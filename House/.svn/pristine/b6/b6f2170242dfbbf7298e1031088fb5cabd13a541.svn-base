using House.DataAccess;
using House.Entity.Cargo;
using House.Entity.Cargo.Product;
using House.Entity.Dto;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Data;
using System.Data.Common;
using System.Data.SqlClient;
using System.Linq;
using System.Reflection;
using System.Security.AccessControl;
using System.Text;

namespace House.Manager.Cargo
{
    /// <summary>
    /// 产品管理数据操作类
    /// </summary>
    public class CargoProductManager
    {
        private SqlHelper conn = new SqlHelper();
        #region 新增产品访问明细
        /// <summary>
        /// 新增产品访问记录及更新浏览量
        /// </summary>
        /// <param name="entity"></param>
        public void AddProductAccessCount(CargoProductAccessDetailsEntity entity)
        {
            try
            {
                #region 新增访问明细记录
                string strSQL = @"INSERT INTO Tbl_Cargo_ProductAccessDetails(HouseID,ProductCode,SuppClientNum,wxOpenID,AccessTime) VALUES(@HouseID,@ProductCode,@SuppClientNum,@wxOpenID,@AccessTime)";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.AddInParameter(cmd, "@SuppClientNum", DbType.Int32, entity.SuppClientNum);
                    conn.AddInParameter(cmd, "@wxOpenID", DbType.String, entity.wxOpenID);
                    conn.AddInParameter(cmd, "@AccessTime", DbType.DateTime, entity.AccessTime);
                    conn.ExecuteNonQuery(cmd);
                }
                #endregion
                // 根据HouseID、ProductCode、SuppClientNum更新访问次数
                UpdateProductAccessCount(entity);
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 更新/新增[访问次数AccessCount]
        /// </summary>
        /// <param name="entity"></param>
        /// <exception cref="ApplicationException"></exception>
        public void UpdateProductAccessCount(CargoProductAccessDetailsEntity entity)
        {
            try
            {
                string strSQL = "SELECT ID,AccessCount FROM Tbl_Cargo_ProductAccessCount WHERE HouseID=@HouseID AND ProductCode=@ProductCode AND SuppClientNum=@SuppClientNum ";
                using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmdQ, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.AddInParameter(cmdQ, "@SuppClientNum", DbType.Int32, entity.SuppClientNum);
                    using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                    {
                        if (idr == null || idr.Rows.Count <= 0)
                        {
                            //无则新增
                            string addSQL = @"INSERT INTO Tbl_Cargo_ProductAccessCount(HouseID,ProductCode,SuppClientNum,AccessCount,AccessTime) VALUES(@HouseID,@ProductCode,@SuppClientNum,@AccessCount,@AccessTime)";
                            using (DbCommand cmd = conn.GetSqlStringCommond(addSQL))
                            {
                                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                                conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                                conn.AddInParameter(cmd, "@SuppClientNum", DbType.Int32, entity.SuppClientNum);
                                conn.AddInParameter(cmd, "@AccessCount", DbType.Int32, 1);
                                conn.AddInParameter(cmd, "@AccessTime", DbType.DateTime, entity.AccessTime);
                                conn.ExecuteNonQuery(cmd);
                            }
                        }
                        else
                        {
                            //有则更新
                            string addSQL = @"UPDATE Tbl_Cargo_ProductAccessCount SET AccessCount=@AccessCount,AccessTime=@AccessTime WHERE ID =@ID";
                            using (DbCommand cmd = conn.GetSqlStringCommond(addSQL))
                            {
                                conn.AddInParameter(cmd, "@ID", DbType.Int64, Convert.ToInt64(idr.Rows[0]["ID"]));
                                conn.AddInParameter(cmd, "@AccessCount", DbType.Int32, Convert.ToInt32(idr.Rows[0]["AccessCount"]) + 1);
                                conn.AddInParameter(cmd, "@AccessTime", DbType.DateTime, entity.AccessTime);
                                conn.ExecuteNonQuery(cmd);
                            }
                        }
                    }
                }
            }
            catch (Exception ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改客户回访状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateProductAccessFeedBackStatus(CargoProductAccessDetailsEntity entity)
        {
            string addSQL = @"UPDATE Tbl_Cargo_ProductAccessDetails SET FeedBackStatus=@FeedBackStatus WHERE ID =@ID";
            using (DbCommand cmd = conn.GetSqlStringCommond(addSQL))
            {
                conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                conn.AddInParameter(cmd, "@FeedBackStatus", DbType.String, entity.FeedBackStatus);
                conn.ExecuteNonQuery(cmd);
            }
        }

        #endregion
        #region 次日达库存操作方法集合
        /// <summary>
        /// 分页查询次日达库存
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <param name="isNextDay">规格是否为次日达</param>
        /// <remark>>默认查询条件：isNextDay为true则 规格类型SpecsType = 5次日达，供应商Supplier=UserInfor.LoginName（ClientNum）</remark>
        /// <returns</returns>
        public Hashtable QueryAllPageNextDayStockInfo(int pIndex, int pNum, CargoProductEntity entity, bool isNextDay)
        {
            var result = QueryAllPageProductStockInfo(pIndex, pNum, entity, isNextDay);
            return result;
        }
        #endregion
        #region 实时库存操作方法集合
        /// <summary>
        /// 分页查询实时库存
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <param name="isNextDay">默认flase时查询实时库存，为true时查询次日达库存 </param>
        /// <returns></returns>
        public Hashtable QueryAllPageProductStockInfo(int pIndex, int pNum, CargoProductEntity entity, bool isNextDay = false)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *   FROM ";
                //strSQL += "(SELECT DISTINCT ROW_NUMBER()  OVER (order by p.Specs asc ) AS RowNumber, h.Name as HouseName,t.TypeName,t.TypeParentName,t.TypeID as TID ,g.Piece,g.ID as ContainerGoodsID, p.*  FROM Tbl_Cargo_Product AS p INNER JOIN  Tbl_Cargo_House as h ON p.HouseID = h.HouseID INNER JOIN Tbl_Cargo_ProductType AS t   ON p.TypeID =t.TypeID  INNER JOIN Tbl_Cargo_ContainerGoods AS g ON p.TypeID = g.TypeID AND p.ProductID = g.ProductID WHERE (1=1) and g.Piece>0";
                strSQL += "(SELECT DISTINCT ROW_NUMBER() OVER (order by p.Specs asc ) AS RowNumber,h.Name as HouseName, t.TypeName, t.TypeParentName, t.TypeID as TID,p.TypeID, p.GoodsCode, p.Specs, p.Figure, p.LoadIndex, p.SpeedLevel, p.SalePrice, p.InHousePrice as InHousePrice, convert(varchar(10),p.InHouseTime,23) as InHouseTime, p.Batch, p.BatchYear, p.BatchWeek, p.HouseID, p.SourceOrderNo, p.SpecsType, p.ProductCode, sum(Piece) as Piece FROM Tbl_Cargo_Product AS p INNER JOIN Tbl_Cargo_House as h ON p.HouseID = h.HouseID INNER JOIN Tbl_Cargo_ProductType AS t ON p.TypeID = t.TypeID INNER JOIN Tbl_Cargo_ContainerGoods AS g ON p.TypeID = g.TypeID AND p.ProductID = g.ProductID WHERE (1 = 1) and g.Piece > 0";

                if (isNextDay)
                {
                    strSQL += "and p.SpecsType = '" + 5 + "'";//（次日达库存）规格类型 SpecsType = 5 次日达
                }
                else
                {
                    strSQL += "and p.SpecsType = '" + 4 + "'";//（实时库存）规格类型 SpecsType = 4  即日达
                }
                //硬性要求：供应商编码SuppClientNum=UserInfor.LoginName（ClientNum）
                if (!entity.SuppClientNum.Equals(0))
                {
                    strSQL += " and p.SuppClientNum = '" + entity.SuppClientNum + "'";
                }
                //产品编码
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and p.ProductCode like '%" + entity.ProductCode + "%'"; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and p.Figure like '%" + entity.Figure + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and p.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strSQL += " and p.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strSQL += " and (p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or p.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strSQL += " and (p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or p.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or p.Specs like '" + entity.Specs + "')";
                    }
                }
                //产品分类编号 
                if (!entity.TypeID.Equals(0)) { strSQL += " and p.TypeID = " + entity.TypeID; }
                if (!entity.BatchYear.Equals(0)) { strSQL += " and p.BatchYear = " + entity.BatchYear; }
                //入库日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and p.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and p.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.InHouseDay)) { strSQL += " and DATEDIFF(day, p.InHouseTime, GETDATE())>=" + Convert.ToInt32(entity.InHouseDay); }

                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and p.HouseID in (" + entity.CargoPermisID + ")"; }
                strSQL += $@" group by h.Name, t.TypeName, t.TypeParentName, t.TypeID, p.ProductCode, Specs, Figure, GoodsCode, LoadIndex, SpeedLevel, Batch, BatchYear, BatchWeek, SourceOrderNo, p.SpecsType, p.HouseID, convert(varchar(10), p.InHouseTime, 23), p.SalePrice, p.InHousePrice, p.TypeID) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取产品库存数据
                            var HouseTime = DateTime.Now - Convert.ToDateTime(idr["InHouseTime"]);
                            result.Add(new CargoProductEntity
                            {
                                //ContainerGoodsID = Convert.ToInt64(idr["ContainerGoodsID"]),
                                //ProductID = Convert.ToInt64(idr["ProductID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                InHousePrice = Convert.ToDecimal(idr["InHousePrice"]),
                                //CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                RealStockNum = Convert.ToInt32(idr["Piece"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                InHouseTime = string.IsNullOrEmpty(Convert.ToString(idr["InHouseTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["InHouseTime"]),
                                InHouseDay = Convert.ToString(HouseTime.Days),
                                //OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                BatchYear = Convert.ToInt32(idr["BatchYear"]),
                                SpecsType = Convert.ToString(idr["SpecsType"]),
                                SourceOrderNo = Convert.ToString(idr["SourceOrderNo"]),
                                LoadSpeed = Convert.ToString(idr["LoadIndex"]) + Convert.ToString(idr["SpeedLevel"]),
                                InHouseTimeStr = string.IsNullOrEmpty(Convert.ToString(idr["InHouseTime"])) ? string.Empty : Convert.ToDateTime(idr["InHouseTime"]).ToString("yyyy-MM-dd HH:mm:ss"),
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = "select count(1) TotalCount,sum(Piece)  as TotalNum, sum(A.Piece * A.InHousePrice) as TotalMoney from (SELECT DISTINCT ROW_NUMBER() OVER (order by p.Specs asc ) AS RowNumber,sum(Piece) as Piece,InHousePrice FROM Tbl_Cargo_Product AS p INNER JOIN Tbl_Cargo_House as h ON p.HouseID = h.HouseID INNER JOIN Tbl_Cargo_ProductType AS t ON p.TypeID = t.TypeID INNER JOIN Tbl_Cargo_ContainerGoods AS g ON p.TypeID = g.TypeID AND p.ProductID = g.ProductID WHERE (1 = 1) and g.Piece > 0 ";

                if (isNextDay)
                {
                    strCount += "and p.SpecsType = '" + 5 + "'";//（次日达库存）规格类型 SpecsType = 5 次日达
                }
                else
                {
                    strCount += "and p.SpecsType = '" + 4 + "'";//（实时库存）规格类型 SpecsType = 4  即日达
                }
                //硬性要求：供应商编码SuppClientNum=UserInfor.LoginName（ClientNum）
                if (!entity.SuppClientNum.Equals(0))
                {
                    strCount += " and p.SuppClientNum = '" + entity.SuppClientNum + "'";
                }
                //产品编码
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strCount += " and p.ProductCode like '%" + entity.ProductCode + "%'"; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and p.Figure like '%" + entity.Figure + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strCount += " and p.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strCount += " and p.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strCount += " and (p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or p.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strCount += " and (p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or p.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or p.Specs like '" + entity.Specs + "')";
                    }
                }
                //产品分类编号 
                if (!entity.TypeID.Equals(0)) { strCount += " and p.TypeID = " + entity.TypeID; }
                if (!entity.BatchYear.Equals(0)) { strCount += " and p.BatchYear = " + entity.BatchYear; }
                //入库日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and p.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and p.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.InHouseDay)) { strCount += " and DATEDIFF(day, p.InHouseTime, GETDATE())>=" + Convert.ToInt32(entity.InHouseDay); }

                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and p.HouseID in (" + entity.CargoPermisID + ")"; }
                strCount += $@" group by h.Name,t.TypeName,t.TypeParentName,t.TypeID, p.ProductCode,Specs,Figure,GoodsCode,LoadIndex,SpeedLevel,Batch,BatchYear,BatchWeek,SourceOrderNo,p.SpecsType,p.HouseID ,convert(varchar(10),p.InHouseTime,23),p.SalePrice,p.InHousePrice,p.TypeID) A ";

                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                            resHT["TotalNum"] = Convert.ToInt32(idrCount.Rows[0]["TotalNum"]);
                            resHT["TotalMoney"] = Convert.ToDecimal(idrCount.Rows[0]["TotalMoney"]);
                        }
                    }
                }
                resHT["rows"] = result;

                #region 总数目
                //string strCount = @"Select Count(*) as TotalCount, sum(a2.Piece) as TotalNum, sum(a2.Piece * a2.InHousePrice) as TotalMoney from (select p.ProductCode, Specs, Figure, GoodsCode, LoadIndex, SpeedLevel,sum(Piece) as Piece, Batch, BatchYear, BatchWeek, SourceOrderNo, p.SpecsType, p.HouseID, convert(varchar(10), p.InHouseTime, 23) as InHouseTime, p.SalePrice, p.InHousePrice from Tbl_Cargo_Product as p inner join Tbl_Cargo_ContainerGoods as b on p.ProductID = b.ProductID Where (1 = 1)";
                //if (isNextDay)
                //{
                //    strCount += "and p.SpecsType = '" + 5 + "'";//（次日达库存）规格类型 SpecsType = 5 次日达
                //}
                //else
                //{
                //    strCount += "and p.SpecsType = '" + 4 + "'";//（实时库存）规格类型 SpecsType = 4  即日达
                //}
                ////硬性要求==UserInfor.LoginName（ClientNum）
                //if (!entity.SuppClientNum.Equals(0))
                //{
                //    strCount += " and p.SuppClientNum = '" + entity.SuppClientNum + "'";
                //}
                ////产品编码
                //if (!string.IsNullOrEmpty(entity.ProductCode)) { strCount += " and p.ProductCode like '%" + entity.ProductCode + "%'"; }
                ////花纹
                //if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and p.Figure like '%" + entity.Figure + "%'"; }
                ////货品代码
                //if (!string.IsNullOrEmpty(entity.GoodsCode)) { strCount += " and p.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                ////规格
                //if (!string.IsNullOrEmpty(entity.Specs)) { strCount += " and p.Specs like '%" + entity.Specs + "%'"; }
                ////产品分类编号 
                //if (!entity.TypeID.Equals(0)) { strCount += " and p.TypeID = " + entity.TypeID; }
                //if (!entity.BatchYear.Equals(0)) { strCount += " and p.BatchYear = " + entity.BatchYear; }
                ////入库日期范围
                //if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                //{
                //    strCount += " and p.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                //}
                //if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                //{
                //    strCount += " and p.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                //}
                //if (!string.IsNullOrEmpty(entity.InHouseDay)) { strCount += " and DATEDIFF(day, p.InHouseTime, GETDATE())>=" + Convert.ToInt32(entity.InHouseDay); }
                ////所属仓库ID
                //if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and p.HouseID in (" + entity.CargoPermisID + ")"; }

                //strCount += $@" group by p.ProductCode,Specs,Figure,GoodsCode,LoadIndex,SpeedLevel,Batch,BatchYear,BatchWeek,SourceOrderNo,p.SpecsType,p.HouseID ,convert(varchar(10),p.InHouseTime,23),p.SalePrice,p.InHousePrice     ) as a2";


                //using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                //{
                //    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                //    {
                //        if (idrCount.Rows.Count > 0)
                //        {
                //            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                //            resHT["TotalNum"] = Convert.ToInt32(idrCount.Rows[0]["TotalNum"]);
                //            resHT["TotalMoney"] = Convert.ToDecimal(idrCount.Rows[0]["TotalMoney"]);
                //        }
                //    }
                //}
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        #endregion
        #region 产品操作方法集合
        /// <summary>
        /// 新增次日达产品数据，并返回ProductID
        /// </summary>
        /// <param name="list"></param>
        public long SaveProductData(CargoProductEntity entity, CargoProductSpecEntity specEntity)
        {
            try
            {
                entity.EnSafe();
                Int64 did = 0;
                string strSQL = @"INSERT INTO Tbl_Cargo_Product(ProductCode,ProductName,TypeID,Model,GoodsCode,Specs,Figure,TreadWidth,FlatRatio,Meridian,HubDiameter,LoadIndex,SpeedLevel,SpeedMax,Weight,UnitPrice,Numbers,TradePrice,SalePrice,PackageNum,PackageWeight,OP_DATE,Batch,BatchYear,BatchWeek,HouseID,Source,BelongMonth,OperaType,Born,Assort,BelongDepart,Company,SpecsType,Supplier,InHouseTime,SuppClientNum,InCargoStatus,InHousePrice) VALUES (@ProductCode,@ProductName,@TypeID,@Model,@GoodsCode,@Specs,@Figure,@TreadWidth,@FlatRatio,@Meridian,@HubDiameter,@LoadIndex,@SpeedLevel,@SpeedMax,@Weight,@UnitPrice,@Numbers,@TradePrice,@SalePrice,@PackageNum,@PackageWeight,@OP_DATE,@Batch,@BatchYear,@BatchWeek,@HouseID,@Source,@BelongMonth,@OperaType,@Born,@Assort,@BelongDepart,@Company,@SpecsType,@Supplier,@InHouseTime,@SuppClientNum,@InCargoStatus,@InHousePrice)SELECT @@IDENTITY";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@Supplier", DbType.String, entity.Supplier);
                    conn.AddInParameter(cmd, "@SuppClientNum", DbType.Int64, entity.SuppClientNum);
                    conn.AddInParameter(cmd, "@SpecsType", DbType.String, entity.SpecsType);
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.AddInParameter(cmd, "@ProductName", DbType.String, entity.TypeName + "轮胎");//品牌名+"轮胎"
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs.Trim());
                    conn.AddInParameter(cmd, "@Figure", DbType.String, entity.Figure.Trim());
                    conn.AddInParameter(cmd, "@LoadIndex", DbType.String, specEntity.LoadIndex);
                    conn.AddInParameter(cmd, "@SpeedLevel", DbType.String, specEntity.SpeedLevel);
                    conn.AddInParameter(cmd, "@SalePrice", DbType.Decimal, entity.SalePrice);
                    conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);

                    //【待确定】库存数量=？导入文件填写的数量
                    conn.AddInParameter(cmd, "@Numbers", DbType.Int32, entity.Numbers);

                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, specEntity.TypeID);
                    conn.AddInParameter(cmd, "@Model", DbType.String, specEntity.Model.Trim());
                    conn.AddInParameter(cmd, "@GoodsCode", DbType.String, specEntity.GoodsCode.Trim());

                    conn.AddInParameter(cmd, "@TreadWidth", DbType.Int32, specEntity.TreadWidth);
                    conn.AddInParameter(cmd, "@FlatRatio", DbType.Int32, specEntity.FlatRatio);
                    conn.AddInParameter(cmd, "@Meridian", DbType.String, "R");//子午线，默认值R？默认R
                    conn.AddInParameter(cmd, "@HubDiameter", DbType.Int32, specEntity.HubDiameter);

                    conn.AddInParameter(cmd, "@SpeedMax", DbType.Int32, entity.SpeedMax);//最高速度？
                    conn.AddInParameter(cmd, "@Weight", DbType.Decimal, 0);//单个重量,默认KG ？默认0
                    conn.AddInParameter(cmd, "@UnitPrice", DbType.Decimal, entity.InHousePrice);//单价？导入文件填写的销售价
                    conn.AddInParameter(cmd, "@TradePrice", DbType.Decimal, entity.SalePrice);//批发价？导入文件填写的销售价
                    conn.AddInParameter(cmd, "@InHousePrice", DbType.Decimal, entity.InHousePrice);//批发价？导入文件填写的销售价

                    conn.AddInParameter(cmd, "@PackageNum", DbType.Int32, entity.PackageNum);//包装数量？默认0
                    conn.AddInParameter(cmd, "@PackageWeight", DbType.Decimal, entity.PackageWeight);//包装重量？默认0
                    conn.AddInParameter(cmd, "@BatchYear", DbType.Int32, entity.BatchYear);//批次年？导入文件填写的批次后两位
                    conn.AddInParameter(cmd, "@BatchWeek", DbType.Int32, entity.BatchWeek);//批次周？导入文件填写的批次前两位
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, entity.OP_DATE);
                    conn.AddInParameter(cmd, "@Source", DbType.String, "83");//归属=83？默认83
                    conn.AddInParameter(cmd, "@BelongMonth", DbType.String, entity.BelongMonth); //订单归属月
                    conn.AddInParameter(cmd, "@OperaType", DbType.String, "0");//操作类型，0电脑？默认0
                    conn.AddInParameter(cmd, "@Born", DbType.String, specEntity.Born);
                    conn.AddInParameter(cmd, "@Assort", DbType.String, specEntity.Assort);
                    conn.AddInParameter(cmd, "@BelongDepart", DbType.String, "1");//归属部门，1:OE渠道销售部？默认1
                    conn.AddInParameter(cmd, "@Company", DbType.String, "0");//所属公司，0：迪乐泰？默认0
                    conn.AddInParameter(cmd, "@InHouseTime", DbType.String, entity.InHouseTime);//入库时间
                    conn.AddInParameter(cmd, "@InCargoStatus", DbType.String, entity.InCargoStatus);//入库状态=已入库1

                    did = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
                return did;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        /// <summary>
        /// 产品是否存在  以产品ID判断
        /// </summary>
        /// <param name="entity"></param>
        /// <returns>True:表示已经存在，False：表示不存在</returns>
        public bool IsExistCargoProduct(CargoProductEntity entity)
        {
            string strQ = @"Select ProductID from Tbl_Cargo_Product Where ProductID=@ProductID";

            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ProductID", DbType.Int64, entity.ProductID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }

        /// <summary>
        /// 查询产品
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryProduct(int pIndex, int pNum, CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber, a.*,b.TypeName,b.ParentID as ParentID,b.TypeParentName as ParentName,e.ContainerCode,g3.AreaID,g3.name as AreaName,f.Name as HouseName,ISNULL(d.Piece,0) as RealStockNum,ISNULL(e.ContainerID,0) as ContainerID FROM Tbl_Cargo_Product as a left join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID left join Tbl_Cargo_ContainerGoods as d on a.ProductID=d.ProductID left join Tbl_Cargo_Container as e on d.ContainerID=e.ContainerID left join Tbl_Cargo_House as f on a.HouseID=f.HouseID left join Tbl_Cargo_Area g1 on e.AreaID=g1.AreaID left join Tbl_Cargo_Area g2 on g2.AreaID=g1.ParentID left join Tbl_Cargo_Area g3 on g3.AreaID=g2.ParentID ";
                if (!string.IsNullOrEmpty(entity.TagCode) || !string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " inner join Tbl_Cargo_ProductTag as g on a.ProductID=g.ProductID "; }
                strSQL += " Where (1=1)";
                //轮胎唯一编码
                if (!string.IsNullOrEmpty(entity.TagCode)) { strSQL += " and g.TagCode like '%" + entity.TagCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " and g.TyreCode like '%" + entity.TyreCode + "%'"; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strSQL += " and a.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and a.ProductCode like '%" + entity.ProductCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.ParentID.Equals(0)) { strSQL += " and b.ParentID=" + entity.ParentID; }
                if (!entity.ProductID.Equals(0)) { strSQL += " and a.ProductID=" + entity.ProductID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                if (!entity.TreadWidth.Equals(0)) { strSQL += " and a.TreadWidth=" + entity.TreadWidth; }
                if (!entity.FlatRatio.Equals(0)) { strSQL += " and a.FlatRatio=" + entity.FlatRatio; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch = '" + entity.Batch + "'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Meridian)) { strSQL += " and a.Meridian = '" + entity.Meridian + "'"; }
                if (!entity.HubDiameter.Equals(0)) { strSQL += " and a.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex like '%" + entity.LoadIndex + "%'"; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                if (!string.IsNullOrEmpty(entity.InCargoStatus)) { strSQL += " and a.InCargoStatus = '" + entity.InCargoStatus + "'"; }
                if (!string.IsNullOrEmpty(entity.BelongDepart)) { strSQL += " and a.BelongDepart = '" + entity.BelongDepart + "'"; }
                //入库时间
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //产品来源ID
                if (!string.IsNullOrEmpty(entity.Source)) { strSQL += " and a.Source = " + entity.Source; }
                if (!string.IsNullOrEmpty(entity.SourceOrderNo)) { strSQL += " and a.SourceOrderNo = '" + entity.SourceOrderNo + "'"; }
                if (!string.IsNullOrEmpty(entity.IsLockStock)) { strSQL += " and a.IsLockStock = '" + entity.IsLockStock + "'"; }
                if (!string.IsNullOrEmpty(entity.Supplier)) { strSQL += " and a.Supplier = '" + entity.Supplier + "'"; }
                if (!string.IsNullOrEmpty(entity.SpecsType)) { strSQL += " and a.SpecsType = '" + entity.SpecsType + "'"; }
                if (!string.IsNullOrEmpty(entity.TyreModel)) { strSQL += " and a.TyreModel = '" + entity.TyreModel + "'"; }

                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " and g3.AreaID=" + entity.FirstAreaID + "";
                }
                if (!entity.BatchYear.Equals(0)) { strSQL += " and a.BatchYear=" + entity.BatchYear; }
                if (!entity.BatchWeek.Equals(0))
                {
                    if (entity.PriceType.Equals(0))
                    {
                        //半年前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-6,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(1))
                    {
                        //一年前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-12,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(2))
                    {
                        //10个月前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-10,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(3))
                    {
                        //30周前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(WEEK,-30,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(4))
                    {
                        //9个月前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-9,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1)) ORDER BY  A.RowNumber ";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoProductEntity
                            {
                                AreaName = Convert.ToString(idr["AreaName"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                //TagCode = Convert.ToString(idr["TagCode"]),
                                InHouseTime = string.IsNullOrEmpty(Convert.ToString(idr["InHouseTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["InHouseTime"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                GoodsName = Convert.ToString(idr["GoodsName"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]).Trim(),
                                Model = Convert.ToString(idr["Model"]).Trim(),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]).Trim(),
                                Figure = Convert.ToString(idr["Figure"]).Trim(),
                                Specs = Convert.ToString(idr["Specs"]).Trim(),
                                TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                                Meridian = Convert.ToString(idr["Meridian"]).Trim(),
                                HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = Convert.ToInt32(idr["SpeedMax"]),
                                Size = Convert.ToString(idr["Size"]),
                                Weight = Convert.ToDecimal(idr["Weight"]),
                                UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                                Numbers = Convert.ToInt32(idr["Numbers"]),
                                RealStockNum = Convert.ToInt32(idr["RealStockNum"]),
                                CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                Package = Convert.ToString(idr["Package"]).Trim(),
                                PackageNum = Convert.ToInt32(idr["PackageNum"]),
                                PackageWeight = Convert.ToDecimal(idr["PackageWeight"]),
                                NextDayPrice = Convert.ToDecimal(idr["NextDayPrice"]),
                                ParentID = Convert.ToInt32(idr["ParentID"]),
                                ParentName = Convert.ToString(idr["ParentName"]).Trim(),
                                Batch = Convert.ToString(idr["Batch"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]).Trim(),
                                Source = Convert.ToString(idr["Source"]).Trim(),
                                SourceOrderNo = Convert.ToString(idr["SourceOrderNo"]).Trim(),
                                BelongMonth = Convert.ToString(idr["BelongMonth"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]).Trim(),
                                OperaType = Convert.ToString(idr["OperaType"]),
                                Born = Convert.ToString(idr["Born"]),
                                Assort = Convert.ToString(idr["Assort"]),
                                BelongDepart = Convert.ToString(idr["BelongDepart"]),
                                IsLockStock = Convert.ToString(idr["IsLockStock"]),
                                LockStockName = Convert.ToString(idr["LockStockName"]),
                                LockStockMemo = Convert.ToString(idr["LockStockMemo"]),
                                LockStockDate = string.IsNullOrEmpty(Convert.ToString(idr["LockStockDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["LockStockDate"]),
                                //UnLockStockDate = Convert.ToString(idr["UnLockStockDate"]),
                                SpecsType = Convert.ToString(idr["SpecsType"]),
                                Supplier = Convert.ToString(idr["Supplier"]),
                                SuppClientNum = string.IsNullOrEmpty(Convert.ToString(idr["SuppClientNum"])) ? 0 : Convert.ToInt32(idr["SuppClientNum"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                TyreModel = Convert.ToString(idr["TyreModel"]),
                                QalityRemark = Convert.ToString(idr["QalityRemark"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }

                resHT["rows"] = result;

                string strCount = @"SELECT Count(*) as TotalCount FROM Tbl_Cargo_Product AS a LEFT JOIN Tbl_Cargo_ProductType AS b ON a.TypeID=b.TypeID LEFT JOIN Tbl_Cargo_ProductType AS c ON b.ParentID=c.TypeID LEFT JOIN Tbl_Cargo_ContainerGoods AS d ON a.ProductID=d.ProductID LEFT JOIN Tbl_Cargo_Container AS e ON d.ContainerID=e.ContainerID LEFT JOIN Tbl_Cargo_House AS f ON a.HouseID=f.HouseID LEFT JOIN Tbl_Cargo_Area g1 ON e.AreaID=g1.AreaID LEFT JOIN Tbl_Cargo_Area g2 ON g2.AreaID=g1.ParentID LEFT JOIN Tbl_Cargo_Area g3 ON g3.AreaID=g2.ParentID ";
                if (!string.IsNullOrEmpty(entity.TagCode) || !string.IsNullOrEmpty(entity.TyreCode)) { strCount += " inner join Tbl_Cargo_ProductTag as g on a.ProductID=g.ProductID "; }
                strCount += " Where (1=1)";
                //轮胎唯一编码
                if (!string.IsNullOrEmpty(entity.TagCode)) { strCount += " and g.TagCode like '%" + entity.TagCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " and g.TyreCode like '%" + entity.TyreCode + "%'"; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strCount += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strCount += " and a.Model like '%" + entity.Model + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strCount += " and a.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strCount += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strCount += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strCount += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strCount += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.ParentID.Equals(0)) { strCount += " and b.ParentID=" + entity.ParentID; }
                if (!entity.ProductID.Equals(0)) { strCount += " and a.ProductID=" + entity.ProductID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strCount += " and a.TypeID=" + entity.TypeID; }
                if (!entity.TreadWidth.Equals(0)) { strCount += " and a.TreadWidth=" + entity.TreadWidth; }
                if (!entity.FlatRatio.Equals(0)) { strCount += " and a.FlatRatio=" + entity.FlatRatio; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Batch)) { strCount += " and a.Batch = '" + entity.Batch + "'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and a.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Meridian)) { strCount += " and a.Meridian = '" + entity.Meridian + "'"; }
                if (!entity.HubDiameter.Equals(0)) { strCount += " and a.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strCount += " and a.LoadIndex like '%" + entity.LoadIndex + "%'"; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strCount += " and a.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                if (!string.IsNullOrEmpty(entity.InCargoStatus)) { strCount += " and a.InCargoStatus = '" + entity.InCargoStatus + "'"; }
                if (!string.IsNullOrEmpty(entity.BelongDepart)) { strCount += " and a.BelongDepart = '" + entity.BelongDepart + "'"; }
                if (!string.IsNullOrEmpty(entity.TyreModel)) { strCount += " and a.TyreModel = '" + entity.TyreModel + "'"; }

                //入库时间
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //产品来源ID
                if (!string.IsNullOrEmpty(entity.Source)) { strCount += " and a.Source = " + entity.Source; }
                if (!string.IsNullOrEmpty(entity.SourceOrderNo)) { strCount += " and a.SourceOrderNo = '" + entity.SourceOrderNo + "'"; }
                if (!string.IsNullOrEmpty(entity.IsLockStock)) { strCount += " and a.IsLockStock = '" + entity.IsLockStock + "'"; }
                if (!string.IsNullOrEmpty(entity.Supplier)) { strCount += " and a.Supplier = '" + entity.Supplier + "'"; }
                if (!entity.BatchYear.Equals(0)) { strCount += " and a.BatchYear=" + entity.BatchYear; }
                if (!entity.BatchWeek.Equals(0))
                {
                    if (entity.PriceType.Equals(0))
                    {
                        //半年前
                        strCount += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-6,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(1))
                    {
                        //一年前
                        strCount += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-12,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(2))
                    {
                        //10个月前
                        strCount += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-10,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(3))
                    {
                        //30周前
                        strCount += " and ((a.BatchWeek<DATEPART(week,DATEADD(WEEK,-30,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(4))
                    {
                        //9个月前
                        strCount += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-9,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                }
                if (!entity.FirstAreaID.Equals(0))
                {
                    strCount += " and g3.AreaID=" + entity.FirstAreaID + "";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        public CargoProductEntity QueryProductData(CargoProductEntity entity)
        {
            CargoProductEntity result = new CargoProductEntity();
            try
            {
                string strSQL = @"Select * from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID inner join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID where a.HouseID=@HouseID and c.ContainerCode=@ContainerCode ";
                if (!entity.SuppClientNum.Equals(0)) { strSQL += " and a.SuppClientNum=" + entity.SuppClientNum + ""; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID + ""; }
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs='" + entity.Specs + "'"; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch='" + entity.Batch + "'"; }
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode='" + entity.GoodsCode + "'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure='" + entity.Figure + "'"; }
                if (!string.IsNullOrEmpty(entity.BelongDepart)) { strSQL += " and a.BelongDepart='" + entity.BelongDepart + "'"; }
                if (!string.IsNullOrEmpty(entity.OperaType)) { strSQL += " and a.OperaType='" + entity.OperaType + "'"; }
                if (!string.IsNullOrEmpty(entity.Source)) { strSQL += " and a.Source='" + entity.Source + "'"; }
                if (!string.IsNullOrEmpty(entity.SpecsType)) { strSQL += " and a.SpecsType='" + entity.SpecsType + "'"; }
                strSQL += " order by b.Piece desc,b.InHouseTime desc";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    // conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs);
                    // conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);
                    conn.AddInParameter(cmd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    using (DataTable dd = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.ProductID = Convert.ToInt64(idr["ProductID"]);
                            result.ContainerGoodsID = Convert.ToInt64(idr["ID"]);
                            result.InCargoID = Convert.ToString(idr["InCargoID"]);
                            result.ContainerID = Convert.ToInt32(idr["ContainerID"]);
                            result.Numbers = Convert.ToInt32(idr["Piece"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;


        }
        /// <summary>
        /// 新增产品
        /// </summary>
        /// <param name="entity"></param>
        public long AddCargoProduct(CargoProductEntity entity)
        {
            entity.EnSafe();
            Int64 did = 0;
            string strSQL = @"INSERT INTO Tbl_Cargo_Product(ProductName,TypeID,Model,GoodsCode,Specs,Figure,TreadWidth,FlatRatio,Meridian,HubDiameter,LoadIndex,SpeedLevel,SpeedMax,Size,Weight,UnitPrice,Numbers,FinalCostPrice,CostPrice,InHousePrice,TaxCostPrice,NoTaxCostPrice,TradePrice,SalePrice,Package,PackageNum,PackageWeight,OP_DATE,Batch,BatchYear,BatchWeek,HouseID,Source,SourceOrderNo,BelongMonth,OperaType,Born,Assort,BelongDepart,Company,SpecsType,Supplier,SuppClientNum,SupplierAddress,ProductCode,GoodsName,NextDayPrice,WholesalePrice,OwnerShip,GoodsClass,TyreModel,QalityRemark,PurchaseSupplier) VALUES (@ProductName,@TypeID,@Model,@GoodsCode,@Specs,@Figure,@TreadWidth,@FlatRatio,@Meridian,@HubDiameter,@LoadIndex,@SpeedLevel,@SpeedMax,@Size,@Weight,@UnitPrice,@Numbers,@FinalCostPrice,@CostPrice,@InHousePrice,@TaxCostPrice,@NoTaxCostPrice,@TradePrice,@SalePrice,@Package,@PackageNum,@PackageWeight,@OP_DATE,@Batch,@BatchYear,@BatchWeek,@HouseID,@Source,@SourceOrderNo,@BelongMonth,@OperaType,@Born,@Assort,@BelongDepart,@Company,@SpecsType,@Supplier,@SuppClientNum,@SupplierAddress,@ProductCode,@GoodsName,@NextDayPrice,@WholesalePrice,@OwnerShip,@GoodsClass,@TyreModel,@QalityRemark,@PurchaseSupplier)SELECT @@IDENTITY";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@GoodsName", DbType.String, entity.GoodsName);
                    conn.AddInParameter(cmd, "@ProductName", DbType.String, entity.ProductName.Trim());
                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                    conn.AddInParameter(cmd, "@Model", DbType.String, entity.Model.Trim());
                    conn.AddInParameter(cmd, "@GoodsCode", DbType.String, entity.GoodsCode.Trim());
                    conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs.Trim());
                    conn.AddInParameter(cmd, "@Figure", DbType.String, entity.Figure.Trim());
                    conn.AddInParameter(cmd, "@TreadWidth", DbType.Int32, entity.TreadWidth);
                    conn.AddInParameter(cmd, "@FlatRatio", DbType.Int32, entity.FlatRatio);
                    conn.AddInParameter(cmd, "@Meridian", DbType.String, entity.Meridian);
                    conn.AddInParameter(cmd, "@HubDiameter", DbType.Int32, entity.HubDiameter);
                    conn.AddInParameter(cmd, "@LoadIndex", DbType.String, entity.LoadIndex);
                    conn.AddInParameter(cmd, "@SpeedLevel", DbType.String, entity.SpeedLevel);
                    conn.AddInParameter(cmd, "@SpeedMax", DbType.Int32, entity.SpeedMax);
                    conn.AddInParameter(cmd, "@Size", DbType.String, entity.Size);
                    conn.AddInParameter(cmd, "@Weight", DbType.Decimal, entity.Weight);
                    conn.AddInParameter(cmd, "@UnitPrice", DbType.Decimal, entity.UnitPrice);
                    conn.AddInParameter(cmd, "@Numbers", DbType.Int32, entity.Numbers);
                    conn.AddInParameter(cmd, "@NextDayPrice", DbType.Decimal, entity.NextDayPrice);
                    conn.AddInParameter(cmd, "@WholesalePrice", DbType.Decimal, entity.WholesalePrice);
                    conn.AddInParameter(cmd, "@FinalCostPrice", DbType.Decimal, entity.FinalCostPrice);
                    conn.AddInParameter(cmd, "@InHousePrice", DbType.Decimal, entity.InHousePrice);
                    conn.AddInParameter(cmd, "@CostPrice", DbType.Decimal, entity.CostPrice);
                    conn.AddInParameter(cmd, "@TaxCostPrice", DbType.Decimal, entity.TaxCostPrice);
                    conn.AddInParameter(cmd, "@NoTaxCostPrice", DbType.Decimal, entity.NoTaxCostPrice);
                    conn.AddInParameter(cmd, "@TradePrice", DbType.Decimal, entity.TradePrice);
                    conn.AddInParameter(cmd, "@SalePrice", DbType.Decimal, entity.SalePrice);
                    conn.AddInParameter(cmd, "@Package", DbType.String, entity.Package);
                    conn.AddInParameter(cmd, "@PackageNum", DbType.Int32, entity.PackageNum);
                    conn.AddInParameter(cmd, "@PackageWeight", DbType.Decimal, entity.PackageWeight);
                    conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);
                    conn.AddInParameter(cmd, "@BatchYear", DbType.Int32, entity.BatchYear);
                    conn.AddInParameter(cmd, "@BatchWeek", DbType.Int32, entity.BatchWeek);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@Source", DbType.String, entity.Source);
                    conn.AddInParameter(cmd, "@SourceOrderNo", DbType.String, entity.SourceOrderNo);
                    conn.AddInParameter(cmd, "@BelongMonth", DbType.String, entity.BelongMonth);
                    conn.AddInParameter(cmd, "@OperaType", DbType.String, entity.OperaType);
                    conn.AddInParameter(cmd, "@Born", DbType.String, entity.Born);
                    conn.AddInParameter(cmd, "@Assort", DbType.String, entity.Assort);
                    conn.AddInParameter(cmd, "@BelongDepart", DbType.String, entity.BelongDepart);
                    conn.AddInParameter(cmd, "@Company", DbType.String, entity.Company);
                    conn.AddInParameter(cmd, "@SpecsType", DbType.String, entity.SpecsType);
                    conn.AddInParameter(cmd, "@Supplier", DbType.String, entity.Supplier);
                    conn.AddInParameter(cmd, "@SuppClientNum", DbType.String, entity.SuppClientNum);
                    conn.AddInParameter(cmd, "@SupplierAddress", DbType.String, entity.SupplierAddress);
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.AddInParameter(cmd, "@OwnerShip", DbType.String, entity.OwnerShip);
                    conn.AddInParameter(cmd, "@GoodsClass", DbType.String, entity.GoodsClass);
                    conn.AddInParameter(cmd, "@TyreModel", DbType.String, entity.TyreModel);
                    conn.AddInParameter(cmd, "@QalityRemark", DbType.String, entity.QalityRemark);
                    conn.AddInParameter(cmd, "@PurchaseSupplier", DbType.String, entity.PurchaseSupplier);
                    //conn.ExecuteNonQuery(cmd);
                    did = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
                return did;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改产品
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoProduct(CargoProductEntity entity)
        {
            //BelongMonth=@BelongMonth,Supplier=@Supplier,SuppClientNum=@SuppClientNum,SupplierAddress=@SupplierAddress
            entity.EnSafe();
            string strSQL = @"UPDATE Tbl_Cargo_Product SET ProductName =@ProductName,TypeID =@TypeID,Model =@Model,GoodsCode =@GoodsCode,Specs =@Specs,Figure =@Figure,TreadWidth =@TreadWidth,FlatRatio =@FlatRatio,Meridian =@Meridian,HubDiameter =@HubDiameter,LoadIndex =@LoadIndex,SpeedLevel =@SpeedLevel,SpeedMax =@SpeedMax,Size =@Size,Weight =@Weight,UnitPrice =@UnitPrice,Numbers =@Numbers,TradePrice =@TradePrice,SalePrice =@SalePrice,Package =@Package,PackageNum =@PackageNum,PackageWeight =@PackageWeight,OP_DATE =@OP_DATE,Batch=@Batch,BatchYear=@BatchYear,BatchWeek=@BatchWeek,Source=@Source,SourceOrderNo=@SourceOrderNo,Born=@Born,Assort=@Assort,BelongDepart=@BelongDepart,TyreModel=@TyreModel WHERE ProductID=@ProductID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);
                    conn.AddInParameter(cmd, "@ProductName", DbType.String, entity.ProductName);
                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                    conn.AddInParameter(cmd, "@Model", DbType.String, entity.Model);
                    conn.AddInParameter(cmd, "@GoodsCode", DbType.String, entity.GoodsCode);
                    conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs);
                    conn.AddInParameter(cmd, "@Figure", DbType.String, entity.Figure);
                    conn.AddInParameter(cmd, "@TreadWidth", DbType.Int32, entity.TreadWidth);
                    conn.AddInParameter(cmd, "@FlatRatio", DbType.Int32, entity.FlatRatio);
                    conn.AddInParameter(cmd, "@Meridian", DbType.String, entity.Meridian);
                    conn.AddInParameter(cmd, "@HubDiameter", DbType.Int32, entity.HubDiameter);
                    conn.AddInParameter(cmd, "@LoadIndex", DbType.String, entity.LoadIndex);
                    conn.AddInParameter(cmd, "@SpeedLevel", DbType.String, entity.SpeedLevel);
                    conn.AddInParameter(cmd, "@SpeedMax", DbType.Int32, entity.SpeedMax);
                    conn.AddInParameter(cmd, "@Size", DbType.String, entity.Size);
                    conn.AddInParameter(cmd, "@Weight", DbType.Decimal, entity.Weight);
                    conn.AddInParameter(cmd, "@UnitPrice", DbType.Decimal, entity.UnitPrice);
                    conn.AddInParameter(cmd, "@Numbers", DbType.Int32, entity.Numbers);
                    //conn.AddInParameter(cmd, "@CostPrice", DbType.Decimal, entity.CostPrice);
                    conn.AddInParameter(cmd, "@TradePrice", DbType.Decimal, entity.TradePrice);
                    conn.AddInParameter(cmd, "@SalePrice", DbType.Decimal, entity.SalePrice);
                    conn.AddInParameter(cmd, "@Package", DbType.String, entity.Package);
                    conn.AddInParameter(cmd, "@PackageNum", DbType.Int32, entity.PackageNum);
                    conn.AddInParameter(cmd, "@PackageWeight", DbType.Decimal, entity.PackageWeight);
                    conn.AddInParameter(cmd, "@BatchYear", DbType.Int32, entity.BatchYear);
                    conn.AddInParameter(cmd, "@BatchWeek", DbType.Int32, entity.BatchWeek);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.AddInParameter(cmd, "@Source", DbType.String, entity.Source);
                    conn.AddInParameter(cmd, "@SourceOrderNo", DbType.String, entity.SourceOrderNo);
                    //conn.AddInParameter(cmd, "@BelongMonth", DbType.String, entity.BelongMonth);
                    conn.AddInParameter(cmd, "@Born", DbType.String, entity.Born);
                    conn.AddInParameter(cmd, "@Assort", DbType.String, entity.Assort);
                    conn.AddInParameter(cmd, "@BelongDepart", DbType.String, entity.BelongDepart);
                    conn.AddInParameter(cmd, "@TyreModel", DbType.String, entity.TyreModel);
                    //conn.AddInParameter(cmd, "@SuppClientNum", DbType.Int32, entity.SuppClientNum);
                    //conn.AddInParameter(cmd, "@SupplierAddress", DbType.String, entity.SupplierAddress);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除产品
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoProduct(List<CargoProductEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_Product where ProductID=@ProductID ";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ProductID", DbType.Int64, it.ProductID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void DelCargoProduct(string ProductID)
        {
            try
            {
                string strSQL = @"Delete from Tbl_Cargo_Product where ProductID=@ProductID ";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, ProductID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 锁定产品库存
        /// </summary>
        /// <param name="entity"></param>
        public void LockStockCargoProduct(List<CargoProductEntity> entity)
        {
            foreach (var it in entity)
            {
                string strSQL = @"Update Tbl_Cargo_Product set IsLockStock=@IsLockStock ";
                if (it.IsLockStock.Equals("1"))
                {
                    //锁定
                    strSQL += ",LockStockName=@LockStockName,LockStockDate=@LockStockDate,LockStockMemo=@LockStockMemo,UnLockStockDate=@UnLockStockDate";
                }
                strSQL += " where ProductID=@ProductID ";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@IsLockStock", DbType.String, it.IsLockStock);
                    if (it.IsLockStock.Equals("1"))
                    {
                        conn.AddInParameter(cmd, "@LockStockMemo", DbType.String, it.LockStockMemo);
                        conn.AddInParameter(cmd, "@LockStockName", DbType.String, it.LockStockName);
                        conn.AddInParameter(cmd, "@LockStockDate", DbType.DateTime, it.LockStockDate);
                        conn.AddInParameter(cmd, "@UnLockStockDate", DbType.Date, it.UnLockStockDate);
                    }
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, it.ProductID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
        }
        /// <summary>
        /// 修改产品的入库状态 
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoProductStatus(CargoProductEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Product Set InCargoStatus=@InCargoStatus,InHouseTime=@InHouseTime Where ProductID=@ProductID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int32, entity.ProductID);
                    conn.AddInParameter(cmd, "@InCargoStatus", DbType.String, entity.InCargoStatus);
                    conn.AddInParameter(cmd, "@InHouseTime", DbType.DateTime, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改产品信息 比如：批次
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoProductInfo(CargoProductEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Product SET ";
            if (!string.IsNullOrEmpty(entity.Batch))
            {
                strSQL += " Batch=@Batch,BatchYear=@BatchYear,BatchWeek=@BatchWeek ";
            }
            strSQL += " WHERE ProductID=@ProductID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!string.IsNullOrEmpty(entity.Batch))
                    {
                        conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);
                        conn.AddInParameter(cmd, "@BatchYear", DbType.Int32, entity.BatchYear);
                        conn.AddInParameter(cmd, "@BatchWeek", DbType.Int32, entity.BatchWeek);
                    }
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改产品数量
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoProductPiece(CargoProductEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Product SET ";
            if (entity.IsAdd) { strSQL += " Numbers=Numbers+@Numbers"; }
            else { strSQL += " Numbers=Numbers-@Numbers"; }
            strSQL += " Where ProductID=@ProductID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@Numbers", DbType.Int32, entity.Numbers);
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 复制产品数据
        /// </summary>
        /// <param name="entity"></param>
        public void CopyProduct(CargoProductEntity entity)
        {
            string strSQL = @"insert into Tbl_Cargo_Product (ProductName,TypeID,Model,GoodsCode,Specs,Figure,TreadWidth,FlatRatio,Meridian,HubDiameter,LoadIndex,SpeedLevel,SpeedMax,Size,Weight,UnitPrice,Numbers,CostPrice,TradePrice,SalePrice,Package,PackageNum,PackageWeight,InHouseTime,InCargoStatus,Batch,BatchYear,BatchWeek,HouseID,Source,SourceOrderNo,BelongMonth,SpecsType) select ProductName,TypeID,Model,GoodsCode,Specs,Figure,TreadWidth,FlatRatio,Meridian,HubDiameter,LoadIndex,SpeedLevel,SpeedMax,Size,Weight,@UnitPrice,@Numbers,@CostPrice,@TradePrice,@SalePrice,Package,PackageNum,PackageWeight,InHouseTime,@InCargoStatus,@Batch,@BatchYear,@BatchWeek,@HouseID,@Source,@SourceOrderNo,@BelongMonth,SpecsType from Tbl_Cargo_Product where ProductID=@ProductID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.AddInParameter(cmd, "@Numbers", DbType.Int32, entity.Numbers);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@InCargoStatus", DbType.String, entity.InCargoStatus);
                    conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);
                    conn.AddInParameter(cmd, "@BatchYear", DbType.Int32, entity.BatchYear);
                    conn.AddInParameter(cmd, "@BatchWeek", DbType.Int32, entity.BatchWeek);
                    conn.AddInParameter(cmd, "@Source", DbType.String, entity.Source);
                    conn.AddInParameter(cmd, "@SourceOrderNo", DbType.String, entity.SourceOrderNo);
                    conn.AddInParameter(cmd, "@BelongMonth", DbType.String, entity.BelongMonth);
                    conn.AddInParameter(cmd, "@UnitPrice", DbType.Decimal, entity.UnitPrice);
                    conn.AddInParameter(cmd, "@TradePrice", DbType.Decimal, entity.TradePrice);
                    conn.AddInParameter(cmd, "@SalePrice", DbType.Decimal, entity.SalePrice);
                    conn.AddInParameter(cmd, "@CostPrice", DbType.Decimal, entity.CostPrice);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 根据产品ID查询产品数据
        /// </summary>
        /// <param name="productID"></param>
        /// <returns></returns>
        public CargoProductEntity QueryProductInfoByID(long productID)
        {
            CargoProductEntity result = new CargoProductEntity();

            try
            {
                string strSQL = @"Select a.*,h.Name as HouseName, b.SourceCode,b.SourceName,c.TypeName,ps.Thumbnail,ps.DetailDrawing from Tbl_Cargo_Product as a inner join Tbl_Cargo_House h on a.HouseID=h.HouseID left join Tbl_Cargo_ProductSource as b on a.Source=b.Source inner join Tbl_Cargo_ProductType c on a.TypeID=c.TypeID left join Tbl_Cargo_ProductSpec ps on a.Specs=ps.Specs and a.Figure=ps.Figure and a.GoodsCode=ps.GoodsCode where a.ProductID=@ProductID ";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, productID);
                    using (DataTable dd = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.ProductID = Convert.ToInt64(idr["ProductID"]);
                            result.ProductName = Convert.ToString(idr["ProductName"]);
                            result.TypeID = Convert.ToInt32(idr["TypeID"]);
                            result.TypeName = Convert.ToString(idr["TypeName"]);
                            result.Model = Convert.ToString(idr["Model"]);
                            result.GoodsCode = Convert.ToString(idr["GoodsCode"]);
                            result.Specs = Convert.ToString(idr["Specs"]);
                            result.Figure = Convert.ToString(idr["Figure"]);
                            result.TreadWidth = Convert.ToInt32(idr["TreadWidth"]);
                            result.FlatRatio = Convert.ToInt32(idr["FlatRatio"]);
                            result.HubDiameter = Convert.ToInt32(idr["HubDiameter"]);
                            result.Meridian = Convert.ToString(idr["Meridian"]);
                            result.LoadIndex = Convert.ToString(idr["LoadIndex"]);
                            result.SpeedLevel = Convert.ToString(idr["SpeedLevel"]);
                            result.UnitPrice = Convert.ToDecimal(idr["UnitPrice"]);
                            result.CostPrice = Convert.ToDecimal(idr["CostPrice"]);
                            result.FinalCostPrice = Convert.ToDecimal(idr["FinalCostPrice"]);
                            result.TaxCostPrice = Convert.ToDecimal(idr["TaxCostPrice"]);
                            result.NoTaxCostPrice = Convert.ToDecimal(idr["NoTaxCostPrice"]);
                            result.NextDayPrice = Convert.ToDecimal(idr["NextDayPrice"]);
                            result.WholesalePrice = Convert.ToDecimal(idr["WholesalePrice"]);
                            result.TradePrice = Convert.ToDecimal(idr["TradePrice"]);
                            result.SalePrice = Convert.ToDecimal(idr["SalePrice"]);
                            result.InHousePrice = Convert.ToDecimal(idr["InHousePrice"]);
                            result.Batch = Convert.ToString(idr["Batch"]);
                            result.BatchWeek = Convert.ToInt32(idr["BatchWeek"]);
                            result.BatchYear = Convert.ToInt32(idr["BatchYear"]);
                            result.Born = Convert.ToString(idr["Born"]);
                            result.Assort = Convert.ToString(idr["Assort"]);
                            result.Source = Convert.ToString(idr["Source"]);
                            result.SourceCode = Convert.ToString(idr["SourceCode"]);
                            result.SourceName = Convert.ToString(idr["SourceName"]);
                            result.InCargoStatus = Convert.ToString(idr["InCargoStatus"]);
                            result.Thumbnail = Convert.ToString(idr["Thumbnail"]);
                            result.DetailDrawing = Convert.ToString(idr["DetailDrawing"]);
                            result.HouseID = Convert.ToInt32(idr["HouseID"]);
                            result.HouseName = Convert.ToString(idr["HouseName"]);
                            result.SuppClientNum = Convert.ToInt32(idr["SuppClientNum"]);
                            result.Supplier = Convert.ToString(idr["Supplier"]);
                            result.SpecsType = Convert.ToString(idr["SpecsType"]);
                            result.ProductCode = Convert.ToString(idr["ProductCode"]);
                            result.SupplierAddress = Convert.ToString(idr["SupplierAddress"]);
                            result.TyreModel = Convert.ToString(idr["TyreModel"]);
                            result.QalityRemark = Convert.ToString(idr["QalityRemark"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public CargoProductEntity QueryProductInfoByProductID(long productID)
        {
            CargoProductEntity result = new CargoProductEntity();

            try
            {
                string strSQL = @"select top 1 p.*,h.Name as HouseName, pso.SourceCode,pso.SourceName,pt.TypeName,psp.Thumbnail,psp.DetailDrawing,ca3.AreaID as FirstAreaID from Tbl_Cargo_Product p inner join Tbl_Cargo_House h on p.HouseID=h.HouseID left join Tbl_Cargo_ProductSource pso on p.Source=pso.Source inner join Tbl_Cargo_ProductType pt on p.TypeID=pt.TypeID left join Tbl_Cargo_ProductSpec psp on p.Specs=psp.Specs and p.Figure=psp.Figure and p.GoodsCode=psp.GoodsCode inner join Tbl_Cargo_ContainerGoods cg on p.ProductID=cg.ProductID inner join Tbl_Cargo_Container cc on cg.ContainerID=cc.ContainerID left join Tbl_Cargo_Area ca1 on cc.AreaID=ca1.AreaID left join Tbl_Cargo_Area ca2 on ca1.ParentID=ca2.AreaID left join Tbl_Cargo_Area ca3 on ca2.ParentID=ca3.AreaID where p.ProductID=@ProductID ";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, productID);
                    using (DataTable dd = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.ProductID = Convert.ToInt64(idr["ProductID"]);
                            result.ProductName = Convert.ToString(idr["ProductName"]);
                            result.ProductCode = Convert.ToString(idr["ProductCode"]);
                            result.TypeID = Convert.ToInt32(idr["TypeID"]);
                            result.TypeName = Convert.ToString(idr["TypeName"]);
                            result.Model = Convert.ToString(idr["Model"]);
                            result.GoodsCode = Convert.ToString(idr["GoodsCode"]);
                            result.Specs = Convert.ToString(idr["Specs"]);
                            result.Figure = Convert.ToString(idr["Figure"]);
                            result.TreadWidth = Convert.ToInt32(idr["TreadWidth"]);
                            result.FlatRatio = Convert.ToInt32(idr["FlatRatio"]);
                            result.HubDiameter = Convert.ToInt32(idr["HubDiameter"]);
                            result.Meridian = Convert.ToString(idr["Meridian"]);
                            result.LoadIndex = Convert.ToString(idr["LoadIndex"]);
                            result.SpeedLevel = Convert.ToString(idr["SpeedLevel"]);
                            result.UnitPrice = Convert.ToDecimal(idr["UnitPrice"]);
                            result.CostPrice = Convert.ToDecimal(idr["CostPrice"]);
                            result.FinalCostPrice = Convert.ToDecimal(idr["FinalCostPrice"]);
                            result.TaxCostPrice = Convert.ToDecimal(idr["TaxCostPrice"]);
                            result.NoTaxCostPrice = Convert.ToDecimal(idr["NoTaxCostPrice"]);
                            result.TradePrice = Convert.ToDecimal(idr["TradePrice"]);
                            result.SalePrice = Convert.ToDecimal(idr["SalePrice"]);
                            result.Batch = Convert.ToString(idr["Batch"]);
                            result.BatchWeek = Convert.ToInt32(idr["BatchWeek"]);
                            result.BatchYear = Convert.ToInt32(idr["BatchYear"]);
                            result.Born = Convert.ToString(idr["Born"]);
                            result.Assort = Convert.ToString(idr["Assort"]);
                            result.Source = Convert.ToString(idr["Source"]);
                            result.SourceCode = Convert.ToString(idr["SourceCode"]);
                            result.SourceName = Convert.ToString(idr["SourceName"]);
                            result.InCargoStatus = Convert.ToString(idr["InCargoStatus"]);
                            result.Thumbnail = Convert.ToString(idr["Thumbnail"]);
                            result.DetailDrawing = Convert.ToString(idr["DetailDrawing"]);
                            result.HouseID = Convert.ToInt32(idr["HouseID"]);
                            result.HouseName = Convert.ToString(idr["HouseName"]);
                            result.FirstAreaID = Convert.ToInt32(idr["FirstAreaID"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        public CargoProductEntity QueryProductInfoByProductCode(string productCode)
        {
            CargoProductEntity result = new CargoProductEntity();

            try
            {
                string strSQL = @"
SELECT
	TOP 1 p.*
FROM
	Tbl_Cargo_Product p
WHERE
	p.ProductCode = @ProductCode
ORDER BY
    p.ProductID DESC";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, productCode);
                    using (DataTable dd = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.ProductID = Convert.ToInt64(idr["ProductID"]);
                            result.ProductName = Convert.ToString(idr["ProductName"]);
                            result.ProductCode = Convert.ToString(idr["ProductCode"]);
                            result.TypeID = Convert.ToInt32(idr["TypeID"]);
                            result.Model = Convert.ToString(idr["Model"]);
                            result.GoodsCode = Convert.ToString(idr["GoodsCode"]);
                            result.Specs = Convert.ToString(idr["Specs"]);
                            result.Figure = Convert.ToString(idr["Figure"]);
                            result.HouseID = Convert.ToInt32(idr["HouseID"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        public List<CargoProductEntity> QueryProductByIDs(long[] productIDs)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();

            try
            {
                string createIDsTempTblSQL = @"
IF OBJECT_ID('tempdb..##IDs') IS NOT NULL DROP TABLE ##IDs;
CREATE TABLE 
	##IDs(
		ID INT
	)
;
";
                string strSQL = @"select p.*,h.Name as HouseName, pso.SourceCode,pso.SourceName,pt.TypeName,psp.Thumbnail,
psp.DetailDrawing,ca3.AreaID as FirstAreaID 
from Tbl_Cargo_Product p 
inner join Tbl_Cargo_House h on p.HouseID=h.HouseID 
left join Tbl_Cargo_ProductSource pso on p.Source=pso.Source
inner join Tbl_Cargo_ProductType pt on p.TypeID=pt.TypeID 
left join Tbl_Cargo_ProductSpec psp on p.Specs=psp.Specs and p.Figure=psp.Figure and p.GoodsCode=psp.GoodsCode 
inner join Tbl_Cargo_ContainerGoods cg on p.ProductID=cg.ProductID 
inner join Tbl_Cargo_Container cc on cg.ContainerID=cc.ContainerID 
left join Tbl_Cargo_Area ca1 on cc.AreaID=ca1.AreaID
left join Tbl_Cargo_Area ca2 on ca1.ParentID=ca2.AreaID 
left join Tbl_Cargo_Area ca3 on ca2.ParentID=ca3.AreaID
INNER JOIN ##IDs IDS ON p.ProductID = IDS.ID";
                List<SqlParameter> sqlParameters = new List<SqlParameter>();
                int batchSize = 1000;
                if (!productIDs.Any()) { return result; }

                var groupedPrdctIDs = productIDs.Select((row, index) => new { row, index })
                        .GroupBy(x => x.index / batchSize)
                        .Select(g => g.Select(x => x.row).ToList());
                using (DbCommand cmd = conn.GetSqlStringCommond(createIDsTempTblSQL))
                {
                    cmd.Connection.Open();
                    cmd.ExecuteNonQuery();
                    foreach (var groupData in groupedPrdctIDs)
                    {
                        string insertIDsTempSql = @"
INSERT INTO ##IDs (ID)
Values @{tempTblVals}
;
";
                        List<string> tempTblVals = new List<string>();
                        foreach (var id in groupData)
                        {
                            tempTblVals.Add($"({id})");
                        }
                        insertIDsTempSql = insertIDsTempSql.Replace("@{tempTblVals}", string.Join("," + Environment.NewLine, tempTblVals));
                        cmd.CommandText = insertIDsTempSql;
                        cmd.ExecuteNonQuery();
                    }


                    cmd.CommandText = strSQL;
                    using (DataTable dd = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            var productData = new CargoProductEntity();
                            productData.ProductID = Convert.ToInt64(idr["ProductID"]);
                            productData.ProductName = Convert.ToString(idr["ProductName"]);
                            productData.ProductCode = Convert.ToString(idr["ProductCode"]);
                            productData.TypeID = Convert.ToInt32(idr["TypeID"]);
                            productData.TypeName = Convert.ToString(idr["TypeName"]);
                            productData.Model = Convert.ToString(idr["Model"]);
                            productData.GoodsCode = Convert.ToString(idr["GoodsCode"]);
                            productData.Specs = Convert.ToString(idr["Specs"]);
                            productData.Figure = Convert.ToString(idr["Figure"]);
                            productData.TreadWidth = Convert.ToInt32(idr["TreadWidth"]);
                            productData.FlatRatio = Convert.ToInt32(idr["FlatRatio"]);
                            productData.HubDiameter = Convert.ToInt32(idr["HubDiameter"]);
                            productData.Meridian = Convert.ToString(idr["Meridian"]);
                            productData.LoadIndex = Convert.ToString(idr["LoadIndex"]);
                            productData.SpeedLevel = Convert.ToString(idr["SpeedLevel"]);
                            productData.UnitPrice = Convert.ToDecimal(idr["UnitPrice"]);
                            productData.CostPrice = Convert.ToDecimal(idr["CostPrice"]);
                            productData.FinalCostPrice = Convert.ToDecimal(idr["FinalCostPrice"]);
                            productData.TaxCostPrice = Convert.ToDecimal(idr["TaxCostPrice"]);
                            productData.NoTaxCostPrice = Convert.ToDecimal(idr["NoTaxCostPrice"]);
                            productData.TradePrice = Convert.ToDecimal(idr["TradePrice"]);
                            productData.SalePrice = Convert.ToDecimal(idr["SalePrice"]);
                            productData.Batch = Convert.ToString(idr["Batch"]);
                            productData.BatchWeek = Convert.ToInt32(idr["BatchWeek"]);
                            productData.BatchYear = Convert.ToInt32(idr["BatchYear"]);
                            productData.Born = Convert.ToString(idr["Born"]);
                            productData.Assort = Convert.ToString(idr["Assort"]);
                            productData.Source = Convert.ToString(idr["Source"]);
                            productData.SourceCode = Convert.ToString(idr["SourceCode"]);
                            productData.SourceName = Convert.ToString(idr["SourceName"]);
                            productData.InCargoStatus = Convert.ToString(idr["InCargoStatus"]);
                            productData.Thumbnail = Convert.ToString(idr["Thumbnail"]);
                            productData.DetailDrawing = Convert.ToString(idr["DetailDrawing"]);
                            productData.HouseID = Convert.ToInt32(idr["HouseID"]);
                            productData.HouseName = Convert.ToString(idr["HouseName"]);
                            productData.FirstAreaID = Convert.ToInt32(idr["FirstAreaID"]);
                            result.Add(productData);
                        }
                    }
                }
            }
            catch (ApplicationException) { throw; }
            return result;
        }
        public List<CargoProductEntity> QueryProductByCodes(string[] productCodes)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();

            try
            {
                string createIDsTempTblSQL = @"
IF OBJECT_ID('tempdb..##IDs') IS NOT NULL DROP TABLE ##IDs;
CREATE TABLE 
	##IDs(
		ID NVARCHAR(50)
	)
;
";
                // 使用 ROW_NUMBER 去重，性能最佳
                string strSQL = @"
WITH UniqueProducts AS (
    SELECT
        ProductCode,
        ProductName,
        TypeID,
        GoodsCode,
        Specs,
        Figure,
        LoadIndex,
        SpeedLevel,
        Model,
        ROW_NUMBER() OVER (PARTITION BY ProductCode ORDER BY ProductID) AS rn
    FROM Tbl_Cargo_Product
    WHERE TRIM(ProductCode) IN (SELECT ID FROM ##IDs)
)
SELECT
    p.ProductCode,
    p.ProductName,
    p.TypeID,
    p.GoodsCode,
    p.Specs,
    p.Figure,
    p.LoadIndex,
    p.SpeedLevel,
    p.Model,
    pt.TypeName
FROM UniqueProducts p
INNER JOIN Tbl_Cargo_ProductType pt ON p.TypeID = pt.TypeID
WHERE p.rn = 1";
                List<SqlParameter> sqlParameters = new List<SqlParameter>();
                int batchSize = 1000;
                if (!productCodes.Any()) { return result; }

                var groupedPrdctIDs = productCodes.Select((row, index) => new { row, index })
                        .GroupBy(x => x.index / batchSize)
                        .Select(g => g.Select(x => x.row).ToList());
                using (DbCommand cmd = conn.GetSqlStringCommond(createIDsTempTblSQL))
                {
                    cmd.Connection.Open();
                    cmd.ExecuteNonQuery();
                    foreach (var groupData in groupedPrdctIDs)
                    {
                        string insertIDsTempSql = @"
INSERT INTO ##IDs (ID)
Values @{tempTblVals}
;
";
                        List<string> tempTblVals = new List<string>();
                        foreach (var id in groupData)
                        {
                            tempTblVals.Add($"('{id?.Trim()}')");
                        }
                        insertIDsTempSql = insertIDsTempSql.Replace("@{tempTblVals}", string.Join("," + Environment.NewLine, tempTblVals));
                        cmd.CommandText = insertIDsTempSql;
                        cmd.ExecuteNonQuery();
                    }


                    cmd.CommandText = strSQL;
                    using (DataTable dd = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            var productData = new CargoProductEntity();
                            // 只赋值实际使用的字段
                            productData.ProductCode = Convert.ToString(idr["ProductCode"]);
                            productData.ProductName = Convert.ToString(idr["ProductName"]);
                            productData.TypeID = Convert.ToInt32(idr["TypeID"]);
                            productData.TypeName = Convert.ToString(idr["TypeName"]);
                            productData.GoodsCode = Convert.ToString(idr["GoodsCode"]);
                            productData.Specs = Convert.ToString(idr["Specs"]);
                            productData.Figure = Convert.ToString(idr["Figure"]);
                            productData.LoadIndex = Convert.ToString(idr["LoadIndex"]);
                            productData.SpeedLevel = Convert.ToString(idr["SpeedLevel"]);
                            productData.Model = Convert.ToString(idr["Model"]);
                            result.Add(productData);
                        }
                    }
                }
            }
            catch (ApplicationException) { throw; }
            return result;
        }

        public CargoAreaEntity QueryProductAreaInfo(long productID)
        {
            CargoAreaEntity result = new CargoAreaEntity();
            try
            {
                string strSQL = @"select a.* from Tbl_Cargo_Product p inner join Tbl_Cargo_ContainerGoods cg on p.ProductID=cg.ProductID inner join Tbl_Cargo_Container c on cg.ContainerID=c.ContainerID inner join Tbl_Cargo_Area a2 on c.AreaID=a2.AreaID inner join Tbl_Cargo_Area a1 on a2.ParentID=a1.AreaID inner join Tbl_Cargo_Area a on a1.ParentID=a.AreaID where p.ProductID=@ProductID ";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, productID);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result = new CargoAreaEntity
                            {
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                Name = Convert.ToString(idr["Name"]),
                                Code = Convert.ToString(idr["Code"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ParentID = Convert.ToInt32(idr["ParentID"]),
                                DeliveryArea = Convert.ToString(idr["DeliveryArea"]),
                                AreaType = Convert.ToString(idr["AreaType"]),
                                OrderCode = Convert.ToString(idr["OrderCode"]),
                                OrderDep = Convert.ToString(idr["OrderDep"]),
                                Longitude = Convert.ToString(idr["Longitude"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                Address = Convert.ToString(idr["Address"]),
                                Remark = Convert.ToString(idr["Remark"])
                            };
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询产品数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoProductEntity QueryProductInfo(CargoProductEntity entity)
        {
            CargoProductEntity result = new CargoProductEntity();
            try
            {
                string strSQL = @"Select top 1 a.ProductID,b.ID,b.InCargoID,b.ContainerID,b.Piece from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID inner join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID where a.HouseID=@HouseID and c.ContainerCode=@ContainerCode ";
                if (!entity.SuppClientNum.Equals(0)) { strSQL += " and a.SuppClientNum=" + entity.SuppClientNum + ""; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID + ""; }
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs='" + entity.Specs + "'"; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch='" + entity.Batch + "'"; }
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode='" + entity.GoodsCode + "'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure='" + entity.Figure + "'"; }
                if (!string.IsNullOrEmpty(entity.BelongDepart)) { strSQL += " and a.BelongDepart='" + entity.BelongDepart + "'"; }
                if (!string.IsNullOrEmpty(entity.OperaType)) { strSQL += " and a.OperaType='" + entity.OperaType + "'"; }
                if (!string.IsNullOrEmpty(entity.Source)) { strSQL += " and a.Source='" + entity.Source + "'"; }
                if (!string.IsNullOrEmpty(entity.SpecsType)) { strSQL += " and a.SpecsType='" + entity.SpecsType + "'"; }
                if (!string.IsNullOrEmpty(entity.IsSpecsType)) { strSQL += " and a.SpecsType<>'" + entity.IsSpecsType + "'"; }
                if (!string.IsNullOrEmpty(entity.TyreModel)) { strSQL += " and a.TyreModel='" + entity.TyreModel + "'"; }
                strSQL += " order by b.Piece desc,b.InHouseTime desc";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    // conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs);
                    // conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);
                    conn.AddInParameter(cmd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    using (DataTable dd = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.ProductID = Convert.ToInt64(idr["ProductID"]);
                            result.ContainerGoodsID = Convert.ToInt64(idr["ID"]);
                            result.InCargoID = Convert.ToString(idr["InCargoID"]);
                            result.ContainerID = Convert.ToInt32(idr["ContainerID"]);
                            result.Numbers = Convert.ToInt32(idr["Piece"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询在库数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryInHouseProductData(int pIndex, int pNum, CargoContainerShowEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber, b.ID,c.ContainerID,c.ContainerCode,c.ContainerType,b.Piece,d.AreaID,d.Name as AreaName,d.ParentID,e.Name as HouseName,e.HouseCode,f.TypeName,f.ParentID as TypeParentID,f.TypeParentName, a.*,ISNULL(g.OnSaleNum,0) as OnSaleNum,g.Title,g.Memo,g.FileName,ISNULL(g.ID,0) as OnSaleID,g.SaleType,g.ShelveStatus,ISNULL(g.Consume,0) as Consume,ISNULL(g.ProductPrice,0) as ProductPrice from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID and a.SpecsType<>5 inner join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID inner join Tbl_Cargo_Area as d on c.AreaID=d.AreaID  ";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " inner join Tbl_Cargo_Area as h on d.ParentID=h.AreaID";
                }
                strSQL += " inner join Tbl_Cargo_House as e on d.HouseID=e.HouseID inner join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID left join Tbl_Cargo_Shelves as g on a.ProductID=g.ProductID where (1=1) ";//and d.AreaType='1'
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " and h.ParentID=" + entity.FirstAreaID + "";
                }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //以产品名称为查询条件
                //if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strCount += " and a.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strSQL += " and f.ParentID=" + entity.TypeParentID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                if (!entity.TreadWidth.Equals(0)) { strSQL += " and a.TreadWidth=" + entity.TreadWidth; }
                if (!entity.FlatRatio.Equals(0)) { strSQL += " and a.FlatRatio=" + entity.FlatRatio; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch = '" + entity.Batch + "'"; }
                if (!entity.BatchYear.Equals(0)) { strSQL += " and a.BatchYear=" + entity.BatchYear; }
                if (!entity.BatchWeekStart.Equals(0)) { strSQL += " and a.BatchWeek>=" + entity.BatchWeekStart; }
                if (!entity.BatchWeekEnd.Equals(0)) { strSQL += " and a.BatchWeek<=" + entity.BatchWeekEnd; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure = '" + entity.Figure + "'"; }
                if (!entity.HubDiameter.Equals(0)) { strSQL += " and a.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex=" + entity.LoadIndex; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                if (!string.IsNullOrEmpty(entity.OnShelves))
                {
                    strSQL += " and g.ShelveStatus='" + entity.OnShelves + "'";
                }
                if (!string.IsNullOrEmpty(entity.SaleType)) { strSQL += " and g.SaleType = '" + entity.SaleType + "'"; }

                if (!entity.HouseID.Equals(0)) { strSQL += " and e.HouseID=@HouseID"; }
                //if (!entity.FirstAreaID.Equals(0)) { strSQL += " and d.ParentID=@ParentID"; }
                //if (!entity.AreaID.Equals(0)) { strSQL += " and (b.ParentID=@AreaID or b.AreaID=@AreaID)"; }
                if (!string.IsNullOrEmpty(entity.ContainerCode)) { strSQL += " and c.ContainerCode=@ContainerCode"; }
                if (!string.IsNullOrEmpty(entity.ContainerType)) { strSQL += " and c.ContainerType=@ContainerType"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (entity.Piece.Equals(0))
                {
                    strSQL += " and b.Piece > 4";
                }
                else if (entity.Piece.Equals(1))
                {
                    strSQL += " and b.Piece < 5 and b.Piece > 0";
                }
                else if (entity.Piece.Equals(2))
                {
                    strSQL += " and b.Piece = 0";
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                //strSQL += " order by a.Figure asc,a.BatchYear asc,a.BatchWeek asc";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!entity.HouseID.Equals(0)) { conn.AddInParameter(cmdAdd, "@HouseID", DbType.Int32, entity.HouseID); }
                    //if (!entity.FirstAreaID.Equals(0))
                    //{
                    //    conn.AddInParameter(cmdAdd, "@ParentID", DbType.Int32, entity.FirstAreaID);
                    //}
                    //if (!entity.AreaID.Equals(0)){conn.AddInParameter(cmdAdd, "@AreaID", DbType.Int32, entity.AreaID);}
                    if (!string.IsNullOrEmpty(entity.ContainerCode))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    }
                    if (!string.IsNullOrEmpty(entity.ContainerType))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerType", DbType.String, entity.ContainerType);
                    }
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            if (string.IsNullOrEmpty(entity.OnShelves) && string.IsNullOrEmpty(Convert.ToString(idr["Title"])))
                            {
                                if (!entity.Piece.Equals(2))
                                {
                                    if (Convert.ToInt32(idr["Piece"]) <= 0) { continue; }
                                }
                            }
                            //CargoAreaEntity cargoArea = new CargoAreaEntity();
                            //CargoAreaEntity hArea = new CargoAreaEntity();
                            ////如果父ID不为0，则查询父ID的区域名称
                            //if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            //{
                            //    cargoArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                            //    if (!cargoArea.ParentID.Equals(0))
                            //    {
                            //        hArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                            //    }
                            //}

                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                Piece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InPiece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InHouseTime = Convert.ToDateTime(idr["InHouseTime"]),//入库时间
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                //FirstAreaName = cargoArea.Name,
                                //ParentAreaName = hArea.Name,
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseCode = Convert.ToString(idr["HouseCode"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                TypeParentID = Convert.ToInt32(idr["TypeParentID"]),
                                TypeParentName = Convert.ToString(idr["TypeParentName"]),
                                Model = Convert.ToString(idr["Model"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                                Meridian = Convert.ToString(idr["Meridian"]),
                                HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = Convert.ToInt32(idr["SpeedMax"]),
                                Size = Convert.ToString(idr["Size"]),
                                Weight = Convert.ToDecimal(idr["Weight"]),
                                UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                                Numbers = Convert.ToInt32(idr["Numbers"]),
                                CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                Package = Convert.ToString(idr["Package"]),
                                PackageNum = Convert.ToInt32(idr["PackageNum"]),
                                PackageWeight = Convert.ToDecimal(idr["PackageWeight"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                ShelvesNum = Convert.ToInt32(idr["OnSaleNum"]),
                                Title = Convert.ToString(idr["Title"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                FileName = Convert.ToString(idr["FileName"]),
                                OnSaleID = Convert.ToInt64(idr["OnSaleID"]),
                                Consume = Convert.ToInt32(idr["Consume"]),
                                ProductPrice = Convert.ToDecimal(idr["ProductPrice"]),
                                SaleType = Convert.ToString(idr["SaleType"]),
                                OnShelves = !string.IsNullOrEmpty(Convert.ToString(idr["Title"])) && Convert.ToString(idr["ShelveStatus"]).Equals("0") ? "0" : "1",
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                GoodsName = Convert.ToString(idr["GoodsName"]),
                            });
                        }
                    }
                }

                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID left join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID ";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strCount += " left join Tbl_Cargo_Area as h on d.ParentID=h.AreaID";
                }
                strCount += " left join Tbl_Cargo_House as e on d.HouseID=e.HouseID left join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID left join Tbl_Cargo_Shelves as g on a.ProductID=g.ProductID where (1=1)";// and d.AreaType='1'
                if (!entity.FirstAreaID.Equals(0))
                {
                    strCount += " and h.ParentID=" + entity.FirstAreaID + "";
                }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strCount += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //以产品名称为查询条件
                //if (!string.IsNullOrEmpty(entity.Specs)) { strCount += " and a.Specs like '%" + entity.Specs + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strCount += " and a.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strCount += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strCount += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strCount += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strCount += " and a.Model like '%" + entity.Model + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strCount += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strCount += " and f.ParentID=" + entity.TypeParentID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strCount += " and a.TypeID=" + entity.TypeID; }
                if (!entity.TreadWidth.Equals(0)) { strCount += " and a.TreadWidth=" + entity.TreadWidth; }
                if (!entity.FlatRatio.Equals(0)) { strCount += " and a.FlatRatio=" + entity.FlatRatio; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strCount += " and a.Batch = '" + entity.Batch + "'"; }
                if (!entity.BatchWeekStart.Equals(0)) { strCount += " and a.BatchWeek>=" + entity.BatchWeekStart; }
                if (!entity.BatchWeekEnd.Equals(0)) { strCount += " and a.BatchWeek<=" + entity.BatchWeekEnd; }
                if (!entity.BatchYear.Equals(0)) { strCount += " and a.BatchYear=" + entity.BatchYear; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and a.Figure = '" + entity.Figure + "'"; }
                if (!entity.HubDiameter.Equals(0)) { strCount += " and a.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strCount += " and a.LoadIndex=" + entity.LoadIndex; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strCount += " and a.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                if (!string.IsNullOrEmpty(entity.OnShelves))
                {
                    strCount += " and g.ShelveStatus='" + entity.OnShelves + "'";
                }
                if (!string.IsNullOrEmpty(entity.SaleType)) { strCount += " and g.SaleType = '" + entity.SaleType + "'"; }

                if (!entity.HouseID.Equals(0)) { strCount += " and e.HouseID=@HouseID"; }
                //if (!entity.FirstAreaID.Equals(0)) { strCount += " and d.ParentID=@ParentID"; }
                //if (!entity.AreaID.Equals(0)) { strSQL += " and (b.ParentID=@AreaID or b.AreaID=@AreaID)"; }
                if (!string.IsNullOrEmpty(entity.ContainerCode)) { strCount += " and c.ContainerCode=@ContainerCode"; }
                if (!string.IsNullOrEmpty(entity.ContainerType)) { strCount += " and c.ContainerType=@ContainerType"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (entity.Piece.Equals(0))
                {
                    strCount += " and b.Piece > 4";
                }
                else if (entity.Piece.Equals(1))
                {
                    strCount += " and b.Piece < 5 and b.Piece > 0";
                }
                else if (entity.Piece.Equals(2))
                {
                    strCount += " and b.Piece = 0";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    if (!entity.HouseID.Equals(0)) { conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID); }
                    //if (!entity.FirstAreaID.Equals(0))
                    //{
                    //    conn.AddInParameter(cmd, "@ParentID", DbType.Int32, entity.FirstAreaID);
                    //}
                    if (!string.IsNullOrEmpty(entity.ContainerCode))
                    {
                        conn.AddInParameter(cmd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    }
                    if (!string.IsNullOrEmpty(entity.ContainerType))
                    {
                        conn.AddInParameter(cmd, "@ContainerType", DbType.String, entity.ContainerType);
                    }
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }


        public List<CargoContainerShowEntity> QueryInHouseProductDataList(CargoContainerShowEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            try
            {
                string strSQL = @" select b.ID,c.ContainerID,c.ContainerCode,c.ContainerType,b.Piece,d.AreaID,d.Name as AreaName,d.ParentID,e.Name as HouseName,e.HouseCode,f.TypeName,f.ParentID as TypeParentID,f.TypeParentName, a.*,ISNULL(g.OnSaleNum,0) as OnSaleNum,g.Title,g.Memo,g.FileName,ISNULL(g.ID,0) as OnSaleID,g.SaleType,g.ShelveStatus,ISNULL(g.Consume,0) as Consume,ISNULL(g.ProductPrice,0) as ProductPrice from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID and a.SpecsType<>5 inner join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID inner join Tbl_Cargo_Area as d on c.AreaID=d.AreaID  ";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " inner join Tbl_Cargo_Area as h on d.ParentID=h.AreaID";
                }
                strSQL += " inner join Tbl_Cargo_House as e on d.HouseID=e.HouseID inner join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID left join Tbl_Cargo_Shelves as g on a.ProductID=g.ProductID where (1=1) ";//and d.AreaType='1'
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " and h.ParentID=" + entity.FirstAreaID + "";
                }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //以产品名称为查询条件
                //if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strCount += " and a.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strSQL += " and f.ParentID=" + entity.TypeParentID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                if (!entity.TreadWidth.Equals(0)) { strSQL += " and a.TreadWidth=" + entity.TreadWidth; }
                if (!entity.FlatRatio.Equals(0)) { strSQL += " and a.FlatRatio=" + entity.FlatRatio; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch = '" + entity.Batch + "'"; }
                if (!entity.BatchYear.Equals(0)) { strSQL += " and a.BatchYear=" + entity.BatchYear; }
                if (!entity.BatchWeekStart.Equals(0)) { strSQL += " and a.BatchWeek>=" + entity.BatchWeekStart; }
                if (!entity.BatchWeekEnd.Equals(0)) { strSQL += " and a.BatchWeek<=" + entity.BatchWeekEnd; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure = '" + entity.Figure + "'"; }
                if (!entity.HubDiameter.Equals(0)) { strSQL += " and a.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex=" + entity.LoadIndex; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                if (!string.IsNullOrEmpty(entity.OnShelves))
                {
                    strSQL += " and g.ShelveStatus='" + entity.OnShelves + "'";
                }
                if (!string.IsNullOrEmpty(entity.SaleType)) { strSQL += " and g.SaleType = '" + entity.SaleType + "'"; }

                if (!entity.HouseID.Equals(0)) { strSQL += " and e.HouseID=@HouseID"; }
                //if (!entity.FirstAreaID.Equals(0)) { strSQL += " and d.ParentID=@ParentID"; }
                //if (!entity.AreaID.Equals(0)) { strSQL += " and (b.ParentID=@AreaID or b.AreaID=@AreaID)"; }
                if (!string.IsNullOrEmpty(entity.ContainerCode)) { strSQL += " and c.ContainerCode=@ContainerCode"; }
                if (!string.IsNullOrEmpty(entity.ContainerType)) { strSQL += " and c.ContainerType=@ContainerType"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (entity.Piece.Equals(0))
                {
                    strSQL += " and b.Piece > 4";
                }
                else if (entity.Piece.Equals(1))
                {
                    strSQL += " and b.Piece < 5 and b.Piece > 0";
                }
                else if (entity.Piece.Equals(2))
                {
                    strSQL += " and b.Piece = 0";
                }
                //strSQL += " order by a.Figure asc,a.BatchYear asc,a.BatchWeek asc";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!entity.HouseID.Equals(0)) { conn.AddInParameter(cmdAdd, "@HouseID", DbType.Int32, entity.HouseID); }
                    //if (!entity.FirstAreaID.Equals(0))
                    //{
                    //    conn.AddInParameter(cmdAdd, "@ParentID", DbType.Int32, entity.FirstAreaID);
                    //}
                    //if (!entity.AreaID.Equals(0)){conn.AddInParameter(cmdAdd, "@AreaID", DbType.Int32, entity.AreaID);}
                    if (!string.IsNullOrEmpty(entity.ContainerCode))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    }
                    if (!string.IsNullOrEmpty(entity.ContainerType))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerType", DbType.String, entity.ContainerType);
                    }
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            if (string.IsNullOrEmpty(entity.OnShelves) && string.IsNullOrEmpty(Convert.ToString(idr["Title"])))
                            {
                                if (!entity.Piece.Equals(2))
                                {
                                    if (Convert.ToInt32(idr["Piece"]) <= 0) { continue; }
                                }
                            }

                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                Piece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InPiece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InHouseTime = Convert.ToDateTime(idr["InHouseTime"]),//入库时间
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                //FirstAreaName = cargoArea.Name,
                                //ParentAreaName = hArea.Name,
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseCode = Convert.ToString(idr["HouseCode"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                TypeParentID = Convert.ToInt32(idr["TypeParentID"]),
                                TypeParentName = Convert.ToString(idr["TypeParentName"]),
                                Model = Convert.ToString(idr["Model"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                                Meridian = Convert.ToString(idr["Meridian"]),
                                HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = Convert.ToInt32(idr["SpeedMax"]),
                                Size = Convert.ToString(idr["Size"]),
                                Weight = Convert.ToDecimal(idr["Weight"]),
                                UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                                Numbers = Convert.ToInt32(idr["Numbers"]),
                                CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                Package = Convert.ToString(idr["Package"]),
                                PackageNum = Convert.ToInt32(idr["PackageNum"]),
                                PackageWeight = Convert.ToDecimal(idr["PackageWeight"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                ShelvesNum = Convert.ToInt32(idr["OnSaleNum"]),
                                Title = Convert.ToString(idr["Title"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                FileName = Convert.ToString(idr["FileName"]),
                                OnSaleID = Convert.ToInt64(idr["OnSaleID"]),
                                Consume = Convert.ToInt32(idr["Consume"]),
                                ProductPrice = Convert.ToDecimal(idr["ProductPrice"]),
                                SaleType = Convert.ToString(idr["SaleType"]),
                                OnShelves = !string.IsNullOrEmpty(Convert.ToString(idr["Title"])) && Convert.ToString(idr["ShelveStatus"]).Equals("0") ? "0" : "1",
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                GoodsName = Convert.ToString(idr["GoodsName"]),
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        /// <summary>
        /// 查询所有在库数据用于导出
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryInHouseProductDataForExport(CargoContainerShowEntity entity)
        {
            CargoHouseManager house = new CargoHouseManager();
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            try
            {
                var AreaEntityList = house.QueryAreaAll();

                string strSQL = @"select b.ID,c.ContainerID,c.ContainerCode,c.ContainerType,b.Piece,isnull(d.AreaID,0) as AreaID,d.Name as AreaName,isnull(d.ParentID,0) as ParentID,e.Name as HouseName,e.HouseCode,f.TypeName,f.ParentID as TypeParentID, a.*,ISNULL(g.OnSaleNum,0) as OnSaleNum,g.Title,g.Memo,g.FileName,ISNULL(g.ID,0) as OnSaleID,g.SaleType,g.ShelveStatus,ISNULL(g.Consume,0) as Consume,ISNULL(g.ProductPrice,0) as ProductPrice from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID left join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID  ";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " left join Tbl_Cargo_Area as h on d.ParentID=h.AreaID";
                }
                strSQL += " left join Tbl_Cargo_House as e on d.HouseID=e.HouseID left join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID left join Tbl_Cargo_Shelves as g on a.ProductID=g.ProductID where (1=1) ";//and d.AreaType='1'
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " and h.ParentID=" + entity.FirstAreaID + "";
                }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strSQL += " and f.ParentID=" + entity.TypeParentID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                if (!entity.TreadWidth.Equals(0)) { strSQL += " and a.TreadWidth=" + entity.TreadWidth; }
                if (!entity.FlatRatio.Equals(0)) { strSQL += " and a.FlatRatio=" + entity.FlatRatio; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch = '" + entity.Batch + "'"; }
                if (!entity.BatchYear.Equals(0)) { strSQL += " and a.BatchYear=" + entity.BatchYear; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure = '" + entity.Figure + "'"; }
                if (!entity.HubDiameter.Equals(0)) { strSQL += " and a.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex=" + entity.LoadIndex; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                if (!string.IsNullOrEmpty(entity.OnShelves))
                {
                    strSQL += " and g.ShelveStatus='" + entity.OnShelves + "'";
                }
                if (!string.IsNullOrEmpty(entity.SaleType)) { strSQL += " and g.SaleType = '" + entity.SaleType + "'"; }

                if (!entity.HouseID.Equals(0)) { strSQL += " and e.HouseID=@HouseID"; }
                //if (!entity.FirstAreaID.Equals(0)) { strSQL += " and d.ParentID=@ParentID"; }
                //if (!entity.AreaID.Equals(0)) { strSQL += " and (b.ParentID=@AreaID or b.AreaID=@AreaID)"; }
                if (!string.IsNullOrEmpty(entity.ContainerCode)) { strSQL += " and c.ContainerCode=@ContainerCode"; }
                if (!string.IsNullOrEmpty(entity.ContainerType)) { strSQL += " and c.ContainerType=@ContainerType"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (entity.Piece.Equals(0))
                {
                    strSQL += " and b.Piece > 4";
                }
                else if (entity.Piece.Equals(1))
                {
                    strSQL += " and b.Piece < 5 and b.Piece > 0";
                }
                else if (entity.Piece.Equals(2))
                {
                    strSQL += " and b.Piece = 0";
                }
                //strSQL += " order by a.Figure asc,a.BatchYear asc,a.BatchWeek asc";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!entity.HouseID.Equals(0)) { conn.AddInParameter(cmdAdd, "@HouseID", DbType.Int32, entity.HouseID); }
                    //if (!entity.FirstAreaID.Equals(0))
                    //{
                    //    conn.AddInParameter(cmdAdd, "@ParentID", DbType.Int32, entity.FirstAreaID);
                    //}
                    //if (!entity.AreaID.Equals(0)){conn.AddInParameter(cmdAdd, "@AreaID", DbType.Int32, entity.AreaID);}
                    if (!string.IsNullOrEmpty(entity.ContainerCode))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    }
                    if (!string.IsNullOrEmpty(entity.ContainerType))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerType", DbType.String, entity.ContainerType);
                    }
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            if (string.IsNullOrEmpty(entity.OnShelves) && string.IsNullOrEmpty(Convert.ToString(idr["Title"])))
                            {
                                if (!entity.Piece.Equals(2))
                                {
                                    if (Convert.ToInt32(idr["Piece"]) <= 0) { continue; }
                                }
                            }
                            CargoAreaEntity cargoArea = new CargoAreaEntity();
                            CargoAreaEntity hArea = new CargoAreaEntity();
                            //如果父ID不为0，则查询父ID的区域名称
                            if (!string.IsNullOrEmpty(Convert.ToString(idr["ParentID"])) && !Convert.ToInt32(idr["ParentID"]).Equals(0))
                            {
                                //cargoArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                                cargoArea = AreaEntityList.FirstOrDefault(a => a.AreaID == Convert.ToInt32(idr["ParentID"]));
                                if (!cargoArea.ParentID.Equals(0))
                                {
                                    //hArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                                    hArea = AreaEntityList.FirstOrDefault(a => a.AreaID == cargoArea.ParentID);
                                }
                            }
                            List<CargoProductTypeEntity> proTypeList = QueryProductType(new CargoProductTypeEntity { TypeID = Convert.ToInt32(idr["TypeParentID"]) });
                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                Piece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InPiece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InHouseTime = Convert.ToDateTime(idr["InHouseTime"]),//入库时间
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                AreaName = Convert.ToString(idr["AreaName"]).Trim(),
                                FirstAreaName = cargoArea.Name,
                                ParentAreaName = hArea.Name,
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseCode = Convert.ToString(idr["HouseCode"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                TypeParentID = Convert.ToInt32(idr["TypeParentID"]),
                                TypeParentName = proTypeList.Count > 0 ? proTypeList[0].TypeName : "",
                                Model = Convert.ToString(idr["Model"]).Trim(),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]).Trim(),
                                Figure = Convert.ToString(idr["Figure"]).Trim(),
                                Specs = Convert.ToString(idr["Specs"]).Trim(),
                                TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                                Meridian = Convert.ToString(idr["Meridian"]).Trim(),
                                HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = Convert.ToInt32(idr["SpeedMax"]),
                                Size = Convert.ToString(idr["Size"]),
                                Weight = Convert.ToDecimal(idr["Weight"]),
                                UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                                Numbers = Convert.ToInt32(idr["Numbers"]),
                                CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                Package = Convert.ToString(idr["Package"]).Trim(),
                                PackageNum = Convert.ToInt32(idr["PackageNum"]),
                                PackageWeight = Convert.ToDecimal(idr["PackageWeight"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]).Trim(),
                                Batch = Convert.ToString(idr["Batch"]),
                                ShelvesNum = Convert.ToInt32(idr["OnSaleNum"]),
                                Title = Convert.ToString(idr["Title"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                FileName = Convert.ToString(idr["FileName"]),
                                OnSaleID = Convert.ToInt64(idr["OnSaleID"]),
                                Consume = Convert.ToInt32(idr["Consume"]),
                                ProductPrice = Convert.ToDecimal(idr["ProductPrice"]),
                                SaleType = Convert.ToString(idr["SaleType"]),
                                OnShelves = !string.IsNullOrEmpty(Convert.ToString(idr["Title"])) && Convert.ToString(idr["ShelveStatus"]).Equals("0") ? "0" : "1",
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public List<CargoContainerShowEntity> QueryInHouseProductData(CargoContainerShowEntity entity)
        {
            CargoHouseManager house = new CargoHouseManager();
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            try
            {
                string strSQL = @"select * from Tbl_Cargo_Product p inner join Tbl_Cargo_ContainerGoods cg on p.ProductID=cg.ProductID where (1=1) ";
                if (!entity.TypeID.Equals(0)) { strSQL += " and p.TypeID=" + entity.TypeID; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and p.HouseID=" + entity.HouseID; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and p.HouseID=" + entity.HouseID; }
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and p.Specs='" + entity.Specs + "'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and p.Figure='" + entity.Figure + "'"; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and p.LoadIndex='" + entity.LoadIndex + "'"; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and p.SpeedLevel='" + entity.SpeedLevel + "'"; }
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoContainerShowEntity
                            {
                                Piece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InPiece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InHouseTime = Convert.ToDateTime(idr["InHouseTime"]),//入库时间
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                Model = Convert.ToString(idr["Model"]).Trim(),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]).Trim(),
                                Figure = Convert.ToString(idr["Figure"]).Trim(),
                                Specs = Convert.ToString(idr["Specs"]).Trim(),
                                TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                                Meridian = Convert.ToString(idr["Meridian"]).Trim(),
                                HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = Convert.ToInt32(idr["SpeedMax"]),
                                Size = Convert.ToString(idr["Size"]),
                                Weight = Convert.ToDecimal(idr["Weight"]),
                                UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                                Numbers = Convert.ToInt32(idr["Numbers"]),
                                CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                Package = Convert.ToString(idr["Package"]).Trim(),
                                PackageNum = Convert.ToInt32(idr["PackageNum"]),
                                PackageWeight = Convert.ToDecimal(idr["PackageWeight"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]).Trim(),
                                Batch = Convert.ToString(idr["Batch"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询在库数据 用于微信商城显示
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryWeixinInHouseProduct(int pIndex, int pNum, CargoContainerShowEntity entity)
        {
            CargoPriceManager price = new CargoPriceManager();
            CargoHouseManager house = new CargoHouseManager();
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY b.HubDiameter Asc) AS RowNumber,a.ID as OnSaleID,a.Title,a.FileName,a.Consume,a.SaleType,a.ProductPrice,b.Specs,b.Figure,b.Model,b.LoadIndex,b.SpeedLevel,b.TradePrice,b.BatchYear,b.Batch,b.BatchWeek,b.SalePrice,b.TypeID,b.HouseID,b.Assort,b.Born,a.ProductID  From Tbl_Cargo_Shelves as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID and a.TypeID=b.TypeID where (1=1) and a.ShelveStatus='0'";
                //所在仓库
                if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID=" + entity.HouseID + ""; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                //以产品名称为查询条件
                string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "");
                if (res.Length <= 3)
                {
                    if (!string.IsNullOrEmpty(res)) { strSQL += " and b.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strSQL += " and b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%'";
                }
                if (res.Length > 5)
                {
                    strSQL += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%')";
                }

                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and b.Model like '%" + entity.Model + "%'"; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and b.Batch = '" + entity.Batch + "'"; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and b.Figure = '" + entity.Figure + "'"; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and b.LoadIndex=" + entity.LoadIndex; }
                if (!entity.HubDiameter.Equals(0)) { strSQL += " and b.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and b.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                //strSQL += " order by a.Figure asc,a.BatchYear asc,a.BatchWeek asc";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            string batch = Convert.ToString(idr["BatchYear"]) + Convert.ToString(idr["BatchWeek"]);
                            List<CargoRuleBankEntity> rule = price.QueryRuleBank(new CargoRuleBankEntity { HouseID = Convert.ToInt32(idr["HouseID"]), TypeID = Convert.ToInt32(idr["TypeID"]), Specs = Convert.ToString(idr["Specs"]), Figure = Convert.ToString(idr["Figure"]), DelFlag = "0", StartBatch = Convert.ToInt32(batch) });
                            CargoRuleBankEntity rb = new CargoRuleBankEntity();
                            if (rule.Count > 0)
                            {
                                rb = rule.Find(c => c.RuleType.Equals("6"));
                            }
                            result.Add(new CargoContainerShowEntity
                            {
                                Specs = Convert.ToString(idr["Specs"]).Trim(),
                                Figure = Convert.ToString(idr["Figure"]).Trim(),
                                Model = Convert.ToString(idr["Model"]).Trim(),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                OnSaleID = Convert.ToInt64(idr["OnSaleID"]),
                                FileName = Convert.ToString(idr["FileName"]),
                                Title = Convert.ToString(idr["Title"]),
                                Assort = Convert.ToString(idr["Assort"]),
                                Born = Convert.ToString(idr["Born"]),
                                Batch = Convert.ToString(idr["BatchYear"]),
                                SaleType = Convert.ToString(idr["SaleType"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                Consume = Convert.ToInt32(idr["Consume"]),
                                CutEntry = rb.CutEntry,
                                IsCut = rb.ID.Equals(0) ? false : true,
                                RuleID = Convert.ToString(rb.ID),
                                //SalePrice = Convert.ToInt32(idr["TypeID"]).Equals(66) || Convert.ToInt32(idr["HouseID"]).Equals(12) ? Convert.ToDecimal(idr["SalePrice"]) : Convert.ToInt32(idr["BatchYear"]).Equals(18) ? Convert.ToDecimal(Convert.ToDouble(idr["SalePrice"]) * 0.85) : Convert.ToDecimal(idr["SalePrice"]),
                                SalePrice = Convert.ToString(idr["SaleType"]).Equals("1") || Convert.ToString(idr["SaleType"]).Equals("3") ? Convert.ToDecimal(idr["ProductPrice"]) : Convert.ToDecimal(idr["SalePrice"]),
                                TradePrice = Convert.ToString(idr["SaleType"]).Equals("1") || Convert.ToString(idr["SaleType"]).Equals("3") ? Convert.ToDecimal(idr["ProductPrice"]) : Convert.ToDecimal(idr["TradePrice"])
                            });
                        }
                    }
                }

                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount From Tbl_Cargo_Shelves as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID and a.TypeID=b.TypeID where (1=1) and a.ShelveStatus='0'";
                if (!entity.HouseID.Equals(0)) { strCount += " and b.HouseID=" + entity.HouseID + ""; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strCount += " and a.TypeID=" + entity.TypeID; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.Specs)) { strCount += " and b.Specs like '%" + entity.Specs + "%'"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strCount += " and b.Model like '%" + entity.Model + "%'"; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strCount += " and b.Batch = '" + entity.Batch + "'"; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and b.Figure = '" + entity.Figure + "'"; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strCount += " and b.LoadIndex=" + entity.LoadIndex; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strCount += " and b.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 商品上架
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoProductShelves(CargoProductShelvesEntity entity)
        {
            entity.EnSafe();
            Int64 did = 0;
            string strSQL = @"INSERT INTO Tbl_Cargo_Shelves(ProductName,TypeID,ProductID,OnSaleNum,Title,Memo,OP_DATE,FileName,SaleType,Consume,ProductPrice,SigningPrice,minPurchase,ProductCode";
            if (entity.SaleType.Equals("3"))// || entity.SaleType.Equals("1")
            {
                strSQL += ",AdvertStartDate,AdvertEndDate";
            }
            if (entity.HouseID != 0)
            {
                strSQL += ",HouseID";

            }
            strSQL += ") VALUES (@ProductName,@TypeID,@ProductID,@OnSaleNum,@Title,@Memo,@OP_DATE,@FileName,@SaleType,@Consume,@ProductPrice,@SigningPrice,@minPurchase,@ProductCode";
            if (entity.SaleType.Equals("3"))// || entity.SaleType.Equals("1")
            {
                strSQL += ",@AdvertStartDate,@AdvertEndDate";
            }
            if (entity.HouseID != 0)
            {
                strSQL += ",@HouseID";

            }
            strSQL += ")SELECT @@IDENTITY";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.AddInParameter(cmd, "@ProductName", DbType.String, entity.ProductName);
                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);

                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.AddInParameter(cmd, "@Title", DbType.String, entity.Title);
                    conn.AddInParameter(cmd, "@Memo", DbType.String, entity.Memo);
                    conn.AddInParameter(cmd, "@OnSaleNum", DbType.Int32, entity.OnSaleNum);
                    conn.AddInParameter(cmd, "@Consume", DbType.Int32, entity.Consume);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@SaleType", DbType.String, entity.SaleType);
                    conn.AddInParameter(cmd, "@FileName", DbType.String, entity.FileName);
                    conn.AddInParameter(cmd, "@ProductPrice", DbType.Decimal, entity.ProductPrice);
                    conn.AddInParameter(cmd, "@SigningPrice", DbType.Decimal, entity.SigningPrice);
                    conn.AddInParameter(cmd, "@minPurchase", DbType.Decimal, entity.minPurchase);
                    if (entity.SaleType.Equals("3"))// || entity.SaleType.Equals("1")
                    {
                        conn.AddInParameter(cmd, "@AdvertStartDate", DbType.DateTime, entity.AdvertStartDate);
                        conn.AddInParameter(cmd, "@AdvertEndDate", DbType.DateTime, entity.AdvertEndDate);
                    }
                    if (entity.HouseID != 0)
                    {
                        conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    }
                    did = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
                if (entity.productFile.Count > 0)
                {
                    AddCargoProductFile(entity.productFile, did);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        /// <summary>
        /// 批量新增在库产品
        /// </summary>
        /// <param name="list"></param>
        public void BulkAddCargoProductShelves(List<CargoProductShelvesEntity> list)
        {
            List<CargoAddProductShelvesEntity> data = new List<CargoAddProductShelvesEntity>();
            foreach (CargoProductShelvesEntity item in list)
            {
                CargoAddProductShelvesEntity entity = new CargoAddProductShelvesEntity();
                entity.ProductID = Convert.ToInt32(item.ProductID);
                entity.TypeID = Convert.ToInt32(item.TypeID);
                entity.ProductName = Convert.ToString(item.ProductName);
                entity.OnSaleNum = Convert.ToInt32(item.OnSaleNum);
                entity.ProductPrice = Convert.ToDecimal(item.ProductPrice);
                entity.Title = Convert.ToString(item.Title);
                entity.Memo = Convert.ToString(item.Memo);
                entity.OP_DATE = DateTime.Now;
                entity.FileName = Convert.ToString(item.FileName);
                entity.SaleType = Convert.ToInt32(item.SaleType);
                entity.ShelveStatus = Convert.ToInt32(item.ShelveStatus);
                entity.ProductCode = Convert.ToString(item.ProductCode);
                entity.AdvertStartDate = DateTime.Now;
                entity.AdvertEndDate = DateTime.Now.AddMonths(3);
                data.Add(entity);
            }
            //批量新增
            conn.BulkInsertData(data, "Tbl_Cargo_Shelves");
        }
        /// <summary>
        /// 批量修改在库产品
        /// </summary>
        /// <param name="entityList"></param>
        public void BatchUpdateCargoProductShelves(List<CargoProductShelvesEntity> entityList)
        {
            if (entityList == null || entityList.Count == 0) return;

            //分页批量执行，防止执行语句太大
            const int batchSize = 10000;
            int totalBatches = (int)Math.Ceiling(entityList.Count / (double)batchSize);
            for (int i = 0; i < totalBatches; i++)
            {
                var batch = entityList.Skip(i * batchSize).Take(batchSize);
                StringBuilder sqlBuilder = new StringBuilder();

                foreach (var entity in batch)
                {
                    sqlBuilder.AppendLine(
                        $"UPDATE Tbl_Cargo_Shelves SET ProductPrice={entity.ProductPrice},OnSaleNum={entity.OnSaleNum} ,ShelveStatus={entity.ShelveStatus},Title='{entity.Title}' ,SaleType={entity.SaleType},AdvertStartDate='{DateTime.Now}',AdvertEndDate='{DateTime.Now.AddMonths(3)}' WHERE ID={entity.ID};");
                }

                using (DbCommand cmd = conn.GetSqlStringCommond(sqlBuilder.ToString()))
                {
                    conn.ExecuteNonQuery(cmd);
                }
            }
        }
        /// <summary>
        /// 批量修改在库产品
        /// </summary>
        /// <param name="entityList"></param>
        public void BatchUpdateProductReserveShelves(List<CargoProductShelvesEntity> entityList)
        {
            if (entityList == null || entityList.Count == 0) return;

            //分页批量执行，防止执行语句太大
            const int batchSize = 10000;
            int totalBatches = (int)Math.Ceiling(entityList.Count / (double)batchSize);
            for (int i = 0; i < totalBatches; i++)
            {
                var batch = entityList.Skip(i * batchSize).Take(batchSize);
                StringBuilder sqlBuilder = new StringBuilder();

                foreach (var entity in batch)
                {
                    var str = "";
                    if (entity.ProductPrice>0)
                    {
                        str += $@" ProductPrice={entity.ProductPrice},";
                    }
                    if (entity.SigningPrice > 0)
                    {
                        str += $@" SigningPrice={entity.SigningPrice},";
                    }
                    if (entity.minPurchase > 0)
                    {
                        str += $@" minPurchase={entity.minPurchase},";
                    }
                    str = str.TrimEnd(',');
                    sqlBuilder.AppendLine(
                        $"UPDATE Tbl_Cargo_Shelves SET {str}  WHERE ID={entity.ID};");
                }

                using (DbCommand cmd = conn.GetSqlStringCommond(sqlBuilder.ToString()))
                {
                    conn.ExecuteNonQuery(cmd);
                }
            }
        }
        /// <summary>
        /// 修改商品上架信息
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoProductShelves(CargoProductShelvesEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"Update Tbl_Cargo_Shelves Set OnSaleNum=@OnSaleNum,Title=@Title,Memo=@Memo,OP_DATE=@OP_DATE,SaleType=@SaleType,Consume=@Consume,ShelveStatus=@ShelveStatus,ProductPrice=@ProductPrice,SigningPrice=@SigningPrice,minPurchase=@minPurchase";
            if (entity.SaleType.Equals("3"))
            {
                strSQL += ",AdvertStartDate=@AdvertStartDate,AdvertEndDate=@AdvertEndDate";
            }
            if (entity.HouseID != 0)
            {
                strSQL += ",HouseID=@HouseID";
            }
            strSQL += " Where ID=@ID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                    conn.AddInParameter(cmd, "@Title", DbType.String, entity.Title);
                    conn.AddInParameter(cmd, "@Memo", DbType.String, entity.Memo);
                    conn.AddInParameter(cmd, "@OnSaleNum", DbType.Int32, entity.OnSaleNum);
                    conn.AddInParameter(cmd, "@Consume", DbType.Int32, entity.Consume);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@SaleType", DbType.String, entity.SaleType);
                    conn.AddInParameter(cmd, "@ShelveStatus", DbType.String, entity.ShelveStatus);
                    conn.AddInParameter(cmd, "@ProductPrice", DbType.Decimal, entity.ProductPrice);
                    conn.AddInParameter(cmd, "@SigningPrice", DbType.Decimal, entity.SigningPrice);
                    conn.AddInParameter(cmd, "@minPurchase", DbType.Decimal, entity.minPurchase);
                    if (entity.SaleType.Equals("3"))
                    {
                        conn.AddInParameter(cmd, "@AdvertStartDate", DbType.DateTime, entity.AdvertStartDate);
                        conn.AddInParameter(cmd, "@AdvertEndDate", DbType.DateTime, entity.AdvertEndDate);
                    }
                    if (entity.HouseID != 0)
                    {
                        conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    }
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 保存上架的商品照片
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoProductFile(List<CargoProductFileEntity> entity, Int64 sid)
        {
            foreach (CargoProductFileEntity it in entity)
            {
                it.EnSafe();
                string strSQL = @"INSERT INTO Tbl_Cargo_ProductFile(FileName,FilePath,ProductID,ShelvesID,FileType,OP_DATE) VALUES (@FileName,@FilePath,@ProductID,@ShelvesID,@FileType,@OP_DATE)";
                try
                {
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@FileName", DbType.String, it.FileName);
                        conn.AddInParameter(cmd, "@FilePath", DbType.String, it.FilePath);
                        conn.AddInParameter(cmd, "@ProductID", DbType.Int64, it.ProductID);
                        conn.AddInParameter(cmd, "@ShelvesID", DbType.Int64, sid);
                        conn.AddInParameter(cmd, "@FileType", DbType.String, it.FileType);
                        conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
                catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            }
        }
        /// <summary>
        /// 商品下架
        /// </summary>
        /// <param name="entity"></param>
        public void Unshelves(List<CargoProductShelvesEntity> entity)
        {
            int index = 0, index2 = 0;
            StringBuilder strSQL = new StringBuilder();
            foreach (CargoProductShelvesEntity it in entity)
            {
                //string strSQL = @"DELETE FROM Tbl_Cargo_Shelves Where ID=@ID";
                strSQL.AppendLine($@";Update Tbl_Cargo_Shelves set ShelveStatus='1',OnSaleNum=0,SaleType=iif(SaleType=5,5,0),OP_DATE='{DateTime.Now}' Where ID={it.ID}");

                index++;
                index2++;

                if (index >= 200)
                {
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL.ToString()))
                    {
                        conn.ExecuteNonQuery(cmd);
                    }
                    strSQL.Clear();
                    index = 0;
                }
                if (index2 >= entity.Count)
                {
                    if (strSQL.Length > 0)
                    {
                        using (DbCommand cmd = conn.GetSqlStringCommond(strSQL.ToString()))
                        {
                            conn.ExecuteNonQuery(cmd);
                        }
                        strSQL.Clear();
                        index = 0;
                    }
                }

            }
        }
        private void DeleteShelvesFile(long shelvesID)
        {
            string strSQL = @"DELETE FROM Tbl_Cargo_ProductFile Where ShelvesID=@ShelvesID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ShelvesID", DbType.Int64, shelvesID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改入库 单 状态
        /// </summary>
        /// <param name="entity"></param>
        public void updateInCargoPrintStatus(List<CargoContainerShowEntity> entity)
        {
            foreach (var it in entity)
            {
                string strSQL = @"Update Tbl_Cargo_InContainerGoods set IsPrintInCargo='1' where ID=@ID ";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ID", DbType.Int64, it.ID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
        }
        /// <summary>
        /// 查询特价胎数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QuerySpecialSaleData(CargoContainerShowEntity entity)
        {
            CargoPriceManager price = new CargoPriceManager();
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            string strSQL = "select a.ID,a.ProductID,a.TypeID,a.Title,a.Memo,a.FileName,a.SaleType,a.OnSaleNum,a.ShelveStatus,a.ProductPrice,b.Piece,b.ContainerID,c.Specs,c.Figure,c.GoodsCode,c.Model,c.LoadIndex,c.SpeedLevel,c.SalePrice,c.TradePrice,c.Batch,c.BatchYear,c.BatchWeek,c.HouseID From Tbl_Cargo_Shelves as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID inner join Tbl_Cargo_Product as c on a.ProductID=c.ProductID  where (1=1) ";
            if (!string.IsNullOrEmpty(entity.OnShelves)) { strSQL += " and a.ShelveStatus='" + entity.OnShelves + "'"; }
            if (!string.IsNullOrEmpty(entity.SaleType)) { strSQL += " and a.SaleType='" + entity.SaleType + "'"; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and c.HouseID=" + entity.HouseID + ""; }
            //以产品名称为查询条件
            if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and c.Specs like '%" + entity.Specs + "%'"; }
            if (!string.IsNullOrEmpty(entity.TypeName)) { strSQL += " and c.TypeID in (" + entity.TypeName + ")"; }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        if (Convert.ToString(idr["SaleType"]).Equals("3"))
                        {
                            if (Convert.ToInt32(idr["OnSaleNum"]) <= 0 || Convert.ToInt32(idr["Piece"]) <= 0) { continue; }
                            if (result.Exists(c => c.ProductID.Equals(Convert.ToInt64(idr["ProductID"]))))
                            {
                                continue;
                            }
                        }
                        else
                        {
                            if (Convert.ToInt32(idr["Piece"]) <= 0) { continue; }
                        }
                        if (result.Exists(c => c.ProductID.Equals(Convert.ToInt64(idr["ProductID"]))))
                        {
                            CargoContainerShowEntity ese = result.Find(c => c.ProductID.Equals(Convert.ToInt64(idr["ProductID"])));
                            ese.Piece += Convert.ToInt32(idr["Piece"]);
                        }
                        else
                        {
                            decimal sj = Convert.ToDecimal(idr["SalePrice"]);
                            if (Convert.ToString(idr["ShelveStatus"]).Equals("0"))
                            {
                                if (Convert.ToString(idr["SaleType"]).Equals("1") || Convert.ToString(idr["SaleType"]).Equals("3"))
                                {
                                    sj = Convert.ToDecimal(idr["ProductPrice"]);
                                }
                            }
                            string batch = Convert.ToString(idr["BatchYear"]) + Convert.ToString(idr["BatchWeek"]);
                            List<CargoRuleBankEntity> rule = price.QueryRuleBank(new CargoRuleBankEntity { HouseID = Convert.ToInt32(idr["HouseID"]), TypeID = Convert.ToInt32(idr["TypeID"]), Specs = Convert.ToString(idr["Specs"]), Figure = Convert.ToString(idr["Figure"]), DelFlag = "0", StartBatch = Convert.ToInt32(batch) });
                            CargoRuleBankEntity rb = new CargoRuleBankEntity();
                            if (rule.Count > 0)
                            {
                                rb = rule.Find(c => c.RuleType.Equals("6"));
                            }
                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),//上架表ID
                                OnSaleID = Convert.ToInt64(idr["ID"]),//上架表ID
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                Title = Convert.ToString(idr["Title"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                FileName = Convert.ToString(idr["FileName"]),
                                SaleType = Convert.ToString(idr["SaleType"]),
                                ShelvesNum = Convert.ToInt32(idr["OnSaleNum"]),
                                Piece = Convert.ToString(idr["SaleType"]).Equals("3") || Convert.ToString(idr["SaleType"]).Equals("1") ? Convert.ToInt32(idr["OnSaleNum"]) : Convert.ToInt32(idr["Piece"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                Specs = Convert.ToString(idr["Specs"]).Trim(),
                                Figure = Convert.ToString(idr["Figure"]).Trim(),
                                Model = Convert.ToString(idr["Model"]).Trim(),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]).Trim(),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                BatchYear = Convert.ToInt32(idr["BatchYear"]),
                                BatchWeek = Convert.ToInt32(idr["BatchWeek"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                CutEntry = rb.CutEntry,
                                IsCut = rb.ID.Equals(0) ? false : true,
                                RuleID = Convert.ToString(rb.ID),
                                SalePrice = sj,
                                TradePrice = Convert.ToDecimal(idr["TradePrice"])
                            });
                        }
                    }
                }
            }
            return result;
        }
        #endregion
        #region 产品分类操作方法集合

        /// <summary>
        /// 产品分类查询
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <param name="strCountWhere">查询总数的查询条件</param>
        /// <returns></returns>
        public Hashtable QueryProductTypeEx(int pIndex, int pNum, CargoProductTypeEntity entity)
        {
            List<CargoProductTypeEntity> result = new List<CargoProductTypeEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY b.OP_DATE DESC) AS RowNumber, b.* FROM Tbl_Cargo_ProductType AS b WHERE (1=1)";
                //以中文名称为查询条件
                if (!string.IsNullOrEmpty(entity.TypeName)) { strSQL += " and b.TypeName like '%" + entity.TypeName + "%'"; }
                if (!string.IsNullOrEmpty(entity.BrandCode)) { strSQL += " and b.BrandCode = '" + entity.BrandCode + "'"; }
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strSQL += " and b.DelFlag = '" + entity.DelFlag + "'"; }

                //以父ID为查询条件
                if (!entity.ParentID.Equals(0)) { strSQL += " and b.ParentID=" + entity.ParentID; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoProductTypeEntity
                            {
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                ParentName = Convert.ToString(idr["TypeParentName"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                BrandCode = Convert.ToString(idr["BrandCode"]),
                                ParentID = Convert.ToInt32(idr["ParentID"]),
                                DelFlag = Convert.ToString(idr["DelFlag"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }

                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_ProductType Where (1=1)";
                //以中文名称为查询条件
                if (!string.IsNullOrEmpty(entity.TypeName)) { strCount += " and TypeName like '%" + entity.TypeName + "%'"; }
                if (!string.IsNullOrEmpty(entity.BrandCode)) { strCount += " and BrandCode = '" + entity.BrandCode + "'"; }
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strCount += " and DelFlag = '" + entity.DelFlag + "'"; }

                //以父ID为查询条件
                if (!entity.ParentID.Equals(0)) { strCount += " and ParentID=" + entity.ParentID; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 查询产品分类 可以查所有分类，可以按父ID查，可以按分类ID查
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoProductTypeEntity> QueryProductType(CargoProductTypeEntity entity)
        {
            List<CargoProductTypeEntity> result = new List<CargoProductTypeEntity>();
            string strSQL = @"SELECT TypeID,TypeName,ParentID,TypeParentName,BrandCode FROM Tbl_Cargo_ProductType WHERE DelFlag=0 ";
            if (!entity.TypeID.Equals(0)) { strSQL += " and TypeID=@TypeID"; }
            if (!entity.ParentID.Equals(-1)) { strSQL += " and ParentID=@ParentID "; }
            if (!string.IsNullOrEmpty(entity.TypeName)) { strSQL += " and TypeName like '%" + entity.TypeName + "%'"; }
            strSQL += " Order by OP_DATE asc";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!entity.TypeID.Equals(0)) { conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID); }
                    if (!entity.ParentID.Equals(-1)) { conn.AddInParameter(cmd, "@ParentID", DbType.Int32, entity.ParentID); }
                    //if (!string.IsNullOrEmpty(entity.TypeName)) { conn.AddInParameter(cmd, "@TypeName", DbType.String, entity.TypeName); }
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoProductTypeEntity
                            {
                                TypeID = Convert.ToInt32(idrCount["TypeID"]),
                                TypeName = Convert.ToString(idrCount["TypeName"]).Trim(),
                                ParentID = Convert.ToInt32(idrCount["ParentID"]),
                                ParentName = Convert.ToString(idrCount["TypeParentName"]),
                                BrandCode = Convert.ToString(idrCount["BrandCode"]),
                                PinyinName = GetSpellCode(Convert.ToString(idrCount["TypeName"])).ToLower()

                            });
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }


        public List<CargoProductTypeEntity> QueryProductTypeByIDs(int[] typeIDs)
        {
            List<CargoProductTypeEntity> result = new List<CargoProductTypeEntity>();
            try
            {
                string createIDsTempTblSQL = @"
IF OBJECT_ID('tempdb..##IDs') IS NOT NULL DROP TABLE ##IDs;
CREATE TABLE 
	##IDs(
		ID INT
	)
;
";
                string strSQL = @"SELECT * FROM Tbl_Cargo_ProductType  pt
INNER JOIN ##IDs IDS ON pt.TypeID = IDS.ID";
                List<SqlParameter> sqlParameters = new List<SqlParameter>();
                int batchSize = 1000;
                if (!typeIDs.Any()) { return result; }

                var groupedPrdctIDs = typeIDs.Select((row, index) => new { row, index })
                        .GroupBy(x => x.index / batchSize)
                        .Select(g => g.Select(x => x.row).ToList());
                using (DbCommand cmd = conn.GetSqlStringCommond(createIDsTempTblSQL))
                {
                    cmd.Connection.Open();
                    cmd.ExecuteNonQuery();
                    foreach (var groupData in groupedPrdctIDs)
                    {
                        string insertIDsTempSql = @"
INSERT INTO ##IDs (ID)
Values @{tempTblVals}
;
";
                        List<string> tempTblVals = new List<string>();
                        foreach (var id in groupData)
                        {
                            tempTblVals.Add($"({id})");
                        }
                        insertIDsTempSql = insertIDsTempSql.Replace("@{tempTblVals}", string.Join("," + Environment.NewLine, tempTblVals));
                        cmd.CommandText = insertIDsTempSql;
                        cmd.ExecuteNonQuery();
                    }


                    cmd.CommandText = strSQL;

                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoProductTypeEntity
                            {
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]).Trim(),
                                ParentID = Convert.ToInt32(idr["ParentID"]),
                                ParentName = Convert.ToString(idr["TypeParentName"]),
                                BrandCode = Convert.ToString(idr["BrandCode"]),
                                PinyinName = GetSpellCode(Convert.ToString(idr["TypeName"])).ToLower()

                            });
                        }
                    }
                }
            }
            catch (ApplicationException) { throw; }
            return result;
        }
        /// <summary>
        /// 根据产品分类ID返回产品分类名称
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public string QueryProductTypeName(CargoProductTypeEntity entity)
        {
            string result = string.Empty;
            try
            {
                string strSQL = @"SELECT TypeName FROM Tbl_Cargo_ProductType WHERE TypeID=@TypeID";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@TypeID", DbType.Int32, entity.TypeID);
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        if (dd.Rows.Count > 0) { result = Convert.ToString(dd.Rows[0]["TypeName"]); }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 是否存在相同的分类名称 
        /// </summary>
        /// <param name="entity"></param>
        /// <returns>True:表示已经存在，False：表示不存在</returns>
        public bool IsExistCargoProductType(CargoProductTypeEntity entity)
        {
            string strQ = @"Select TypeName from Tbl_Cargo_ProductType Where TypeName=@TypeName and ParentID=@ParentID";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@TypeName", DbType.String, entity.TypeName);
                conn.AddInParameter(cmdQ, "@ParentID", DbType.Int32, entity.ParentID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 根据产品类型ID查询 该产品分类下还有没有产品数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistCargoProductByProductType(CargoProductTypeEntity entity)
        {
            string strQ = @"Select TypeID from Tbl_Cargo_Product Where TypeID=@TypeID";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@TypeID", DbType.Int32, entity.TypeID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 新增分类
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoProductType(CargoProductTypeEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_ProductType(TypeName,ParentID,TypeParentName,BrandCode,DelFlag) VALUES (@TypeName,@ParentID,@TypeParentName,@BrandCode,@DelFlag)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@TypeName", DbType.String, entity.TypeName);
                    conn.AddInParameter(cmd, "@ParentID", DbType.Int32, entity.ParentID);
                    conn.AddInParameter(cmd, "@TypeParentName", DbType.String, entity.ParentName);
                    conn.AddInParameter(cmd, "@BrandCode", DbType.String, entity.BrandCode);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        /// <summary>
        /// 修改产品分类数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoProductType(CargoProductTypeEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_ProductType SET TypeName=@TypeName,ParentID=@ParentID,TypeParentName=@TypeParentName,BrandCode=@BrandCode,DelFlag=@DelFlag WHERE TypeID=@TypeID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@TypeName", DbType.String, entity.TypeName);
                    conn.AddInParameter(cmd, "@ParentID", DbType.Int32, entity.ParentID);
                    conn.AddInParameter(cmd, "@TypeParentName", DbType.String, entity.ParentName);
                    conn.AddInParameter(cmd, "@BrandCode", DbType.String, entity.BrandCode);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除产品分类
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoProductType(List<CargoProductTypeEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"UPDATE Tbl_Cargo_ProductType SET DelFlag='1' WHERE TypeID=@TypeID";
                    if (it.DelFlag.Equals("1"))//彻底删除
                    {
                        strSQL = @"Delete from Tbl_Cargo_ProductType where TypeID=@TypeID ";
                    }
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@TypeID", DbType.Int32, it.TypeID);
                        conn.ExecuteNonQuery(cmd);
                    }


                    //string strSQL = @"Delete from Tbl_Cargo_ProductType where TypeID=@TypeID ";

                    //using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    //{
                    //    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, it.TypeID);
                    //    conn.ExecuteNonQuery(cmd);
                    //}
                    ////删除该分类下的子类
                    //string delSQL = @"Delete from Tbl_Cargo_ProductType where ParentID=@ParentID";
                    //using (DbCommand delcmd = conn.GetSqlStringCommond(delSQL))
                    //{
                    //    conn.AddInParameter(delcmd, "@ParentID", DbType.Int32, it.TypeID);
                    //    conn.ExecuteNonQuery(delcmd);
                    //}
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion
        #region 车辆品牌适配轮胎规格
        /// <summary>
        /// 查询适配轮胎规格
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoProductCarTyreEntity> QueryCarTyreMatch(CargoProductCarTyreEntity entity)
        {
            List<CargoProductCarTyreEntity> result = new List<CargoProductCarTyreEntity>();
            string strSQL = "select * From Tbl_Cargo_CarTyreMatch where Car like '%" + entity.Car + "%'";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoProductCarTyreEntity
                            {
                                ID = Convert.ToInt32(idrCount["ID"]),
                                Car = Convert.ToString(idrCount["Car"]).Trim(),
                                CarBrade = Convert.ToString(idrCount["CarBrade"]).Trim(),
                                Brade = Convert.ToString(idrCount["Brade"]).Trim(),
                                Spec = Convert.ToString(idrCount["Spec"]).Trim(),
                                OP_DATE = Convert.ToDateTime(idrCount["OP_DATE"])
                            });
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        #endregion
        #region 产品标签操作方法集合
        /// <summary>
        /// 判断产品编码是否存在 True:存在 False:不存在
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistCargoProductTag(CargoProductTagEntity entity)
        {
            string strQ = @"Select TagCode from Tbl_Cargo_ProductTag Where TagCode=@TagCode";
            if (!string.IsNullOrEmpty(entity.OutCargoStatus))
            {
                strQ += " and OutCargoStatus='" + entity.OutCargoStatus + "'";
            }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@TagCode", DbType.String, entity.TagCode);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 新增产品标签数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoProductTag(CargoProductTagEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"INSERT INTO Tbl_Cargo_ProductTag(ProductID,TagCode,InCargoStatus,InCargoType,InCargoOperID,InCargoTime,TyreCode,ContainerID) VALUES (@ProductID,@TagCode,@InCargoStatus,@InCargoType,@InCargoOperID,@InCargoTime,@TyreCode,@ContainerID)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.AddInParameter(cmd, "@TagCode", DbType.String, entity.TagCode.Trim());
                    conn.AddInParameter(cmd, "@InCargoStatus", DbType.String, entity.InCargoStatus);
                    conn.AddInParameter(cmd, "@InCargoType", DbType.String, entity.InCargoType);
                    conn.AddInParameter(cmd, "@InCargoOperID", DbType.String, entity.InCargoOperID);
                    conn.AddInParameter(cmd, "@InCargoTime", DbType.DateTime, entity.InCargoTime);
                    conn.AddInParameter(cmd, "@TyreCode", DbType.String, entity.TyreCode);
                    conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, entity.ContainerID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 通过产品ID查询产品标签数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoProductTagEntity> QueryTagByProductID(CargoProductTagEntity entity)
        {
            List<CargoProductTagEntity> result = new List<CargoProductTagEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @"select a.ProductName,a.Specs,a.Figure,a.Batch,a.Model,a.GoodsCode,a.LoadIndex,a.SpeedLevel,a.ProductCode,a.PackageNum,a.Supplier,b.*,c.ContainerCode From Tbl_Cargo_Product as a inner join Tbl_Cargo_ProductTag as b on a.ProductID=b.ProductID inner join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID WHERE (1=1)";
                if (!entity.ProductID.Equals(0)) { strSQL += " and a.ProductID=" + entity.ProductID; }
                if (!entity.ContainerID.Equals(0)) { strSQL += " and b.ContainerID=" + entity.ContainerID; }
                if (!string.IsNullOrEmpty(entity.TagCode)) { strSQL += " and b.TagCode like '%" + entity.TagCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " and b.TyreCode like '%" + entity.TyreCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.MoveOrderNo)) { strSQL += " and b.MoveOrderNo='" + entity.MoveOrderNo + "'"; }
                strSQL += " order by OutCargoStatus asc,OutCargoTime asc";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(command, "@ProductID", DbType.Int64, entity.ProductID);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.Add(new CargoProductTagEntity
                            {
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Model = Convert.ToString(idr["Model"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                TagCode = Convert.ToString(idr["TagCode"]),
                                BundleNum = string.IsNullOrEmpty(Convert.ToString(idr["PackageNum"])) ? 1 : Convert.ToInt32(idr["PackageNum"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                InCargoTime = Convert.ToDateTime(idr["InCargoTime"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]),
                                InCargoOperID = Convert.ToString(idr["InCargoOperID"]),
                                InCargoType = Convert.ToString(idr["InCargoType"]),
                                OutCargoStatus = Convert.ToString(idr["OutCargoStatus"]),
                                OutCargoOperID = Convert.ToString(idr["OutCargoOperID"]),
                                OutCargoTime = string.IsNullOrEmpty(Convert.ToString(idr["OutCargoTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["OutCargoTime"]),
                                TyreCode = Convert.ToString(idr["TyreCode"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                MoveOrderNo = Convert.ToString(idr["MoveOrderNo"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                MoveStatus = Convert.ToString(idr["MoveStatus"]),
                                Supplier = Convert.ToString(idr["Supplier"]),
                            });
                            #endregion
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public List<CargoProductTagEntity> QueryProductTagList(CargoProductTagEntity entity)
        {
            List<CargoProductTagEntity> result = new List<CargoProductTagEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @"select * From Tbl_Cargo_ProductTag WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.OrderNo)) { strSQL += " and OrderNo='" + entity.OrderNo + "'"; }
                if (!string.IsNullOrEmpty(entity.MoveOrderNo)) { strSQL += " and MoveOrderNo='" + entity.MoveOrderNo + "'"; }
                if (string.IsNullOrEmpty(entity.OrderNo) && string.IsNullOrEmpty(entity.MoveOrderNo))
                {
                    return result;
                }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.Add(new CargoProductTagEntity
                            {
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                TagCode = Convert.ToString(idr["TagCode"]),
                                InCargoTime = string.IsNullOrEmpty(Convert.ToString(idr["InCargoTime"])) ? DateTime.MinValue : Convert.ToDateTime(idr["InCargoTime"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]),
                                InCargoOperID = Convert.ToString(idr["InCargoOperID"]),
                                InCargoType = Convert.ToString(idr["InCargoType"]),
                                OutCargoStatus = Convert.ToString(idr["OutCargoStatus"]),
                                OutCargoOperID = Convert.ToString(idr["OutCargoOperID"]),
                                OutCargoTime = string.IsNullOrEmpty(Convert.ToString(idr["OutCargoTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["OutCargoTime"]),
                                TyreCode = Convert.ToString(idr["TyreCode"]),
                                ContainerID = string.IsNullOrEmpty(Convert.ToString(idr["ContainerID"])) ? 0 : Convert.ToInt32(idr["ContainerID"]),
                                MoveOrderNo = Convert.ToString(idr["MoveOrderNo"]),
                                OrderNo = Convert.ToString(idr["OrderNo"])
                            });
                            #endregion
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 通过标签代码查询标签信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoProductTagEntity QueryTagByTagCode(CargoProductTagEntity entity)
        {
            CargoProductTagEntity result = new CargoProductTagEntity();
            string strSQL = "Select a.*,b.ContainerCode From Tbl_Cargo_ProductTag  as a inner join Tbl_Cargo_Container as b on a.ContainerID=b.ContainerID Where a.TagCode=@TagCode";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@TagCode", DbType.String, entity.TagCode);
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.TagCode = Convert.ToString(idr["TagCode"]);
                        result.ProductID = Convert.ToInt64(idr["ProductID"]);
                        result.InCargoTime = Convert.ToDateTime(idr["InCargoTime"]);
                        result.InCargoStatus = Convert.ToString(idr["InCargoStatus"]);
                        result.InCargoOperID = Convert.ToString(idr["InCargoOperID"]);
                        result.InCargoType = Convert.ToString(idr["InCargoType"]);
                        result.OutCargoStatus = Convert.ToString(idr["OutCargoStatus"]);
                        result.OutCargoOperID = Convert.ToString(idr["OutCargoOperID"]);
                        result.OutCargoTime = string.IsNullOrEmpty(Convert.ToString(idr["OutCargoTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["OutCargoTime"]);
                        result.TyreCode = Convert.ToString(idr["TyreCode"]);
                        result.ContainerID = Convert.ToInt32(idr["ContainerID"]);
                        result.OrderNo = Convert.ToString(idr["OrderNo"]);
                        result.ContainerCode = Convert.ToString(idr["ContainerCode"]);
                        result.MoveOrderNo = Convert.ToString(idr["MoveOrderNo"]);
                        result.MoveStatus = Convert.ToString(idr["MoveStatus"]);
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询产品标签数据 
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoProductEntity QueryProductInfoByTagCode(CargoProductTagEntity entity)
        {
            CargoProductEntity result = new CargoProductEntity();
            try
            {
                entity.EnSafe();
                string strSQL = @"select a.ProductID,a.OrderNo,a.OutCargoStatus,a.ContainerID,a.MoveStatus,b.TypeID,b.GoodsCode,c.ContainerCode,b.ProductCode,b.PackageNum,b.Batch From Tbl_Cargo_ProductTag as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_Container as c on a.ContainerID=c.ContainerID where a.TagCode=@TagCode";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@TagCode", DbType.String, entity.TagCode);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.ProductID = Convert.ToInt64(idr["ProductID"]);
                            result.ContainerID = Convert.ToInt32(idr["ContainerID"]);
                            result.TypeID = Convert.ToInt32(idr["TypeID"]);
                            result.GoodsCode = Convert.ToString(idr["GoodsCode"]);
                            result.ContainerCode = Convert.ToString(idr["ContainerCode"]);
                            result.MoveStatus = Convert.ToString(idr["MoveStatus"]);
                            result.ProductCode = Convert.ToString(idr["ProductCode"]);
                            result.PackageNum = Convert.ToInt32(idr["PackageNum"]);
                            result.Batch = Convert.ToString(idr["Batch"]);
                            result.OrderNo = Convert.ToString(idr["OrderNo"]);
                            result.OutCargoStatus = Convert.ToString(idr["OutCargoStatus"]);
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 删除标签条码
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoProductTag(CargoProductTagEntity entity)
        {
            string strSQL = @"Delete from Tbl_Cargo_ProductTag where ProductID=@ProductID ";
            if (!string.IsNullOrEmpty(entity.TagCode))
            {
                strSQL += " and TagCode='" + entity.TagCode + "'";
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 设置标签为未出库
        /// </summary>
        /// <param name="entity"></param>
        public void SetTagUnOutCargo(List<CargoProductTagEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Update Tbl_Cargo_ProductTag set OutCargoStatus=@OutCargoStatus,OutCargoOperID='',OrderNo='',OutCargoTime='' where TagCode=@TagCode";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@TagCode", DbType.String, it.TagCode);
                        conn.AddInParameter(cmd, "@OutCargoStatus", DbType.String, it.OutCargoStatus);
                        //conn.AddInParameter(cmd, "@ProductID", DbType.Int64, it.ProductID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 通过订单号修改标签的出库状态 为未出库
        /// </summary>
        /// <param name="entity"></param>
        public void SetTagUnOutCargoByOrderNo(CargoProductTagEntity entity)
        {
            string strSQL = @"Update Tbl_Cargo_ProductTag set OutCargoStatus=@OutCargoStatus,OutCargoOperID='',OrderNo='',OutCargoTime='' where OrderNo=@OrderNo";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@OrderNo", DbType.String, entity.OrderNo);
                conn.AddInParameter(cmd, "@OutCargoStatus", DbType.String, entity.OutCargoStatus);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 删除 好来运系统标签数据
        /// </summary>
        /// <param name="entity"></param>
        public void DelHlyProductTagData(List<CargoProductTagEntity> entity)
        {
            //好来运数据库的数据连接
            SqlHelper hlySql = new SqlHelper("HLYSql");
            foreach (var it in entity)
            {
                string strSQL = "Delete From Tbl_ProductStockList Where barcode=@TagCode";
                using (DbCommand cmd = hlySql.GetSqlStringCommond(strSQL))
                {
                    hlySql.AddInParameter(cmd, "@TagCode", DbType.String, it.TagCode);
                    hlySql.ExecuteNonQuery(cmd);
                }
            }
        }
        /// <summary>
        /// 修改标签的称库目标数据
        /// </summary>
        /// <param name="entity"></param>
        public void SetTagMoveOrderByTagCode(CargoProductTagEntity entity)
        {
            string strSQL = @"Update Tbl_Cargo_ProductTag set ProductID=@ProductID,InCargoType=@InCargoType,InCargoOperID=@InCargoOperID,InCargoTime=@InCargoTime,ContainerID=@ContainerID,MoveStatus=@MoveStatus where MoveOrderNo=@MoveOrderNo and TagCode=@TagCode";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@TagCode", DbType.String, entity.TagCode);
                conn.AddInParameter(cmd, "@MoveOrderNo", DbType.String, entity.MoveOrderNo);
                conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, entity.ContainerID);
                conn.AddInParameter(cmd, "@InCargoTime", DbType.DateTime, entity.InCargoTime);
                conn.AddInParameter(cmd, "@InCargoOperID", DbType.String, entity.InCargoOperID);
                conn.AddInParameter(cmd, "@InCargoType", DbType.String, entity.InCargoType);
                conn.AddInParameter(cmd, "@MoveStatus", DbType.String, entity.MoveStatus);
                conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 退回移库状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateTagMoveOrder(CargoProductTagEntity entity)
        {
            string strSQL = @"Update Tbl_Cargo_ProductTag set MoveOrderNo='',MoveStatus='' where MoveOrderNo=@MoveOrderNo";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@MoveOrderNo", DbType.String, entity.MoveOrderNo);
                conn.ExecuteNonQuery(cmd);
            }
        }
        #endregion
        #region 处理上架产品数据
        /// <summary>
        /// 查询所有上架的产品数据
        /// </summary>
        /// <returns></returns>
        public List<CargoProductEntity> QueryShelveProductData()
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            try
            {
                string strSQL = "select a.ID,a.ProductID,a.TypeID,a.ProductName,b.Model,b.GoodsCode,b.Specs,b.Figure,b.TreadWidth,b.LoadIndex,b.SpeedLevel,b.Batch,b.InCargoStatus,b.BatchYear,b.BatchWeek,b.HouseID,b.InHouseTime from Tbl_Cargo_Shelves as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID where a.ShelveStatus=0";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.Add(new CargoProductEntity
                            {
                                ShelvesID = Convert.ToInt64(idr["ID"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                Model = Convert.ToString(idr["Model"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                BatchYear = Convert.ToInt32(idr["BatchYear"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                InHouseTime = string.IsNullOrEmpty(Convert.ToString(idr["InHouseTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["InHouseTime"])
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        ///  查询同一周期的产品
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoProductEntity QueryInCargoProduct(CargoProductEntity entity)
        {
            CargoProductEntity result = new CargoProductEntity();
            string strSQL = "select top 1 a.ProductID,a.ProductName,b.* from Tbl_Cargo_Product as a left join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID where a.TypeID=" + entity.TypeID + " and a.Specs='" + entity.Specs + "' and a.Figure='" + entity.Figure + "' and a.Model='" + entity.Model + "' and a.HouseID=" + entity.HouseID + " and a.BatchYear=" + entity.BatchYear + " and b.Piece>0 order by b.Piece desc";
            try
            {
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.ProductID = Convert.ToInt64(idr["ProductID"]);
                            result.ProductName = Convert.ToString(idr["ProductName"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        ///  查询没有库存的产品ID
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoProductShelvesEntity> QueryInCargoProductSpecial()
        {
            List<CargoProductShelvesEntity> result = new List<CargoProductShelvesEntity>();
            string strSQL = $@"
           select c.GoodsCode,c.Model, b.Piece, a.* from Tbl_Cargo_Shelves as a
            inner join (
                select ProductID,sum(Piece) as Piece from Tbl_Cargo_ContainerGoods
                group by ProductID
            ) as b on a.ProductID=b.ProductID
            inner join Tbl_Cargo_Product as c on a.ProductID=c.ProductID
            where a.ShelveStatus=0 and Piece=0
            ";
            try
            {
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoProductShelvesEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                Title = Convert.ToString(idr["Title"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                FileName = Convert.ToString(idr["FileName"]),
                                SaleType = Convert.ToString(idr["SaleType"]),
                                ShelveStatus = Convert.ToString(idr["ShelveStatus"]),
                                AdvertStartDate = string.IsNullOrEmpty(Convert.ToString(idr["AdvertStartDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["AdvertStartDate"]),
                                AdvertEndDate = string.IsNullOrEmpty(Convert.ToString(idr["AdvertEndDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["AdvertEndDate"]),
                                Consume = Convert.ToInt32(idr["Consume"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                OnSaleNum = Convert.ToInt32(idr["OnSaleNum"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Model = Convert.ToString(idr["Model"]),
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 修改上架产品的ID
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateShelvesProductID(CargoProductEntity entity)
        {
            string strSQL = "Update Tbl_Cargo_Shelves set ProductID=@ProductID where ID=@ID";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@ProductID", DbType.Int64, entity.ProductID);
                conn.AddInParameter(command, "@ID", DbType.Int64, entity.ShelvesID);
                conn.ExecuteNonQuery(command);
            }
        }
        /// <summary>
        /// 自动处理所有已上架的推广商品 自动下架今天 到期 的推广产品
        /// </summary>
        public void AutoUnShelveAdvertProduct()
        {
            string strSQL = "Update Tbl_Cargo_Shelves set ShelveStatus='1',OnSaleNum=0,SaleType='0' Where ID in (select ID from Tbl_Cargo_Shelves where SaleType='3') and AdvertEndDate='" + DateTime.Now.ToString("yyyy-MM-dd") + "'";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.ExecuteNonQuery(command);
            }
        }
        /// <summary>
        /// 处理商城 特价销售商品数量与库存统一
        /// </summary>
        public void HandleWxMallOnSaleNum()
        {
            //处理商城促销产品在售数量
            string strU = "UPDATE Tbl_Cargo_Shelves SET OnSaleNum = c.Piece FROM(SELECT  a.ProductID,SUM(a.Piece) AS Piece FROM   Tbl_Cargo_ContainerGoods AS a INNER JOIN Tbl_Cargo_Shelves AS b ON a.ProductID = b.ProductID   WHERE   b.SaleType = 1      AND b.ShelveStatus = 0  GROUP BY a.ProductID) AS c WHERE Tbl_Cargo_Shelves.ProductID= c.ProductID AND c.Piece<>0  AND Tbl_Cargo_Shelves.OnSaleNum <> c.Piece AND Tbl_Cargo_Shelves.OnSaleNum <> 0 AND Tbl_Cargo_Shelves.OnSaleNum > c.Piece";
            using (DbCommand cmdU = conn.GetSqlStringCommond(strU))
            {
                conn.ExecuteNonQuery(cmdU);
            }
        }
        /// <summary>
        /// 查询今天入库的所有产品
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoProductEntity> QueryCurDayInHouseProduct(CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            string strSQL = "select a.ProductID,a.ProductName,a.TypeID,b.TypeName,a.Model,a.Specs,a.Figure,a.LoadIndex,a.SpeedLevel,a.Batch,a.BatchYear,c.Piece as OnSaleNum,a.HouseID from Tbl_Cargo_Product as a inner join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID inner join Tbl_Cargo_ContainerGoods as c on a.ProductID=c.ProductID where b.ParentID=1 and a.OperaType=1 and c.Piece>0 ";
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID + ""; }
            //制单日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " order by a.OP_DATE desc";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoProductEntity
                        {
                            ProductID = Convert.ToInt64(idr["ProductID"]),
                            ProductName = Convert.ToString(idr["ProductName"]),
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            Model = Convert.ToString(idr["Model"]),
                            Specs = Convert.ToString(idr["Specs"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            Batch = Convert.ToString(idr["Batch"]),
                            BatchYear = Convert.ToInt32(idr["BatchYear"]),
                            OnSaleNum = Convert.ToInt32(idr["OnSaleNum"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 判断该 规格花纹 产品是否已上架
        /// True：已经存在上架的  False:不存在
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistShelveProduct(CargoProductEntity entity)
        {
            string strSQL = "select b.ID From Tbl_Cargo_Product as a inner join Tbl_Cargo_Shelves as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID where c.ParentID=1";
            if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID + ""; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID + ""; }
            if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs='" + entity.Specs + "'"; }
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure='" + entity.Figure + "'"; }
            if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex=" + entity.LoadIndex + ""; }
            if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel='" + entity.SpeedLevel + "'"; }
            if (!entity.BatchYear.Equals(0)) { strSQL += " and a.BatchYear=" + entity.BatchYear + ""; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 根据花纹查询对应的花纹轮胎照片
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoProductShelvesEntity QueryTryePic(CargoProductShelvesEntity entity)
        {
            CargoProductShelvesEntity result = new CargoProductShelvesEntity();
            string strSQL = "select * From Tbl_Cargo_TryePic where Figure =@Figure and TypeID=@TypeID";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@Figure", DbType.String, entity.Figure);
                conn.AddInParameter(command, "@TypeID", DbType.Int32, entity.TypeID);
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Figure = Convert.ToString(idr["Figure"]);
                        result.FileName = Convert.ToString(idr["PicSrc"]);
                    }
                }
            }
            return result;
        }
        #endregion
        #region 获取所有产品来源
        /// <summary>
        /// 获取所有产品来源
        /// </summary>
        /// <returns></returns>
        public List<CargoProductSourceEntity> QueryAllProductSource()
        {
            List<CargoProductSourceEntity> result = new List<CargoProductSourceEntity>();
            string strSQL = "select * from Tbl_Cargo_ProductSource";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoProductSourceEntity
                        {
                            Source = Convert.ToInt32(idr["Source"]),
                            SourceName = Convert.ToString(idr["SourceName"]).Trim(),
                            AssociationType = Convert.ToString(idr["AssociationType"]).Trim()
                        });
                    }
                }
            }
            return result;
        }

        public List<CargoProductSourceEntity> QueryAllProductSource(CargoProductSourceEntity entity)
        {
            List<CargoProductSourceEntity> result = new List<CargoProductSourceEntity>();
            string strSQL = "select * from Tbl_Cargo_ProductSource where (1=1)";
            if (!string.IsNullOrEmpty(entity.SourceType))
            {
                strSQL += " and SourceType='" + entity.SourceType + "'";
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoProductSourceEntity
                        {
                            Source = Convert.ToInt32(idr["Source"]),
                            SourceName = Convert.ToString(idr["SourceName"]),
                            SourceCode = Convert.ToString(idr["SourceCode"])
                        });
                    }
                }
            }
            return result;
        }

        #endregion

        #region 获取所有产品
        /// <summary>
        /// 根据HouseID列表和ProductCode列表精确查询前置仓产品（使用临时表+BulkInsert高效查询）
        /// </summary>
        /// <param name="houseIDs">仓库ID列表</param>
        /// <param name="productCodes">产品编码列表</param>
        /// <returns></returns>
        public List<CargoProductEntity> QueryProductByHouseIDsAndCodes(IEnumerable<int> houseIDs, IEnumerable<string> productCodes)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            if (!houseIDs.Any() || !productCodes.Any()) return result;

            var houseIDSet = new HashSet<int>(houseIDs.Distinct());
            var codeList = productCodes.Distinct().ToList();

            // 只用 ProductCode 查询，避免笛卡尔积导致临时表过大
            var queryParams = codeList.Select(code => new ProductQueryParam { ProductCode = code }).ToList();

            // 步骤1: 创建全局临时表（独立连接，避免DTC）
            string createTempTableSQL = @"
IF OBJECT_ID('tempdb..##ProductQueryParmTemp') IS NOT NULL DROP TABLE ##ProductQueryParmTemp;
CREATE TABLE ##ProductQueryParmTemp(
    ProductCode NVARCHAR(50) NOT NULL
);";


            // 步骤3: 创建索引并查询数据（独立连接，避免DTC）
            string querySQL = $@"
SELECT p.ProductID, p.SpecsType, p.ProductCode, p.BatchYear, p.TypeID, p.HouseID, p.SuppClientNum, p.ShareHouseID
FROM Tbl_Cargo_Product p WITH(NOLOCK)
INNER JOIN ##ProductQueryParmTemp t ON p.ProductCode = t.ProductCode
WHERE p.SpecsType = '5'
AND p.HouseID IN ({string.Join(",", houseIDSet)});";

            using (DbCommand createCommand = conn.GetSqlStringCommond(createTempTableSQL))
            {
                createCommand.Connection.Open();
                createCommand.ExecuteNonQuery();
                createCommand.Connection.Close();
                //conn.ExecuteScalar(createCommand);
                conn.BulkInsertData(queryParams, "##ProductQueryParmTemp");

                // 执行查询
                createCommand.Connection.Open();
                createCommand.CommandText = querySQL;
                using (DataTable dd = conn.ExecuteDataTable(createCommand))
                {
                    foreach (DataRow row in dd.Rows)
                    {
                        result.Add(new CargoProductEntity
                        {
                            ProductID = row.Field<long>("ProductID"),
                            SpecsType = row.Field<string>("SpecsType") ?? "",
                            ProductCode = row.Field<string>("ProductCode") ?? "",
                            BatchYear = row.Field<int?>("BatchYear") ?? 0,
                            TypeID = row.Field<int>("TypeID"),
                            HouseID = row.Field<int?>("HouseID") ?? 0,
                            SuppClientNum = row.Field<int?>("SuppClientNum") ?? 0,
                            ShareHouseID = row.Field<int?>("ShareHouseID") ?? 0,
                        });
                    }
                }

                createCommand.Connection.Close();
            }
            
            return result;
        }

        /// <summary>
        /// 获取所有产品
        /// </summary>
        /// <returns></returns>
        public List<CargoProductEntity> QueryProductByHousIDs(CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            string strSQL = "select * from Tbl_Cargo_Product where (1=1) and SpecsType=5";

            if (entity.HouseID != 0)
            {
                strSQL += $@" and HouseID='{entity.HouseID}' ";
            }
            if (entity.TypeID != 0)
            {
                strSQL += $@" and TypeID='{entity.TypeID}' ";
            }
            if (!string.IsNullOrEmpty(entity.ProductCodeStr))
            {
                strSQL += $@" and ProductCode in({entity.ProductCodeStr}) ";
            }


            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow row in dd.Rows)
                    {
                        result.Add(new CargoProductEntity
                        {
                            ProductID = row.Field<long>("ProductID"),
                            SpecsType = row.Field<string>("SpecsType") ?? "",
                            ProductCode = row.Field<string>("ProductCode") ?? "",
                            BatchYear = row.Field<int?>("BatchYear") ?? 0,
                            TypeID = row.Field<int>("TypeID"),
                            HouseID = row.Field<int?>("HouseID") ?? 0,
                            SuppClientNum = row.Field<int?>("SuppClientNum") ?? 0,
                            ShareHouseID = row.Field<int?>("ShareHouseID") ?? 0,
                        });
                    }
                }
            }
            return result;
        }
        #endregion

        #region 广丰品番供应商品番
        /// <summary>
        /// 判断仓库名是否存在 true:表示存在
        /// </summary>
        /// <param name="entity"></param>
        /// <returns>true:表示存在</returns>
        public bool IsExistGtmcProduct(CargoGtmcProductBasicEntity entity)
        {
            string strQ = @"Select SupplierPinfan from Tbl_GTMC_ProductBasic Where (1=1)";
            if (!string.IsNullOrEmpty(entity.SupplierCode)) { strQ += " and SupplierCode='" + entity.SupplierCode + "'"; }
            if (!string.IsNullOrEmpty(entity.SupplierPinfan)) { strQ += " and SupplierPinfan='" + entity.SupplierPinfan + "'"; }
            if (!string.IsNullOrEmpty(entity.GtmcPinfan)) { strQ += " and GtmcPinfan='" + entity.GtmcPinfan + "'"; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        public Hashtable QueryGtmcProductData(int pIndex, int pNum, CargoGtmcProductBasicEntity entity)
        {
            List<CargoGtmcProductBasicEntity> result = new List<CargoGtmcProductBasicEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY OPDATE DESC) AS RowNumber,* FROM Tbl_GTMC_ProductBasic WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.SupplierCode)) { strSQL += " and SupplierCode like '%" + entity.SupplierCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.SupplierName)) { strSQL += " and SupplierName = '%" + entity.SupplierName + "%'"; }
                if (!string.IsNullOrEmpty(entity.SupplierPinfan)) { strSQL += " and SupplierPinfan like '%" + entity.SupplierPinfan + "%'"; }
                if (!string.IsNullOrEmpty(entity.GtmcPinfan)) { strSQL += " and GtmcPinfan like '%" + entity.GtmcPinfan + "%'"; }
                if (!string.IsNullOrEmpty(entity.GtmcBeifan)) { strSQL += " and GtmcBeifan like '%" + entity.GtmcBeifan + "%'"; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoGtmcProductBasicEntity
                            {
                                PID = Convert.ToInt64(idr["PID"]),
                                SupplierCode = Convert.ToString(idr["SupplierCode"]),
                                SupplierName = Convert.ToString(idr["SupplierName"]),
                                SupplierPinfan = Convert.ToString(idr["SupplierPinfan"]),
                                SupplierBeifan = Convert.ToString(idr["SupplierBeifan"]),
                                GtmcBeifan = Convert.ToString(idr["GtmcBeifan"]),
                                GtmcPinfan = Convert.ToString(idr["GtmcPinfan"]),
                                OPDATE = Convert.ToDateTime(idr["OPDATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_GTMC_ProductBasic Where (1=1)";
                if (!string.IsNullOrEmpty(entity.SupplierCode)) { strCount += " and SupplierCode like '%" + entity.SupplierCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.SupplierName)) { strCount += " and SupplierName = '%" + entity.SupplierName + "%'"; }
                if (!string.IsNullOrEmpty(entity.SupplierPinfan)) { strCount += " and SupplierPinfan like '%" + entity.SupplierPinfan + "%'"; }
                if (!string.IsNullOrEmpty(entity.GtmcPinfan)) { strCount += " and GtmcPinfan like '%" + entity.GtmcPinfan + "%'"; }
                if (!string.IsNullOrEmpty(entity.GtmcBeifan)) { strCount += " and GtmcBeifan like '%" + entity.GtmcBeifan + "%'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        public void DelGtmcProductBasic(List<CargoGtmcProductBasicEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_GTMC_ProductBasic where PID=@PID ";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@PID", DbType.Int64, it.PID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void AddGtmcProductBasic(CargoGtmcProductBasicEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"INSERT INTO Tbl_GTMC_ProductBasic(SupplierCode,SupplierName,SupplierPinfan,SupplierBeifan,GtmcPinfan,GtmcBeifan) VALUES (@SupplierCode,@SupplierName,@SupplierPinfan,@SupplierBeifan,@GtmcPinfan,@GtmcBeifan)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@SupplierCode", DbType.String, entity.SupplierCode);
                    conn.AddInParameter(cmd, "@SupplierName", DbType.String, entity.SupplierName);
                    conn.AddInParameter(cmd, "@SupplierPinfan", DbType.String, entity.SupplierPinfan);
                    conn.AddInParameter(cmd, "@SupplierBeifan", DbType.String, entity.SupplierBeifan);
                    conn.AddInParameter(cmd, "@GtmcPinfan", DbType.String, entity.GtmcPinfan);
                    conn.AddInParameter(cmd, "@GtmcBeifan", DbType.String, entity.GtmcBeifan);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        public CargoProductEntity QueryTopOneProduct(CargoProductEntity entity)
        {
            CargoProductEntity result = new CargoProductEntity();
            string strSQL = "select top 1 ProductID,TypeID From Tbl_Cargo_Product where InCargoStatus=1";
            if (!entity.HouseID.Equals(0))
            {
                strSQL += " and HouseID=" + entity.HouseID;
            }
            if (!string.IsNullOrEmpty(entity.GoodsCode))
            {
                strSQL += " and GoodsCode='" + entity.GoodsCode + "'";
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.ProductID = Convert.ToInt64(idr["ProductID"]);
                        result.TypeID = Convert.ToInt32(idr["TypeID"]);
                    }
                }
            }

            return result;
        }

        public List<CargoProductEntity> QueryProductID(CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            string strSQL = "SELECT c.ProductCode,mAX(Batch)Batch, maX(SalePrice)SalePrice,a.TypeID,  suM(Piece)Piece  FROM Tbl_Cargo_Product A left join Tbl_Cargo_ProductSpec as c on a.TypeID=c.TypeID and a.Specs=c.Specs and a.Figure=c.Figure and a.LoadIndex=c.LoadIndex  and c.SpeedLevel=a.SpeedLevel and a.Model=c.Model LEFT JOIN Tbl_Cargo_ContainerGoods T ON T.ProductID=A.ProductID where 1=1";
            if (!string.IsNullOrEmpty(entity.Model))
            {
                strSQL += $" and A.Model='{entity.Model}'";
            }
            if (!string.IsNullOrEmpty(entity.GoodsCode))
            {
                strSQL += $" and A.GoodsCode='{entity.GoodsCode}'";
            }
            if (entity.TypeID != 0)
            {
                strSQL += $" and A.TypeID='{entity.TypeID}'";
            }
            if (entity.HouseID != 0)
            {
                strSQL += $" and A.HouseID='{entity.HouseID}'";
            }
            if (!string.IsNullOrEmpty(entity.Specs))
            {
                strSQL += $" and A.Specs='{entity.Specs}'";
            }
            if (!string.IsNullOrEmpty(entity.Figure))
            {
                strSQL += $" and A.Figure='{entity.Figure}'";
            }
            if (entity.ProductID != 0)
            {
                strSQL += $" and A.ProductID='{entity.ProductID}'";
            }
            if (!string.IsNullOrEmpty(Convert.ToString(entity.ProductCode)))
            {
                strSQL += $" and C.ProductCode='{entity.ProductCode}'";
            }
            strSQL += " GROUP BY c.ProductCode,a.TypeID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoProductEntity
                        {
                            ProductCode = Convert.ToString(idr["ProductCode"]),
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            Batch = Convert.ToString(idr["Batch"]),
                            SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                            RealStockNum = Convert.ToInt32(idr["Piece"]),
                        });
                    }
                }
            }
            return result;
        }
        public void AddChangeStock(CargoProductEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Open_ChangeStock(ProductCode, Number,Batch,SalePrice,OPDATE, DelFlag) VALUES (@ProductCode, @Number,@Batch,@SalePrice, getDate(), 0)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.AddInParameter(cmd, "@Number", DbType.String, entity.RealStockNum);
                    conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);
                    conn.AddInParameter(cmd, "@SalePrice", DbType.Decimal, entity.SalePrice);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }

        public void UpdateChangeStock(CargoProductEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Open_ChangeStock SET Number=@Number,Batch=@Batch,SalePrice=@SalePrice,DelFlag=0 WHERE ProductCode=@ProductCode";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.AddInParameter(cmd, "@Number", DbType.String, entity.RealStockNum);
                    conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);
                    conn.AddInParameter(cmd, "@SalePrice", DbType.Decimal, entity.SalePrice);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }

        public bool IsProductCodeExist(string ProductCode)
        {
            string strSQL = $"Select * from Tbl_Open_ChangeStock WHERE ProductCode='{ProductCode}'";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;

        }

        public CargoProductEntity QueryProductContainerGoods(CargoProductEntity entity)
        {
            CargoProductEntity result = new CargoProductEntity();
            string strSQL = "SELECT sum(Piece) as Piece,ProductID FROM Tbl_Cargo_ContainerGoods where 1=1";
            if (entity.TypeID != 0)
            {
                strSQL += $" and TypeID='{entity.TypeID}'";
            }
            if (entity.ProductID != 0)
            {
                strSQL += $" and ProductID='{entity.ProductID}'";
            }
            if (entity.ContainerID != 0)
            {
                strSQL += $" and ContainerID='{entity.ContainerID}'";
            }
            strSQL += " group by ProductID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.ProductID = Convert.ToInt64(idr["ProductID"]);
                        result.RealStockNum = Convert.ToInt32(idr["Piece"]);
                    }
                }
            }
            return result;


        }
        public CargoGtmcProductBasicEntity QueryGtmcProductInfo(CargoGtmcProductBasicEntity entity)
        {
            CargoGtmcProductBasicEntity result = new CargoGtmcProductBasicEntity();
            try
            {
                string strSQL = @"Select top 1 * from Tbl_GTMC_ProductBasic  where (1=1) ";
                if (!string.IsNullOrEmpty(entity.SupplierPinfan))
                {
                    strSQL += " and SupplierPinfan='" + entity.SupplierPinfan + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.PID = Convert.ToInt64(idr["PID"]);
                            result.SupplierCode = Convert.ToString(idr["SupplierCode"]);
                            result.SupplierName = Convert.ToString(idr["SupplierName"]);
                            result.SupplierPinfan = Convert.ToString(idr["SupplierPinfan"]);
                            result.GtmcPinfan = Convert.ToString(idr["GtmcPinfan"]);
                            result.GtmcBeifan = Convert.ToString(idr["GtmcBeifan"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        #endregion

        #region 获取字符串拼音

        /// <summary>
        /// 在指定的字符串列表CnStr中检索符合拼音索引字符串
        /// </summary>
        /// <param name="CnStr">汉字字符串</param>
        /// <returns>相对应的汉语拼音首字母串</returns>
        public static string GetSpellCode(string CnStr)
        {
            string strTemp = "";
            for (int i = 0; i < CnStr.Length; i++)
            {
                strTemp += GetCharSpellCode(CnStr.Substring(i, 1));
            }
            return strTemp;
        }
        /// <summary>
        /// 截取字符长度
        /// </summary>
        /// <param name="str">被截取的字符串</param>
        /// <param name="len">所截取的长度</param>
        /// <returns>子字符串</returns>
        public static string CutString(string str, int len)
        {
            if (str == null || str.Length == 0 || len <= 0)
            {
                return string.Empty;
            }
            int l = str.Length;
            #region 计算长度
            int clen = 0;
            while (clen < len && clen < l)
            {
                //每遇到一个中文，则将目标长度减一。
                if ((int)str[clen] > 128) { len--; }
                clen++;
            }
            #endregion

            if (clen < l)
            {
                return str.Substring(0, clen) + "...";
            }
            else
            {
                return str;
            }
        }
        /// <summary>
        /// 得到一个汉字的拼音第一个字母，如果是一个英文字母则直接返回大写字母
        /// </summary>
        /// <param name="CnChar">单个汉字</param>
        /// <returns>单个大写字母</returns>
        private static string GetCharSpellCode(string CnChar)
        {

            long iCnChar;

            byte[] ZW = System.Text.Encoding.Default.GetBytes(CnChar);

            //如果是字母，则直接返回首字母

            if (ZW.Length == 1)
            {

                return CutString(CnChar.ToUpper(), 1);

            }
            else
            {

                // get the array of byte from the single char

                int i1 = (short)(ZW[0]);

                int i2 = (short)(ZW[1]);

                iCnChar = i1 * 256 + i2;

            }

            // iCnChar match the constant

            if ((iCnChar >= 45217) && (iCnChar <= 45252)) { return "a"; }
            else if ((iCnChar >= 45253) && (iCnChar <= 45760)) { return "B"; }
            else if ((iCnChar >= 45761) && (iCnChar <= 46317))
            {

                return "C";

            }
            else if ((iCnChar >= 46318) && (iCnChar <= 46825))
            {

                return "D";

            }
            else if ((iCnChar >= 46826) && (iCnChar <= 47009))
            {

                return "E";

            }
            else if ((iCnChar >= 47010) && (iCnChar <= 47296))
            {

                return "F";

            }
            else if ((iCnChar >= 47297) && (iCnChar <= 47613))
            {

                return "G";

            }
            else if ((iCnChar >= 47614) && (iCnChar <= 48118))
            {

                return "H";

            }
            else if ((iCnChar >= 48119) && (iCnChar <= 49061))
            {

                return "J";

            }
            else if ((iCnChar >= 49062) && (iCnChar <= 49323))
            {

                return "K";

            }
            else if ((iCnChar >= 49324) && (iCnChar <= 49895))
            {

                return "L";

            }
            else if ((iCnChar >= 49896) && (iCnChar <= 50370))
            {

                return "M";

            }
            else if ((iCnChar >= 50371) && (iCnChar <= 50613))
            {

                return "N";

            }
            else if ((iCnChar >= 50614) && (iCnChar <= 50621))
            {

                return "O";

            }
            else if ((iCnChar >= 50622) && (iCnChar <= 50905))
            {

                return "P";

            }
            else if ((iCnChar >= 50906) && (iCnChar <= 51386))
            {

                return "Q";

            }
            else if ((iCnChar >= 51387) && (iCnChar <= 51445))
            {

                return "R";

            }
            else if ((iCnChar >= 51446) && (iCnChar <= 52217))
            {

                return "S";

            }
            else if ((iCnChar >= 52218) && (iCnChar <= 52697))
            {

                return "T";

            }
            else if ((iCnChar >= 52698) && (iCnChar <= 52979))
            {

                return "W";

            }
            else if ((iCnChar >= 52980) && (iCnChar <= 53640))
            {

                return "X";

            }
            else if ((iCnChar >= 53689) && (iCnChar <= 54480))
            {

                return "Y";

            }
            else if ((iCnChar >= 54481) && (iCnChar <= 55289))
            {

                return "Z";

            }
            else

                return ("?");

        }
        #endregion

        #region 产品价格操作方法集合
        /// <summary>
        /// 查询当前客户的产品价格数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryAllSupplierProductPrice(int pIndex, int pNum, CargoSupplierProductPriceEntity entity)
        {
            List<CargoSupplierProductPriceEntity> result = new List<CargoSupplierProductPriceEntity>();
            Hashtable resTab = new Hashtable();
            try
            {
                string strSQL = @"SELECT TOP " + pNum + " * FROM  (SELECT ROW_NUMBER() OVER (ORDER BY s.Specs asc) AS RowNumber,a.*,s.Specs,s.Figure,s.GoodsCode,s.LoadIndex,s.SpeedLevel,s.Born,t.TypeName ,t.ParentID,t.TypeParentName,h.Name AS HouseName FROM Tbl_Cargo_SupplierProductPrice a INNER JOIN Tbl_Cargo_ProductSpec s ON a.SID = s.SID INNER JOIN Tbl_Cargo_ProductType t ON s.TypeID=t.TypeID  INNER JOIN Tbl_Cargo_House h ON h.HouseID = a.HouseID WHERE (1=1) and a.DelFlag=0 ";

                if (!entity.SupplierNum.Equals(0)) { strSQL += " and a.SupplierNum=" + entity.SupplierNum; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and t.TypeID=" + entity.TypeID; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID; }
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and s.ProductCode like '%" + entity.ProductCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and s.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strSQL += " and s.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strSQL += " and s.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strSQL += " and (s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or s.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strSQL += " and (s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoSupplierProductPriceEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                SID = Convert.ToInt32(idr["SID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                Born = Convert.ToInt32(idr["Born"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                UnitPrice = Convert.ToDouble(idr["UnitPrice"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),

                            });
                        }
                    }
                }
                resTab["rows"] = result;
                string strCount = "select count(*) as TotalCount from Tbl_Cargo_SupplierProductPrice as a INNER JOIN Tbl_Cargo_ProductSpec s ON a.SID = s.SID INNER JOIN Tbl_Cargo_ProductType t ON s.TypeID=t.TypeID  INNER JOIN Tbl_Cargo_House h ON h.HouseID = a.HouseID WHERE (1=1) and a.DelFlag=0 ";
                if (!entity.SupplierNum.Equals(0)) { strCount += " and a.SupplierNum=" + entity.SupplierNum; }
                if (!entity.TypeID.Equals(0)) { strCount += " and t.TypeID=" + entity.TypeID; }
                if (!entity.HouseID.Equals(0)) { strCount += " and a.HouseID=" + entity.HouseID; }
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strCount += " and s.ProductCode like '%" + entity.ProductCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and s.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strSQL += " and s.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strCount += " and s.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strCount += " and (s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or s.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strCount += " and (s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resTab["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return resTab;
        }
        /// <summary>
        /// 查询供应商的所有产品数据用于导出
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoSupplierProductPriceEntity> QuerySupplierProductALLExport(CargoSupplierProductPriceEntity entity)
        {
            List<CargoSupplierProductPriceEntity> result = new List<CargoSupplierProductPriceEntity>();

            string strSQL = @"SELECT a.*,s.Specs,s.Figure,s.GoodsCode,s.LoadIndex,s.SpeedLevel,s.Born,t.TypeName ,t.ParentID,t.TypeParentName,h.Name AS HouseName FROM Tbl_Cargo_SupplierProductPrice a INNER JOIN Tbl_Cargo_ProductSpec s ON a.SID = s.SID INNER JOIN Tbl_Cargo_ProductType t ON s.TypeID=t.TypeID  INNER JOIN Tbl_Cargo_House h ON h.HouseID = a.HouseID WHERE (1=1) and a.DelFlag=0";

            if (!entity.SupplierNum.Equals(0)) { strSQL += " and a.SupplierNum=" + entity.SupplierNum; }
            if (!entity.TypeID.Equals(0)) { strSQL += " and t.TypeID=" + entity.TypeID; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID; }
            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and s.ProductCode like '%" + entity.ProductCode + "%'"; }
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and s.Figure like '%" + entity.Figure + "%'"; }
            if (!string.IsNullOrEmpty(entity.Specs))
            {
                //strSQL += " and s.Specs like '%" + entity.Specs + "%'";
                string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                if (res.Length <= 3)
                {
                    if (!string.IsNullOrEmpty(res)) { strSQL += " and s.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strSQL += " and (s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or s.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
                if (res.Length > 5)
                {
                    strSQL += " and (s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
            }
            strSQL += " Order by s.Specs asc";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoSupplierProductPriceEntity
                        {
                            ID = Convert.ToInt64(idr["ID"]),
                            SID = Convert.ToInt32(idr["SID"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            Specs = Convert.ToString(idr["Specs"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            GoodsCode = Convert.ToString(idr["GoodsCode"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            Born = Convert.ToInt32(idr["Born"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                            UnitPrice = Convert.ToDouble(idr["UnitPrice"]),
                            ProductCode = Convert.ToString(idr["ProductCode"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            HouseName = Convert.ToString(idr["HouseName"]),

                        });
                    }
                }
            }
            return result;
        }

        /// <summary>
        /// 修改供应商产品单价
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateSupplierProductPrice(List<CargoSupplierProductPriceEntity> entities)
        {
            foreach (var entity in entities)
            {
                string strSQL = "BEGIN TRANSACTION; UPDATE Tbl_Cargo_SupplierProductPrice  SET UnitPrice =@UnitPrice where ProductCode=@ProductCode  AND HouseID=@HouseID AND SupplierNum =@SupplierNum ;" +
                    " UPDATE Tbl_Cargo_Product  SET SalePrice =@SalePrice,InHousePrice=@UnitPrice where ProductCode=@ProductCode AND HouseID=@HouseID and SuppClientNum=@SupplierNum; COMMIT;";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@SupplierNum", DbType.Int64, entity.SupplierNum);
                    conn.AddInParameter(command, "@HouseID", DbType.Int64, entity.HouseID);
                    conn.AddInParameter(command, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.AddInParameter(command, "@UnitPrice", DbType.Double, entity.UnitPrice);
                    conn.AddInParameter(command, "@SalePrice", DbType.Double, entity.SalePrice);
                    conn.ExecuteNonQuery(command);
                }
            }
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="entity"></param>
        public void InsertSupplierProductPrice(CargoSupplierProductPrice entity)
        {
            string strSQL = "INSERT INTO Tbl_Cargo_SupplierProductPrice (SID,SupplierID,SupplierNum,HouseID,ProductCode,TypeID) VALUES(@SID,@SupplierID,@SupplierNum,@HouseID,@ProductCode,@TypeID);";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@SID", DbType.Int32, entity.SID);
                conn.AddInParameter(command, "@SupplierID", DbType.Int32, entity.SupplierID);
                conn.AddInParameter(command, "@SupplierNum", DbType.Int32, entity.SupplierNum);
                conn.AddInParameter(command, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(command, "@TypeID", DbType.Int32, entity.TypeID);
                conn.AddInParameter(command, "@ProductCode", DbType.String, entity.ProductCode);
                conn.ExecuteNonQuery(command);
            }
        }
        /// <summary>
        /// 判断供应商品牌数据中是否存在该基础数据  以产品ID判断
        /// </summary>
        /// <param name="entity"></param>
        /// <returns>True:表示已经存在，False：表示不存在</returns>
        public bool IsExistSupplierProductPrice(CargoSupplierProductPrice entity)
        {
            string strQ = @"Select ID from Tbl_Cargo_SupplierProductPrice Where SID=@SID and HouseID=@HouseID and TypeID=@TypeID and SupplierID=@SupplierID and SupplierNum=@SupplierNum";

            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@SID", DbType.Int64, entity.SID);
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmdQ, "@TypeID", DbType.Int32, entity.TypeID);
                conn.AddInParameter(cmdQ, "@SupplierID", DbType.Int32, entity.SupplierID);
                conn.AddInParameter(cmdQ, "@SupplierNum", DbType.Int32, entity.SupplierNum);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }

        #endregion

        #region 查询产品规格方法集合
        /// <summary>
        /// 根据产品编码查询产品规格
        /// </summary>
        /// <param name="productCode"></param>
        /// <returns></returns>
        public CargoProductSpecEntity GetProductSpecByProductCode(string productCode)
        {
            CargoProductSpecEntity result = new CargoProductSpecEntity();
            try
            {
                string strSQL = @"SELECT t.TypeName,s.* FROM Tbl_Cargo_ProductSpec as s INNER JOIN Tbl_Cargo_ProductType as t ON s.TypeID = t.TypeID where s.ProductCode = @ProductCode";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, productCode);
                    using (DataTable dd = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.SID = Convert.ToInt64(idr["SID"]);
                            result.ProductCode = Convert.ToString(idr["ProductCode"]);
                            result.ProductName = Convert.ToString(idr["ProductName"]);
                            result.TypeID = Convert.ToInt32(idr["TypeID"]);
                            result.Model = Convert.ToString(idr["Model"]);
                            result.GoodsCode = Convert.ToString(idr["GoodsCode"]);
                            result.Specs = Convert.ToString(idr["Specs"]);
                            result.Figure = Convert.ToString(idr["Figure"]);
                            result.TreadWidth = Convert.ToInt32(idr["TreadWidth"]);
                            result.FlatRatio = Convert.ToInt32(idr["FlatRatio"]);
                            result.HubDiameter = Convert.ToInt32(idr["HubDiameter"]);
                            result.LoadIndex = Convert.ToString(idr["LoadIndex"]);
                            result.SpeedLevel = Convert.ToString(idr["SpeedLevel"]);
                            result.LoadSpeed = Convert.ToString(idr["LoadIndex"]) + Convert.ToString(idr["SpeedLevel"]);
                            result.Born = Convert.ToInt32(idr["Born"]);
                            result.Assort = Convert.ToString(idr["Assort"]);
                            result.CommType = string.IsNullOrEmpty(Convert.ToString(idr["CommType"])) ? 0 : Convert.ToInt32(idr["CommType"]);
                            result.Thumbnail = Convert.ToString(idr["Thumbnail"]);
                            result.DetailDrawing = Convert.ToString(idr["DetailDrawing"]);
                            result.CarModel = Convert.ToString(idr["CarModel"]);
                            result.Manufacturer = Convert.ToString(idr["Manufacturer"]);
                            result.ManufacturerAddress = Convert.ToString(idr["ManufacturerAddress"]);
                            result.Seller = Convert.ToString(idr["Seller"]);
                            result.SellerAddress = Convert.ToString(idr["SellerAddress"]);
                            result.Servicer = Convert.ToString(idr["Servicer"]);
                            result.ServicerAddress = Convert.ToString(idr["ServicerAddress"]);
                            result.BrandCode = Convert.ToString(idr["BrandCode"]);
                            result.ProductUnit = Convert.ToString(idr["ProductUnit"]);
                            result.BundleNum = Convert.ToInt32(idr["BundleNum"]);
                            result.TyreType = Convert.ToInt32(idr["TyreType"]);
                            result.TypeName = Convert.ToString(idr["TypeName"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 根据查询产品信息
        /// </summary>
        /// <param name="productCode"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public CargoProductSpecEntity GetProductSpecEntity(CargoProductSpecEntity entity)
        {
            CargoProductSpecEntity result = new CargoProductSpecEntity();
            try
            {
                string strSQL = @"SELECT * FROM Tbl_Cargo_ProductSpec where 1=1  and DelFlag=0 ";
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    strSQL += @" and Specs='" + entity.Specs + "'";
                }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure))
                {
                    strSQL += @" and Figure='" + entity.Figure + "'";
                }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode))
                {
                    strSQL += @" and GoodsCode='" + entity.GoodsCode + "'";
                }
                if (!string.IsNullOrEmpty(entity.ProductCode))
                {
                    strSQL += @" and ProductCode='" + entity.ProductCode + "'";
                }
                if (entity.TypeID != 0)
                {
                    strSQL += @" and TypeID='" + entity.TypeID + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.SID = Convert.ToInt64(idr["SID"]);
                            result.ProductCode = Convert.ToString(idr["ProductCode"]);
                            result.ProductName = Convert.ToString(idr["ProductName"]);
                            result.TypeID = Convert.ToInt32(idr["TypeID"]);
                            result.Model = Convert.ToString(idr["Model"]);
                            result.GoodsCode = Convert.ToString(idr["GoodsCode"]);
                            result.Specs = Convert.ToString(idr["Specs"]);
                            result.Figure = Convert.ToString(idr["Figure"]);
                            result.TreadWidth = Convert.ToInt32(idr["TreadWidth"]);
                            result.FlatRatio = Convert.ToInt32(idr["FlatRatio"]);
                            result.HubDiameter = Convert.ToInt32(idr["HubDiameter"]);
                            result.LoadIndex = Convert.ToString(idr["LoadIndex"]);
                            result.SpeedLevel = Convert.ToString(idr["SpeedLevel"]);
                            result.LoadSpeed = Convert.ToString(idr["LoadIndex"]) + Convert.ToString(idr["SpeedLevel"]);
                            result.Born = Convert.ToInt32(idr["Born"]);
                            result.Assort = Convert.ToString(idr["Assort"]);
                            result.CommType = string.IsNullOrEmpty(Convert.ToString(idr["CommType"])) ? 0 : Convert.ToInt32(idr["CommType"]);
                            result.Thumbnail = Convert.ToString(idr["Thumbnail"]);
                            result.DetailDrawing = Convert.ToString(idr["DetailDrawing"]);
                            result.CarModel = Convert.ToString(idr["CarModel"]);
                            result.Manufacturer = Convert.ToString(idr["Manufacturer"]);
                            result.ManufacturerAddress = Convert.ToString(idr["ManufacturerAddress"]);
                            result.Seller = Convert.ToString(idr["Seller"]);
                            result.SellerAddress = Convert.ToString(idr["SellerAddress"]);
                            result.Servicer = Convert.ToString(idr["Servicer"]);
                            result.ServicerAddress = Convert.ToString(idr["ServicerAddress"]);
                            result.BrandCode = Convert.ToString(idr["BrandCode"]);
                            result.ProductUnit = Convert.ToString(idr["ProductUnit"]);
                            result.BundleNum = Convert.ToInt32(idr["BundleNum"]);
                            result.TyreType = Convert.ToInt32(idr["TyreType"]);
                            //result.TypeName = Convert.ToString(idr["TypeName"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        public Hashtable QueryProductMapping(int pIndex, int pNum, CargoProductMappingEntity entity)
        {
            List<CargoProductMappingEntity> result = new List<CargoProductMappingEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.MID desc) AS RowNumber, a.*,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,b.GoodsCode,b.TypeID,c.TypeName from Tbl_Cargo_ProductMapping as a inner join Tbl_Cargo_ProductSpec as b on a.ProductCode=b.ProductCode inner join Tbl_Cargo_ProductType as c on b.TypeID=c.TypeID ";
                strSQL += " Where (1=1)";
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and a.ProductCode like '%" + entity.ProductCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.CassCode)) { strSQL += " and a.CassCode like '%" + entity.CassCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.ShareCode)) { strSQL += " and a.ShareCode like '%" + entity.ShareCode + "%'"; }

                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strSQL += " and a.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strSQL += " and b.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strSQL += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or b.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strSQL += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and b.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and b.TypeID=" + entity.TypeID; }
                //花纹
                if (!string.IsNullOrEmpty(entity.CorpClass)) { strSQL += " and a.CorpClass = '" + entity.CorpClass + "'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                ////入库时间
                //if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                //{
                //    strSQL += " and a.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                //}
                //if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                //{
                //    strSQL += " and a.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                //}

                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1)) ORDER BY  A.RowNumber ";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoProductMappingEntity
                            {
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                ShareCode = Convert.ToString(idr["ShareCode"]),
                                CorpClass = Convert.ToString(idr["CorpClass"]),
                                MID = Convert.ToInt64(idr["MID"]),
                                CassCode = Convert.ToString(idr["CassCode"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]).Trim(),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]).Trim(),
                                Figure = Convert.ToString(idr["Figure"]).Trim(),
                                Specs = Convert.ToString(idr["Specs"]).Trim(),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),

                            });
                        }
                    }
                }

                resHT["rows"] = result;

                string strCount = @"SELECT Count(*) as TotalCount FROM Tbl_Cargo_ProductMapping as a inner join Tbl_Cargo_ProductSpec as b on a.ProductCode=b.ProductCode ";
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strCount += " and a.ProductCode like '%" + entity.ProductCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.CassCode)) { strCount += " and a.CassCode like '%" + entity.CassCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.ShareCode)) { strCount += " and a.ShareCode like '%" + entity.ShareCode + "%'"; }

                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strSQL += " and a.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strCount += " and b.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strCount += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or b.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strCount += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strCount += " and b.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strCount += " and b.TypeID=" + entity.TypeID; }
                //花纹
                if (!string.IsNullOrEmpty(entity.CorpClass)) { strCount += " and a.CorpClass = '" + entity.CorpClass + "'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and a.Figure like '%" + entity.Figure + "%'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        /// <summary>
        /// 新增产品映射
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoProductMapping(CargoProductMappingEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"INSERT INTO Tbl_Cargo_ProductMapping(ProductCode,CassCode,CorpClass,ShareCode) VALUES (@ProductCode,@CassCode,@CorpClass,@ShareCode)SELECT @@IDENTITY";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode.Trim());
                conn.AddInParameter(cmd, "@CassCode", DbType.String, entity.CassCode.Trim());
                conn.AddInParameter(cmd, "@CorpClass", DbType.String, entity.CorpClass);
                conn.AddInParameter(cmd, "@ShareCode", DbType.String, entity.ShareCode.Trim());
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 删除产品映射
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoProductMapping(List<CargoProductMappingEntity> entity)
        {
            foreach (var it in entity)
            {
                string strSQL = @"Delete from Tbl_Cargo_ProductMapping where MID=@MID ";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@MID", DbType.Int64, it.MID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
        }
        /// <summary>
        /// 根据货品代码查询产品共享编码数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoProductMappingEntity> QueryProductShareCode(CargoProductMappingEntity entity)
        {
            List<CargoProductMappingEntity> result = new List<CargoProductMappingEntity>();
            string strSQL = "select * from Tbl_Cargo_ProductMapping where sharecode in (select sharecode from Tbl_Cargo_ProductMapping where casscode='" + entity.CassCode + "')";
            using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoProductMappingEntity
                        {
                            MID = Convert.ToInt64(idr["MID"]),
                            ProductCode = Convert.ToString(idr["ProductCode"]),
                            CassCode = Convert.ToString(idr["CassCode"]),
                            CorpClass = Convert.ToString(idr["CorpClass"]),
                            ShareCode = Convert.ToString(idr["ShareCode"]),

                        });
                    }
                }
            }
            return result;
        }

        /// <summary>
        /// 批量修改产品基础规格的轮胎照片
        /// </summary>
        /// <param name="entity"></param>
        public void PLSaveTyreFigurePic(List<CargoProductEntity> entity)
        {
            foreach (var it in entity)
            {
                string strSQL = @"update Tbl_Cargo_ProductSpec set Thumbnail=@Thumbnail where TypeID=@TypeID and SID=@SID ";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@SID", DbType.Int32, it.SID);
                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, it.TypeID);
                    conn.AddInParameter(cmd, "@Thumbnail", DbType.String, it.Thumbnail);
                    conn.ExecuteNonQuery(cmd);
                }
            }
        }
        #endregion

        /// <summary>
        /// 查询标签产品 移库
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryProductMoveOrder(int pIndex, int pNum, CargoMoveOrderGoodsEntity entity)
        {
            List<CargoMoveOrderGoodsEntity> result = new List<CargoMoveOrderGoodsEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = $@" SELECT TOP {pNum} * from( select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber, a.ProductID,a.ContainerGoodsID,a.MoveNo,bb.OldHouseID,bb.OldHouseName,bb.NewHouseID,bb.NewHouseName,bb.NewAreaID,e.Name as OldwAreaName,bb.MoveNum,a.NewPiece,bb.MoveStatus,ff.TypeName,prod.GoodsCode,prod.ProductCode,bb.OPID,bb.OP_DATE,d.ContainerCode,users.UserName from Tbl_Cargo_MoveOrderGood as a inner join Tbl_Cargo_MoveOrder as bb on a.MoveNo=bb.MoveNo inner join Tbl_Cargo_ContainerGoods as b on a.ContainerGoodsID = b.ID inner join Tbl_Cargo_Container as d on b.ContainerID = d.ContainerID inner join Tbl_Cargo_Area as e on d.AreaID = e.AreaID inner join Tbl_Cargo_Area as f on e.ParentID = f.AreaID inner join Tbl_Cargo_Area as h on f.ParentID = h.AreaID inner join Tbl_Cargo_House as ee on h.HouseID = ee.HouseID inner join Tbl_Cargo_Product as prod on prod.ProductID=a.ProductID inner join Tbl_Cargo_ProductType as ff on prod.TypeID = ff.TypeID left join Tbl_SysUser as users on bb.OPID=users.LoginName ";
                if (!string.IsNullOrEmpty(entity.TagCode) || !string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " inner join Tbl_Cargo_ProductTag as gg on a.ProductID=gg.ProductID and a.MoveNo = gg.MoveOrderNo "; }
                strSQL += " Where (1=1)";
                //轮胎唯一编码
                if (!string.IsNullOrEmpty(entity.TagCode)) { strSQL += " and gg.TagCode like '%" + entity.TagCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " and gg.TyreCode like '%" + entity.TyreCode + "%'"; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strSQL += " and a.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                //以一级类型ID为查询条件
                if (!entity.ProductID.Equals(0)) { strSQL += " and a.ProductID=" + entity.ProductID; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and a.ProductCode like '%" + entity.ProductCode + "%'"; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1)) ORDER BY  A.RowNumber ";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoMoveOrderGoodsEntity
                            {
                                //AreaName = Convert.ToString(idr["AreaName"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                MoveNo = Convert.ToString(idr["MoveNo"]),
                                MoveNum = Convert.ToInt32(idr["MoveNum"]),
                                NewPiece = Convert.ToInt32(idr["NewPiece"]),
                                MoveStatus = Convert.ToString(idr["MoveStatus"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                HouseName = Convert.ToString(idr["OldHouseName"]),
                                FirstAreaName = Convert.ToString(idr["OldwAreaName"]),
                                NewHouseName = Convert.ToString(idr["NewHouseName"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                OPID = Convert.ToString(idr["UserName"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                            });
                        }
                    }
                }

                resHT["rows"] = result;

                //string strCount = @"select count(1) as TotalCount from Tbl_Cargo_MoveOrderGood as a inner join Tbl_Cargo_MoveOrder as bb on a.MoveNo=bb.MoveNo inner join Tbl_Cargo_ContainerGoods as b on a.ContainerGoodsID = b.ID inner join Tbl_Cargo_Container as d on b.ContainerID = d.ContainerID inner join Tbl_Cargo_Area as e on d.AreaID = e.AreaID inner join Tbl_Cargo_Area as f on e.ParentID = f.AreaID inner join Tbl_Cargo_Area as h on f.ParentID = h.AreaID inner join Tbl_Cargo_House as ee on h.HouseID = ee.HouseID inner join Tbl_Cargo_Product as prod on prod.ProductID=a.ProductID inner join Tbl_Cargo_ProductType as ff on prod.TypeID = ff.TypeID  ";
                //if (!string.IsNullOrEmpty(entity.TagCode) || !string.IsNullOrEmpty(entity.TyreCode)) { strCount += " inner join Tbl_Cargo_ProductTag as gg on a.ProductID=gg.ProductID "; }
                //strCount += " Where (1=1)";
                ////轮胎唯一编码
                //if (!string.IsNullOrEmpty(entity.TagCode)) { strCount += " and gg.TagCode like '%" + entity.TagCode + "%'"; }
                //if (!string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " and gg.TyreCode like '%" + entity.TyreCode + "%'"; }
                //if (!entity.ProductID.Equals(0)) { strSQL += " and a.ProductID=" + entity.ProductID; }
                //using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                //{
                //    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                //    {
                //        if (idrCount.Rows.Count > 0)
                //        {
                //            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                //        }
                //    }

                //}
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        /// <summary>
        /// 查询标签产品 销售(退货)订单
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryProductSalesOrder(int pIndex, int pNum, CargoOrderGoodsEntity entity)
        {

            List<CargoOrderGoodsEntity> result = new List<CargoOrderGoodsEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = $@" SELECT TOP {pNum} * from( select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.HouseID,b.Name as HouseName,c.AreaID,c.Name as AreaName,a.OrderNo,a.ProductID,a.Piece,a.ContainerCode,prod.GoodsCode,prod.ProductCode,f.TypeName,prod.BelongDepart,order_.AwbStatus,order_.DeliveryType,order_.OrderModel,order_.OrderType,order_.FinanceSecondCheck,order_.CheckStatus,order_.CreateAwb,order_.CreateDate,order_.ThrowGood from Tbl_Cargo_OrderGoods as a inner join Tbl_Cargo_Order as order_ on a.OrderNo=order_.OrderNo inner join Tbl_Cargo_House as b on a.HouseID = b.HouseID inner join Tbl_Cargo_Area as c on a.AreaID = c.AreaID inner join Tbl_Cargo_Product as prod on a.ProductID = prod.ProductID  inner join Tbl_Cargo_ProductType as f on prod.TypeID = f.TypeID ";
                if (!string.IsNullOrEmpty(entity.TagCode) || !string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " inner join Tbl_Cargo_ProductTag as gg on a.ProductID=gg.ProductID and gg.OrderNo=a.OrderNo "; }
                strSQL += " Where (1=1)";
                //轮胎唯一编码
                if (!string.IsNullOrEmpty(entity.TagCode)) { strSQL += " and gg.TagCode like '%" + entity.TagCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " and gg.TyreCode like '%" + entity.TyreCode + "%'"; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.ProductID.Equals(0)) { strSQL += " and a.ProductID=" + entity.ProductID; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1)) ORDER BY  A.RowNumber ";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoOrderGoodsEntity
                            {
                                //AreaName = Convert.ToString(idr["AreaName"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                AwbStatus = Convert.ToInt32(idr["AwbStatus"]),
                                ThrowGood = Convert.ToString(idr["ThrowGood"]),
                                DeliveryType = Convert.ToInt32(idr["DeliveryType"]),
                                FinanceSecondCheck = Convert.ToInt32(idr["FinanceSecondCheck"]),
                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                CheckStatus = string.IsNullOrEmpty(Convert.ToString(idr["CheckStatus"])) ? 0 : Convert.ToInt32(idr["CheckStatus"]),
                                CreateAwb = Convert.ToString(idr["CreateAwb"]),
                                BelongDepart = Convert.ToString(idr["BelongDepart"]),
                                OrderType = Convert.ToInt32(idr["OrderType"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                            });
                        }
                    }
                }

                resHT["rows"] = result;

                //string strCount = @"select count(1) as TotalCount from Tbl_Cargo_OrderGoods as a inner join Tbl_Cargo_Order as order_ on a.OrderNo=order_.OrderNo inner join Tbl_Cargo_House as b on a.HouseID = b.HouseID inner join Tbl_Cargo_Area as c on a.AreaID = c.AreaID inner join Tbl_Cargo_Product as prod on a.ProductID = prod.ProductID inner join Tbl_Cargo_ProductType as f on prod.TypeID = f.TypeID  ";
                //if (!string.IsNullOrEmpty(entity.TagCode) || !string.IsNullOrEmpty(entity.TyreCode)) { strCount += " inner join Tbl_Cargo_ProductTag as gg on a.ProductID=gg.ProductID "; }
                //strCount += " Where (1=1)";
                ////轮胎唯一编码
                //if (!string.IsNullOrEmpty(entity.TagCode)) { strCount += " and gg.TagCode like '%" + entity.TagCode + "%'"; }
                //if (!string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " and gg.TyreCode like '%" + entity.TyreCode + "%'"; }
                //if (!entity.ProductID.Equals(0)) { strSQL += " and a.ProductID=" + entity.ProductID; }
                //using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                //{
                //    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                //    {
                //        if (idrCount.Rows.Count > 0)
                //        {
                //            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                //        }
                //    }

                //}
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        /// <summary>
        /// 查询标签产品
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryProductTag(int pIndex, int pNum, CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = $@" SELECT TOP {pNum} * from( select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,h.Name FirstAreaName,e.Name HouseName, d.Name as AreaName,g.Name as ParentAreaName,c.ContainerCode,c.ContainerID,a.Piece,a.InHouseTime,f.TypeName,product.ProductID,product.ProductCode,product.GoodsCode,product.Model,product.Specs,product.Figure,product.LoadIndex,product.Batch,product.ProductName,product.Supplier,product.BelongDepart from Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as product on a.ProductID=product.ProductID inner join Tbl_Cargo_Container as c on a.ContainerID = c.ContainerID inner join Tbl_Cargo_Area as d on c.AreaID = d.AreaID inner join Tbl_Cargo_Area as g on d.ParentID = g.AreaID inner join Tbl_Cargo_Area as h on g.ParentID = h.AreaID inner join Tbl_Cargo_House as e on h.HouseID = e.HouseID inner join Tbl_Cargo_ProductType as f on product.TypeID = f.TypeID ";
                if (!string.IsNullOrEmpty(entity.TagCode) || !string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " inner join Tbl_Cargo_ProductTag as gg on a.ProductID=gg.ProductID "; }
                strSQL += " Where (1=1)";
                //轮胎唯一编码
                if (!string.IsNullOrEmpty(entity.TagCode)) { strSQL += " and gg.TagCode like '%" + entity.TagCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " and gg.TyreCode like '%" + entity.TyreCode + "%'"; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strSQL += " and a.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and a.ProductCode like '%" + entity.ProductCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.ParentID.Equals(0)) { strSQL += " and b.ParentID=" + entity.ParentID; }
                if (!entity.ProductID.Equals(0)) { strSQL += " and a.ProductID=" + entity.ProductID; }

                //入库时间
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1)) ORDER BY  A.RowNumber ";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            var HouseTime = DateTime.Now - (idr["InHouseTime"] == DBNull.Value ? DateTime.Now : Convert.ToDateTime(idr["InHouseTime"]));
                            result.Add(new CargoProductEntity
                            {
                                AreaName = Convert.ToString(idr["AreaName"]),
                                FirstAreaName = Convert.ToString(idr["FirstAreaName"]),
                                ParentAreaName = Convert.ToString(idr["ParentAreaName"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                //TagCode = Convert.ToString(idr["TagCode"]),
                                InHouseTime = string.IsNullOrEmpty(Convert.ToString(idr["InHouseTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["InHouseTime"]),
                                InHouseDay = Convert.ToString(HouseTime.Days),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                TypeName = Convert.ToString(idr["TypeName"]).Trim(),
                                Model = Convert.ToString(idr["Model"]).Trim(),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]).Trim(),
                                Figure = Convert.ToString(idr["Figure"]).Trim(),
                                Specs = Convert.ToString(idr["Specs"]).Trim(),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                HouseName = Convert.ToString(idr["HouseName"]).Trim(),
                                Supplier = Convert.ToString(idr["Supplier"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                BelongDepart = Convert.ToString(idr["BelongDepart"]),
                                Piece = Convert.ToInt32(idr["Piece"])
                            });
                        }
                    }
                }

                resHT["rows"] = result;

                string strCount = @"select count(1) as TotalCount from Tbl_Cargo_ContainerGoods as a  inner join Tbl_Cargo_Product as product on a.ProductID=product.ProductID inner join Tbl_Cargo_Container as c on a.ContainerID = c.ContainerID inner join Tbl_Cargo_Area as d on c.AreaID = d.AreaID inner join Tbl_Cargo_Area as g on d.ParentID = g.AreaID inner join Tbl_Cargo_Area as h on g.ParentID = h.AreaID inner join Tbl_Cargo_House as e on h.HouseID = e.HouseID inner join Tbl_Cargo_ProductType as f on product.TypeID = f.TypeID  ";
                if (!string.IsNullOrEmpty(entity.TagCode) || !string.IsNullOrEmpty(entity.TyreCode)) { strCount += " inner join Tbl_Cargo_ProductTag as gg on a.ProductID=gg.ProductID "; }
                strCount += " Where (1=1)";
                //轮胎唯一编码
                if (!string.IsNullOrEmpty(entity.TagCode)) { strCount += " and gg.TagCode like '%" + entity.TagCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.TyreCode)) { strSQL += " and gg.TyreCode like '%" + entity.TyreCode + "%'"; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strCount += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strCount += " and a.Model like '%" + entity.Model + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strCount += " and a.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strCount += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strCount += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strCount += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strCount += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.ParentID.Equals(0)) { strCount += " and b.ParentID=" + entity.ParentID; }
                if (!entity.ProductID.Equals(0)) { strCount += " and a.ProductID=" + entity.ProductID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strCount += " and a.TypeID=" + entity.TypeID; }
                if (!entity.TreadWidth.Equals(0)) { strCount += " and a.TreadWidth=" + entity.TreadWidth; }
                if (!entity.FlatRatio.Equals(0)) { strCount += " and a.FlatRatio=" + entity.FlatRatio; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Batch)) { strCount += " and a.Batch = '" + entity.Batch + "'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and a.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Meridian)) { strCount += " and a.Meridian = '" + entity.Meridian + "'"; }
                if (!entity.HubDiameter.Equals(0)) { strCount += " and a.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strCount += " and a.LoadIndex like '%" + entity.LoadIndex + "%'"; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strCount += " and a.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                if (!string.IsNullOrEmpty(entity.InCargoStatus)) { strCount += " and a.InCargoStatus = '" + entity.InCargoStatus + "'"; }
                if (!string.IsNullOrEmpty(entity.BelongDepart)) { strCount += " and a.BelongDepart = '" + entity.BelongDepart + "'"; }
                //入库时间
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //产品来源ID
                if (!string.IsNullOrEmpty(entity.Source)) { strCount += " and a.Source = " + entity.Source; }
                if (!string.IsNullOrEmpty(entity.SourceOrderNo)) { strCount += " and a.SourceOrderNo = '" + entity.SourceOrderNo + "'"; }
                if (!string.IsNullOrEmpty(entity.IsLockStock)) { strCount += " and a.IsLockStock = '" + entity.IsLockStock + "'"; }
                if (!string.IsNullOrEmpty(entity.Supplier)) { strCount += " and a.Supplier = '" + entity.Supplier + "'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        #region 慧采云仓-补货统计
        /// <summary>
        /// 销售统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoProductEntity> QueryProductSell(CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            string strSQL = @"
SELECT SUM(a.Piece) AS TotalPiece,b.HouseID,c.Name AS HouseName,t.TypeID,t.TypeName,b.SuppClientNum,b.ProductCode,b.ProductName,b.Model,b.GoodsCode,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,b.Supplier
FROM Tbl_Cargo_OrderGoods AS a
JOIN Tbl_Cargo_Product AS b ON a.ProductID = b.ProductID
JOIN Tbl_Cargo_House AS c ON b.HouseID = c.HouseID
JOIN Tbl_Cargo_ProductType AS t ON b.TypeID = t.TypeID
WHERE (1=1) ";
            if (!entity.SuppClientNum.Equals(0)) { strSQL += " and b.SuppClientNum='" + entity.SuppClientNum + "'"; }

            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and b.ProductCode='" + entity.ProductCode + "'"; }

            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }

            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.OP_DATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " GROUP BY b.HouseID,c.Name,t.TypeID,t.TypeName, b.SuppClientNum, b.ProductCode, b.ProductName,b.Model,b.GoodsCode,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,b.Supplier";
            strSQL += " Order by TotalPiece DESC";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoProductEntity
                            {
                                Piece = Convert.ToInt32(idrCount["TotalPiece"]),
                                TypeID = Convert.ToInt32(idrCount["TypeID"]),
                                TypeName = Convert.ToString(idrCount["TypeName"]).Trim(),
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                HouseName = Convert.ToString(idrCount["HouseName"]).Trim(),
                                SuppClientNum = Convert.ToInt32(idrCount["SuppClientNum"]),
                                Supplier = Convert.ToString(idrCount["Supplier"]).Trim(),
                                ProductCode = Convert.ToString(idrCount["ProductCode"]),
                                ProductName = Convert.ToString(idrCount["ProductName"]),
                                Model = Convert.ToString(idrCount["Model"]),
                                GoodsCode = Convert.ToString(idrCount["GoodsCode"]),
                                Specs = Convert.ToString(idrCount["Specs"]),
                                Figure = Convert.ToString(idrCount["Figure"]),
                                LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                            });
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 入库统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoProductEntity> QueryProductIn(CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            string strSQL = @"
SELECT SUM(a.Piece) AS TotalPiece,b.HouseID,c.Name AS HouseName,t.TypeID,t.TypeName,b.SuppClientNum,b.ProductCode,b.ProductName,b.Model,b.GoodsCode,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,b.Supplier
FROM Tbl_Cargo_InContainerGoods as a
JOIN Tbl_Cargo_Product AS b ON a.ProductID = b.ProductID
JOIN Tbl_Cargo_House AS c ON b.HouseID = c.HouseID
JOIN Tbl_Cargo_ProductType AS t ON b.TypeID = t.TypeID
WHERE (1=1) ";
            if (!entity.SuppClientNum.Equals(0)) { strSQL += " and b.SuppClientNum='" + entity.SuppClientNum + "'"; }

            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and b.ProductCode='" + entity.ProductCode + "'"; }

            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }

            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.OP_DATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " GROUP BY b.HouseID,c.Name,t.TypeID,t.TypeName, b.SuppClientNum, b.ProductCode, b.ProductName,b.Model,b.GoodsCode,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,b.Supplier";
            strSQL += " Order by TotalPiece DESC";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoProductEntity
                            {
                                Piece = Convert.ToInt32(idrCount["TotalPiece"]),
                                TypeID = Convert.ToInt32(idrCount["TypeID"]),
                                TypeName = Convert.ToString(idrCount["TypeName"]).Trim(),
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                HouseName = Convert.ToString(idrCount["HouseName"]).Trim(),
                                SuppClientNum = Convert.ToInt32(idrCount["SuppClientNum"]),
                                Supplier = Convert.ToString(idrCount["Supplier"]).Trim(),
                                ProductCode = Convert.ToString(idrCount["ProductCode"]),
                                ProductName = Convert.ToString(idrCount["ProductName"]),
                                Model = Convert.ToString(idrCount["Model"]),
                                GoodsCode = Convert.ToString(idrCount["GoodsCode"]),
                                Specs = Convert.ToString(idrCount["Specs"]),
                                Figure = Convert.ToString(idrCount["Figure"]),
                                LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                            });
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        #endregion

        public List<CargoProductEntity> GetProductList()
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            try
            {
                string strSQL = $@" select * from Tbl_Cargo_Product where 1=1 and SpecsType=5";

                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoProductEntity
                            {
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                BatchYear = Convert.ToInt32(idr["BatchYear"]),
                                BatchWeek = Convert.ToInt32(idr["BatchWeek"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),

                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public void UpdateProductData(CargoProductEntity entity)
        {
            try
            {
                entity.EnSafe();
                string strSQL = @"update Tbl_Cargo_Product set Numbers=@Numbers,InHousePrice=@InHousePrice,SalePrice=@SalePrice,Batch=@Batch,BatchWeek=@BatchWeek,BatchYear=@BatchYear where ProductID=@ProductID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@Numbers", DbType.Int64, entity.Numbers);
                    conn.AddInParameter(cmd, "@InHousePrice", DbType.Decimal, entity.InHousePrice);
                    conn.AddInParameter(cmd, "@SalePrice", DbType.Decimal, entity.SalePrice);
                    conn.AddInParameter(cmd, "@ProductID", DbType.String, entity.ProductID);
                    conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);
                    conn.AddInParameter(cmd, "@BatchWeek", DbType.Int32, entity.BatchWeek);
                    conn.AddInParameter(cmd, "@BatchYear", DbType.Int32, entity.BatchYear);

                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void UpdateContainerGoodsData(CargoContainerGoodsEntity entity)
        {
            try
            {
                string strSQL = @"update Tbl_Cargo_ContainerGoods set Piece=@Piece where ProductID=@ProductID and ContainerID=@ContainerID and TypeID=@TypeID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@Piece", DbType.Int64, entity.Piece);
                    conn.AddInParameter(cmd, "@ContainerID", DbType.String, entity.ContainerID);
                    conn.AddInParameter(cmd, "@ProductID", DbType.String, entity.ProductID);
                    conn.AddInParameter(cmd, "@TypeID", DbType.String, entity.TypeID);

                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        #region 集采上架

        public Hashtable QueryBasicProdictData(int pIndex, int pNum, CargoContainerShowEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY SaleType desc,a.OPDATE DESC) AS RowNumber, a.*,b.TypeName, b.ParentID as TypeParentID, b.TypeParentName,g.OnSaleNum,g.Title,g.Memo,g.FileName,g.Consume,g.ProductPrice,g.SigningPrice,g.minPurchase,g.SaleType,g.ShelveStatus,g.OP_DATE,g.ID as OnSaleID,g.HouseID,c.Name as HouseName from Tbl_Cargo_ProductSpec as a inner join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID left join Tbl_Cargo_Shelves as g on a.ProductCode=g.ProductCode  and a.TypeID=g.TypeID and SaleType = 5 left join Tbl_Cargo_House as c on g.HouseID = c.HouseID  where 1=1  ";
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strCount += " and a.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strSQL += " and b.ParentID=" + entity.TypeParentID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                if (!entity.TreadWidth.Equals(0)) { strSQL += " and a.TreadWidth=" + entity.TreadWidth; }
                if (!entity.FlatRatio.Equals(0)) { strSQL += " and a.FlatRatio=" + entity.FlatRatio; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure = '" + entity.Figure + "'"; }
                if (!entity.HubDiameter.Equals(0)) { strSQL += " and a.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex=" + entity.LoadIndex; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                if (!string.IsNullOrEmpty(entity.OnShelves))
                {
                    strSQL += " and g.ShelveStatus='" + entity.OnShelves + "'";
                }
                if (!string.IsNullOrEmpty(entity.SaleType)) { strSQL += " and g.SaleType = '" + entity.SaleType + "'"; }


                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                //strSQL += " order by a.Figure asc,a.BatchYear asc,a.BatchWeek asc";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {

                            result.Add(new CargoContainerShowEntity
                            {
                                OnSaleID = string.IsNullOrEmpty(Convert.ToString(idr["OnSaleID"])) ? 0 : Convert.ToInt64(idr["OnSaleID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                HouseID = string.IsNullOrEmpty(Convert.ToString(idr["HouseID"])) ? 0 : Convert.ToInt32(idr["HouseID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                TypeParentID = Convert.ToInt32(idr["TypeParentID"]),
                                TypeParentName = Convert.ToString(idr["TypeParentName"]),
                                Model = Convert.ToString(idr["Model"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                                HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                ShelvesNum = string.IsNullOrEmpty(Convert.ToString(idr["OnSaleNum"])) ? 0 : Convert.ToInt32(idr["OnSaleNum"]),
                                Title = Convert.ToString(idr["Title"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                FileName = Convert.ToString(idr["FileName"]),
                                ID = Convert.ToInt64(idr["RowNumber"]),
                                Consume = string.IsNullOrEmpty(Convert.ToString(idr["Consume"])) ? 0 : Convert.ToInt32(idr["Consume"]),
                                ProductPrice = string.IsNullOrEmpty(Convert.ToString(idr["ProductPrice"])) ? 0 : Convert.ToDecimal(idr["ProductPrice"]),
                                SigningPrice = string.IsNullOrEmpty(Convert.ToString(idr["SigningPrice"])) ? 0 : Convert.ToDecimal(idr["SigningPrice"]),
                                minPurchase = string.IsNullOrEmpty(Convert.ToString(idr["minPurchase"])) ? 0 : Convert.ToDecimal(idr["minPurchase"]),
                                SaleType = Convert.ToString(idr["SaleType"]),
                                OnShelves = !string.IsNullOrEmpty(Convert.ToString(idr["Title"])) && Convert.ToString(idr["ShelveStatus"]).Equals("0") ? "0" : "1",
                                OP_DATE = string.IsNullOrEmpty(Convert.ToString(idr["OP_DATE"])) ? DateTime.MinValue : Convert.ToDateTime(idr["OP_DATE"]),
                            });
                        }
                    }
                }

                resHT["rows"] = result;

                string strCount = @"select count(1) as TotalCount from Tbl_Cargo_ProductSpec as a inner join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID left join Tbl_Cargo_Shelves as g on a.ProductCode=g.ProductCode and a.TypeID=g.TypeID and SaleType = 5  where 1=1 ";
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strCount += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    //strCount += " and a.Specs like '%" + entity.Specs + "%'";
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strCount += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strCount += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strCount += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strCount += " and a.Model like '%" + entity.Model + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strCount += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strCount += " and b.ParentID=" + entity.TypeParentID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strCount += " and a.TypeID=" + entity.TypeID; }
                if (!entity.TreadWidth.Equals(0)) { strCount += " and a.TreadWidth=" + entity.TreadWidth; }
                if (!entity.FlatRatio.Equals(0)) { strCount += " and a.FlatRatio=" + entity.FlatRatio; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strCount += " and a.Batch = '" + entity.Batch + "'"; }
                if (!entity.BatchWeekStart.Equals(0)) { strCount += " and a.BatchWeek>=" + entity.BatchWeekStart; }
                if (!entity.BatchWeekEnd.Equals(0)) { strCount += " and a.BatchWeek<=" + entity.BatchWeekEnd; }
                if (!entity.BatchYear.Equals(0)) { strCount += " and a.BatchYear=" + entity.BatchYear; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and a.Figure = '" + entity.Figure + "'"; }
                if (!entity.HubDiameter.Equals(0)) { strCount += " and a.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strCount += " and a.LoadIndex=" + entity.LoadIndex; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strCount += " and a.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                if (!string.IsNullOrEmpty(entity.OnShelves))
                {
                    strCount += " and g.ShelveStatus='" + entity.OnShelves + "'";
                }
                if (!string.IsNullOrEmpty(entity.SaleType)) { strCount += " and g.SaleType = '" + entity.SaleType + "'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        public List<CargoAddProductShelvesEntity> QueryReserveShelves()
        {
            List<CargoAddProductShelvesEntity> result = new List<CargoAddProductShelvesEntity>();
            try
            {
                string strSQL = $@" select * from Tbl_Cargo_Shelves where 1=1 and SaleType=5";

                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoAddProductShelvesEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        #endregion

        /// <summary>
        /// 获取基础产品
        /// </summary>
        /// <returns></returns>
        public List<CargoProductSpecEntity> QueryProductSpecs(CargoProductEntity entity)
        {
            List<CargoProductSpecEntity> result = new List<CargoProductSpecEntity>();
            string strSQL = "select * from Tbl_Cargo_ProductSpec where (1=1)";
            if (!string.IsNullOrEmpty(entity.ProductCodeStr))
            {
                strSQL += $@" and ProductCode in({entity.ProductCodeStr}) ";
            }


            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow row in dd.Rows)
                    {
                        result.Add(new CargoProductSpecEntity
                        {
                            ProductCode = row.Field<string>("ProductCode") ?? "",
                            TypeID = row.Field<int>("TypeID"),
                        });
                    }
                }
            }
            return result;
        }

        //        public void UpdateContainerGoodsTakeDate(int StockID)
        //        {
        //            string strSQL = @"
        //UPDATE cg
        //SET cg.Take_DATE = stg.OP_DATE
        //FROM Tbl_Cargo_ContainerGoods AS cg
        //INNER JOIN Tbl_Cargo_StockTakeTag AS stg
        //ON cg.ContainerID = stg.ContainerID
        //AND cg.ProductID = stg.ProductID
        //WHERE stg.StockID = @StockID";
        //            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
        //            {
        //                conn.AddInParameter(cmd, "@StockID", DbType.Int32, StockID);
        //                conn.ExecuteNonQuery(cmd);
        //            }
        //        }
    }

    
}
