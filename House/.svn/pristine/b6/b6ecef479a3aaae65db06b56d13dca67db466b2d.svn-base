using House.DataAccess;
using House.Entity;
using House.Entity.Cargo;
using House.Entity.Cargo.House;
using House.Entity.Cargo.Interface;
using House.Entity.Cargo.Order;
using House.Entity.Cargo.Product;
using House.Entity.Dto;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Data.SqlClient;
using System.Globalization;
using System.Linq;
using System.Text;

namespace House.Manager.Cargo
{
    /// <summary>
    /// 仓储管理系统接口数据操作类
    /// </summary>
    public class CargoInterfaceManager
    {
        private SqlHelper conn = new SqlHelper();

        #region 库存接口方法集合
        /// <summary>
        /// 查询仓库产品库存数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoInterfaceEntity> queryCargoStock(CargoInterfaceEntity entity)
        {
            List<CargoInterfaceEntity> result = new List<CargoInterfaceEntity>();
            try
            {
                string strSQL = @"select a.ProductID,a.SuppClientNum,a.ProductName,a.TypeID,a.Model,a.GoodsCode,a.Specs,a.Figure,a.LoadIndex,a.SpeedLevel,a.SpeedMax,a.Batch,a.BatchYear,a.SalePrice,a.TradePrice,a.CostPrice,a.InHousePrice,a.NextDayPrice,a.HouseID,a.GoodsName,b.ID,b.ContainerID,b.Piece,b.InHouseTime,b.InCargoID,c.ContainerCode,c.AreaID,d.IsAddOrder,ca2.Name as AreaName,ca3.OrderCode,ca3.OrderDep,a.ShareHouseID,a.ShareHouseName from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID left join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID inner join Tbl_Cargo_Area as d on c.AreaID=d.AreaID inner join Tbl_Cargo_Area ca2 on d.ParentID=ca2.AreaID inner join Tbl_Cargo_Area ca3 on ca2.ParentID=ca3.AreaID ";
                //(a.BelongDepart != '1' or a.BelongDepart is NULL)
                if (!entity.Regular.Equals(0))
                {
                    //查询特价促销和积分兑换 and f.AdvertStartDate<='" + DateTime.Now.ToString("yyyy-MM-dd") + "' and f.AdvertEndDate>=" + DateTime.Now.ToString("yyyy-MM-dd") + "
                    strSQL += " inner join Tbl_Cargo_Shelves as f on a.ProductID=f.ProductID and f.SaleType=" + entity.Regular;
                }
                strSQL += " Where a.InCargoStatus='1' and a.IsLockStock=0 and b.Piece<>0 ";
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode=@GoodsCode"; }
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName=@ProductName"; }
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and a.ProductCode=@ProductCode"; }
                if (!string.IsNullOrEmpty(entity.ProductCodeStr)) { strSQL += " and a.ProductCode in ('" + entity.ProductCodeStr + "')"; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=@TypeID "; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=@HouseID "; }
                if (!entity.AreaID.Equals(0)) { strSQL += " and ca3.AreaID=@AreaID "; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex=@LoadIndex "; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel=@SpeedLevel"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model=@Model"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs=@Specs"; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure=@Figure"; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch=@Batch"; }
                if (!entity.BatckWeek.Equals(0))
                {
                    //if (entity.TypeID.Equals(9))
                    //{
                    //    strSQL += " and a.BatchYear>=20";
                    //}
                    //else 
                    if (entity.TypeID.Equals(258))
                    {
                        //安泰路斯特殊处理一年半以前周期的轮胎不能出库
                        if (DateTime.Now.Month <= 6)
                        {
                            strSQL += " and (a.BatchYear>=" + DateTime.Now.AddYears(-1).ToString("yy") + " or (a.BatchYear=" + DateTime.Now.AddYears(-2).ToString("yy") + " and a.BatchWeek>=" + entity.BatckWeek + ") )";
                        }
                        else
                        {
                            strSQL += " and (a.BatchYear=" + DateTime.Now.ToString("yy") + " or (a.BatchYear=" + DateTime.Now.AddYears(-1).ToString("yy") + " and a.BatchWeek>=" + entity.BatckWeek + ") or (a.BatchYear=" + DateTime.Now.AddYears(-2).ToString("yy") + " and a.BatchWeek>=" + entity.BatckWeek + ") )";
                        }
                    }
                    else
                    {
                        strSQL += " and (a.BatchYear=" + DateTime.Now.ToString("yy") + " or (a.BatchYear=" + DateTime.Now.AddYears(-1).ToString("yy") + " and a.BatchWeek>=" + entity.BatckWeek + "))";
                        //strSQL += " and (a.BatchYear=" + DateTime.Now.ToString("yy") + ")";
                    }
                }
                if (!entity.BatchWeekFilter.Equals(0))
                {
                    var currPrefixYear = DateTime.Now.Year.ToString().Substring(0, 2);
                   var BatchWeek = GetWeekOfYear($@"{currPrefixYear}{entity.BatchYear}-06-{(GetLastDayOfMonth(entity.BatchYear, 6).Day)}");
                    if (entity.BatchWeekFilter==1)
                    {
                        strSQL += $@" and (a.BatchWeek<={BatchWeek})";
                    }
                    else
                    {
                        strSQL += $@" and (a.BatchWeek>{BatchWeek})";
                    }
                }
                if (!entity.LastMonth.Equals(0))
                {
                    if (DateTime.Now.Month > entity.LastMonth)
                    {
                        strSQL += " AND ((a.BatchWeek>DATEPART(week,DATEADD(month," + (entity.LastMonth * -1) + ",getdate())) AND a.BatchYear=SUBSTRING(DateName(year,dateadd(YEAR,0,GetDate()) ),3,2)))";
                    }
                    else
                    {
                        strSQL += " AND ((a.BatchWeek>DATEPART(week,DATEADD(month," + (entity.LastMonth * -1) + ",getdate())) AND a.BatchYear=SUBSTRING(DateName(year,dateadd(MONTH," + (entity.LastMonth * -1) + ",GetDate()) ),3,2)) or a.BatchYear=SUBSTRING(DateName(year,dateadd(YEAR,0,GetDate()) ),3,2))";
                    }
                }
                if (!entity.BatchYear.Equals(0))
                {
                    strSQL += " and a.BatchYear=" + entity.BatchYear;
                }
                if (!entity.ActSalePrice.Equals(0)) { strSQL += " and a.TradePrice=" + entity.ActSalePrice; }
                if (!string.IsNullOrEmpty(entity.BelongDepart)) { strSQL += " and a.BelongDepart=@BelongDepart"; }
                if (!string.IsNullOrEmpty(entity.SuppClientNum)) { strSQL += " and a.SuppClientNum=@SuppClientNum"; }
                if (!string.IsNullOrEmpty(entity.SuppClientNumStr)) { strSQL += " and a.SuppClientNum in (" + entity.SuppClientNumStr + ")"; }

                //if (!string.IsNullOrEmpty(entity.SpecsType)) { strSQL += " and a.SpecsType=@SpecsType"; }
                if (!string.IsNullOrEmpty(entity.SpecsType)) { strSQL += " and a.SpecsType='" + entity.SpecsType + "'"; }
                else
                {
                    strSQL += " and a.SpecsType<>5";
                }
                if (entity.ParentID.Equals(1))
                {
                    //表示查询的轮胎
                    strSQL += " order by a.BatchYear asc ,a.BatchWeek asc,b.Piece asc,b.ContainerID asc  ";
                }
                else
                {
                    strSQL += " order by a.Batch asc,b.Piece asc,b.ContainerID asc";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!string.IsNullOrEmpty(entity.GoodsCode)) { conn.AddInParameter(cmd, "@GoodsCode", DbType.String, entity.GoodsCode); }
                    if (!string.IsNullOrEmpty(entity.ProductName)) { conn.AddInParameter(cmd, "@ProductName", DbType.String, entity.ProductName); }
                    if (!string.IsNullOrEmpty(entity.ProductCode)) { conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode); }
                    if (!entity.TypeID.Equals(0)) { conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID); }
                    if (!entity.HouseID.Equals(0)) { conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID); }
                    if (!entity.AreaID.Equals(0)) { conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID); }
                    if (!string.IsNullOrEmpty(entity.LoadIndex)) { conn.AddInParameter(cmd, "@LoadIndex", DbType.String, entity.LoadIndex); }
                    if (!string.IsNullOrEmpty(entity.SpeedLevel)) { conn.AddInParameter(cmd, "@SpeedLevel", DbType.String, entity.SpeedLevel); }
                    //型号
                    if (!string.IsNullOrEmpty(entity.Model)) { conn.AddInParameter(cmd, "@Model", DbType.String, entity.Model); }
                    //规格
                    if (!string.IsNullOrEmpty(entity.Specs)) { conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs); }
                    //花纹
                    if (!string.IsNullOrEmpty(entity.Figure)) { conn.AddInParameter(cmd, "@Figure", DbType.String, entity.Figure); }
                    if (!string.IsNullOrEmpty(entity.Batch)) { conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch); }
                    if (!string.IsNullOrEmpty(entity.BelongDepart)) { conn.AddInParameter(cmd, "@BelongDepart", DbType.String, entity.BelongDepart); }
                    if (!string.IsNullOrEmpty(entity.SuppClientNum)) { conn.AddInParameter(cmd, "@SuppClientNum", DbType.String, entity.SuppClientNum); }
                    // if (!string.IsNullOrEmpty(entity.SpecsType)) { conn.AddInParameter(cmd, "@SpecsType", DbType.String, entity.SpecsType); }
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            if (Convert.ToInt32(idrCount["Piece"]) <= 0) { continue; }
                            result.Add(new CargoInterfaceEntity
                            {
                                ContainerGoodsID = Convert.ToInt64(idrCount["ID"]),
                                ProductID = Convert.ToInt64(idrCount["ProductID"]),
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                ContainerID = Convert.ToInt32(idrCount["ContainerID"]),
                                TypeID = Convert.ToInt32(idrCount["TypeID"]),
                                ProductName = Convert.ToString(idrCount["ProductName"]),
                                Model = Convert.ToString(idrCount["Model"]).Trim(),
                                GoodsCode = Convert.ToString(idrCount["GoodsCode"]),
                                Specs = Convert.ToString(idrCount["Specs"]),
                                Figure = Convert.ToString(idrCount["Figure"]),
                                LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                                SpeedMax = Convert.ToInt32(idrCount["SpeedMax"]),
                                Batch = Convert.ToString(idrCount["Batch"]),
                                BatchYear = Convert.ToInt32(idrCount["BatchYear"]),
                                ContainerCode = Convert.ToString(idrCount["ContainerCode"]),
                                StockNum = Convert.ToInt32(idrCount["Piece"]),
                                InHouseTime = Convert.ToDateTime(idrCount["InHouseTime"]),
                                InCargoID = Convert.ToString(idrCount["InCargoID"]),
                                AreaID = Convert.ToInt32(idrCount["AreaID"]),
                                InHousePrice = Convert.ToDecimal(idrCount["InHousePrice"]),
                                SalePrice = Convert.ToDecimal(idrCount["SalePrice"]),
                                CostPrice = Convert.ToDecimal(idrCount["CostPrice"]),
                                TradePrice = Convert.ToDecimal(idrCount["TradePrice"]),
                                NextDayPrice = string.IsNullOrEmpty(Convert.ToString(idrCount["NextDayPrice"])) ? 0 : Convert.ToDecimal(idrCount["NextDayPrice"]),
                                IsAddOrder = Convert.ToString(idrCount["IsAddOrder"]),
                                OrderCode = Convert.ToString(idrCount["OrderCode"]),
                                SuppClientNum = Convert.ToString(idrCount["SuppClientNum"]),
                                OrderDep = Convert.ToString(idrCount["OrderDep"]),
                                ShareHouseID = Convert.ToInt32(idrCount["ShareHouseID"]),
                                ShareHouseName = Convert.ToString(idrCount["ShareHouseName"]),
                                GoodsName = Convert.ToString(idrCount["GoodsName"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public static DateTime GetLastDayOfMonth(int year, int month)
        {
            int lastDay = DateTime.DaysInMonth(year, month);
            return new DateTime(year, month, lastDay);
        }

        public static int GetWeekOfYear(string dateStr)
        {
            var date = Convert.ToDateTime(dateStr);
            // 使用 ISO 8601 标准（周一为一周的第一天）
            var culture = CultureInfo.CurrentCulture;
            CalendarWeekRule weekRule = culture.DateTimeFormat.CalendarWeekRule;
            DayOfWeek firstDayOfWeek = culture.DateTimeFormat.FirstDayOfWeek;

            return culture.Calendar.GetWeekOfYear(date, weekRule, firstDayOfWeek);
        }
        /// <summary>
        /// 查询前置仓仓库产品库存数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoInterfaceEntity> queryMiniCargoStock(CargoInterfaceEntity entity)
        {
            List<CargoInterfaceEntity> result = new List<CargoInterfaceEntity>();
            try
            {
                string strSQL = @"select a.ProductID,a.ProductName,a.TypeID,a.Model,a.GoodsCode,a.Specs,a.Figure,a.LoadIndex,a.SpeedLevel,a.SpeedMax,a.Batch,a.HouseID,b.ID,b.ContainerID,b.Piece,b.InHouseTime,b.InCargoID,c.ContainerCode,c.AreaID from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID left join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID ";
                if (!entity.AreaID.Equals(0))
                {
                    strSQL += " left join Tbl_Cargo_Area as e on d.ParentID=e.AreaID left join Tbl_Cargo_Area as f on e.ParentID=f.AreaID ";
                }
                strSQL += " Where a.InCargoStatus='1'  ";//and d.AreaType='1'
                if (!entity.AreaID.Equals(0)) { strSQL += " and f.AreaID = " + entity.AreaID + ""; }
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode=@GoodsCode"; }
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName=@ProductName"; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=@TypeID "; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=@HouseID "; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex=@LoadIndex "; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel=@SpeedLevel"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model=@Model"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs=@Specs"; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure=@Figure"; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch=@Batch"; }
                if (!entity.BatchYear.Equals(0)) { strSQL += " and a.BatchYear=" + entity.BatchYear + ""; }
                strSQL += " order by a.BatchYear,a.BatchWeek asc ";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!string.IsNullOrEmpty(entity.GoodsCode))
                    {
                        conn.AddInParameter(cmd, "@GoodsCode", DbType.String, entity.GoodsCode);
                    }
                    if (!string.IsNullOrEmpty(entity.ProductName))
                    {
                        conn.AddInParameter(cmd, "@ProductName", DbType.String, entity.ProductName);
                    }
                    if (!entity.TypeID.Equals(0))
                    {
                        conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                    }
                    if (!entity.HouseID.Equals(0))
                    {
                        conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    }
                    if (!string.IsNullOrEmpty(entity.LoadIndex))
                    {
                        conn.AddInParameter(cmd, "@LoadIndex", DbType.String, entity.LoadIndex);
                    }
                    if (!string.IsNullOrEmpty(entity.SpeedLevel))
                    {
                        conn.AddInParameter(cmd, "@SpeedLevel", DbType.String, entity.SpeedLevel);
                    }
                    //型号
                    if (!string.IsNullOrEmpty(entity.Model))
                    {
                        conn.AddInParameter(cmd, "@Model", DbType.String, entity.Model);
                    }
                    //规格
                    if (!string.IsNullOrEmpty(entity.Specs))
                    {
                        conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs);
                    }
                    //花纹
                    if (!string.IsNullOrEmpty(entity.Figure))
                    {
                        conn.AddInParameter(cmd, "@Figure", DbType.String, entity.Figure);
                    }
                    if (!string.IsNullOrEmpty(entity.Batch))
                    {
                        conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);
                    }
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoInterfaceEntity
                            {
                                ContainerGoodsID = Convert.ToInt64(idrCount["ID"]),
                                ProductID = Convert.ToInt64(idrCount["ProductID"]),
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                ContainerID = Convert.ToInt32(idrCount["ContainerID"]),
                                TypeID = Convert.ToInt32(idrCount["TypeID"]),
                                ProductName = Convert.ToString(idrCount["ProductName"]).Trim(),
                                Model = Convert.ToString(idrCount["Model"]).Trim(),
                                GoodsCode = Convert.ToString(idrCount["GoodsCode"]).Trim(),
                                Specs = Convert.ToString(idrCount["Specs"]).Trim(),
                                Figure = Convert.ToString(idrCount["Figure"]).Trim(),
                                LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]).Trim(),
                                SpeedMax = Convert.ToInt32(idrCount["SpeedMax"]),
                                Batch = Convert.ToString(idrCount["Batch"]).Trim(),
                                ContainerCode = Convert.ToString(idrCount["ContainerCode"]).Trim(),
                                StockNum = Convert.ToInt32(idrCount["Piece"]),
                                InHouseTime = Convert.ToDateTime(idrCount["InHouseTime"]),
                                InCargoID = Convert.ToString(idrCount["InCargoID"]).Trim(),
                                AreaID = Convert.ToInt32(idrCount["AreaID"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoAPIMessage> queryOrderDataList(CargoOrderEntity entity)
        {
            CargoProductManager product = new CargoProductManager();
            CargoOrderManager man = new CargoOrderManager();
            List<CargoAPIMessage> result = new List<CargoAPIMessage>();
            string strSQL = "Select * from Tbl_Cargo_Order where (1=1)";

            //运单号 
            if (!string.IsNullOrEmpty(entity.LogisAwbNo))
            {
                strSQL += " and LogisAwbNo = '" + entity.LogisAwbNo.ToUpper().Trim() + "'";
            }
            else
            {
                //订单编号 
                if (!string.IsNullOrEmpty(entity.OrderNo))
                {
                    strSQL += " and OrderNo = '" + entity.OrderNo.ToUpper().Trim() + "'";
                    //strSQL += " and AwbStatus='0'";
                }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //收货单位,人
                if (!string.IsNullOrEmpty(entity.AcceptPeople))
                {
                    strSQL += " and (AcceptPeople like '%" + entity.AcceptPeople + "%' or AcceptUnit like '%" + entity.AcceptPeople + "%')";
                }
                //收货人电话
                if (!string.IsNullOrEmpty(entity.AcceptCellphone))
                {
                    strSQL += " and AcceptCellphone = '" + entity.AcceptCellphone + "'";
                }
            }
            //所属仓库ID
            if (!entity.HouseID.Equals(0)) { strSQL += " and HouseID =" + entity.HouseID + ""; }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        List<CargoOrderGoodsEntity> goods = man.QueryOrderGoodsInfo(new CargoOrderGoodsEntity
                        {
                            OrderNo = Convert.ToString(idr["OrderNo"])
                        });
                        List<CargoInterfaceEntity> interGoods = new List<CargoInterfaceEntity>();
                        if (goods.Count > 0)
                        {
                            foreach (var it in goods)
                            {
                                //CargoProductEntity productEnt = product.QueryProductInfoByID(it.ProductID);
                                interGoods.Add(new CargoInterfaceEntity
                                {
                                    OrderNo = Convert.ToString(idr["OrderNo"]),
                                    LogisAwbNo = Convert.ToString(idr["LogisAwbNo"]),
                                    HouseName = Convert.ToString(idr["OutHouseName"]),
                                    ProductID = it.ProductID,
                                    HouseID = it.HouseID,
                                    AreaID = it.AreaID,
                                    ContainerCode = it.ContainerCode,
                                    StockNum = it.Piece,
                                    Model = it.Model,//productEnt.Model,
                                    Specs = it.Specs,//productEnt.Specs,
                                    Figure = it.Figure,//productEnt.Figure,
                                    Batch = it.Batch,// productEnt.Batch,
                                    GoodsCode = it.GoodsCode,
                                    ProductName = it.ProductName,
                                    LoadIndex = it.LoadIndex,
                                    SpeedLevel = it.SpeedLevel,
                                    AreaName = it.AreaName,
                                    Source = "",//productEnt.Source,
                                    SourceName = "",//productEnt.SourceName,
                                    SourceCode = "",//productEnt.SourceCode,
                                    TypeID = it.TypeID,
                                    TypeName = it.TypeName,
                                    ScanNum = man.QueryOrderScanNum(new CargoProductTagEntity { OrderNo = Convert.ToString(idr["OrderNo"]), ContainerID = it.ContainerID, ProductID = it.ProductID })
                                });
                            }
                        }
                        #region 获取运单数据

                        result.Add(new CargoAPIMessage
                        {
                            OrderNo = Convert.ToString(idr["OrderNo"]),
                            Dep = Convert.ToString(idr["Dep"]),
                            Dest = Convert.ToString(idr["Dest"]),
                            Number = Convert.ToInt32(idr["Piece"]),
                            AcceptAddress = Convert.ToString(idr["AcceptAddress"]),
                            AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                            AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                            HLYAwbNo = Convert.ToString(idr["LogisAwbNo"]),
                            Result = interGoods.Count > 0 ? true : false,
                            cargoList = interGoods
                        });
                        #endregion
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 判断订单号是否存在
        /// </summary>
        /// <param name="OrderNo"></param>
        /// <returns></returns>
        public bool IsExistOrderInfo(string OrderNo)
        {
            string strSQL = "Select OrderNo from Tbl_Cargo_OrderGoods where OrderNo=@OrderNo";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmdQ, "@OrderNo", DbType.String, OrderNo);

                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 判断产品是否存在
        /// </summary>
        /// <param name="OrderNo"></param>
        /// <param name="ProductID"></param>
        /// <returns></returns>
        public bool IsExistOrderProductID(string OrderNo, long ProductID)
        {
            string strSQL = "Select OrderNo from Tbl_Cargo_OrderGoods where OrderNo=@OrderNo and ProductID=@ProductID";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmdQ, "@OrderNo", DbType.String, OrderNo);
                conn.AddInParameter(cmdQ, "@ProductID", DbType.Int64, ProductID);

                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 判断是否存在未出库的标签
        /// </summary>
        /// <param name="ProductID"></param>
        /// <param name="TagCode"></param>
        /// <returns></returns>
        public bool IsExistProductTag(long ProductID, string TagCode)
        {
            string strSQL = "Select OrderNo from Tbl_Cargo_ProductTag where TagCode=@TagCode and ProductID=@ProductID and OutCargoStatus='0'";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmdQ, "@TagCode", DbType.String, TagCode);
                conn.AddInParameter(cmdQ, "@ProductID", DbType.Int64, ProductID);

                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 设置标签为已出库
        /// </summary>
        /// <param name="ProductID"></param>
        /// <param name="TagCode"></param>
        public void SetProductTag(CargoProductTagEntity entity)
        {
            try
            {
                string strSQL = "Update Tbl_Cargo_ProductTag set OutCargoStatus=@OutCargoStatus,OutCargoOperID=@OutCargoOperID,OutCargoTime=@OutCargoTime";
                if (!string.IsNullOrEmpty(entity.OrderNo))
                {
                    strSQL += " ,OrderNo=@OrderNo ";
                }
                if (!string.IsNullOrEmpty(entity.MoveOrderNo))
                {
                    strSQL += " ,MoveOrderNo=@MoveOrderNo";
                }
                strSQL += " Where ProductID=@ProductID and TagCode=@TagCode";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!string.IsNullOrEmpty(entity.OrderNo))
                    {
                        conn.AddInParameter(cmd, "@OrderNo", DbType.String, entity.OrderNo);
                    }
                    if (!string.IsNullOrEmpty(entity.MoveOrderNo))
                    {
                        conn.AddInParameter(cmd, "@MoveOrderNo", DbType.String, entity.MoveOrderNo);
                    }
                    conn.AddInParameter(cmd, "@OutCargoStatus", DbType.String, entity.OutCargoStatus);
                    conn.AddInParameter(cmd, "@OutCargoOperID", DbType.String, entity.OutCargoOperID);
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.AddInParameter(cmd, "@OutCargoTime", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@TagCode", DbType.String, entity.TagCode);

                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void SetProductTagMove(CargoProductTagEntity entity)
        {
            try
            {
                string strSQL = "Update Tbl_Cargo_ProductTag set MoveOrderNo=@MoveOrderNo,MoveStatus=@MoveStatus Where ProductID=@ProductID and TagCode=@TagCode";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@MoveStatus", DbType.String, entity.MoveStatus);
                    conn.AddInParameter(cmd, "@MoveOrderNo", DbType.String, entity.MoveOrderNo);
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.AddInParameter(cmd, "@TagCode", DbType.String, entity.TagCode);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 判断是否超出订单数量
        /// </summary>
        /// <param name="entity"></param>
        public bool IsSetOutCargoOK(CargoProductTagEntity entity)
        {
            bool result = true;
            string strSQL = "select ProductID,OrderNo,Piece From Tbl_Cargo_OrderGoods where OrderNo=@OrderNo and ProductID=@ProductID";
            if (!string.IsNullOrEmpty(entity.ContainerCode)) { strSQL += " and ContainerCode='" + entity.ContainerCode + "'"; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmdQ, "@OrderNo", DbType.String, entity.OrderNo);
                conn.AddInParameter(cmdQ, "@ProductID", DbType.Int64, entity.ProductID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr.Rows.Count <= 0)
                    {
                        result = false;
                    }
                    else
                    {
                        int OrderNum = Convert.ToInt32(idr.Rows[0]["Piece"]);
                        int OutNum = GetOutCargoNum(entity) * entity.BundleNum;//出库的数量
                        if (OutNum >= OrderNum)
                        {
                            result = false;
                        }
                    }
                }
            }

            return result;
        }
        public int GetOutCargoNum(CargoProductTagEntity entity)
        {
            int OutNum = 0;
            string strSQL = "select COUNT(*) as OutNum From Tbl_Cargo_ProductTag where OutCargoStatus=1 ";
            if (!string.IsNullOrEmpty(entity.MoveOrderNo)) { strSQL += " and MoveOrderNo='" + entity.MoveOrderNo + "'"; }
            if (!string.IsNullOrEmpty(entity.OrderNo)) { strSQL += " and OrderNo='" + entity.OrderNo + "'"; }
            if (!entity.ProductID.Equals(0)) { strSQL += " and ProductID=" + entity.ProductID; }
            if (!entity.ContainerID.Equals(0)) { strSQL += " and ContainerID=" + entity.ContainerID; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                //conn.AddInParameter(cmdQ, "@OrderNo", DbType.String, entity.OrderNo);
                //conn.AddInParameter(cmdQ, "@ProductID", DbType.Int64, entity.ProductID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow it in idr.Rows)
                    {
                        OutNum = Convert.ToInt32(it["OutNum"]);
                    }
                }
            }
            return OutNum;
        }
        public int GetOutCargoNumByBundle(CargoProductTagEntity entity)
        {
            int OutNum = 0;
            string strSQL = "select SUM(ISNULL(c.BundleNum,1)) as OutNum From Tbl_Cargo_ProductTag as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID left join Tbl_Cargo_ProductSpec as c on b.ProductCode=c.ProductCode where (1=1) and a.OutCargoStatus=1 ";
            if (!string.IsNullOrEmpty(entity.MoveOrderNo)) { strSQL += " and a.MoveOrderNo='" + entity.MoveOrderNo + "'"; }
            if (!string.IsNullOrEmpty(entity.OrderNo)) { strSQL += " and a.OrderNo='" + entity.OrderNo + "'"; }
            if (!entity.ProductID.Equals(0)) { strSQL += " and a.ProductID=" + entity.ProductID; }
            if (!entity.ContainerID.Equals(0)) { strSQL += " and a.ContainerID=" + entity.ContainerID; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                //conn.AddInParameter(cmdQ, "@OrderNo", DbType.String, entity.OrderNo);
                //conn.AddInParameter(cmdQ, "@ProductID", DbType.Int64, entity.ProductID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow it in idr.Rows)
                    {
                        OutNum = Convert.ToInt32(it["OutNum"]);
                    }
                }
            }
            return OutNum;
        }
        /// <summary>
        /// 判断是否超出移库数量 
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsSetOutMoveCargoOK(CargoProductTagEntity entity)
        {
            bool result = true;
            string strSQL = "select ProductID,MoveNo,Piece From Tbl_Cargo_MoveOrderGood where MoveNo=@MoveNo and ProductID=@ProductID";
            if (!entity.ContainerID.Equals(0)) { strSQL += " and ContainerID=" + entity.ContainerID; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmdQ, "@MoveNo", DbType.String, entity.MoveOrderNo);
                conn.AddInParameter(cmdQ, "@ProductID", DbType.Int64, entity.ProductID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr.Rows.Count <= 0)
                    {
                        result = false;
                    }
                    else
                    {
                        int OrderNum = Convert.ToInt32(idr.Rows[0]["Piece"]);
                        int OutNum = GetMoveCargoNum(entity);
                        if (OutNum >= OrderNum)
                        {
                            result = false;
                        }
                    }
                }
            }

            return result;
        }
        public int GetMoveCargoNum(CargoProductTagEntity entity)
        {
            int OutNum = 0;
            string strSQL = "select COUNT(*) as OutNum From Tbl_Cargo_ProductTag where (1=1) ";
            if (!string.IsNullOrEmpty(entity.MoveOrderNo)) { strSQL += " and MoveOrderNo='" + entity.MoveOrderNo + "'"; }
            if (!string.IsNullOrEmpty(entity.OrderNo)) { strSQL += " and OrderNo='" + entity.OrderNo + "'"; }
            if (!entity.ProductID.Equals(0)) { strSQL += " and ProductID=" + entity.ProductID; }
            if (!entity.ContainerID.Equals(0)) { strSQL += " and ContainerID=" + entity.ContainerID; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                //conn.AddInParameter(cmdQ, "@OrderNo", DbType.String, entity.OrderNo);
                //conn.AddInParameter(cmdQ, "@ProductID", DbType.Int64, entity.ProductID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow it in idr.Rows)
                    {
                        OutNum = Convert.ToInt32(it["OutNum"]);
                    }
                }
            }
            return OutNum;
        }
        /// <summary>
        /// 查询一个订单关联的运单 号所有的订单列表
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoProductTagEntity> QueryScanOutCargoOrderList(CargoProductTagEntity entity)
        {
            List<CargoProductTagEntity> result = new List<CargoProductTagEntity>();
            string strSQL = "select a.OrderNo,a.LogisAwbNo,c.ProductID From Tbl_Cargo_Order as a inner join (select LogisAwbNo,HouseID From Tbl_Cargo_Order where OrderNo='" + entity.OrderNo + "') as b on a.LogisAwbNo=b.LogisAwbNo and a.HouseID=b.HouseID inner join Tbl_Cargo_OrderGoods as c on a.OrderNo=c.OrderNo and c.ProductID=" + entity.ProductID + "";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoProductTagEntity
                        {
                            OrderNo = Convert.ToString(idr["OrderNo"]),
                            LogisAwbNo = Convert.ToString(idr["LogisAwbNo"]),
                            ProductID = Convert.ToInt64(idr["ProductID"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询要移库的产品库存数据
        /// </summary>
        /// <param name="TagCodeList"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryOldContainerList(string TagCodeList)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            //string strSQL = "select b.*,a.MNum,c.ContainerCode from (select ProductID,ContainerID,COUNT(*) as MNum from Tbl_Cargo_ProductTag where TagCode in ('" + TagCodeList + "') group by ProductID,ContainerID) as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID and a.ContainerID=b.ContainerID left join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID";
            string strSQL = "select a.MoveOrderNo,a.MoveStatus,b.*,c.ContainerCode,d.HouseID from Tbl_Cargo_ProductTag as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID = b.ProductID and a.ContainerID = b.ContainerID inner join Tbl_Cargo_Product as d on b.ProductID = d.ProductID left join Tbl_Cargo_Container as c on b.ContainerID = c.ContainerID where a.TagCode = '" + TagCodeList + "'";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoContainerShowEntity
                        {
                            ID = Convert.ToInt64(idr["ID"]),
                            ContainerID = Convert.ToInt32(idr["ContainerID"]),
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            ProductID = Convert.ToInt64(idr["ProductID"]),
                            ContainerCode = Convert.ToString(idr["ContainerCode"]),
                            InCargoID = Convert.ToString(idr["InCargoID"]),
                            InPiece = Convert.ToInt32(idr["Piece"]),//在库数量
                            MoveOrderNo = Convert.ToString(idr["MoveOrderNo"]),
                            MoveStatus = Convert.ToString(idr["MoveOrderNo"]),
                            HouseID = Convert.ToInt32(idr["HouseID"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 修改标签所在货位ID
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateProductTagContainID(List<CargoProductTagEntity> entity)
        {
            foreach (var it in entity)
            {
                try
                {
                    string strSQL = "Update Tbl_Cargo_ProductTag set ContainerID=@ContainerID Where TagCode=@TagCode";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, it.ContainerID);
                        conn.AddInParameter(cmd, "@TagCode", DbType.String, it.TagCode);

                        conn.ExecuteNonQuery(cmd);
                    }
                }
                catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            }

        }
        /// <summary>
        /// 查询移库数据和已扫描的标签数量
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoMoveOrderGoodsEntity> QueryMoveOrderGoodsList(CargoMoveOrderEntity entity)
        {
            List<CargoMoveOrderGoodsEntity> result = new List<CargoMoveOrderGoodsEntity>();
            string strSQL = "select a.*,ISNULL( b.Mov,0) as ScanNum From (select MoveNo,ProductID,ContainerGoodsID,Piece,ContainerID From Tbl_Cargo_MoveOrderGood where (1=1) ";
            if (!string.IsNullOrEmpty(entity.MoveNo)) { strSQL += " and MoveNo='" + entity.MoveNo + "'"; }
            strSQL += ") as a left join (select ProductID,ContainerID,COUNT(*) as Mov From Tbl_Cargo_ProductTag where (1=1) ";
            if (!string.IsNullOrEmpty(entity.MoveNo)) { strSQL += " and MoveOrderNo='" + entity.MoveNo + "'"; }
            strSQL += "group by ProductID,ContainerID) as b on a.ProductID=b.ProductID and a.ContainerID=b.ContainerID ";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoMoveOrderGoodsEntity
                        {
                            MoveNo = Convert.ToString(idr["MoveNo"]),
                            ProductID = Convert.ToInt64(idr["ProductID"]),
                            ContainerGoodsID = Convert.ToInt64(idr["ContainerGoodsID"]),
                            ContainerID = Convert.ToInt32(idr["ContainerID"]),//在库数量
                            Piece = Convert.ToInt32(idr["Piece"]),
                            ScanNum = Convert.ToInt32(idr["ScanNum"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询养护品订单产品出库状态
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public int GetMaintenanceOrderProductOutCargoType(CargoProductTagEntity entity)
        {
            int OutCargoType = 0;
            string strSQL = "select OutCargoType From Tbl_Cargo_OrderGoods where (1=1) ";
            if (!string.IsNullOrEmpty(entity.OrderNo)) { strSQL += " and OrderNo='" + entity.OrderNo + "'"; }
            if (!entity.ProductID.Equals(0)) { strSQL += " and ProductID=" + entity.ProductID; }

            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                string type = conn.ExecuteScalar(cmdQ).ToString();

                if (!string.IsNullOrEmpty(type))
                {
                    OutCargoType = Convert.ToInt32(type);
                }
            }
            return OutCargoType;
        }
        /// <summary>
        /// 查询养护品订单是否出库完成
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool GetMaintenanceOrderOutCargoType(CargoProductTagEntity entity)
        {
            bool outType = true;
            string strSQL = "select OutCargoType From Tbl_Cargo_OrderGoods where (1=1) ";
            if (!string.IsNullOrEmpty(entity.OrderNo)) { strSQL += " and OrderNo='" + entity.OrderNo + "'"; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow it in idr.Rows)
                    {
                        if (string.IsNullOrEmpty(it["OutCargoType"].ToString()) || it["OutCargoType"].ToString() == "0")
                        {
                            outType = false;
                        }
                    }
                }
            }
            return outType;
        }
        /// <summary>
        /// 修改养护品产品出库状态
        /// </summary>
        /// <param name="OrderNo"></param>
        /// <param name="ProductID"></param>
        /// <param name="type"></param>
        public void UpdateMaintenanceProductOutCargoType(string OrderNo, string ProductID, bool type)
        {
            int OutCargoType = 0;
            if (type)
            {
                OutCargoType = 1;
            }
            string strSQL = "Update Tbl_Cargo_OrderGoods set OutCargoType=@OutCargoType Where OrderNo=@OrderNo and ProductID=@ProductID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@OutCargoType", DbType.Int32, OutCargoType);
                conn.AddInParameter(cmd, "@OrderNo", DbType.String, OrderNo);
                conn.AddInParameter(cmd, "@ProductID", DbType.String, ProductID);

                conn.ExecuteNonQuery(cmd);
            }
            strSQL = @"if((select count(*) num from Tbl_Cargo_OrderGoods where OrderNo=@OrderNo and OutCargoType=0)<=0)
                                begin
                                update Tbl_Cargo_Order set AwbStatus=2 where OrderNo=@OrderNo
                                end
                                else
                                begin
                                update Tbl_Cargo_Order set AwbStatus=1 where OrderNo=@OrderNo
                                end";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@OrderNo", DbType.String, OrderNo);

                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 查询养护品出库数量
        /// </summary>
        /// <param name="OrderNo"></param>
        /// <param name="ProductID"></param>
        /// <returns></returns>
        public int GetMaintenanceProductOutCargoNum(string OrderNo, string ProductID)
        {
            int OutNum = 0;
            string strSQL = "select sum(Piece) From Tbl_Cargo_OrderGoods where OrderNo='" + OrderNo + "' and ProductID=" + ProductID;
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                OutNum = Convert.ToInt32(conn.ExecuteScalar(cmdQ));
            }
            return OutNum;
        }

        public List<CargoProductOrderTagEntity> QueryProductOrderTagList(CargoProductOrderTagEntity entity)
        {
            List<CargoProductOrderTagEntity> result = new List<CargoProductOrderTagEntity>();
            string strSQL = "select a.OrderNo,a.TagCode,a.TyreCode,c.TypeName,b.TypeID,b.Specs,b.Figure,b.GoodsCode,b.SpeedLevel,b.LoadIndex,b.Batch,b.BatchYear,b.BatchWeek from Tbl_Cargo_ProductTag as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductType as c on b.TypeID=c.TypeID where (1=1)";
            if (!string.IsNullOrEmpty(entity.OrderNo)) { strSQL += " and a.OrderNo='" + entity.OrderNo + "'"; }
            if (!string.IsNullOrEmpty(entity.TagCode)) { strSQL += " and a.TagCode='" + entity.TagCode + "'"; }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoProductOrderTagEntity
                        {
                            OrderNo = Convert.ToString(idr["OrderNo"]),
                            TagCode = Convert.ToString(idr["TagCode"]),
                            TyreCode = Convert.ToString(idr["TyreCode"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            TypeID = Convert.ToInt32(idr["TypeID"]),//在库数量
                            Specs = Convert.ToString(idr["Specs"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            GoodsCode = Convert.ToString(idr["GoodsCode"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            Batch = Convert.ToString(idr["Batch"]),
                            BatchWeek = Convert.ToInt32(idr["BatchWeek"]),
                            BatchYear = Convert.ToInt32(idr["BatchYear"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 通过标签码和内侧码查询轮胎产品信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoProductEntity QueryProductInfoByTagCode(CargoProductEntity entity)
        {
            CargoProductEntity result = new CargoProductEntity();
            string strSQL = " select c.Name as HouseName,a.TagCode,a.TyreCode,a.InCargoStatus,a.InCargoOperID,a.InCargoTime,a.OutCargoStatus,a.OutCargoOperID,a.OutCargoTime,\r\n a.OrderNo,a.MoveOrderNo,e.TypeName,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,b.GoodsCode,b.Batch,d.AwbStatus,d.SignTime,d.Dep,d.Dest,d.AcceptUnit,d.ShopCode,d.OrderID,d.OutHouseName From Tbl_Cargo_ProductTag as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_House as c on b.HouseID=c.HouseID inner join Tbl_Cargo_ProductType as e on b.TypeID=e.TypeID  left join Tbl_Cargo_Order as d on a.OrderNo=d.OrderNo where a.TagCode='" + entity.TagCode + "'";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result = new CargoProductEntity
                        {
                            HouseName = Convert.ToString(idr["HouseName"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            SourceName = Convert.ToString(idr["OutHouseName"]),
                            SourceCode = Convert.ToString(idr["ShopCode"]),
                            FacID = string.IsNullOrEmpty(Convert.ToString(idr["OrderID"])) ? 0 : Convert.ToInt64(idr["OrderID"]),
                            OrderNo = Convert.ToString(idr["OrderNo"]),
                            SourceOrderNo = Convert.ToString(idr["MoveOrderNo"]),
                            TagCode = Convert.ToString(idr["TagCode"]),
                            TyreCode = Convert.ToString(idr["TyreCode"]),
                            //TypeID = Convert.ToInt32(idr["TypeID"]),//在库数量
                            Specs = Convert.ToString(idr["Specs"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            GoodsCode = Convert.ToString(idr["GoodsCode"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            Batch = Convert.ToString(idr["Batch"]),
                            InCargoStatus = Convert.ToString(idr["InCargoStatus"]),
                            InHouseTime = Convert.ToDateTime(idr["InCargoTime"]),
                            OutCargoStatus = Convert.ToString(idr["OutCargoStatus"]),
                            MoveStatus = Convert.ToString(idr["AwbStatus"]),
                            Supplier = Convert.ToString(idr["AcceptUnit"]),
                            Company = Convert.ToString(idr["Dest"]),
                            BelongDepart = Convert.ToString(idr["Dep"]),
                            EndDate = string.IsNullOrEmpty(Convert.ToString(idr["SignTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["SignTime"]),
                            StartDate = string.IsNullOrEmpty(Convert.ToString(idr["OutCargoTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["OutCargoTime"]),
                        };
                    }
                }
            }
            return result;
        }


        #endregion

        #region 推送新陆程接口信息
        /// <summary>
        /// 查询所有未推送的数据
        /// </summary>
        /// <returns></returns>
        public List<CargoNewayDataPush> QueryNewayDataPush()
        {
            List<CargoNewayDataPush> result = new List<CargoNewayDataPush>();
            SqlHelper neway = new SqlHelper("Neway");
            string strSQL = "Select * From Tbl_PushAwb Where PushStatus=0";
            using (DbCommand command = neway.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = neway.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoNewayDataPush
                        {
                            ID = Convert.ToInt64(idr["ID"]),
                            NwAwbNo = Convert.ToString(idr["NwAwbNo"]),
                            HlyAwbNo = Convert.ToString(idr["HlyAwbNo"]),
                            BelongSystem = Convert.ToString(idr["BelongSystem"]),
                            CurCity = Convert.ToString(idr["CurCity"]),
                            UserName = Convert.ToString(idr["UserName"]),
                            Remark = Convert.ToString(idr["Remark"]),
                            Status = Convert.ToString(idr["Status"]),
                            PushStatus = Convert.ToString(idr["PushStatus"]),
                            ShipperName = Convert.ToString(idr["ShipperName"]),
                            AcceptAddress = Convert.ToString(idr["AcceptAddress"]),
                            AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                            AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                            StartTime = Convert.ToDateTime(idr["StartTime"]),
                            Piece = Convert.ToInt32(idr["Piece"]),
                            Weight = Convert.ToDecimal(idr["Weight"]),
                            Dest = Convert.ToString(idr["Dest"]),
                            SplitCB = Convert.ToString(idr["SplitCB"]),
                            OPDATE = Convert.ToDateTime(idr["OPDATE"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 修改推送状态 
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateNewayDataPush(CargoNewayDataPush entity)
        {
            //使用新陆程 的数据库
            SqlHelper neway = new SqlHelper("Neway");
            string strSQL = @"UPDATE Tbl_PushAwb SET PushStatus=@PushStatus WHERE ID=@ID";
            entity.EnSafe();
            using (DbCommand cmd = neway.GetSqlStringCommond(strSQL))
            {
                neway.AddInParameter(cmd, "@PushStatus", DbType.String, entity.PushStatus);
                neway.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                neway.ExecuteNonQuery(cmd);
            }
        }
        #endregion

        #region 快递100订阅物流接口
        /// <summary>
        /// 查询新陆程中转未订阅数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<NWTransitEntity> QueryNwTransitList(NWTransitEntity entity)
        {
            SqlHelper neway = new SqlHelper("Neway");
            List<NWTransitEntity> result = new List<NWTransitEntity>();
            string strSQL = "select a.AssistNum,b.CarrierID,b.CarrierName,b.CarrierShortName,b.Email,a.TransitID From Tbl_TransitAwb as a inner join Tbl_Carrier as b on a.CarrierID=b.CarrierID where (1=1)";
            if (!string.IsNullOrEmpty(entity.PollStatus))
            {
                strSQL += " and a.PollStatus='" + entity.PollStatus + "'";
            }
            if (!string.IsNullOrEmpty(entity.BelongSystem))
            {
                strSQL += " and a.BelongSystem='" + entity.BelongSystem + "'";
            }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            using (DbCommand command = neway.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = neway.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        //只订阅京广速递和加运美速递
                        if (Convert.ToString(idr["Email"]).Equals("jiayunmeiwuliu") || Convert.ToString(idr["Email"]).Equals("jinguangsudikuaijian") || Convert.ToString(idr["Email"]).Equals("yimidida") || Convert.ToString(idr["Email"]).Equals("xinfengwuliu") || Convert.ToString(idr["Email"]).Equals("huisenky"))
                        {
                            result.Add(new NWTransitEntity
                            {
                                CarrierName = Convert.ToString(idr["CarrierName"]),
                                ComCode = Convert.ToString(idr["Email"]),
                                TransitNo = Convert.ToString(idr["AssistNum"]),
                                TransitID = Convert.ToInt64(idr["TransitID"])
                            });
                        }
                        //if (!Convert.ToString(idr["CarrierName"]).Equals("京广速递") && !Convert.ToString(idr["CarrierName"]).Equals("加运美速递") && !Convert.ToString(idr["CarrierName"]).Equals("壹米滴答") && !Convert.ToString(idr["CarrierName"]).Equals("信丰物流") && !Convert.ToString(idr["CarrierName"]).Equals("汇深速运")) { continue; }
                        //result.Add(new NWTransitEntity
                        //{
                        //    CarrierName = Convert.ToString(idr["CarrierName"]),
                        //    ComCode = Convert.ToString(idr["Email"]),
                        //    TransitNo = Convert.ToString(idr["AssistNum"]),
                        //    TransitID = Convert.ToInt64(idr["TransitID"])
                        //});
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 修改中转单号的订阅状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateNwTransitPollStatus(NWTransitEntity entity)
        {
            //使用新陆程 的数据库
            SqlHelper neway = new SqlHelper("Neway");
            string strSQL = @"UPDATE Tbl_TransitAwb SET PollStatus=@PollStatus WHERE TransitID=@TransitID";
            using (DbCommand cmd = neway.GetSqlStringCommond(strSQL))
            {
                neway.AddInParameter(cmd, "@PollStatus", DbType.String, entity.PollStatus);
                neway.AddInParameter(cmd, "@TransitID", DbType.Int64, entity.TransitID);
                neway.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 查询中转运单数据列表
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<NWTransitEntity> QueryTransitAwbList(NWTransitEntity entity)
        {
            SqlHelper neway = new SqlHelper("Neway");
            List<NWTransitEntity> result = new List<NWTransitEntity>();
            string strSQL = "select a.DeliveryID,a.AwbID,a.AwbNo,a.OP_ID,a.BelongSystem,b.AwbStatus from Tbl_DeliveryAwb as a inner join Tbl_Awb_Basic as b on a.AwbNo=b.AwbNo where a.DeliveryID=" + entity.TransitID + " and a.Mode=1";
            using (DbCommand command = neway.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = neway.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new NWTransitEntity
                        {
                            TransitID = Convert.ToInt64(idr["DeliveryID"]),
                            AwbID = Convert.ToInt64(idr["AwbID"]),
                            AwbNo = Convert.ToString(idr["AwbNo"]),
                            OPID = Convert.ToString(idr["OP_ID"]),
                            BelongSystem = Convert.ToString(idr["BelongSystem"]),
                            AwbStatus = Convert.ToString(idr["AwbStatus"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 插入运单状态
        /// </summary>
        /// <param name="entity"></param>
        public void SaveAwbStatus(CargoKD100Entity entity)
        {
            entity.EnSafe();
            SqlHelper neway = new SqlHelper("Neway");
            string strSQL = "Insert into Tbl_AwbStatusTruck (AwbNo,TruckFlag,CurrentLocation,ArriveTime,DetailInfo,OP_ID,OP_DATE,AwbID,Signer,BelongSystem) values (@AwbNo,@TruckFlag,@CurrentLocation,@ArriveTime,@DetailInfo,@OP_ID,@OP_DATE,@AwbID,@Signer,@BelongSystem)";
            using (DbCommand cmd = neway.GetSqlStringCommond(strSQL))
            {
                neway.AddInParameter(cmd, "@AwbNo", DbType.String, entity.AwbNo);
                neway.AddInParameter(cmd, "@TruckFlag", DbType.String, entity.TruckFlag);
                neway.AddInParameter(cmd, "@CurrentLocation", DbType.String, entity.CurrentLocation);
                neway.AddInParameter(cmd, "@ArriveTime", DbType.DateTime, entity.ArriveTime);
                neway.AddInParameter(cmd, "@DetailInfo", DbType.String, entity.DetailInfo);
                neway.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                neway.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                neway.AddInParameter(cmd, "@AwbID", DbType.Int64, entity.AwbID);
                neway.AddInParameter(cmd, "@Signer", DbType.String, entity.Signer);
                neway.AddInParameter(cmd, "@BelongSystem", DbType.String, entity.BelongSystem);
                neway.ExecuteNonQuery(cmd);
            }
            if (entity.TruckFlag.Equals("7"))
            {
                //如果是签收状态则修改运单状态为签收状态
                string strAwb = "Update Tbl_Awb_Basic set AwbStatus=@AwbStatus,Signer=@Signer,SignTime=@SignTime WHERE AwbID=@AwbID and BelongSystem=@BelongSystem";
                using (DbCommand cmdAdd = neway.GetSqlStringCommond(strAwb))
                {
                    //neway.AddInParameter(cmdAdd, "@AwbNo", DbType.String, entity.AwbNo);
                    neway.AddInParameter(cmdAdd, "@AwbStatus", DbType.String, entity.TruckFlag);
                    neway.AddInParameter(cmdAdd, "@Signer", DbType.String, entity.Signer);
                    neway.AddInParameter(cmdAdd, "@SignTime", DbType.DateTime, entity.ArriveTime);
                    neway.AddInParameter(cmdAdd, "@AwbID", DbType.Int64, entity.AwbID);
                    neway.AddInParameter(cmdAdd, "@BelongSystem", DbType.String, entity.BelongSystem);
                    neway.ExecuteNonQuery(cmdAdd);
                }
                string strArriveAwb = "Update Tbl_Awb_Arrive set AwbStatus=@AwbStatus,Signer=@Signer,SignTime=@SignTime WHERE AwbID=@AwbID and BelongSystem=@BelongSystem";
                using (DbCommand cmdArriveAdd = neway.GetSqlStringCommond(strArriveAwb))
                {
                    //neway.AddInParameter(cmdAdd, "@AwbNo", DbType.String, entity.AwbNo);
                    neway.AddInParameter(cmdArriveAdd, "@AwbStatus", DbType.String, entity.TruckFlag);
                    neway.AddInParameter(cmdArriveAdd, "@Signer", DbType.String, entity.Signer);
                    neway.AddInParameter(cmdArriveAdd, "@SignTime", DbType.DateTime, entity.ArriveTime);
                    neway.AddInParameter(cmdArriveAdd, "@AwbID", DbType.Int64, entity.AwbID);
                    neway.AddInParameter(cmdArriveAdd, "@BelongSystem", DbType.String, entity.BelongSystem);
                    neway.ExecuteNonQuery(cmdArriveAdd);
                }
            }
        }
        #endregion

        #region 马牌订单系统数据接口
        public Hashtable QueryContiOrder(int pIndex, int pNum, saleOpenInfoResp entity)
        {
            List<saleOpenInfoResp> result = new List<saleOpenInfoResp>();
            Hashtable resHT = new Hashtable();
            try
            {
                #region 获取订单明细
                string strSQL = @" SELECT TOP " + pNum + "* FROM (SELECT DISTINCT ROW_NUMBER() OVER(ORDER BY a.InCreateStatus asc,a.OPDATE DESC) AS RowNumber,a.*,b.Name as HouseName from dbo.Tbl_Cargo_ContiOrder as a inner join tbl_Cargo_house as b on a.HouseID=b.HouseID WHERE (1=1)";


                if (!string.IsNullOrEmpty(entity.orderType)) { strSQL += "and a.orderType='" + entity.orderType + "'"; }
                if (!string.IsNullOrEmpty(entity.orderLabel)) { strSQL += "and a.orderLabel='" + entity.orderLabel + "'"; }
                if (!string.IsNullOrEmpty(entity.InCreateStatus)) { strSQL += "and a.InCreateStatus='" + entity.InCreateStatus + "'"; }
                //所属仓库ID
                //if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.orderCode)) { strSQL += " and a.orderCode like '%" + entity.orderCode + "%'"; }

                if (!string.IsNullOrEmpty(entity.consigneeName)) { strSQL += " and a.consigneeName like '%" + entity.consigneeName + "%'"; }
                if (!string.IsNullOrEmpty(entity.customerName)) { strSQL += " and a.customerName like '%" + entity.customerName + "%'"; }

                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OPDATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OPDATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += ") as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))  order by RowNumber";
                #endregion

                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    #region 获取数据
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new saleOpenInfoResp
                            {
                                OrderID = Convert.ToInt64(idr["OrderID"]),
                                orderCode = Convert.ToString(idr["orderCode"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                orderSource = Convert.ToString(idr["orderSource"]),
                                orderType = Convert.ToString(idr["orderType"]),
                                orderLabel = Convert.ToString(idr["orderLabel"]),
                                nowTotalAmount = Convert.ToDecimal(idr["nowTotalAmount"]),
                                rebateAmount = Convert.ToDecimal(idr["rebateAmount"]),
                                onlinePaidAmount = Convert.ToDecimal(idr["onlinePaidAmount"]),
                                creditAmount = Convert.ToDecimal(idr["creditAmount"]),
                                couponAmount = Convert.ToDecimal(idr["couponAmount"]),
                                freightAmount = Convert.ToString(idr["freightAmount"]),
                                OrderPiece = Convert.ToInt32(idr["OrderPiece"]),
                                orderLabelStr = Convert.ToString(idr["orderLabelStr"]),
                                deliveryType = Convert.ToString(idr["deliveryType"]),
                                deliveryTypeDesc = Convert.ToString(idr["deliveryTypeDesc"]),
                                customerName = Convert.ToString(idr["customerName"]),
                                customerCode = Convert.ToString(idr["customerCode"]),
                                customerSubCode = Convert.ToString(idr["customerSubCode"]),
                                orderStatus = Convert.ToString(idr["orderStatus"]),
                                //LoadSpeed = Convert.ToString(idr["LoadIndex"]) + Convert.ToString(idr["SpeedLevel"]),
                                orderStatusStr = Convert.ToString(idr["orderStatusStr"]),
                                sellerName = Convert.ToString(idr["sellerName"]),
                                warehouseName = Convert.ToString(idr["warehouseName"]),
                                warehouseCode = Convert.ToString(idr["warehouseCode"]),
                                submitTime = Convert.ToDateTime(idr["submitTime"]).ToString("yyyy-MM-dd HH:mm:ss"),

                                deliveryTime = Convert.ToString(idr["deliveryTime"]),
                                remark = Convert.ToString(idr["remark"]),
                                consigneeAddress = Convert.ToString(idr["consigneeAddress"]),
                                consigneeName = Convert.ToString(idr["consigneeName"]),
                                consigneeMobile = Convert.ToString(idr["consigneeMobile"]),
                                distributorSoldTo = Convert.ToString(idr["distributorSoldTo"]),
                                OPDATE = Convert.ToDateTime(idr["OPDATE"]),
                                BidClientNum = string.IsNullOrEmpty(Convert.ToString(idr["BidClientNum"])) ? 0 : Convert.ToInt32(idr["BidClientNum"]),
                                BidClientName = Convert.ToString(idr["BidClientName"]),
                                ClientNum = string.IsNullOrEmpty(Convert.ToString(idr["ClientNum"])) ? 0 : Convert.ToInt32(idr["ClientNum"]),
                                InCreateStatus = Convert.ToString(idr["InCreateStatus"]),
                                CreateAwbID = Convert.ToString(idr["CreateAwbID"]),
                                CreateAwb = Convert.ToString(idr["CreateAwb"]),
                                CreateDate = string.IsNullOrEmpty(Convert.ToString(idr["CreateDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["CreateDate"]),
                                CargoOrderNo = Convert.ToString(idr["CargoOrderNo"]),
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                naCustomerName = Convert.ToString(idr["naCustomerName"]),
                            });
                        }
                    }
                    #endregion
                }
                resHT["rows"] = result;
                #region 获取总数
                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_ContiOrder as a  Where (1=1)";

                if (!string.IsNullOrEmpty(entity.orderLabel)) { strCount += "and a.orderLabel='" + entity.orderLabel + "'"; }
                if (!string.IsNullOrEmpty(entity.orderType)) { strCount += "and a.orderType='" + entity.orderType + "'"; }
                if (!string.IsNullOrEmpty(entity.InCreateStatus)) { strCount += "and a.InCreateStatus='" + entity.InCreateStatus + "'"; }
                //所属仓库ID
                //if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.orderCode)) { strCount += " and a.orderCode like '%" + entity.orderCode + "%'"; }

                if (!string.IsNullOrEmpty(entity.consigneeName)) { strCount += " and a.consigneeName like '%" + entity.consigneeName + "%'"; }
                if (!string.IsNullOrEmpty(entity.customerName)) { strCount += " and a.customerName like '%" + entity.customerName + "%'"; }

                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.OPDATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.OPDATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
                #endregion
            }
            catch (Exception ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return resHT;
        }
        /// <summary>
        /// 根据订单ID查询订单明细
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<saleSkuOpenInfoResp> QueryContiOrderGoods(saleSkuOpenInfoResp entity)
        {
            List<saleSkuOpenInfoResp> result = new List<saleSkuOpenInfoResp>();
            string strSQL = $@"select a.*, b.couponAmount,b.nowTotalAmount,b.rebateAmount
                                from Tbl_Cargo_ContiOrderGoods as a
                                inner join  Tbl_Cargo_ContiOrder as b on a.OrderID=b.OrderID where (1=1)";
            if (!entity.OrderID.Equals(0)) { strSQL += " and b.OrderID=" + entity.OrderID; }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new saleSkuOpenInfoResp
                        {
                            skuName = Convert.ToString(idrCount["skuName"]),
                            GoodsID = Convert.ToInt64(idrCount["GoodsID"]),
                            OrderID = Convert.ToInt64(idrCount["OrderID"]),
                            skuCode = Convert.ToString(idrCount["skuCode"]),
                            skuNum = Convert.ToInt32(idrCount["skuNum"]),
                            totalCouponAmount = Convert.ToDecimal(idrCount["couponAmount"]),
                            nowTotalAmount = Convert.ToDecimal(idrCount["nowTotalAmount"]),
                            nowUnitPrice = Convert.ToDecimal(idrCount["nowUnitPrice"]),
                            rebateAmount = Convert.ToDecimal(idrCount["rebateAmount"]),
                        });
                    }
                }
            }
            //计算含税净价
            var totalPrice = Math.Round(result.Sum(a => a.nowUnitPrice), 2);//总含税单价
            var index = 1;
            foreach (var item in result)
            {
                if (item.totalCouponAmount >= 0)
                {
                    //((含税原价 * 销售数量)/商品金额总计)*总优惠卷 
                    item.couponAmount = Math.Round(((item.nowUnitPrice * Convert.ToDecimal(item.skuNum)) / item.nowTotalAmount) * item.totalCouponAmount, 2);
                    //((485*4)/2888)*68
                    //含税原价-(当行优惠卷金额/销售数量)
                    item.netUnitPrice = Math.Round(item.nowUnitPrice - (item.couponAmount / Convert.ToDecimal(item.skuNum)), 2);
                }
                else
                    item.netUnitPrice = item.nowUnitPrice;

                //补尾差
                if (index >= result.Count && item.totalCouponAmount >= 0)
                {
                    var couponAmount = result.Sum(a => a.couponAmount);
                    item.couponAmount = item.couponAmount + (item.totalCouponAmount - couponAmount);
                    item.netUnitPrice = Math.Round(item.nowUnitPrice - (item.couponAmount / Convert.ToDecimal(item.skuNum)), 2);
                }
                item.netAmount = item.netUnitPrice * Convert.ToDecimal(item.skuNum);
                index++;
            }
            return result;
        }

        /// <summary>
        /// 查询马牌订单数据
        /// </summary>
        /// <returns></returns>
        public saleOpenInfoResp QueryContiOrderEntity(saleOpenInfoResp entity)
        {
            saleOpenInfoResp result = new saleOpenInfoResp();
            string strSQL = "select * from Tbl_Cargo_ContiOrder as a  where (1=1)";
            if (!entity.OrderID.Equals(0)) { strSQL += " and a.OrderID=" + entity.OrderID; }
            strSQL += " order by OPDATE desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result = new saleOpenInfoResp
                        {
                            OrderID = Convert.ToInt64(idr["OrderID"]),
                            orderCode = Convert.ToString(idr["orderCode"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            orderSource = Convert.ToString(idr["orderSource"]),
                            orderType = Convert.ToString(idr["orderType"]),
                            orderLabel = Convert.ToString(idr["orderLabel"]),
                            nowTotalAmount = Convert.ToDecimal(idr["nowTotalAmount"]),
                            rebateAmount = Convert.ToDecimal(idr["rebateAmount"]),
                            onlinePaidAmount = Convert.ToDecimal(idr["onlinePaidAmount"]),
                            creditAmount = Convert.ToDecimal(idr["creditAmount"]),
                            couponAmount = Convert.ToDecimal(idr["couponAmount"]),
                            freightAmount = Convert.ToString(idr["freightAmount"]),
                            OrderPiece = Convert.ToInt32(idr["OrderPiece"]),
                            orderLabelStr = Convert.ToString(idr["orderLabelStr"]),
                            deliveryType = Convert.ToString(idr["deliveryType"]),
                            deliveryTypeDesc = Convert.ToString(idr["deliveryTypeDesc"]),
                            customerName = Convert.ToString(idr["customerName"]),
                            customerCode = Convert.ToString(idr["customerCode"]),
                            customerSubCode = Convert.ToString(idr["customerSubCode"]),
                            orderStatus = Convert.ToString(idr["orderStatus"]),
                            //LoadSpeed = Convert.ToString(idr["LoadIndex"]) + Convert.ToString(idr["SpeedLevel"]),
                            orderStatusStr = Convert.ToString(idr["orderStatusStr"]),
                            sellerName = Convert.ToString(idr["sellerName"]),
                            warehouseName = Convert.ToString(idr["warehouseName"]),
                            warehouseCode = Convert.ToString(idr["warehouseCode"]),
                            submitTime = Convert.ToDateTime(idr["submitTime"]).ToString("yyyy-MM-dd HH:mm:ss"),
                            deliveryTime = Convert.ToString(idr["deliveryTime"]),
                            remark = Convert.ToString(idr["remark"]),
                            consigneeAddress = Convert.ToString(idr["consigneeAddress"]),
                            consigneeName = Convert.ToString(idr["consigneeName"]),
                            consigneeMobile = Convert.ToString(idr["consigneeMobile"]),
                            distributorSoldTo = Convert.ToString(idr["distributorSoldTo"]),
                            OPDATE = Convert.ToDateTime(idr["OPDATE"]),
                            BidClientNum = string.IsNullOrEmpty(Convert.ToString(idr["BidClientNum"])) ? 0 : Convert.ToInt32(idr["BidClientNum"]),
                            BidClientName = Convert.ToString(idr["BidClientName"]),
                            ClientNum = string.IsNullOrEmpty(Convert.ToString(idr["ClientNum"])) ? 0 : Convert.ToInt32(idr["ClientNum"]),
                            InCreateStatus = Convert.ToString(idr["InCreateStatus"]),
                            CreateAwbID = Convert.ToString(idr["CreateAwbID"]),
                            CreateAwb = Convert.ToString(idr["CreateAwb"]),
                            CreateDate = string.IsNullOrEmpty(Convert.ToString(idr["CreateDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["CreateDate"]),
                            CargoOrderNo = Convert.ToString(idr["CargoOrderNo"]),
                            //HouseName = Convert.ToString(idr["HouseName"]),
                        };

                    }
                }
            }
            return result;
        }

        /// <summary>
        /// 删除马牌订单数据
        /// </summary>
        /// <param name="entity"></param>
        public void DelContiOrder(saleOpenInfoResp entity)
        {
            string strSQL = @"DELETE FROM Tbl_Cargo_ContiOrder Where OrderID=@OrderID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@OrderID", DbType.Int64, entity.OrderID);
                conn.ExecuteNonQuery(cmd);
            }

            DelContiOrderGoods(entity);
        }

        private void DelContiOrderGoods(saleOpenInfoResp entity)
        {
            string strSQL = @"DELETE FROM Tbl_Cargo_ContiOrderGoods Where OrderID=@OrderID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@OrderID", DbType.Int64, entity.OrderID);
                conn.ExecuteNonQuery(cmd);
            }
        }

        /// <summary>
        /// 判断 是否存在产品订单，如果存在则不允许新增
        /// </summary>
        /// <param name="entity">订单号</param>
        /// <returns>True：已经存在订单 False：不存在</returns>
        public bool IsExistContiSaleOrder(saleOpenInfoResp entity)
        {
            string strSQL = "Select OrderID from Tbl_Cargo_ContiOrder where orderCode=@orderCode";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmdQ, "@orderCode", DbType.String, entity.orderCode);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 新增马牌订单数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddContiSaleOrderInfo(saleOpenInfoResp entity)
        {
            Int64 did = 0;
            string strSQL = @"INSERT INTO Tbl_Cargo_ContiOrder(orderCode,orderSource,orderType,orderLabel,orderLabelStr,deliveryType,deliveryTypeDesc,customerCode,customerName,customerSubCode,sellerName,creditAmount,rebateAmount,nowTotalAmount,freightAmount,submitTime,remark,consigneeAddress,consigneeName,consigneeMobile,distributorSoldTo,warehouseCode,warehouseName,OPDATE,orderStatus,orderStatusStr,onlinePaidAmount,BidClientNum,BidClientName,HouseID,InCreateStatus,AreaID,OrderPiece,couponAmount,naCustomerName) VALUES (@orderCode,@orderSource,@orderType,@orderLabel,@orderLabelStr,@deliveryType,@deliveryTypeDesc,@customerCode,@customerName,@customerSubCode,@sellerName,@creditAmount,@rebateAmount,@nowTotalAmount,@freightAmount,@submitTime,@remark,@consigneeAddress,@consigneeName,@consigneeMobile,@distributorSoldTo,@warehouseCode,@warehouseName,@OPDATE,@orderStatus,@orderStatusStr,@onlinePaidAmount,@BidClientNum,@BidClientName,@HouseID,@InCreateStatus,@AreaID,@OrderPiece,@couponAmount,@naCustomerName) SELECT @@IDENTITY";
            try
            {
                #region 订单保存
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@orderStatus", DbType.String, entity.orderStatus);
                    conn.AddInParameter(cmd, "@orderStatusStr", DbType.String, entity.orderStatusStr);
                    conn.AddInParameter(cmd, "@orderCode", DbType.String, entity.orderCode);
                    conn.AddInParameter(cmd, "@orderSource", DbType.String, entity.orderSource);
                    conn.AddInParameter(cmd, "@orderLabel", DbType.String, entity.orderLabel);
                    conn.AddInParameter(cmd, "@orderLabelStr", DbType.String, entity.orderLabelStr);
                    conn.AddInParameter(cmd, "@orderType", DbType.String, entity.orderType);
                    conn.AddInParameter(cmd, "@deliveryType", DbType.String, entity.deliveryType);
                    conn.AddInParameter(cmd, "@deliveryTypeDesc", DbType.String, entity.deliveryTypeDesc);
                    conn.AddInParameter(cmd, "@customerCode", DbType.String, entity.customerCode);
                    conn.AddInParameter(cmd, "@customerName", DbType.String, entity.customerName);
                    conn.AddInParameter(cmd, "@customerSubCode", DbType.String, entity.customerSubCode);
                    conn.AddInParameter(cmd, "@sellerName", DbType.String, entity.sellerName);
                    conn.AddInParameter(cmd, "@creditAmount", DbType.Decimal, entity.creditAmount);
                    conn.AddInParameter(cmd, "@rebateAmount", DbType.Decimal, entity.rebateAmount);
                    conn.AddInParameter(cmd, "@nowTotalAmount", DbType.Decimal, entity.nowTotalAmount);
                    conn.AddInParameter(cmd, "@freightAmount", DbType.Decimal, entity.freightAmount);
                    conn.AddInParameter(cmd, "@onlinePaidAmount", DbType.Decimal, entity.onlinePaidAmount);
                    conn.AddInParameter(cmd, "@couponAmount", DbType.Decimal, entity.couponAmount);

                    conn.AddInParameter(cmd, "@remark", DbType.String, entity.remark);
                    conn.AddInParameter(cmd, "@consigneeAddress", DbType.String, entity.consigneeAddress);
                    conn.AddInParameter(cmd, "@consigneeName", DbType.String, entity.consigneeName);
                    conn.AddInParameter(cmd, "@consigneeMobile", DbType.String, entity.consigneeMobile);
                    conn.AddInParameter(cmd, "@distributorSoldTo", DbType.String, entity.distributorSoldTo);
                    conn.AddInParameter(cmd, "@warehouseCode", DbType.String, entity.warehouseCode);
                    conn.AddInParameter(cmd, "@warehouseName", DbType.String, entity.warehouseName);
                    conn.AddInParameter(cmd, "@submitTime", DbType.DateTime, entity.submitTime);
                    //conn.AddInParameter(cmd, "@shippingTime", DbType.DateTime, entity.shippingTime);
                    conn.AddInParameter(cmd, "@OPDATE", DbType.DateTime, DateTime.Now);

                    conn.AddInParameter(cmd, "@BidClientNum", DbType.Int32, entity.BidClientNum);
                    conn.AddInParameter(cmd, "@BidClientName", DbType.String, entity.BidClientName);
                    //conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID);
                    conn.AddInParameter(cmd, "@OrderPiece", DbType.Int32, entity.OrderPiece);
                    conn.AddInParameter(cmd, "@InCreateStatus", DbType.String, entity.InCreateStatus);
                    conn.AddInParameter(cmd, "@naCustomerName", DbType.String, entity.naCustomerName);
                    //conn.AddInParameter(cmd, "@CreateAwbID", DbType.String, entity.CreateAwbID);
                    //conn.AddInParameter(cmd, "@CreateAwb", DbType.String, entity.CreateAwb);
                    //conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, entity.CreateDate);
                    //conn.AddInParameter(cmd, "@CargoOrderNo", DbType.String, entity.CargoOrderNo);

                    did = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
                #endregion

                //新增产品与订单关联数据
                AddContiOrderSKUInfo(entity.saleSkuOpenInfoResp, did);
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }
        /// <summary>
        /// 修改订单开单状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateContiOrderCreateData(saleOpenInfoResp entity)
        {
            string strSQL = "Update Tbl_Cargo_ContiOrder set ClientNum=@ClientNum,InCreateStatus=@InCreateStatus,CreateAwbID=@CreateAwbID,CreateAwb=@CreateAwb,CreateDate=@CreateDate,CargoOrderNo=@CargoOrderNo where orderCode=@orderCode";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                conn.AddInParameter(cmd, "@InCreateStatus", DbType.String, entity.InCreateStatus);
                conn.AddInParameter(cmd, "@CreateAwbID", DbType.String, entity.CreateAwbID);
                conn.AddInParameter(cmd, "@CreateAwb", DbType.String, entity.CreateAwb);
                conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, entity.CreateDate);
                conn.AddInParameter(cmd, "@CargoOrderNo", DbType.String, entity.CargoOrderNo);
                //conn.AddInParameter(cmd, "@OrderID", DbType.Int64, entity.OrderID);
                conn.AddInParameter(cmd, "@orderCode", DbType.String, entity.orderCode);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改订单开单状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCassMallOrderCreateData(saleOpenInfoResp entity)
        {
            string strSQL = "Update Tbl_Cargo_CassMallOrder set ClientNum=@ClientNum,InCreateStatus=@InCreateStatus,CreateAwbID=@CreateAwbID,CreateAwb=@CreateAwb,CreateDate=@CreateDate,CargoOrderNo=@CargoOrderNo where orderId=@orderCode";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                conn.AddInParameter(cmd, "@InCreateStatus", DbType.String, entity.InCreateStatus);
                conn.AddInParameter(cmd, "@CreateAwbID", DbType.String, entity.CreateAwbID);
                conn.AddInParameter(cmd, "@CreateAwb", DbType.String, entity.CreateAwb);
                conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, entity.CreateDate);
                conn.AddInParameter(cmd, "@CargoOrderNo", DbType.String, entity.CargoOrderNo);
                //conn.AddInParameter(cmd, "@OrderID", DbType.Int64, entity.OrderID);
                conn.AddInParameter(cmd, "@orderCode", DbType.String, entity.orderCode);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改马牌订单发货状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateContiOrderStatus(saleOpenInfoResp entity)
        {
            string strSQL = "Update Tbl_Cargo_ContiOrder set orderStatus=@orderStatus where orderCode=@orderCode";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@orderStatus", DbType.String, entity.orderStatus);
                conn.AddInParameter(cmd, "@orderCode", DbType.String, entity.orderCode);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改马牌订单出库单数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateContiOrderOutData(saleOpenInfoResp entity)
        {
            string strSQL = "Update Tbl_Cargo_ContiOrder set doNo=@doNo,shippingCode=@shippingCode where orderCode=@orderCode";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@doNo", DbType.String, entity.doNo);
                conn.AddInParameter(cmd, "@shippingCode", DbType.String, entity.shippingCode);
                conn.AddInParameter(cmd, "@orderCode", DbType.String, entity.orderCode);
                conn.ExecuteNonQuery(cmd);
            }

        }
        public void UpdateContiOutOrderPushStatus(saleOpenInfoResp entity)
        {
            string strSQL = "Update Tbl_Cargo_ContiOrder set IsPushOutTag=@IsPushOutTag where orderCode=@orderCode";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@IsPushOutTag", DbType.String, entity.IsPushOutTag);
                conn.AddInParameter(cmd, "@orderCode", DbType.String, entity.orderCode);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 保存接口推送数据
        /// </summary>
        /// <param name="entity"></param>
        /// <exception cref="ApplicationException"></exception>
        public void AddContiOrderPushInfo(saleOrderStatusOpenQueryResp entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_ContiOrderPush(currentUpdateTime,nextUpdateTime,tenantId,companyId,ResJson) VALUES (@currentUpdateTime,@nextUpdateTime,@tenantId,@companyId,@ResJson)";
            #region 订单保存
            //entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@currentUpdateTime", DbType.DateTime, Convert.ToDateTime(entity.currentUpdateTime));
                conn.AddInParameter(cmd, "@nextUpdateTime", DbType.DateTime, Convert.ToDateTime(entity.nextUpdateTime));
                conn.AddInParameter(cmd, "@tenantId", DbType.Int64, entity.tenantId);
                conn.AddInParameter(cmd, "@companyId", DbType.Int64, entity.companyId);
                conn.AddInParameter(cmd, "@ResJson", DbType.String, entity.ResJson);
                conn.ExecuteNonQuery(cmd);
            }
            #endregion

        }
        /// <summary>
        /// 查询最新一条数据
        /// </summary>
        /// <returns></returns>
        public saleOrderStatusOpenQueryResp QuerySaleOrderStatusOpenData(saleOrderStatusOpenQueryResp entity)
        {
            saleOrderStatusOpenQueryResp result = new saleOrderStatusOpenQueryResp();
            string strSQL = "select top 1 * from Tbl_Cargo_ContiOrderPush where (1=1)";
            if (!entity.CID.Equals(0)) { strSQL += " and CID=" + entity.CID; }
            if (!entity.companyId.Equals(0)) { strSQL += " and companyId=" + entity.companyId; }
            strSQL += " order by OPDATE desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result = new saleOrderStatusOpenQueryResp
                        {
                            CID = Convert.ToInt64(idrCount["CID"]),
                            currentUpdateTime = Convert.ToDateTime(idrCount["currentUpdateTime"]).ToString("yyyy-MM-dd HH:mm:ss"),
                            nextUpdateTime = Convert.ToDateTime(idrCount["nextUpdateTime"]).ToString("yyyy-MM-dd HH:mm:ss"),
                            tenantId = Convert.ToInt64(idrCount["tenantId"]),
                            companyId = Convert.ToInt64(idrCount["companyId"]),
                            ResJson = Convert.ToString(idrCount["ResJson"])
                        };

                    }
                }
            }
            return result;
        }


        /// <summary>
        /// 新增订单与产品关联表数据
        /// </summary>
        /// <param name="goods"></param>
        public void AddContiOrderSKUInfo(List<saleSkuOpenInfoResp> goods, long OrderID)
        {
            foreach (var it in goods)
            {
                it.EnSafe();
                string strSQL = @"INSERT INTO Tbl_Cargo_ContiOrderGoods(OrderID,skuName,skuCode,skuNum,nowUnitPrice,originalUnitPrice) VALUES  (@OrderID,@skuName,@skuCode,@skuNum,@nowUnitPrice,@originalUnitPrice)";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@skuName", DbType.String, it.skuName);
                    conn.AddInParameter(cmd, "@OrderID", DbType.Int64, OrderID);
                    conn.AddInParameter(cmd, "@skuCode", DbType.String, it.skuCode);
                    conn.AddInParameter(cmd, "@skuNum", DbType.Int32, it.skuNum);
                    conn.AddInParameter(cmd, "@nowUnitPrice", DbType.Decimal, it.nowUnitPrice);
                    conn.AddInParameter(cmd, "@originalUnitPrice", DbType.Decimal, it.originalUnitPrice);
                    conn.ExecuteNonQuery(cmd);
                }
            }
        }
        /// <summary>
        /// 查询东莞仓，深圳仓和揭阳仓马牌 维京库存数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoSafeStockEntity> QueryContiStockData(CargoSafeStockEntity entity)
        {
            List<CargoSafeStockEntity> result = new List<CargoSafeStockEntity>();
            string strSQL = "select b.GoodsCode,a.TypeID,f.AreaID,b.Batch,SUM(a.Piece) as Stock From Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID and a.TypeID=b.TypeID and a.TypeID in (34,345) and b.IsLockStock=0 and a.Piece>0 and b.OperaType=1 ";
            if (!string.IsNullOrEmpty(entity.HouseID))
            {
                strSQL += " and b.HouseID=" + Convert.ToInt32(entity.HouseID);
            }
            if (!string.IsNullOrEmpty(entity.HouseIDStr))
            {
                strSQL += " and b.HouseID in (" + entity.HouseIDStr + ")";
            }
            if (!string.IsNullOrEmpty(entity.GoodsCode))
            {
                strSQL += " and b.GoodsCode in ('" + entity.GoodsCode + "')";
            }

            //and a.Piece>0
            strSQL += " inner join Tbl_Cargo_Container as c on a.ContainerID=c.ContainerID inner join Tbl_Cargo_Area as d on c.AreaID=d.AreaID inner join Tbl_Cargo_Area as e on d.ParentID=e.AreaID inner join Tbl_Cargo_Area f on e.ParentID=f.AreaID where a.OP_DATE>='2023-01-01' group by b.GoodsCode,a.TypeID,f.AreaID,b.Batch order by f.AreaID,a.TypeID,b.GoodsCode asc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoSafeStockEntity
                        {
                            GoodsCode = Convert.ToString(idrCount["GoodsCode"]),
                            TypeID = Convert.ToInt32(idrCount["TypeID"]),
                            AreaID = Convert.ToInt32(idrCount["AreaID"]),
                            Batch = Convert.ToString(idrCount["Batch"]),
                            StockNum = Convert.ToInt32(idrCount["Stock"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询广州仓马牌维京库存数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoSafeStockEntity> QueryGZContiStockData(CargoSafeStockEntity entity)
        {
            List<CargoSafeStockEntity> result = new List<CargoSafeStockEntity>();
            string strSQL = "select b.GoodsCode,a.TypeID,b.Batch,sum(a.Piece) as Stock From Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID and a.TypeID=b.TypeID and a.TypeID in (34,345) and b.IsLockStock=0 and a.Piece>0 and b.OperaType=1 ";
            if (!string.IsNullOrEmpty(entity.HouseID))
            {
                strSQL += " and b.HouseID=" + Convert.ToInt32(entity.HouseID);
            }
            if (!string.IsNullOrEmpty(entity.HouseIDStr))
            {
                strSQL += " and b.HouseID in (" + entity.HouseIDStr + ")";
            }
            if (!string.IsNullOrEmpty(entity.GoodsCode))
            {
                strSQL += " and b.GoodsCode in ('" + entity.GoodsCode + "')";
            }
            //if (!string.IsNullOrEmpty(entity.GoodsCode))
            //{
            //    strSQL += " and b.GoodsCode='" + entity.GoodsCode + "'";
            //}
            //and a.Piece>0 and b.BelongDepart=0
            strSQL += "  and a.OP_DATE>='2023-01-01' group by a.TypeID,b.GoodsCode,b.Batch";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoSafeStockEntity
                        {
                            GoodsCode = Convert.ToString(idrCount["GoodsCode"]),
                            TypeID = Convert.ToInt32(idrCount["TypeID"]),
                            Batch = Convert.ToString(idrCount["Batch"]),
                            StockNum = Convert.ToInt32(idrCount["Stock"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询已出库的未推送马牌的出库标签数据
        /// </summary>
        /// <returns></returns>
        public List<saleOpenInfoResp> QueryContiOutOrderInfo(saleOpenInfoResp entity)
        {
            List<saleOpenInfoResp> result = new List<saleOpenInfoResp>();
            //string strSQL = "select a.OrderID,a.orderCode,a.orderSource,a.orderType,a.orderLabel,a.deliveryType,a.CargoOrderNo,a.InCreateStatus,a.CreateAwbID,a.CreateAwb,a.CreateDate,a.doNo,a.shippingCode,a.IsPushOutTag,b.LogisAwbNo,b.LogisID,b.SaleManName,b.SaleCellphone,b.OpenExpressName,b.OpenExpressNum,b.PayClientName From Tbl_Cargo_ContiOrder as a inner join Tbl_Cargo_Order as b on a.CargoOrderNo=b.OrderNo and a.doNo!='' and b.AwbStatus>=2 ";
            string strSQL = $@"   with cte as (
select OrderPiece,a.OrderID,a.orderCode,b.OrderNo as CargoOrderNo
     ,a.doNo,b.SaleManName,b.SaleCellphone
             From Tbl_Cargo_ContiOrder as a
                      inner join Tbl_Cargo_Order as b
                                 on a.orderCode = b.OpenOrderNo
                where a.doNo IS NOT NULL AND a.doNo <> '' and b.AwbStatus >= 2
             ";
            if (!string.IsNullOrEmpty(entity.HouseIDStr)) { strSQL += " and b.HouseID in (" + entity.HouseIDStr + ")"; }
            //制单日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.InCreateStatus)) { strSQL += " and a.InCreateStatus='" + entity.InCreateStatus + "'"; }
            if (!string.IsNullOrEmpty(entity.IsPushOutTag)) { strSQL += " and a.IsPushOutTag='" + entity.IsPushOutTag + "'"; }
            strSQL += $@" 
             )
select a.OrderID,a.orderCode,a.doNo,OrderPiece,a.CargoOrderNo
     ,SaleManName,SaleCellphone
                From cte as a 
                group by a.OrderID,a.orderCode,a.doNo,OrderPiece,a.doNo,a.CargoOrderNo,SaleManName,SaleCellphone
";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new saleOpenInfoResp
                        {
                            OrderID = Convert.ToInt64(idrCount["OrderID"]),
                            orderCode = Convert.ToString(idrCount["orderCode"]),
                            doNo = Convert.ToString(idrCount["doNo"]),
                            OrderPiece = Convert.ToInt32(idrCount["OrderPiece"]),
                            CargoOrderNo = Convert.ToString(idrCount["CargoOrderNo"]),
                            SaleManName = Convert.ToString(idrCount["SaleManName"]),
                            SaleCellphone = Convert.ToString(idrCount["SaleCellphone"]),
                            //orderSource = Convert.ToString(idrCount["orderSource"]),
                            //orderType = Convert.ToString(idrCount["orderType"]),
                            //deliveryType = Convert.ToString(idrCount["deliveryType"]),
                            //InCreateStatus = Convert.ToString(idrCount["InCreateStatus"]),
                            //CreateAwbID = Convert.ToString(idrCount["CreateAwbID"]),
                            //CreateAwb = Convert.ToString(idrCount["CreateAwb"]),
                            //CreateDate = Convert.ToDateTime(idrCount["CreateDate"]),
                            //shippingCode = Convert.ToString(idrCount["shippingCode"]),
                            //IsPushOutTag = Convert.ToString(idrCount["IsPushOutTag"]),
                            //LogisAwbNo = Convert.ToString(idrCount["LogisAwbNo"]),
                            //OpenExpressName = Convert.ToString(idrCount["OpenExpressName"]),
                            //OpenExpressNum = Convert.ToString(idrCount["OpenExpressNum"]),
                            //PayClientName = Convert.ToString(idrCount["PayClientName"]),
                        });
                    }
                }
            }
            var result2 = result
                            .GroupBy(o => new { o.OrderID, o.orderCode, o.doNo, o.OrderPiece })
                            .Select(g => new saleOpenInfoResp
                            {
                                OrderID = g.Key.OrderID,
                                orderCode = g.Key.orderCode,
                                doNo = g.Key.doNo,
                                OrderPiece = g.Key.OrderPiece,
                                CargoOrderNo = $@"'{string.Join("','", g.Select(x => x.CargoOrderNo).Distinct())}'",
                                SaleManName = g.FirstOrDefault()?.SaleManName,
                                SaleCellphone = g.FirstOrDefault()?.SaleCellphone,
                            })
                            .ToList();
            return result2;
        }

        /// <summary>
        /// 根据订单号查询订单出库明细列表
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoProductTagEntity> QueryContiOutOrderDetail(saleOpenInfoResp entity)
        {
            List<CargoProductTagEntity> result = new List<CargoProductTagEntity>();
            //string strSQL = "select b.Batch,b.GoodsCode,c.TyreCode,c.OutCargoTime From Tbl_Cargo_OrderGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductTag as c on a.OrderNo=c.OrderNo and b.ProductID=c.ProductID where a.OrderNo=@OrderNo";
            string strSQL = $@"select b.Batch,b.GoodsCode,c.TyreCode,c.OutCargoTime From Tbl_Cargo_OrderGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductTag as c on a.OrderNo=c.OrderNo and b.ProductID=c.ProductID where a.OrderNo in({entity.CargoOrderNo})";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                //conn.AddInParameter(cmd, "@OrderNo", DbType.String, entity.CargoOrderNo);
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoProductTagEntity
                        {
                            GoodsCode = Convert.ToString(idrCount["GoodsCode"]),
                            TyreCode = Convert.ToString(idrCount["TyreCode"]),
                            Batch = Convert.ToString(idrCount["Batch"]),
                            OutCargoTime = Convert.ToDateTime(idrCount["OutCargoTime"])
                        });
                    }
                }
            }

            return result;
        }



        #endregion

        #region 开思订单系统数据接口

        public Hashtable QueryCassMallOrder(int pIndex, int pNum, OrderHeader entity)
        {
            List<OrderHeader> result = new List<OrderHeader>();
            Hashtable resHT = new Hashtable();
            try
            {
                #region 获取订单明细
                //string strSQL = @" SELECT TOP " + pNum + "* FROM (SELECT DISTINCT ROW_NUMBER() OVER(ORDER BY a.InCreateStatus asc,a.OPDATE DESC) AS RowNumber,a.*,b.Name as HouseName from dbo.Tbl_Cargo_ContiOrder as a inner join tbl_Cargo_house as b on a.HouseID=b.HouseID WHERE (1=1)";
                string strSQL = $@" 
                select top {pNum} * from (
              select DISTINCT ROW_NUMBER() OVER (ORDER BY a.orderDate desc) AS RowNumber, a.*,b.companyCode as AconsigneeCode,b.companyName as AconsigneeName,bb.companyName as SellerName,c.ReceiverName,(c.provinceGeoName+c.cityGeoName+ c.villageGeoName+ c.address) as address,c.contactNumber
              ,d.facilityId,d.facilityName,e.HouseID,e.AreaID,c.cityGeoName,f.OverDayNum,f.OverDueUnitPrice,cc.feeAmount,f.Person,users.LoginName,f.Cellphone,ff.Name OrderHouseName
from Tbl_Cargo_CassMallOrder as a
         inner join Tbl_Cargo_CassMallOrderBuyer as b on a.CID = b.CID
         inner join Tbl_Cargo_CassMallOrderSeller as bb on a.CID = bb.CID
inner join Tbl_Cargo_CassMallOrderPostalAddress as c on a.orderId=c.orderId
inner join Tbl_Cargo_CassMallOrderWayDetails as cc on c.PID=cc.PID
left join (
    select orderId,facilityId,facilityName,max(orderItemSeqId) orderItemSeqId from Tbl_Cargo_CassMallOrderItemInventories as aa
             group by orderId,facilityId,facilityName
) as d on d.orderId=a.orderId
left join Tbl_Cargo_Area as e on e.CassHouseCode=d.facilityId
left join Tbl_Cargo_House as f on e.HouseID=f.HouseID
left join Tbl_Cargo_House as ff on a.OrderHouseID=ff.HouseID
left join (
    select ltrim(rtrim(UserName)) UserName,max(LoginName) LoginName from Tbl_SysUser
group by ltrim(rtrim(UserName))
) as users on f.Person=users.UserName
      where 1 = 1  ";

                if (!string.IsNullOrEmpty(entity.OrderTypeId)) { strSQL += "and a.OrderTypeId='" + entity.OrderTypeId + "'"; }
                if (!string.IsNullOrEmpty(entity.SalesChannelEnumId)) { strSQL += "and a.SalesChannelEnumId='" + entity.SalesChannelEnumId + "'"; }
                if (!string.IsNullOrEmpty(entity.InCreateStatus)) { strSQL += "and a.InCreateStatus='" + entity.InCreateStatus + "'"; }
                //所属仓库ID
                if (entity.HouseID!=0) { strSQL += " and a.OrderHouseID in (" + entity.HouseID + ")"; }
                if (!string.IsNullOrEmpty(entity.OrderId)) { strSQL += " and a.OrderId like '%" + entity.OrderId + "%'"; }

                //if (!string.IsNullOrEmpty(entity.consigneeName)) { strSQL += " and a.consigneeName like '%" + entity.consigneeName + "%'"; }
                if (!string.IsNullOrEmpty(entity.Buyer?.CompanyName)) { strSQL += " and b.companyName like '%" + entity.Buyer.CompanyName + "%'"; }

                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OrderDateTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OrderDateTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += ") as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))  order by RowNumber";
                #endregion

                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    #region 获取数据
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        Common.Common.ReplaceDBNullWithDefault(dd);
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new OrderHeader
                            {
                                CID = Convert.ToInt64(idr["CID"]),
                                OrderId = Convert.ToString(idr["orderId"]),
                                OrderTypeId = Convert.ToString(idr["orderTypeId"]),
                                OrderTypeIdDesc = Convert.ToString(idr["orderTypeIdDesc"]),
                                OrderName = Convert.ToString(idr["orderName"]),
                                SalesChannelEnumId = Convert.ToString(idr["salesChannelEnumId"]),
                                OrderDate = Convert.ToString(idr["orderDate"]),
                                OrderDateStr = Convert.ToDateTime(idr["OrderDateTime"]),
                                SourceId = Convert.ToString(idr["sourceId"]),
                                CreateBy = Convert.ToString(idr["createBy"]),
                                CreateName = Convert.ToString(idr["createName"]),
                                OriginalSource = Convert.ToString(idr["originalSource"]),
                                OriginalSourceDesc = Convert.ToString(idr["originalSourceDesc"]),
                                StatusId = Convert.ToString(idr["statusId"]),
                                EvaluateStatus = Convert.ToString(idr["evaluateStatus"]),
                                StatusIdDesc = Convert.ToString(idr["statusIdDesc"]),
                                PaymentStatus = Convert.ToString(idr["paymentStatus"]),
                                PaymentStatusDesc = Convert.ToString(idr["paymentStatusDesc"]),
                                InvoiceStatus = Convert.ToString(idr["invoiceStatus"]),
                                OrderStoreType = Convert.ToString(idr["orderStoreType"]),
                                InquiryId = Convert.ToString(idr["inquiryId"]),
                                QuotationId = Convert.ToString(idr["quotationId"]),
                                Amount = Convert.ToDecimal(idr["amount"]),
                                ActualAmount = Convert.ToDecimal(idr["actualAmount"]),
                                DiscountAmount = Convert.ToDecimal(idr["discountAmount"]),
                                SalesmanId = Convert.ToString(idr["salesmanId"]),
                                SalesmanName = Convert.ToString(idr["salesmanName"]),
                                Remark = Convert.ToString(idr["remark"]),
                                CarBrandId = Convert.ToString(idr["carBrandId"]),
                                CarBrandName = Convert.ToString(idr["carBrandName"]),
                                CancelReason = Convert.ToString(idr["cancelReason"]),
                                AconsigneeCode = Convert.ToString(idr["AconsigneeCode"]),
                                AconsigneeName = Convert.ToString(idr["AconsigneeName"]),
                                ContactNumber = Convert.ToString(idr["contactNumber"]),
                                SellerName = Convert.ToString(idr["SellerName"]),
                                ReceiverName = Convert.ToString(idr["ReceiverName"]),
                                Address = Convert.ToString(idr["address"]),
                                FacilityId = Convert.ToString(idr["facilityId"]),
                                FacilityName = Convert.ToString(idr["facilityName"]),
                                CityGeoName = Convert.ToString(idr["cityGeoName"]),
                                Person = Convert.ToString(idr["Person"]),
                                LoginName = Convert.ToString(idr["LoginName"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                OrderHouseID = Convert.ToInt32(idr["OrderHouseID"]),
                                OrderHouseName = Convert.ToString(idr["OrderHouseName"]),
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                InCreateStatus = Convert.ToString(idr["InCreateStatus"]),
                                CancelTime = Convert.ToInt64(idr["cancelTime"]),
                                OverDayNum = string.IsNullOrEmpty(Convert.ToString(idr["OverDayNum"])) ? 0 : Convert.ToInt32(idr["OverDayNum"]),
                                OverDueUnitPrice = string.IsNullOrEmpty(Convert.ToString(idr["OverDueUnitPrice"])) ? 0M : Convert.ToDecimal(idr["OverDueUnitPrice"]),
                                FeeAmount = string.IsNullOrEmpty(Convert.ToString(idr["feeAmount"])) ? 0M : Convert.ToDecimal(idr["feeAmount"]),
                                CargoOrderNo = Convert.ToString(idr["CargoOrderNo"]),
                            });
                        }
                    }
                    #endregion
                }
                resHT["rows"] = result;
                #region 获取总数
                string strCount = $@" 
               select count(1) totalCount   from Tbl_Cargo_CassMallOrder as a
               inner join Tbl_Cargo_CassMallOrderBuyer as b on a.CID = b.CID
      inner join Tbl_Cargo_CassMallOrderPostalAddress as c on a.orderId=c.orderId
                where 1=1
                      ";


                if (!string.IsNullOrEmpty(entity.OrderTypeId)) { strSQL += "and a.OrderTypeId='" + entity.OrderTypeId + "'"; }
                if (!string.IsNullOrEmpty(entity.SalesChannelEnumId)) { strSQL += "and a.SalesChannelEnumId='" + entity.SalesChannelEnumId + "'"; }
                if (!string.IsNullOrEmpty(entity.InCreateStatus)) { strSQL += "and a.InCreateStatus='" + entity.InCreateStatus + "'"; }
                //所属仓库ID
                //if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.OrderId)) { strSQL += " and a.OrderId like '%" + entity.OrderId + "%'"; }

                //if (!string.IsNullOrEmpty(entity.consigneeName)) { strSQL += " and a.consigneeName like '%" + entity.consigneeName + "%'"; }
                if (!string.IsNullOrEmpty(entity.Buyer?.CompanyName)) { strSQL += " and b.companyName like '%" + entity.Buyer.CompanyName + "%'"; }

                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OrderDateTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OrderDateTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
                #endregion
            }
            catch (Exception ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return resHT;
        }
        //private T? GetValue<T>(SqlDataReader reader, string columnName)
        //{
        //    int index = reader.GetOrdinal(columnName);
        //    if (reader.IsDBNull(index))
        //        return default;
        //    return (T)Convert.ChangeType(reader.GetValue(index), typeof(T));
        //}
        public List<OrderItem> QueryCassMallOrderGoods(OrderHeader entity)
        {
            List<OrderItem> result = new List<OrderItem>();
            try
            {
                #region 获取订单明细
                //string strSQL = @" SELECT TOP " + pNum + "* FROM (SELECT DISTINCT ROW_NUMBER() OVER(ORDER BY a.InCreateStatus asc,a.OPDATE DESC) AS RowNumber,a.*,b.Name as HouseName from dbo.Tbl_Cargo_ContiOrder as a inner join tbl_Cargo_house as b on a.HouseID=b.HouseID WHERE (1=1)";
                string strSQL = $@" 
                  select a.*,facilityId,facilityName,b.quantity facilityquantity,waybillOnlineFlag from Tbl_Cargo_CassMallOrderGoods as a
                inner join  Tbl_Cargo_CassMallOrderItemInventories as b on a.SID=b.SID
                where 1=1 ";

                if (!string.IsNullOrEmpty(entity.OrderId)) { strSQL += $@" and a.OrderId ='{entity.OrderId}'"; }
                #endregion

                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    #region 获取数据
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        Common.Common.ReplaceDBNullWithDefault(dd);
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new OrderItem
                            {
                                SID = Convert.ToInt32(idr["SID"]),
                                OrderId = Convert.ToString(idr["orderId"]),
                                OrderItemSeqId = Convert.ToString(idr["orderItemSeqId"]),
                                QuoteId = Convert.ToString(idr["quoteId"]),
                                Quantity = Convert.ToDecimal(idr["quantity"]),
                                ActualPrice = Convert.ToDecimal(idr["actualPrice"]),
                                OriginalSellerPrice = Convert.ToDecimal(idr["originalSellerPrice"]),
                                ItemDescription = Convert.ToString(idr["itemDescription"]),
                                CancelQuantity = Convert.ToDecimal(idr["cancelQuantity"]),
                                OrderItemTypeId = Convert.ToString(idr["orderItemTypeId"]),
                                CheckInventory = !string.IsNullOrEmpty(Convert.ToString(idr["checkInventory"])) ? true : Convert.ToBoolean(idr["checkInventory"]),
                                PostageStatus = Convert.ToString(idr["postageStatus"]),
                                CustomerProductId = Convert.ToString(idr["customerProductId"]),
                                ProductId = Convert.ToString(idr["productId"]),
                                ProductName = Convert.ToString(idr["productName"]),
                                BrandId = Convert.ToString(idr["brandId"]),
                                BrandName = Convert.ToString(idr["brandName"]),
                                Quality = Convert.ToString(idr["quality"]),
                                QualityName = Convert.ToString(idr["qualityName"]),
                                InternalNum = Convert.ToString(idr["internalNum"]),
                                PartsName = Convert.ToString(idr["partsName"]),
                                PartsNum = Convert.ToString(idr["partsNum"]),
                                OriginalPartsNum = Convert.ToString(idr["originalPartsNum"]),
                                ReplacePartsNum = Convert.ToString(idr["replacePartsNum"]),
                                AfterSalePolicy = Convert.ToString(idr["afterSalePolicy"]),
                                Dispatch = Convert.ToBoolean(idr["dispatch"]),
                                DispatchTime = Convert.ToString(idr["dispatchTime"]),
                                FacilityId = Convert.ToString(idr["facilityId"]),
                                FacilityName = Convert.ToString(idr["facilityName"]),
                                Facilityquantity = Convert.ToInt32(idr["facilityquantity"]),
                                WaybillOnlineFlag = Convert.ToString(idr["waybillOnlineFlag"]),
                            });
                        }
                    }
                    #endregion
                }
            }
            catch (Exception ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return result;
        }
        public List<OrderItemAdjustment> QueryCassMallItemAdjustments(OrderHeader entity)
        {
            List<OrderItemAdjustment> result = new List<OrderItemAdjustment>();
            try
            {
                #region 获取订单明细
                //string strSQL = @" SELECT TOP " + pNum + "* FROM (SELECT DISTINCT ROW_NUMBER() OVER(ORDER BY a.InCreateStatus asc,a.OPDATE DESC) AS RowNumber,a.*,b.Name as HouseName from dbo.Tbl_Cargo_ContiOrder as a inner join tbl_Cargo_house as b on a.HouseID=b.HouseID WHERE (1=1)";
                string strSQL = $@" 
                  select * from Tbl_Cargo_CassMallOrderItemAdjustments as a
                where 1=1 ";

                if (!string.IsNullOrEmpty(entity.OrderId)) { strSQL += $@" and a.OrderId ='{entity.OrderId}'"; }
                #endregion

                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    #region 获取数据
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        Common.Common.ReplaceDBNullWithDefault(dd);
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new OrderItemAdjustment
                            {
                                AID = Convert.ToInt64(idr["AID"]),
                                OrderId = Convert.ToString(idr["orderId"]),
                                OrderItemSeqId = Convert.ToString(idr["orderItemSeqId"]),
                                AdjustmentType = Convert.ToString(idr["adjustmentType"]),
                                AdjustmentDesc = Convert.ToString(idr["adjustmentDesc"]),
                                AdjustmentAmount = Convert.ToDecimal(idr["adjustmentAmount"]),
                            });
                        }
                    }
                    #endregion
                }
            }
            catch (Exception ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return result;
        }
        public List<OrderGiftItem> QueryCassMallGiftItems(OrderHeader entity)
        {
            List<OrderGiftItem> result = new List<OrderGiftItem>();
            try
            {
                #region 获取订单明细
                //string strSQL = @" SELECT TOP " + pNum + "* FROM (SELECT DISTINCT ROW_NUMBER() OVER(ORDER BY a.InCreateStatus asc,a.OPDATE DESC) AS RowNumber,a.*,b.Name as HouseName from dbo.Tbl_Cargo_ContiOrder as a inner join tbl_Cargo_house as b on a.HouseID=b.HouseID WHERE (1=1)";
                string strSQL = $@" 
                  select * from Tbl_Cargo_CassMallOrderGiftItems as a
                where 1=1 ";

                if (!string.IsNullOrEmpty(entity.OrderId)) { strSQL += $@" and a.OrderId ='{entity.OrderId}'"; }
                #endregion

                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    #region 获取数据
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        Common.Common.ReplaceDBNullWithDefault(dd);
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new OrderGiftItem
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                orderId = Convert.ToString(idr["orderId"]),
                                GiftCode = Convert.ToString(idr["giftCode"]),
                                GiftName = Convert.ToString(idr["giftName"]),
                                OriginalPrice = Convert.ToDecimal(idr["originalPrice"]),
                                Quantity = Convert.ToInt32(idr["quantity"]),
                                IsSellProduct = Convert.ToBoolean(idr["isSellProduct"]),
                            });
                        }
                    }
                    #endregion
                }
            }
            catch (Exception ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return result;
        }
        public List<CargoProductMappingEntity> GetProductMapping(OrderItem entity)
        {
            List<CargoProductMappingEntity> result = new List<CargoProductMappingEntity>();
            try
            {
                string strSQL = @" select ROW_NUMBER() OVER (ORDER BY a.MID desc) AS RowNumber, a.*,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,b.GoodsCode,b.TypeID,c.TypeName,c.ParentID,c.TypeParentName from Tbl_Cargo_ProductMapping as a inner join Tbl_Cargo_ProductSpec as b on a.ProductCode=b.ProductCode inner join Tbl_Cargo_ProductType as c on b.TypeID=c.TypeID  ";
                strSQL += " Where (1=1) and CorpClass=1 ";
                if (!string.IsNullOrEmpty(entity.PartsNum)) { strSQL += " and a.CassCode = '" + entity.PartsNum + "'"; }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoProductMappingEntity
                            {
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                ShareCode = Convert.ToString(idr["ShareCode"]),
                                CorpClass = Convert.ToString(idr["CorpClass"]),
                                MID = Convert.ToInt64(idr["MID"]),
                                CassCode = Convert.ToString(idr["CassCode"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]).Trim(),
                                ParentID = Convert.ToInt32(idr["ParentID"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]).Trim(),
                                Figure = Convert.ToString(idr["Figure"]).Trim(),
                                Specs = Convert.ToString(idr["Specs"]).Trim(),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),

                            });
                        }
                    }
                }


            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        #endregion

        #region 揭阳仓处理接口
        public bool keyExists(StockApiEntity entity)
        {
            string strSQL = $"Select * from Tbl_Open_BasicProduct where SystemKey='{entity.SystemKey}'";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    if (dt.Rows.Count > 0)
                    {
                        return true;
                    }
                    else
                    {
                        return false;
                    }
                }
            }
        }

        public bool ExistsGoodCode(string GoodsCode)
        {
            string strSQL = $"Select * from Tbl_Open_BasicProduct where GoodsCode='{GoodsCode}'";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    if (dt.Rows.Count > 0)
                    {
                        return true;
                    }
                    else
                    {
                        return false;
                    }
                }
            }

        }
        public bool ExistsProduct(string HouseID, string ProductID)
        {
            string strSQL = $"Select * from Tbl_Cargo_Product where HouseID='{HouseID}' and ProductID='{ProductID}'";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    if (dt.Rows.Count > 0)
                    {
                        return true;
                    }
                    else
                    {
                        return false;
                    }
                }
            }

        }
        public bool ExistsContainerGoods(string ContainerID, string ProductID)
        {
            string strSQL = $"Select * from Tbl_Cargo_ContainerGoods where ContainerID='{ContainerID}' and ProductID='{ProductID}'";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    if (dt.Rows.Count > 0)
                    {
                        return true;
                    }
                    else
                    {
                        return false;
                    }
                }
            }

        }
        public long QueryProductID(string HouseID, string GoodsCode)
        {
            string strSQL = $"SELECT ProductID FROM Tbl_Cargo_Product WHERE HouseID='{HouseID}' AND GoodsCode='{GoodsCode}'";
            long result = 0;
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result = Convert.ToString(idr["ProductID"]) == "" ? 0 : Convert.ToInt32(idr["ProductID"]);
                    }
                }
            }
            return result;

        }

        public void UpdateContainerGoods(StockApiEntity entity, string ProductID)
        {
            string strSQL = string.Empty;
            if (ExistsContainerGoods(Convert.ToString(entity.ContainerID), ProductID))
            {
                strSQL = "Update Tbl_Cargo_ContainerGoods set Piece=@Piece where ContainerID=@ContainerID and ProductID=@ProductID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@Piece", DbType.String, entity.StockNum);
                    conn.AddInParameter(cmd, "@ContainerID", DbType.String, entity.ContainerID);
                    conn.AddInParameter(cmd, "@ProductID", DbType.String, ProductID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            else
            {
                strSQL = "INSERT INTO Tbl_Cargo_ContainerGoods(ContainerID, TypeID, ProductID, Piece, InHouseTime,OP_DATE,InCargoID) VALUES(@ContainerID, @TypeID, @ProductID, @Piece, GETDATE(),GETDATE(),@InCargoID)";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ContainerID", DbType.String, entity.ContainerID);
                    conn.AddInParameter(cmd, "@TypeID", DbType.String, entity.TypeID);
                    conn.AddInParameter(cmd, "@ProductID", DbType.String, ProductID);
                    conn.AddInParameter(cmd, "@Piece", DbType.Decimal, entity.StockNum);
                    conn.AddInParameter(cmd, "@InCargoID", DbType.String, entity.InCargoID);
                    conn.ExecuteNonQuery(cmd);
                }
            }

        }
        public StockApiEntity QueryInventory(string GoodsCode)
        {
            StockApiEntity result = new StockApiEntity();
            string strSQL = $"Select * from Tbl_Open_BasicProduct where GoodsCode='{GoodsCode}'";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.TypeID = Convert.ToInt32(idrCount["TypeID"]);
                        result.Model = Convert.ToString(idrCount["Model"]);
                        result.GoodsCode = Convert.ToString(idrCount["GoodsCode"]);
                        result.Specs = Convert.ToString(idrCount["Specs"]);
                        result.Figure = Convert.ToString(idrCount["Figure"]);
                        result.LoadIndex = Convert.ToString(idrCount["LoadIndex"]);
                        result.SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]);
                        result.Born = Convert.ToString(idrCount["Born"]);
                        result.ProductName = Convert.ToString(idrCount["ProductName"]);
                        result.BrandCode = Convert.ToString(idrCount["BrandCode"]);
                        result.TyreType = Convert.ToInt32(idrCount["TyreType"]);
                        result.ProductCode = Convert.ToString(idrCount["ProductCode"]);
                        result.ProductUnit = Convert.ToString(idrCount["ProductUnit"]);
                        result.CassProductCode = Convert.ToString(idrCount["CassProductCode"]);
                        result.IsUpdate = Convert.ToInt32(idrCount["IsUpdate"]);
                        result.IsPush = Convert.ToInt32(idrCount["IsPush"]);
                        result.SalePrice = Convert.ToDecimal(idrCount["SalePrice"]);
                        result.StockNum = Convert.ToInt32(idrCount["StockNum"]);
                        result.Batch = Convert.ToString(idrCount["Batch"]);
                        result.OID = Convert.ToInt32(idrCount["OID"]);
                    }
                }
            }
            return result;
        }


        public void UpdateInventory(StockApiEntity entity)
        {
            string strSQL = "Update Tbl_Open_BasicProduct set IsUpdate=@IsUpdate,IsPush=@IsPush,SalePrice=@SalePrice,StockNum=@StockNum,Batch=@Batch where  GoodsCode=@GoodsCode ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@IsUpdate", DbType.String, 1);
                conn.AddInParameter(cmd, "@IsPush", DbType.String, 0);
                conn.AddInParameter(cmd, "@GoodsCode", DbType.String, entity.GoodsCode);
                conn.AddInParameter(cmd, "@StockNum", DbType.String, entity.StockNum);
                conn.AddInParameter(cmd, "@SalePrice", DbType.Decimal, entity.SalePrice);
                conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);
                conn.ExecuteNonQuery(cmd);
            }
        }

        public void UpdateStatus(List<StockApiEntity> entity)
        {
            string GoodsCodes = string.Empty;
            for (int i = 0; i < entity.Count; i++)
            {
                GoodsCodes += entity[i].GoodsCode + "','";
            }
            string strSQL = "Update Tbl_Open_BasicProduct set IsUpdate=@IsUpdate,IsPush=@IsPush where  GoodsCode in('" + GoodsCodes + "')";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@IsUpdate", DbType.String, 0);
                conn.AddInParameter(cmd, "@IsPush", DbType.String, 1);
                conn.ExecuteNonQuery(cmd);
            }

        }
        public List<StockApiEntity> QueryModifyInventory()
        {
            List<StockApiEntity> result = new List<StockApiEntity>();
            string strSQL = " SELECT B.TypeName,A.* FROM Tbl_Open_BasicProduct A LEFT JOIN Tbl_Cargo_ProductType B ON A.TypeID=B.TypeID where a.IsUpdate=1 and IsPush=0 ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new StockApiEntity
                        {
                            Model = Convert.ToString(idrCount["Model"]),
                            GoodsCode = Convert.ToString(idrCount["GoodsCode"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            Figure = Convert.ToString(idrCount["Figure"]),
                            LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                            Born = Convert.ToString(idrCount["Born"]),
                            ProductName = Convert.ToString(idrCount["ProductName"]),
                            BrandCode = Convert.ToString(idrCount["BrandCode"]),
                            TyreType = Convert.ToInt32(idrCount["TyreType"]),
                            ProductCode = Convert.ToString(idrCount["ProductCode"]),
                            ProductUnit = Convert.ToString(idrCount["ProductUnit"]),
                            CassProductCode = Convert.ToString(idrCount["CassProductCode"]),
                            IsUpdate = Convert.ToInt32(idrCount["IsUpdate"]),
                            IsPush = Convert.ToInt32(idrCount["IsPush"]),
                            SalePrice = Convert.ToDecimal(idrCount["SalePrice"]),
                            StockNum = Convert.ToInt32(idrCount["StockNum"]),
                            Batch = Convert.ToString(idrCount["Batch"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                        });
                    }
                }
            }
            return result;

        }
        /// <summary>
        /// 查询云仓的库存数据同步
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<StockApiEntity> QueryYunCangStockSync(CargoProductEntity entity)
        {
            List<StockApiEntity> result = new List<StockApiEntity>();
            string strSQL = " select distinct a.*,b.CassCode from (select SUM(a.Piece)over(partition by b.ProductCode,b.Batch) as StockNum,ROW_NUMBER() over (partition by b.ProductCode,b.Batch order by a.Piece desc,b.SalePrice desc,b.Specs) as RN,c.TypeName,a.Piece,b.TypeID,b.ProductCode,b.Specs,b.Figure,b.GoodsCode,b.LoadIndex,b.SpeedLevel,b.Batch,b.HouseID,b.SalePrice From Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID and b.SpecsType<>5 ";
            if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID=@HouseID"; }
            if (!entity.TypeID.Equals(0)) { strSQL += " and b.TypeID=@TypeID"; }
            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and b.ProductCode in ('" + entity.ProductCode + "')"; }
            strSQL += " inner join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID) as a left join Tbl_Cargo_ProductMapping as b on a.ProductCode=b.ProductCode where a.RN=1 order by a.TypeName,a.ProductCode ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                if (!entity.HouseID.Equals(0)) { conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID); }
                if (!entity.TypeID.Equals(0)) { conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID); }

                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new StockApiEntity
                        {
                            //Model = Convert.ToString(idrCount["Model"]),
                            GoodsCode = Convert.ToString(idrCount["GoodsCode"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            Figure = Convert.ToString(idrCount["Figure"]),
                            LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                            //Born = Convert.ToString(idrCount["Born"]),
                            ProductName = Convert.ToString(idrCount["TypeName"]) + " " + Convert.ToString(idrCount["Specs"]) + " " + Convert.ToString(idrCount["Figure"]) + " " + Convert.ToString(idrCount["LoadIndex"]) + Convert.ToString(idrCount["SpeedLevel"]),
                            //BrandCode = Convert.ToString(idrCount["BrandCode"]),
                            //TyreType = Convert.ToInt32(idrCount["TyreType"]),
                            ProductCode = Convert.ToString(idrCount["ProductCode"]),
                            CassProductCode = Convert.ToString(idrCount["CassCode"]),
                            //ProductUnit = Convert.ToString(idrCount["ProductUnit"]),
                            //CassProductCode = Convert.ToString(idrCount["CassProductCode"]),
                            //IsUpdate = Convert.ToInt32(idrCount["IsUpdate"]),
                            //IsPush = Convert.ToInt32(idrCount["IsPush"]),
                            SalePrice = Convert.ToDecimal(idrCount["SalePrice"]),
                            StockNum = Convert.ToInt32(idrCount["StockNum"]),
                            Batch = Convert.ToString(idrCount["Batch"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            HouseID = Convert.ToInt32(idrCount["HouseID"]),
                            TypeID = Convert.ToInt32(idrCount["TypeID"]),
                        });
                    }
                }
            }
            return result;

        }

        public List<CargoInterfaceEntity> QueryChangeStock()
        {
            string strSQL = "SELECT  *FROM  Tbl_Open_ChangeStock where DelFlag=0 ";
            List<CargoInterfaceEntity> result = new List<CargoInterfaceEntity>();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoInterfaceEntity
                        {
                            ProductCode = Convert.ToString(idrCount["ProductCode"]),
                            Batch = Convert.ToString(idrCount["Batch"]),
                            StockNum = Convert.ToInt32(idrCount["Number"]),
                            SalePrice = Convert.ToDecimal(idrCount["SalePrice"])
                        });
                    }
                }
            }
            return result;
        }
        public void UpdateChangeStock(List<CargoInterfaceEntity> entities)
        {
            foreach (CargoInterfaceEntity entity in entities)
            {
                string strSQL = "update Tbl_Open_ChangeStock set PushBatchID=@PushBatchID,DelFlag=1 where ProductCode=@ProductCode";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@PushBatchID", DbType.String, entity.PushBatchID);
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.ExecuteScalar(cmd);
                }

            }
        }
        public void AddProductData(StockApiEntity entity)
        {
            try
            {
                string strSQL = "Insert into Tbl_Open_BasicProduct(SystemKey, TypeID, Model, GoodsCode, Specs, Figure, LoadIndex, SpeedLevel, Born, ProductName, BrandCode,TyreType, ProductCode, ProductUnit, CassProductCode, IsUpdate, IsPush, SalePrice, StockNum, Batch)values(@SystemKey, @TypeID, @Model, @GoodsCode, @Specs, @Figure, @LoadIndex, @SpeedLevel, @Born, @ProductName, @BrandCode,@TyreType, @ProductCode, @ProductUnit, @CassProductCode, @IsUpdate, @IsPush, @SalePrice, @StockNum, @Batch)";
                long cdid = 0;
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@SystemKey", DbType.String, entity.SystemKey == null ? "" : entity.SystemKey);
                    conn.AddInParameter(cmd, "@TypeID", DbType.String, entity.TypeID);
                    conn.AddInParameter(cmd, "@Model", DbType.String, entity.Model == null ? "" : entity.Model);
                    conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs == null ? "" : entity.Specs);
                    conn.AddInParameter(cmd, "@GoodsCode", DbType.String, entity.GoodsCode == null ? "" : entity.GoodsCode);
                    conn.AddInParameter(cmd, "@Figure", DbType.String, entity.Figure == null ? "" : entity.Figure);
                    conn.AddInParameter(cmd, "@LoadIndex", DbType.String, entity.LoadIndex == null ? "" : entity.LoadIndex);
                    conn.AddInParameter(cmd, "@SpeedLevel", DbType.String, entity.SpeedLevel == null ? "" : entity.SpeedLevel);
                    conn.AddInParameter(cmd, "@Born", DbType.String, entity.Born == null ? "" : entity.Born);
                    conn.AddInParameter(cmd, "@ProductName", DbType.String, entity.ProductName == null ? "" : entity.ProductName);
                    conn.AddInParameter(cmd, "@TyreType", DbType.String, entity.TyreType);
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode == null ? "" : entity.ProductCode);
                    conn.AddInParameter(cmd, "@ProductUnit", DbType.String, entity.ProductUnit == null ? "" : entity.ProductUnit);
                    conn.AddInParameter(cmd, "@CassProductCode", DbType.String, entity.CassProductCode == null ? "" : entity.CassProductCode);
                    conn.AddInParameter(cmd, "@IsUpdate", DbType.String, 1);
                    conn.AddInParameter(cmd, "@IsPush", DbType.String, 0);
                    conn.AddInParameter(cmd, "@SalePrice", DbType.String, entity.SalePrice);
                    conn.AddInParameter(cmd, "@StockNum", DbType.String, entity.StockNum);
                    conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch == null ? "" : entity.Batch);
                    conn.AddInParameter(cmd, "@BrandCode", DbType.String, entity.BrandCode == null ? "" : entity.BrandCode);
                    cdid = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
                if (cdid != 0)
                {
                    strSQL = "INSERT INTO Tbl_Cargo_ContainerGoods(ContainerID, TypeID, ProductID, Piece, InHouseTime,OP_DATE,InCargoID) VALUES(@ContainerID, @TypeID, @ProductID, @Piece, GETDATE(),GETDATE(),@InCargoID) ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ContainerID", DbType.String, entity.ContainerID);
                        conn.AddInParameter(cmd, "@TypeID", DbType.String, entity.TypeID);
                        conn.AddInParameter(cmd, "@ProductID", DbType.String, cdid);
                        conn.AddInParameter(cmd, "@Piece", DbType.String, entity.SalePrice);
                        conn.AddInParameter(cmd, "@InCargoID", DbType.String, entity.InCargoID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (Exception EX)
            {

                throw new ApplicationException(EX.Message);
            }

        }
        #endregion

        #region 联盈系统数据接口
        /// <summary>
        /// 查询系统七天内未签收的联盈系统过来的运单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoKD100Entity> QueryLYAwbNoData(CargoNewayDataPush entity)
        {
            List<CargoKD100Entity> result = new List<CargoKD100Entity>();
            SqlHelper neway = new SqlHelper("Neway");
            string strSQL = "select AwbID,AwbNo,HAwbNo,ShipperCellphone,BelongSystem,OP_ID from Tbl_Awb_Basic where OP_ID=@OP_ID and AwbStatus=@AwbStatus and BelongSystem=@BelongSystem and HandleTime>='" + entity.StartTime.ToString("yyyy-MM-dd") + "'";
            using (DbCommand command = neway.GetSqlStringCommond(strSQL))
            {
                neway.AddInParameter(command, "@OP_ID", DbType.String, entity.UserName);
                neway.AddInParameter(command, "@AwbStatus", DbType.String, entity.Status);
                neway.AddInParameter(command, "@BelongSystem", DbType.String, entity.BelongSystem);
                using (DataTable dd = neway.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoKD100Entity
                        {
                            AwbID = Convert.ToInt64(idr["AwbID"]),
                            AwbNo = Convert.ToString(idr["AwbNo"]),
                            OrderNo = Convert.ToString(idr["HAwbNo"]),
                            BelongSystem = Convert.ToString(idr["BelongSystem"]),
                            ComCode = Convert.ToString(idr["ShipperCellphone"]),
                            OP_ID = Convert.ToString(idr["OP_ID"]),
                        });
                    }
                }
            }
            return result;
        }


        #endregion

        #region 数据接口生成次日达

        /// <summary>
        /// 判断是否已经有产品数据
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="ProductID"></param>
        /// <returns></returns>
        public bool IsExistCargoProductBySuppClient(CargoProductEntity entity, ref long ProductID)
        {
            ProductID = 0;
            string strQ = @"Select ProductID from Tbl_Cargo_Product Where ProductCode=@ProductCode and SuppClientNum=@SuppClientNum and BatchYear=@BatchYear and TypeID=@TypeID and SpecsType=@SpecsType and HouseID=@HouseID";

            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@SpecsType", DbType.String, entity.SpecsType);
                conn.AddInParameter(cmdQ, "@ProductCode", DbType.String, entity.ProductCode);
                conn.AddInParameter(cmdQ, "@BatchYear", DbType.Int32, entity.BatchYear);
                conn.AddInParameter(cmdQ, "@TypeID", DbType.Int32, entity.TypeID);
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmdQ, "@SuppClientNum", DbType.Int32, entity.SuppClientNum);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                    ProductID = Convert.ToInt64(idr.Rows[0]["ProductID"]);
                }
            }
            return true;
        }


        /// <summary>
        /// 修改库存根据产品ID
        /// </summary>
        /// <param name="entity"></param>
        /// <exception cref="ApplicationException"></exception>
        public void UpdateProductStockNum(CargoContainerGoodsEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_ContainerGoods SET Piece=@Piece Where ProductID=@ProductID ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                conn.AddInParameter(cmd, "@Piece", DbType.Int32, entity.Piece);
                conn.ExecuteNonQuery(cmd);
            }

            string strSQLAdd = @"UPDATE Tbl_Cargo_Product SET SalePrice=@SalePrice,InHousePrice=@InHousePrice,UnitPrice=@UnitPrice Where ProductID=@ProductID ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQLAdd))
            {
                conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                conn.AddInParameter(cmd, "@SalePrice", DbType.Decimal, entity.SalePrice);//销售价
                conn.AddInParameter(cmd, "@InHousePrice", DbType.Decimal, entity.InHousePrice);//销售价
                conn.AddInParameter(cmd, "@UnitPrice", DbType.Decimal, entity.UnitPrice);//销售价
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 批量修改产品库存信息
        /// </summary>
        /// <param name="entityList"></param>
        public void BatchUpdateProductStockNum(List<CargoContainerGoodsEntity> entityList)
        {
            if (entityList == null || entityList.Count == 0) return;
            // Step 1: 创建临时表（和正式表字段保持一致）
            string createTempTableSql = @"
            CREATE TABLE ##TempProductsBatch (
                ProductID BIGINT, Piece INT,
                Supplier NVARCHAR(100), SuppClientNum INT, SpecsType NVARCHAR(50), ProductCode NVARCHAR(100),
                ProductName NVARCHAR(200), HouseID INT, Specs NVARCHAR(100), Figure NVARCHAR(100),
                LoadIndex NVARCHAR(50), SpeedLevel NVARCHAR(50), SalePrice DECIMAL(18,2), Batch NVARCHAR(100), 
                Numbers INT, TypeID INT, Model NVARCHAR(100), GoodsCode NVARCHAR(100), GoodsName NVARCHAR(100),
                TreadWidth NVARCHAR(50), FlatRatio NVARCHAR(50), Meridian NVARCHAR(50), HubDiameter NVARCHAR(50),
                SpeedMax NVARCHAR(50), Weight DECIMAL(18,2),
                UnitPrice DECIMAL(18,2), TradePrice DECIMAL(18,2), InHousePrice DECIMAL(18,2),NextDayPrice DECIMAL(18,2),
                PackageNum INT, PackageWeight DECIMAL(18,2), BatchYear INT, BatchWeek INT,
                OP_DATE DATETIME, Source INT, BelongMonth NVARCHAR(50), OperaType INT, Born NVARCHAR(50), Assort NVARCHAR(50),
                BelongDepart NVARCHAR(100), Company NVARCHAR(100), InHouseTime DATETIME, InCargoStatus INT, ShareHouseID INT
            )";
            using (var cmd = conn.GetSqlStringCommond(createTempTableSql))
            {
                conn.ExecuteScalar(cmd);
            }


            List<TempProducts> tempEntity = entityList.Select(p => new TempProducts
            {
                ProductID = p.ProductID,
                Piece = p.Piece,
                SalePrice = p.SalePrice,
                InHousePrice = p.InHousePrice,
                NextDayPrice = p.NextDayPrice,
                UnitPrice = p.UnitPrice
            }).ToList();
            conn.BulkInsertData(tempEntity, "##TempProductsBatch");
            

                string updateContainerGoods = @"
            UPDATE cg
            SET cg.Piece = tp.Piece
            FROM Tbl_Cargo_ContainerGoods cg
            JOIN ##TempProductsBatch tp ON cg.ProductID = tp.ProductID;";

                // 批量更新 Tbl_Cargo_Product
                string updateProduct = @"
            UPDATE p
            SET p.SalePrice = tp.SalePrice,
                p.InHousePrice = tp.InHousePrice,
                p.NextDayPrice = tp.NextDayPrice,
                p.UnitPrice = tp.UnitPrice
            FROM Tbl_Cargo_Product p
            JOIN ##TempProductsBatch tp ON p.ProductID = tp.ProductID;";

                using (var cmd = conn.GetSqlStringCommond(updateContainerGoods + updateProduct))
                {
                    conn.ExecuteNonQuery(cmd);
                }


        }
        /// <summary>
        /// 设置次日达库存为0
        /// </summary>
        public void SetNextDayStockZero(CargoHouseBrandShareEntity entity)
        {
            //string strSQL = "update Tbl_Cargo_ContainerGoods set Piece=0 where ID in (select b.ID from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID = b.ProductID and a.TypeID = b.TypeID where a.HouseID in (select MainHouseID from Tbl_Cargo_HouseBrandShare group by MainHouseID) and a.SpecsType = 5 and b.Piece > 0)";
            string strSQL = $@"update Tbl_Cargo_ContainerGoods set Piece=0 where ID in (select b.ID from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID = b.ProductID and a.TypeID = b.TypeID where 1=1";
            if (entity != null)
            {
                if (entity.MainHouseID!=0)
                {
                    strSQL += $@" and a.HouseID = {entity.MainHouseID}";
                }
                if (entity.BrandID!=0)
                {
                    strSQL += $@" and a.TypeID = {entity.BrandID}";
                }
            }
            else
            {
                strSQL += $@" and a.HouseID in (select MainHouseID from Tbl_Cargo_HouseBrandShare group by MainHouseID)";
            }
            strSQL += $@"  and a.SpecsType = 5 and a.SharehouseID <> 0 and b.Piece > 0)";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.ExecuteNonQuery(cmd);
            }
        }


        /// <summary>
        /// 查询共享仓库库存同步到前置仓做次日达库存数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoProductEntity> QueryNextDayStockSync(CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            string strSQL = "select t.*,CEILING( case when t.UpPriceType='0' then t.SalePrice+t.FixMoney else t.SalePrice*(1+t.RatePrice/100) end ) as MiniProSalePrice from (select ROW_NUMBER()over(partition by a.TypeID,b.ProductCode,b.SuppClientNum,b.BatchYear,m.MainHouseID order by b.SalePrice desc) as RN ,SUM(a.Piece) over (partition by a.TypeID,b.ProductCode,b.SuppClientNum,b.BatchYear,m.MainHouseID) as TotalNum,b.HouseID,a.TypeID,a.Piece,b.Batch,b.BatchYear,b.BatchWeek,b.SalePrice,b.InHousePrice,b.NextDayPrice,b.SuppClientNum,b.Supplier,b.ProductCode,m.ShareHouseID,m.MainHouseID,m.UpPriceType,ISNULL(m.FixMoney,0) as FixMoney,ISNULL(m.RatePrice,0) as RatePrice,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,b.GoodsCode,b.GoodsName,b.Model,b.Assort,b.SpeedMax,b.TreadWidth,b.FlatRatio,b.HubDiameter,b.Born from Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID and a.TypeID=b.TypeID and a.Piece>0 and b.SpecsType<>5 ";
            if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID=" + entity.HouseID; }
            if (!entity.TypeID.Equals(0)) { strSQL += " and b.TypeID=" + entity.TypeID; }
            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and b.ProductCode in ('" + entity.ProductCode + "')"; }

            strSQL += $@" inner join Tbl_Cargo_HouseBrandShare as m on b.HouseID=m.ShareHouseID  ";
            if (entity.MainHouseID!=0)
            {
                strSQL += $@" and m.MainHouseID={entity.MainHouseID} ";
            }
            strSQL += $@" and b.TypeID=m.BrandID and m.DelFlag=0) as t where t.RN=1 ";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoProductEntity
                        {
                            Numbers = Convert.ToInt32(idr["TotalNum"]),//库存数量
                            HouseID = Convert.ToInt32(idr["MainHouseID"]),//前置仓ID
                            ShareHouseID = Convert.ToInt32(idr["ShareHouseID"]),//共享仓库ID
                            SuppClientNum = Convert.ToInt64(idr["SuppClientNum"]),//供应商编码
                            ProductCode = Convert.ToString(idr["ProductCode"]),//产品编码
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            Batch = Convert.ToString(idr["Batch"]),//周期
                            BatchYear = Convert.ToInt32(idr["BatchYear"]),//周期年
                            SalePrice = Convert.ToDecimal(idr["MiniProSalePrice"]),//销售价
                            MiniProPrice = Convert.ToDecimal(idr["MiniProSalePrice"]),//加价后的小程序销售价
                            InHousePrice = Convert.ToDecimal(idr["InHousePrice"]),//进仓价
                            NextDayPrice = Convert.ToDecimal(idr["NextDayPrice"]).Equals(0) ? Convert.ToDecimal(idr["MiniProSalePrice"]) : Convert.ToDecimal(idr["NextDayPrice"]),//云仓二批客户次日达价
                            Specs = Convert.ToString(idr["Specs"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            SpeedMax = Convert.ToInt32(idr["SpeedMax"]),
                            Model = Convert.ToString(idr["Model"]),
                            GoodsCode = Convert.ToString(idr["GoodsCode"]),
                            GoodsName = Convert.ToString(idr["GoodsName"]),
                            Assort = Convert.ToString(idr["Assort"]),
                            Born = Convert.ToString(idr["Born"]),
                            TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                            FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                            HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 新增次日达产品数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public long SaveProductData(CargoProductEntity entity)
        {
            entity.EnSafe();
            Int64 did = 0;
            string strSQL = @"INSERT INTO Tbl_Cargo_Product(ProductCode,ProductName,TypeID,Model,GoodsCode,Specs,Figure,TreadWidth,FlatRatio,Meridian,HubDiameter,LoadIndex,SpeedLevel,SpeedMax,Weight,UnitPrice,Numbers,TradePrice,SalePrice,PackageNum,PackageWeight,OP_DATE,Batch,BatchYear,BatchWeek,HouseID,Source,BelongMonth,OperaType,Born,Assort,BelongDepart,Company,SpecsType,Supplier,InHouseTime,SuppClientNum,InCargoStatus,InHousePrice,ShareHouseID) VALUES (@ProductCode,@ProductName,@TypeID,@Model,@GoodsCode,@Specs,@Figure,@TreadWidth,@FlatRatio,@Meridian,@HubDiameter,@LoadIndex,@SpeedLevel,@SpeedMax,@Weight,@UnitPrice,@Numbers,@TradePrice,@SalePrice,@PackageNum,@PackageWeight,@OP_DATE,@Batch,@BatchYear,@BatchWeek,@HouseID,@Source,@BelongMonth,@OperaType,@Born,@Assort,@BelongDepart,@Company,@SpecsType,@Supplier,@InHouseTime,@SuppClientNum,@InCargoStatus,@InHousePrice,@ShareHouseID)SELECT @@IDENTITY";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@Supplier", DbType.String, entity.Supplier);
                conn.AddInParameter(cmd, "@SuppClientNum", DbType.Int64, entity.SuppClientNum);
                conn.AddInParameter(cmd, "@SpecsType", DbType.String, entity.SpecsType);
                conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                conn.AddInParameter(cmd, "@ProductName", DbType.String, entity.TypeName + "轮胎");//品牌名+"轮胎"
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs);
                conn.AddInParameter(cmd, "@Figure", DbType.String, entity.Figure);
                conn.AddInParameter(cmd, "@LoadIndex", DbType.String, entity.LoadIndex);
                conn.AddInParameter(cmd, "@SpeedLevel", DbType.String, entity.SpeedLevel);
                conn.AddInParameter(cmd, "@SalePrice", DbType.Decimal, entity.MiniProPrice);//销售价
                conn.AddInParameter(cmd, "@Batch", DbType.String, entity.Batch);

                //【待确定】库存数量=？导入文件填写的数量
                conn.AddInParameter(cmd, "@Numbers", DbType.Int32, entity.Numbers);

                conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                conn.AddInParameter(cmd, "@Model", DbType.String, entity.Model);
                conn.AddInParameter(cmd, "@GoodsCode", DbType.String, entity.GoodsCode);

                conn.AddInParameter(cmd, "@TreadWidth", DbType.Int32, entity.TreadWidth);
                conn.AddInParameter(cmd, "@FlatRatio", DbType.Int32, entity.FlatRatio);
                conn.AddInParameter(cmd, "@Meridian", DbType.String, "R");//子午线，默认值R？默认R
                conn.AddInParameter(cmd, "@HubDiameter", DbType.Int32, entity.HubDiameter);

                conn.AddInParameter(cmd, "@SpeedMax", DbType.Int32, entity.SpeedMax);//最高速度？
                conn.AddInParameter(cmd, "@Weight", DbType.Decimal, 0);//单个重量,默认KG ？默认0
                conn.AddInParameter(cmd, "@UnitPrice", DbType.Decimal, entity.InHousePrice);//单价？导入文件填写的销售价
                conn.AddInParameter(cmd, "@TradePrice", DbType.Decimal, entity.MiniProPrice);//批发价？导入文件填写的销售价
                conn.AddInParameter(cmd, "@InHousePrice", DbType.Decimal, entity.InHousePrice);//批发价？导入文件填写的销售价

                conn.AddInParameter(cmd, "@PackageNum", DbType.Int32, entity.PackageNum);//包装数量？默认0
                conn.AddInParameter(cmd, "@PackageWeight", DbType.Decimal, entity.PackageWeight);//包装重量？默认0
                conn.AddInParameter(cmd, "@BatchYear", DbType.Int32, entity.Batch.Substring(2, 2));//批次年？导入文件填写的批次后两位
                conn.AddInParameter(cmd, "@BatchWeek", DbType.Int32, entity.Batch.Substring(0, 2));//批次周？导入文件填写的批次前两位
                conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                conn.AddInParameter(cmd, "@Source", DbType.String, "83");//归属=83？默认83
                conn.AddInParameter(cmd, "@BelongMonth", DbType.String, entity.BelongMonth); //订单归属月
                conn.AddInParameter(cmd, "@OperaType", DbType.String, "0");//操作类型，0电脑？默认0
                conn.AddInParameter(cmd, "@Born", DbType.String, entity.Born);
                conn.AddInParameter(cmd, "@Assort", DbType.String, entity.Assort);
                conn.AddInParameter(cmd, "@BelongDepart", DbType.String, "1");//归属部门，1:OE渠道销售部？默认1
                conn.AddInParameter(cmd, "@Company", DbType.String, "0");//所属公司，0：迪乐泰？默认0
                conn.AddInParameter(cmd, "@InHouseTime", DbType.String, DateTime.Now);//入库时间
                conn.AddInParameter(cmd, "@InCargoStatus", DbType.String, entity.InCargoStatus);//入库状态=已入库1
                conn.AddInParameter(cmd, "@ShareHouseID", DbType.Int32, entity.ShareHouseID);//共享仓库ID

                did = Convert.ToInt64(conn.ExecuteScalar(cmd));
            }
            return did;
        }


        /// <summary>
        /// 批量插入产品数据
        /// </summary>
        /// <param name="products"></param>
        /// <returns></returns>
        public List<CargoProductEntity> BulkInsertProducts(List<CargoProductEntity> products)
        {
            var insertedProducts = new List<CargoProductEntity>();


            // Step 1: 创建临时表（和正式表字段保持一致）
            string createTempTableSql = @"
            CREATE TABLE ##TempProducts (
                ProductID BIGINT, Piece INT,
                Supplier NVARCHAR(100), SuppClientNum INT, SpecsType NVARCHAR(50), ProductCode NVARCHAR(100),
                ProductName NVARCHAR(200), HouseID INT, Specs NVARCHAR(100), Figure NVARCHAR(100),
                LoadIndex NVARCHAR(50), SpeedLevel NVARCHAR(50), SalePrice DECIMAL(18,2), Batch NVARCHAR(100), 
                Numbers INT, TypeID INT, Model NVARCHAR(100), GoodsCode NVARCHAR(100), GoodsName NVARCHAR(100),
                TreadWidth NVARCHAR(50), FlatRatio NVARCHAR(50), Meridian NVARCHAR(50), HubDiameter NVARCHAR(50),
                SpeedMax NVARCHAR(50), Weight DECIMAL(18,2),
                UnitPrice DECIMAL(18,2), TradePrice DECIMAL(18,2), InHousePrice DECIMAL(18,2),NextDayPrice DECIMAL(18,2),
                PackageNum INT, PackageWeight DECIMAL(18,2), BatchYear INT, BatchWeek INT,
                OP_DATE DATETIME, Source INT, BelongMonth NVARCHAR(50), OperaType INT, Born NVARCHAR(50), Assort NVARCHAR(50),
                BelongDepart NVARCHAR(100), Company NVARCHAR(100), InHouseTime DATETIME, InCargoStatus INT, ShareHouseID INT
            )";
            using (var cmd = conn.GetSqlStringCommond(createTempTableSql))
            {
                conn.ExecuteScalar(cmd);
            }


            // 转换到临时实体列表
            List<TempProducts> tempEntity = products.Select(p => new TempProducts
            {
                Supplier = p.Supplier,
                SuppClientNum = p.SuppClientNum,
                SpecsType = p.SpecsType,
                ProductCode = p.ProductCode,
                ProductName = string.IsNullOrEmpty(p.ProductName) ? "轮胎" : p.ProductName,
                HouseID = p.HouseID,
                Specs = p.Specs,
                Figure = p.Figure,
                LoadIndex = p.LoadIndex,
                SpeedLevel = p.SpeedLevel,
                SalePrice = p.SalePrice,
                Batch = p.Batch,
                Numbers = p.Numbers,
                TypeID = p.TypeID,
                Model = p.Model,
                GoodsCode = p.GoodsCode,
                GoodsName = p.GoodsName,
                TreadWidth = p.TreadWidth,
                FlatRatio = p.FlatRatio,
                Meridian = p.Meridian,
                HubDiameter = p.HubDiameter,
                SpeedMax = p.SpeedMax,
                Weight = p.Weight,
                UnitPrice = p.UnitPrice,
                TradePrice = p.TradePrice,
                InHousePrice = p.InHousePrice,
                NextDayPrice = p.NextDayPrice,
                PackageNum = p.PackageNum,
                PackageWeight = p.PackageWeight,
                BatchYear = p.BatchYear,
                BatchWeek = p.BatchWeek,
                OP_DATE = DateTime.Now,
                Source = p.Source,
                BelongMonth = p.BelongMonth,
                OperaType = p.OperaType,
                Born = p.Born,
                Assort = p.Assort,
                BelongDepart = p.BelongDepart,
                Company = p.Company,
                InHouseTime = DateTime.Now,
                InCargoStatus = p.InCargoStatus,
                ShareHouseID = p.ShareHouseID
            }).ToList();

            // Step 2: 批量写入临时表
            conn.BulkInsertData(tempEntity, "##TempProducts");

            // Step 3: 从临时表插入到正式表，并输出 INSERTED.ProductID
            string insertSql = @"
            INSERT INTO Tbl_Cargo_Product
            (
                Supplier, SuppClientNum, SpecsType, ProductCode, ProductName, HouseID, Specs, Figure,
                LoadIndex, SpeedLevel, SalePrice, Batch, Numbers, TypeID, Model, GoodsCode, GoodsName,
                TreadWidth, FlatRatio, HubDiameter, SpeedMax, Weight,
                UnitPrice, TradePrice, InHousePrice,NextDayPrice,
                PackageNum, PackageWeight, BatchYear, BatchWeek,
                Source, BelongMonth, OperaType, Born, Assort,
                BelongDepart, Company, InHouseTime, InCargoStatus, ShareHouseID,
                Size, Package
            )
            OUTPUT INSERTED.*
            SELECT
                Supplier, SuppClientNum, SpecsType, ProductCode, ProductName, HouseID, Specs, Figure,
                LoadIndex, SpeedLevel, SalePrice, Batch, Numbers, TypeID, Model, GoodsCode, GoodsName,
                TreadWidth, FlatRatio, HubDiameter, SpeedMax, Weight,
                UnitPrice, TradePrice, InHousePrice,NextDayPrice,
                1 as PackageNum, PackageWeight, BatchYear, BatchWeek,
                83 as Source, BelongMonth, 0 as OperaType, Born, Assort,
                1 as BelongDepart, 0 as Company, GETDATE() AS InHouseTime, InCargoStatus, ShareHouseID,
                HubDiameter, '条' as Package
            FROM ##TempProducts;
        ";
            using (var cmd = conn.GetSqlStringCommond(insertSql))
            {
                using (var datatable = conn.ExecuteDataTable(cmd))
                {
                    if (datatable.Rows.Count > 0)
                    {
                        foreach (DataRow dr in datatable.Rows)
                        {
                            var entity = new CargoProductEntity()
                            {
                                ProductID = dr.Field<long>("ProductID"),
                                TypeID = dr.Field<int>("TypeID"),
                                Numbers = dr.Field<int>("Numbers"),
                                HouseID = dr.Field<int>("HouseID"),
                            };

                            insertedProducts.Add(entity);
                        }
                    }
                }
            }

            return insertedProducts;
        }


        /// <summary>
        /// 更新共享订单号
        /// 
        /// </summary>
        /// <param name="entity"></param>
        /// <exception cref="ApplicationException"></exception>
        public void UpdateOrderOpenNo(CargoOrderEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Order Set OpenOrderNo=@OpenOrderNo Where OrderNo=@OrderNo and HouseID=@HouseID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@OpenOrderNo", DbType.String, entity.OpenOrderNo);
                conn.AddInParameter(cmd, "@OrderNo", DbType.String, entity.OrderNo);
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                conn.ExecuteNonQuery(cmd);
            }
        }

        #endregion

        #region 开思
        private object ToDbValue(object value) => value ?? DBNull.Value;
        public void AddCassMallData(CargoCassMallEntity entity)
        {
            try
            {
                string strSQL = "insert into Tbl_Cargo_CassMallOrderLog(sourcetype,SourceAction, opdate, resjson, orderId) values (@sourcetype,@SourceAction, @opdate, @resjson, @orderId)SELECT @@IDENTITY";
                long cdid = 0;
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@sourcetype", DbType.Int32, entity.SourceType);
                    conn.AddInParameter(cmd, "@SourceAction", DbType.String, entity.SourceAction);
                    conn.AddInParameter(cmd, "@opdate", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@resjson", DbType.String, entity.ResJson);
                    conn.AddInParameter(cmd, "@orderId", DbType.String, entity.orderId);
                    cdid = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
            }
            catch (Exception EX)
            {

                throw new ApplicationException(EX.Message);
            }

        }
        public static DateTimeOffset FromUnixTimeMilliseconds(long milliseconds)
        {
            var epoch = new DateTimeOffset(1970, 1, 1, 0, 0, 0, TimeSpan.Zero);
            return epoch.AddMilliseconds(milliseconds);
        }
        public void AddCassMallOrder(OrderHeader entity)
        {
            try
            {
                string strSQL = $@"insert into Tbl_Cargo_CassMallOrder
                (orderId, orderTypeId, orderTypeIdDesc, orderName, salesChannelEnumId, orderDate, OrderDateTime, sourceId, createBy, createName, originalSource, originalSourceDesc, statusId, evaluateStatus, statusIdDesc, paymentStatus, paymentStatusDesc, invoiceStatus, orderStoreType, inquiryId, quotationId, amount, actualAmount, discountAmount, salesmanId, salesmanName, remark, carBrandId, carBrandName,OrderHouseID)
            values(@orderId, @orderTypeId, @orderTypeIdDesc, @orderName, @salesChannelEnumId, @orderDate, @OrderDateTime, @sourceId, @createBy, @createName, @originalSource, @originalSourceDesc, @statusId, @evaluateStatus, @statusIdDesc, @paymentStatus, @paymentStatusDesc, @invoiceStatus, @orderStoreType, @inquiryId, @quotationId, @amount, @actualAmount, @discountAmount, @salesmanId, @salesmanName, @remark, @carBrandId, @carBrandName, @OrderHouseID)
            SELECT @@IDENTITY
            ";
                long cdid = 0;
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    long timestamp = Convert.ToInt64(entity.OrderDate); // 毫秒
                    DateTimeOffset dateTimeOffset = FromUnixTimeMilliseconds(timestamp);
                    DateTime dateTime = dateTimeOffset.ToLocalTime().DateTime;

                    conn.AddInParameter(cmd, "@orderId", DbType.String, entity.OrderId);
                    conn.AddInParameter(cmd, "@orderTypeId", DbType.String, ToDbValue(entity.OrderTypeId));
                    conn.AddInParameter(cmd, "@orderTypeIdDesc", DbType.String, ToDbValue(entity.OrderTypeIdDesc));
                    conn.AddInParameter(cmd, "@orderName", DbType.String, ToDbValue(entity.OrderName));
                    conn.AddInParameter(cmd, "@salesChannelEnumId", DbType.String, ToDbValue(entity.SalesChannelEnumId));
                    conn.AddInParameter(cmd, "@orderDate", DbType.Int64, (entity.OrderDate));
                    conn.AddInParameter(cmd, "@OrderDateTime", DbType.DateTime, (dateTime));
                    conn.AddInParameter(cmd, "@sourceId", DbType.String, ToDbValue(entity.SourceId));
                    conn.AddInParameter(cmd, "@createBy", DbType.String, ToDbValue(entity.CreateBy));
                    conn.AddInParameter(cmd, "@createName", DbType.String, ToDbValue(entity.CreateName));
                    conn.AddInParameter(cmd, "@originalSource", DbType.String, ToDbValue(entity.OriginalSource));
                    conn.AddInParameter(cmd, "@originalSourceDesc", DbType.String, ToDbValue(entity.OriginalSourceDesc));
                    conn.AddInParameter(cmd, "@statusId", DbType.String, ToDbValue(entity.StatusId));
                    conn.AddInParameter(cmd, "@evaluateStatus", DbType.String, ToDbValue(entity.EvaluateStatus));
                    conn.AddInParameter(cmd, "@statusIdDesc", DbType.String, ToDbValue(entity.StatusIdDesc));
                    conn.AddInParameter(cmd, "@paymentStatus", DbType.String, ToDbValue(entity.PaymentStatus));
                    conn.AddInParameter(cmd, "@paymentStatusDesc", DbType.String, ToDbValue(entity.PaymentStatusDesc));
                    conn.AddInParameter(cmd, "@invoiceStatus", DbType.String, ToDbValue(entity.InvoiceStatus));
                    conn.AddInParameter(cmd, "@orderStoreType", DbType.String, ToDbValue(entity.OrderStoreType));
                    conn.AddInParameter(cmd, "@inquiryId", DbType.String, ToDbValue(entity.InquiryId));
                    conn.AddInParameter(cmd, "@quotationId", DbType.String, ToDbValue(entity.QuotationId));
                    conn.AddInParameter(cmd, "@amount", DbType.String, ToDbValue(entity.Amount));
                    conn.AddInParameter(cmd, "@actualAmount", DbType.String, ToDbValue(entity.ActualAmount));
                    conn.AddInParameter(cmd, "@discountAmount", DbType.String, ToDbValue(entity.DiscountAmount));
                    conn.AddInParameter(cmd, "@salesmanId", DbType.String, ToDbValue(entity.SalesmanId));
                    conn.AddInParameter(cmd, "@salesmanName", DbType.String, ToDbValue(entity.SalesmanName));
                    conn.AddInParameter(cmd, "@remark", DbType.String, ToDbValue(entity.Remark));
                    conn.AddInParameter(cmd, "@carBrandId", DbType.String, ToDbValue(entity.CarBrandId));
                    conn.AddInParameter(cmd, "@carBrandName", DbType.String, ToDbValue(entity.CarBrandName));
                    conn.AddInParameter(cmd, "@OrderHouseID", DbType.Int32, ToDbValue(entity.OrderHouseID));
                    cdid = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }

                if (entity.Buyer != null)
                {
                    strSQL = $@"insert into Tbl_Cargo_CassMallOrderBuyer(companyId, companyName, companyType, companyDisplayName, companyCode, companyStoreId, outerCompanyId, CID) 
                    values(@companyId,@companyName,@companyType,@companyDisplayName,@companyCode,@companyStoreId,@outerCompanyId,@CID)
                    ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@companyId", DbType.String, ToDbValue(entity.Buyer.CompanyId));
                        conn.AddInParameter(cmd, "@companyName", DbType.String, ToDbValue(entity.Buyer.CompanyName));
                        conn.AddInParameter(cmd, "@companyType", DbType.String, ToDbValue(entity.Buyer.CompanyType));
                        conn.AddInParameter(cmd, "@companyDisplayName", DbType.String, ToDbValue(entity.Buyer.CompanyDisplayName));
                        conn.AddInParameter(cmd, "@companyCode", DbType.String, ToDbValue(entity.Buyer.CompanyCode));
                        conn.AddInParameter(cmd, "@companyStoreId", DbType.String, ToDbValue(entity.Buyer.CompanyStoreId));
                        conn.AddInParameter(cmd, "@outerCompanyId", DbType.String, ToDbValue(entity.Buyer.OuterCompanyId));
                        conn.AddInParameter(cmd, "@CID", DbType.Int64, cdid);
                        Convert.ToInt64(conn.ExecuteScalar(cmd));
                    }
                }

                if (entity.Seller != null)
                {
                    strSQL = $@"insert into Tbl_Cargo_CassMallOrderSeller(companyId, companyName, companyType, companyDisplayName, companyCode, companyStoreId, vendorId, CID) 
                    values(@companyId,@companyName,@companyType,@companyDisplayName,@companyCode,@companyStoreId,@vendorId,@CID)
                    ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@companyId", DbType.String, ToDbValue(entity.Seller.CompanyId));
                        conn.AddInParameter(cmd, "@companyName", DbType.String, ToDbValue(entity.Seller.CompanyName));
                        conn.AddInParameter(cmd, "@companyType", DbType.String, ToDbValue(entity.Seller.CompanyType));
                        conn.AddInParameter(cmd, "@companyDisplayName", DbType.String, ToDbValue(entity.Seller.CompanyDisplayName));
                        conn.AddInParameter(cmd, "@companyCode", DbType.String, ToDbValue(entity.Seller.CompanyCode));
                        conn.AddInParameter(cmd, "@companyStoreId", DbType.String, ToDbValue(entity.Seller.CompanyStoreId));
                        conn.AddInParameter(cmd, "@vendorId", DbType.String, ToDbValue(entity.Seller.VendorId));
                        conn.AddInParameter(cmd, "@CID", DbType.Int64, cdid);
                        Convert.ToInt64(conn.ExecuteScalar(cmd));
                    }
                }

                if (entity.FulfillStore != null)
                {
                    strSQL = $@"insert into Tbl_Cargo_CassMallOrderFulfillStore(vendorId, storeId, storeName, roleType, storeType, CID) 
                    values(@vendorId, @storeId, @storeName, @roleType, @storeType, @CID)
                    ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@vendorId", DbType.String, ToDbValue(entity.FulfillStore.VendorId));
                        conn.AddInParameter(cmd, "@storeId", DbType.String, ToDbValue(entity.FulfillStore.StoreId));
                        conn.AddInParameter(cmd, "@storeName", DbType.String, ToDbValue(entity.FulfillStore.StoreName));
                        conn.AddInParameter(cmd, "@roleType", DbType.String, ToDbValue(entity.FulfillStore.RoleType));
                        conn.AddInParameter(cmd, "@storeType", DbType.String, ToDbValue(entity.FulfillStore.StoreType));
                        conn.AddInParameter(cmd, "@CID", DbType.Int64, cdid);
                        Convert.ToInt64(conn.ExecuteScalar(cmd));
                    }
                }
            }
            catch (Exception EX)
            {

                throw new ApplicationException(EX.Message);
            }

        }

        public void AddCassMallOrderGoods(OrderItem entity)
        {
            try
            {
                string strSQL = $@"insert into Tbl_Cargo_CassMallOrderGoods(orderId, orderItemSeqId, quoteId, quantity, actualPrice, originalSellerPrice, itemDescription, cancelQuantity, orderItemTypeId, checkInventory, postageStatus, customerProductId, productId, productName, brandId, brandName, quality, qualityName, internalNum, partsName, partsNum, originalPartsNum, replacePartsNum, afterSalePolicy, dispatch, dispatchTime, thirdPartySystem)
values (@orderId,@orderItemSeqId,@quoteId,@quantity,@actualPrice,@originalSellerPrice,@itemDescription,@cancelQuantity,@orderItemTypeId,@checkInventory,@postageStatus,@customerProductId,@productId,@productName,@brandId,@brandName,@quality,@qualityName,@internalNum,@partsName,@partsNum,@originalPartsNum,@replacePartsNum,@afterSalePolicy,@dispatch,@dispatchTime, @thirdPartySystem) 
SELECT @@IDENTITY
";
                long cdid = 0;
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@orderId", DbType.String, entity.OrderId);
                    conn.AddInParameter(cmd, "@orderItemSeqId", DbType.String, ToDbValue(entity.OrderItemSeqId));
                    conn.AddInParameter(cmd, "@quoteId", DbType.String, ToDbValue(entity.QuoteId));
                    conn.AddInParameter(cmd, "@quantity", DbType.Decimal, ToDbValue(entity.Quantity));
                    conn.AddInParameter(cmd, "@actualPrice", DbType.Decimal, ToDbValue(entity.ActualPrice));
                    conn.AddInParameter(cmd, "@originalSellerPrice", DbType.Decimal, entity.OriginalSellerPrice);
                    conn.AddInParameter(cmd, "@itemDescription", DbType.String, ToDbValue(entity.ItemDescription));
                    conn.AddInParameter(cmd, "@cancelQuantity", DbType.Decimal, ToDbValue(entity.CancelQuantity));
                    conn.AddInParameter(cmd, "@orderItemTypeId", DbType.String, ToDbValue(entity.OrderItemTypeId));
                    conn.AddInParameter(cmd, "@checkInventory", DbType.String, ToDbValue(entity.CheckInventory));
                    conn.AddInParameter(cmd, "@postageStatus", DbType.String, ToDbValue(entity.PostageStatus));
                    conn.AddInParameter(cmd, "@customerProductId", DbType.String, ToDbValue(entity.CustomerProductId));
                    conn.AddInParameter(cmd, "@productId", DbType.String, ToDbValue(entity.ProductId));
                    conn.AddInParameter(cmd, "@productName", DbType.String, ToDbValue(entity.ProductName));
                    conn.AddInParameter(cmd, "@brandId", DbType.String, ToDbValue(entity.BrandId));
                    conn.AddInParameter(cmd, "@brandName", DbType.String, ToDbValue(entity.BrandName));
                    conn.AddInParameter(cmd, "@quality", DbType.String, ToDbValue(entity.Quality));
                    conn.AddInParameter(cmd, "@qualityName", DbType.String, ToDbValue(entity.QualityName));
                    conn.AddInParameter(cmd, "@internalNum", DbType.String, ToDbValue(entity.InternalNum));
                    conn.AddInParameter(cmd, "@partsName", DbType.String, ToDbValue(entity.PartsName));
                    conn.AddInParameter(cmd, "@partsNum", DbType.String, ToDbValue(entity.PartsNum));
                    conn.AddInParameter(cmd, "@originalPartsNum", DbType.String, ToDbValue(entity.OriginalPartsNum));
                    conn.AddInParameter(cmd, "@replacePartsNum", DbType.String, ToDbValue(entity.ReplacePartsNum));
                    conn.AddInParameter(cmd, "@afterSalePolicy", DbType.String, ToDbValue(entity.AfterSalePolicy));
                    conn.AddInParameter(cmd, "@dispatch", DbType.Boolean, ToDbValue(entity.Dispatch));
                    conn.AddInParameter(cmd, "@dispatchTime", DbType.String, ToDbValue(entity.DispatchTime));
                    conn.AddInParameter(cmd, "@thirdPartySystem", DbType.String, ToDbValue(entity.ThirdPartySystemStr));

                    cdid = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }

                if (entity.ItemInventories != null && entity.ItemInventories.Count > 0)
                {
                    foreach (var item2 in entity.ItemInventories)
                    {
                        strSQL = $@"insert into Tbl_Cargo_CassMallOrderItemInventories(orderId, orderItemSeqId, facilityId, facilityName, quantity, waybillOnlineFlag,SID) 
                        values(@orderId, @orderItemSeqId, @facilityId, @facilityName, @quantity, @waybillOnlineFlag,@SID)
                        ";
                        using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                        {
                            conn.AddInParameter(cmd, "@orderId", DbType.String, item2.OrderId);
                            conn.AddInParameter(cmd, "@orderItemSeqId", DbType.String, ToDbValue(item2.OrderItemSeqId));
                            conn.AddInParameter(cmd, "@facilityId", DbType.String, ToDbValue(item2.FacilityId));
                            conn.AddInParameter(cmd, "@facilityName", DbType.String, ToDbValue(item2.FacilityName));
                            conn.AddInParameter(cmd, "@quantity", DbType.Decimal, ToDbValue(item2.Quantity));
                            conn.AddInParameter(cmd, "@waybillOnlineFlag", DbType.Boolean, ToDbValue(item2.WaybillOnlineFlag));
                            conn.AddInParameter(cmd, "@SID", DbType.Int64, cdid);
                            Convert.ToInt64(conn.ExecuteScalar(cmd));
                        }
                    }

                }
            }
            catch (Exception EX)
            {

                throw new ApplicationException(EX.Message);
            }

        }

        public void AddCassMallGiftItems(OrderGiftItem entity)
        {
            try
            {
                string strSQL = $@"insert into Tbl_Cargo_CassMallOrderGiftItems(giftCode, giftName, originalPrice, quantity, isSellProduct, orderId) 
                                    values (@giftCode, @giftName, @originalPrice, @quantity, @isSellProduct, @orderId) SELECT @@IDENTITY";
                long cdid = 0;
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@giftCode", DbType.String, entity.GiftCode);
                    conn.AddInParameter(cmd, "@giftName", DbType.String, ToDbValue(entity.GiftName));
                    conn.AddInParameter(cmd, "@originalPrice", DbType.Decimal, ToDbValue(entity.OriginalPrice));
                    conn.AddInParameter(cmd, "@quantity", DbType.Int32, ToDbValue(entity.Quantity));
                    conn.AddInParameter(cmd, "@isSellProduct", DbType.Boolean, ToDbValue(entity.IsSellProduct));
                    conn.AddInParameter(cmd, "@orderId", DbType.String, ToDbValue(entity.orderId));

                    cdid = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
            }
            catch (Exception EX)
            {

                throw new ApplicationException(EX.Message);
            }

        }

        public void AddCassMallPostalAddress(OrderPostalAddress entity)
        {
            try
            {
                string strSQL = $@"insert into Tbl_Cargo_CassMallOrderPostalAddress(orderId, id, houseNumber, receiverName, provinceGeoId, provinceGeoName, cityGeoId, cityGeoName, countyGeoId, countyGeoName, villageGeoId, villageGeoName, address, contactTel, contactNumber, longitude, latitude, accurate)
values(@orderId,@id,@houseNumber,@receiverName,@provinceGeoId,@provinceGeoName,@cityGeoId,@cityGeoName,@countyGeoId,@countyGeoName,@villageGeoId,@villageGeoName,@address,@contactTel,@contactNumber,@longitude,@latitude,@accurate) 
SELECT @@IDENTITY ";
                long cdid = 0;
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@orderId", DbType.String, entity.OrderId);
                    conn.AddInParameter(cmd, "@id", DbType.String, ToDbValue(entity.Id));
                    conn.AddInParameter(cmd, "@houseNumber", DbType.String, ToDbValue(entity.HouseNumber));
                    conn.AddInParameter(cmd, "@receiverName", DbType.String, ToDbValue(entity.ReceiverName));
                    conn.AddInParameter(cmd, "@provinceGeoId", DbType.String, ToDbValue(entity.ProvinceGeoId));
                    conn.AddInParameter(cmd, "@provinceGeoName", DbType.String, ToDbValue(entity.ProvinceGeoName));
                    conn.AddInParameter(cmd, "@cityGeoId", DbType.String, ToDbValue(entity.CityGeoId));
                    conn.AddInParameter(cmd, "@cityGeoName", DbType.String, ToDbValue(entity.CityGeoName));
                    conn.AddInParameter(cmd, "@countyGeoId", DbType.String, ToDbValue(entity.CountyGeoId));
                    conn.AddInParameter(cmd, "@countyGeoName", DbType.String, ToDbValue(entity.CountyGeoName));
                    conn.AddInParameter(cmd, "@villageGeoId", DbType.String, ToDbValue(entity.VillageGeoId));
                    conn.AddInParameter(cmd, "@villageGeoName", DbType.String, ToDbValue(entity.VillageGeoName));
                    conn.AddInParameter(cmd, "@address", DbType.String, ToDbValue(entity.Address));
                    conn.AddInParameter(cmd, "@contactTel", DbType.String, ToDbValue(entity.ContactTel));
                    conn.AddInParameter(cmd, "@contactNumber", DbType.String, ToDbValue(entity.ContactNumber));
                    conn.AddInParameter(cmd, "@longitude", DbType.Double, ToDbValue(entity.Longitude));
                    conn.AddInParameter(cmd, "@latitude", DbType.Double, ToDbValue(entity.Latitude));
                    conn.AddInParameter(cmd, "@accurate", DbType.Boolean, ToDbValue(entity.Accurate));

                    cdid = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
                if (entity.OrderWayDetails != null && entity.OrderWayDetails.Count > 0)
                {
                    foreach (var item2 in entity.OrderWayDetails)
                    {
                        strSQL = $@"insert into Tbl_Cargo_CassMallOrderWayDetails(orderId, id, facilityId, facilityName, companyId, companyName, locationId, locationName, transportationCode, transportationName, deliverType, landingLogisticsLocationCode, landingLogisticsLocationName, displayLocation, wholion, wholionServiceType, wholionCarModel, wholionServiceCar, wholionLineShiftCode, distance, timeEfficiency, arrivalTime, wholionLocationId, wholionLocationName, feeAmount,PID)
values(@orderId,@id,@facilityId,@facilityName,@companyId,@companyName,@locationId,@locationName,@transportationCode,@transportationName,@deliverType,@landingLogisticsLocationCode,@landingLogisticsLocationName,@displayLocation,@wholion,@wholionServiceType,@wholionCarModel,@wholionServiceCar,@wholionLineShiftCode,@distance,@timeEfficiency,@arrivalTime,@wholionLocationId,@wholionLocationName,@feeAmount,@PID)
                        ";
                        using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                        {
                            conn.AddInParameter(cmd, "@orderId", DbType.String, item2.OrderId);
                            conn.AddInParameter(cmd, "@id", DbType.String, ToDbValue(item2.Id));
                            conn.AddInParameter(cmd, "@facilityId", DbType.String, ToDbValue(item2.FacilityId));
                            conn.AddInParameter(cmd, "@facilityName", DbType.String, ToDbValue(item2.FacilityName));
                            conn.AddInParameter(cmd, "@companyId", DbType.String, ToDbValue(item2.CompanyId));
                            conn.AddInParameter(cmd, "@companyName", DbType.String, ToDbValue(item2.CompanyName));
                            conn.AddInParameter(cmd, "@locationId", DbType.String, ToDbValue(item2.LocationId));
                            conn.AddInParameter(cmd, "@locationName", DbType.String, ToDbValue(item2.LocationName));
                            conn.AddInParameter(cmd, "@transportationCode", DbType.String, ToDbValue(item2.TransportationCode));
                            conn.AddInParameter(cmd, "@transportationName", DbType.String, ToDbValue(item2.TransportationName));
                            conn.AddInParameter(cmd, "@deliverType", DbType.String, ToDbValue(item2.DeliverType));
                            conn.AddInParameter(cmd, "@landingLogisticsLocationCode", DbType.String, ToDbValue(item2.LandingLogisticsLocationCode));
                            conn.AddInParameter(cmd, "@landingLogisticsLocationName", DbType.String, ToDbValue(item2.LandingLogisticsLocationName));
                            conn.AddInParameter(cmd, "@displayLocation", DbType.String, ToDbValue(item2.DisplayLocation));
                            conn.AddInParameter(cmd, "@wholion", DbType.Boolean, ToDbValue(item2.Wholion));
                            conn.AddInParameter(cmd, "@wholionServiceType", DbType.String, ToDbValue(item2.WholionServiceType));
                            conn.AddInParameter(cmd, "@wholionCarModel", DbType.String, ToDbValue(item2.WholionCarModel));
                            conn.AddInParameter(cmd, "@wholionServiceCar", DbType.String, ToDbValue(item2.WholionServiceCar));
                            conn.AddInParameter(cmd, "@wholionLineShiftCode", DbType.String, ToDbValue(item2.WholionLineShiftCode));
                            conn.AddInParameter(cmd, "@distance", DbType.String, ToDbValue(item2.Distance));
                            conn.AddInParameter(cmd, "@timeEfficiency", DbType.String, ToDbValue(item2.TimeEfficiency));
                            conn.AddInParameter(cmd, "@arrivalTime", DbType.String, ToDbValue(item2.ArrivalTime));
                            conn.AddInParameter(cmd, "@wholionLocationId", DbType.String, ToDbValue(item2.WholionLocationId));
                            conn.AddInParameter(cmd, "@wholionLocationName", DbType.String, ToDbValue(item2.WholionLocationName));
                            conn.AddInParameter(cmd, "@feeAmount", DbType.Decimal, ToDbValue(item2.FeeAmount));
                            conn.AddInParameter(cmd, "@PID", DbType.Int64, cdid);
                            Convert.ToInt64(conn.ExecuteScalar(cmd));
                        }
                    }

                }
            }
            catch (Exception EX)
            {

                throw new ApplicationException(EX.Message);
            }

        }

        public void AddCassMallItemAdjustments(OrderItemAdjustment entity)
        {
            try
            {
                string strSQL = $@"insert into Tbl_Cargo_CassMallOrderItemAdjustments(orderId,orderItemSeqId,adjustmentType,adjustmentDesc,adjustmentAmount)
VALUES(@orderId,@orderItemSeqId,@adjustmentType,@adjustmentDesc,@adjustmentAmount)";
                long cdid = 0;
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@orderId", DbType.String, entity.OrderId);
                    conn.AddInParameter(cmd, "@orderItemSeqId", DbType.String, ToDbValue(entity.OrderItemSeqId));
                    conn.AddInParameter(cmd, "@adjustmentType", DbType.String, ToDbValue(entity.AdjustmentType));
                    conn.AddInParameter(cmd, "@adjustmentDesc", DbType.String, ToDbValue(entity.AdjustmentDesc));
                    conn.AddInParameter(cmd, "@adjustmentAmount", DbType.Decimal, ToDbValue(entity.AdjustmentAmount));

                    cdid = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
            }
            catch (Exception EX)
            {

                throw new ApplicationException(EX.Message);
            }

        }

        public void MassCallOrderCancelled(CassMallDTO entity)
        {
            try
            {
                //string strSQL = $@"update Tbl_Cargo_CassMallOrder set statusId='ORDER_CANCELLED',statusIdDesc='已取消',cancelReason=@cancelReason,cancelTime=@cancelTime where orderId=@orderId";
                //long cdid = 0;
                //using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                //{
                //    conn.AddInParameter(cmd, "@orderId", DbType.String, entity.data.orderId);
                //    conn.AddInParameter(cmd, "@cancelReason", DbType.String, entity.data.cancelReason);
                //    conn.AddInParameter(cmd, "@cancelTime", DbType.Int64, entity.data.cancelTime);

                //    conn.ExecuteNonQuery(cmd);
                //}
                var data = QueryCallMallOrderList(entity.data.orderId).FirstOrDefault();

                if (data != null)
                {
                    //删除开思订单数据
                    string strSQL = $@"
                    ;delete from Tbl_Cargo_CassMallOrder where CID='{data.CID}'
                    ;delete from Tbl_Cargo_CassMallOrderBuyer where CID='{data.CID}'
                    ;delete from Tbl_Cargo_CassMallOrderSeller where CID='{data.CID}'
                    ;delete from Tbl_Cargo_CassMallOrderFulfillStore where CID='{data.CID}'
                    ;delete from Tbl_Cargo_CassMallOrderGoods where orderId='{data.OrderId}'
                    ;delete from Tbl_Cargo_CassMallOrderGiftItems where orderId='{data.OrderId}'
                    ;delete from Tbl_Cargo_CassMallOrderItemAdjustments where orderId='{data.OrderId}'
                    ;delete from Tbl_Cargo_CassMallOrderItemInventories where orderId='{data.OrderId}'
                    ;delete from Tbl_Cargo_CassMallOrderPostalAddress where orderId='{data.OrderId}'
                    ;delete from Tbl_Cargo_CassMallOrderWayDetails where orderId='{data.OrderId}'
                ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.ExecuteNonQuery(cmd);
                    }
                }


            }
            catch (Exception EX)
            {

                throw new ApplicationException(EX.Message);
            }

        }

        public List<CargoOrderEntity> QueryOrderList(string entity)
        {
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();
            try
            {
                string strSQL = $@"select * from Tbl_Cargo_Order where OpenOrderNo=@OpenOrderNo and OpenOrderSource=2";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@OpenOrderNo", DbType.String, entity);

                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoOrderEntity
                            {
                                OrderID = string.IsNullOrEmpty(Convert.ToString(idr["OrderID"])) ? 0L : Convert.ToInt64(idr["OrderID"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                OrderNum = string.IsNullOrEmpty(Convert.ToString(idr["OrderNum"])) ? 0 : Convert.ToInt32(idr["OrderNum"]),
                                HAwbNo = Convert.ToString(idr["HAwbNo"]),
                                LogisAwbNo = Convert.ToString(idr["LogisAwbNo"]),
                                LogisID = string.IsNullOrEmpty(Convert.ToString(idr["LogisID"])) ? 0 : Convert.ToInt32(idr["LogisID"]),
                                Dep = Convert.ToString(idr["Dep"]),
                                Dest = Convert.ToString(idr["Dest"]),
                                Piece = string.IsNullOrEmpty(Convert.ToString(idr["Piece"])) ? 0 : Convert.ToInt32(idr["Piece"]),
                                Weight = string.IsNullOrEmpty(Convert.ToString(idr["Weight"])) ? 0m : Convert.ToDecimal(idr["Weight"]),
                                Volume = string.IsNullOrEmpty(Convert.ToString(idr["Volume"])) ? 0m : Convert.ToDecimal(idr["Volume"]),
                                InsuranceFee = string.IsNullOrEmpty(Convert.ToString(idr["InsuranceFee"])) ? 0m : Convert.ToDecimal(idr["InsuranceFee"]),
                                TransitFee = string.IsNullOrEmpty(Convert.ToString(idr["TransitFee"])) ? 0m : Convert.ToDecimal(idr["TransitFee"]),
                                TransportFee = string.IsNullOrEmpty(Convert.ToString(idr["TransportFee"])) ? 0m : Convert.ToDecimal(idr["TransportFee"]),
                                DeliveryFee = string.IsNullOrEmpty(Convert.ToString(idr["DeliveryFee"])) ? 0m : Convert.ToDecimal(idr["DeliveryFee"]),
                                OtherFee = string.IsNullOrEmpty(Convert.ToString(idr["OtherFee"])) ? 0m : Convert.ToDecimal(idr["OtherFee"]),
                                TotalCharge = string.IsNullOrEmpty(Convert.ToString(idr["TotalCharge"])) ? 0m : Convert.ToDecimal(idr["TotalCharge"]),
                                Rebate = string.IsNullOrEmpty(Convert.ToString(idr["Rebate"])) ? 0m : Convert.ToDecimal(idr["Rebate"]),
                                CheckOutType = Convert.ToString(idr["CheckOutType"]),
                                TrafficType = Convert.ToString(idr["TrafficType"]),
                                DeliveryType = Convert.ToString(idr["DeliveryType"]),
                                AcceptUnit = Convert.ToString(idr["AcceptUnit"]),
                                AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                                AcceptTelephone = Convert.ToString(idr["AcceptTelephone"]),
                                AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                                AcceptAddress = Convert.ToString(idr["AcceptAddress"]),
                                CreateAwb = Convert.ToString(idr["CreateAwb"]),
                                CreateDate = string.IsNullOrEmpty(Convert.ToString(idr["CreateDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["CreateDate"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                Signer = Convert.ToString(idr["Signer"]),
                                SignTime = string.IsNullOrEmpty(Convert.ToString(idr["SignTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["SignTime"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = string.IsNullOrEmpty(Convert.ToString(idr["OP_DATE"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["OP_DATE"]),
                                AwbStatus = Convert.ToString(idr["AwbStatus"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                SaleManID = Convert.ToString(idr["SaleManID"]),
                                SaleManName = Convert.ToString(idr["SaleManName"]),
                                HouseID = string.IsNullOrEmpty(Convert.ToString(idr["HouseID"])) ? 0 : Convert.ToInt32(idr["HouseID"]),
                                CreateAwbID = Convert.ToString(idr["CreateAwbID"]),
                                OrderType = Convert.ToString(idr["OrderType"]),
                                FinanceSecondCheck = Convert.ToString(idr["FinanceSecondCheck"]),
                                FinanceSecondCheckName = Convert.ToString(idr["FinanceSecondCheckName"]),
                                FinanceSecondCheckDate = string.IsNullOrEmpty(Convert.ToString(idr["FinanceSecondCheckDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["FinanceSecondCheckDate"]),
                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                ClientNum = string.IsNullOrEmpty(Convert.ToString(idr["ClientNum"])) ? 0 : Convert.ToInt32(idr["ClientNum"]),
                                WXOrderNo = Convert.ToString(idr["WXOrderNo"]),
                                ThrowGood = Convert.ToString(idr["ThrowGood"]),
                                TranHouse = Convert.ToString(idr["TranHouse"]),
                                OutHouseName = Convert.ToString(idr["OutHouseName"]),
                                ModifyPriceStatus = Convert.ToString(idr["ModifyPriceStatus"]),
                                PayClientNum = string.IsNullOrEmpty(Convert.ToString(idr["PayClientNum"])) ? 0 : Convert.ToInt32(idr["PayClientNum"]),
                                PayClientName = Convert.ToString(idr["PayClientName"]),
                                BelongHouse = Convert.ToString(idr["BelongHouse"]),
                                IsPrintPrice = string.IsNullOrEmpty(Convert.ToString(idr["IsPrintPrice"])) ? (byte)0 : Convert.ToByte(idr["IsPrintPrice"]),
                                AccountNo = Convert.ToString(idr["AccountNo"]),
                                PostponeShip = Convert.ToString(idr["PostponeShip"]),
                                OutCargoTime = string.IsNullOrEmpty(Convert.ToString(idr["OutCargoTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["OutCargoTime"]),
                                DeliverySettlement = Convert.ToString(idr["DeliverySettlement"]),
                                OrderAging = Convert.ToString(idr["OrderAging"]),
                                PrintNum = string.IsNullOrEmpty(Convert.ToString(idr["PrintNum"])) ? 0 : Convert.ToInt32(idr["PrintNum"]),
                                PollStatus = Convert.ToString(idr["PollStatus"]),
                                CheckDate = string.IsNullOrEmpty(Convert.ToString(idr["CheckDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["CheckDate"]),
                                PickStatus = string.IsNullOrEmpty(Convert.ToString(idr["PickStatus"])) ? (byte)0 : Convert.ToByte(idr["PickStatus"]),
                                LineID = string.IsNullOrEmpty(Convert.ToString(idr["LineID"])) ? 0 : Convert.ToInt32(idr["LineID"]),
                                LineName = Convert.ToString(idr["LineName"]),
                                ShopCode = Convert.ToString(idr["ShopCode"]),
                                SuppClientNum = string.IsNullOrEmpty(Convert.ToString(idr["SuppClientNum"])) ? 0 : Convert.ToInt32(idr["SuppClientNum"]),
                                CollectMoney = string.IsNullOrEmpty(Convert.ToString(idr["CollectMoney"])) ? 0m : Convert.ToDecimal(idr["CollectMoney"]),
                                PlanOrderNo = Convert.ToString(idr["PlanOrderNo"]),
                                TakeOrderName = Convert.ToString(idr["TakeOrderName"]),
                                TakeOrderTime = string.IsNullOrEmpty(Convert.ToString(idr["TakeOrderTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["TakeOrderTime"]),
                                SendCarName = Convert.ToString(idr["SendCarName"]),
                                SendCarTime = string.IsNullOrEmpty(Convert.ToString(idr["SendCarTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["SendCarTime"]),
                                OpenOrderNo = Convert.ToString(idr["OpenOrderNo"]),
                                OpenOrderSource = Convert.ToString(idr["OpenOrderSource"]),
                                BusinessID = Convert.ToString(idr["BusinessID"]),
                                OverDueFee = string.IsNullOrEmpty(Convert.ToString(idr["OverDueFee"])) ? 0m : Convert.ToDecimal(idr["OverDueFee"]),
                                OpenExpressName = Convert.ToString(idr["OpenExpressName"]),
                                OpenExpressNum = Convert.ToString(idr["OpenExpressNum"]),
                                CouponType = Convert.ToString(idr["CouponType"]),
                                DeliveryDriverName = Convert.ToString(idr["DeliveryDriverName"]),
                                DriverIDNum = Convert.ToString(idr["DriverIDNum"]),
                                DriverCellphone = Convert.ToString(idr["DriverCellphone"]),
                                DriverCarNum = Convert.ToString(idr["DriverCarNum"]),
                                IsSupplierType = string.IsNullOrEmpty(Convert.ToString(idr["IsSupplierType"])) ? 0 : Convert.ToInt32(idr["IsSupplierType"]),
                                IsHouseType = string.IsNullOrEmpty(Convert.ToString(idr["IsHouseType"])) ? 0 : Convert.ToInt32(idr["IsHouseType"]),
                                IsTransitFee = string.IsNullOrEmpty(Convert.ToString(idr["IsTransitFee"])) ? 0 : Convert.ToInt32(idr["IsTransitFee"]),
                                ShareHouseID = string.IsNullOrEmpty(Convert.ToString(idr["ShareHouseID"])) ? 0 : Convert.ToInt32(idr["ShareHouseID"]),
                                ShareHouseName = Convert.ToString(idr["ShareHouseName"]),
                                OrignHouseID = string.IsNullOrEmpty(Convert.ToString(idr["OrignHouseID"])) ? 0 : Convert.ToInt32(idr["OrignHouseID"]),
                                OrignHouseName = Convert.ToString(idr["OrignHouseName"]),
                                BateAmount = string.IsNullOrEmpty(Convert.ToString(idr["BateAmount"])) ? 0m : Convert.ToDecimal(idr["BateAmount"]),
                                OnlinePaidAmount = string.IsNullOrEmpty(Convert.ToString(idr["OnlinePaidAmount"])) ? 0m : Convert.ToDecimal(idr["OnlinePaidAmount"])

                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        public List<OrderHeader> QueryCallMallOrderList(string entity)
        {
            List<OrderHeader> result = new List<OrderHeader>();
            try
            {
                string strSQL = $@"
                    select a.*,b.companyName as AconsigneeName,c.ReceiverName,c.address
                      from Tbl_Cargo_CassMallOrder as a
                               inner join Tbl_Cargo_CassMallOrderBuyer as b on a.CID = b.CID
                      inner join Tbl_Cargo_CassMallOrderPostalAddress as c on a.orderId=c.orderId
                      where 1 = 1  and statusId<>'ORDER_CANCELLED' and a.orderId='{entity}'";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new OrderHeader
                            {
                                CID = Convert.ToInt64(idr["CID"]),
                                OrderId = Convert.ToString(idr["orderId"]),
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        #endregion

        #region 系统数据处理
        /// <summary>
        /// 处理系统自有和进驻的数据
        /// </summary>
        public void HandleGoodsClassData()
        {
            string strSQL = "update Tbl_Cargo_Product set GoodsClass=0 where GoodsClass!=0 and SuppClientNum in (select ClientNum from Tbl_Cargo_Client where UpClientID=1 and ClientType=4)";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.ExecuteNonQuery(cmd);
            }


            string strSQLOut = "update Tbl_Cargo_Product set GoodsClass=1 where GoodsClass!=1 and SuppClientNum in (100143,980873,982170,394992,270319,484582,349629,989827,832291,958950,630009,172833,251253,643493,307811)";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQLOut))
            {
                conn.ExecuteNonQuery(cmd);
            }
        }
        #endregion
    }
}
