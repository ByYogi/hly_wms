using House.DataAccess;
using House.Entity.Cargo;
using House.Entity.Cargo.Product;
using House.Entity.House;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Linq;
using System.Reflection;
using System.Security.Cryptography.X509Certificates;
using System.Text;

namespace House.Manager.Cargo
{
    /// <summary>
    /// 客户管理数据操作类
    /// </summary>
    public class CargoClientManager
    {
        private SqlHelper conn = new SqlHelper();

        #region 客户管理操作方法集合
        /// <summary>
        /// 判断是否存在相同的客户名称
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistCargoClient(CargoClientEntity entity)
        {
            string strQ = @"Select ClientShortName from Tbl_Cargo_Client Where HouseID=@HouseID and ( Boss=@Boss";
            if (!string.IsNullOrEmpty(entity.ClientShortName))
            {
                strQ += " or ClientShortName=@ClientShortName ";
            }
            //2021-01-13 去除客户添加/修改手机号码重复验证
            //if (!string.IsNullOrEmpty(entity.Cellphone))
            //{
            //    strQ += " or Cellphone=@Cellphone ";
            //}
            strQ += " )";
            if (entity.ClientID != 0)
            {
                strQ += " and ClientID!=@ClientID";
            }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                if (!string.IsNullOrEmpty(entity.ClientShortName))
                {
                    conn.AddInParameter(cmdQ, "@ClientShortName", DbType.String, entity.ClientShortName);
                }
                conn.AddInParameter(cmdQ, "@Boss", DbType.String, entity.Boss);
                //2021-01-13 去除客户添加/修改手机号码重复验证
                //if (!string.IsNullOrEmpty(entity.Cellphone))
                //{
                //    conn.AddInParameter(cmdQ, "@Cellphone", DbType.String, entity.Cellphone);
                //}
                if (entity.ClientID != 0)
                {
                    conn.AddInParameter(cmdQ, "@ClientID", DbType.String, entity.ClientID);
                }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 判断是否存在相同的客户编码
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistCargoClientNum(CargoClientEntity entity)
        {
            string strQ = @"Select ClientNum from Tbl_Cargo_Client Where ClientNum=@ClientNum";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ClientNum", DbType.Int32, entity.ClientNum);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 客户数据查询
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <param name="strCountWhere">查询总数的查询条件</param>
        /// <returns></returns>
        public Hashtable QueryCargoClient(int pIndex, int pNum, CargoClientEntity entity)
        {
            List<CargoClientEntity> result = new List<CargoClientEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.*,b.Name as HouseName,stuff((select ','+AcceptPeople from Tbl_Cargo_AcceptAddress where ClientID=a.ClientID for xml path('')),1,1,'') as AcceptPeople,ISNULL(d.LineName,'') as LineName FROM Tbl_Cargo_Client as a left join Tbl_Cargo_House as b on a.HouseID=b.HouseID left join Tbl_Cargo_LogisLineClient as c on a.ClientID=c.ClientID left join Tbl_Cargo_LogisLine as d on c.LineID=d.LineID WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strSQL += " and a.DelFlag = '" + entity.DelFlag + "'"; }
                if (!string.IsNullOrEmpty(entity.ArrivePayLimit)) { strSQL += " and a.ArrivePayLimit = '" + entity.ArrivePayLimit + "'"; }
                if (!string.IsNullOrEmpty(entity.ClientType)) { strSQL += " and a.ClientType = '" + entity.ClientType + "'"; }
                if (!string.IsNullOrEmpty(entity.Province)) { strSQL += " and a.Province = '" + entity.Province + "'"; }
                if (!string.IsNullOrEmpty(entity.City)) { strSQL += " and a.City = '" + entity.City + "'"; }
                if (!string.IsNullOrEmpty(entity.ShopCode)) { strSQL += " and a.ShopCode = '" + entity.ShopCode + "'"; }
                //以名称为查询条件
                if (!string.IsNullOrEmpty(entity.ClientName)) { strSQL += " and (a.ClientName like '%" + entity.ClientName + "%' or a.ClientShortName like '%" + entity.ClientName + "%')"; }
                if (!string.IsNullOrEmpty(entity.ClientShortName)) { strSQL += " and a.ClientShortName like '%" + entity.ClientShortName + "%'"; }
                if (!string.IsNullOrEmpty(entity.Boss)) { strSQL += " and a.Boss like '%" + entity.Boss + "%'"; }
                if (!string.IsNullOrEmpty(entity.Telephone)) { strSQL += " and a.Telephone like '%" + entity.Telephone + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strSQL += " and a.Cellphone like '%" + entity.Cellphone + "%'"; }
                if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum = " + entity.ClientNum; }
                if (!entity.UpClientID.Equals(0)) { strSQL += " and a.UpClientID = " + entity.UpClientID; }
                if (!string.IsNullOrEmpty(entity.UserID)) { strSQL += " and a.UserID = '" + entity.UserID + "'"; }
                if (!string.IsNullOrEmpty(entity.PushAccount)) { strSQL += " and a.PushAccount = '" + entity.PushAccount + "'"; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strSQL += " and AcceptPeople like '%" + entity.AcceptPeople + "%'"; }
                strSQL += " order by RowNumber asc";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoClientEntity
                            {
                                ClientID = Convert.ToInt64(idr["ClientID"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                ClientShortName = Convert.ToString(idr["ClientShortName"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                Address = Convert.ToString(idr["Address"]),
                                Boss = Convert.ToString(idr["Boss"]),
                                ClientType = Convert.ToString(idr["ClientType"]),
                                Email = Convert.ToString(idr["Email"]),
                                Fax = Convert.ToString(idr["Fax"]),
                                Product = Convert.ToString(idr["Product"]),
                                Province = Convert.ToString(idr["Province"]),
                                Country = Convert.ToString(idr["Country"]),
                                Telephone = Convert.ToString(idr["Telephone"]),
                                ZipCode = Convert.ToString(idr["ZipCode"]),
                                DelFlag = Convert.ToString(idr["DelFlag"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                ClientTypeID = Convert.ToString(idr["ClientTypeID"]),
                                ClientTypeName = Convert.ToString(idr["ClientTypeName"]),
                                SettleHouseID = Convert.ToString(idr["SettleHouseID"]),
                                SettleHouseName = Convert.ToString(idr["SettleHouseName"]),
                                City = Convert.ToString(idr["City"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ShopCode = Convert.ToString(idr["ShopCode"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                UserName = Convert.ToString(idr["UserName"]),
                                BusUserID = Convert.ToString(idr["BusUserID"]),
                                BusUserName = Convert.ToString(idr["BusUserName"]),
                                LogisID = Convert.ToInt32(idr["LogisID"]),
                                LogisName = Convert.ToString(idr["LogisName"]),
                                PreReceiveMoney = string.IsNullOrEmpty(Convert.ToString(idr["PreReceiveMoney"])) ? 0 : Convert.ToDecimal(idr["PreReceiveMoney"]),
                                RebateMoney = string.IsNullOrEmpty(Convert.ToString(idr["RebateMoney"])) ? 0 : Convert.ToDecimal(idr["RebateMoney"]),
                                LogisFee = string.IsNullOrEmpty(Convert.ToString(idr["LogisFee"])) ? 0 : Convert.ToDecimal(idr["LogisFee"]),
                                LimitMoney = string.IsNullOrEmpty(Convert.ToString(idr["LimitMoney"])) ? 0 : Convert.ToDecimal(idr["LimitMoney"]),
                                TargetNum = string.IsNullOrEmpty(Convert.ToString(idr["TargetNum"])) ? 0 : Convert.ToInt32(idr["TargetNum"]),
                                TryeClientCode = Convert.ToString(idr["TryeClientCode"]),
                                TryeCompany = Convert.ToString(idr["TryeCompany"]),
                                TryeClientType = Convert.ToString(idr["TryeClientType"]),
                                PushAccount = Convert.ToString(idr["PushAccount"]),
                                BookCheck = Convert.ToString(idr["BookCheck"]),
                                AddData = Convert.ToString(idr["AddData"]),
                                CheckOutType = Convert.ToString(idr["CheckOutType"]),
                                Discount = Convert.ToDecimal(idr["Discount"]),
                                LineName = Convert.ToString(idr["LineName"]),
                                //AreaName = Convert.ToString(idr["AreaName"]),
                                UpClientShortName = Convert.ToString(idr["UpClientShortName"]),
                                GroundPushName = Convert.ToString(idr["GroundPushName"]),
                                UpClientID = Convert.ToInt32(idr["UpClientID"]),
                                ArrivePayLimit = Convert.ToString(idr["ArrivePayLimit"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"select count(*) as TotalCount from ( Select a.ClientNum, stuff((select ',' + AcceptPeople from Tbl_Cargo_AcceptAddress where ClientID = a.ClientID for xml path('')), 1, 1, '') as AcceptPeople  from Tbl_Cargo_Client as a left join Tbl_Cargo_House as b on a .HouseID = b.HouseID Where(1 = 1)";
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strCount += " and a.DelFlag = '" + entity.DelFlag + "'"; }
                if (!string.IsNullOrEmpty(entity.ArrivePayLimit)) { strCount += " and a.ArrivePayLimit = '" + entity.ArrivePayLimit + "'"; }
                if (!string.IsNullOrEmpty(entity.ClientType)) { strCount += " and a.ClientType = '" + entity.ClientType + "'"; }
                if (!string.IsNullOrEmpty(entity.Province)) { strCount += " and a.Province = '" + entity.Province + "'"; }
                if (!string.IsNullOrEmpty(entity.City)) { strCount += " and a.City = '" + entity.City + "'"; }
                if (!string.IsNullOrEmpty(entity.ShopCode)) { strCount += " and a.ShopCode = '" + entity.ShopCode + "'"; }
                //以名称为查询条件
                if (!string.IsNullOrEmpty(entity.ClientName)) { strCount += " and a.ClientName like '%" + entity.ClientName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ClientShortName)) { strCount += " and a.ClientShortName like '%" + entity.ClientShortName + "%'"; }
                if (!string.IsNullOrEmpty(entity.Boss)) { strCount += " and a.Boss like '%" + entity.Boss + "%'"; }
                if (!string.IsNullOrEmpty(entity.Telephone)) { strCount += " and a.Telephone like '%" + entity.Telephone + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strCount += " and a.Cellphone like '%" + entity.Cellphone + "%'"; }
                if (!entity.ClientNum.Equals(0)) { strCount += " and a.ClientNum = " + entity.ClientNum; }
                if (!entity.UpClientID.Equals(0)) { strCount += " and a.UpClientID = " + entity.UpClientID; }
                if (!string.IsNullOrEmpty(entity.UserID)) { strCount += " and a.UserID = '" + entity.UserID + "'"; }
                if (!string.IsNullOrEmpty(entity.PushAccount)) { strCount += " and a.PushAccount = '" + entity.PushAccount + "'"; }
                strCount += ")A";
                if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strCount += " where A.AcceptPeople like '%" + entity.AcceptPeople + "%'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        public CargoClientEntity QueryCargoClientEntity(CargoClientEntity entity)
        {
            CargoClientEntity result = new CargoClientEntity();
            string strSQL = "Select * From Tbl_Cargo_Client Where (1=1)";
            if (!entity.ClientNum.Equals(0))
            {
                strSQL += " and ClientNum=" + entity.ClientNum;
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result = new CargoClientEntity
                        {
                            ClientID = Convert.ToInt64(idr["ClientID"]),
                            ClientNum = Convert.ToInt32(idr["ClientNum"]),
                            ClientName = Convert.ToString(idr["ClientName"]),
                            ClientShortName = Convert.ToString(idr["ClientShortName"]),
                            Cellphone = Convert.ToString(idr["Cellphone"]),
                            Address = Convert.ToString(idr["Address"]),
                            Boss = Convert.ToString(idr["Boss"]),
                            ClientType = Convert.ToString(idr["ClientType"]),
                            Email = Convert.ToString(idr["Email"]),
                            Fax = Convert.ToString(idr["Fax"]),
                            Product = Convert.ToString(idr["Product"]),
                            Province = Convert.ToString(idr["Province"]),
                            Country = Convert.ToString(idr["Country"]),
                            Telephone = Convert.ToString(idr["Telephone"]),
                            ZipCode = Convert.ToString(idr["ZipCode"]),
                            DelFlag = Convert.ToString(idr["DelFlag"]),
                            Remark = Convert.ToString(idr["Remark"]),
                            ClientTypeID = Convert.ToString(idr["ClientTypeID"]),
                            ClientTypeName = Convert.ToString(idr["ClientTypeName"]),
                            SettleHouseID = Convert.ToString(idr["SettleHouseID"]),
                            SettleHouseName = Convert.ToString(idr["SettleHouseName"]),
                            City = Convert.ToString(idr["City"]),
                            //HouseName = Convert.ToString(idr["HouseName"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            ShopCode = Convert.ToString(idr["ShopCode"]),
                            UserID = Convert.ToString(idr["UserID"]),
                            UserName = Convert.ToString(idr["UserName"]),
                            BusUserID = Convert.ToString(idr["BusUserID"]),
                            BusUserName = Convert.ToString(idr["BusUserName"]),
                            LogisID = Convert.ToInt32(idr["LogisID"]),
                            LogisName = Convert.ToString(idr["LogisName"]),
                            PreReceiveMoney = string.IsNullOrEmpty(Convert.ToString(idr["PreReceiveMoney"])) ? 0 : Convert.ToDecimal(idr["PreReceiveMoney"]),
                            RebateMoney = string.IsNullOrEmpty(Convert.ToString(idr["RebateMoney"])) ? 0 : Convert.ToDecimal(idr["RebateMoney"]),
                            LogisFee = string.IsNullOrEmpty(Convert.ToString(idr["LogisFee"])) ? 0 : Convert.ToDecimal(idr["LogisFee"]),
                            LimitMoney = string.IsNullOrEmpty(Convert.ToString(idr["LimitMoney"])) ? 0 : Convert.ToDecimal(idr["LimitMoney"]),
                            TargetNum = string.IsNullOrEmpty(Convert.ToString(idr["TargetNum"])) ? 0 : Convert.ToInt32(idr["TargetNum"]),
                            TryeClientCode = Convert.ToString(idr["TryeClientCode"]),
                            TryeCompany = Convert.ToString(idr["TryeCompany"]),
                            TryeClientType = Convert.ToString(idr["TryeClientType"]),
                            PushAccount = Convert.ToString(idr["PushAccount"]),
                            BookCheck = Convert.ToString(idr["BookCheck"]),
                            AddData = Convert.ToString(idr["AddData"]),
                            CheckOutType = Convert.ToString(idr["CheckOutType"]),
                            Discount = Convert.ToDecimal(idr["Discount"]),
                            // LineName = Convert.ToString(idr["LineName"]),
                            //AreaName = Convert.ToString(idr["AreaName"]),
                            UpClientShortName = Convert.ToString(idr["UpClientShortName"]),
                            GroundPushName = Convert.ToString(idr["GroundPushName"]),
                            UpClientID = Convert.ToInt32(idr["UpClientID"]),
                            ArrivePayLimit = Convert.ToString(idr["ArrivePayLimit"]),
                            BizUserId = Convert.ToString(idr["BizUserId"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                        };
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询客户数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoClientEntity> QueryCargoClientList(CargoClientEntity entity)
        {
            List<CargoClientEntity> result = new List<CargoClientEntity>();
            string strSQL = "Select * From Tbl_Cargo_Client Where (1=1)";
            if (!string.IsNullOrEmpty(entity.DelFlag)) { strSQL += " and DelFlag='" + entity.DelFlag + "'"; }
            if (!string.IsNullOrEmpty(entity.PushAccount)) { strSQL += " and PushAccount='" + entity.PushAccount + "'"; }
            if (!string.IsNullOrEmpty(entity.HouseIDStr)) { strSQL += " and HouseID in (" + entity.HouseIDStr + ")"; }
            if (!string.IsNullOrEmpty(entity.TryeClientCode)) { strSQL += " and TryeClientCode='" + entity.TryeClientCode + "'"; }
            if (!string.IsNullOrEmpty(entity.ClientType)) { strSQL += " and ClientType='" + entity.ClientType + "'"; }
            if (!string.IsNullOrEmpty(entity.ClientName)) { strSQL += " and ClientName='" + entity.ClientName + "'"; }
            if (!entity.UpClientID.Equals(0)) { strSQL += " and UpClientID=" + entity.UpClientID; }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoClientEntity
                        {
                            ClientID = Convert.ToInt64(idr["ClientID"]),
                            ClientNum = Convert.ToInt32(idr["ClientNum"]),
                            ClientName = Convert.ToString(idr["ClientName"]),
                            ClientShortName = Convert.ToString(idr["ClientShortName"]),
                            Boss = Convert.ToString(idr["Boss"]),
                            Telephone = Convert.ToString(idr["Telephone"]),
                            Cellphone = Convert.ToString(idr["Cellphone"]),
                            Address = Convert.ToString(idr["Address"]),
                            UserID = Convert.ToString(idr["UserID"]),
                            UserName = Convert.ToString(idr["UserName"]),
                            BusUserID = Convert.ToString(idr["BusUserID"]),
                            BusUserName = Convert.ToString(idr["BusUserName"]),
                            Bank = Convert.ToString(idr["Bank"]),
                            CardName = Convert.ToString(idr["CardName"]),
                            CardNum = Convert.ToString(idr["CardNum"]),
                            ShopCode = Convert.ToString(idr["ShopCode"]),
                            ClientType = Convert.ToString(idr["ClientType"]),
                            City = Convert.ToString(idr["City"]),
                            PushAccount = Convert.ToString(idr["PushAccount"]),
                            CheckOutType = Convert.ToString(idr["CheckOutType"]),
                            Discount = Convert.ToDecimal(idr["Discount"]),
                            Latitude = Convert.ToString(idr["Latitude"]),
                            Longitude = Convert.ToString(idr["Longitude"])
                            //AcceptAddress = listAcceptAddress
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 删除客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoClient(List<CargoClientEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"UPDATE Tbl_Cargo_Client SET DelFlag='1' WHERE ClientID=@ClientID";
                    if (it.DelFlag.Equals("1"))//彻底删除
                    {
                        strSQL = @"Delete from Tbl_Cargo_Client where ClientID=@ClientID ";
                    }
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ClientID", DbType.Int64, it.ClientID);
                        conn.ExecuteNonQuery(cmd);
                    }

                    if (it.DelFlag.Equals("1"))
                    {
                        DelCargoClientProductType(new CargoClientTypeIDEntity { ClientID = it.ClientID });
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 新增客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoClient(CargoClientEntity entity)
        {
            long did = 0;

            string strSQL = @"INSERT INTO Tbl_Cargo_Client(ClientNum,ClientName,ClientShortName,ClientType,Address,ZipCode,Telephone,Fax,Boss,Cellphone,Email,Product,OP_DATE,Remark,DelFlag,ClientTypeID,ClientTypeName,City,Province,Country,HouseID,UserID,UserName,LimitMoney,TargetNum,ShopCode,TryeClientCode,TryeCompany,TryeClientType,LogisID,LogisName,LogisFee,PushAccount,BookCheck,AddData,CheckOutType,BusUserID,BusUserName,Discount,UpClientID,UpClientShortName,SettleHouseID,SettleHouseName,GroundPushName,ArrivePayLimit) VALUES (@ClientNum,@ClientName,@ClientShortName,@ClientType,@Address,@ZipCode,@Telephone,@Fax,@Boss,@Cellphone,@Email,@Product,@OP_DATE,@Remark,@DelFlag,@ClientTypeID,@ClientTypeName,@City,@Province,@Country,@HouseID,@UserID,@UserName,@LimitMoney,@TargetNum,@ShopCode,@TryeClientCode,@TryeCompany,@TryeClientType,@LogisID,@LogisName,@LogisFee,@PushAccount,@BookCheck,@AddData,@CheckOutType,@BusUserID,@BusUserName,@Discount,@UpClientID,@UpClientShortName,@SettleHouseID,@SettleHouseName,@GroundPushName,@ArrivePayLimit)  SELECT @@IDENTITY";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@UpClientID", DbType.Int32, entity.UpClientID);
                    conn.AddInParameter(cmd, "@ClientName", DbType.String, entity.ClientName);
                    conn.AddInParameter(cmd, "@UpClientShortName", DbType.String, entity.UpClientShortName);
                    conn.AddInParameter(cmd, "@ClientShortName", DbType.String, entity.ClientShortName);
                    conn.AddInParameter(cmd, "@ClientType", DbType.String, entity.ClientType);
                    conn.AddInParameter(cmd, "@Address", DbType.String, entity.Address);
                    conn.AddInParameter(cmd, "@ZipCode", DbType.String, entity.ZipCode);
                    conn.AddInParameter(cmd, "@Telephone", DbType.String, entity.Telephone);
                    conn.AddInParameter(cmd, "@Fax", DbType.String, entity.Fax);
                    conn.AddInParameter(cmd, "@Boss", DbType.String, entity.Boss);
                    conn.AddInParameter(cmd, "@Cellphone", DbType.String, entity.Cellphone);
                    conn.AddInParameter(cmd, "@Email", DbType.String, entity.Email);
                    conn.AddInParameter(cmd, "@Product", DbType.String, entity.Product);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@ClientTypeID", DbType.String, entity.ClientTypeID);
                    conn.AddInParameter(cmd, "@ClientTypeName", DbType.String, entity.ClientTypeName);
                    conn.AddInParameter(cmd, "@SettleHouseID", DbType.String, entity.SettleHouseID);
                    conn.AddInParameter(cmd, "@SettleHouseName", DbType.String, entity.SettleHouseName);
                    conn.AddInParameter(cmd, "@City", DbType.String, entity.City);
                    conn.AddInParameter(cmd, "@Province", DbType.String, entity.Province);
                    conn.AddInParameter(cmd, "@Country", DbType.String, entity.Country);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@UserID", DbType.String, entity.UserID);
                    conn.AddInParameter(cmd, "@UserName", DbType.String, entity.UserName);
                    conn.AddInParameter(cmd, "@LimitMoney", DbType.Decimal, entity.LimitMoney);
                    conn.AddInParameter(cmd, "@TargetNum", DbType.Int32, entity.TargetNum);
                    conn.AddInParameter(cmd, "@ShopCode", DbType.String, entity.ShopCode);
                    conn.AddInParameter(cmd, "@TryeClientCode", DbType.String, entity.TryeClientCode);
                    conn.AddInParameter(cmd, "@TryeCompany", DbType.String, entity.TryeCompany);
                    conn.AddInParameter(cmd, "@TryeClientType", DbType.String, entity.TryeClientType);
                    conn.AddInParameter(cmd, "@LogisName", DbType.String, entity.LogisName);
                    conn.AddInParameter(cmd, "@LogisID", DbType.Int32, entity.LogisID);
                    conn.AddInParameter(cmd, "@LogisFee", DbType.Decimal, entity.LogisFee);
                    conn.AddInParameter(cmd, "@PushAccount", DbType.String, entity.PushAccount);
                    conn.AddInParameter(cmd, "@CheckOutType", DbType.String, entity.CheckOutType);
                    conn.AddInParameter(cmd, "@BookCheck", DbType.String, entity.BookCheck);
                    conn.AddInParameter(cmd, "@AddData", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@BusUserID", DbType.String, entity.BusUserID);
                    conn.AddInParameter(cmd, "@BusUserName", DbType.String, entity.BusUserName);
                    conn.AddInParameter(cmd, "@Discount", DbType.Decimal, entity.Discount);
                    conn.AddInParameter(cmd, "@GroundPushName", DbType.String, entity.GroundPushName);
                    conn.AddInParameter(cmd, "@ArrivePayLimit", DbType.String, entity.ArrivePayLimit);
                    //conn.ExecuteNonQuery(cmd);
                    did = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
                //新增客户收货人数据表
                AddAcceptAddress(new CargoClientAcceptAddressEntity
                {
                    ClientID = did,
                    ClientNum = entity.ClientNum,
                    HouseID = entity.HouseID,
                    AcceptAddress = entity.Address,
                    AcceptPeople = entity.Boss,
                    AcceptCellphone = entity.Cellphone,
                    AcceptTelephone = entity.Telephone,
                    AcceptCity = entity.City,
                    AcceptCompany = entity.ClientShortName,
                    AcceptCountry = entity.Country,
                    AcceptProvince = entity.Province,
                    TryeCompany = entity.TryeCompany,
                    TryeClientCode = entity.TryeClientCode,
                    TryeClientType = entity.TryeClientType,
                    TargetNum = entity.TargetNum,
                    Latitude = entity.Latitude,
                    Longitude = entity.Longitude
                });
                if (entity.ClientType.Equals("2"))
                {
                    UpdateSpecialCodeStatus(new CargoSpecialVIPNumEntity { ClientNum = entity.ClientNum });
                }
                DelCargoClientProductType(new CargoClientTypeIDEntity { ClientID = did });
                //保存客户与产品分类关系表
                if (!string.IsNullOrEmpty(entity.ClientTypeID))
                {
                    List<CargoClientTypeIDEntity> ctype = new List<CargoClientTypeIDEntity>();
                    string[] tid = entity.ClientTypeID.Split(',');
                    for (int i = 0; i < tid.Length; i++)
                    {
                        ctype.Add(new CargoClientTypeIDEntity
                        {
                            ClientID = did,
                            TypeID = Convert.ToInt32(tid[i])
                        });
                    }
                    AddClientProduct(ctype);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }
        /// <summary>
        /// 修改客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoClient(CargoClientEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Client SET ClientNum = @ClientNum,ClientName = @ClientName,ClientShortName = @ClientShortName,ClientType = @ClientType,Address = @Address,ZipCode = @ZipCode,Telephone = @Telephone,Fax = @Fax,Boss = @Boss,Cellphone = @Cellphone,Email = @Email,Product = @Product,DelFlag = @DelFlag,OP_DATE = @OP_DATE,Remark = @Remark,ClientTypeID=@ClientTypeID,ClientTypeName=@ClientTypeName,City=@City,Province=@Province,HouseID=@HouseID,LimitMoney=@LimitMoney,TargetNum=@TargetNum,ShopCode=@ShopCode,UserID=@UserID,UserName=@UserName,TryeClientCode=@TryeClientCode,TryeCompany=@TryeCompany,LogisID=@LogisID,LogisName=@LogisName,LogisFee=@LogisFee,TryeClientType=@TryeClientType,Country=@Country,PushAccount=@PushAccount,CheckOutType=@CheckOutType,BusUserID=@BusUserID,BusUserName=@BusUserName,Discount=@Discount,UpClientID=@UpClientID,UpClientShortName=@UpClientShortName,SettleHouseID=@SettleHouseID,SettleHouseName=@SettleHouseName,GroundPushName=@GroundPushName,ArrivePayLimit=@ArrivePayLimit WHERE ClientID=@ClientID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ShopCode", DbType.String, entity.ShopCode);
                    conn.AddInParameter(cmd, "@UpClientShortName", DbType.String, entity.UpClientShortName);
                    conn.AddInParameter(cmd, "@UpClientID", DbType.Int32, entity.UpClientID);
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@ClientName", DbType.String, entity.ClientName);
                    conn.AddInParameter(cmd, "@ClientShortName", DbType.String, entity.ClientShortName);
                    conn.AddInParameter(cmd, "@ClientType", DbType.String, entity.ClientType);
                    conn.AddInParameter(cmd, "@Address", DbType.String, entity.Address);
                    conn.AddInParameter(cmd, "@ZipCode", DbType.String, entity.ZipCode);
                    conn.AddInParameter(cmd, "@Telephone", DbType.String, entity.Telephone);
                    conn.AddInParameter(cmd, "@Fax", DbType.String, entity.Fax);
                    conn.AddInParameter(cmd, "@Boss", DbType.String, entity.Boss);
                    conn.AddInParameter(cmd, "@Cellphone", DbType.String, entity.Cellphone);
                    conn.AddInParameter(cmd, "@Email", DbType.String, entity.Email);
                    conn.AddInParameter(cmd, "@Product", DbType.String, entity.Product);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@ClientID", DbType.Int64, entity.ClientID);
                    conn.AddInParameter(cmd, "@ClientTypeID", DbType.String, entity.ClientTypeID);
                    conn.AddInParameter(cmd, "@ClientTypeName", DbType.String, entity.ClientTypeName);
                    conn.AddInParameter(cmd, "@SettleHouseID", DbType.String, entity.SettleHouseID);
                    conn.AddInParameter(cmd, "@SettleHouseName", DbType.String, entity.SettleHouseName);
                    conn.AddInParameter(cmd, "@City", DbType.String, entity.City);
                    conn.AddInParameter(cmd, "@Province", DbType.String, entity.Province);
                    conn.AddInParameter(cmd, "@Country", DbType.String, entity.Country);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@LimitMoney", DbType.Decimal, entity.LimitMoney);
                    conn.AddInParameter(cmd, "@TargetNum", DbType.Int32, entity.TargetNum);
                    conn.AddInParameter(cmd, "@UserID", DbType.String, entity.UserID);
                    conn.AddInParameter(cmd, "@UserName", DbType.String, entity.UserName);
                    conn.AddInParameter(cmd, "@TryeClientCode", DbType.String, entity.TryeClientCode);
                    conn.AddInParameter(cmd, "@TryeCompany", DbType.String, entity.TryeCompany);
                    conn.AddInParameter(cmd, "@TryeClientType", DbType.String, entity.TryeClientType);
                    conn.AddInParameter(cmd, "@LogisName", DbType.String, entity.LogisName);
                    conn.AddInParameter(cmd, "@LogisID", DbType.Int32, entity.LogisID);
                    conn.AddInParameter(cmd, "@LogisFee", DbType.Decimal, entity.LogisFee);
                    conn.AddInParameter(cmd, "@PushAccount", DbType.String, entity.PushAccount);
                    conn.AddInParameter(cmd, "@CheckOutType", DbType.String, entity.CheckOutType);
                    conn.AddInParameter(cmd, "@BusUserID", DbType.String, entity.BusUserID);
                    conn.AddInParameter(cmd, "@BusUserName", DbType.String, entity.BusUserName);
                    conn.AddInParameter(cmd, "@Discount", DbType.Decimal, entity.Discount);
                    conn.AddInParameter(cmd, "@GroundPushName", DbType.String, entity.GroundPushName);
                    conn.AddInParameter(cmd, "@ArrivePayLimit", DbType.String, entity.ArrivePayLimit);
                    conn.ExecuteNonQuery(cmd);
                }

                if (entity.ClientType.Equals("2"))
                {
                    UpdateSpecialCodeStatus(new CargoSpecialVIPNumEntity { ClientNum = entity.ClientNum });
                }

                DelCargoClientProductType(new CargoClientTypeIDEntity { ClientID = entity.ClientID });
                //保存客户与产品分类关系表
                if (!string.IsNullOrEmpty(entity.ClientTypeID))
                {
                    List<CargoClientTypeIDEntity> ctype = new List<CargoClientTypeIDEntity>();
                    string[] tid = entity.ClientTypeID.Split(',');
                    for (int i = 0; i < tid.Length; i++)
                    {
                        ctype.Add(new CargoClientTypeIDEntity
                        {
                            ClientID = entity.ClientID,
                            TypeID = Convert.ToInt32(tid[i])
                        });
                    }
                    AddClientProduct(ctype);
                }
                if (entity.HouseID.Equals(46))
                {
                    //四川仓库特殊处理配送物流
                    CargoWeiXinManager wxman = new CargoWeiXinManager();
                    wxman.UpdateWxUserLogicNameByClientNum(new WXUserEntity { ClientNum = entity.ClientNum, LogisID = entity.LogisID, LogicName = entity.LogisName });
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void UpdateClentMoney(CargoClientEntity entity)
        {
            try
            {
                entity.EnSafe();
                string strSQL = @"UPDATE Tbl_Cargo_Client SET LimitMoney=@LimitMoney,TargetNum=@TargetNum WHERE ClientNum=@ClientNum and HouseID=@HouseID";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@TargetNum", DbType.String, entity.TargetNum);
                    conn.AddInParameter(cmd, "@LimitMoney", DbType.String, entity.LimitMoney);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改客户的业务员
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoClientUserID(CargoClientEntity entity)
        {
            try
            {
                entity.EnSafe();
                string strSQL = @"UPDATE Tbl_Cargo_Client SET UserID=@UserID,UserName=@UserName WHERE ClientNum=@ClientNum and HouseID=@HouseID";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@UserName", DbType.String, entity.UserName);
                    conn.AddInParameter(cmd, "@UserID", DbType.String, entity.UserID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void UpdateCargoClientBookCheck(CargoClientEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"UPDATE Tbl_Cargo_Client SET BookCheck=@BookCheck,LimitMoney=@LimitMoney,QuotaMoney=@QuotaMoney WHERE ClientID=@ClientID";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ClientID", DbType.Int64, entity.ClientID);
                conn.AddInParameter(cmd, "@BookCheck", DbType.String, entity.BookCheck);
                conn.AddInParameter(cmd, "@LimitMoney", DbType.Decimal, entity.LimitMoney);
                conn.AddInParameter(cmd, "@QuotaMoney", DbType.Decimal, entity.LimitMoney);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改客户的经纬度坐标
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoClientClientity(CargoClientAcceptAddressEntity entity)
        {
            try
            {
                entity.EnSafe();
                string strSQL = @"UPDATE Tbl_Cargo_AcceptAddress SET Longitude=@Longitude,Latitude=@Latitude WHERE ADID=@ADID";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ADID", DbType.Int32, entity.ADID);
                    conn.AddInParameter(cmd, "@Longitude", DbType.String, entity.Longitude);
                    conn.AddInParameter(cmd, "@Latitude", DbType.String, entity.Latitude);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改客户的返利款
        /// </summary>
        /// <param name="ClientID"></param>
        /// <param name="Money"></param>
        public void UpdateCargoClientRebateMoney(CargoClientEntity entity)
        {
            try
            {
                entity.EnSafe();
                string strSQL = string.Empty;
                if (!entity.ClientID.Equals(0))
                {
                    strSQL = @"UPDATE Tbl_Cargo_Client SET RebateMoney=RebateMoney+@RebateMoney WHERE ClientID=@ClientID ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ClientID", DbType.Int64, entity.ClientID);
                        conn.AddInParameter(cmd, "@RebateMoney", DbType.Decimal, entity.RebateMoney);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
                else if (!entity.ClientNum.Equals(0))
                {
                    strSQL = @"UPDATE Tbl_Cargo_Client SET RebateMoney=RebateMoney+@RebateMoney WHERE ClientNum=@ClientNum ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                        conn.AddInParameter(cmd, "@RebateMoney", DbType.Decimal, entity.RebateMoney);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 解绑客户编码
        /// </summary>
        /// <param name="entity"></param>
        public void CancelCargoClient(CargoClientEntity entity)
        {
            try
            {
                entity.EnSafe();
                string strSQL = @"UPDATE Tbl_Cargo_Client SET ClientNum=0 WHERE ClientNum=@ClientNum";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.ExecuteNonQuery(cmd);
                }

            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 查询客户数据用于缓存
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<ClientSessionEntity> QueryClientSession(CargoClientEntity entity)
        {
            List<ClientSessionEntity> result = new List<ClientSessionEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @" SELECT * FROM Tbl_Cargo_Client c where c.BookCheck=1 and c.DelFlag=@DelFlag ";
                if (!string.IsNullOrEmpty(entity.Boss)) { strSQL += " and c.Boss like '%" + entity.Boss + "%'"; }
                if (entity.HouseID != 0) { strSQL += " and c.HouseID = " + entity.HouseID; }
                if (!string.IsNullOrEmpty(entity.HouseIDStr)) { strSQL += " and c.HouseID in (" + entity.HouseIDStr + ")"; }
                if (!string.IsNullOrEmpty(entity.ClientNums)) { strSQL += " and c.ClientNum in (" + entity.ClientNums + ")"; }
                if (!string.IsNullOrEmpty(entity.ClientType)) { strSQL += " and c.ClientType = '" + entity.ClientType + "'"; }
                if (!string.IsNullOrEmpty(entity.UserName)) { strSQL += " and c.UserName = '" + entity.UserName + "'"; }
                if (!string.IsNullOrEmpty(entity.SettleHouseID)) { strSQL += " and c.SettleHouseID !=''"; }
                if (!entity.UpClientID.Equals(0)) { strSQL += " and c.UpClientID=" + entity.UpClientID; }
                if (!string.IsNullOrEmpty(entity.BelongHouse)) { strSQL += " and HouseID in (select HouseID from Tbl_Cargo_House where BelongHouse='" + entity.BelongHouse + "')"; }

                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@DelFlag", DbType.String, entity.DelFlag);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new ClientSessionEntity
                            {
                                ClientID = Convert.ToInt64(idr["ClientID"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                ClientShortName = Convert.ToString(idr["ClientShortName"]),
                                Boss = Convert.ToString(idr["Boss"]),
                                Telephone = Convert.ToString(idr["Telephone"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                Address = Convert.ToString(idr["Address"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                UserName = Convert.ToString(idr["UserName"]),
                                Bank = Convert.ToString(idr["Bank"]),
                                CardName = Convert.ToString(idr["CardName"]),
                                CardNum = Convert.ToString(idr["CardNum"]),
                                ClientNum = Convert.ToString(idr["ClientNum"]),
                                ShopCode = Convert.ToString(idr["ShopCode"]),
                                ClientType = Convert.ToString(idr["ClientType"]),
                                City = Convert.ToString(idr["City"]),
                                Province = Convert.ToString(idr["Province"]),
                                RebateMoney = Convert.ToDecimal(idr["RebateMoney"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                Longitude = Convert.ToString(idr["Longitude"]),
                                BookCheck = Convert.ToString(idr["BookCheck"]),
                                CheckOutType = Convert.ToString(idr["CheckOutType"]),
                                LimitMoney = string.IsNullOrEmpty(Convert.ToString(idr["LimitMoney"])) ? 0 : Convert.ToDecimal(idr["LimitMoney"]),
                                PinyinName = GetSpellCode(Convert.ToString(idr["Boss"])).ToLower()
                                //AcceptAddress = listAcceptAddress
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 在指定的字符串列表CnStr中检索符合拼音索引字符串
        /// </summary>
        /// <param name="CnStr">汉字字符串</param>
        /// <returns>相对应的汉语拼音首字母串</returns>
        public static string GetSpellCode(string CnStr)
        {
            string strTemp = "";
            for (int i = 0; i < CnStr.Length; i++)
            {
                strTemp += GetCharSpellCode(CnStr.Substring(i, 1));
            }
            return strTemp;
        }
        /// <summary>
        /// 截取字符长度
        /// </summary>
        /// <param name="str">被截取的字符串</param>
        /// <param name="len">所截取的长度</param>
        /// <returns>子字符串</returns>
        public static string CutString(string str, int len)
        {
            if (str == null || str.Length == 0 || len <= 0)
            {
                return string.Empty;
            }
            int l = str.Length;
            #region 计算长度
            int clen = 0;
            while (clen < len && clen < l)
            {
                //每遇到一个中文，则将目标长度减一。
                if ((int)str[clen] > 128) { len--; }
                clen++;
            }
            #endregion

            if (clen < l)
            {
                return str.Substring(0, clen) + "...";
            }
            else
            {
                return str;
            }
        }
        /// <summary>
        /// 得到一个汉字的拼音第一个字母，如果是一个英文字母则直接返回大写字母
        /// </summary>
        /// <param name="CnChar">单个汉字</param>
        /// <returns>单个大写字母</returns>
        private static string GetCharSpellCode(string CnChar)
        {

            long iCnChar;

            byte[] ZW = System.Text.Encoding.Default.GetBytes(CnChar);

            //如果是字母，则直接返回首字母

            if (ZW.Length == 1)
            {

                return CutString(CnChar.ToUpper(), 1);

            }
            else
            {

                // get the array of byte from the single char

                int i1 = (short)(ZW[0]);

                int i2 = (short)(ZW[1]);

                iCnChar = i1 * 256 + i2;

            }

            // iCnChar match the constant

            if ((iCnChar >= 45217) && (iCnChar <= 45252)) { return "a"; }
            else if ((iCnChar >= 45253) && (iCnChar <= 45760)) { return "B"; }
            else if ((iCnChar >= 45761) && (iCnChar <= 46317))
            {

                return "C";

            }
            else if ((iCnChar >= 46318) && (iCnChar <= 46825))
            {

                return "D";

            }
            else if ((iCnChar >= 46826) && (iCnChar <= 47009))
            {

                return "E";

            }
            else if ((iCnChar >= 47010) && (iCnChar <= 47296))
            {

                return "F";

            }
            else if ((iCnChar >= 47297) && (iCnChar <= 47613))
            {

                return "G";

            }
            else if ((iCnChar >= 47614) && (iCnChar <= 48118))
            {

                return "H";

            }
            else if ((iCnChar >= 48119) && (iCnChar <= 49061))
            {

                return "J";

            }
            else if ((iCnChar >= 49062) && (iCnChar <= 49323))
            {

                return "K";

            }
            else if ((iCnChar >= 49324) && (iCnChar <= 49895))
            {

                return "L";

            }
            else if ((iCnChar >= 49896) && (iCnChar <= 50370))
            {

                return "M";

            }
            else if ((iCnChar >= 50371) && (iCnChar <= 50613))
            {

                return "N";

            }
            else if ((iCnChar >= 50614) && (iCnChar <= 50621))
            {

                return "O";

            }
            else if ((iCnChar >= 50622) && (iCnChar <= 50905))
            {

                return "P";

            }
            else if ((iCnChar >= 50906) && (iCnChar <= 51386))
            {

                return "Q";

            }
            else if ((iCnChar >= 51387) && (iCnChar <= 51445))
            {

                return "R";

            }
            else if ((iCnChar >= 51446) && (iCnChar <= 52217))
            {

                return "S";

            }
            else if ((iCnChar >= 52218) && (iCnChar <= 52697))
            {

                return "T";

            }
            else if ((iCnChar >= 52698) && (iCnChar <= 52979))
            {

                return "W";

            }
            else if ((iCnChar >= 52980) && (iCnChar <= 53640))
            {

                return "X";

            }
            else if ((iCnChar >= 53689) && (iCnChar <= 54480))
            {

                return "Y";

            }
            else if ((iCnChar >= 54481) && (iCnChar <= 55289))
            {

                return "Z";

            }
            else

                return ("?");

        }
        /// <summary>
        /// 查询客户地址信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoClientEntity> QueryClientAddress(CargoClientEntity entity)
        {
            List<CargoClientEntity> result = new List<CargoClientEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @" SELECT * FROM Tbl_Cargo_Client Where DelFlag=@DelFlag ";
                if (!string.IsNullOrEmpty(entity.Boss)) { strSQL += " and Boss like '%" + entity.Boss + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strSQL += " and Cellphone = '" + entity.Cellphone + "'"; }
                if (!string.IsNullOrEmpty(entity.UserID)) { strSQL += " and UserID = '" + entity.UserID + "'"; }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@DelFlag", DbType.String, entity.DelFlag);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoClientEntity
                            {
                                ClientID = Convert.ToInt32(idr["ClientID"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                ClientType = Convert.ToString(idr["ClientType"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                ClientShortName = Convert.ToString(idr["ClientShortName"]),
                                Boss = Convert.ToString(idr["Boss"]),
                                Telephone = Convert.ToString(idr["Telephone"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                City = Convert.ToString(idr["City"]),
                                Province = Convert.ToString(idr["Province"]),
                                Address = Convert.ToString(idr["Address"])
                                //AcceptAddress = listAcceptAddress
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询客户数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoClientEntity QueryCargoClient(CargoClientEntity entity)
        {
            CargoClientEntity result = new CargoClientEntity();
            try
            {
                string strSQL = @"SELECT top 1 c.*,ll.LineID,ll.LineName,ll.LogisID as LogisLineLogisID FROM Tbl_Cargo_Client c inner join Tbl_Cargo_LogisLineClient llc on c.ClientID=llc.ClientID inner join Tbl_Cargo_LogisLine ll on llc.LineID=ll.LineID and c.HouseID=ll.HouseID Where (1=1)";
                if (!entity.HouseID.Equals(0))
                {
                    strSQL += " and c.HouseID=" + entity.HouseID;
                }
                if (!string.IsNullOrEmpty(entity.HouseIDStr))
                {
                    strSQL += " and c.HouseID in (" + entity.HouseIDStr + ")";

                }
                if (!string.IsNullOrEmpty(entity.TryeClientCode))
                {
                    strSQL += " and c.TryeClientCode='" + entity.TryeClientCode + "'";
                }
                if (!string.IsNullOrEmpty(entity.ShopCode))
                {
                    strSQL += " and c.ShopCode='" + entity.ShopCode + "'";
                }
                strSQL += " Order by c.RebateMoney desc";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.ClientID = Convert.ToInt64(idr["ClientID"]);
                            result.ClientNum = Convert.ToInt32(idr["ClientNum"]);
                            result.ClientType = Convert.ToString(idr["ClientType"]);
                            result.ClientName = Convert.ToString(idr["ClientName"]);
                            result.ClientShortName = Convert.ToString(idr["ClientShortName"]);
                            result.Boss = Convert.ToString(idr["Boss"]);
                            result.Telephone = Convert.ToString(idr["Telephone"]);
                            result.Cellphone = Convert.ToString(idr["Cellphone"]);
                            result.UserID = Convert.ToString(idr["UserID"]);
                            result.Address = Convert.ToString(idr["Address"]);
                            result.ZipCode = Convert.ToString(idr["ZipCode"]);
                            result.Fax = Convert.ToString(idr["Fax"]);
                            result.Email = Convert.ToString(idr["Email"]);
                            result.Product = Convert.ToString(idr["Product"]);
                            result.City = Convert.ToString(idr["City"]);
                            result.DelFlag = Convert.ToString(idr["DelFlag"]);
                            result.Remark = Convert.ToString(idr["Remark"]);
                            result.HouseID = Convert.ToInt32(idr["HouseID"]);
                            result.UserID = Convert.ToString(idr["UserID"]);
                            result.Province = Convert.ToString(idr["Province"]);
                            result.Country = Convert.ToString(idr["Country"]);
                            result.ClientTypeID = Convert.ToString(idr["ClientTypeID"]);
                            result.ClientTypeName = Convert.ToString(idr["ClientTypeName"]);
                            result.TryeClientType = Convert.ToString(idr["TryeClientType"]);
                            result.TryeClientCode = Convert.ToString(idr["TryeClientCode"]);
                            result.TryeCompany = Convert.ToString(idr["TryeCompany"]);
                            result.Bank = Convert.ToString(idr["Bank"]);
                            result.ShopCode = Convert.ToString(idr["ShopCode"]);
                            result.CardName = Convert.ToString(idr["CardName"]);
                            result.CardNum = Convert.ToString(idr["CardNum"]);
                            result.LineID = string.IsNullOrEmpty(Convert.ToString(idr["LineID"])) ? 0 : Convert.ToInt32(idr["LineID"]);
                            result.LineName = Convert.ToString(idr["LineName"]);
                            result.PreReceiveMoney = string.IsNullOrEmpty(Convert.ToString(idr["PreReceiveMoney"])) ? 0 : Convert.ToDecimal(idr["PreReceiveMoney"]);
                            result.LimitMoney = string.IsNullOrEmpty(Convert.ToString(idr["LimitMoney"])) ? 0 : Convert.ToDecimal(idr["LimitMoney"]);
                            result.RebateMoney = string.IsNullOrEmpty(Convert.ToString(idr["RebateMoney"])) ? 0 : Convert.ToDecimal(idr["RebateMoney"]);
                            result.LogisLineLogisID = string.IsNullOrEmpty(Convert.ToString(idr["LogisLineLogisID"])) ? 0 : Convert.ToInt32(idr["LogisLineLogisID"]);
                            //AcceptAddress = listAcceptAddress
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 根据客户ID查询客户信息
        /// </summary>
        /// <param name="cargoid"></param>
        /// <returns></returns>
        public CargoClientEntity QueryCargoClient(Int64 cargoid)
        {
            CargoClientEntity result = new CargoClientEntity();
            try
            {
                string strSQL = @"SELECT a.*,b.Name as HouseName FROM Tbl_Cargo_Client as a Inner join tbl_Cargo_house as b on a.HouseID=b.HouseID Where a.ClientID=@ClientID";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@ClientID", DbType.Int64, cargoid);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.ClientID = Convert.ToInt64(idr["ClientID"]);
                            result.ClientNum = Convert.ToInt32(idr["ClientNum"]);
                            result.ClientType = Convert.ToString(idr["ClientType"]);
                            result.ClientName = Convert.ToString(idr["ClientName"]);
                            result.ClientShortName = Convert.ToString(idr["ClientShortName"]);
                            result.Boss = Convert.ToString(idr["Boss"]);
                            result.Telephone = Convert.ToString(idr["Telephone"]);
                            result.Cellphone = Convert.ToString(idr["Cellphone"]);
                            result.UserID = Convert.ToString(idr["UserID"]);
                            result.Address = Convert.ToString(idr["Address"]);
                            result.ZipCode = Convert.ToString(idr["ZipCode"]);
                            result.Fax = Convert.ToString(idr["Fax"]);
                            result.Email = Convert.ToString(idr["Email"]);
                            result.Product = Convert.ToString(idr["Product"]);
                            result.City = Convert.ToString(idr["City"]);
                            result.DelFlag = Convert.ToString(idr["DelFlag"]);
                            result.Remark = Convert.ToString(idr["Remark"]);
                            result.UserID = Convert.ToString(idr["UserID"]);
                            result.Province = Convert.ToString(idr["Province"]);
                            result.Country = Convert.ToString(idr["Country"]);
                            result.HouseID = Convert.ToInt32(idr["HouseID"]);
                            result.HouseName = Convert.ToString(idr["HouseName"]);
                            result.ClientTypeID = Convert.ToString(idr["ClientTypeID"]);
                            result.ClientTypeName = Convert.ToString(idr["ClientTypeName"]);
                            result.TryeClientType = Convert.ToString(idr["TryeClientType"]);
                            result.TryeClientCode = Convert.ToString(idr["TryeClientCode"]);
                            result.TryeCompany = Convert.ToString(idr["TryeCompany"]);
                            result.Bank = Convert.ToString(idr["Bank"]);
                            result.ShopCode = Convert.ToString(idr["ShopCode"]);
                            result.CardName = Convert.ToString(idr["CardName"]);
                            result.CardNum = Convert.ToString(idr["CardNum"]);
                            result.PreReceiveMoney = string.IsNullOrEmpty(Convert.ToString(idr["PreReceiveMoney"])) ? 0 : Convert.ToDecimal(idr["PreReceiveMoney"]);
                            result.LimitMoney = string.IsNullOrEmpty(Convert.ToString(idr["LimitMoney"])) ? 0 : Convert.ToDecimal(idr["LimitMoney"]);
                            result.RebateMoney = string.IsNullOrEmpty(Convert.ToString(idr["RebateMoney"])) ? 0 : Convert.ToDecimal(idr["RebateMoney"]);
                            result.Latitude = Convert.ToString(idr["Latitude"]);
                            result.Longitude = Convert.ToString(idr["Longitude"]);
                            result.BookCheck = Convert.ToString(idr["BookCheck"]);
                            result.PushAccount = Convert.ToString(idr["PushAccount"]);
                            //AcceptAddress = listAcceptAddress
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 根据客户代码查询客户信息
        /// </summary>
        /// <param name="cargoid"></param>
        /// <returns></returns>
        public CargoClientEntity QueryCargoClient(int clientNum, int HouseID)
        {
            CargoClientEntity result = new CargoClientEntity();
            try
            {
                string strSQL = @"SELECT a.*,b.UserName FROM Tbl_Cargo_Client as a left join Tbl_SysUser as b on a.UserID=b.LoginName Where a.ClientNum=@ClientNum";
                if (!HouseID.Equals(0))
                {
                    strSQL += " and a.HouseID=@HouseID";
                }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@ClientNum", DbType.Int32, clientNum);
                    if (!HouseID.Equals(0))
                    {
                        conn.AddInParameter(command, "@HouseID", DbType.Int32, HouseID);
                    }
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.ClientID = Convert.ToInt32(idr["ClientID"]);
                            result.ClientNum = Convert.ToInt32(idr["ClientNum"]);
                            result.ClientType = Convert.ToString(idr["ClientType"]);
                            result.ClientName = Convert.ToString(idr["ClientName"]);
                            result.ClientShortName = Convert.ToString(idr["ClientShortName"]);
                            result.Boss = Convert.ToString(idr["Boss"]);
                            result.Telephone = Convert.ToString(idr["Telephone"]);
                            result.Cellphone = Convert.ToString(idr["Cellphone"]);
                            result.UserID = Convert.ToString(idr["UserID"]);
                            result.UserName = Convert.ToString(idr["UserName"]);
                            result.Address = Convert.ToString(idr["Address"]);
                            result.ZipCode = Convert.ToString(idr["ZipCode"]);
                            result.Fax = Convert.ToString(idr["Fax"]);
                            result.Email = Convert.ToString(idr["Email"]);
                            result.Product = Convert.ToString(idr["Product"]);
                            result.City = Convert.ToString(idr["City"]);
                            result.DelFlag = Convert.ToString(idr["DelFlag"]);
                            result.Remark = Convert.ToString(idr["Remark"]);
                            result.Province = Convert.ToString(idr["Province"]);
                            result.Country = Convert.ToString(idr["Country"]);
                            result.ClientTypeID = Convert.ToString(idr["ClientTypeID"]);
                            result.ClientTypeName = Convert.ToString(idr["ClientTypeName"]);
                            result.Bank = Convert.ToString(idr["Bank"]);
                            result.TryeClientType = Convert.ToString(idr["TryeClientType"]);
                            result.TryeClientCode = Convert.ToString(idr["TryeClientCode"]);
                            result.TryeCompany = Convert.ToString(idr["TryeCompany"]);
                            result.CardName = Convert.ToString(idr["CardName"]);
                            result.CardNum = Convert.ToString(idr["CardNum"]);
                            result.PreReceiveMoney = string.IsNullOrEmpty(Convert.ToString(idr["PreReceiveMoney"])) ? 0 : Convert.ToDecimal(idr["PreReceiveMoney"]);
                            result.LimitMoney = string.IsNullOrEmpty(Convert.ToString(idr["LimitMoney"])) ? 0 : Convert.ToDecimal(idr["LimitMoney"]);
                            result.RebateMoney = string.IsNullOrEmpty(Convert.ToString(idr["RebateMoney"])) ? 0 : Convert.ToDecimal(idr["RebateMoney"]);
                            result.Latitude = Convert.ToString(idr["Latitude"]);
                            result.Longitude = Convert.ToString(idr["Longitude"]);
                            result.LogisID = Convert.ToInt32(idr["LogisID"]);
                            result.LogisName = Convert.ToString(idr["LogisName"]);
                            result.BookCheck = Convert.ToString(idr["BookCheck"]);
                            result.PushAccount = Convert.ToString(idr["PushAccount"]);
                            result.HouseID = Convert.ToInt32(idr["HouseID"]);
                            result.LoginPwd = Convert.ToString(idr["LoginPwd"]);
                            result.Discount = Convert.ToDecimal(idr["Discount"]);
                            result.SettleHouseID = Convert.ToString(idr["SettleHouseID"]);
                            result.SettleHouseName = Convert.ToString(idr["SettleHouseName"]);
                            result.UpClientID = Convert.ToInt32(idr["UpClientID"]);
                            result.UpClientShortName = Convert.ToString(idr["UpClientShortName"]);
                            //AcceptAddress = listAcceptAddress
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }


        /// <summary>
        /// 查询客户下单数量
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public CargoClientEntity QueryCargoClientTarget(CargoClientEntity entity)
        {
            CargoClientEntity result = new CargoClientEntity();
            try
            {
                string strSQL = @"select a.ClientNum,a.TargetNum,a.LimitMoney,b.SumPiece,c.SumPiece as UserRulePiece,a.RebateMoney from (select c.TargetNum,c.LimitMoney,c.ClientNum,c.RebateMoney from Tbl_Cargo_Client c where c.ClientNum=@ClientNum ) a left join (select SUM(o.Piece)as SumPiece,PayClientNum from Tbl_Cargo_Order o where o.PayClientNum=@ClientNum and o.ThrowGood=21";
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and o.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and o.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " group by PayClientNum)b on a.ClientNum=b.PayClientNum left join (select SUM(og.Piece)as SumPiece,PayClientNum from Tbl_Cargo_OrderGoods og inner join Tbl_Cargo_Order o on og.OrderNo=o.OrderNo where o.PayClientNum=148482 and o.ThrowGood=21 and CHARINDEX(','+'6'+',' , ','+og.RuleType+',') > 0 ";
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and o.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and o.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " group by PayClientNum)c on a.ClientNum=c.PayClientNum";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@ClientNum", DbType.Int32, entity.ClientNum);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.ClientNum = Convert.ToInt32(idr["ClientNum"]);
                            result.TargetNum = string.IsNullOrEmpty(Convert.ToString(idr["TargetNum"])) ? 0 : Convert.ToInt32(idr["TargetNum"]);
                            result.LimitMoney = string.IsNullOrEmpty(Convert.ToString(idr["LimitMoney"])) ? 0 : Convert.ToDecimal(idr["LimitMoney"]);
                            result.SumPiece = string.IsNullOrEmpty(Convert.ToString(idr["SumPiece"])) ? 0 : Convert.ToInt32(idr["SumPiece"]);
                            result.UserRulePiece = string.IsNullOrEmpty(Convert.ToString(idr["UserRulePiece"])) ? 0 : Convert.ToInt32(idr["UserRulePiece"]);
                            result.RebateMoney = string.IsNullOrEmpty(Convert.ToString(idr["RebateMoney"])) ? 0 : Convert.ToDecimal(idr["RebateMoney"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public void ClearClentQuota(CargoClientEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"UPDATE Tbl_Cargo_Client SET LimitMoney=@LimitMoney WHERE HouseID=@HouseID";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmd, "@LimitMoney", DbType.Decimal, entity.LimitMoney);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改客户密码
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateClentPwd(CargoClientEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"UPDATE Tbl_Cargo_Client SET LoginPwd=@LoginPwd WHERE ClientNum=@ClientNum";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@LoginPwd", DbType.String, entity.LoginPwd);
                conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 保存客户与产品分类数据
        /// </summary>
        /// <param name="entity"></param>
        private void AddClientProduct(List<CargoClientTypeIDEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"INSERT INTO Tbl_Cargo_ClientProduct(ClientID,TypeID,OP_DATE) VALUES (@ClientID,@TypeID,@OP_DATE)";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ClientID", DbType.Int64, it.ClientID);
                        conn.AddInParameter(cmd, "@TypeID", DbType.Int32, it.TypeID);
                        conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 判断是否存在客户与产品分类数据
        /// True:存在
        /// False：不存在
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistCargoClientProductType(CargoClientTypeIDEntity entity)
        {
            string strQ = @"Select ClientID from Tbl_Cargo_ClientProduct Where ClientID=@ClientID";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ClientID", DbType.Int64, entity.ClientID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 删除客户与产品分类数据
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoClientProductType(CargoClientTypeIDEntity entity)
        {
            try
            {
                string strSQL = @"Delete from Tbl_Cargo_ClientProduct where ClientID=@ClientID ";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientID", DbType.Int64, entity.ClientID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 冻结当月未结清账款客户的额度付款权限
        /// </summary>
        public void UpdateClientQuotaLimit(string checkStatus)
        {
            string strSQL = "update Tbl_Cargo_Client set QuotaLimit='" + checkStatus + "'";
            strSQL += " from (select distinct a.ClientNum,b.HouseID From (select distinct ClientNum from Tbl_WX_Client where ClientNum is not null and ClientNum!=0) as a inner join Tbl_Cargo_Order as b on a.ClientNum=b.ClientNum where ";
            if (checkStatus.Equals("0"))
            {
                //已结清的客户，修改权限
                strSQL += " b.CheckStatus=1 ";
            }
            else
            {
                strSQL += " b.CheckStatus<>1 ";
            }
            strSQL += "and b.CreateDate>'" + DateTime.Now.AddDays(-DateTime.Now.DayOfYear).ToString("yyyy-MM-dd") + "') as c where Tbl_Cargo_Client.ClientNum=c.ClientNum and Tbl_Cargo_Client.HouseID=c.HouseID";
            if (checkStatus.Equals("0"))
            {
                strSQL += " and Tbl_Cargo_Client.QuotaLimit!='0'";
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 保存导入的数据
        /// </summary>
        /// <param name="entity"></param>
        public void SaveData(List<CargoClientEntity> entity)
        {
            try
            {
                long did = 0;
                string strSQL = @"INSERT INTO Tbl_Cargo_Client(ClientNum,ClientName,ClientShortName,ClientType,Address,Telephone,Boss,Cellphone,OP_DATE,Remark,DelFlag,HouseID,TargetNum,ShopCode,TryeClientType) VALUES (@ClientNum,@ClientName,@ClientShortName,@ClientType,@Address,@Telephone,@Boss,@Cellphone,@OP_DATE,@Remark,@DelFlag,@HouseID,@TargetNum,@ShopCode,@TryeClientType)  SELECT @@IDENTITY";
                foreach (var it in entity)
                {
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ClientNum", DbType.String, it.ClientNum);
                        conn.AddInParameter(cmd, "@ClientName", DbType.String, it.ClientName);
                        conn.AddInParameter(cmd, "@ClientShortName", DbType.String, it.ClientShortName);
                        conn.AddInParameter(cmd, "@ClientType", DbType.String, it.ClientType);
                        conn.AddInParameter(cmd, "@Address", DbType.String, it.Address);
                        conn.AddInParameter(cmd, "@Telephone", DbType.String, it.Telephone);
                        conn.AddInParameter(cmd, "@Boss", DbType.String, it.Boss);
                        conn.AddInParameter(cmd, "@Cellphone", DbType.String, it.Cellphone);
                        conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                        conn.AddInParameter(cmd, "@Remark", DbType.String, it.Remark);
                        conn.AddInParameter(cmd, "@DelFlag", DbType.String, 0);
                        conn.AddInParameter(cmd, "@HouseID", DbType.String, it.HouseID);
                        conn.AddInParameter(cmd, "@TargetNum", DbType.String, it.TargetNum);
                        conn.AddInParameter(cmd, "@ShopCode", DbType.String, it.ShopCode);
                        conn.AddInParameter(cmd, "@TryeClientType", DbType.String, it.TryeClientType);
                        did = Convert.ToInt64(conn.ExecuteScalar(cmd));
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 根据客户名称、电话、仓库查询客户是否存在
        /// </summary>
        /// <param name="Boss"></param>
        /// <param name="Cellphone"></param>
        /// <param name="HouseID"></param>
        /// <returns></returns>
        public bool QueryCargoClientNum(string Boss, string Cellphone, int HouseID)
        {
            string strSQL = @"SELECT a.*,b.UserName FROM Tbl_Cargo_Client as a left join Tbl_SysUser as b on a.UserID=b.LoginName Where a.Boss=@Boss and a.Cellphone=@Cellphone and a.HouseID=@HouseID";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@Boss", DbType.String, Boss);
                conn.AddInParameter(command, "@Cellphone", DbType.String, Cellphone);
                conn.AddInParameter(command, "@HouseID", DbType.Int32, HouseID);
                using (DataTable idr = conn.ExecuteDataTable(command))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 根据客户编码复制客户信息
        /// </summary>
        /// <param name="entity"></param>
        public void CopyCargoClientData(int OldClientNum, int NewClientNum, int NewHouseID)
        {
            string strSQL = @"insert into Tbl_Cargo_Client (ClientNum, ClientName, ClientShortName, ClientType, Address, ZipCode, Telephone, Fax, Boss, Cellphone, Email, Product, DelFlag, Remark, OP_DATE, UserID, City, Province, ClientTypeID, ClientTypeName, HouseID,Bank,CardName,CardNum,PreReceiveMoney,RebateMoney,LimitMoney,TargetNum,ShopCode,QuotaLimit,TryeClientCode,TryeCompany,TryeClientType,LogisName,LogisID,LogisFee) select @NewClientNum, ClientName, ClientShortName, ClientType, Address, ZipCode, Telephone, Fax, Boss, Cellphone, Email, Product, DelFlag, Remark,GETDATE(), UserID, City, Province, ClientTypeID, ClientTypeName, @HouseID,Bank,CardName,CardNum,PreReceiveMoney,RebateMoney,LimitMoney,TargetNum,ShopCode,QuotaLimit,TryeClientCode,TryeCompany,TryeClientType,LogisName,LogisID,LogisFee from Tbl_Cargo_Client where ClientNum=@OldClientNum";

            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@OldClientNum", DbType.Int32, OldClientNum);
                    conn.AddInParameter(cmd, "@NewClientNum", DbType.Int32, NewClientNum);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, NewHouseID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void AddClientCredenFile(CargoClientFileEntity entity)
        {
            string inSQL = @"INSERT INTO Tbl_Cargo_ClientFile(ClientID,FileName,FilePath,FileType,OP_DATE,OP_ID) values (@ClientID,@FileName,@FilePath,@FileType,@OP_DATE,@OP_ID)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(inSQL))
                {
                    conn.AddInParameter(cmd, "@ClientID", DbType.Int64, entity.ClientID);
                    conn.AddInParameter(cmd, "@FileName", DbType.String, entity.FileName);
                    conn.AddInParameter(cmd, "@FilePath", DbType.String, entity.FilePath);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@FileType", DbType.String, entity.FileType);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void DeleteClientCredenFile(CargoClientFileEntity entity)
        {
            string inSQL = @"Delete From Tbl_Cargo_ClientFile Where FID=@FID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(inSQL))
                {
                    conn.AddInParameter(cmd, "@FID", DbType.Int64, entity.FID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public List<CargoClientFileEntity> QueryClientCredenFileByID(CargoClientFileEntity entity)
        {
            entity.EnSafe();
            List<CargoClientFileEntity> result = new List<CargoClientFileEntity>();
            try
            {
                string strSQL = @"SELECT * FROM Tbl_Cargo_ClientFile where ClientID=@ClientID ";
                if (!string.IsNullOrEmpty(entity.FileType))
                {
                    strSQL += " and FileType='" + entity.FileType + "'";
                }
                strSQL += " Order by OP_DATE Desc ";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@ClientID", DbType.Int64, entity.ClientID);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoClientFileEntity
                            {
                                FID = Convert.ToInt64(idr["FID"]),
                                ClientID = Convert.ToInt64(idr["ClientID"]),
                                FileType = Convert.ToString(idr["FileType"]),
                                FileName = Convert.ToString(idr["FileName"]),
                                FilePath = Convert.ToString(idr["FilePath"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

            return result;
        }
        /// <summary>
        /// 修改客户密码
        /// </summary>
        /// <param name="entity"></param>
        /// <returns>1:客户不存在</returns>
        public int ChangeClientPwd(CargoClientEntity entity)
        {
            try
            {
                if (!IsExistCargoClientNum(entity))
                {
                    return 1;
                }
                string strSQL = @"UPDATE Tbl_Cargo_Client SET LoginPwd=@LoginPwd";
                strSQL += " WHERE (1=1) ";
                if (!entity.ClientNum.Equals(0))
                {
                    strSQL += " and ClientNum=@ClientNum";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientNum", DbType.String, entity.ClientNum);
                    conn.AddInParameter(cmd, "@LoginPwd", DbType.String, entity.LoginPwd);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return 0;
        }
        /// <summary>
        /// 处理云仓客户已经开过两单的，关闭货到付款权限
        /// </summary>
        public void UpdateClientArriveLimit()
        {
            string strSQL = "update Tbl_Cargo_Client set arrivepaylimit=1 from (select a.ClientNum,COUNT(*) as SNUM from Tbl_Cargo_Client as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID and b.BelongHouse=6 and b.HouseID!=65 inner join Tbl_Cargo_Order as c on a.ClientNum=c.PayClientNum and c.CreateDate>='2024-03-01' and a.arrivepaylimit=0 group by a.ClientNum having COUNT(*)>2) as a where Tbl_Cargo_Client.ClientNum=a.ClientNum";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.ExecuteNonQuery(cmd);
            }
        }

        #endregion
        #region 收货地址操作方法集合
        /// <summary>
        /// 查询客户收货地址数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryAcceptAddress(int pIndex, int pNum, CargoClientAcceptAddressEntity entity)
        {
            List<CargoClientAcceptAddressEntity> result = new List<CargoClientAcceptAddressEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.*,b.Name as HouseName FROM Tbl_Cargo_AcceptAddress as a left join Tbl_Cargo_House as b on a.HouseID=b.HouseID WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.AcceptCompany)) { strSQL += " and a.AcceptCompany like '%" + entity.AcceptCompany + "%'"; }
                if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strSQL += " and a.AcceptPeople like '%" + entity.AcceptPeople + "%'"; }
                if (!string.IsNullOrEmpty(entity.AcceptCellphone)) { strSQL += " and a.AcceptCellphone like '%" + entity.AcceptCellphone + "%'"; }
                if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum = " + entity.ClientNum; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoClientAcceptAddressEntity
                            {
                                ADID = Convert.ToInt64(idr["ADID"]),
                                ClientID = Convert.ToInt64(idr["ClientID"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                AcceptAddress = Convert.ToString(idr["AcceptAddress"]),
                                AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                                AcceptCity = Convert.ToString(idr["AcceptCity"]),
                                AcceptCompany = Convert.ToString(idr["AcceptCompany"]),
                                AcceptCountry = Convert.ToString(idr["AcceptCountry"]),
                                AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                                AcceptProvince = Convert.ToString(idr["AcceptProvince"]),
                                AcceptTelephone = Convert.ToString(idr["AcceptTelephone"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                Longitude = Convert.ToString(idr["Longitude"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                isDefault = Convert.ToInt32(idr["isDefault"]),
                                TargetNum = string.IsNullOrEmpty(Convert.ToString(idr["TargetNum"])) ? 0 : Convert.ToInt32(idr["TargetNum"]),
                                TryeClientCode = Convert.ToString(idr["TryeClientCode"]),
                                TryeCompany = Convert.ToString(idr["TryeCompany"]),
                                TryeClientType = Convert.ToString(idr["TryeClientType"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_AcceptAddress as a left join Tbl_Cargo_House as b on a.HouseID=b.HouseID Where (1=1)";
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.AcceptCompany)) { strCount += " and a.AcceptCompany like '%" + entity.AcceptCompany + "%'"; }
                if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strCount += " and a.AcceptPeople like '%" + entity.AcceptPeople + "%'"; }
                if (!string.IsNullOrEmpty(entity.AcceptCellphone)) { strCount += " and a.AcceptCellphone like '%" + entity.AcceptCellphone + "%'"; }
                if (!entity.ClientNum.Equals(0)) { strCount += " and a.ClientNum = " + entity.ClientNum; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        /// <summary>
        /// 查询收货人数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoClientAcceptAddressEntity QueryAcceptAddressInfo(CargoClientAcceptAddressEntity entity)
        {
            CargoClientAcceptAddressEntity result = new CargoClientAcceptAddressEntity();
            try
            {
                string strSQL = @"SELECT top 1 * FROM Tbl_Cargo_AcceptAddress Where (1=1)";
                if (entity.ADID != 0)
                {
                    strSQL += " and ADID='" + entity.ADID + "'";
                }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.ADID = Convert.ToInt64(idr["ADID"]);
                            result.ClientID = Convert.ToInt64(idr["ClientID"]);
                            result.ClientNum = Convert.ToInt32(idr["ClientNum"]);
                            result.AcceptAddress = Convert.ToString(idr["AcceptAddress"]);
                            result.AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]);
                            result.AcceptCity = Convert.ToString(idr["AcceptCity"]);
                            result.AcceptCompany = Convert.ToString(idr["AcceptCompany"]);
                            result.AcceptCountry = Convert.ToString(idr["AcceptCountry"]);
                            result.AcceptPeople = Convert.ToString(idr["AcceptPeople"]);
                            result.AcceptProvince = Convert.ToString(idr["AcceptProvince"]);
                            result.AcceptTelephone = Convert.ToString(idr["AcceptTelephone"]);
                            result.Latitude = Convert.ToString(idr["Latitude"]);
                            result.Longitude = Convert.ToString(idr["Longitude"]);
                            result.HouseID = Convert.ToInt32(idr["HouseID"]);
                            result.TargetNum = string.IsNullOrEmpty(Convert.ToString(idr["TargetNum"])) ? 0 : Convert.ToInt32(idr["TargetNum"]);
                            result.TryeClientCode = Convert.ToString(idr["TryeClientCode"]);
                            result.TryeCompany = Convert.ToString(idr["TryeCompany"]);
                            result.TryeClientType = Convert.ToString(idr["TryeClientType"]);
                            result.OP_DATE = Convert.ToDateTime(idr["OP_DATE"]);
                            //AcceptAddress = listAcceptAddress
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public List<CargoUpClientEntity> QueryBusinessID(int ClientID)
        {
            List<CargoUpClientEntity> result = new List<CargoUpClientEntity>();
            try
            {
                string strSQL = @" SELECT a.ID,a.DepName FROM Tbl_Cargo_UpClientDep as a inner join Tbl_Cargo_Client as b on a.UpClientID=b.UpClientID WHERE ID>11 ";
                if (ClientID != 0)
                {
                    strSQL += " and b.ClientID='" + ClientID + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoUpClientEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                DepName = Convert.ToString(idr["DepName"])
                            });
                        }
                    }
                }
                if (result.Count == 0 && ClientID != 0)
                {
                    result = QueryBusinessIDDefault(new CargoUpClientEntity { UpClientID = 1 });
                }


            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public List<CargoUpClientEntity> QueryBusinessIDDefault(CargoUpClientEntity entity)
        {
            List<CargoUpClientEntity> result = new List<CargoUpClientEntity>();
            try
            {
                string strSQL = "SELECT ID,DepName FROM Tbl_Cargo_UpClientDep WHERE ID>11";

                if (entity.UpClientID != 0)
                {
                    strSQL += "and UpClientID='" + entity.UpClientID + "'";
                }

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoUpClientEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                DepName = Convert.ToString(idr["DepName"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public List<CargoUpClientEntity> QueryUpClientDep(CargoUpClientEntity entity)
        {
            List<CargoUpClientEntity> result = new List<CargoUpClientEntity>();
            try
            {
                string strSQL = @" SELECT ID,DepName FROM Tbl_Cargo_UpClientDep where ID>11";
                if (!string.IsNullOrEmpty(entity.DepName))
                {
                    strSQL += " and DepName='" + entity.DepName + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoUpClientEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                DepName = Convert.ToString(idr["DepName"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public List<CargoUpClientEntity> QueryUpClientDepName(string DepName)
        {
            List<CargoUpClientEntity> result = new List<CargoUpClientEntity>();
            try
            {
                string strSQL = @" SELECT ID,DepName FROM Tbl_Cargo_UpClientDep where ID>11 and DepName='" + DepName + "'";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoUpClientEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                DepName = Convert.ToString(idr["DepName"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询客户收货地址
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoClientAcceptAddressEntity> QueryAcceptAddress(CargoClientAcceptAddressEntity entity)
        {
            List<CargoClientAcceptAddressEntity> result = new List<CargoClientAcceptAddressEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @" SELECT * FROM Tbl_Cargo_AcceptAddress where (1=1) ";
                if (!string.IsNullOrEmpty(entity.ClientNum.ToString()))
                {
                    strSQL += " and ClientNum=" + entity.ClientNum;
                }
                if (!entity.isDefault.Equals(0))
                {
                    strSQL += " and isDefault=" + entity.isDefault;
                }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoClientAcceptAddressEntity
                            {
                                ADID = Convert.ToInt64(idr["ADID"]),
                                ClientID = Convert.ToInt64(idr["ClientID"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                AcceptAddress = Convert.ToString(idr["AcceptAddress"]),
                                AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                                AcceptCity = Convert.ToString(idr["AcceptCity"]),
                                AcceptCompany = Convert.ToString(idr["AcceptCompany"]),
                                AcceptCountry = Convert.ToString(idr["AcceptCountry"]),
                                AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                                AcceptProvince = Convert.ToString(idr["AcceptProvince"]),
                                AcceptTelephone = Convert.ToString(idr["AcceptTelephone"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                Longitude = Convert.ToString(idr["Longitude"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                TargetNum = string.IsNullOrEmpty(Convert.ToString(idr["TargetNum"])) ? 0 : Convert.ToInt32(idr["TargetNum"]),
                                TryeClientCode = Convert.ToString(idr["TryeClientCode"]),
                                TryeCompany = Convert.ToString(idr["TryeCompany"]),
                                TryeClientType = Convert.ToString(idr["TryeClientType"]),
                                AcceptPeopleCellphone = Convert.ToString(idr["AcceptPeople"]) + (string.IsNullOrEmpty(Convert.ToString(idr["AcceptCellphone"])) ? Convert.ToString(idr["AcceptTelephone"]) : Convert.ToString(idr["AcceptCellphone"])),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 删除客户收货地址
        /// </summary>
        /// <param name="entity"></param>
        public void DelAcceptAddress(List<CargoClientAcceptAddressEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_AcceptAddress where ADID=@ADID ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ADID", DbType.Int64, it.ADID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 是否存在相同的收货地址
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistAcceptAddress(CargoClientAcceptAddressEntity entity)
        {
            string strQ = @"Select ClientNum from Tbl_Cargo_AcceptAddress Where ClientNum=@ClientNum and AcceptPeople=@AcceptPeople";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ClientNum", DbType.Int32, entity.ClientNum);
                conn.AddInParameter(cmdQ, "@AcceptPeople", DbType.String, entity.AcceptPeople);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 新增客户收货地址
        /// </summary>
        /// <param name="entity"></param>
        public void AddAcceptAddress(CargoClientAcceptAddressEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_AcceptAddress(ClientID,ClientNum,AcceptProvince,AcceptCity,AcceptCountry,AcceptCompany,AcceptAddress,AcceptPeople,AcceptTelephone,AcceptCellphone,TryeClientCode,TryeCompany,TryeClientType,OP_DATE,TargetNum,Longitude,Latitude,HouseID,isDefault) VALUES (@ClientID,@ClientNum,@AcceptProvince,@AcceptCity,@AcceptCountry,@AcceptCompany,@AcceptAddress,@AcceptPeople,@AcceptTelephone,@AcceptCellphone,@TryeClientCode,@TryeCompany,@TryeClientType,@OP_DATE,@TargetNum,@Longitude,@Latitude,@HouseID,@isDefault)";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientID", DbType.Int64, entity.ClientID);
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@AcceptProvince", DbType.String, entity.AcceptProvince);
                    conn.AddInParameter(cmd, "@AcceptCity", DbType.String, entity.AcceptCity);
                    conn.AddInParameter(cmd, "@AcceptCountry", DbType.String, entity.AcceptCountry);
                    conn.AddInParameter(cmd, "@AcceptCompany", DbType.String, entity.AcceptCompany);
                    conn.AddInParameter(cmd, "@AcceptAddress", DbType.String, entity.AcceptAddress);
                    conn.AddInParameter(cmd, "@AcceptPeople", DbType.String, entity.AcceptPeople);
                    conn.AddInParameter(cmd, "@AcceptTelephone", DbType.String, entity.AcceptTelephone);
                    conn.AddInParameter(cmd, "@AcceptCellphone", DbType.String, entity.AcceptCellphone);
                    conn.AddInParameter(cmd, "@TryeClientCode", DbType.String, entity.TryeClientCode);
                    conn.AddInParameter(cmd, "@TryeCompany", DbType.String, entity.TryeCompany);
                    conn.AddInParameter(cmd, "@TryeClientType", DbType.String, entity.TryeClientType);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@TargetNum", DbType.Int32, entity.TargetNum);
                    conn.AddInParameter(cmd, "@Longitude", DbType.String, entity.Longitude);
                    conn.AddInParameter(cmd, "@Latitude", DbType.String, entity.Latitude);
                    conn.AddInParameter(cmd, "@isDefault", DbType.Int32, entity.isDefault);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改客户地址
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateAcceptAddress(CargoClientAcceptAddressEntity entity)
        {
            try
            {
                entity.EnSafe();
                string strSQL = @"UPDATE Tbl_Cargo_AcceptAddress SET AcceptProvince=@AcceptProvince,AcceptCity=@AcceptCity,AcceptCountry=@AcceptCountry,AcceptCompany=@AcceptCompany,AcceptAddress=@AcceptAddress,AcceptPeople=@AcceptPeople,AcceptTelephone=@AcceptTelephone,AcceptCellphone=@AcceptCellphone,TryeClientCode=@TryeClientCode,TryeCompany=@TryeCompany,TryeClientType=@TryeClientType,TargetNum=@TargetNum,Longitude=@Longitude,Latitude=@Latitude,HouseID=@HouseID,OP_DATE=@OP_DATE,isDefault=@isDefault WHERE ClientNum=@ClientNum and ADID=@ADID";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ADID", DbType.Int64, entity.ADID);
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@AcceptProvince", DbType.String, entity.AcceptProvince);
                    conn.AddInParameter(cmd, "@AcceptCity", DbType.String, entity.AcceptCity);
                    conn.AddInParameter(cmd, "@AcceptCountry", DbType.String, entity.AcceptCountry);
                    conn.AddInParameter(cmd, "@AcceptCompany", DbType.String, entity.AcceptCompany);
                    conn.AddInParameter(cmd, "@AcceptAddress", DbType.String, entity.AcceptAddress);
                    conn.AddInParameter(cmd, "@AcceptPeople", DbType.String, entity.AcceptPeople);
                    conn.AddInParameter(cmd, "@AcceptTelephone", DbType.String, entity.AcceptTelephone);
                    conn.AddInParameter(cmd, "@AcceptCellphone", DbType.String, entity.AcceptCellphone);
                    conn.AddInParameter(cmd, "@TryeClientCode", DbType.String, entity.TryeClientCode);
                    conn.AddInParameter(cmd, "@TryeCompany", DbType.String, entity.TryeCompany);
                    conn.AddInParameter(cmd, "@TryeClientType", DbType.String, entity.TryeClientType);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@TargetNum", DbType.Int32, entity.TargetNum);
                    conn.AddInParameter(cmd, "@Longitude", DbType.String, entity.Longitude);
                    conn.AddInParameter(cmd, "@Latitude", DbType.String, entity.Latitude);
                    conn.AddInParameter(cmd, "@isDefault", DbType.Int32, entity.isDefault);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void RemoveDefaultAcceptAddress(CargoClientAcceptAddressEntity entity)
        {
            try
            {
                string strSQL = @"UPDATE Tbl_Cargo_AcceptAddress SET isDefault=@isDefault,OP_DATE=@OP_DATE WHERE ClientNum=@ClientNum";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@isDefault", DbType.Int32, entity.isDefault);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion
        #region 客户发票管理方法集合
        /// <summary>
        /// 查询发票数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public Hashtable QueryClientInvoiceHeader(int pIndex, int pNum, CargoClientInvoiceHeaderEntity entity)
        {
            List<CargoClientInvoiceHeaderEntity> result = new List<CargoClientInvoiceHeaderEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY OP_DATE DESC) AS RowNumber,* FROM Tbl_Cargo_InvoiceHeader WHERE (1=1)";
                if (!entity.ClientNum.Equals(0)) { strSQL += " and ClientNum = " + entity.ClientNum; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoClientInvoiceHeaderEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                HeaderInfo = Convert.ToString(idr["HeaderInfo"]),
                                HeaderType = Convert.ToString(idr["HeaderType"]),
                                InvoiceType = Convert.ToString(idr["InvoiceType"]),
                                BankName = Convert.ToString(idr["BankName"]),
                                BankNumber = Convert.ToString(idr["BankNumber"]),
                                RegisAddress = Convert.ToString(idr["RegisAddress"]),
                                RegisTelephone = Convert.ToString(idr["RegisTelephone"]),
                                SocialCode = Convert.ToString(idr["SocialCode"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_InvoiceHeader Where (1=1)";
                if (!entity.ClientNum.Equals(0)) { strCount += " and ClientNum = " + entity.ClientNum; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        public void DelClientInvoiceHeader(List<CargoClientInvoiceHeaderEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_InvoiceHeader where ID=@ID ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ID", DbType.Int64, it.ID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 新增发票数据
        /// </summary>
        /// <param name="entity"></param>
        /// <exception cref="ApplicationException"></exception>
        public void AddClientInvoiceHeader(CargoClientInvoiceHeaderEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_InvoiceHeader(ClientNum,HeaderInfo,HeaderType,InvoiceType,SocialCode,BankName,BankNumber,RegisAddress,RegisTelephone,OP_ID) VALUES (@ClientNum,@HeaderInfo,@HeaderType,@InvoiceType,@SocialCode,@BankName,@BankNumber,@RegisAddress,@RegisTelephone,@OP_ID)";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@HeaderInfo", DbType.String, entity.HeaderInfo);
                    conn.AddInParameter(cmd, "@HeaderType", DbType.String, entity.HeaderType);
                    conn.AddInParameter(cmd, "@InvoiceType", DbType.String, entity.InvoiceType);
                    conn.AddInParameter(cmd, "@SocialCode", DbType.String, entity.SocialCode);
                    conn.AddInParameter(cmd, "@BankName", DbType.String, entity.BankName);
                    conn.AddInParameter(cmd, "@BankNumber", DbType.String, entity.BankNumber);
                    conn.AddInParameter(cmd, "@RegisAddress", DbType.String, entity.RegisAddress);
                    conn.AddInParameter(cmd, "@RegisTelephone", DbType.String, entity.RegisTelephone);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void UpdateClientInvoiceHeader(CargoClientInvoiceHeaderEntity entity)
        {
            try
            {
                entity.EnSafe();
                string strSQL = @"UPDATE Tbl_Cargo_InvoiceHeader SET HeaderInfo=@HeaderInfo,HeaderType=@HeaderType,InvoiceType=@InvoiceType,SocialCode=@SocialCode,BankName=@BankName,BankNumber=@BankNumber,RegisAddress=@RegisAddress,RegisTelephone=@RegisTelephone,OP_ID=@OP_ID,OP_DATE=@OP_DATE WHERE ClientNum=@ClientNum and ID=@ID";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@HeaderInfo", DbType.String, entity.HeaderInfo);
                    conn.AddInParameter(cmd, "@HeaderType", DbType.String, entity.HeaderType);
                    conn.AddInParameter(cmd, "@InvoiceType", DbType.String, entity.InvoiceType);
                    conn.AddInParameter(cmd, "@SocialCode", DbType.String, entity.SocialCode);
                    conn.AddInParameter(cmd, "@BankName", DbType.String, entity.BankName);
                    conn.AddInParameter(cmd, "@BankNumber", DbType.String, entity.BankNumber);
                    conn.AddInParameter(cmd, "@RegisAddress", DbType.String, entity.RegisAddress);
                    conn.AddInParameter(cmd, "@RegisTelephone", DbType.String, entity.RegisTelephone);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public bool IsExistClientInvoiceHeader(CargoClientInvoiceHeaderEntity entity)
        {
            string strQ = @"Select ClientNum from Tbl_Cargo_InvoiceHeader Where ClientNum=@ClientNum and HeaderInfo=@HeaderInfo";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ClientNum", DbType.Int32, entity.ClientNum);
                conn.AddInParameter(cmdQ, "@HeaderInfo", DbType.String, entity.HeaderInfo);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }

        public Hashtable QueryClientPostAddress(int pIndex, int pNum, CargoClientPostAddressEntity entity)
        {
            List<CargoClientPostAddressEntity> result = new List<CargoClientPostAddressEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY OP_DATE DESC) AS RowNumber,* FROM Tbl_Cargo_PostAddress WHERE (1=1)";
                if (!entity.ClientNum.Equals(0)) { strSQL += " and ClientNum = " + entity.ClientNum; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoClientPostAddressEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                AcceptAddress = Convert.ToString(idr["AcceptAddress"]),
                                AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                                AcceptCity = Convert.ToString(idr["AcceptCity"]),
                                AcceptCountry = Convert.ToString(idr["AcceptCountry"]),
                                AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                                AcceptProvince = Convert.ToString(idr["AcceptProvince"]),
                                ZipCode = Convert.ToString(idr["ZipCode"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_PostAddress Where (1=1)";
                if (!entity.ClientNum.Equals(0)) { strCount += " and ClientNum = " + entity.ClientNum; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        public void DelClientPostAddress(List<CargoClientPostAddressEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_PostAddress where ID=@ID ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ID", DbType.Int64, it.ID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void AddClientPostAddress(CargoClientPostAddressEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_PostAddress(ClientNum,AcceptProvince,AcceptCity,AcceptCountry,AcceptAddress,AcceptPeople,AcceptCellphone,ZipCode,OP_ID) VALUES (@ClientNum,@AcceptProvince,@AcceptCity,@AcceptCountry,@AcceptAddress,@AcceptPeople,@AcceptCellphone,@ZipCode,@OP_ID)";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@AcceptProvince", DbType.String, entity.AcceptProvince);
                    conn.AddInParameter(cmd, "@AcceptCity", DbType.String, entity.AcceptCity);
                    conn.AddInParameter(cmd, "@AcceptCountry", DbType.String, entity.AcceptCountry);
                    conn.AddInParameter(cmd, "@AcceptAddress", DbType.String, entity.AcceptAddress);
                    conn.AddInParameter(cmd, "@AcceptPeople", DbType.String, entity.AcceptPeople);
                    conn.AddInParameter(cmd, "@AcceptCellphone", DbType.String, entity.AcceptCellphone);
                    conn.AddInParameter(cmd, "@ZipCode", DbType.String, entity.ZipCode);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void UpdateClientPostAddress(CargoClientPostAddressEntity entity)
        {
            try
            {
                entity.EnSafe();
                string strSQL = @"UPDATE Tbl_Cargo_PostAddress SET AcceptProvince=@AcceptProvince,AcceptCity=@AcceptCity,AcceptCountry=@AcceptCountry,AcceptAddress=@AcceptAddress,AcceptPeople=@AcceptPeople,AcceptCellphone=@AcceptCellphone,ZipCode=@ZipCode,OP_ID=@OP_ID,OP_DATE=@OP_DATE WHERE ClientNum=@ClientNum and ID=@ID";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@AcceptProvince", DbType.String, entity.AcceptProvince);
                    conn.AddInParameter(cmd, "@AcceptCity", DbType.String, entity.AcceptCity);
                    conn.AddInParameter(cmd, "@AcceptCountry", DbType.String, entity.AcceptCountry);
                    conn.AddInParameter(cmd, "@AcceptAddress", DbType.String, entity.AcceptAddress);
                    conn.AddInParameter(cmd, "@AcceptPeople", DbType.String, entity.AcceptPeople);
                    conn.AddInParameter(cmd, "@AcceptCellphone", DbType.String, entity.AcceptCellphone);
                    conn.AddInParameter(cmd, "@ZipCode", DbType.String, entity.ZipCode);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public bool IsExistClientPostAddress(CargoClientPostAddressEntity entity)
        {
            string strQ = @"Select ClientNum from Tbl_Cargo_PostAddress Where ClientNum=@ClientNum and AcceptAddress=@AcceptAddress and AcceptPeople=@AcceptPeople and AcceptCellphone=@AcceptCellphone";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ClientNum", DbType.Int32, entity.ClientNum);
                conn.AddInParameter(cmdQ, "@AcceptPeople", DbType.String, entity.AcceptPeople);
                conn.AddInParameter(cmdQ, "@AcceptCellphone", DbType.String, entity.AcceptCellphone);
                conn.AddInParameter(cmdQ, "@AcceptAddress", DbType.String, entity.AcceptAddress);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        #endregion

        #region VIP编码操作方法集合
        /// <summary>
        /// 查询所有的VIP编码 
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <param name="strCountWhere">查询总数的查询条件</param>
        /// <returns></returns>
        public Hashtable QuerySpecialCode(int pIndex, int pNum, CargoSpecialVIPNumEntity entity)
        {
            List<CargoSpecialVIPNumEntity> result = new List<CargoSpecialVIPNumEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.*,b.ClientShortName from Tbl_Cargo_SpecialCode as a left join Tbl_Cargo_Client as b on a.ClientNum=b.ClientNum WHERE (1=1)";
                if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum = " + entity.ClientNum; }
                if (!string.IsNullOrEmpty(entity.Status)) { strSQL += " and a.Status = '" + entity.Status + "'"; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoSpecialVIPNumEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                ClientShortName = Convert.ToString(idr["ClientShortName"]),
                                Status = Convert.ToString(idr["Status"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_SpecialCode Where (1=1)";
                if (!entity.ClientNum.Equals(0)) { strCount += " and ClientNum = " + entity.ClientNum; }
                if (!string.IsNullOrEmpty(entity.Status)) { strCount += " and Status = '" + entity.Status + "'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 保存特殊的客户编码
        /// </summary>
        /// <param name="entity"></param>
        public void SaveSpecialCode(CargoSpecialVIPNumEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_SpecialCode(ClientNum,Status,OP_DATE) VALUES (@ClientNum,@Status,@OP_DATE)";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@Status", DbType.String, entity.Status);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }
        /// <summary>
        /// 判断是否存在相同的客户编码
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistSpecialCode(CargoSpecialVIPNumEntity entity)
        {
            string strQ = @"Select ClientNum from Tbl_Cargo_SpecialCode Where ClientNum=@ClientNum";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ClientNum", DbType.Int32, entity.ClientNum);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 删除特殊的客户编码
        /// </summary>
        /// <param name="entity"></param>
        public void DelSpecialCode(List<CargoSpecialVIPNumEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_SpecialCode where ID=@ID ";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ID", DbType.Int32, it.ID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 解绑特殊的客户编码
        /// </summary>
        /// <param name="entity"></param>
        public void CancelSpecialCode(List<CargoSpecialVIPNumEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"UPDATE Tbl_Cargo_SpecialCode SET Status=0 where ID=@ID ";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ID", DbType.Int32, it.ID);
                        conn.ExecuteNonQuery(cmd);
                    }
                    //解绑客户表
                    CancelCargoClient(new CargoClientEntity { ClientNum = it.ClientNum });
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 设备VIP客户编码状态为已启用
        /// </summary>
        /// <param name="entity"></param>
        private void UpdateSpecialCodeStatus(CargoSpecialVIPNumEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_SpecialCode SET Status='1' where ClientNum=@ClientNum ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改客户预收款
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateClientPreRecord(CargoClientPreRecordEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Client SET ";
            if (entity.OperaType.Equals("0"))
            {
                if (entity.IsAdd) { strSQL += " PreReceiveMoney=PreReceiveMoney+@Money"; }
                else { strSQL += " PreReceiveMoney=PreReceiveMoney-@Money"; }
            }
            else
            {
                if (entity.IsAdd) { strSQL += " RebateMoney=RebateMoney+@Money"; }
                else { strSQL += " RebateMoney=RebateMoney-@Money"; }
            }
            strSQL += " Where ClientID=@ClientID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ClientID", DbType.Int64, entity.ClientID);
                conn.AddInParameter(cmd, "@Money", DbType.Decimal, entity.Money);
                conn.ExecuteNonQuery(cmd);
            }

            AddClientPreRecord(entity);
        }
        #endregion
        #region 客户预收款操作方法集合
        /// <summary>
        /// 保存客户预收款方法
        /// </summary>
        /// <param name="entity"></param>
        public void AddClientPreRecord(CargoClientPreRecordEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_ClientPreRecord(ClientID,ExID,Money,RecordType,OP_ID,OP_DATE,OperaType,RebateType,TryeClientCode,TypeID,RebateDate,Remark) VALUES (@ClientID,@ExID,@Money,@RecordType,@OP_ID,@OP_DATE,@OperaType,@RebateType,@TryeClientCode,@TypeID,@RebateDate,@Remark)";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientID", DbType.Int64, entity.ClientID);
                    conn.AddInParameter(cmd, "@ExID", DbType.String, entity.ExID);
                    conn.AddInParameter(cmd, "@Money", DbType.Decimal, entity.Money);
                    conn.AddInParameter(cmd, "@RecordType", DbType.String, entity.RecordType);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.AddInParameter(cmd, "@OperaType", DbType.String, entity.OperaType);
                    conn.AddInParameter(cmd, "@RebateType", DbType.String, entity.RebateType);
                    conn.AddInParameter(cmd, "@TryeClientCode", DbType.String, entity.TryeClientCode);
                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                    //conn.AddInParameter(cmd, "@RebateDate", DbType.DateTime, entity.RebateDate);
                    conn.AddInParameter(cmd, "@RebateDate", DbType.DateTime, (entity.RebateDate.ToString("yyyy-MM-dd") == "0001-01-01" || entity.RebateDate.ToString("yyyy-MM-dd") == "1900-01-01") ? DateTime.Now : entity.RebateDate);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }
        /// <summary>
        /// 查询客户预收款
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryPreRecord(int pIndex, int pNum, CargoClientPreRecordEntity entity)
        {
            List<CargoClientPreRecordEntity> result = new List<CargoClientPreRecordEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.RebateDate DESC) AS RowNumber,  a.*,b.ClientName,b.Boss,b.ClientNum,ISNULL(b.RebateMoney,0) as RebateMoney,ISNULL(b.PreReceiveMoney,0) as PreReceiveMoney From ( select ClientID,TryeClientCode,ExID,RecordType,OperaType,ISNULL(TypeID,0) as TypeID,RebateDate, Sum(case rebatetype when '1' then Money else 0 end) as 'YB', Sum(case rebatetype when '2' then Money else 0 end) as 'BT', Sum(case rebatetype when '3' then Money else 0 end) as 'HP', Sum(case rebatetype when '4' then Money else 0 end) as 'ROSS', Sum(case rebatetype when '5' then Money else 0 end) as 'MT', Sum(case rebatetype when '6' then Money else 0 end) as 'SB',Sum(case rebatetype when '0' then Money else 0 end) as 'BX',REPLACE(REPLACE(stuff( (select ',' + Remark from Tbl_Cargo_ClientPreRecord where ClientID = cp.ClientID and TryeClientCode=cp.TryeClientCode and ExID=cp.ExID and RecordType=cp.RecordType and OperaType=cp.OperaType and TypeID=cp.TypeID and RebateDate=cp.RebateDate for xml path('')) ,1,1,''),',,',','),',,',',') as Remark From Tbl_Cargo_ClientPreRecord cp group by ClientID,TryeClientCode,ExID,RecordType,OperaType,TypeID,RebateDate ) as a inner join Tbl_Cargo_Client as b on a.ClientID=b.ClientID  WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.OperaType)) { strSQL += " and a.OperaType='" + entity.OperaType + "'"; }
                if (!entity.ClientID.Equals(0)) { strSQL += " and a.ClientID = " + entity.ClientID; }
                //if (!entity.CargoPermisID.Equals(0)) { strSQL += " and b.HouseID in ('" + entity.CargoPermisID + "')"; }
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and b.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!entity.ClientNum.Equals(0)) { strSQL += " and b.ClientNum = " + entity.ClientNum; }
                if (!string.IsNullOrEmpty(entity.ClientName)) { strSQL += " and b.ClientName like '%" + entity.ClientName + "%'"; }
                if (!string.IsNullOrEmpty(entity.Boss)) { strSQL += " and b.Boss like '%" + entity.Boss + "%'"; }
                //日期范围
                //if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                //{
                //    strSQL += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                //}
                //if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                //{
                //    strSQL += " and a.OP_DATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                //}
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoClientPreRecordEntity
                            {
                                //ID = Convert.ToInt32(idr["ID"]),
                                Boss = Convert.ToString(idr["Boss"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                ClientID = Convert.ToInt64(idr["ClientID"]),
                                //RebateType = Convert.ToString(idr["RebateType"]),
                                TryeClientCode = Convert.ToString(idr["TryeClientCode"]),
                                RebateDate = string.IsNullOrEmpty(Convert.ToString(idr["RebateDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["RebateDate"]),
                                RebateMonth = string.IsNullOrEmpty(Convert.ToString(idr["RebateDate"])) ? "" : Convert.ToDateTime(idr["RebateDate"]).ToString("yyyy-MM"),
                                Money = Convert.ToDecimal(idr["BX"]),//报销
                                YBMoney = Convert.ToDecimal(idr["YB"]),//延保
                                BTMoney = Convert.ToDecimal(idr["BT"]),//补贴
                                HPMoney = Convert.ToDecimal(idr["HP"]),//好评
                                ROSSMoney = Convert.ToDecimal(idr["ROSS"]),//ROSS
                                MonthMoney = Convert.ToDecimal(idr["MT"]),//月度达成
                                ShiBaMoney = Convert.ToDecimal(idr["SB"]),//18寸达成
                                RebateMoney = Convert.ToDecimal(idr["RebateMoney"]),
                                PreReceiveMoney = Convert.ToDecimal(idr["PreReceiveMoney"]),
                                ExID = Convert.ToString(idr["ExID"]),
                                RecordType = Convert.ToString(idr["RecordType"]),
                                Remark = Convert.ToString(idr["Remark"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount From (select ClientID,TryeClientCode,ExID,RecordType,OperaType,TypeID,RebateDate, Sum(case rebatetype when '1' then Money else 0 end) as 'YB',Sum(case rebatetype when '2' then Money else 0 end) as 'BT',Sum(case rebatetype when '3' then Money else 0 end) as 'HP',Sum(case rebatetype when '4' then Money else 0 end) as 'ROSS',  Sum(case rebatetype when '5' then Money else 0 end) as 'MT', Sum(case rebatetype when '6' then Money else 0 end) as 'SB',Sum(case rebatetype when '0' then Money else 0 end) as 'BX' From Tbl_Cargo_ClientPreRecord group by ClientID,TryeClientCode,ExID,RecordType,OperaType,TypeID,RebateDate) as a inner join Tbl_Cargo_Client as b on a.ClientID=b.ClientID  WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.OperaType)) { strCount += " and a.OperaType='" + entity.OperaType + "'"; }
                if (!entity.ClientID.Equals(0)) { strCount += " and a.ClientID = " + entity.ClientID; }
                if (!entity.ClientNum.Equals(0)) { strCount += " and b.ClientNum = " + entity.ClientNum; }
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and b.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.ClientName)) { strCount += " and b.ClientName like '%" + entity.ClientName + "%'"; }
                if (!string.IsNullOrEmpty(entity.Boss)) { strCount += " and b.Boss like '%" + entity.Boss + "%'"; }
                //日期范围
                //if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                //{
                //    strCount += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                //}
                //if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                //{
                //    strCount += " and a.OP_DATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                //}
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        #endregion
        #region 微信服务号用户管理方法集合
        /// <summary>
        /// 查询微信服务号用户数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryWxClientCheckData(int pIndex, int pNum, WXUserEntity entity)
        {
            List<WXUserEntity> result = new List<WXUserEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.RegisterDate DESC) AS RowNumber,a.*,c.Name as HouseName FROM Tbl_WX_Client as a left join Tbl_Cargo_Client as b on a.ClientNum=b.ClientNum left join Tbl_Cargo_House as c on b.HouseID=c.HouseID  WHERE (1=1) and a.Cellphone!='' and a.UserType<>2 ";
                //以名称为查询条件
                if (!string.IsNullOrEmpty(entity.Name)) { strSQL += " and a.Name like '%" + entity.Name + "%'"; }
                if (!string.IsNullOrEmpty(entity.CompanyName)) { strSQL += " and a.CompanyName like '%" + entity.CompanyName + "%'"; }
                if (!string.IsNullOrEmpty(entity.wxName)) { strSQL += " and a.wxName like '%" + entity.wxName + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strSQL += " and a.Cellphone = '" + entity.Cellphone + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.RegisterDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.RegisterDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.IsBind))
                {
                    if (entity.IsBind.Equals("0"))
                    {
                        //未绑定
                        strSQL += " and (a.ClientNum is Null Or a.ClientNum=0)";
                    }
                    else
                    {
                        strSQL += " and a.ClientNum>0";
                    }
                }
                if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID = " + entity.HouseID; }
                if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum = " + entity.ClientNum; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new WXUserEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ClientNum = string.IsNullOrEmpty(Convert.ToString(idr["ClientNum"])) ? 0 : Convert.ToInt32(idr["ClientNum"]),
                                Name = Convert.ToString(idr["Name"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                CompanyName = Convert.ToString(idr["CompanyName"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                Address = Convert.ToString(idr["Address"]),
                                wxName = Convert.ToString(idr["wxName"]),
                                wxOpenID = Convert.ToString(idr["wxOpenID"]),
                                AvatarBig = Convert.ToString(idr["AvatarBig"]),
                                AvatarSmall = Convert.ToString(idr["AvatarSmall"]),
                                IDCardNum = Convert.ToString(idr["IDCardNum"]),
                                IsCertific = Convert.ToString(idr["IsCertific"]),
                                ConsumerPoint = Convert.ToInt32(idr["ConsumerPoint"]),
                                Sex = Convert.ToInt32(idr["Sex"]),
                                DenyReason = Convert.ToString(idr["DenyReason"]),
                                Province = Convert.ToString(idr["Province"]),
                                City = Convert.ToString(idr["City"]),
                                Country = Convert.ToString(idr["Country"]),
                                RegisterDate = Convert.ToDateTime(idr["RegisterDate"]),
                                BindDate = string.IsNullOrEmpty(Convert.ToString(idr["BindDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["BindDate"]),
                                ClientPayType = Convert.ToString(idr["ClientPayType"]),
                                BusLicenseImg = Convert.ToString(idr["BusLicenseImg"]),
                                IDCardImg = Convert.ToString(idr["IDCardImg"]),
                                IDCardBackImg = Convert.ToString(idr["IDCardBackImg"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_WX_Client as a left join Tbl_Cargo_Client as b on a.ClientNum=b.ClientNum left join Tbl_Cargo_House as c on b.HouseID=c.HouseID Where (1=1) and a.Cellphone!=''";
                //以名称为查询条件
                if (!string.IsNullOrEmpty(entity.Name)) { strCount += " and a.Name like '%" + entity.Name + "%'"; }
                if (!string.IsNullOrEmpty(entity.CompanyName)) { strCount += " and a.CompanyName like '%" + entity.CompanyName + "%'"; }
                if (!string.IsNullOrEmpty(entity.wxName)) { strCount += " and a.wxName like '%" + entity.wxName + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strCount += " and a.Cellphone = '" + entity.Cellphone + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.RegisterDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.RegisterDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.IsBind))
                {
                    if (entity.IsBind.Equals("0"))
                    {
                        //未绑定
                        strCount += " and (a.ClientNum is Null Or a.ClientNum=0)";
                    }
                    else
                    {
                        strCount += " and a.ClientNum>0";
                    }
                }
                if (!entity.HouseID.Equals(0)) { strCount += " and b.HouseID = " + entity.HouseID; }
                if (!entity.ClientNum.Equals(0)) { strCount += " and a.ClientNum = " + entity.ClientNum; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 修改用户的管理员属性
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateWxClientManager(WXUserEntity entity)
        {
            string strSQL = @"UPDATE Tbl_WX_Client Set IsManager=@IsManager Where ID=@ID";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@IsManager", DbType.String, entity.IsManager);
                conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 绑定微信用户的店代码
        /// </summary>
        /// <param name="entity"></param>
        public void saveWxUserBind(WXUserEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"UPDATE Tbl_WX_Client Set ClientNum=@ClientNum,BindDate=@BindDate,IsManager=@IsManager Where ID=@ID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@IsManager", DbType.String, entity.IsManager);
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@BindDate", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                    conn.ExecuteNonQuery(cmd);
                }
                CargoWeiXinManager wxman = new CargoWeiXinManager();
                wxman.UpdateWxUserLogicName(new WXUserEntity { ID = entity.ID, LogisID = entity.LogisID, LogicName = entity.LogicName });
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 保存拒审原因
        /// </summary>
        /// <param name="entity"></param>
        public void saveDenyReason(WXUserEntity entity)
        {
            string strSQL = @"UPDATE Tbl_WX_Client Set DenyReason=@DenyReason Where ID=@ID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@DenyReason", DbType.String, entity.DenyReason);
                    conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion
        #region 客户来款数据记录集合
        /// <summary>
        /// 新增客户来款记录
        /// </summary>
        /// <param name="entity"></param>
        public void AddClientIncome(CargoClientIncomeEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"INSERT INTO Tbl_Cargo_InComeMoney(ClientNum,ClientID,Money,CreateDate,RecordType,BasicID,HouseID,OP_ID) VALUES (@ClientNum,@ClientID,@Money,@CreateDate,@RecordType,@BasicID,@HouseID,@OP_ID)";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                conn.AddInParameter(cmd, "@ClientID", DbType.Int64, entity.ClientID);
                conn.AddInParameter(cmd, "@Money", DbType.Decimal, entity.Money);
                conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, entity.CreateDate);
                conn.AddInParameter(cmd, "@RecordType", DbType.String, entity.RecordType);
                conn.AddInParameter(cmd, "@BasicID", DbType.Int32, entity.BasicID);
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改客户来款记录
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateClientIncome(CargoClientIncomeEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"Update Tbl_Cargo_InComeMoney set Money=@Money,CreateDate=@CreateDate,BasicID=@BasicID,OP_ID=@OP_ID,OP_DATE=@OP_DATE Where IncomeID=@IncomeID";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@IncomeID", DbType.Int64, entity.IncomeID);
                conn.AddInParameter(cmd, "@Money", DbType.Decimal, entity.Money);
                conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, entity.CreateDate);
                conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                conn.AddInParameter(cmd, "@BasicID", DbType.Int32, entity.BasicID);
                conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 删除 客户来款记录
        /// </summary>
        /// <param name="entity"></param>
        public void DelClientIncome(List<CargoClientIncomeEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_InComeMoney where IncomeID=@IncomeID ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@IncomeID", DbType.Int64, it.IncomeID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 查询客户来款数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryClientIncome(int pIndex, int pNum, CargoClientIncomeEntity entity)
        {
            List<CargoClientIncomeEntity> result = new List<CargoClientIncomeEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.CreateDate DESC) AS RowNumber,a.*,c.Boss,b.CardType,b.Aliases,b.Bank,b.CardName,b.CardNum From Tbl_Cargo_InComeMoney as a inner join Tbl_Cargo_BasicData as b on a.BasicID=b.BasicID inner join Tbl_Cargo_Client as c on a.ClientID=c.ClientID WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.Boss)) { strSQL += " and c.Boss like '%" + entity.Boss + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strSQL += " and c.Cellphone like '%" + entity.Cellphone + "%'"; }
                if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum = " + entity.ClientNum; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoClientIncomeEntity
                            {
                                IncomeID = Convert.ToInt64(idr["IncomeID"]),
                                ClientID = Convert.ToInt64(idr["ClientID"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                Money = Convert.ToDecimal(idr["Money"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                BasicID = Convert.ToInt32(idr["BasicID"]),
                                CardType = Convert.ToString(idr["CardType"]),
                                Aliases = Convert.ToString(idr["Aliases"]),
                                Bank = Convert.ToString(idr["Bank"]),
                                CardName = Convert.ToString(idr["CardName"]),
                                CardNum = Convert.ToString(idr["CardNum"]),
                                Boss = Convert.ToString(idr["Boss"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount From Tbl_Cargo_InComeMoney as a inner join Tbl_Cargo_BasicData as b on a.BasicID=b.BasicID inner join Tbl_Cargo_Client as c on a.ClientID=c.ClientID Where (1=1)";
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.Boss)) { strCount += " and c.Boss like '%" + entity.Boss + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strCount += " and c.Cellphone like '%" + entity.Cellphone + "%'"; }
                if (!entity.ClientNum.Equals(0)) { strCount += " and a.ClientNum = " + entity.ClientNum; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 查询客户来款 数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoClientIncomeEntity> QueryClientIncome(CargoClientIncomeEntity entity)
        {
            List<CargoClientIncomeEntity> result = new List<CargoClientIncomeEntity>();
            string strSQL = "Select a.*,c.Boss From Tbl_Cargo_InComeMoney as a inner join Tbl_Cargo_Client as c on a.ClientID=c.ClientID WHERE (1=1)";
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum = " + entity.ClientNum; }
            //制单日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoClientIncomeEntity
                        {
                            IncomeID = Convert.ToInt64(idr["IncomeID"]),
                            ClientID = Convert.ToInt64(idr["ClientID"]),
                            ClientNum = Convert.ToInt32(idr["ClientNum"]),
                            Money = Convert.ToDecimal(idr["Money"]),
                            CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                            Boss = Convert.ToString(idr["Boss"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            OP_ID = Convert.ToString(idr["OP_ID"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                        });
                    }
                }
            }
            return result;
        }
        #endregion
        #region 客户账单管理
        /// <summary>
        /// 查询当前日期当前仓库账单表中最大顺序号
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public int GetMaxAccountNumByCurDate(CargoClientAccountEntity entity)
        {
            int result = 0;
            try
            {
                string strSQL = @"select Count(*) as OrderNum from Tbl_Cargo_ClientAccount where HouseID=@HouseID ";
                strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@HouseID", DbType.Int32, entity.HouseID);
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        if (dd.Rows.Count > 0) { result = Convert.ToInt32(dd.Rows[0]["OrderNum"]); }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 新增账单
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoAccount(CargoClientAccountEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_ClientAccount(AccountID,AccountTitle,CreateDate,ClientID,ClientNum,ARMoney,Total,TaxFee,OtherFee,Memo,Status,NextCheckID,NextCheckName,CheckStatus,OPID,OPDATE,AType,HouseID) VALUES (@AccountID,@AccountTitle,@CreateDate,@ClientID,@ClientNum,@ARMoney,@Total,@TaxFee,@OtherFee,@Memo,@Status,@NextCheckID,@NextCheckName,@CheckStatus,@OPID,@OPDATE,@AType,@HouseID)";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@AccountID", DbType.String, entity.AccountID);
                    conn.AddInParameter(cmd, "@AccountTitle", DbType.String, entity.AccountTitle);
                    conn.AddInParameter(cmd, "@ClientID", DbType.Int64, entity.ClientID);
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, entity.CreateDate);
                    conn.AddInParameter(cmd, "@ARMoney", DbType.Decimal, entity.ARMoney);
                    conn.AddInParameter(cmd, "@Total", DbType.Decimal, entity.Total);
                    conn.AddInParameter(cmd, "@TaxFee", DbType.Decimal, entity.TaxFee);
                    conn.AddInParameter(cmd, "@OtherFee", DbType.Decimal, entity.OtherFee);
                    conn.AddInParameter(cmd, "@Memo", DbType.String, entity.Memo);
                    conn.AddInParameter(cmd, "@Status", DbType.String, entity.Status);
                    conn.AddInParameter(cmd, "@NextCheckID", DbType.String, entity.NextCheckID);
                    conn.AddInParameter(cmd, "@NextCheckName", DbType.String, entity.NextCheckName);
                    conn.AddInParameter(cmd, "@CheckStatus", DbType.String, entity.CheckStatus);
                    conn.AddInParameter(cmd, "@OPID", DbType.String, entity.OPID);
                    conn.AddInParameter(cmd, "@OPDATE", DbType.String, DateTime.Now);
                    conn.AddInParameter(cmd, "@AType", DbType.String, entity.AType);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改账单
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoAccount(CargoClientAccountEntity entity)
        {
            string strSQL = "Update Tbl_Cargo_ClientAccount set AccountTitle=@AccountTitle,ClientID=@ClientID,ClientNum=@ClientNum,ARMoney=@ARMoney,Total=@Total,TaxFee=@TaxFee,OtherFee=@OtherFee,Memo=@Memo,OPID=@OPID,OPDATE=@OPDATE,AType=@AType,HouseID=@HouseID Where AccountID=@AccountID";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@AccountID", DbType.String, entity.AccountID);
                conn.AddInParameter(cmd, "@AccountTitle", DbType.String, entity.AccountTitle);
                conn.AddInParameter(cmd, "@ClientID", DbType.Int64, entity.ClientID);
                conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                conn.AddInParameter(cmd, "@ARMoney", DbType.Decimal, entity.ARMoney);
                conn.AddInParameter(cmd, "@Total", DbType.Decimal, entity.Total);
                conn.AddInParameter(cmd, "@TaxFee", DbType.Decimal, entity.TaxFee);
                conn.AddInParameter(cmd, "@OtherFee", DbType.Decimal, entity.OtherFee);
                conn.AddInParameter(cmd, "@Memo", DbType.String, entity.Memo);
                conn.AddInParameter(cmd, "@OPID", DbType.String, entity.OPID);
                conn.AddInParameter(cmd, "@OPDATE", DbType.String, DateTime.Now);
                conn.AddInParameter(cmd, "@AType", DbType.String, entity.AType);
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改订单的账单号
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateOrderAccountNo(CargoClientAccountEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Order SET AccountNo=@AccountNo where OrderNo=@OrderNo";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@AccountNo", DbType.String, entity.AccountID);
                conn.AddInParameter(cmd, "@OrderNo", DbType.String, entity.OrderNo);
                conn.ExecuteNonQuery(cmd);
            }
        }
       
        public void DeleteOrderAccountNo(string AccountNo)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Order SET AccountNo='' where AccountNo=@AccountNo";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@AccountNo", DbType.String, AccountNo);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 查询客户账单 
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryBillManager(int pIndex, int pNum, CargoClientAccountEntity entity)
        {
            List<CargoClientAccountEntity> result = new List<CargoClientAccountEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OPDATE DESC) AS RowNumber,a.*,b.Name as HouseName,c.Boss FROM Tbl_Cargo_ClientAccount as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID inner join Tbl_Cargo_Client as c on a.ClientID=c.ClientID WHERE (1=1)";
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID = " + entity.HouseID; }
                if (!string.IsNullOrEmpty(entity.AccountID)) { strSQL += " and a.AccountID = '" + entity.AccountID + "'"; }
                if (!entity.ClientID.Equals(0)) { strSQL += " and a.ClientID = " + entity.ClientID; }
                if (!string.IsNullOrEmpty(entity.Status)) { strSQL += " and a.Status = '" + entity.Status + "'"; }
                if (!string.IsNullOrEmpty(entity.ElecSign)) { strSQL += " and a.ElecSign = '" + entity.ElecSign + "'"; }
                if (!string.IsNullOrEmpty(entity.CheckStatus)) { strSQL += " and a.CheckStatus = '" + entity.CheckStatus + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoClientAccountEntity
                            {
                                ClientID = Convert.ToInt64(idr["ClientID"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                ClientName = Convert.ToString(idr["Boss"]),
                                AccountID = Convert.ToString(idr["AccountID"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                AccountTitle = Convert.ToString(idr["AccountTitle"]),
                                ARMoney = string.IsNullOrEmpty(Convert.ToString(idr["ARMoney"])) ? 0 : Convert.ToDecimal(idr["ARMoney"]),
                                Total = string.IsNullOrEmpty(Convert.ToString(idr["Total"])) ? 0 : Convert.ToDecimal(idr["Total"]),
                                TaxFee = string.IsNullOrEmpty(Convert.ToString(idr["TaxFee"])) ? 0 : Convert.ToDecimal(idr["TaxFee"]),
                                OtherFee = string.IsNullOrEmpty(Convert.ToString(idr["OtherFee"])) ? 0 : Convert.ToDecimal(idr["OtherFee"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                Status = Convert.ToString(idr["Status"]),
                                NextCheckID = Convert.ToString(idr["NextCheckID"]),
                                NextCheckName = Convert.ToString(idr["NextCheckName"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                ElecSign = Convert.ToString(idr["ElecSign"]),
                                ElecSignImg = Convert.ToString(idr["ElecSignImg"]),
                                ElecSignDate = string.IsNullOrEmpty(Convert.ToString(idr["ElecSignDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["ElecSignDate"]),
                                OPID = Convert.ToString(idr["OPID"]),
                                OPDATE = Convert.ToDateTime(idr["OPDATE"]),
                                AType = Convert.ToString(idr["AType"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseID = Convert.ToInt32(idr["HouseID"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"select count(*) as TotalCount from Tbl_Cargo_ClientAccount as a Where(1 = 1)";
                if (!entity.HouseID.Equals(0)) { strCount += " and a.HouseID = " + entity.HouseID; }
                if (!string.IsNullOrEmpty(entity.AccountID)) { strCount += " and a.AccountID = '" + entity.AccountID + "'"; }
                if (!entity.ClientID.Equals(0)) { strCount += " and a.ClientID = " + entity.ClientID; }
                if (!string.IsNullOrEmpty(entity.Status)) { strCount += " and a.Status = '" + entity.Status + "'"; }
                if (!string.IsNullOrEmpty(entity.ElecSign)) { strCount += " and a.ElecSign = '" + entity.ElecSign + "'"; }
                if (!string.IsNullOrEmpty(entity.CheckStatus)) { strCount += " and a.CheckStatus = '" + entity.CheckStatus + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 查询客户账单
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoClientAccountEntity QueryCargoClientAccount(CargoClientAccountEntity entity)
        {
            CargoClientAccountEntity result = new CargoClientAccountEntity();
            try
            {
                string strSQL = @"SELECT a.*,b.Name as HouseName,c.Boss FROM Tbl_Cargo_ClientAccount as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID inner join Tbl_Cargo_Client as c on a.ClientID=c.ClientID  Where (1=1)";
                if (!string.IsNullOrEmpty(entity.AccountID)) { strSQL += " and a.AccountID='" + entity.AccountID + "'"; }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.ClientID = Convert.ToInt64(idr["ClientID"]);
                            result.ClientNum = Convert.ToInt32(idr["ClientNum"]);
                            result.ClientID = Convert.ToInt64(idr["ClientID"]);
                            result.ClientNum = Convert.ToInt32(idr["ClientNum"]);
                            result.ClientName = Convert.ToString(idr["Boss"]);
                            result.AccountID = Convert.ToString(idr["AccountID"]);
                            result.CreateDate = Convert.ToDateTime(idr["CreateDate"]);
                            result.AccountTitle = Convert.ToString(idr["AccountTitle"]);
                            result.ARMoney = string.IsNullOrEmpty(Convert.ToString(idr["ARMoney"])) ? 0 : Convert.ToDecimal(idr["ARMoney"]);
                            result.Total = string.IsNullOrEmpty(Convert.ToString(idr["Total"])) ? 0 : Convert.ToDecimal(idr["Total"]);
                            result.TaxFee = string.IsNullOrEmpty(Convert.ToString(idr["TaxFee"])) ? 0 : Convert.ToDecimal(idr["TaxFee"]);
                            result.OtherFee = string.IsNullOrEmpty(Convert.ToString(idr["OtherFee"])) ? 0 : Convert.ToDecimal(idr["OtherFee"]);
                            result.Memo = Convert.ToString(idr["Memo"]);
                            result.Status = Convert.ToString(idr["Status"]);
                            result.NextCheckID = Convert.ToString(idr["NextCheckID"]);
                            result.NextCheckName = Convert.ToString(idr["NextCheckName"]);
                            result.CheckStatus = Convert.ToString(idr["CheckStatus"]);
                            result.OPID = Convert.ToString(idr["OPID"]);
                            result.OPDATE = Convert.ToDateTime(idr["OPDATE"]);
                            result.AType = Convert.ToString(idr["AType"]);
                            result.HouseName = Convert.ToString(idr["HouseName"]);
                            result.HouseID = Convert.ToInt32(idr["HouseID"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 删除客户账单
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoAccount(CargoClientAccountEntity entity)
        {
            string strSQL = @"Delete from Tbl_Cargo_ClientAccount where AccountID=@AccountID ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@AccountID", DbType.String, entity.AccountID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改账单 的结算状态 ，同时修改账单 里的订单的结算状态 
        /// </summary>
        /// <param name="AccountID"></param>
        /// <param name="CheckStatus"></param>
        public void UpdateClientAccountCheckStatus(string AccountID, string CheckStatus)
        {
            string strDel = @"UPDATE Tbl_Cargo_ClientAccount SET CheckStatus=@CheckStatus WHERE AccountID=@AccountID";
            using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
            {
                conn.AddInParameter(cmdAdd, "@CheckStatus", DbType.String, CheckStatus);
                conn.AddInParameter(cmdAdd, "@AccountID", DbType.String, AccountID);
                conn.ExecuteNonQuery(cmdAdd);
            }
            string strSQL = @"UPDATE Tbl_Cargo_Order SET CheckStatus=@CheckStatus WHERE AccountNo=@AccountNo";
            using (DbCommand cmdSQL = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmdSQL, "@CheckStatus", DbType.String, CheckStatus);
                conn.AddInParameter(cmdSQL, "@AccountNo", DbType.String, AccountID);
                conn.ExecuteNonQuery(cmdSQL);
            }
        }
        /// <summary>
        /// 查询客户本月账单
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<APPClientAccountEntity> QueryClientAccountAPP(int pIndex, int pNum, APPClientAccountEntity entity)
        {
            List<APPClientAccountEntity> result = new List<APPClientAccountEntity>();
            string strSQL = "SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.CreateDate DESC) AS RowNumber,a.*,b.Name as HouseName,c.Boss as ClientName From Tbl_Cargo_ClientAccount as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID inner join Tbl_Cargo_Client as c on a.ClientID=c.ClientID Where (1=1) and a.Status='1'";
            if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum=" + entity.ClientNum; }
            if (!string.IsNullOrEmpty(entity.CheckStatus)) { strSQL += " and a.CheckStatus='" + entity.CheckStatus + "'"; }
            //if (!entity.HouseID.Equals(0)) { strSQL += " and HouseID = " + entity.HouseID; }
            //制单日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
            //strSQL += " Order By a.CreateDate desc";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new APPClientAccountEntity
                        {
                            ClientID = Convert.ToInt64(idr["ClientID"]),
                            ClientNum = Convert.ToInt32(idr["ClientNum"]),
                            ClientName = Convert.ToString(idr["ClientName"]),
                            AccountID = Convert.ToString(idr["AccountID"]),
                            AccountTitle = Convert.ToString(idr["AccountTitle"]),
                            AType = Convert.ToString(idr["AType"]),
                            CheckStatus = Convert.ToString(idr["CheckStatus"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            HouseName = Convert.ToString(idr["HouseName"]),
                            Memo = Convert.ToString(idr["Memo"]),
                            ElecSign = Convert.ToString(idr["ElecSign"]),
                            CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                            Total = Convert.ToDecimal(idr["Total"]),
                            TaxFee = Convert.ToDecimal(idr["TaxFee"]),
                            OtherFee = Convert.ToDecimal(idr["OtherFee"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询客户账单明细列表
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public APPClientAccountEntity QueryClientAccountInfo(APPClientAccountEntity entity)
        {
            APPClientAccountEntity result = new APPClientAccountEntity();
            string strSQL = "select a.*,b.Name as HouseName,c.Boss as ClientName,ISNULL(c.RebateMoney,0) as RebateMoney From Tbl_Cargo_ClientAccount as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID inner join Tbl_Cargo_Client as c on a.ClientID=c.ClientID Where AccountID=@AccountID";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@AccountID", DbType.String, entity.AccountID);
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.ClientID = Convert.ToInt64(idr["ClientID"]);
                        result.ClientNum = Convert.ToInt32(idr["ClientNum"]);
                        result.ClientName = Convert.ToString(idr["ClientName"]);
                        result.AccountID = Convert.ToString(idr["AccountID"]);
                        result.AccountTitle = Convert.ToString(idr["AccountTitle"]);
                        result.AType = Convert.ToString(idr["AType"]);
                        result.CheckStatus = Convert.ToString(idr["CheckStatus"]);
                        result.HouseID = Convert.ToInt32(idr["HouseID"]);
                        result.HouseName = Convert.ToString(idr["HouseName"]);
                        result.Memo = Convert.ToString(idr["Memo"]);
                        result.CreateDate = Convert.ToDateTime(idr["CreateDate"]);
                        result.Total = Convert.ToDecimal(idr["Total"]);
                        result.TaxFee = Convert.ToDecimal(idr["TaxFee"]);
                        result.OtherFee = Convert.ToDecimal(idr["OtherFee"]);
                        result.ElecSign = Convert.ToString(idr["ElecSign"]);
                        result.RebateMoney = Convert.ToDecimal(idr["RebateMoney"]);
                        result.OrderList = QueryOrderInfo(new APPClientOrderEntity { AccountID = Convert.ToString(idr["AccountID"]) });
                        List<APPClientIncomeMoneyEntity> incomelist = QueryClientIncomeInfo(new APPClientIncomeMoneyEntity { ClientID = Convert.ToInt64(idr["ClientID"]), StartDate = Convert.ToDateTime(idr["CreateDate"]).AddMonths(-1).AddDays(-Convert.ToDateTime(idr["CreateDate"]).Day), EndDate = Convert.ToDateTime(idr["CreateDate"]).AddDays(-Convert.ToDateTime(idr["CreateDate"]).Day) });
                        decimal incMoney = 0.00M;
                        foreach (var it in incomelist) { incMoney += it.IncomeMoney; }
                        result.IncomeMoney = incMoney;
                        result.IncomeList = incomelist;
                        result.RebateList = QueryClientRebateInfo(new APPClientRebateEntity { ClientID = Convert.ToInt64(idr["ClientID"]), StartDate = Convert.ToDateTime(idr["CreateDate"]).AddMonths(-1).AddDays(-Convert.ToDateTime(idr["CreateDate"]).Day), EndDate = Convert.ToDateTime(idr["CreateDate"]).AddDays(-Convert.ToDateTime(idr["CreateDate"]).Day) });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询账单关联的订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        private List<APPClientOrderEntity> QueryOrderInfo(APPClientOrderEntity entity)
        {
            List<APPClientOrderEntity> result = new List<APPClientOrderEntity>();
            try
            {
                string strSQL = @"Select OrderNo,Piece,TotalCharge,AcceptPeople,AcceptCellphone,CreateDate,OrderModel,CheckStatus,SaleManName from Tbl_Cargo_Order Where AccountNo=@AccountNo";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@AccountNo", DbType.String, entity.AccountID);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new APPClientOrderEntity
                            {
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                TotalCharge = Convert.ToDecimal(idr["TotalCharge"]),
                                AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                                AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                SaleManName = Convert.ToString(idr["SaleManName"]),
                                OrderGoodsList = QueryOrderGoodsInfo(new APPClientOrderGoodsEntity { OrderNo = Convert.ToString(idr["OrderNo"]) })
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        private List<APPClientOrderGoodsEntity> QueryOrderGoodsInfo(APPClientOrderGoodsEntity entity)
        {
            List<APPClientOrderGoodsEntity> result = new List<APPClientOrderGoodsEntity>();
            string strSQL = @"select a.OrderNo,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,b.Batch,b.BatchYear,a.Piece,a.ActSalePrice,c.TypeName from Tbl_Cargo_OrderGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductType as c on b.TypeID=c.TypeID where a.OrderNo=@OrderNo";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@OrderNo", DbType.String, entity.OrderNo);
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new APPClientOrderGoodsEntity
                        {
                            OrderNo = Convert.ToString(idr["OrderNo"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            Specs = Convert.ToString(idr["Specs"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            Batch = Convert.ToString(idr["Batch"]),
                            BatchYear = Convert.ToInt32(idr["BatchYear"]),
                            ActSalePrice = Convert.ToDecimal(idr["ActSalePrice"]),
                            Piece = Convert.ToInt32(idr["Piece"]),
                        });
                    }
                }
            }
            return result;
        }
        private List<APPClientIncomeMoneyEntity> QueryClientIncomeInfo(APPClientIncomeMoneyEntity entity)
        {
            List<APPClientIncomeMoneyEntity> result = new List<APPClientIncomeMoneyEntity>();
            string strSQL = "Select a.* From Tbl_Cargo_InComeMoney as a WHERE (1=1)";
            if (!entity.ClientID.Equals(0)) { strSQL += " and a.ClientID = " + entity.ClientID; }
            if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum = " + entity.ClientNum; }
            //制单日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new APPClientIncomeMoneyEntity
                        {
                            ClientID = Convert.ToInt64(idr["ClientID"]),
                            IncomeMoney = Convert.ToDecimal(idr["Money"]),
                            IncomeDate = Convert.ToDateTime(idr["CreateDate"])
                        });
                    }
                }
            }
            return result;
        }
        private List<APPClientRebateEntity> QueryClientRebateInfo(APPClientRebateEntity entity)
        {
            List<APPClientRebateEntity> result = new List<APPClientRebateEntity>();
            string strSQL = "select RebateType,RebateDate,Money,ClientID From Tbl_Cargo_ClientPreRecord where OperaType=1 and RecordType=0 ";
            if (!entity.ClientID.Equals(0)) { strSQL += " and ClientID = " + entity.ClientID; }
            //制单日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and RebateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and RebateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new APPClientRebateEntity
                        {
                            ClientID = Convert.ToInt64(idr["ClientID"]),
                            RebateMoney = Convert.ToDecimal(idr["Money"]),
                            RebateType = Convert.ToString(idr["RebateType"]),
                            RebateDate = Convert.ToDateTime(idr["RebateDate"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 保存客户的账单签名照片
        /// </summary>
        /// <param name="entity"></param>
        public void SaveAccountElecSign(CargoClientAccountEntity entity)
        {
            string strDel = @"UPDATE Tbl_Cargo_ClientAccount SET ElecSign=@ElecSign,ElecSignDate=@ElecSignDate,ElecSignImg=@ElecSignImg WHERE AccountID=@AccountID";
            using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
            {
                conn.AddInParameter(cmdAdd, "@ElecSign", DbType.String, entity.ElecSign);
                conn.AddInParameter(cmdAdd, "@ElecSignImg", DbType.String, entity.ElecSignImg);
                conn.AddInParameter(cmdAdd, "@ElecSignDate", DbType.DateTime, DateTime.Now);
                conn.AddInParameter(cmdAdd, "@AccountID", DbType.String, entity.AccountID);
                conn.ExecuteNonQuery(cmdAdd);
            }
        }
        /// <summary>
        /// 查询客户的账单还款情况
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoClientAccountEntity> QueryClientAccountPay(CargoClientAccountEntity entity)
        {
            bool CurMonth = false;
            List<CargoClientAccountEntity> result = new List<CargoClientAccountEntity>();
            string strSQL = "SELECT a.*,c.Boss From Tbl_Cargo_ClientAccount as a inner join Tbl_Cargo_Client as c on a.ClientID=c.ClientID Where a.ClientNum=@ClientNum Order by a.CreateDate asc";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@ClientNum", DbType.Int32, entity.ClientNum);
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    decimal NoP = 0.00M;
                    foreach (DataRow idr in dd.Rows)
                    {
                        if (Convert.ToDateTime(idr["CreateDate"]).AddMonths(-1).Month.Equals(DateTime.Now.Month)) { CurMonth = true; }
                        List<APPClientIncomeMoneyEntity> incomelist = QueryClientIncomeInfo(new APPClientIncomeMoneyEntity { ClientID = Convert.ToInt64(idr["ClientID"]), StartDate = Convert.ToDateTime(idr["CreateDate"]).AddMonths(-1).AddDays(-Convert.ToDateTime(idr["CreateDate"]).Day), EndDate = Convert.ToDateTime(idr["CreateDate"]).AddDays(-Convert.ToDateTime(idr["CreateDate"]).Day) });
                        List<APPClientRebateEntity> rebateList = QueryClientRebateInfo(new APPClientRebateEntity { ClientID = Convert.ToInt64(idr["ClientID"]), StartDate = Convert.ToDateTime(idr["CreateDate"]).AddMonths(-1).AddDays(-Convert.ToDateTime(idr["CreateDate"]).Day), EndDate = Convert.ToDateTime(idr["CreateDate"]).AddDays(-Convert.ToDateTime(idr["CreateDate"]).Day) });
                        decimal IncomeMoney = incomelist.Sum(c => c.IncomeMoney);
                        decimal RebateMoney = rebateList.Sum(c => c.RebateMoney);
                        NoP = NoP + Convert.ToDecimal(idr["Total"]) - IncomeMoney - RebateMoney;
                        result.Add(new CargoClientAccountEntity
                        {
                            ClientID = Convert.ToInt64(idr["ClientID"]),
                            ClientNum = Convert.ToInt32(idr["ClientNum"]),
                            ClientName = Convert.ToString(idr["Boss"]),
                            AccountID = Convert.ToString(idr["AccountID"]),
                            CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                            AccountDate = Convert.ToDateTime(idr["CreateDate"]).AddMonths(-1).Year + "年" + Convert.ToDateTime(idr["CreateDate"]).AddMonths(-1).Month + "月",
                            AccountTitle = Convert.ToString(idr["AccountTitle"]),
                            ARMoney = string.IsNullOrEmpty(Convert.ToString(idr["ARMoney"])) ? 0 : Convert.ToDecimal(idr["ARMoney"]),
                            Total = string.IsNullOrEmpty(Convert.ToString(idr["Total"])) ? 0 : Convert.ToDecimal(idr["Total"]),
                            TaxFee = string.IsNullOrEmpty(Convert.ToString(idr["TaxFee"])) ? 0 : Convert.ToDecimal(idr["TaxFee"]),
                            OtherFee = string.IsNullOrEmpty(Convert.ToString(idr["OtherFee"])) ? 0 : Convert.ToDecimal(idr["OtherFee"]),
                            Memo = Convert.ToString(idr["Memo"]),
                            Status = Convert.ToString(idr["Status"]),
                            CheckStatus = Convert.ToString(idr["CheckStatus"]),
                            ElecSign = Convert.ToString(idr["ElecSign"]),
                            ElecSignImg = Convert.ToString(idr["ElecSignImg"]),
                            ElecSignDate = string.IsNullOrEmpty(Convert.ToString(idr["ElecSignDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["ElecSignDate"]),
                            IncomeMoney = IncomeMoney,
                            RebateMoney = RebateMoney,
                            PreReceiveMoney = NoP
                        });
                    }
                    if (!CurMonth)
                    {
                        //表示没有账单数据
                        List<APPClientIncomeMoneyEntity> Lastincomelist = QueryClientIncomeInfo(new APPClientIncomeMoneyEntity { ClientNum = entity.ClientNum, StartDate = DateTime.Now.AddDays(-DateTime.Now.Day), EndDate = DateTime.Now });
                        if (Lastincomelist.Count > 0)
                        {
                            decimal IncomeMoney = Lastincomelist.Sum(c => c.IncomeMoney);
                            result.Add(new CargoClientAccountEntity
                            {
                                AccountTitle = "",
                                Total = 0,
                                CreateDate = DateTime.Now,
                                AccountDate = DateTime.Now.Year + "年" + DateTime.Now.Month + "月",
                                IncomeMoney = IncomeMoney,
                                RebateMoney = 0,
                                PreReceiveMoney = NoP - IncomeMoney
                            });
                        }
                    }
                }
            }
            result = result.OrderByDescending(c => c.CreateDate).ToList();
            return result;
        }
        /// <summary>
        /// 查询客户的账单还款情况
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<APPClientAccountEntity> QueryClientPayInfoAPP(APPClientAccountEntity entity)
        {
            bool CurMonth = false;
            List<APPClientAccountEntity> result = new List<APPClientAccountEntity>();
            string strSQL = "SELECT a.*,c.Boss From Tbl_Cargo_ClientAccount as a inner join Tbl_Cargo_Client as c on a.ClientID=c.ClientID Where a.ClientNum=@ClientNum Order by a.CreateDate asc";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@ClientNum", DbType.Int32, entity.ClientNum);
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    decimal NoP = 0.00M;
                    foreach (DataRow idr in dd.Rows)
                    {
                        if (Convert.ToDateTime(idr["CreateDate"]).AddMonths(-1).Month.Equals(DateTime.Now.Month)) { CurMonth = true; }
                        List<APPClientIncomeMoneyEntity> incomelist = QueryClientIncomeInfo(new APPClientIncomeMoneyEntity { ClientID = Convert.ToInt64(idr["ClientID"]), StartDate = Convert.ToDateTime(idr["CreateDate"]).AddMonths(-1).AddDays(-Convert.ToDateTime(idr["CreateDate"]).Day), EndDate = Convert.ToDateTime(idr["CreateDate"]).AddDays(-Convert.ToDateTime(idr["CreateDate"]).Day) });
                        List<APPClientRebateEntity> rebateList = QueryClientRebateInfo(new APPClientRebateEntity { ClientID = Convert.ToInt64(idr["ClientID"]), StartDate = Convert.ToDateTime(idr["CreateDate"]).AddMonths(-1).AddDays(-Convert.ToDateTime(idr["CreateDate"]).Day), EndDate = Convert.ToDateTime(idr["CreateDate"]).AddDays(-Convert.ToDateTime(idr["CreateDate"]).Day) });
                        decimal IncomeMoney = incomelist.Sum(c => c.IncomeMoney);
                        decimal RebateMoney = rebateList.Sum(c => c.RebateMoney);
                        NoP = NoP + Convert.ToDecimal(idr["Total"]) - IncomeMoney - RebateMoney;
                        result.Add(new APPClientAccountEntity
                        {
                            ClientID = Convert.ToInt64(idr["ClientID"]),
                            ClientNum = Convert.ToInt32(idr["ClientNum"]),
                            ClientName = Convert.ToString(idr["Boss"]),
                            AccountID = Convert.ToString(idr["AccountID"]),
                            CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                            AccountTitle = Convert.ToString(idr["AccountTitle"]),
                            AccountDate = DateTime.Now.Year + "年" + DateTime.Now.Month + "月",
                            Total = string.IsNullOrEmpty(Convert.ToString(idr["Total"])) ? 0 : Convert.ToDecimal(idr["Total"]),
                            TaxFee = string.IsNullOrEmpty(Convert.ToString(idr["TaxFee"])) ? 0 : Convert.ToDecimal(idr["TaxFee"]),
                            OtherFee = string.IsNullOrEmpty(Convert.ToString(idr["OtherFee"])) ? 0 : Convert.ToDecimal(idr["OtherFee"]),
                            Memo = Convert.ToString(idr["Memo"]),
                            CheckStatus = Convert.ToString(idr["CheckStatus"]),
                            ElecSign = Convert.ToString(idr["ElecSign"]),
                            IncomeMoney = IncomeMoney,
                            RebateMoney = RebateMoney,
                            NoPayMoney = NoP
                        });
                    }
                    if (!CurMonth)
                    {
                        //表示没有账单数据
                        List<APPClientIncomeMoneyEntity> Lastincomelist = QueryClientIncomeInfo(new APPClientIncomeMoneyEntity { ClientNum = entity.ClientNum, StartDate = DateTime.Now.AddDays(-DateTime.Now.Day), EndDate = DateTime.Now });
                        if (Lastincomelist.Count > 0)
                        {
                            decimal IncomeMoney = Lastincomelist.Sum(c => c.IncomeMoney);
                            result.Add(new APPClientAccountEntity
                            {
                                AccountTitle = "",
                                AccountDate = DateTime.Now.Year + "年" + DateTime.Now.Month + "月",
                                Total = 0,
                                CreateDate = DateTime.Now,
                                IncomeMoney = IncomeMoney,
                                RebateMoney = 0,
                                NoPayMoney = NoP - IncomeMoney
                            });
                        }
                    }
                }
            }
            result = result.OrderByDescending(c => c.CreateDate).ToList();
            return result;
        }
        #endregion
        #region 上游客户管理
        /// <summary>
        /// 上游客户数据查询
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <param name="strCountWhere">查询总数的查询条件</param>
        /// <returns></returns>
        public Hashtable QueryUpClientData(int pIndex, int pNum, CargoUpClientEntity entity)
        {
            List<CargoUpClientEntity> result = new List<CargoUpClientEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY uc.OP_DATE DESC) AS RowNumber,uc.*,h.Name as HouseName FROM tbl_Cargo_UpClient uc inner join Tbl_Cargo_House h on uc.HouseID=h.HouseID WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.UpClientName)) { strSQL += " and uc.UpClientName like '%" + entity.UpClientName + "%'"; }
                if (!string.IsNullOrEmpty(entity.UpClientShortName)) { strSQL += " and uc.UpClientShortName like '%" + entity.UpClientShortName + "%'"; }
                if (!entity.ClientType.Equals(-1)) { strSQL += " and uc.ClientType = " + entity.ClientType; }
                if (!string.IsNullOrEmpty(entity.Address)) { strSQL += " and uc.Address like '%" + entity.Address + "%'"; }
                if (!string.IsNullOrEmpty(entity.Telephone)) { strSQL += " and uc.Telephone like '%" + entity.Telephone + "%'"; }
                if (!string.IsNullOrEmpty(entity.Boss)) { strSQL += " and uc.Boss like '%" + entity.Boss + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strSQL += " and uc.Cellphone like '%" + entity.Cellphone + "%'"; }
                if (!entity.DelFlag.Equals(-1)) { strSQL += " and uc.DelFlag = " + entity.DelFlag; }
                if (!string.IsNullOrEmpty(entity.Remark)) { strSQL += " and uc.Remark like '%" + entity.Remark + "%'"; }
                if (!string.IsNullOrEmpty(entity.Province)) { strSQL += " and uc.Province like '%" + entity.Province + "%'"; }
                if (!string.IsNullOrEmpty(entity.City)) { strSQL += " and uc.City like '%" + entity.City + "%'"; }
                if (!string.IsNullOrEmpty(entity.Country)) { strSQL += " and uc.Country like '%" + entity.Country + "%'"; }
                if (!string.IsNullOrEmpty(entity.HouseID)) { strSQL += " and uc.HouseID = " + entity.HouseID; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoUpClientEntity
                            {
                                UpClientID = Convert.ToInt64(idr["UpClientID"]),
                                UpClientName = Convert.ToString(idr["UpClientName"]),
                                UpClientShortName = Convert.ToString(idr["UpClientShortName"]),
                                ClientType = Convert.ToInt32(idr["ClientType"]),
                                Address = Convert.ToString(idr["Address"]),
                                ZipCode = Convert.ToString(idr["ZipCode"]),
                                Telephone = Convert.ToString(idr["Telephone"]),
                                Boss = Convert.ToString(idr["Boss"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                DelFlag = Convert.ToInt32(idr["DelFlag"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                Province = Convert.ToString(idr["Province"]),
                                Country = Convert.ToString(idr["Country"]),
                                City = Convert.ToString(idr["City"]),
                                HouseID = Convert.ToString(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"select count(*) as TotalCount from tbl_Cargo_UpClient uc inner join tbl_Cargo_UpClientDep ucd on uc.UpClientID=ucd.UpClientID Where(1 = 1)";
                if (!string.IsNullOrEmpty(entity.UpClientName)) { strCount += " and uc.UpClientName like '%" + entity.UpClientName + "%'"; }
                if (!string.IsNullOrEmpty(entity.UpClientShortName)) { strCount += " and uc.UpClientShortName like '%" + entity.UpClientShortName + "%'"; }
                if (!entity.ClientType.Equals(-1)) { strCount += " and uc.ClientType = " + entity.ClientType; }
                if (!string.IsNullOrEmpty(entity.Address)) { strCount += " and uc.Address like '%" + entity.Address + "%'"; }
                if (!string.IsNullOrEmpty(entity.Telephone)) { strCount += " and uc.Telephone like '%" + entity.Telephone + "%'"; }
                if (!string.IsNullOrEmpty(entity.Boss)) { strCount += " and uc.Boss like '%" + entity.Boss + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strCount += " and uc.Cellphone like '%" + entity.Cellphone + "%'"; }
                if (!entity.DelFlag.Equals(-1)) { strCount += " and uc.DelFlag = " + entity.DelFlag; }
                if (!string.IsNullOrEmpty(entity.Remark)) { strCount += " and uc.Remark like '%" + entity.Remark + "%'"; }
                if (!string.IsNullOrEmpty(entity.Province)) { strCount += " and uc.Province like '%" + entity.Province + "%'"; }
                if (!string.IsNullOrEmpty(entity.City)) { strCount += " and uc.City like '%" + entity.City + "%'"; }
                if (!string.IsNullOrEmpty(entity.Country)) { strCount += " and uc.Country like '%" + entity.Country + "%'"; }
                if (!string.IsNullOrEmpty(entity.HouseID)) { strCount += " and uc.HouseID = " + entity.HouseID; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        public List<CargoUpClientEntity> QueryUpClientData(string UpClientID)
        {
            List<CargoUpClientEntity> result = new List<CargoUpClientEntity>();
            string strSQL = " select ROW_NUMBER() OVER (ORDER BY uc.OP_DATE DESC) AS RowNumber,uc.*,h.Name as HouseName FROM tbl_Cargo_UpClient uc inner join Tbl_Cargo_House h on uc.HouseID=h.HouseID WHERE (1=1) and  uc.DelFlag = 0 ";
            if (!string.IsNullOrEmpty(UpClientID))
            {
                strSQL += " and UpClientID='" + UpClientID + "'";
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoUpClientEntity
                        {
                            UpClientID = Convert.ToInt64(idr["UpClientID"]),
                            UpClientName = Convert.ToString(idr["UpClientName"]),
                            UpClientShortName = Convert.ToString(idr["UpClientShortName"]),
                            ClientType = Convert.ToInt32(idr["ClientType"]),
                            Address = Convert.ToString(idr["Address"]),
                            ZipCode = Convert.ToString(idr["ZipCode"]),
                            Telephone = Convert.ToString(idr["Telephone"]),
                            Boss = Convert.ToString(idr["Boss"]),
                            Cellphone = Convert.ToString(idr["Cellphone"]),
                            DelFlag = Convert.ToInt32(idr["DelFlag"]),
                            Remark = Convert.ToString(idr["Remark"]),
                            Province = Convert.ToString(idr["Province"]),
                            Country = Convert.ToString(idr["Country"]),
                            City = Convert.ToString(idr["City"]),
                            HouseID = Convert.ToString(idr["HouseID"]),
                            HouseName = Convert.ToString(idr["HouseName"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 删除客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void DelUpClientData(List<CargoUpClientEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"UPDATE tbl_Cargo_UpClient SET DelFlag='1' WHERE UpClientID=@UpClientID";
                    if (it.DelFlag.Equals(1))//彻底删除
                    {
                        strSQL = @"Delete from tbl_Cargo_UpClient where UpClientID=@UpClientID ";
                    }
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@UpClientID", DbType.Int64, it.UpClientID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 判断是否存在相同的客户名称
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistUpClient(CargoUpClientEntity entity)
        {
            string strQ = @"Select UpClientShortName from tbl_Cargo_UpClient Where HouseID=@HouseID and ( 1>1";
            if (!string.IsNullOrEmpty(entity.UpClientShortName))
            {
                strQ += " or UpClientShortName=@UpClientShortName ";
            }
            if (!string.IsNullOrEmpty(entity.UpClientName))
            {
                strQ += " or UpClientName=@UpClientName ";
            }
            strQ += " )";
            if (entity.UpClientID != 0)
            {
                strQ += " and UpClientID!=@UpClientID";
            }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                if (!string.IsNullOrEmpty(entity.UpClientShortName))
                {
                    conn.AddInParameter(cmdQ, "@UpClientShortName", DbType.String, entity.UpClientShortName);
                }
                if (!string.IsNullOrEmpty(entity.UpClientName))
                {
                    conn.AddInParameter(cmdQ, "@UpClientName", DbType.String, entity.UpClientName);
                }
                if (entity.UpClientID != 0)
                {
                    conn.AddInParameter(cmdQ, "@UpClientID", DbType.Int64, entity.UpClientID);
                }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 新增客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddUpClient(CargoUpClientEntity entity)
        {
            long did = 0;

            string strSQL = @"INSERT INTO tbl_Cargo_UpClient(UpClientName,UpClientShortName,ClientType,Address,ZipCode,Telephone,Boss,Cellphone,DelFlag,Remark,OP_DATE,Province,City,Country,HouseID) VALUES (@UpClientName,@UpClientShortName,@ClientType,@Address,@ZipCode,@Telephone,@Boss,@Cellphone,@DelFlag,@Remark,@OP_DATE,@Province,@City,@Country,@HouseID)  SELECT @@IDENTITY";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@UpClientName", DbType.String, entity.UpClientName);
                    conn.AddInParameter(cmd, "@UpClientShortName", DbType.String, entity.UpClientShortName);
                    conn.AddInParameter(cmd, "@ClientType", DbType.String, entity.ClientType);
                    conn.AddInParameter(cmd, "@Address", DbType.String, entity.Address);
                    conn.AddInParameter(cmd, "@ZipCode", DbType.String, entity.ZipCode);
                    conn.AddInParameter(cmd, "@Telephone", DbType.String, entity.Telephone);
                    conn.AddInParameter(cmd, "@Boss", DbType.String, entity.Boss);
                    conn.AddInParameter(cmd, "@Cellphone", DbType.String, entity.Cellphone);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@Province", DbType.String, entity.Province);
                    conn.AddInParameter(cmd, "@City", DbType.String, entity.City);
                    conn.AddInParameter(cmd, "@Country", DbType.String, entity.Country);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    //conn.ExecuteNonQuery(cmd);
                    did = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }
        /// <summary>
        /// 修改客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateUpClient(CargoUpClientEntity entity)
        {
            string strSQL = @"UPDATE tbl_Cargo_UpClient SET UpClientName = @UpClientName,UpClientShortName = @UpClientShortName,ClientType = @ClientType,Address = @Address,ZipCode = @ZipCode,Telephone = @Telephone,Boss = @Boss,Cellphone = @Cellphone,DelFlag = @DelFlag,Remark = @Remark,OP_DATE = @OP_DATE,Province=@Province,City=@City,Country=@Country,HouseID=@HouseID WHERE UpClientID=@UpClientID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@UpClientName", DbType.String, entity.UpClientName);
                    conn.AddInParameter(cmd, "@UpClientShortName", DbType.String, entity.UpClientShortName);
                    conn.AddInParameter(cmd, "@ClientType", DbType.String, entity.ClientType);
                    conn.AddInParameter(cmd, "@Address", DbType.String, entity.Address);
                    conn.AddInParameter(cmd, "@ZipCode", DbType.String, entity.ZipCode);
                    conn.AddInParameter(cmd, "@Telephone", DbType.String, entity.Telephone);
                    conn.AddInParameter(cmd, "@Boss", DbType.String, entity.Boss);
                    conn.AddInParameter(cmd, "@Cellphone", DbType.String, entity.Cellphone);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@Province", DbType.String, entity.Province);
                    conn.AddInParameter(cmd, "@City", DbType.String, entity.City);
                    conn.AddInParameter(cmd, "@Country", DbType.String, entity.Country);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@UpClientID", DbType.Int32, entity.UpClientID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 上游客户数据查询
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <param name="strCountWhere">查询总数的查询条件</param>
        /// <returns></returns>
        public Hashtable QueryUpClientDepData(int pIndex, int pNum, CargoUpClientEntity entity)
        {
            List<CargoUpClientEntity> result = new List<CargoUpClientEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY OP_DATE DESC) AS RowNumber,* FROM  tbl_Cargo_UpClientDep WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.DepName)) { strSQL += " and DepName like '%" + entity.DepName + "%'"; }
                if (!entity.UpClientID.Equals(-1)) { strSQL += " and UpClientID = " + entity.UpClientID; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoUpClientEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                UpClientID = Convert.ToInt64(idr["UpClientID"]),
                                DepName = Convert.ToString(idr["DepName"]),
                                SmallStockCheckFee = string.IsNullOrEmpty(idr["SmallStockCheckFee"].ToString()) ? 0 : Convert.ToDouble(idr["SmallStockCheckFee"]),
                                BigStockCheckFee = string.IsNullOrEmpty(idr["BigStockCheckFee"].ToString()) ? 0 : Convert.ToDouble(idr["BigStockCheckFee"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_Name = Convert.ToString(idr["OP_Name"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"select count(*) as TotalCount from tbl_Cargo_UpClientDep Where(1 = 1)";
                if (!string.IsNullOrEmpty(entity.UpClientName)) { strCount += " and DepName like '%" + entity.DepName + "%'"; }
                if (!entity.UpClientID.Equals(-1)) { strCount += " and UpClientID = " + entity.UpClientID; }
                if (!string.IsNullOrEmpty(entity.HouseID)) { strCount += " and HouseID = " + entity.HouseID; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 删除客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void DelUpClientDep(List<CargoUpClientEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from tbl_Cargo_UpClientDep where ID=@ID ";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ID", DbType.Int64, it.ID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 判断是否存在相同的客户名称
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistUpClientDep(CargoUpClientEntity entity)
        {
            string strQ = @"Select * from tbl_Cargo_UpClientDep Where UpClientID=@UpClientID ";
            if (!string.IsNullOrEmpty(entity.DepName))
            {
                strQ += " and DepName=@DepName ";
            }
            if (entity.ID != -1)
            {
                strQ += " and ID!=@ID";
            }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@UpClientID", DbType.Int32, entity.UpClientID);
                if (!string.IsNullOrEmpty(entity.DepName))
                {
                    conn.AddInParameter(cmdQ, "@DepName", DbType.String, entity.DepName);
                }
                if (entity.ID != -1)
                {
                    conn.AddInParameter(cmdQ, "@ID", DbType.Int32, entity.ID);
                }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 新增客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddUpClientDep(CargoUpClientEntity entity)
        {
            long did = 0;

            string strSQL = @"INSERT INTO tbl_Cargo_UpClientDep(UpClientID,DepName,SmallStockCheckFee,BigStockCheckFee,OP_ID,OP_Name,OP_DATE) VALUES (@UpClientID,@DepName,@SmallStockCheckFee,@BigStockCheckFee,@OP_ID,@OP_Name,@OP_DATE)  SELECT @@IDENTITY";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@UpClientID", DbType.Int64, entity.UpClientID);
                    conn.AddInParameter(cmd, "@DepName", DbType.String, entity.DepName);
                    conn.AddInParameter(cmd, "@SmallStockCheckFee", DbType.Double, entity.SmallStockCheckFee);
                    conn.AddInParameter(cmd, "@BigStockCheckFee", DbType.Double, entity.BigStockCheckFee);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.AddInParameter(cmd, "@OP_Name", DbType.String, entity.OP_Name);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    //conn.ExecuteNonQuery(cmd);
                    did = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }
        /// <summary>
        /// 修改客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateUpClientDep(CargoUpClientEntity entity)
        {
            string strSQL = @"UPDATE tbl_Cargo_UpClientDep SET UpClientID = @UpClientID,DepName = @DepName,SmallStockCheckFee = @SmallStockCheckFee,BigStockCheckFee = @BigStockCheckFee,OP_ID = @OP_ID,OP_Name = @OP_Name,OP_DATE = @OP_DATE WHERE ID=@ID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ID", DbType.Int32, entity.ID);
                    conn.AddInParameter(cmd, "@UpClientID", DbType.Int64, entity.UpClientID);
                    conn.AddInParameter(cmd, "@DepName", DbType.String, entity.DepName);
                    conn.AddInParameter(cmd, "@SmallStockCheckFee", DbType.Double, entity.SmallStockCheckFee);
                    conn.AddInParameter(cmd, "@BigStockCheckFee", DbType.Double, entity.BigStockCheckFee);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.AddInParameter(cmd, "@OP_Name", DbType.String, entity.OP_Name);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 获取所有客户部门
        /// </summary>
        /// <returns></returns>
        public List<CargoUpClientEntity> QueryAllUpClientDep(CargoUpClientEntity entity)
        {
            List<CargoUpClientEntity> result = new List<CargoUpClientEntity>();
            string strSQL = "select ID,DepName from tbl_Cargo_UpClient uc inner join tbl_Cargo_UpClientDep ucd on ucd.UpClientID=uc.UpClientID where 1=1";
            if (!string.IsNullOrEmpty(entity.HouseIDs))
            {
                strSQL += " and uc.HouseID in (" + entity.HouseIDs + ")";
            }
            if (!string.IsNullOrEmpty(entity.HouseID))
            {
                strSQL += " and uc.HouseID =" + entity.HouseID;
            }
            if (!String.IsNullOrEmpty(entity.DepName))
            {
                strSQL += " and ucd.DepName='" + entity.DepName + "'";
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoUpClientEntity
                        {
                            ID = Convert.ToInt32(idr["ID"]),
                            DepName = Convert.ToString(idr["DepName"]).Trim()
                        });
                    }
                }
            }
            return result;
        }
        #endregion
        #region 采购商管理
        public Hashtable QueryDeliveryAddress(int pIndex, int pNum, CargoPurchaserDeliveryAddressEntity entity)
        {
            List<CargoPurchaserDeliveryAddressEntity> result = new List<CargoPurchaserDeliveryAddressEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.*,b.PurchaserName FROM Tbl_Cargo_PurchaserDeliveryAddress as a left join Tbl_Cargo_Purchaser as b on a.PurchaserID=b.PurchaserID WHERE (1=1)";
                if (!entity.PurchaserID.Equals(0)) { strSQL += " and b.PurchaserID = " + entity.PurchaserID; }
                if (!string.IsNullOrEmpty(entity.DeliveryName)) { strSQL += " and a.DeliveryName like '%" + entity.DeliveryName + "%'"; }
                if (!string.IsNullOrEmpty(entity.DeliveryBoss)) { strSQL += " and a.DeliveryBoss like '%" + entity.DeliveryBoss + "%'"; }
                if (!string.IsNullOrEmpty(entity.DeliveryCellphone)) { strSQL += " and a.DeliveryCellphone like '%" + entity.DeliveryCellphone + "%'"; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoPurchaserDeliveryAddressEntity
                            {
                                DAID = Convert.ToInt64(idr["DAID"]),
                                PurchaserID = Convert.ToInt64(idr["PurchaserID"]),
                                PurchaserName = Convert.ToString(idr["PurchaserName"]),
                                DeliveryName = Convert.ToString(idr["DeliveryName"]),
                                DeliveryAddress = Convert.ToString(idr["DeliveryAddress"]),
                                DeliveryTelephone = Convert.ToString(idr["DeliveryTelephone"]),
                                DeliveryBoss = Convert.ToString(idr["DeliveryBoss"]),
                                DeliveryCellphone = Convert.ToString(idr["DeliveryCellphone"]),
                                DeliveryRemark = Convert.ToString(idr["DeliveryRemark"]),
                                DeliveryProvince = Convert.ToString(idr["DeliveryProvince"]),
                                DeliveryCountry = Convert.ToString(idr["DeliveryCountry"]),
                                DeliveryCity = Convert.ToString(idr["DeliveryCity"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                Longitude = Convert.ToString(idr["Longitude"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_PurchaserDeliveryAddress as a left join Tbl_Cargo_Purchaser as b on a.PurchaserID=b.PurchaserID Where (1=1)";
                if (!entity.PurchaserID.Equals(0)) { strCount += " and b.PurchaserID = " + entity.PurchaserID; }
                if (!string.IsNullOrEmpty(entity.DeliveryName)) { strCount += " and a.DeliveryName like '%" + entity.DeliveryName + "%'"; }
                if (!string.IsNullOrEmpty(entity.DeliveryBoss)) { strCount += " and a.DeliveryBoss like '%" + entity.DeliveryBoss + "%'"; }
                if (!string.IsNullOrEmpty(entity.DeliveryCellphone)) { strCount += " and a.DeliveryCellphone like '%" + entity.DeliveryCellphone + "%'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        public void AddDeliveryAddress(CargoPurchaserDeliveryAddressEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_PurchaserDeliveryAddress(PurchaserID,DeliveryName,DeliveryAddress,DeliveryTelephone,DeliveryBoss,DeliveryCellphone,DeliveryRemark,DeliveryCity,DeliveryCountry,DeliveryProvince,OP_DATE,Longitude,Latitude) VALUES (@PurchaserID,@DeliveryName,@DeliveryAddress,@DeliveryTelephone,@DeliveryBoss,@DeliveryCellphone,@DeliveryRemark,@DeliveryCity,@DeliveryCountry,@DeliveryProvince,@OP_DATE,@Longitude,@Latitude)";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@PurchaserID", DbType.Int64, entity.PurchaserID);
                    conn.AddInParameter(cmd, "@DeliveryName", DbType.String, entity.DeliveryName);
                    conn.AddInParameter(cmd, "@DeliveryAddress", DbType.String, entity.DeliveryAddress);
                    conn.AddInParameter(cmd, "@DeliveryTelephone", DbType.String, entity.DeliveryTelephone);
                    conn.AddInParameter(cmd, "@DeliveryBoss", DbType.String, entity.DeliveryBoss);
                    conn.AddInParameter(cmd, "@DeliveryCellphone", DbType.String, entity.DeliveryCellphone);
                    conn.AddInParameter(cmd, "@DeliveryRemark", DbType.String, entity.DeliveryRemark);
                    conn.AddInParameter(cmd, "@DeliveryCity", DbType.String, entity.DeliveryCity);
                    conn.AddInParameter(cmd, "@DeliveryCountry", DbType.String, entity.DeliveryCountry);
                    conn.AddInParameter(cmd, "@DeliveryProvince", DbType.String, entity.DeliveryProvince);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@Longitude", DbType.String, entity.Longitude);
                    conn.AddInParameter(cmd, "@Latitude", DbType.String, entity.Latitude);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void UpdateDeliveryAddress(CargoPurchaserDeliveryAddressEntity entity)
        {
            try
            {
                entity.EnSafe();
                string strSQL = @"UPDATE Tbl_Cargo_PurchaserDeliveryAddress SET DeliveryName=@DeliveryName,DeliveryAddress=@DeliveryAddress,DeliveryTelephone=@DeliveryTelephone,DeliveryBoss=@DeliveryBoss,DeliveryCellphone=@DeliveryCellphone,DeliveryRemark=@DeliveryRemark,DeliveryCity=@DeliveryCity,DeliveryCountry=@DeliveryCountry,DeliveryProvince=@DeliveryProvince,Longitude=@Longitude,Latitude=@Latitude,OP_DATE=@OP_DATE WHERE PurchaserID=@PurchaserID and DAID=@DAID";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@DAID", DbType.Int64, entity.DAID);
                    conn.AddInParameter(cmd, "@PurchaserID", DbType.Int32, entity.PurchaserID);
                    conn.AddInParameter(cmd, "@DeliveryName", DbType.String, entity.DeliveryName);
                    conn.AddInParameter(cmd, "@DeliveryAddress", DbType.String, entity.DeliveryAddress);
                    conn.AddInParameter(cmd, "@DeliveryTelephone", DbType.String, entity.DeliveryTelephone);
                    conn.AddInParameter(cmd, "@DeliveryBoss", DbType.String, entity.DeliveryBoss);
                    conn.AddInParameter(cmd, "@DeliveryCellphone", DbType.String, entity.DeliveryCellphone);
                    conn.AddInParameter(cmd, "@DeliveryRemark", DbType.String, entity.DeliveryRemark);
                    conn.AddInParameter(cmd, "@DeliveryCity", DbType.String, entity.DeliveryCity);
                    conn.AddInParameter(cmd, "@DeliveryCountry", DbType.String, entity.DeliveryCountry);
                    conn.AddInParameter(cmd, "@DeliveryProvince", DbType.String, entity.DeliveryProvince);
                    conn.AddInParameter(cmd, "@Longitude", DbType.String, entity.Longitude);
                    conn.AddInParameter(cmd, "@Latitude", DbType.String, entity.Latitude);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void DelDeliveryAddress(List<CargoPurchaserDeliveryAddressEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_PurchaserDeliveryAddress where DAID=@DAID ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@DAID", DbType.Int64, it.DAID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 获取采购商信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public List<CargoPurchaserEntity> AutoCompletePurchaser(CargoPurchaserEntity entity)
        {
            List<CargoPurchaserEntity> result = new List<CargoPurchaserEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @" SELECT * FROM Tbl_Cargo_Purchaser c where c.DelFlag=@DelFlag ";
                if (entity.PurchaserID != 0)
                {
                    strSQL += " and c.PurchaserID = " + entity.PurchaserID;
                }
                if (entity.HouseID != 0)
                {
                    strSQL += " and c.HouseID = " + entity.HouseID;
                }
                if (!string.IsNullOrEmpty(entity.HouseIDStr))
                {
                    strSQL += " and c.HouseID in (" + entity.HouseIDStr + ")";
                }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@DelFlag", DbType.String, entity.DelFlag);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoPurchaserEntity
                            {
                                PurchaserID = Convert.ToInt64(idr["PurchaserID"]),
                                PurchaserName = Convert.ToString(idr["PurchaserName"]),
                                PurchaserShortName = Convert.ToString(idr["PurchaserShortName"]),
                                PurchaserType = Convert.ToInt32(idr["PurchaserType"]),
                                Address = Convert.ToString(idr["Address"]),
                                Telephone = Convert.ToString(idr["Telephone"]),
                                Boss = Convert.ToString(idr["Boss"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                DelFlag = Convert.ToInt32(idr["DelFlag"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                City = Convert.ToString(idr["City"]),
                                Province = Convert.ToString(idr["Province"]),
                                Country = Convert.ToString(idr["Country"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                Longitude = Convert.ToString(idr["Longitude"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public List<CargoPurchaserDeliveryAddressEntity> QueryDeliveryAddressByPurchaserID(CargoPurchaserDeliveryAddressEntity entity) 
        {
            List<CargoPurchaserDeliveryAddressEntity> result = new List<CargoPurchaserDeliveryAddressEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @" SELECT * FROM Tbl_Cargo_PurchaserDeliveryAddress c where (1=1) ";
                if (entity.PurchaserID != 0)
                {
                    strSQL += " and c.PurchaserID = " + entity.PurchaserID;
                }

                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoPurchaserDeliveryAddressEntity
                            {
                                DAID = Convert.ToInt64(idr["DAID"]),
                                PurchaserID = Convert.ToInt64(idr["PurchaserID"]),
                                DeliveryName = Convert.ToString(idr["DeliveryName"]),
                                DeliveryAddress = Convert.ToString(idr["DeliveryAddress"]),
                                DeliveryTelephone = Convert.ToString(idr["DeliveryTelephone"]),
                                DeliveryBoss = Convert.ToString(idr["DeliveryBoss"]),
                                DeliveryCellphone = Convert.ToString(idr["DeliveryCellphone"]),
                                DeliveryRemark = Convert.ToString(idr["DeliveryRemark"]),
                                DeliveryProvince = Convert.ToString(idr["DeliveryProvince"]),
                                DeliveryCountry = Convert.ToString(idr["DeliveryCountry"]),
                                DeliveryCity = Convert.ToString(idr["DeliveryCity"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                Longitude = Convert.ToString(idr["Longitude"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        /// <summary>
        /// 客户数据查询
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <param name="strCountWhere">查询总数的查询条件</param>
        /// <returns></returns>
        public Hashtable QueryCargoPurchaser(int pIndex, int pNum, CargoPurchaserEntity entity)
        {
            List<CargoPurchaserEntity> result = new List<CargoPurchaserEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.*,b.Name as HouseName FROM Tbl_Cargo_Purchaser as a left join Tbl_Cargo_House as b on a.HouseID=b.HouseID  WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.PurchaserName)) { strSQL += " and a.PurchaserName like '%" + entity.PurchaserName + "%'"; }
                if (!string.IsNullOrEmpty(entity.PurchaserShortName)) { strSQL += " and a.PurchaserShortName like '%" + entity.PurchaserShortName + "%'"; }
                if (!entity.PurchaserType.Equals(-1)) { strSQL += " and a.PurchaserType = " + entity.PurchaserType; }
                if (!string.IsNullOrEmpty(entity.Address)) { strSQL += " and a.Address like '%" + entity.Address + "%'"; }
                if (!string.IsNullOrEmpty(entity.Boss)) { strSQL += " and a.Boss like '%" + entity.Boss + "%'"; }
                if (!string.IsNullOrEmpty(entity.Telephone)) { strSQL += " and a.Telephone like '%" + entity.Telephone + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strSQL += " and a.Cellphone like '%" + entity.Cellphone + "%'"; }
                if (!entity.DelFlag.Equals(-1)) { strSQL += " and a.DelFlag = " + entity.DelFlag; }
                if (!string.IsNullOrEmpty(entity.Remark)) { strSQL += " and a.Remark like '%" + entity.Remark + "%'"; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoPurchaserEntity
                            {
                                PurchaserID = Convert.ToInt64(idr["PurchaserID"]),
                                PurchaserName = Convert.ToString(idr["PurchaserName"]),
                                PurchaserShortName = Convert.ToString(idr["PurchaserShortName"]),
                                PurchaserType = Convert.ToInt32(idr["PurchaserType"]),
                                Address = Convert.ToString(idr["Address"]),
                                Telephone = Convert.ToString(idr["Telephone"]),
                                Boss = Convert.ToString(idr["Boss"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                DelFlag = Convert.ToInt32(idr["DelFlag"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                City = Convert.ToString(idr["City"]),
                                Country = Convert.ToString(idr["Country"]),
                                Province = Convert.ToString(idr["Province"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                Longitude = Convert.ToString(idr["Longitude"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                AddData = Convert.ToString(idr["AddData"]),
                                SocialCreditCode = Convert.ToString(idr["SocialCreditCode"]),
                                LegalPerson = Convert.ToString(idr["LegalPerson"]),
                                SupplierEvaluation = Convert.ToString(idr["SupplierEvaluation"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"select count(*) as TotalCount from ( Select a.PurchaserID  from Tbl_Cargo_Purchaser as a left join Tbl_Cargo_House as b on a .HouseID = b.HouseID Where(1 = 1)";
                if (!string.IsNullOrEmpty(entity.PurchaserName)) { strCount += " and a.PurchaserName like '%" + entity.PurchaserName + "%'"; }
                if (!entity.PurchaserType.Equals(-1)) { strCount += " and a.PurchaserType = " + entity.PurchaserType; }
                if (!string.IsNullOrEmpty(entity.Address)) { strCount += " and a.Address like '%" + entity.Address + "%'"; }
                if (!string.IsNullOrEmpty(entity.Boss)) { strCount += " and a.Boss like '%" + entity.Boss + "%'"; }
                if (!string.IsNullOrEmpty(entity.Telephone)) { strCount += " and a.Telephone like '%" + entity.Telephone + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strCount += " and a.Cellphone like '%" + entity.Cellphone + "%'"; }
                if (!entity.DelFlag.Equals(-1)) { strCount += " and a.DelFlag = " + entity.DelFlag; }
                if (!string.IsNullOrEmpty(entity.Remark)) { strCount += " and a.Remark like '%" + entity.Remark + "%'"; }
                strCount += ")A";
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 判断是否存在相同的采购商名称
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistCargoPurchaser(CargoPurchaserEntity entity)
        {
            string strQ = @"Select PurchaserName from Tbl_Cargo_Purchaser Where HouseID=@HouseID and ( Boss=@Boss";
            if (!string.IsNullOrEmpty(entity.PurchaserName))
            {
                strQ += " or PurchaserName=@PurchaserName ";
            }
            if (!string.IsNullOrEmpty(entity.PurchaserShortName))
            {
                strQ += " or PurchaserShortName=@PurchaserShortName ";
            }
            strQ += " )";
            if (entity.PurchaserID != 0)
            {
                strQ += " and PurchaserID!=@PurchaserID";
            }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                if (!string.IsNullOrEmpty(entity.PurchaserName))
                {
                    conn.AddInParameter(cmdQ, "@PurchaserName", DbType.String, entity.PurchaserName);
                }
                if (!string.IsNullOrEmpty(entity.PurchaserShortName))
                {
                    conn.AddInParameter(cmdQ, "@PurchaserShortName", DbType.String, entity.PurchaserShortName);
                }
                conn.AddInParameter(cmdQ, "@Boss", DbType.String, entity.Boss);
                if (entity.PurchaserID != 0)
                {
                    conn.AddInParameter(cmdQ, "@PurchaserID", DbType.String, entity.PurchaserID);
                }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 新增客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoPurchaser(CargoPurchaserEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_Purchaser(PurchaserName,PurchaserShortName,PurchaserType,Address,Telephone,Boss,Cellphone,OP_DATE,Remark,DelFlag,City,Province,Country,HouseID,Longitude,Latitude,AddData,SocialCreditCode,LegalPerson,SupplierEvaluation) VALUES (@PurchaserName,@PurchaserShortName,@PurchaserType,@Address,@Telephone,@Boss,@Cellphone,@OP_DATE,@Remark,@DelFlag,@City,@Province,@Country,@HouseID,@Longitude,@Latitude,@AddData,@SocialCreditCode,@LegalPerson,@SupplierEvaluation)  SELECT @@IDENTITY";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@PurchaserName", DbType.String, entity.PurchaserName);
                    conn.AddInParameter(cmd, "@PurchaserShortName", DbType.String, entity.PurchaserShortName);
                    conn.AddInParameter(cmd, "@PurchaserType", DbType.Int32, entity.PurchaserType);
                    conn.AddInParameter(cmd, "@Address", DbType.String, entity.Address);
                    conn.AddInParameter(cmd, "@Telephone", DbType.String, entity.Telephone);
                    conn.AddInParameter(cmd, "@Boss", DbType.String, entity.Boss);
                    conn.AddInParameter(cmd, "@Cellphone", DbType.String, entity.Cellphone);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@City", DbType.String, entity.City);
                    conn.AddInParameter(cmd, "@Province", DbType.String, entity.Province);
                    conn.AddInParameter(cmd, "@Country", DbType.String, entity.Country);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@Longitude", DbType.String, entity.Longitude);
                    conn.AddInParameter(cmd, "@Latitude", DbType.String, entity.Latitude);
                    conn.AddInParameter(cmd, "@AddData", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@SocialCreditCode", DbType.String, entity.SocialCreditCode);
                    conn.AddInParameter(cmd, "@LegalPerson", DbType.String, entity.LegalPerson);
                    conn.AddInParameter(cmd, "@SupplierEvaluation", DbType.String, entity.SupplierEvaluation);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoPurchaser(CargoPurchaserEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Purchaser SET PurchaserName = @PurchaserName,PurchaserShortName=@PurchaserShortName,PurchaserType = @PurchaserType,Address = @Address,Telephone = @Telephone,Boss = @Boss,Cellphone = @Cellphone,DelFlag = @DelFlag,OP_DATE = @OP_DATE,Remark = @Remark,City=@City,Province=@Province,HouseID=@HouseID,Longitude=@Longitude,Latitude=@Latitude
            ,SocialCreditCode=@SocialCreditCode,LegalPerson=@LegalPerson,SupplierEvaluation=@SupplierEvaluation WHERE PurchaserID=@PurchaserID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@PurchaserName", DbType.String, entity.PurchaserName);
                    conn.AddInParameter(cmd, "@PurchaserShortName", DbType.String, entity.PurchaserShortName);
                    conn.AddInParameter(cmd, "@PurchaserType", DbType.Int32, entity.PurchaserType);
                    conn.AddInParameter(cmd, "@Address", DbType.String, entity.Address);
                    conn.AddInParameter(cmd, "@Telephone", DbType.String, entity.Telephone);
                    conn.AddInParameter(cmd, "@Boss", DbType.String, entity.Boss);
                    conn.AddInParameter(cmd, "@Cellphone", DbType.String, entity.Cellphone);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@City", DbType.String, entity.City);
                    conn.AddInParameter(cmd, "@Province", DbType.String, entity.Province);
                    conn.AddInParameter(cmd, "@Country", DbType.String, entity.Country);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@Longitude", DbType.String, entity.Longitude);
                    conn.AddInParameter(cmd, "@Latitude", DbType.String, entity.Latitude);
                    conn.AddInParameter(cmd, "@PurchaserID", DbType.String, entity.PurchaserID);
                    conn.AddInParameter(cmd, "@SocialCreditCode", DbType.String, entity.SocialCreditCode);
                    conn.AddInParameter(cmd, "@LegalPerson", DbType.String, entity.LegalPerson);
                    conn.AddInParameter(cmd, "@SupplierEvaluation", DbType.String, entity.SupplierEvaluation);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoPurchaser(List<CargoPurchaserEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"UPDATE Tbl_Cargo_Purchaser SET DelFlag='1' WHERE PurchaserID=@PurchaserID";
                    if (it.DelFlag.Equals("1"))//彻底删除
                    {
                        strSQL = @"Delete from Tbl_Cargo_Purchaser where PurchaserID=@PurchaserID ";
                    }
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@PurchaserID", DbType.Int64, it.PurchaserID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion
        #region 优惠券
        public List<WXCouponEntity> QueryWXClient(WXCouponEntity entity)
        {
            List<WXCouponEntity> result = new List<WXCouponEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @" select wc.ID,wc.CompanyName,wc.Name,wc.Cellphone,wc.ClientNum,wc.Address,cc.ClientName from Tbl_WX_Client wc inner join Tbl_Cargo_Client cc on wc.ClientNum=cc.ClientNum where cc.DelFlag=0 and CompanyName is not null ";
                if (entity.HouseID != 0) { strSQL += " and cc.HouseID = " + entity.HouseID; }
                if (!string.IsNullOrEmpty(entity.HouseIDStr)) { strSQL += " and cc.HouseID in (" + entity.HouseIDStr + ")"; }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new WXCouponEntity
                            {
                                WXID = Convert.ToInt64(idr["ID"]),
                                CompanyName = Convert.ToString(idr["CompanyName"]) + " " + Convert.ToString(idr["Name"]) + " " + Convert.ToString(idr["Cellphone"]),
                                Name = Convert.ToString(idr["Name"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                Address = Convert.ToString(idr["Address"]),
                                PinyinName = GetSpellCode(Convert.ToString(idr["CompanyName"])).ToLower()
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public Hashtable QueryCouponList(int pIndex, int pNum, WXCouponEntity entity)
        {
            List<WXCouponEntity> result = new List<WXCouponEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY wco.GainDate DESC) AS RowNumber, h.Name as HouseName,wc.ID as WXClientID,wc.CompanyName,wc.Name,wc.Cellphone,wc.ClientNum,wc.Address,cc.ClientName,o.OrderNo,wco.* from Tbl_WX_Coupon wco inner join Tbl_WX_Client wc on wco.WXID=wc.ID inner join Tbl_Cargo_Client cc on wc.ClientNum=cc.ClientNum left join Tbl_Cargo_Order o on wco.OrderID=o.OrderID inner join Tbl_Cargo_House h on cc.HouseID=h.HouseID where wc.CompanyName is not null ";
                if (!entity.HouseID.Equals(0))
                {
                    strSQL += " and cc.HouseID=" + entity.HouseID;
                }
                if (!entity.ClientNum.Equals(0))
                {
                    strSQL += " and wc.ClientNum=" + entity.ClientNum;
                }
                if (!string.IsNullOrEmpty(entity.ClientName))
                {
                    strSQL += " and cc.ClientName like '%" + entity.ClientName + "%'";
                }
                if (!string.IsNullOrEmpty(entity.CompanyName))
                {
                    strSQL += " and wc.CompanyName like '%" + entity.CompanyName + "%'";
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new WXCouponEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                HouseName = Convert.ToString(idr["HouseName"]).Trim(),
                                ClientNum = (string.IsNullOrEmpty(Convert.ToString(idr["ClientNum"])) ? 0 : Convert.ToInt32(idr["ClientNum"])),
                                ClientName = Convert.ToString(idr["ClientName"]).Trim(),
                                CompanyName = Convert.ToString(idr["CompanyName"]).Trim(),
                                Money = Convert.ToDecimal(idr["Money"]),
                                UseStatus = Convert.ToString(idr["UseStatus"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                Name = Convert.ToString(idr["Name"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                Address = Convert.ToString(idr["Address"]),
                                GainDate = string.IsNullOrEmpty(Convert.ToString(idr["GainDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["GainDate"]),
                                UseDate = string.IsNullOrEmpty(Convert.ToString(idr["UseDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["UseDate"]),
                                StartDate = string.IsNullOrEmpty(Convert.ToString(idr["StartDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["StartDate"]),
                                EndDate = string.IsNullOrEmpty(Convert.ToString(idr["EndDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["EndDate"]),
                                IsFollowQuantity = Convert.ToString(idr["IsFollowQuantity"]),
                                IsSuperPosition = Convert.ToString(idr["IsSuperPosition"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }

                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_WX_Coupon wco inner join Tbl_WX_Client wc on wco.WXID=wc.ID inner join Tbl_Cargo_Client cc on wc.ClientNum=cc.ClientNum Where (1=1)";
                if (!entity.HouseID.Equals(0))
                {
                    strCount += " and cc.HouseID=" + entity.HouseID;
                }
                if (!entity.ClientNum.Equals(0))
                {
                    strCount += " and wc.ClientNum=" + entity.ClientNum;
                }
                if (!string.IsNullOrEmpty(entity.ClientName))
                {
                    strCount += " and cc.ClientName like '%" + entity.ClientName + "%'";
                }
                if (!string.IsNullOrEmpty(entity.CompanyName))
                {
                    strCount += " and wc.CompanyName like '%" + entity.CompanyName + "%'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        public void DelCoupon(List<WXCouponEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_WX_Coupon where ID=@ID ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ID", DbType.Int64, it.ID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void AddCoupon(WXCouponEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_WX_Coupon(WXID,Money,UseStatus,GainDate,OP_DATE,StartDate,EndDate,Remark,IsSuperPosition,TypeID,TypeName,SuppClientNum,CouponType,FromOrderNO,IsFollowQuantity) VALUES (@WXID,@Money,0,@GainDate,@OP_DATE,@StartDate,@EndDate,@Remark,@IsSuperPosition,@TypeID,@TypeName,@SuppClientNum,@CouponType,@FromOrderNO,@IsFollowQuantity)";
            try
            {
                entity.EnSafe();
                for (int i = 0; i < entity.Piece; i++)
                {
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@WXID", DbType.Int64, entity.WXID);
                        conn.AddInParameter(cmd, "@Money", DbType.Decimal, entity.Money);
                        conn.AddInParameter(cmd, "@GainDate", DbType.DateTime, DateTime.Now);
                        conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                        conn.AddInParameter(cmd, "@StartDate", DbType.DateTime, entity.StartDate);
                        conn.AddInParameter(cmd, "@EndDate", DbType.DateTime, entity.EndDate);
                        conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                        conn.AddInParameter(cmd, "@IsSuperPosition", DbType.String, entity.IsSuperPosition);
                        conn.AddInParameter(cmd, "@IsFollowQuantity", DbType.String, entity.IsFollowQuantity);
                        conn.AddInParameter(cmd, "@TypeID", DbType.String, entity.TypeID);
                        conn.AddInParameter(cmd, "@TypeName", DbType.String, entity.TypeName);
                        conn.AddInParameter(cmd, "@SuppClientNum", DbType.Int32, entity.SuppClientNum);
                        conn.AddInParameter(cmd, "@CouponType", DbType.String, entity.CouponType);
                        conn.AddInParameter(cmd, "@FromOrderNO", DbType.String, entity.FromOrderNO);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }
        public void UpdateCoupon(WXCouponEntity entity)
        {
            string strSQL = @"UPDATE Tbl_WX_Coupon SET Money = @Money,StartDate = @StartDate,EndDate = @EndDate,OP_DATE = @OP_DATE,Remark=@Remark WHERE ID=@ID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@Money", DbType.Decimal, entity.Money);
                    conn.AddInParameter(cmd, "@StartDate", DbType.DateTime, entity.StartDate);
                    conn.AddInParameter(cmd, "@EndDate", DbType.DateTime, entity.EndDate);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion
        #region 入驻仓库

        public List<CargoSettleHouseEntity> QuerySettleHouseList(CargoSettleHouseEntity entity)
        {
            List<CargoSettleHouseEntity> result = new List<CargoSettleHouseEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @" select * from Tbl_Cargo_SettleHouse sh where (1=1) ";
                if (!entity.ClientNum.Equals(0))
                {
                    strSQL += " and sh.ClientNum=" + entity.ClientNum;
                }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoSettleHouseEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                ClientID = string.IsNullOrEmpty(Convert.ToString(idr["ClientID"])) ? 0 : Convert.ToInt32(idr["ClientID"]),
                                ClientNum = string.IsNullOrEmpty(Convert.ToString(idr["ClientNum"])) ? 0 : Convert.ToInt32(idr["ClientNum"]),
                                ClientTypeID = Convert.ToString(idr["ClientTypeID"]),
                                ClientTypeName = Convert.ToString(idr["ClientTypeName"]),
                                SettleHouseID = Convert.ToString(idr["SettleHouseID"]),
                                SettleHouseName = Convert.ToString(idr["SettleHouseName"]),
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public List<CargoProductSpecEntity> QueryProductSpecList(CargoProductEntity entity)
        {
            List<CargoProductSpecEntity> result = new List<CargoProductSpecEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @" select SID,TypeID,ProductCode from Tbl_Cargo_ProductSpec where  ProductCode is not null and ProductCode !='' ";
                if (!string.IsNullOrEmpty(entity.TypeIDStr))
                {
                    strSQL += " and TypeID in(" + entity.TypeIDStr + ")";
                }
                if (!entity.UpClientID.Equals(0))
                {
                    strSQL += " and UpClientID =" + entity.UpClientID + "";
                }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoProductSpecEntity
                            {
                                SID = Convert.ToInt32(idr["SID"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                ProductCode = Convert.ToString(idr["ProductCode"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public CargoSettleHouseEntity QuerySettleHouseInfo(CargoSettleHouseEntity entity)
        {
            entity.EnSafe();
            CargoSettleHouseEntity result = new CargoSettleHouseEntity();
            try
            {
                string strSQL = @"select * from Tbl_Cargo_SettleHouse sh Where (1=1)";
                if (!entity.ID.Equals(0))
                {
                    strSQL += " and sh.ID=" + entity.ID;
                }
                if (!string.IsNullOrEmpty(entity.SettleHouseID))
                {
                    strSQL += " and sh.SettleHouseID='" + entity.SettleHouseID + "'";
                }
                if (!entity.ClientNum.Equals(0))
                {
                    strSQL += " and sh.ClientNum=" + entity.ClientNum;
                }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.ID = Convert.ToInt32(idr["ID"]);
                            result.ClientID = string.IsNullOrEmpty(Convert.ToString(idr["ClientID"])) ? 0 : Convert.ToInt32(idr["ClientID"]);
                            result.ClientNum = string.IsNullOrEmpty(Convert.ToString(idr["ClientNum"])) ? 0 : Convert.ToInt32(idr["ClientNum"]);
                            result.ClientTypeID = Convert.ToString(idr["ClientTypeID"]);
                            result.ClientTypeName = Convert.ToString(idr["ClientTypeName"]);
                            result.SettleHouseID = Convert.ToString(idr["SettleHouseID"]);
                            result.SettleHouseName = Convert.ToString(idr["SettleHouseName"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public void UpdateClientSettleHouse(CargoSettleHouseEntity entity)
        {
            string strSQL = @"select * from Tbl_Cargo_SettleHouse WHERE ID=@ID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ID", DbType.Int32, entity.ID);
                    var dt = conn.ExecuteDataTable(cmd);
                    if (dt.Rows.Count > 0)
                    {
                        strSQL = "update Tbl_Cargo_Client set ClientTypeID=@ClientTypeID,ClientTypeName=@ClientTypeName,SettleHouseID=@SettleHouseID,SettleHouseName=@SettleHouseName where ClientNum=@ClientNum";
                        using (DbCommand updateCmd = conn.GetSqlStringCommond(strSQL))
                        {
                            conn.AddInParameter(updateCmd, "@ClientTypeID", DbType.String, dt.Rows[0]["ClientTypeID"]);
                            conn.AddInParameter(updateCmd, "@ClientTypeName", DbType.String, dt.Rows[0]["ClientTypeName"]);
                            conn.AddInParameter(updateCmd, "@SettleHouseID", DbType.String, dt.Rows[0]["SettleHouseID"]);
                            conn.AddInParameter(updateCmd, "@SettleHouseName", DbType.String, dt.Rows[0]["SettleHouseName"]);
                            conn.AddInParameter(updateCmd, "@ClientNum", DbType.Int32, dt.Rows[0]["ClientNum"]);
                            conn.ExecuteNonQuery(updateCmd);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public Hashtable QuerySettleHouseList(int pIndex, int pNum, CargoSettleHouseEntity entity)
        {
            List<CargoSettleHouseEntity> result = new List<CargoSettleHouseEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY sh.id DESC) AS RowNumber,* from Tbl_Cargo_SettleHouse sh where (1=1) ";
                if (!entity.ClientNum.Equals(0))
                {
                    strSQL += " and sh.ClientNum=" + entity.ClientNum;
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoSettleHouseEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                ClientID = (string.IsNullOrEmpty(Convert.ToString(idr["ClientID"])) ? 0 : Convert.ToInt32(idr["ClientID"])),
                                ClientNum = (string.IsNullOrEmpty(Convert.ToString(idr["ClientNum"])) ? 0 : Convert.ToInt32(idr["ClientNum"])),
                                ClientTypeID = Convert.ToString(idr["ClientTypeID"]),
                                ClientTypeName = Convert.ToString(idr["ClientTypeName"]),
                                SettleHouseID = Convert.ToString(idr["SettleHouseID"]),
                                SettleHouseName = Convert.ToString(idr["SettleHouseName"]),
                            });
                        }
                    }
                }

                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_SettleHouse sh Where (1=1)";
                if (!entity.ClientNum.Equals(0))
                {
                    strCount += " and sh.ClientNum=" + entity.ClientNum;
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        public void DelSettleHouse(List<CargoSettleHouseEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_SettleHouse where ID=@ID ";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ID", DbType.Int64, it.ID);
                        conn.ExecuteNonQuery(cmd);
                    }
                    strSQL = "select * from Tbl_Cargo_SettleHouse where ClientNum=@ClientNum";
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, it.ClientNum);
                        var dt = conn.ExecuteDataTable(cmd);
                        if (dt.Rows.Count.Equals(1))
                        {
                            strSQL = "update Tbl_Cargo_Client set ClientTypeID=@ClientTypeID,ClientTypeName=@ClientTypeName,SettleHouseID=@SettleHouseID,SettleHouseName=@SettleHouseName where ClientNum=@ClientNum";
                            using (DbCommand updateCmd = conn.GetSqlStringCommond(strSQL))
                            {
                                conn.AddInParameter(updateCmd, "@ClientTypeID", DbType.String, dt.Rows[0]["ClientTypeID"]);
                                conn.AddInParameter(updateCmd, "@ClientTypeName", DbType.String, dt.Rows[0]["ClientTypeName"]);
                                conn.AddInParameter(updateCmd, "@SettleHouseID", DbType.String, dt.Rows[0]["SettleHouseID"]);
                                conn.AddInParameter(updateCmd, "@SettleHouseName", DbType.String, dt.Rows[0]["SettleHouseName"]);
                                conn.AddInParameter(updateCmd, "@ClientNum", DbType.Int32, it.ClientNum);
                                conn.ExecuteNonQuery(updateCmd);
                            }
                        }
                        else if (dt.Rows.Count.Equals(0))
                        {
                            strSQL = "update Tbl_Cargo_Client set ClientTypeID=NULL,ClientTypeName=NULL,SettleHouseID=NULL,SettleHouseName=NULL where ClientNum=@ClientNum";
                            using (DbCommand updateCmd = conn.GetSqlStringCommond(strSQL))
                            {
                                conn.AddInParameter(updateCmd, "@ClientNum", DbType.Int32, it.ClientNum);
                                conn.ExecuteNonQuery(updateCmd);
                            }
                        }
                    }
                    strSQL = "update Tbl_Cargo_SupplierProductPrice set DelFlag=1 where SupplierNum=@SupplierNum and HouseID=@HouseID";
                    using (DbCommand updateCmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(updateCmd, "@SupplierNum", DbType.String, it.ClientNum);
                        conn.AddInParameter(updateCmd, "@HouseID", DbType.String, it.SettleHouseID);
                        conn.ExecuteNonQuery(updateCmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void AddSettleHouse(CargoSettleHouseEntity entity, List<CargoSupplierProductPrice> productPrices)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_SettleHouse(ClientID,ClientNum,ClientTypeID,ClientTypeName,SettleHouseID,SettleHouseName) VALUES (@ClientID,@ClientNum,@ClientTypeID,@ClientTypeName,@SettleHouseID,@SettleHouseName)";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientID", DbType.Int32, entity.ClientID);
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@ClientTypeID", DbType.String, entity.ClientTypeID);
                    conn.AddInParameter(cmd, "@ClientTypeName", DbType.String, entity.ClientTypeName);
                    conn.AddInParameter(cmd, "@SettleHouseID", DbType.String, entity.SettleHouseID);
                    conn.AddInParameter(cmd, "@SettleHouseName", DbType.String, entity.SettleHouseName);
                    conn.ExecuteNonQuery(cmd);
                }
                strSQL = "select count(*) from Tbl_Cargo_SettleHouse where ClientNum=@ClientNum";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    var count = conn.ExecuteScalar(cmd);
                    if (count.Equals(1))
                    {
                        strSQL = "update Tbl_Cargo_Client set ClientTypeID=@ClientTypeID,ClientTypeName=@ClientTypeName,SettleHouseID=@SettleHouseID,SettleHouseName=@SettleHouseName where ClientNum=@ClientNum";
                        using (DbCommand updateCmd = conn.GetSqlStringCommond(strSQL))
                        {
                            conn.AddInParameter(updateCmd, "@ClientTypeID", DbType.String, entity.ClientTypeID);
                            conn.AddInParameter(updateCmd, "@ClientTypeName", DbType.String, entity.ClientTypeName);
                            conn.AddInParameter(updateCmd, "@SettleHouseID", DbType.String, entity.SettleHouseID);
                            conn.AddInParameter(updateCmd, "@SettleHouseName", DbType.String, entity.SettleHouseName);
                            conn.AddInParameter(updateCmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                            conn.ExecuteNonQuery(updateCmd);
                        }
                    }
                }
                conn.BulkInsertData(productPrices, "Tbl_Cargo_SupplierProductPrice");
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }
        public void UpdateSettleHouse(CargoSettleHouseEntity entity, CargoSettleHouseUpdateEntity updateEntity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_SettleHouse SET ClientTypeID = @ClientTypeID,ClientTypeName = @ClientTypeName,SettleHouseID = @SettleHouseID,SettleHouseName = @SettleHouseName WHERE ID=@ID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientTypeID", DbType.String, entity.ClientTypeID);
                    conn.AddInParameter(cmd, "@ClientTypeName", DbType.String, entity.ClientTypeName);
                    conn.AddInParameter(cmd, "@SettleHouseID", DbType.String, entity.SettleHouseID);
                    conn.AddInParameter(cmd, "@SettleHouseName", DbType.String, entity.SettleHouseName);
                    conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                    conn.ExecuteNonQuery(cmd);
                }
                strSQL = "select count(*) from Tbl_Cargo_SettleHouse where ClientNum=@ClientNum";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    var count = conn.ExecuteScalar(cmd);
                    if (count.Equals(1))
                    {
                        strSQL = "update Tbl_Cargo_Client set ClientTypeID=@ClientTypeID,ClientTypeName=@ClientTypeName,SettleHouseID=@SettleHouseID,SettleHouseName=@SettleHouseName where ClientNum=@ClientNum";
                        using (DbCommand updateCmd = conn.GetSqlStringCommond(strSQL))
                        {
                            conn.AddInParameter(updateCmd, "@ClientTypeID", DbType.String, entity.ClientTypeID);
                            conn.AddInParameter(updateCmd, "@ClientTypeName", DbType.String, entity.ClientTypeName);
                            conn.AddInParameter(updateCmd, "@SettleHouseID", DbType.String, entity.SettleHouseID);
                            conn.AddInParameter(updateCmd, "@SettleHouseName", DbType.String, entity.SettleHouseName);
                            conn.AddInParameter(updateCmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                            conn.ExecuteNonQuery(updateCmd);
                        }
                    }
                }
                if (!string.IsNullOrEmpty(updateEntity.OldSettleHouseID))
                {
                    strSQL = "update Tbl_Cargo_SupplierProductPrice set DelFlag=1 where SupplierNum=@SupplierNum and HouseID=@HouseID";
                    using (DbCommand updateCmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(updateCmd, "@SupplierNum", DbType.String, entity.ClientNum);
                        conn.AddInParameter(updateCmd, "@HouseID", DbType.String, entity.SettleHouseID);
                        conn.ExecuteNonQuery(updateCmd);
                    }
                }
                if (!string.IsNullOrEmpty(updateEntity.DelClientTypeID))
                {
                    strSQL = "update Tbl_Cargo_SupplierProductPrice set DelFlag=1 where SupplierNum=@SupplierNum and HouseID=@HouseID and TypeID in (" + updateEntity.DelClientTypeID + ")";
                    using (DbCommand updateCmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(updateCmd, "@SupplierNum", DbType.String, entity.ClientNum);
                        conn.AddInParameter(updateCmd, "@HouseID", DbType.String, entity.SettleHouseID);
                        conn.ExecuteNonQuery(updateCmd);
                    }
                }
                if (updateEntity.AddProductPrices != null && updateEntity.AddProductPrices.Count > 0)
                {
                    conn.BulkInsertData(updateEntity.AddProductPrices, "Tbl_Cargo_SupplierProductPrice");
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion

        #region 余额分账 BILL
        /// <summary>
        /// 获取每日最大的分账账单单号数据
        /// </summary>
        /// <returns></returns>
        public int GetMaxHouseAccountNoNum()
        {
            int result = 0;
            string strSQL = @"select COUNT(AccountID) as OrderNum from Tbl_Cargo_SuppClientAccount where (1=1) ";
            strSQL += " and CreateDate>='" + DateTime.Now.ToString("yyyy-MM-dd") + "'";
            strSQL += " and CreateDate<'" + DateTime.Now.AddDays(1).ToString("yyyy-MM-dd") + "'";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                //conn.AddInParameter(command, "@HouseID", DbType.Int32, entity.HouseID);
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    if (dd.Rows.Count > 0) { result = Convert.ToInt32(dd.Rows[0]["OrderNum"]); }
                }
            }
            return result;
        }

        /// <summary>
        /// 查询客户账单 
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QuerySuppClientBillManager(int pIndex, int pNum, CargoSuppClientAccountEntity entity)
        {
            List<CargoSuppClientAccountEntity> result = new List<CargoSuppClientAccountEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OPDATE DESC) AS RowNumber,a.*,b.Name as HouseName,c.ClientName,c.Boss FROM Tbl_Cargo_SuppClientAccount as a LEFT join Tbl_Cargo_House as b on a.HouseID=b.HouseID LEFT join Tbl_Cargo_Client as c on a.ClientID=c.ClientID WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.AccountNO)) { strSQL += " and a.AccountNO = '" + entity.AccountNO + "'"; }
                if (!entity.ClientID.Equals(0)) { strSQL += " and a.ClientID = " + entity.ClientID; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID = " + entity.HouseID; }
                if (!entity.Status.Equals(-1)) { strSQL += " and a.Status = '" + entity.Status + "'"; }
                if (!entity.ElecSign.Equals(-1)) { strSQL += " and a.ElecSign = '" + entity.ElecSign + "'"; }
                if (!entity.CheckStatus.Equals(-1)) { strSQL += " and a.CheckStatus = '" + entity.CheckStatus + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoSuppClientAccountEntity
                            {
                                ClientID = Convert.ToInt32(idr["ClientID"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                AccountID = Convert.ToInt64(idr["AccountID"]),
                                AccountNO = Convert.ToString(idr["AccountNO"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                AccountTitle = Convert.ToString(idr["AccountTitle"]),
                                ARMoney = string.IsNullOrEmpty(Convert.ToString(idr["ARMoney"])) ? 0 : Convert.ToDecimal(idr["ARMoney"]),
                                Total = string.IsNullOrEmpty(Convert.ToString(idr["Total"])) ? 0 : Convert.ToDecimal(idr["Total"]),
                                InsuranceFee = string.IsNullOrEmpty(Convert.ToString(idr["InsuranceFee"])) ? 0 : Convert.ToDecimal(idr["InsuranceFee"]),
                                TransitFee = string.IsNullOrEmpty(Convert.ToString(idr["TransitFee"])) ? 0 : Convert.ToDecimal(idr["TransitFee"]),
                                OverDueFee = string.IsNullOrEmpty(Convert.ToString(idr["OverDueFee"])) ? 0 : Convert.ToDecimal(idr["OverDueFee"]),
                                OutStorageFee = string.IsNullOrEmpty(Convert.ToString(idr["OutStorageFee"])) ? 0 : Convert.ToDecimal(idr["OutStorageFee"]),
                                DeliveryFee = string.IsNullOrEmpty(Convert.ToString(idr["DeliveryFee"])) ? 0 : Convert.ToDecimal(idr["DeliveryFee"]),
                                StoReleaseFee = string.IsNullOrEmpty(Convert.ToString(idr["StoReleaseFee"])) ? 0 : Convert.ToDecimal(idr["StoReleaseFee"]),
                                OtherFee = string.IsNullOrEmpty(Convert.ToString(idr["OtherFee"])) ? 0 : Convert.ToDecimal(idr["OtherFee"]),
                                //TaxFee = string.IsNullOrEmpty(Convert.ToString(idr["TaxFee"])) ? 0 : Convert.ToDecimal(idr["TaxFee"]),
                                //OtherFee = string.IsNullOrEmpty(Convert.ToString(idr["OtherFee"])) ? 0 : Convert.ToDecimal(idr["OtherFee"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                Status = Convert.ToInt32(idr["Status"]),
                                NextCheckID = Convert.ToString(idr["NextCheckID"]),
                                NextCheckName = Convert.ToString(idr["NextCheckName"]),
                                CheckStatus = Convert.ToInt32(idr["CheckStatus"]),
                                ElecSign = Convert.ToInt32(idr["ElecSign"]),
                                ElecSignImg = Convert.ToString(idr["ElecSignImg"]),
                                ElecSignDate = string.IsNullOrEmpty(Convert.ToString(idr["ElecSignDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["ElecSignDate"]),
                                OPID = Convert.ToString(idr["OPID"]),
                                OPDATE = Convert.ToDateTime(idr["OPDATE"]),
                                AType = Convert.ToInt32(idr["AType"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseID = Convert.ToInt32(idr["HouseID"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"select count(*) as TotalCount from Tbl_Cargo_ClientAccount as a Where(1 = 1)";
                //if (!entity.HouseID.Equals(0)) { strCount += " and a.HouseID = " + entity.HouseID; }
                //if (!string.IsNullOrEmpty(entity.AccountID)) { strCount += " and a.AccountID = '" + entity.AccountID + "'"; }
                //if (!entity.ClientID.Equals(0)) { strCount += " and a.ClientID = " + entity.ClientID; }
                //if (!string.IsNullOrEmpty(entity.Status)) { strCount += " and a.Status = '" + entity.Status + "'"; }
                //if (!string.IsNullOrEmpty(entity.ElecSign)) { strCount += " and a.ElecSign = '" + entity.ElecSign + "'"; }
                //if (!string.IsNullOrEmpty(entity.CheckStatus)) { strCount += " and a.CheckStatus = '" + entity.CheckStatus + "'"; }
                ////制单日期范围
                //if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                //{
                //    strCount += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                //}
                //if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                //{
                //    strCount += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                //}
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 查询客户账单
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoClientAccountEntity QueryCargoSuppClientAccount(CargoClientAccountEntity entity)
        {
            CargoClientAccountEntity result = new CargoClientAccountEntity();
            try
            {
                string strSQL = @"SELECT a.*,b.Name as HouseName,c.Boss FROM Tbl_Cargo_ClientAccount as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID inner join Tbl_Cargo_Client as c on a.ClientID=c.ClientID  Where (1=1)";
                if (!string.IsNullOrEmpty(entity.AccountID)) { strSQL += " and a.AccountID='" + entity.AccountID + "'"; }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.ClientID = Convert.ToInt64(idr["ClientID"]);
                            result.ClientNum = Convert.ToInt32(idr["ClientNum"]);
                            result.ClientID = Convert.ToInt64(idr["ClientID"]);
                            result.ClientNum = Convert.ToInt32(idr["ClientNum"]);
                            result.ClientName = Convert.ToString(idr["Boss"]);
                            result.AccountID = Convert.ToString(idr["AccountID"]);
                            result.CreateDate = Convert.ToDateTime(idr["CreateDate"]);
                            result.AccountTitle = Convert.ToString(idr["AccountTitle"]);
                            result.ARMoney = string.IsNullOrEmpty(Convert.ToString(idr["ARMoney"])) ? 0 : Convert.ToDecimal(idr["ARMoney"]);
                            result.Total = string.IsNullOrEmpty(Convert.ToString(idr["Total"])) ? 0 : Convert.ToDecimal(idr["Total"]);
                            result.TaxFee = string.IsNullOrEmpty(Convert.ToString(idr["TaxFee"])) ? 0 : Convert.ToDecimal(idr["TaxFee"]);
                            result.OtherFee = string.IsNullOrEmpty(Convert.ToString(idr["OtherFee"])) ? 0 : Convert.ToDecimal(idr["OtherFee"]);
                            result.Memo = Convert.ToString(idr["Memo"]);
                            result.Status = Convert.ToString(idr["Status"]);
                            result.NextCheckID = Convert.ToString(idr["NextCheckID"]);
                            result.NextCheckName = Convert.ToString(idr["NextCheckName"]);
                            result.CheckStatus = Convert.ToString(idr["CheckStatus"]);
                            result.OPID = Convert.ToString(idr["OPID"]);
                            result.OPDATE = Convert.ToDateTime(idr["OPDATE"]);
                            result.AType = Convert.ToString(idr["AType"]);
                            result.HouseName = Convert.ToString(idr["HouseName"]);
                            result.HouseID = Convert.ToInt32(idr["HouseID"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询账单明细
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public List<CargoSuppClientAccountGoodsEntity> QueryCargoSuppClientAccountGoods(CargoSuppClientAccountGoodsEntity entity) {
            List<CargoSuppClientAccountGoodsEntity> result = new List<CargoSuppClientAccountGoodsEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @" select * from Tbl_Cargo_SuppClientAccountGoods where (1=1) ";
                if (!string.IsNullOrEmpty(entity.AccountNO))
                {
                    strSQL += " and AccountNO ='" + entity.AccountNO+"'";
                }
                
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoSuppClientAccountGoodsEntity
                            {
                                 AccountNO = Convert.ToString(idr["AccountNO"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                ID = Convert.ToInt64(idr["ID"]),
                                ProductID = Convert.ToInt32(idr["ProductID"]),
                                Total = Convert.ToDecimal(idr["Total"]),
                                InsuranceFee = Convert.ToDecimal(idr["InsuranceFee"]),
                                TransitFee = Convert.ToDecimal(idr["TransitFee"]),
                                DeliveryFee = Convert.ToDecimal(idr["DeliveryFee"]),
                                OverDueFee = Convert.ToDecimal(idr["OverDueFee"]),
                                OutStorageFee = Convert.ToDecimal(idr["OutStorageFee"]),
                                StoReleaseFee = Convert.ToDecimal(idr["StoReleaseFee"]),

                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                //OrderNo = Convert.ToString(idr["AccountNO"]),
                                //OrderNo = Convert.ToString(idr["AccountNO"]),
                                //OrderNo = Convert.ToString(idr["AccountNO"]),
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;

        }
        /// <summary>
        /// 查询账单明细 批量
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public List<CargoSuppClientAccountGoodsEntity> QueryCargoSuppClientAccountGoodsBatch(List<CargoSuppClientAccountEntity> entity) {
            List<CargoSuppClientAccountGoodsEntity> result = new List<CargoSuppClientAccountGoodsEntity>();
            try
            {
                string strSQL = @" select * from Tbl_Cargo_SuppClientAccountGoods where (1=1) ";
                if (entity.Count>0)
                {
                    strSQL += $@" and AccountNO in('{(string.Join("','",entity.Select(a=>a.AccountNO).ToList()))}')";
                }

                strSQL += $@" order by AccountNO";
                
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoSuppClientAccountGoodsEntity
                            {
                                 AccountNO = Convert.ToString(idr["AccountNO"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                ID = Convert.ToInt64(idr["ID"]),
                                ProductID = Convert.ToInt32(idr["ProductID"]),
                                Total = Convert.ToDecimal(idr["Total"]),
                                InsuranceFee = Convert.ToDecimal(idr["InsuranceFee"]),
                                TransitFee = Convert.ToDecimal(idr["TransitFee"]),
                                DeliveryFee = Convert.ToDecimal(idr["DeliveryFee"]),
                                OverDueFee = Convert.ToDecimal(idr["OverDueFee"]),
                                OutStorageFee = Convert.ToDecimal(idr["OutStorageFee"]),
                                StoReleaseFee = Convert.ToDecimal(idr["StoReleaseFee"]),
                                OtherExpensesFee = Convert.ToDecimal(idr["OtherExpensesFee"]),

                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                //OrderNo = Convert.ToString(idr["AccountNO"]),
                                //OrderNo = Convert.ToString(idr["AccountNO"]),
                                //OrderNo = Convert.ToString(idr["AccountNO"]),
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;

        }

        /// <summary>
        /// 新增账单
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoSuppAccount(CargoSuppClientAccountEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_SuppClientAccount
(AccountNO,AccountTitle,CreateDate,ClientID,ClientNum,HouseID,ARMoney,Total,InsuranceFee,OverDueFee,OutStorageFee,DeliveryFee,StoReleaseFee,Memo,Status,NextCheckID,NextCheckName,CheckStatus,OPID,OPDATE,AType,OtherFee,TransitFee)
VALUES(@AccountNO,@AccountTitle,@CreateDate,@ClientID,@ClientNum,@HouseID,@ARMoney,@Total,@InsuranceFee,@OverDueFee,@OutStorageFee,@DeliveryFee,@StoReleaseFee,@Memo,@Status,@NextCheckID,@NextCheckName,@CheckStatus,@OPID,@OPDATE,@AType,@OtherFee,@TransitFee)";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@AccountNO", DbType.String, entity.AccountNO);
                    conn.AddInParameter(cmd, "@AccountTitle", DbType.String, entity.AccountTitle);
                    conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, entity.CreateDate);
                    conn.AddInParameter(cmd, "@ClientID", DbType.Int64, entity.ClientID);
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);

                    conn.AddInParameter(cmd, "@ARMoney", DbType.Decimal, entity.ARMoney);
                    conn.AddInParameter(cmd, "@Total", DbType.Decimal, entity.Total);
                    conn.AddInParameter(cmd, "@InsuranceFee", DbType.Decimal, entity.InsuranceFee);
                    conn.AddInParameter(cmd, "@OverDueFee", DbType.Decimal, entity.OverDueFee);
                    conn.AddInParameter(cmd, "@TransitFee", DbType.Decimal, entity.TransitFee);
                    conn.AddInParameter(cmd, "@OutStorageFee", DbType.Decimal, entity.OutStorageFee);
                    conn.AddInParameter(cmd, "@DeliveryFee", DbType.Decimal, entity.DeliveryFee);
                    conn.AddInParameter(cmd, "@StoReleaseFee", DbType.Decimal, entity.StoReleaseFee);
                    conn.AddInParameter(cmd, "@OtherFee", DbType.Decimal, entity.OtherFee);

                    conn.AddInParameter(cmd, "@Memo", DbType.String, entity.Memo);
                    conn.AddInParameter(cmd, "@Status", DbType.String, entity.Status);
                    conn.AddInParameter(cmd, "@NextCheckID", DbType.String, entity.NextCheckID);
                    conn.AddInParameter(cmd, "@NextCheckName", DbType.String, entity.NextCheckName);
                    conn.AddInParameter(cmd, "@CheckStatus", DbType.String, entity.CheckStatus);
                    conn.AddInParameter(cmd, "@OPID", DbType.String, entity.OPID);
                    conn.AddInParameter(cmd, "@OPDATE", DbType.String, DateTime.Now);
                    conn.AddInParameter(cmd, "@AType", DbType.String, entity.AType);
                    
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        //CargoSuppClientAccountGoodsEntity
        /// <summary>
        /// 新增账单
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoSuppAccountGoods(CargoSuppClientAccountGoodsEntity entity, string AccountNO)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_SuppClientAccountGoods
(AccountNO,OrderNo,ProductID,Total,InsuranceFee,TransitFee,DeliveryFee,OverDueFee,OutStorageFee,StoReleaseFee,OrderModel,OtherFee,OtherExpensesFee)
VALUES(@AccountNO,@OrderNo,@ProductID,@Total,@InsuranceFee,@TransitFee,@DeliveryFee,@OverDueFee,@OutStorageFee,@StoReleaseFee,@OrderModel,@OtherFee,@OtherExpensesFee)";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@AccountNO", DbType.String, AccountNO);
                    conn.AddInParameter(cmd, "@OrderNo", DbType.String, entity.OrderNo);
                    conn.AddInParameter(cmd, "@ProductID", DbType.String, entity.ProductID);
                    conn.AddInParameter(cmd, "@Total", DbType.Decimal, entity.Total);
                    conn.AddInParameter(cmd, "@InsuranceFee", DbType.Decimal, entity.InsuranceFee);
                    conn.AddInParameter(cmd, "@TransitFee", DbType.Decimal, entity.TransitFee);
                    conn.AddInParameter(cmd, "@DeliveryFee", DbType.Decimal, entity.DeliveryFee);
                    conn.AddInParameter(cmd, "@OverDueFee", DbType.Decimal, entity.OverDueFee);
                    conn.AddInParameter(cmd, "@OutStorageFee", DbType.Decimal, entity.OutStorageFee);
                    conn.AddInParameter(cmd, "@StoReleaseFee", DbType.Decimal, entity.StoReleaseFee);
                    conn.AddInParameter(cmd, "@OtherFee", DbType.Decimal, entity.OtherFee);
                    conn.AddInParameter(cmd, "@OrderModel", DbType.Int32, entity.OrderModel);
                    conn.AddInParameter(cmd, "@OtherExpensesFee", DbType.Decimal, entity.OtherExpensesFee);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改账单
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateSuppAccountData(CargoSuppClientAccountGoodsEntity entity)
        {
            var ARMoneyStr = entity.OrderModel == "0" ? "ARMoney+=@OtherExpensesFee" : "ARMoney-=@OtherExpensesFee";
            var TotalStr = entity.OrderModel == "0" ? "Total+=@OtherExpensesFee" : "Total-=@OtherExpensesFee";
            string strSQL = $@"update Tbl_Cargo_SuppClientAccount set {ARMoneyStr},{TotalStr},Memo+=@Memo where AccountNO=@AccountNO";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@OtherExpensesFee", DbType.Decimal, entity.OtherExpensesFee);
                conn.AddInParameter(cmd, "@Memo", DbType.String,"冲账："+ entity.Memo);
                conn.AddInParameter(cmd, "@AccountNO", DbType.String, entity.AccountNO);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改订单的账单号
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateSuppOrderAccountNo(CargoSuppClientAccountGoodsEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Order SET IsSupplierType=@IsSupplierType,IsHouseType=@IsHouseType where OrderNo=@OrderNo";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@IsSupplierType", DbType.Int32, entity.IsSupplierType);
                conn.AddInParameter(cmd, "@IsHouseType", DbType.Int32, entity.IsHouseType);
                conn.AddInParameter(cmd, "@OrderNo", DbType.String, entity.OrderNo);
                conn.ExecuteNonQuery(cmd);
            }
        }
        public void UpdateIsSupplierTypeOrder(CargoSuppClientAccountGoodsEntity entity)
        {
            string inClauseParams = "'" + string.Join("','", entity.OrderNoList) + "'";

            string strSQL = $@"UPDATE Tbl_Cargo_Order 
                       SET IsSupplierType = @IsSupplierType 
                       WHERE OrderNo IN ({inClauseParams})";
            //string strSQL = @"UPDATE Tbl_Cargo_Order SET IsSupplierType=@IsSupplierType where OrderNo IN (@OrderNo)";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@IsSupplierType", DbType.Int32, entity.IsSupplierType);
                conn.ExecuteNonQuery(cmd);
            }
        }
        public void UpdateIsHouseTypeAccountNo(CargoSuppClientAccountGoodsEntity entity)
        {
            string inClauseParams = "'" + string.Join("','", entity.OrderNoList) + "'";

            string strSQL = $@"UPDATE Tbl_Cargo_Order 
                       SET IsHouseType = @IsHouseType 
                       WHERE OrderNo IN ({inClauseParams})";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@IsHouseType", DbType.Int32, entity.IsHouseType);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改客户数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoSuppAccount(CargoSuppClientAccountEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_SuppClientAccount SET Status = @Status,CheckStatus = @CheckStatus WHERE AccountNO=@AccountNO";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@AccountNO", DbType.String, entity.AccountNO);
                    conn.AddInParameter(cmd, "@Status", DbType.String, entity.Status);
                    conn.AddInParameter(cmd, "@CheckStatus", DbType.Int32, entity.CheckStatus);
                    
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void DelCargoSuppClientAccount(List<CargoSuppClientAccountEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete Tbl_Cargo_SuppClientAccount  WHERE AccountID=@AccountID;";
                    strSQL += @" Delete Tbl_Cargo_SuppClientAccountGoods  WHERE AccountNO=@AccountNO;";
                    //string strSQL = @"Delete Tbl_Cargo_SuppClientAccount  WHERE AccountID=@AccountID;";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@AccountID", DbType.Int64, it.AccountID);
                        conn.AddInParameter(cmd, "@AccountNO", DbType.String, it.AccountNO);
                        conn.ExecuteNonQuery(cmd);
                    }


                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        
        #endregion
    }
}
