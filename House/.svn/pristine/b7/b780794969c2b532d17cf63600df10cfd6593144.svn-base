using House.DataAccess;
using House.DataAccess.Sql;
using House.Entity.Cargo;
using House.Entity.Cargo.House;
using House.Entity.Cargo.Product;
using House.Entity.Dto;
using House.Manager.Common;
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Data.Common;
using System.Data.SqlClient;
using System.Linq;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Text;

namespace House.Manager.Cargo
{
    /// <summary>
    /// 仓库管理数据操作类
    /// </summary>
    public class CargoHouseManager
    {
        private SqlHelper conn = new SqlHelper();
        #region 仓库管理操作方法集合

        /// <summary>
        /// 判断仓库名是否存在 true:表示存在
        /// </summary>
        /// <param name="entity"></param>
        /// <returns>true:表示存在</returns>
        public bool IsExistCargoHouse(CargoHouseEntity entity)
        {
            string strQ = @"Select Name from Tbl_Cargo_House Where Name=@Name";
            if (entity.HouseID != 0)
            {
                strQ += " and HouseID!=@HouseID";
            }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@Name", DbType.String, entity.Name);
                if (entity.HouseID != 0)
                {
                    conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }

        /// <summary>
        /// 判断仓库代码是否存在 true:表示存在 
        /// </summary>
        /// <param name="housecode"></param>
        /// <returns></returns>
        public bool IsExistCargoHouse(string houseCode, int houseID = 0)
        {
            string strQ = @"Select HouseCode from Tbl_Cargo_House Where HouseCode=@HouseCode";
            if (houseID != 0)
            {
                strQ += " and HouseID!=@HouseID";
            }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@HouseCode", DbType.String, houseCode);
                if (houseID != 0)
                {
                    conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, houseID);
                }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 新增仓库数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoHouse(CargoHouseEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"INSERT INTO Tbl_Cargo_House(Name,HouseCode,Person,Cellphone,Remark,DelFlag,PickTitle,SendTitle,DeliveryArea,BelongHouse,DepCity,CargoDepart,OESCargoDepart,Address,OperaBrand,LogisFee,TwoLogisFee,ThreeLogisFee,StartBusHours,EndBusHours,HCYCOrderPushTagID,NextDayLogisFee,OverDueUnitPrice,OverDayNum,IsCanRush,IsCanPickUp,IsCanNextDay,StockShareHouseID,ParentID,ParentName) VALUES (@Name,@HouseCode,@Person,@Cellphone,@Remark,@DelFlag,@PickTitle,@SendTitle,@DeliveryArea,@BelongHouse,@DepCity,@CargoDepart,@OESCargoDepart,@Address,@OperaBrand,@LogisFee,@TwoLogisFee,@ThreeLogisFee,@StartBusHours,@EndBusHours,@HCYCOrderPushTagID,@NextDayLogisFee,@OverDueUnitPrice,@OverDayNum,@IsCanRush,@IsCanPickUp,@IsCanNextDay,@StockShareHouseID,@ParentID,@ParentName)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@Name", DbType.String, entity.Name);
                    conn.AddInParameter(cmd, "@HouseCode", DbType.String, entity.HouseCode);
                    conn.AddInParameter(cmd, "@Person", DbType.String, entity.Person);
                    conn.AddInParameter(cmd, "@Cellphone", DbType.String, entity.Cellphone);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@SendTitle", DbType.String, entity.SendTitle);
                    conn.AddInParameter(cmd, "@PickTitle", DbType.String, entity.PickTitle);
                    conn.AddInParameter(cmd, "@DeliveryArea", DbType.String, entity.DeliveryArea);
                    conn.AddInParameter(cmd, "@DepCity", DbType.String, entity.DepCity);
                    conn.AddInParameter(cmd, "@CargoDepart", DbType.String, entity.CargoDepart);
                    conn.AddInParameter(cmd, "@OESCargoDepart", DbType.String, entity.OESCargoDepart);
                    conn.AddInParameter(cmd, "@BelongHouse", DbType.String, entity.BelongHouse);
                    conn.AddInParameter(cmd, "@Address", DbType.String, entity.Address);
                    conn.AddInParameter(cmd, "@OperaBrand", DbType.String, entity.OperaBrand);
                    conn.AddInParameter(cmd, "@LogisFee", DbType.Decimal, entity.LogisFee);
                    conn.AddInParameter(cmd, "@TwoLogisFee", DbType.Decimal, entity.TwoLogisFee);
                    conn.AddInParameter(cmd, "@ThreeLogisFee", DbType.Decimal, entity.ThreeLogisFee);
                    conn.AddInParameter(cmd, "@NextDayLogisFee", DbType.Decimal, entity.NextDayLogisFee);
                    conn.AddInParameter(cmd, "@StartBusHours", DbType.String, entity.StartBusHours);
                    conn.AddInParameter(cmd, "@EndBusHours", DbType.String, entity.EndBusHours);
                    conn.AddInParameter(cmd, "@HCYCOrderPushTagID", DbType.Int32, entity.HCYCOrderPushTagID);
                    conn.AddInParameter(cmd, "@OverDayNum", DbType.Int32, entity.OverDayNum);
                    conn.AddInParameter(cmd, "@OverDueUnitPrice", DbType.Decimal, entity.OverDueUnitPrice);
                    conn.AddInParameter(cmd, "@IsCanRush", DbType.String, entity.IsCanRush);
                    conn.AddInParameter(cmd, "@IsCanPickUp", DbType.String, entity.IsCanPickUp);
                    conn.AddInParameter(cmd, "@IsCanNextDay", DbType.String, entity.IsCanNextDay);
                    conn.AddInParameter(cmd, "@StockShareHouseID", DbType.Int32, entity.StockShareHouseID);
                    conn.AddInParameter(cmd, "@ParentID", DbType.Int32, entity.ParentID);
                    conn.AddInParameter(cmd, "@ParentName", DbType.String, entity.ParentName);

                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改仓库数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoHouse(CargoHouseEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"UPDATE Tbl_Cargo_House SET Name=@Name,HouseCode=@HouseCode,Person=@Person,Cellphone=@Cellphone,Remark=@Remark,DelFlag=@DelFlag,SendTitle=@SendTitle,PickTitle=@PickTitle,DeliveryArea=@DeliveryArea,BelongHouse=@BelongHouse,DepCity=@DepCity,CargoDepart=@CargoDepart,OESCargoDepart=@OESCargoDepart,Address=@Address,OperaBrand=@OperaBrand,LogisFee=@LogisFee,TwoLogisFee=@TwoLogisFee,ThreeLogisFee=@ThreeLogisFee,StartBusHours=@StartBusHours,EndBusHours=@EndBusHours,HCYCOrderPushTagID=@HCYCOrderPushTagID,NextDayLogisFee=@NextDayLogisFee,OverDayNum=@OverDayNum,OverDueUnitPrice=@OverDueUnitPrice,IsCanRush=@IsCanRush,IsCanPickUp=@IsCanPickUp,IsCanNextDay=@IsCanNextDay,StockShareHouseID=@StockShareHouseID,ParentID=@ParentID,ParentName=@ParentName WHERE HouseID=@HouseID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@Name", DbType.String, entity.Name);
                    conn.AddInParameter(cmd, "@HouseCode", DbType.String, entity.HouseCode);
                    conn.AddInParameter(cmd, "@Person", DbType.String, entity.Person);
                    conn.AddInParameter(cmd, "@Cellphone", DbType.String, entity.Cellphone);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@SendTitle", DbType.String, entity.SendTitle);
                    conn.AddInParameter(cmd, "@PickTitle", DbType.String, entity.PickTitle);
                    conn.AddInParameter(cmd, "@DeliveryArea", DbType.String, entity.DeliveryArea);
                    conn.AddInParameter(cmd, "@DepCity", DbType.String, entity.DepCity);
                    conn.AddInParameter(cmd, "@CargoDepart", DbType.String, entity.CargoDepart);
                    conn.AddInParameter(cmd, "@OESCargoDepart", DbType.String, entity.OESCargoDepart);
                    conn.AddInParameter(cmd, "@BelongHouse", DbType.String, entity.BelongHouse);
                    conn.AddInParameter(cmd, "@Address", DbType.String, entity.Address);
                    conn.AddInParameter(cmd, "@OperaBrand", DbType.String, entity.OperaBrand);
                    conn.AddInParameter(cmd, "@LogisFee", DbType.Decimal, entity.LogisFee);
                    conn.AddInParameter(cmd, "@TwoLogisFee", DbType.Decimal, entity.TwoLogisFee);
                    conn.AddInParameter(cmd, "@ThreeLogisFee", DbType.Decimal, entity.ThreeLogisFee);
                    conn.AddInParameter(cmd, "@StartBusHours", DbType.String, entity.StartBusHours);
                    conn.AddInParameter(cmd, "@EndBusHours", DbType.String, entity.EndBusHours);
                    conn.AddInParameter(cmd, "@HCYCOrderPushTagID", DbType.Int32, entity.HCYCOrderPushTagID);
                    conn.AddInParameter(cmd, "@NextDayLogisFee", DbType.Decimal, entity.NextDayLogisFee);
                    conn.AddInParameter(cmd, "@OverDayNum", DbType.Int32, entity.OverDayNum);
                    conn.AddInParameter(cmd, "@OverDueUnitPrice", DbType.Decimal, entity.OverDueUnitPrice);
                    conn.AddInParameter(cmd, "@IsCanRush", DbType.String, entity.IsCanRush);
                    conn.AddInParameter(cmd, "@IsCanPickUp", DbType.String, entity.IsCanPickUp);
                    conn.AddInParameter(cmd, "@IsCanNextDay", DbType.String, entity.IsCanNextDay);
                    conn.AddInParameter(cmd, "@StockShareHouseID", DbType.String, entity.StockShareHouseID);
                    conn.AddInParameter(cmd, "@ParentID", DbType.Int32, entity.ParentID);
                    conn.AddInParameter(cmd, "@ParentName", DbType.String, entity.ParentName);

                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除仓库数据
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoHouse(List<CargoHouseEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"UPDATE Tbl_Cargo_House SET DelFlag='1' WHERE HouseID=@HouseID";
                    if (it.DelFlag.Equals("1"))//彻底删除
                    {
                        strSQL = @"Delete from Tbl_Cargo_House where HouseID=@HouseID ";
                    }
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@HouseID", DbType.Int32, it.HouseID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 根据仓库ID查询仓库数据
        /// </summary>
        /// <param name="houseID"></param>
        /// <returns></returns>
        public CargoHouseEntity QueryCargoHouseByID(int houseID)
        {
            CargoHouseEntity result = new CargoHouseEntity();
            string strSQL = @"SELECT * FROM Tbl_Cargo_House WHERE DelFlag='0' and HouseID=@HouseID ";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, houseID);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.HouseID = Convert.ToInt32(idrCount["HouseID"]);
                            result.Name = Convert.ToString(idrCount["Name"]);
                            result.HouseCode = Convert.ToString(idrCount["HouseCode"]);
                            result.Person = Convert.ToString(idrCount["Person"]);
                            result.Cellphone = Convert.ToString(idrCount["Cellphone"]);
                            result.Remark = Convert.ToString(idrCount["Remark"]);
                            result.OP_DATE = Convert.ToDateTime(idrCount["OP_DATE"]);
                            result.SendTitle = Convert.ToString(idrCount["SendTitle"]);
                            result.PickTitle = Convert.ToString(idrCount["PickTitle"]);
                            result.DepCity = Convert.ToString(idrCount["DepCity"]);
                            result.BelongHouse = Convert.ToString(idrCount["BelongHouse"]);
                            result.CargoDepart = Convert.ToString(idrCount["CargoDepart"]);
                            result.OESCargoDepart = Convert.ToString(idrCount["OESCargoDepart"]);
                            result.Address = Convert.ToString(idrCount["Address"]);
                            result.StartBusHours = Convert.ToString(idrCount["StartBusHours"]);
                            result.EndBusHours = Convert.ToString(idrCount["EndBusHours"]);
                            result.HCYCOrderPushTagID = Convert.ToInt32(idrCount["HCYCOrderPushTagID"]);
                            result.OverDayNum = string.IsNullOrEmpty(Convert.ToString(idrCount["OverDayNum"])) ? 0 : Convert.ToInt32(idrCount["OverDayNum"]);
                            result.OverDueUnitPrice = string.IsNullOrEmpty(Convert.ToString(idrCount["OverDueUnitPrice"])) ? 0 : Convert.ToDecimal(idrCount["OverDueUnitPrice"]);
                            result.IsCanRush = Convert.ToString(idrCount["IsCanRush"]);
                            result.IsCanPickUp = Convert.ToString(idrCount["IsCanPickUp"]);
                            result.IsCanNextDay = Convert.ToString(idrCount["IsCanNextDay"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 仓库查询
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <param name="strCountWhere">查询总数的查询条件</param>
        /// <returns></returns> 
        public Hashtable QueryCargoHouse(int pIndex, int pNum, CargoHouseEntity entity)
        {
            List<CargoHouseEntity> result = new List<CargoHouseEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY OP_DATE DESC) AS RowNumber,* FROM Tbl_Cargo_House WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.HouseCode)) { strSQL += " and HouseCode = '" + entity.HouseCode + "'"; }
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strSQL += " and DelFlag = '" + entity.DelFlag + "'"; }
                if (!string.IsNullOrEmpty(entity.BelongHouse)) { strSQL += " and BelongHouse = '" + entity.BelongHouse + "'"; }
                //以名称为查询条件
                if (!string.IsNullOrEmpty(entity.Name)) { strSQL += " and Name like '%" + entity.Name + "%'"; }
                if (!string.IsNullOrEmpty(entity.Person)) { strSQL += " and Person like '%" + entity.Person + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strSQL += " and Cellphone like '%" + entity.Cellphone + "%'"; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoHouseEntity
                            {
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                Name = Convert.ToString(idr["Name"]),
                                HouseCode = Convert.ToString(idr["HouseCode"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                Person = Convert.ToString(idr["Person"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                DelFlag = Convert.ToString(idr["DelFlag"]),
                                BelongHouse = Convert.ToString(idr["BelongHouse"]),
                                PickTitle = Convert.ToString(idr["PickTitle"]),
                                SendTitle = Convert.ToString(idr["SendTitle"]),
                                DeliveryArea = Convert.ToString(idr["DeliveryArea"]),
                                DepCity = Convert.ToString(idr["DepCity"]),
                                CargoDepart = Convert.ToString(idr["CargoDepart"]),
                                OESCargoDepart = Convert.ToString(idr["OESCargoDepart"]),
                                Address = Convert.ToString(idr["Address"]),
                                OperaBrand = Convert.ToString(idr["OperaBrand"]),
                                StartBusHours = Convert.ToString(idr["StartBusHours"]),
                                EndBusHours = Convert.ToString(idr["EndBusHours"]),
                                HCYCOrderPushTagID = Convert.ToInt32(idr["HCYCOrderPushTagID"]),
                                LogisFee = string.IsNullOrEmpty(Convert.ToString(idr["LogisFee"])) ? 0 : Convert.ToDecimal(idr["LogisFee"]),
                                TwoLogisFee = string.IsNullOrEmpty(Convert.ToString(idr["TwoLogisFee"])) ? 0 : Convert.ToDecimal(idr["TwoLogisFee"]),
                                ThreeLogisFee = string.IsNullOrEmpty(Convert.ToString(idr["ThreeLogisFee"])) ? 0 : Convert.ToDecimal(idr["ThreeLogisFee"]),
                                NextDayLogisFee = string.IsNullOrEmpty(Convert.ToString(idr["NextDayLogisFee"])) ? 0 : Convert.ToDecimal(idr["NextDayLogisFee"]),
                                OverDayNum = string.IsNullOrEmpty(Convert.ToString(idr["OverDayNum"])) ? 0 : Convert.ToInt32(idr["OverDayNum"]),
                                OverDueUnitPrice = string.IsNullOrEmpty(Convert.ToString(idr["OverDueUnitPrice"])) ? 0 : Convert.ToDecimal(idr["OverDueUnitPrice"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                IsCanRush = Convert.ToString(idr["IsCanRush"]),
                                IsCanPickUp = Convert.ToString(idr["IsCanPickUp"]),
                                IsCanNextDay = Convert.ToString(idr["IsCanNextDay"]),
                                StockShareHouseID = string.IsNullOrEmpty(Convert.ToString(idr["StockShareHouseID"])) ? 0 : Convert.ToInt32(idr["StockShareHouseID"]),
                                ParentID = idr.Field<int?>("ParentID"),
                                ParentName = idr.Field<string>("ParentName")
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_House Where (1=1)";
                if (!string.IsNullOrEmpty(entity.HouseCode)) { strCount += " and HouseCode = '" + entity.HouseCode + "'"; }
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strCount += " and DelFlag = '" + entity.DelFlag + "'"; }
                if (!string.IsNullOrEmpty(entity.BelongHouse)) { strCount += " and BelongHouse = '" + entity.BelongHouse + "'"; }
                //以名称为查询条件
                if (!string.IsNullOrEmpty(entity.Name)) { strCount += " and Name like '%" + entity.Name + "%'"; }
                if (!string.IsNullOrEmpty(entity.Person)) { strCount += " and Person like '%" + entity.Person + "%'"; }
                if (!string.IsNullOrEmpty(entity.Cellphone)) { strCount += " and Cellphone like '%" + entity.Cellphone + "%'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 查询所有正常状态的仓库
        /// </summary>
        /// <returns></returns>
        public List<CargoHouseEntity> QueryALLHouse()
        {
            List<CargoHouseEntity> result = new List<CargoHouseEntity>();
            string strSQL = @"SELECT HouseID,Name,Address,DepCity,CargoDepart,ParentID,ParentName FROM Tbl_Cargo_House WHERE DelFlag='0' ";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoHouseEntity
                            {
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                Name = Convert.ToString(idrCount["Name"]),
                                Address = Convert.ToString(idrCount["Address"]),
                                DepCity = Convert.ToString(idrCount["DepCity"]),
                                CargoDepart = Convert.ToString(idrCount["CargoDepart"]),
                                ParentID = idrCount["ParentID"] == DBNull.Value ? (int?)null : Convert.ToInt32(idrCount["ParentID"]),
                                ParentName = Convert.ToString(idrCount["ParentName"]),
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public List<CargoHouseEntity> QueryALLHouse(CargoHouseEntity entity)
        {
            List<CargoHouseEntity> result = new List<CargoHouseEntity>();
            string strSQL = @"SELECT HouseID,Name FROM Tbl_Cargo_House WHERE DelFlag='0' ";
            if (!string.IsNullOrEmpty(entity.BelongHouse))
            {
                strSQL += " and BelongHouse in (" + entity.BelongHouse + ")";
            }
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoHouseEntity
                            {
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                Name = Convert.ToString(idrCount["Name"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询城市
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoCityEntity> QueryCityData(CargoCityEntity entity)
        {
            List<CargoCityEntity> result = new List<CargoCityEntity>();
            string strSQL = "Select * From Tbl_OA_City Where 1=1";
            //strSQL += " and ParentID=@ParentID";
            if (!entity.ParentID.Equals(-1)) { strSQL += " and ParentID=@ParentID"; }
            if (!string.IsNullOrEmpty(entity.City))
            {
                strSQL += " and City=@City";
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                //conn.AddInParameter(cmd, "@ParentID", DbType.Int32, entity.ParentID);
                if (!entity.ParentID.Equals(-1))
                {
                    conn.AddInParameter(cmd, "@ParentID", DbType.Int32, entity.ParentID);
                }
                if (!string.IsNullOrEmpty(entity.City))
                {
                    conn.AddInParameter(cmd, "@City", DbType.String, entity.City);
                }
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoCityEntity
                        {
                            ID = Convert.ToInt32(idrCount["ID"]),
                            City = Convert.ToString(idrCount["City"]),
                            ParentID = Convert.ToInt32(idrCount["ParentID"]),
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询仓库
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoHouseEntity QueryCargoHouse(CargoHouseEntity entity)
        {
            CargoHouseEntity result = new CargoHouseEntity();
            string strSQL = @"SELECT * FROM Tbl_Cargo_House WHERE DelFlag='0'";
            if (!string.IsNullOrEmpty(entity.HouseCode)) { strSQL += " and HouseCode = '" + entity.HouseCode + "'"; }
            if (!string.IsNullOrEmpty(entity.DeliveryArea)) { strSQL += " and DeliveryArea like '%" + entity.DeliveryArea + "%'"; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and HouseID='" + entity.HouseID + "'"; }
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.HouseID = Convert.ToInt32(idrCount["HouseID"]);
                            result.Name = Convert.ToString(idrCount["Name"]);
                            result.HouseCode = Convert.ToString(idrCount["HouseCode"]);
                            result.Person = Convert.ToString(idrCount["Person"]);
                            result.Cellphone = Convert.ToString(idrCount["Cellphone"]);
                            result.Remark = Convert.ToString(idrCount["Remark"]);
                            result.OP_DATE = Convert.ToDateTime(idrCount["OP_DATE"]);
                            result.SendTitle = Convert.ToString(idrCount["SendTitle"]);
                            result.PickTitle = Convert.ToString(idrCount["PickTitle"]);
                            result.DeliveryArea = Convert.ToString(idrCount["DeliveryArea"]);
                            result.CargoDepart = Convert.ToString(idrCount["CargoDepart"]);
                            result.DepCity = Convert.ToString(idrCount["DepCity"]);
                            result.Address = Convert.ToString(idrCount["Address"]);
                            result.BelongHouse = Convert.ToString(idrCount["BelongHouse"]);
                            result.BizUserId = Convert.ToString(idrCount["BizUserId"]);

                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        public List<CargoHouseEntity> BigDataQueryCargoHouse()
        {
            List<CargoHouseEntity> result = new List<CargoHouseEntity>();
            string strSQL = @"SELECT HouseID,Name,HouseCode,Address,Lng,Lat FROM Tbl_Cargo_House WHERE Lng is not null and Lat is not null";

            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            CargoHouseEntity data = new CargoHouseEntity();
                            data.HouseID = Convert.ToInt32(idrCount["HouseID"]);
                            data.Name = Convert.ToString(idrCount["Name"]);
                            data.HouseCode = Convert.ToString(idrCount["HouseCode"]);
                            data.Address = Convert.ToString(idrCount["Address"]);
                            data.Lng = Convert.ToString(idrCount["Lng"]);
                            data.Lat = Convert.ToString(idrCount["Lat"]);
                            result.Add(data);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 判断是否存在配送区域
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistDeliveryArea(CargoAreaEntity entity)
        {
            string strQ = @"select AreaID from Tbl_Cargo_Area where HouseID=@HouseID and ParentID=0 and DeliveryArea like '%" + entity.DeliveryArea + "%'";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 通过区域ID查询区域信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoAreaEntity QueryAreaByDeliveryArea(CargoAreaEntity entity)
        {
            CargoAreaEntity result = new CargoAreaEntity();
            string strSQL = @"select * from Tbl_Cargo_Area where HouseID=@HouseID and ParentID=0 and DeliveryArea like '%" + entity.DeliveryArea + "%'";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result = new CargoAreaEntity
                        {
                            AreaID = Convert.ToInt32(idr["AreaID"]),
                            Name = Convert.ToString(idr["Name"]),
                            Code = Convert.ToString(idr["Code"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            ParentID = Convert.ToInt32(idr["ParentID"]),
                            DeliveryArea = Convert.ToString(idr["DeliveryArea"]),
                            AreaType = Convert.ToString(idr["AreaType"]),
                            OrderCode = Convert.ToString(idr["OrderCode"]),
                            OrderDep = Convert.ToString(idr["OrderDep"]),
                            Remark = Convert.ToString(idr["Remark"])
                        };
                    }
                }

            }
            return result;

        }
        /// <summary>
        /// 查询区域
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoAreaEntity> QueryAreaListByDeliveryArea(CargoAreaEntity entity)
        {
            List<CargoAreaEntity> result = new List<CargoAreaEntity>();
            string strSQL = @"select * from Tbl_Cargo_Area where HouseID=@HouseID and ParentID=0 and DeliveryArea like '%" + entity.DeliveryArea + "%'";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoAreaEntity
                        {
                            AreaID = Convert.ToInt32(idr["AreaID"]),
                            Name = Convert.ToString(idr["Name"]),
                            Code = Convert.ToString(idr["Code"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            ParentID = Convert.ToInt32(idr["ParentID"]),
                            DeliveryArea = Convert.ToString(idr["DeliveryArea"]),
                            AreaType = Convert.ToString(idr["AreaType"]),
                            Remark = Convert.ToString(idr["Remark"])
                        });
                    }
                }

            }
            return result;
        }
        /// <summary>
        /// 查询慧采云仓小程序广告Banner数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public List<CargoBannerEntity> QueryHouseBannerList(CargoBannerEntity entity)
        {
            List<CargoBannerEntity> result = new List<CargoBannerEntity>();
            string strSQL = @"SELECT * FROM Tbl_Cargo_HouseBanner WHERE (1=1) ";
            if (!string.IsNullOrEmpty(entity.DelFlag)) { strSQL += " and DelFlag='" + entity.DelFlag + "'"; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and HouseID=" + entity.HouseID; }
            strSQL += " order by OPDATE desc";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoBannerEntity
                            {
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                BID = Convert.ToInt32(idrCount["BID"]),
                                PicName = Convert.ToString(idrCount["PicName"]),
                                Title = Convert.ToString(idrCount["Title"]),
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 判断是否同步开思
        /// </summary>
        /// <param name="HouseID"></param>
        /// <returns></returns>
        public string SyncTypeHouse(string HouseID)
        {
            string SyncType = "0";
            CargoHouseEntity result = new CargoHouseEntity();
            string strQ = @"Select HouseID,SyncType from Tbl_Cargo_House Where HouseID='" + HouseID + "'";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                using (DataTable dd = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        SyncType = Convert.ToString(idr["SyncType"]);
                    }
                }
            }
            return SyncType;
        }
        /// <summary>
        /// 开思同步产品信息    产品ID
        /// </summary>
        /// <param name="HouseID"></param>
        /// <returns></returns>
        public CargoProductEntity SyncTypeProduct(string ProductID)
        {
            CargoProductEntity result = new CargoProductEntity();
            if (string.IsNullOrEmpty(ProductID))
            {
                return result;
            }
            string strQ = @"Select a.HouseID,a.TypeID,a.ProductCode,a.GoodsCode,b.SyncType from Tbl_Cargo_Product AS a FULL JOIN Tbl_Cargo_House AS b ON a.HouseID = b.HouseID  Where ProductID='" + ProductID + "'";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                using (DataTable dd = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.HouseID = Convert.ToInt32(idr["HouseID"]);
                        result.TypeID = Convert.ToInt32(idr["TypeID"]);
                        result.ProductCode = Convert.ToString(idr["ProductCode"]);
                        result.GoodsCode = Convert.ToString(idr["GoodsCode"]);
                        result.SyncType = string.IsNullOrEmpty(Convert.ToString(idr["SyncType"])) ? "0" : Convert.ToString(idr["SyncType"]);
                    }
                }
            }
            return result;
        }

        /// <summary>
        /// 开思同步产品信息  订单号
        /// </summary>
        /// <param name="OrderNo"></param>
        /// <returns></returns>
        public List<CargoProductEntity> SyncTypeOrderNo(string OrderNo)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            if (string.IsNullOrEmpty(OrderNo))
            {
                return result;
            }
            string strQ = @"Select  DISTINCT a.HouseID,a.TypeID,a.ProductCode,a.GoodsCode,b.SyncType from Tbl_Cargo_Product AS a FULL JOIN Tbl_Cargo_House AS b ON a.HouseID = b.HouseID FULL JOIN Tbl_Cargo_OrderGoods AS c ON a.ProductID = c.ProductID where  OrderNo='" + OrderNo + "'";

            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                using (DataTable dd = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoProductEntity
                        {
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            ProductCode = Convert.ToString(idr["ProductCode"]),
                            GoodsCode = Convert.ToString(idr["GoodsCode"]),
                            SyncType = string.IsNullOrEmpty(Convert.ToString(idr["SyncType"])) ? "0" : Convert.ToString(idr["SyncType"]),
                        });

                    }
                }
            }
            return result;
        }

        /// <summary>
        /// 开思同步产品信息  移库单号
        /// </summary>
        /// <param name="MoveNo"></param>
        /// <returns></returns>
        public List<CargoProductEntity> SyncTypeMoveNo(string MoveNo)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            if (string.IsNullOrEmpty(MoveNo))
            {
                return result;
            }
            string strQ = @"Select  DISTINCT a.HouseID,a.TypeID,a.ProductCode,a.GoodsCode,b.SyncType from Tbl_Cargo_Product AS a FULL JOIN Tbl_Cargo_House AS b ON a.HouseID = b.HouseID FULL JOIN Tbl_Cargo_MoveOrderGood AS c ON a.ProductID = c.ProductID where  MoveNo='" + MoveNo + "'";

            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                using (DataTable dd = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoProductEntity
                        {
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            ProductCode = Convert.ToString(idr["ProductCode"]),
                            GoodsCode = Convert.ToString(idr["GoodsCode"]),
                            SyncType = string.IsNullOrEmpty(Convert.ToString(idr["SyncType"])) ? "0" : Convert.ToString(idr["SyncType"]),
                        });

                    }
                }
            }
            return result;
        }

        #endregion
        #region 区域管理操作方法集合
        /// <summary>
        /// 查询区域数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryCargoArea(int pIndex, int pNum, CargoAreaEntity entity)
        {
            List<CargoAreaEntity> result = new List<CargoAreaEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.*,b.Name as HouseName,c.Name as ParentName,d.Name as MainHouseName,ISNULL(d.AreaID,0) as MainHouseID FROM Tbl_Cargo_Area  as a left join Tbl_Cargo_House as b on a.HouseID=b.HouseID LEFT JOIN (select AreaID,Name,Code,ParentID from Tbl_Cargo_Area ) as c on a.ParentID=c.AreaID  LEFT JOIN (select AreaID,Name,Code from Tbl_Cargo_Area ) as d on c.ParentID=d.AreaID  WHERE (1=1)";
                //if (!entity.HouseID.Equals(0))
                //{
                //    strSQL += " and a.HouseID = " + entity.HouseID + "";
                //}
                if (!string.IsNullOrEmpty(entity.CargoPermisID))
                {
                    strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")";
                }
                if (!entity.ParentID.Equals(0))
                {
                    strSQL += " and a.ParentID = " + entity.ParentID + "";
                }
                //以名称为查询条件
                if (!string.IsNullOrEmpty(entity.Name))
                {
                    strSQL += " and a.Name like '%" + entity.Name + "%'";
                }
                if (!string.IsNullOrEmpty(entity.Code))
                {
                    strSQL += " and a.Code like '%" + entity.Code + "%'";
                }
                if (!string.IsNullOrEmpty(entity.DelFlag) && entity.DelFlag.Equals("0"))
                {
                    strSQL += " and (a.DelFlag=0 or a.DelFlag is null)";
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoAreaEntity
                            {
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ParentID = Convert.ToInt32(idr["ParentID"]),
                                Name = Convert.ToString(idr["Name"]),
                                Code = Convert.ToString(idr["Code"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                DeliveryArea = Convert.ToString(idr["DeliveryArea"]),
                                ParentName = Convert.ToString(idr["ParentName"]),
                                MainHouseName = Convert.ToString(idr["MainHouseName"]),
                                MainHouseID = Convert.ToInt32(idr["MainHouseID"]),
                                Longitude = Convert.ToString(idr["Longitude"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                Address = Convert.ToString(idr["Address"]),
                                OrderCode = Convert.ToString(idr["OrderCode"]),
                                OrderDep = Convert.ToString(idr["OrderDep"]),
                                DelFlag = Convert.ToString(idr["DelFlag"]),
                                LogisticName = Convert.ToString(idr["LogisticName"]),
                                LogisID = string.IsNullOrEmpty(Convert.ToString(idr["LogisID"])) ? 0 : Convert.ToInt32(idr["LogisID"]),
                                VirtualInventory = Convert.ToString(idr["VirtualInventory"]),
                                IsShowStock = Convert.ToString(idr["IsShowStock"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_Area as a Where (1=1)";
                //if (!entity.HouseID.Equals(0))
                //{
                //    strCount += " and a.HouseID = " + entity.HouseID + "";
                //}
                if (!string.IsNullOrEmpty(entity.CargoPermisID))
                {
                    strCount += " and a.HouseID in (" + entity.CargoPermisID + ")";
                }
                if (!entity.ParentID.Equals(0))
                {
                    strCount += " and a.ParentID = " + entity.ParentID + "";
                }
                //以名称为查询条件
                if (!string.IsNullOrEmpty(entity.Name))
                {
                    strCount += " and a.Name like '%" + entity.Name + "%'";
                }
                if (!string.IsNullOrEmpty(entity.Code))
                {
                    strCount += " and a.Code like '%" + entity.Code + "%'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 新增区域数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoArea(CargoAreaEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_Area(Name,Code,ParentID,Remark,HouseID,DeliveryArea,Longitude,Latitude,Address,OrderCode,OrderDep,LogisID,LogisticName,VirtualInventory,IsShowStock) VALUES (@Name,@Code,@ParentID,@Remark,@HouseID,@DeliveryArea,@Longitude,@Latitude,@Address,@OrderCode,@OrderDep,@LogisID,@LogisticName,@VirtualInventory,@IsShowStock)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@Name", DbType.String, entity.Name);
                    conn.AddInParameter(cmd, "@Code", DbType.String, entity.Code.ToUpper());
                    conn.AddInParameter(cmd, "@ParentID", DbType.Int32, entity.ParentID);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@DeliveryArea", DbType.String, entity.DeliveryArea);
                    conn.AddInParameter(cmd, "@Longitude", DbType.String, entity.Longitude);
                    conn.AddInParameter(cmd, "@Latitude", DbType.String, entity.Latitude);
                    conn.AddInParameter(cmd, "@Address", DbType.String, entity.Address);
                    conn.AddInParameter(cmd, "@OrderCode", DbType.String, entity.OrderCode);
                    conn.AddInParameter(cmd, "@OrderDep", DbType.String, entity.OrderDep);
                    conn.AddInParameter(cmd, "@LogisID", DbType.Int32, entity.LogisID);
                    conn.AddInParameter(cmd, "@LogisticName", DbType.String, entity.LogisticName);
                    conn.AddInParameter(cmd, "@VirtualInventory", DbType.String, entity.VirtualInventory);
                    conn.AddInParameter(cmd, "@IsShowStock", DbType.String, entity.IsShowStock);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改区域
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoArea(CargoAreaEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Area Set Name=@Name,Code=@Code,ParentID=@ParentID,Remark=@Remark,HouseID=@HouseID,OP_DATE=@OP_DATE,DeliveryArea=@DeliveryArea,Longitude=@Longitude,Latitude=@Latitude,Address=@Address,OrderCode=@OrderCode,OrderDep=@OrderDep,LogisID=@LogisID,LogisticName=@LogisticName,VirtualInventory=@VirtualInventory,IsShowStock=@IsShowStock Where AreaID=@AreaID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@Name", DbType.String, entity.Name);
                    conn.AddInParameter(cmd, "@Code", DbType.String, entity.Code.ToUpper());
                    conn.AddInParameter(cmd, "@ParentID", DbType.Int32, entity.ParentID);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@DeliveryArea", DbType.String, entity.DeliveryArea);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID);
                    conn.AddInParameter(cmd, "@Longitude", DbType.String, entity.Longitude);
                    conn.AddInParameter(cmd, "@Latitude", DbType.String, entity.Latitude);
                    conn.AddInParameter(cmd, "@Address", DbType.String, entity.Address);
                    conn.AddInParameter(cmd, "@OrderCode", DbType.String, entity.OrderCode);
                    conn.AddInParameter(cmd, "@OrderDep", DbType.String, entity.OrderDep);
                    conn.AddInParameter(cmd, "@LogisID", DbType.Int32, entity.LogisID);
                    conn.AddInParameter(cmd, "@LogisticName", DbType.String, entity.LogisticName);
                    conn.AddInParameter(cmd, "@VirtualInventory", DbType.String, entity.VirtualInventory);
                    conn.AddInParameter(cmd, "@IsShowStock", DbType.String, entity.IsShowStock);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 通过区域ID查询区域信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoAreaEntity QueryAreaByAreaID(CargoAreaEntity entity)
        {
            CargoAreaEntity result = new CargoAreaEntity();
            try
            {
                string strSQL = @"SELECT * from Tbl_Cargo_Area Where AreaID=@AreaID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result = new CargoAreaEntity
                            {
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                Name = Convert.ToString(idr["Name"]),
                                Code = Convert.ToString(idr["Code"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ParentID = Convert.ToInt32(idr["ParentID"]),
                                DeliveryArea = Convert.ToString(idr["DeliveryArea"]),
                                AreaType = Convert.ToString(idr["AreaType"]),
                                OrderCode = Convert.ToString(idr["OrderCode"]),
                                OrderDep = Convert.ToString(idr["OrderDep"]),
                                Longitude = Convert.ToString(idr["Longitude"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                Address = Convert.ToString(idr["Address"]),
                                LogisticName = Convert.ToString(idr["LogisticName"]),
                                LogisID = string.IsNullOrEmpty(Convert.ToString(idr["LogisID"])) ? 0 : Convert.ToInt32(idr["LogisID"]),
                                VirtualInventory = Convert.ToString(idr["VirtualInventory"]),
                                IsShowStock = Convert.ToString(idr["IsShowStock"]),
                                ContiHouseCode = Convert.ToString(idr["ContiHouseCode"]),
                                Remark = Convert.ToString(idr["Remark"])
                            };
                        }
                    }

                }
                return result;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public List<CargoAreaEntity> QueryAreaAll()
        {
            List<CargoAreaEntity> result = new List<CargoAreaEntity>();
            try
            {
                string strSQL = @"SELECT * from Tbl_Cargo_Area Where 1=1 ";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoAreaEntity
                            {
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                Name = Convert.ToString(idr["Name"]),
                                Code = Convert.ToString(idr["Code"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ParentID = Convert.ToInt32(idr["ParentID"]),
                                DeliveryArea = Convert.ToString(idr["DeliveryArea"]),
                                AreaType = Convert.ToString(idr["AreaType"]),
                                OrderCode = Convert.ToString(idr["OrderCode"]),
                                OrderDep = Convert.ToString(idr["OrderDep"]),
                                Longitude = Convert.ToString(idr["Longitude"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                Address = Convert.ToString(idr["Address"]),
                                LogisticName = Convert.ToString(idr["LogisticName"]),
                                LogisID = string.IsNullOrEmpty(Convert.ToString(idr["LogisID"])) ? 0 : Convert.ToInt32(idr["LogisID"]),
                                VirtualInventory = Convert.ToString(idr["VirtualInventory"]),
                                IsShowStock = Convert.ToString(idr["IsShowStock"]),
                                ContiHouseCode = Convert.ToString(idr["ContiHouseCode"]),
                                Remark = Convert.ToString(idr["Remark"])
                            });
                        }
                    }

                }
                return result;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 根据仓库区域ID查询该所区域所在的仓库
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoAreaEntity QueryHouseByAreaID(CargoAreaEntity entity)
        {
            CargoAreaEntity result = new CargoAreaEntity();
            string strSQL = @"select c.* From Tbl_Cargo_Area as a inner join Tbl_Cargo_Area as b on a.ParentID=b.AreaID inner join Tbl_Cargo_Area as c on b.ParentID=c.AreaID where a.AreaID=@AreaID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID);
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result = new CargoAreaEntity
                        {
                            AreaID = Convert.ToInt32(idr["AreaID"]),
                            Name = Convert.ToString(idr["Name"]),
                            Code = Convert.ToString(idr["Code"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            ParentID = Convert.ToInt32(idr["ParentID"]),
                            DeliveryArea = Convert.ToString(idr["DeliveryArea"]),
                            AreaType = Convert.ToString(idr["AreaType"]),
                            OrderCode = Convert.ToString(idr["OrderCode"]),
                            OrderDep = Convert.ToString(idr["OrderDep"]),
                            Longitude = Convert.ToString(idr["Longitude"]),
                            Latitude = Convert.ToString(idr["Latitude"]),
                            Address = Convert.ToString(idr["Address"]),
                            Remark = Convert.ToString(idr["Remark"])
                        };
                    }
                }
            }
            return result;
        }
        public CargoAreaEntity QueryHouseByDeliveryArea(CargoAreaEntity entity)
        {
            CargoAreaEntity result = new CargoAreaEntity();
            string strSQL = @" select top 1 * from Tbl_Cargo_Area where (1=1)";
            if (!entity.HouseID.Equals(0))
            {
                strSQL += " and HouseID=@HouseID";
            }
            if (!string.IsNullOrEmpty(entity.DeliveryArea))
            {
                strSQL += " and DeliveryArea like '%" + entity.DeliveryArea + "%'";
            }
            if (!string.IsNullOrEmpty(entity.ContiHouseCode))
            {
                strSQL += " and ContiHouseCode = '" + entity.ContiHouseCode + "'";
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                if (!entity.HouseID.Equals(0))
                {
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                }
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result = new CargoAreaEntity
                        {
                            AreaID = Convert.ToInt32(idr["AreaID"]),
                            Name = Convert.ToString(idr["Name"]),
                            Code = Convert.ToString(idr["Code"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            ParentID = Convert.ToInt32(idr["ParentID"]),
                            DeliveryArea = Convert.ToString(idr["DeliveryArea"]),
                            AreaType = Convert.ToString(idr["AreaType"]),
                            OrderCode = Convert.ToString(idr["OrderCode"]),
                            OrderDep = Convert.ToString(idr["OrderDep"]),
                            Longitude = Convert.ToString(idr["Longitude"]),
                            Latitude = Convert.ToString(idr["Latitude"]),
                            LogisID = string.IsNullOrEmpty(Convert.ToString(idr["LogisID"])) ? 0 : Convert.ToInt32(idr["LogisID"]),
                            ContiHouseCode = Convert.ToString(idr["ContiHouseCode"]),
                            Address = Convert.ToString(idr["Address"]),
                            Remark = Convert.ToString(idr["Remark"])
                        };
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 根据客户查询该客户的订单出库仓库顺序
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoAreaEntity> QueryOutHouseLevelList(CargoAreaEntity entity)
        {
            List<CargoAreaEntity> result = new List<CargoAreaEntity>();
            string strSQL = "select b.*,a.ClientNum,a.OrderLevel from Tbl_Cargo_HouseCityMapp as a inner join Tbl_Cargo_Area as b on a.AreaID=b.AreaID where (1=1)";
            if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum=" + entity.ClientNum; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID=" + entity.HouseID; }
            if (!entity.AreaID.Equals(0)) { strSQL += " and b.AreaID=" + entity.AreaID; }
            strSQL += " order by a.OrderLevel asc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoAreaEntity
                        {
                            AreaID = Convert.ToInt32(idr["AreaID"]),
                            Name = Convert.ToString(idr["Name"]),
                            Code = Convert.ToString(idr["Code"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            ParentID = Convert.ToInt32(idr["ParentID"]),
                            DeliveryArea = Convert.ToString(idr["DeliveryArea"]),
                            AreaType = Convert.ToString(idr["AreaType"]),
                            OrderCode = Convert.ToString(idr["OrderCode"]),
                            OrderDep = Convert.ToString(idr["OrderDep"]),
                            Longitude = Convert.ToString(idr["Longitude"]),
                            Latitude = Convert.ToString(idr["Latitude"]),
                            Address = Convert.ToString(idr["Address"]),
                            ClientNum = Convert.ToInt32(idr["ClientNum"]),
                            OrderLevel = Convert.ToInt32(idr["OrderLevel"]),
                            LogisID = string.IsNullOrEmpty(Convert.ToString(idr["LogisID"])) ? 0 : Convert.ToInt32(idr["LogisID"]),
                            LogisticName = Convert.ToString(idr["LogisticName"]),
                            Remark = Convert.ToString(idr["Remark"])
                        });
                    }
                }
            }
            return result;
        }

        /// <summary>
        /// 通过仓库ID和父ID查询区域
        /// </summary>
        /// <returns></returns>
        public List<CargoAreaEntity> QueryALLArea(CargoAreaEntity entity)
        {
            List<CargoAreaEntity> result = new List<CargoAreaEntity>();
            string strSQL = $@"SELECT AreaID,Name,Code,Longitude,Latitude,Address FROM Tbl_Cargo_Area WHERE (DelFlag=0 or DelFlag is null) 
            and HouseID in({(!string.IsNullOrEmpty(entity.ParamHouseID) ? entity.ParamHouseID : entity.HouseID.ToString())}) ";
            if (!entity.AreaID.Equals(0)) { strSQL += " and AreaID=@AreaID "; }
            if (!string.IsNullOrEmpty(entity.ParamParentID))
            {
                strSQL += $@" and ParentID in({entity.ParamParentID}) ";
            }
            else if (!entity.ParentID.Equals(-1))
            {
                strSQL += $@" and ParentID in({entity.ParentID}) ";
            }
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                  
                    if (!entity.AreaID.Equals(0)) { conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID); }
                    //if (!string.IsNullOrEmpty(entity.ParamHouseID))
                    //{
                    //    conn.AddInParameter(cmd, "@HouseID", DbType.String, entity.ParamHouseID);
                    //}
                    //else
                    //{
                    //    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    //}

                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoAreaEntity
                            {
                                AreaID = Convert.ToInt32(idrCount["AreaID"]),
                                Name = Convert.ToString(idrCount["Name"]),
                                Code = Convert.ToString(idrCount["Code"]),
                                Longitude = Convert.ToString(idrCount["Longitude"]),
                                Latitude = Convert.ToString(idrCount["Latitude"]),
                                Address = Convert.ToString(idrCount["Address"])
                            });
                        }
                    }

                }
            }
            catch (ApplicationException ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return result;
        }
        public List<CargoAreaEntity> QueryALLAreaRecur(CargoAreaEntity entity)
        {
            List<CargoAreaEntity> result = new List<CargoAreaEntity>();
            string strSQL = @"SELECT AreaID,Name,Code,Longitude,Latitude,Address From Tbl_Cargo_Area where ParentID in (select AreaID From Tbl_Cargo_Area where HouseID=@HouseID and ParentID=@ParentID) ";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ParentID", DbType.Int32, entity.ParentID);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoAreaEntity
                            {
                                AreaID = Convert.ToInt32(idrCount["AreaID"]),
                                Name = Convert.ToString(idrCount["Name"]),
                                Code = Convert.ToString(idrCount["Code"]),
                                Longitude = Convert.ToString(idrCount["Longitude"]),
                                Latitude = Convert.ToString(idrCount["Latitude"]),
                                Address = Convert.ToString(idrCount["Address"])
                            });
                        }
                    }

                }
            }
            catch (ApplicationException ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return result;
        }
        /// <summary>
        /// 删除区域
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoArea(List<CargoAreaEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_Area where AreaID=@AreaID ";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@AreaID", DbType.Int32, it.AreaID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void UpdateCargoAreaType(List<CargoAreaEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"UPDATE Tbl_Cargo_Area SET DelFlag=@DelFlag,OP_DATE=@OP_DATE WHERE AreaID=@AreaID ";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@AreaID", DbType.Int32, it.AreaID);
                        conn.AddInParameter(cmd, "@DelFlag", DbType.Int32, it.DelFlag);
                        conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 判断是否存在相同的区域代码
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistCargoAreaCode(CargoAreaEntity entity)
        {
            string strQ = @"Select Name from Tbl_Cargo_Area Where Code=@Code and HouseID=@HouseID";
            if (!entity.ParentID.Equals(0)) { strQ += " and ParentID=@ParentID"; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@Code", DbType.String, entity.Code);
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                if (!entity.ParentID.Equals(0)) { conn.AddInParameter(cmdQ, "@ParentID", DbType.Int32, entity.ParentID); }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 判断是否存在相同的订单代码
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistCargoOrderCode(CargoAreaEntity entity)
        {
            string strQ = @"Select Name from Tbl_Cargo_Area Where OrderCode=@OrderCode and HouseID=@HouseID";
            if (!entity.ParentID.Equals(0)) { strQ += " and ParentID=@ParentID"; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@OrderCode", DbType.String, entity.OrderCode);
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                if (!entity.ParentID.Equals(0)) { conn.AddInParameter(cmdQ, "@ParentID", DbType.Int32, entity.ParentID); }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 该区域下是否存在货位
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistCargoContainerArea(CargoAreaEntity entity)
        {
            string strQ = @"select a.AreaID,a.Name from Tbl_Cargo_Area as a inner join Tbl_Cargo_OrderGoods as b on a.AreaID=b.AreaID Where a.Code=@Code and a.HouseID=@HouseID";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@Code", DbType.String, entity.Code);
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;

        }
        public List<CargoContainerStarEntity> QueryAreaContainer(CargoAreaEntity entity)
        {
            List<CargoContainerStarEntity> result = new List<CargoContainerStarEntity>();
            string strSQL = @"SELECT * FROM Tbl_Cargo_Container WHERE AreaID in(Select AreaID from Tbl_Cargo_Area where ParentID=@ParentID and HouseID=@HouseID) ";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ParentID", DbType.Int32, entity.ParentID);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoContainerStarEntity
                            {
                                ContainerID = Convert.ToInt32(idrCount["ContainerID"]),
                            });
                        }
                    }

                }
            }
            catch (Exception ex)
            {

            }
            return result;


        }
        #endregion
        #region 货位管理操作方法集合
        /// <summary>
        /// 根据仓库ID查询货位ID
        /// </summary>
        /// <remarks>
        ///  备注：查询第一条ContainerType='VIR'，有则取该货位号ContainerID。为空则倒序取第一条数据的货位号
        /// </remarks>
        /// <param name="houseId"></param>
        public int QueryCargoContainerGoodsContainerID(int houseId)
        {
            int result = 0;
            try
            {
                //1. 查询第一条ContainerType='VIR'，有则取该货位号ContainerID
                string strSQL = @"select ContainerID,a.AreaID,ContainerCode from Tbl_Cargo_Container c inner join Tbl_Cargo_Area a on c.AreaID=a.AreaID where a.HouseID=@HouseID and c.ContainerType='VIR'  order by c.OP_DATE desc";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@HouseID", DbType.Int32, houseId);
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        if (dd.Rows.Count > 0) { result = Convert.ToInt32(dd.Rows[0]["ContainerID"]); }
                    }
                }
                if (result <= 0)
                {
                    //2. 为空则倒序取第一条数据的货位号
                    strSQL = @"select top 1 ContainerID,a.AreaID,ContainerCode from Tbl_Cargo_Container  c Inner Join Tbl_Cargo_Area as a ON  c.AreaId = a.AreaId where a.HouseID=@HouseID
order by c.OP_DATE desc";
                    using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(command, "@HouseID", DbType.Int32, houseId);
                        using (DataTable dd = conn.ExecuteDataTable(command))
                        {
                            if (dd.Rows.Count > 0) { result = Convert.ToInt32(dd.Rows[0]["ContainerID"]); }
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 货位查询
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryCargoContainer(int pIndex, int pNum, CargoContainerEntity entity)
        {
            List<CargoContainerEntity> result = new List<CargoContainerEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.*,(a.MaxPiece-a.InPiece) as allowPiece,b.Name,b.Code,b.HouseID,b.ParentID,c.Name as HouseName from Tbl_Cargo_Container a left join Tbl_Cargo_Area as b on a.AreaID=b.AreaID ";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " left join Tbl_Cargo_Area as e on b.ParentID=e.AreaID left join Tbl_Cargo_Area as f on e.ParentID=f.AreaID ";
                }
                strSQL += " left join Tbl_Cargo_House as c on b.HouseID=c.HouseID WHERE (1=1)";
                //if (!entity.HouseID.Equals(0))
                //{
                //    strSQL += " and b.HouseID = " + entity.HouseID + "";
                //}
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " and f.AreaID = " + entity.FirstAreaID + "";
                }
                if (!entity.ParentID.Equals(0))
                {
                    strSQL += " and e.AreaID = " + entity.ParentID + "";
                }
                if (!string.IsNullOrEmpty(entity.CargoPermisID))
                {
                    strSQL += " and b.HouseID in (" + entity.CargoPermisID + ")";
                }
                if (!entity.AreaID.Equals(0))
                {
                    strSQL += " and a.AreaID = " + entity.AreaID + "";
                }

                //以货位代码为查询条件
                if (!string.IsNullOrEmpty(entity.ContainerCode))
                {
                    strSQL += " and a.ContainerCode like '%" + entity.ContainerCode + "%'";
                }
                if (!string.IsNullOrEmpty(entity.ContainerType))
                {
                    strSQL += " and a.ContainerType = '" + entity.ContainerType + "'";
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            CargoAreaEntity cargoArea = new CargoAreaEntity();
                            CargoAreaEntity hArea = new CargoAreaEntity();
                            //如果父ID不为0，则查询父ID的区域名称
                            if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            {
                                cargoArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                                if (!cargoArea.ParentID.Equals(0))
                                {
                                    hArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                                }
                            }
                            //货位星级排序数据
                            List<CargoContainerStarEntity> goodsList = QueryCargoContainerStar(new CargoContainerStarEntity { ContainerID = Convert.ToInt32(idr["ContainerID"]) });
                            string EmOrder = string.Empty;
                            string EmOrderID = string.Empty;
                            if (goodsList.Count > 0)
                            {
                                foreach (var good in goodsList)
                                {
                                    EmOrderID += good.TypeID + ",";
                                    EmOrder += good.TypeName + ",";
                                }
                            }
                            result.Add(new CargoContainerEntity
                            {
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ContainerNum = Convert.ToInt32(idr["ContainerNum"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                AreaName = Convert.ToString(idr["Name"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                allowPiece = Convert.ToInt32(idr["allowPiece"]),
                                MaxPiece = Convert.ToInt32(idr["MaxPiece"]),
                                WarnPiece = Convert.ToInt32(idr["WarnPiece"]),
                                MaxVolume = Convert.ToDecimal(idr["MaxVolume"]),
                                MaxWeight = Convert.ToDecimal(idr["MaxWeight"]),
                                InPiece = Convert.ToInt32(idr["InPiece"]),
                                //Star = Convert.ToInt32(idr["Star"]),
                                FirstAreaID = hArea.AreaID,
                                FirstAreaName = hArea.Name,
                                ParentID = cargoArea.AreaID,
                                ParentName = cargoArea.Name,
                                ContainerGoodsList = goodsList,
                                EmOrder = goodsList.Count > 0 ? EmOrder.Substring(0, EmOrder.Length - 1) : EmOrder,
                                EmOrderID = goodsList.Count > 0 ? EmOrderID.Substring(0, EmOrderID.Length - 1) : EmOrderID,
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_Container a left join Tbl_Cargo_Area as b on a.AreaID=b.AreaID";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strCount += " left join Tbl_Cargo_Area as e on b.ParentID=e.AreaID left join Tbl_Cargo_Area as f on e.ParentID=f.AreaID ";
                }
                strCount += " left join Tbl_Cargo_House as c on b.HouseID=c.HouseID Where (1=1)";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strCount += " and f.AreaID = " + entity.FirstAreaID + "";
                }
                if (!entity.ParentID.Equals(0))
                {
                    strCount += " and e.AreaID = " + entity.ParentID + "";
                }
                //if (!entity.HouseID.Equals(0))
                //{
                //    strCount += " and b.HouseID = " + entity.HouseID + "";
                //}
                if (!string.IsNullOrEmpty(entity.CargoPermisID))
                {
                    strCount += " and b.HouseID in (" + entity.CargoPermisID + ")";
                }
                if (!entity.AreaID.Equals(0))
                {
                    strSQL += " and a.AreaID = " + entity.AreaID + "";
                }
                //以货位代码为查询条件
                if (!string.IsNullOrEmpty(entity.ContainerCode))
                {
                    strCount += " and a.ContainerCode like '%" + entity.ContainerCode + "%'";
                }
                if (!string.IsNullOrEmpty(entity.ContainerType))
                {
                    strCount += " and a.ContainerType = '" + entity.ContainerType + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 新增货位数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoContainer(CargoContainerEntity entity)
        {
            int did = 0;
            string strSQL = @"INSERT INTO Tbl_Cargo_Container(ContainerCode,ContainerNum,ContainerType,AreaID,MaxPiece,MaxWeight,MaxVolume,WarnPiece,Remark) VALUES (@ContainerCode,@ContainerNum,@ContainerType,@AreaID,@MaxPiece,@MaxWeight,@MaxVolume,@WarnPiece,@Remark) SELECT @@IDENTITY";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    conn.AddInParameter(cmd, "@ContainerType", DbType.String, entity.ContainerType);
                    conn.AddInParameter(cmd, "@ContainerNum", DbType.Int32, entity.ContainerNum);
                    conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID);
                    conn.AddInParameter(cmd, "@MaxPiece", DbType.Int32, entity.MaxPiece);
                    conn.AddInParameter(cmd, "@WarnPiece", DbType.Int32, entity.WarnPiece);
                    conn.AddInParameter(cmd, "@MaxWeight", DbType.Decimal, entity.MaxWeight);
                    conn.AddInParameter(cmd, "@MaxVolume", DbType.Decimal, entity.MaxVolume);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    //conn.ExecuteNonQuery(cmd);
                    did = Convert.ToInt32(conn.ExecuteScalar(cmd));
                }
                foreach (var it in entity.ContainerGoodsList)
                {
                    AddCargoContainerStar(new CargoContainerStarEntity
                    {
                        ContainerID = did,
                        TypeID = it.TypeID,
                        Star = it.Star
                    });
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改货位 
        /// </summary>
        /// <param name="entity"></param> 
        public void UpdateCargoContainer(CargoContainerEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Container SET ContainerCode=@ContainerCode,ContainerNum=@ContainerNum,ContainerType=@ContainerType,AreaID=@AreaID,MaxPiece=@MaxPiece,MaxWeight=@MaxWeight,MaxVolume=@MaxVolume,WarnPiece=@WarnPiece,Remark=@Remark WHERE ContainerID=@ContainerID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    conn.AddInParameter(cmd, "@ContainerNum", DbType.Int32, entity.ContainerNum);
                    conn.AddInParameter(cmd, "@ContainerType", DbType.String, entity.ContainerType);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID);
                    conn.AddInParameter(cmd, "@MaxPiece", DbType.Int32, entity.MaxPiece);
                    conn.AddInParameter(cmd, "@WarnPiece", DbType.Int32, entity.WarnPiece);
                    conn.AddInParameter(cmd, "@MaxWeight", DbType.Decimal, entity.MaxWeight);
                    conn.AddInParameter(cmd, "@MaxVolume", DbType.Decimal, entity.MaxVolume);
                    conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, entity.ContainerID);
                    conn.ExecuteNonQuery(cmd);
                }

                //2.删除货位星级排序数据
                DelCargoContainerStar(new CargoContainerStarEntity { ContainerID = entity.ContainerID });
                //3.增加货位星级排序数据
                foreach (var it in entity.ContainerGoodsList)
                {
                    AddCargoContainerStar(new CargoContainerStarEntity
                    {
                        ContainerID = entity.ContainerID,
                        TypeID = it.TypeID,
                        Star = it.Star
                    });
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 根据货位类型返回该货位类型的最大货位号
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public int ReturnContainerNum(CargoContainerEntity entity)
        {
            int result = 0;
            string strQ = @"SELECT ISNULL(MAX(a.ContainerNum),0) as ContainerNum from Tbl_Cargo_Container as a 
left join Tbl_Cargo_Area as b on a.AreaID=b.AreaID where a.ContainerType=@ContainerType and b.HouseID=@HouseID";
            if (!entity.AreaID.Equals(0))
            {
                strQ += " and a.AreaID=@AreaID";
            }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ContainerType", DbType.String, entity.ContainerType);
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                if (!entity.AreaID.Equals(0))
                {
                    conn.AddInParameter(cmdQ, "@AreaID", DbType.Int32, entity.AreaID);
                }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    result = Convert.ToInt32(idr.Rows[0]["ContainerNum"]) + 1;
                }
            }
            return result;
        }
        /// <summary>
        /// 判断是否存在相同的货位代码
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistCargoContainerCode(CargoContainerEntity entity)
        {
            string strQ = @"Select a.ContainerCode from Tbl_Cargo_Container as a left join Tbl_Cargo_Area as b on a.AreaID=b.AreaID Where ContainerCode=@ContainerCode";
            if (!entity.HouseID.Equals(0)) { strQ += " and b.HouseID=" + entity.HouseID + ""; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ContainerCode", DbType.String, entity.ContainerCode);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 判断是否存在订单下的货位号码
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistOrderContainerCode(CargoContainerEntity entity)
        {
            string strQ = @"Select ContainerCode from Tbl_Cargo_OrderGoods Where ContainerCode=@ContainerCode and HouseID=" + entity.HouseID + "";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ContainerCode", DbType.String, entity.ContainerCode);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 判断该货位下是否存在库存
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistContainerGood(CargoContainerEntity entity)
        {
            string strQ = @"Select ID from Tbl_Cargo_ContainerGoods Where ContainerID=@ContainerID";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ContainerID", DbType.Int32, entity.ContainerID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 删除货位
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoContainer(List<CargoContainerEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_Container where ContainerID=@ContainerID ";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, it.ContainerID);
                        conn.ExecuteNonQuery(cmd);
                    }
                    //删除货位星级排序数据
                    DelCargoContainerStar(new CargoContainerStarEntity { ContainerID = it.ContainerID });
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 通过产品类型查询货位，按星级排序
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerEntity> QueryContainerByType(CargoContainerEntity entity)
        {
            List<CargoContainerEntity> result = new List<CargoContainerEntity>();
            try
            {
                string strSQL = @"select a.Star,a.TypeID, (b.MaxPiece-b.InPiece) as allowPiece,b.*,c.Name,c.Code,c.HouseID,c.ParentID,d.Name as HouseName from Tbl_Cargo_ContainerStar as a left join Tbl_Cargo_Container as b on a.ContainerID=b.ContainerID left join Tbl_Cargo_Area as c on b.AreaID=c.AreaID ";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " left join Tbl_Cargo_Area as e on c.ParentID=e.AreaID left join Tbl_Cargo_Area as f on e.ParentID=f.AreaID ";
                }
                strSQL += " left join Tbl_Cargo_House as d on c.HouseID=d.HouseID where (1=1) ";
                if (!entity.FirstAreaID.Equals(0)) { strSQL += " and f.AreaID = " + entity.FirstAreaID + ""; }
                if (!entity.ParentID.Equals(0)) { strSQL += " and e.AreaID = " + entity.ParentID + ""; }
                if (!entity.AreaID.Equals(0)) { strSQL += " and b.AreaID = " + entity.AreaID + ""; }
                if (!entity.Star.Equals(0)) { strSQL += " and a.Star = " + entity.Star + ""; }//星级
                if (!entity.HouseID.Equals(0)) { strSQL += " and d.HouseID = " + entity.HouseID + ""; }
                //if (!entity.AreaID.Equals(0)) { strSQL += " and b.AreaID = " + entity.AreaID + ""; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID = " + entity.TypeID + ""; }
                //以货位代码为查询条件
                if (!string.IsNullOrEmpty(entity.ContainerCode))
                {
                    strSQL += " and b.ContainerCode like '%" + entity.ContainerCode + "%'";
                }
                if (!string.IsNullOrEmpty(entity.ContainerType))
                {
                    strSQL += " and b.ContainerType = '" + entity.ContainerType + "'";
                }
                strSQL += " order by Star desc,InPiece asc,(b.MaxPiece-b.InPiece) desc";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            if (Convert.ToInt32(idr["allowPiece"]) <= 0) { continue; }
                            CargoAreaEntity cargoArea = new CargoAreaEntity();
                            CargoAreaEntity hArea = new CargoAreaEntity();
                            //如果父ID不为0，则查询父ID的区域名称
                            if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            {
                                cargoArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                                if (!cargoArea.ParentID.Equals(0))
                                {
                                    hArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                                }
                            }
                            result.Add(new CargoContainerEntity
                            {
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ContainerNum = Convert.ToInt32(idr["ContainerNum"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                AreaName = Convert.ToString(idr["Name"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                MaxPiece = Convert.ToInt32(idr["MaxPiece"]),
                                WarnPiece = Convert.ToInt32(idr["WarnPiece"]),
                                MaxVolume = Convert.ToDecimal(idr["MaxVolume"]),
                                MaxWeight = Convert.ToDecimal(idr["MaxWeight"]),
                                InPiece = Convert.ToInt32(idr["InPiece"]),
                                FirstAreaID = hArea.AreaID,
                                FirstAreaName = hArea.Name,
                                ParentID = cargoArea.AreaID,
                                ParentName = cargoArea.Name,
                                allowPiece = Convert.ToInt32(idr["allowPiece"]),
                                Star = Convert.ToInt32(idr["Star"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 修改货位上的件数
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateContainerInPiece(CargoContainerEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Container Set ";
            if (entity.IsAdd) { strSQL += " InPiece=InPiece+@InPiece"; }
            else { strSQL += " InPiece=InPiece-@InPiece"; }
            strSQL += " Where ContainerID=@ContainerID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, entity.ContainerID);
                    conn.AddInParameter(cmd, "@InPiece", DbType.Int32, entity.InPiece);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 查询货位数据实体
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoContainerEntity QueryContainerEntity(CargoContainerEntity entity)
        {
            CargoContainerEntity result = new CargoContainerEntity();
            try
            {
                string strSQL = @"select (a.MaxPiece-a.InPiece) as allowPiece, a.*,b.HouseID from Tbl_Cargo_Container as a inner join Tbl_Cargo_Area as b on a.AreaID=b.AreaID where (1=1) ";
                if (!entity.ContainerID.Equals(0)) { strSQL += " and a.ContainerID = " + entity.ContainerID + ""; }
                if (!entity.AreaID.Equals(0)) { strSQL += " and a.AreaID = " + entity.AreaID + ""; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID = " + entity.HouseID + ""; }
                //以货位代码为查询条件
                if (!string.IsNullOrEmpty(entity.ContainerCode))
                {
                    strSQL += " and a.ContainerCode like '%" + entity.ContainerCode + "%'";
                }
                if (!string.IsNullOrEmpty(entity.ContainerType))
                {
                    strSQL += " and a.ContainerType = '" + entity.ContainerType + "'";
                }
                strSQL += " order by a.InPiece asc,(a.MaxPiece-a.InPiece) desc";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.ContainerID = Convert.ToInt32(idr["ContainerID"]);
                            result.ContainerCode = Convert.ToString(idr["ContainerCode"]);
                            result.AreaID = Convert.ToInt32(idr["AreaID"]);
                            result.HouseID = Convert.ToInt32(idr["HouseID"]);
                            result.ContainerNum = Convert.ToInt32(idr["ContainerNum"]);
                            result.ContainerType = Convert.ToString(idr["ContainerType"]);
                            result.Remark = Convert.ToString(idr["Remark"]);
                            result.MaxPiece = Convert.ToInt32(idr["MaxPiece"]);
                            result.WarnPiece = Convert.ToInt32(idr["WarnPiece"]);
                            result.MaxVolume = Convert.ToDecimal(idr["MaxVolume"]);
                            result.MaxWeight = Convert.ToDecimal(idr["MaxWeight"]);
                            result.InPiece = Convert.ToInt32(idr["InPiece"]);
                            result.allowPiece = Convert.ToInt32(idr["allowPiece"]);
                            result.OP_DATE = Convert.ToDateTime(idr["OP_DATE"]);

                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 根据货位代码查询货位数据
        /// </summary>
        /// <param name="containerCode"></param>
        /// <returns></returns>
        public CargoContainerEntity QueryContainerEntityByCode(string containerCode, int HouseID)
        {
            CargoContainerEntity result = new CargoContainerEntity();
            try
            {
                string strSQL = @"select (a.MaxPiece-a.InPiece) as allowPiece, a.*,b.HouseID from Tbl_Cargo_Container as a left join Tbl_Cargo_Area as b on a.AreaID=b.AreaID where ContainerCode=@ContainerCode and b.HouseID=@HouseID ";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@ContainerCode", DbType.String, containerCode);
                    conn.AddInParameter(command, "@HouseID", DbType.Int32, HouseID);
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.ContainerID = Convert.ToInt32(idr["ContainerID"]);
                            result.ContainerCode = Convert.ToString(idr["ContainerCode"]);
                            result.AreaID = Convert.ToInt32(idr["AreaID"]);
                            result.ContainerNum = Convert.ToInt32(idr["ContainerNum"]);
                            result.ContainerType = Convert.ToString(idr["ContainerType"]);
                            result.Remark = Convert.ToString(idr["Remark"]);
                            result.MaxPiece = Convert.ToInt32(idr["MaxPiece"]);
                            result.WarnPiece = Convert.ToInt32(idr["WarnPiece"]);
                            result.MaxVolume = Convert.ToDecimal(idr["MaxVolume"]);
                            result.MaxWeight = Convert.ToDecimal(idr["MaxWeight"]);
                            result.InPiece = Convert.ToInt32(idr["InPiece"]);
                            result.allowPiece = Convert.ToInt32(idr["allowPiece"]);
                            result.OP_DATE = Convert.ToDateTime(idr["OP_DATE"]);
                            result.HouseID = Convert.ToInt32(idr["HouseID"]);

                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 根据区域ID查询该 区域 下的所有货位数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerEntity> QueryContainerByAreaID(CargoContainerEntity entity)
        {
            List<CargoContainerEntity> result = new List<CargoContainerEntity>();

            string strSQL = "select a.* From Tbl_Cargo_Container as a inner join Tbl_Cargo_Area as b on a.AreaID=b.AreaID where (1=1)";
            if (!entity.ParentID.Equals(0))
            {
                strSQL += " and b.ParentID=" + entity.ParentID + "";
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoContainerEntity
                        {
                            ContainerID = Convert.ToInt32(idr["ContainerID"]),
                            AreaID = Convert.ToInt32(idr["AreaID"]),
                            ContainerNum = Convert.ToInt32(idr["ContainerNum"]),
                            ContainerCode = Convert.ToString(idr["ContainerCode"]),
                            ContainerType = Convert.ToString(idr["ContainerType"]),
                            Remark = Convert.ToString(idr["Remark"]),
                            MaxPiece = Convert.ToInt32(idr["MaxPiece"]),
                            WarnPiece = Convert.ToInt32(idr["WarnPiece"]),
                            MaxVolume = Convert.ToDecimal(idr["MaxVolume"]),
                            MaxWeight = Convert.ToDecimal(idr["MaxWeight"]),
                            InPiece = Convert.ToInt32(idr["InPiece"])
                        });
                    }
                }
            }
            return result;
        }

        /// <summary>
        /// 根据类型ID、规格、花纹、载重指数、速度指数、订单年、订单月
        /// </summary>
        /// <param name="HouseID">仓库ID</param>
        /// <param name="TypeID">类型ID</param>
        /// <param name="Specs">规格</param>
        /// <param name="Figure">花纹</param>
        /// <param name="LoadIndex">载重指数</param>
        /// <param name="SpeedLevel">速度指数</param>
        /// <param name="ProYear">订单年</param>
        /// <param name="ProMonth">订单月</param>
        /// <returns></returns>
        public CargoProductBasicPriceEntity QueryProductBasicPrice(CargoProductBasicPriceEntity entity)

        //public CargoProductBasicPriceEntity QueryProductBasicPrice(int HouseID, int TypeID, string Born, string Assort, string GoodsCode, string Specs, string Figure, string LoadIndex, string SpeedLevel, string ProYear, string ProMonth)
        {
            CargoProductBasicPriceEntity result = new CargoProductBasicPriceEntity();
            try
            {
                string strSQL = @"select * from Tbl_Cargo_ProductBasicPrice a where 1=1 ";
                if (entity.HouseID != -1)
                {
                    strSQL += @" and a.HouseID=@HouseID";
                }
                if (entity.TypeID != -1)
                {
                    strSQL += @" and a.TypeID=@TypeID";
                }
                if (entity.Born != -1)
                {
                    strSQL += @" and a.Born=@Born";
                }
                if (!string.IsNullOrEmpty(entity.Assort))
                {
                    strSQL += @" and a.Assort=@Assort";
                }
                if (!string.IsNullOrEmpty(entity.GoodsCode))
                {
                    strSQL += @" and a.GoodsCode=@GoodsCode";
                }
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    strSQL += @" and a.Specs=@Specs";
                }
                if (!string.IsNullOrEmpty(entity.Figure))
                {
                    strSQL += @" and a.Figure=@Figure";
                }
                if (!string.IsNullOrEmpty(entity.LoadIndex))
                {
                    strSQL += @" and a.LoadIndex=@LoadIndex";
                }
                if (!string.IsNullOrEmpty(entity.SpeedLevel))
                {
                    strSQL += @" and a.SpeedLevel=@SpeedLevel";
                }
                if (!string.IsNullOrEmpty(entity.ProYear))
                {
                    strSQL += @" and a.ProYear=@ProYear";
                }
                if (!string.IsNullOrEmpty(entity.ProMonth))
                {
                    strSQL += @" and a.ProMonth=@ProMonth";
                }
                if (!string.IsNullOrEmpty(entity.ProductCode))
                {
                    strSQL += @" and a.ProductCode=@ProductCode";
                }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    if (entity.HouseID != -1)
                    {
                        conn.AddInParameter(command, "@HouseID", DbType.Int32, entity.HouseID);
                    }
                    if (entity.TypeID != -1)
                    {
                        conn.AddInParameter(command, "@TypeID", DbType.Int32, entity.TypeID);
                    }
                    if (entity.Born != -1)
                    {
                        conn.AddInParameter(command, "@Born", DbType.Int32, entity.Born);
                    }
                    if (!string.IsNullOrEmpty(entity.Assort))
                    {
                        conn.AddInParameter(command, "@Assort", DbType.String, entity.Assort);
                    }
                    if (!string.IsNullOrEmpty(entity.GoodsCode))
                    {
                        conn.AddInParameter(command, "@GoodsCode", DbType.String, entity.GoodsCode);
                    }
                    if (!string.IsNullOrEmpty(entity.Specs))
                    {
                        conn.AddInParameter(command, "@Specs", DbType.String, entity.Specs);
                    }
                    if (!string.IsNullOrEmpty(entity.Figure))
                    {
                        conn.AddInParameter(command, "@Figure", DbType.String, entity.Figure);
                    }
                    if (!string.IsNullOrEmpty(entity.LoadIndex))
                    {
                        conn.AddInParameter(command, "@LoadIndex", DbType.String, entity.LoadIndex);
                    }
                    if (!string.IsNullOrEmpty(entity.SpeedLevel))
                    {
                        conn.AddInParameter(command, "@SpeedLevel", DbType.String, entity.SpeedLevel);
                    }
                    if (!string.IsNullOrEmpty(entity.ProYear))
                    {
                        conn.AddInParameter(command, "@ProYear", DbType.String, entity.ProYear);
                    }
                    if (!string.IsNullOrEmpty(entity.ProMonth))
                    {
                        conn.AddInParameter(command, "@ProMonth", DbType.String, entity.ProMonth);
                    }
                    if (!string.IsNullOrEmpty(entity.ProductCode))
                    {
                        conn.AddInParameter(command, "@ProductCode", DbType.String, entity.ProductCode);
                    }
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.PID = Convert.ToInt64(idr["PID"]);
                            result.TypeID = Convert.ToInt32(idr["TypeID"]);
                            result.Born = Convert.ToInt32(idr["Born"]);
                            result.Assort = Convert.ToString(idr["Assort"]);
                            result.Model = Convert.ToString(idr["Model"]);
                            result.GoodsCode = Convert.ToString(idr["GoodsCode"]);
                            result.Specs = Convert.ToString(idr["Specs"]);
                            result.Figure = Convert.ToString(idr["Figure"]);
                            result.LoadIndex = Convert.ToString(idr["LoadIndex"]);
                            result.SpeedLevel = Convert.ToString(idr["SpeedLevel"]);
                            result.HubDiameter = Convert.ToString(idr["HubDiameter"]);
                            result.ProYear = Convert.ToString(idr["ProYear"]);
                            result.ProMonth = Convert.ToString(idr["ProMonth"]);
                            result.ProQuarter = Convert.ToInt32(idr["ProQuarter"]);
                            result.UnitPrice = Convert.ToDouble(idr["UnitPrice"]);//单价
                            result.TradePrice = Convert.ToDouble(idr["TradePrice"]);//门店价
                            result.FinalCostPrice = Convert.ToDouble(idr["FinalCostPrice"]);//最终成本价
                            result.PreCostPrice = Convert.ToDouble(idr["PreCostPrice"]);//上一年最终成本价
                            result.CostPrice = Convert.ToDouble(idr["CostPrice"]);//成本价
                            result.TaxCostPrice = Convert.ToDouble(idr["TaxCostPrice"]);//含税成本价
                            result.NoTaxCostPrice = Convert.ToDouble(idr["NoTaxCostPrice"]);//不含税成本价
                            result.NextDayPrice = Convert.ToDouble(idr["NextDayPrice"]);//次日达价

                            result.InHousePrice = Convert.ToDouble(idr["InHousePrice"]);//进仓价
                            result.SalePrice = Convert.ToDouble(idr["SalePrice"]);//小程序价
                            result.OESalePrice = Convert.ToDouble(idr["OESalePrice"]);//OE销售价
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public CargoContainerEntity QueryTopOneContainer(CargoContainerEntity entity)
        {
            CargoContainerEntity result = new CargoContainerEntity();
            try
            {
                string strSQL = @"select top 1 d.*,a.Name as AreaName from Tbl_Cargo_Area a inner join Tbl_Cargo_Area b on b.ParentID=a.AreaID inner join Tbl_Cargo_Area c on c.ParentID=b.AreaID inner join Tbl_Cargo_Container d on d.AreaID=c.AreaID where (a.DelFlag is null or a.DelFlag=0) ";
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID= " + entity.HouseID; }
                if (!entity.FirstAreaID.Equals(0)) { strSQL += " and a.AreaID=" + entity.FirstAreaID; }
                strSQL += " order by OP_DATE asc";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.AreaName = Convert.ToString(idr["AreaName"]);
                            result.ContainerID = Convert.ToInt32(idr["ContainerID"]);
                            result.ContainerCode = Convert.ToString(idr["ContainerCode"]);
                            result.AreaID = Convert.ToInt32(idr["AreaID"]);
                            result.ContainerNum = Convert.ToInt32(idr["ContainerNum"]);
                            result.ContainerType = Convert.ToString(idr["ContainerType"]);
                            result.Remark = Convert.ToString(idr["Remark"]);
                            result.MaxPiece = Convert.ToInt32(idr["MaxPiece"]);
                            result.WarnPiece = Convert.ToInt32(idr["WarnPiece"]);
                            result.MaxVolume = Convert.ToDecimal(idr["MaxVolume"]);
                            result.MaxWeight = Convert.ToDecimal(idr["MaxWeight"]);
                            result.InPiece = Convert.ToInt32(idr["InPiece"]);
                            result.OP_DATE = Convert.ToDateTime(idr["OP_DATE"]);

                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        #endregion
        #region 货位与星级操作方法集合
        /// <summary>
        /// 保存货位星级数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoContainerStar(CargoContainerStarEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_ContainerStar(ContainerID,TypeID,Star) VALUES (@ContainerID,@TypeID,@Star)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, entity.ContainerID);
                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                    conn.AddInParameter(cmd, "@Star", DbType.Int32, entity.Star);
                    conn.ExecuteNonQuery(cmd);
                }

            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除货位星级数据
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoContainerStar(CargoContainerStarEntity entity)
        {
            try
            {
                string strSQL = @"Delete from Tbl_Cargo_ContainerStar where ContainerID=@ContainerID ";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, entity.ContainerID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 查询货位星级数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerStarEntity> QueryCargoContainerStar(CargoContainerStarEntity entity)
        {
            List<CargoContainerStarEntity> result = new List<CargoContainerStarEntity>();
            try
            {
                string strDel = @"select a.*,b.TypeName from Tbl_Cargo_ContainerStar as a left join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID Where ContainerID=@ContainerID order by a.Star desc";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                {
                    conn.AddInParameter(cmdAdd, "@ContainerID", DbType.Int32, entity.ContainerID);
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoContainerStarEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                Star = Convert.ToInt32(idr["Star"]),
                                TypeName = Convert.ToString(idr["TypeName"])
                            });
                        }
                    }
                }
                return result;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        /// <summary>
        /// 新增进在库表库存表
        /// </summary>
        /// <param name="entity"></param>
        public void AddContainerGoods(CargoContainerGoodsEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_ContainerGoods(ContainerID,TypeID,ProductID,Piece,Weight,InHouseTime,IsPrintInCargo,InCargoID) VALUES (@ContainerID,@TypeID,@ProductID,@Piece,@Weight,@InHouseTime,@IsPrintInCargo,@InCargoID)";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, entity.ContainerID);
                conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                conn.AddInParameter(cmd, "@ProductID", DbType.Int32, entity.ProductID);
                conn.AddInParameter(cmd, "@Piece", DbType.Int32, entity.Piece);
                conn.AddInParameter(cmd, "@Weight", DbType.Decimal, entity.Weight);
                conn.AddInParameter(cmd, "@InHouseTime", DbType.DateTime, DateTime.Now);
                conn.AddInParameter(cmd, "@IsPrintInCargo", DbType.String, entity.IsPrintInCargo ? "1" : "0");
                conn.AddInParameter(cmd, "@InCargoID", DbType.String, entity.InCargoID);
                conn.ExecuteNonQuery(cmd);
            }
        }

        /// <summary>
        /// 批量新增在库产品
        /// </summary>
        /// <param name="list"></param>
        public void BulkInsertContainerGoods(List<CargoContainerGoodsEntity> list)
        {
            List<ContainerGoodsInsertDto> insertDto = list.Select(p => new ContainerGoodsInsertDto
            {
                ID = p.ID,
                ContainerID = p.ContainerID,
                TypeID = p.TypeID,
                ProductID = p.ProductID,
                Piece = p.Piece,
                Weight = p.Weight,
                Star = p.Star,
                InHouseTime = DateTime.Now,
                IsPrintInCargo = p.IsPrintInCargo,
                InCargoID = p.InCargoID
            }).ToList();
            conn.BulkInsertData(insertDto, "Tbl_Cargo_ContainerGoods");
        }


        /// <summary>
        /// 保存入库单
        /// </summary>
        /// <param name="entity"></param>
        public void AddInContainerGoods(CargoContainerGoodsEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_InContainerGoods(ContainerID,TypeID,ProductID,Piece,Weight,InHouseTime,IsPrintInCargo,InCargoID,InHouseType) VALUES (@ContainerID,@TypeID,@ProductID,@Piece,@Weight,@InHouseTime,@IsPrintInCargo,@InCargoID,@InHouseType)";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, entity.ContainerID);
                conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                conn.AddInParameter(cmd, "@ProductID", DbType.Int32, entity.ProductID);
                conn.AddInParameter(cmd, "@Piece", DbType.Int32, entity.Piece);
                conn.AddInParameter(cmd, "@Weight", DbType.Decimal, entity.Weight);
                conn.AddInParameter(cmd, "@InHouseTime", DbType.DateTime, DateTime.Now);
                conn.AddInParameter(cmd, "@IsPrintInCargo", DbType.String, entity.IsPrintInCargo ? "1" : "0");
                conn.AddInParameter(cmd, "@InCargoID", DbType.String, entity.InCargoID);
                conn.AddInParameter(cmd, "@InHouseType", DbType.String, entity.InHouseType);
                conn.ExecuteNonQuery(cmd);
            }
        }
        #endregion
        #region 打印入库单操作方法集合
        /// <summary>
        /// 查找未打印入库单的数据
        /// </summary>
        public List<CargoContainerShowEntity> QueryNoPrintInCargoAwbData(CargoContainerShowEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            try
            {
                string strDel = @"select b.ProductName,b.Batch,b.Figure,c.TypeName,b.Model,b.GoodsCode,b.Specs,a.Piece,d.ContainerCode,d.ContainerType,e.Name as AreaName,f.Name as HouseName,a.InHouseTime,a.ID,a.ContainerID,a.TypeID,a.ProductID,a.InCargoID,e.Code,e.ParentID,e.HouseID from Tbl_Cargo_InContainerGoods as a left join Tbl_Cargo_Product as b on a.TypeID=b.TypeID and a.ProductID=b.ProductID left join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID left join Tbl_Cargo_Container as d on a.ContainerID=d.ContainerID left join Tbl_Cargo_Area as e on d.AreaID=e.AreaID  left join Tbl_Cargo_House as f on e.HouseID=f.HouseID ";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strDel += " left join Tbl_Cargo_Area as g on e.ParentID=g.AreaID left join Tbl_Cargo_Area as h on g.ParentID=h.AreaID ";
                }
                strDel += " where (1=1)";
                if (!entity.FirstAreaID.Equals(0)) { strDel += " and h.AreaID = " + entity.FirstAreaID + ""; }
                //是否打印
                if (!string.IsNullOrEmpty(entity.PrintInCargo)) { strDel += " and a.IsPrintInCargo = '" + entity.PrintInCargo + "'"; }
                //入库类型
                if (!string.IsNullOrEmpty(entity.InHouseType)) { strDel += " and a.InHouseType = '" + entity.InHouseType + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strDel += " and a.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strDel += " and a.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strDel += " and f.HouseID in (" + entity.CargoPermisID + ")"; }
                strDel += " order by a.InHouseTime asc,c.TypeName asc";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            CargoAreaEntity cargoArea = new CargoAreaEntity();
                            CargoAreaEntity hArea = new CargoAreaEntity();
                            //如果父ID不为0，则查询父ID的区域名称
                            if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            {
                                cargoArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                                if (!cargoArea.ParentID.Equals(0))
                                {
                                    hArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                                }
                            }
                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                InCargoID = Convert.ToString(idr["InCargoID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                Model = Convert.ToString(idr["Model"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                InHouseTime = Convert.ToDateTime(idr["InHouseTime"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ParentAreaID = cargoArea.AreaID,
                                ParentAreaName = cargoArea.Name,
                                FirstAreaID = hArea.AreaID,
                                FirstAreaName = hArea.Name
                            });
                        }
                    }
                }
                return result;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion
        #region 入库管理操作方法集合
        /// <summary>
        /// 查询在库的产品数据
        /// </summary>
        public Hashtable QueryInHouseData(int pIndex, int pNum, CargoContainerShowEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            Hashtable resHT = new Hashtable();
            string strSQL = "select a.*,b.ProductName,b.Model,b.GoodsCode,b.Specs,b.Figure,b.TreadWidth,b.FlatRatio,b.Meridian,b.HubDiameter,b.LoadIndex,b.SpeedLevel,b.SpeedMax,b.Size,f.TypeName,b.SalePrice,b.TradePrice,b.CostPrice,b.Batch,b.BatchWeek,b.BatchYear,b.SourceOrderNo,b.Source,b.InHouseTime as ProductInHouseTime,c.ContainerCode,c.ContainerType,c.AreaID,c.InPiece,c.MaxPiece,c.WarnPiece,d.Name as AreaName,d.ParentID,e.Name as HouseName,e.HouseID,h.Name as FirstAreaName,h.AreaID as FirstAreaID,g.Name as ParentAreaName,g.AreaID as ParentAreaID,IsLockStock From Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_Container as c on a.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID";
            //if (!entity.FirstAreaID.Equals(0))
            //{
            strSQL += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID left join Tbl_Cargo_Area as h on g.ParentID=h.AreaID";
            //}
            strSQL += " left join Tbl_Cargo_House as e on d.HouseID=e.HouseID left join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID where (1=1) and a.Piece<>0 ";
            if (!entity.FirstAreaID.Equals(0)) { strSQL += " and h.AreaID=" + entity.FirstAreaID + ""; }
            if (!entity.ParentAreaID.Equals(0)) { strSQL += " and g.AreaID=" + entity.ParentAreaID + ""; }
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and e.HouseID in (" + entity.CargoPermisID + ")"; }
            if (!string.IsNullOrEmpty(entity.ContainerCode)) { strSQL += " and c.ContainerCode='" + entity.ContainerCode + "'"; }
            if (!string.IsNullOrEmpty(entity.ContainerType)) { strSQL += " and c.ContainerType='" + entity.ContainerType + "'"; }
            string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
            if (res.Length <= 3)
            {
                if (!string.IsNullOrEmpty(res)) { strSQL += " and b.Specs like '%" + res + "%'"; }
            }
            if (res.Length > 3 && res.Length <= 5)
            {
                strSQL += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or b.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
            }
            if (res.Length > 5)
            {
                strSQL += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
            }

            if (!entity.ProductID.Equals(0)) { strSQL += " and b.ProductID=" + entity.ProductID; }
            //型号
            if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and b.Model like '%" + entity.Model + "%'"; }
            //以一级类型ID为查询条件
            if (!entity.TypeParentID.Equals(0)) { strSQL += " and f.ParentID=" + entity.TypeParentID; }
            //二级类型ID
            if (!entity.TypeID.Equals(0)) { strSQL += " and b.TypeID=" + entity.TypeID; }
            if (!entity.BatchYear.Equals(0)) { strSQL += " and b.BatchYear=" + entity.BatchYear; }
            //花纹
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and b.Figure like '%" + entity.Figure + "%'"; }
            //以产品名称为查询条件
            if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and b.ProductName like '%" + entity.ProductName + "%'"; }
            //规格类型
            if (!string.IsNullOrEmpty(entity.SpecsType)) { strSQL += " and b.SpecsType='" + entity.SpecsType + "'"; }
            else
            {
                strSQL += " and b.SpecsType<>5";
            }
            //货品代码
            if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and b.GoodsCode like '%" + entity.GoodsCode + "%'"; }
            if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and b.Batch = '" + entity.Batch + "'"; }
            if (!string.IsNullOrEmpty(entity.IsLockStock)) { strSQL += " and IsLockStock in (" + entity.IsLockStock + ")"; }
            if (!string.IsNullOrEmpty(entity.IsShowStock)) { strSQL += " and h.IsShowStock='" + entity.IsShowStock + "'"; }
            strSQL += " order by b.Specs asc,b.BatchYear asc,b.BatchWeek asc ";
            using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        //CargoAreaEntity cargoArea = new CargoAreaEntity();
                        //CargoAreaEntity hArea = new CargoAreaEntity();
                        ////如果父ID不为0，则查询父ID的区域名称
                        //if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                        //{
                        //    cargoArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                        //    if (!cargoArea.ParentID.Equals(0))
                        //    {
                        //        hArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                        //    }
                        //}
                        result.Add(new CargoContainerShowEntity
                        {
                            ID = Convert.ToInt64(idr["ID"]),
                            ContainerID = Convert.ToInt32(idr["ContainerID"]),
                            InCargoID = Convert.ToString(idr["InCargoID"]),//入库单
                            ContainerCode = Convert.ToString(idr["ContainerCode"]),
                            ContainerType = Convert.ToString(idr["ContainerType"]),
                            AreaID = Convert.ToInt32(idr["AreaID"]),
                            InPiece = Convert.ToInt32(idr["InPiece"]),
                            MaxPiece = Convert.ToInt32(idr["MaxPiece"]),
                            WarnPiece = Convert.ToInt32(idr["WarnPiece"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            HouseName = Convert.ToString(idr["HouseName"]),
                            ParentAreaName = Convert.ToString(idr["ParentAreaName"]),
                            FirstAreaName = Convert.ToString(idr["FirstAreaName"]),
                            AreaName = Convert.ToString(idr["AreaName"]),
                            SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                            TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                            CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            ProductID = Convert.ToInt64(idr["ProductID"]),
                            Piece = Convert.ToInt32(idr["Piece"]),
                            InHouseTime = string.IsNullOrEmpty(Convert.ToString(idr["ProductInHouseTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["ProductInHouseTime"]),
                            IsPrintInCargo = Convert.ToString(idr["IsPrintInCargo"]).Equals("1") ? true : false,
                            ProductName = Convert.ToString(idr["ProductName"]),
                            Model = Convert.ToString(idr["Model"]),
                            GoodsCode = Convert.ToString(idr["GoodsCode"]),
                            Specs = Convert.ToString(idr["Specs"]),
                            Source = Convert.ToString(idr["Source"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            TreadWidth = string.IsNullOrEmpty(Convert.ToString(idr["TreadWidth"])) ? 0 : Convert.ToInt32(idr["TreadWidth"]),
                            FlatRatio = string.IsNullOrEmpty(Convert.ToString(idr["FlatRatio"])) ? 0 : Convert.ToInt32(idr["FlatRatio"]),
                            Meridian = Convert.ToString(idr["Meridian"]),
                            HubDiameter = string.IsNullOrEmpty(Convert.ToString(idr["HubDiameter"])) ? 0 : Convert.ToInt32(idr["HubDiameter"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            SpeedMax = string.IsNullOrEmpty(Convert.ToString(idr["SpeedMax"])) ? 0 : Convert.ToInt32(idr["SpeedMax"]),
                            Size = Convert.ToString(idr["Size"]),
                            Batch = Convert.ToString(idr["Batch"]),
                            BatchYear = Convert.ToInt32(idr["BatchYear"]),
                            BatchWeek = Convert.ToInt32(idr["BatchWeek"]),
                            SourceOrderNo = Convert.ToString(idr["SourceOrderNo"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            IsLockStock = Convert.ToString(idr["IsLockStock"]),
                        });
                    }
                }
            }
            resHT["rows"] = result;
            resHT["total"] = result.Count;
            return resHT;
        }
        /// <summary>
        /// 根据货位号查询该货位上的所有产品数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        private List<CargoContainerShowEntity> queryProductGoodsData(CargoContainerEntity entity, CargoContainerShowEntity showEnt)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            try
            {
                string strSQL = @"select a.ID,a.ContainerID,a.InCargoID,a.TypeID,a.ProductID,a.Piece,c.InHouseTime,a.IsPrintInCargo,c.ProductName,c.Model,c.GoodsCode,c.Specs,c.Figure,c.TreadWidth,c.FlatRatio,c.Meridian,c.HubDiameter,c.LoadIndex,c.SpeedLevel,c.SpeedMax,c.Size,d.TypeName,c.SalePrice,c.TradePrice,c.Batch,c.SourceOrderNo from Tbl_Cargo_ContainerGoods as a left join Tbl_Cargo_Product as c on a.ProductID=c.ProductID left join Tbl_Cargo_ProductType as d on a.TypeID=d.TypeID where a.ContainerID=@ContainerID and a.Piece<>0 ";
                if (!string.IsNullOrEmpty(showEnt.Specs)) { strSQL += " and c.Specs like '%" + showEnt.Specs + "%'"; }
                //型号
                if (!string.IsNullOrEmpty(showEnt.Model)) { strSQL += " and c.Model like '%" + showEnt.Model + "%'"; }
                //以一级类型ID为查询条件
                if (!showEnt.TypeParentID.Equals(0)) { strSQL += " and d.ParentID=" + showEnt.TypeParentID; }
                //二级类型ID
                if (!showEnt.TypeID.Equals(0)) { strSQL += " and c.TypeID=" + showEnt.TypeID; }
                if (!showEnt.BatchYear.Equals(0)) { strSQL += " and c.BatchYear=" + showEnt.BatchYear; }
                //花纹
                if (!string.IsNullOrEmpty(showEnt.Figure)) { strSQL += " and c.Figure like '%" + showEnt.Figure + "%'"; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(showEnt.ProductName)) { strSQL += " and c.ProductName like '%" + showEnt.ProductName + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(showEnt.GoodsCode)) { strSQL += " and c.GoodsCode like '%" + showEnt.GoodsCode + "%'"; }
                if (!string.IsNullOrEmpty(showEnt.Batch)) { strSQL += " and c.Batch = '" + showEnt.Batch + "'"; }

                strSQL += " order by c.BatchYear asc,c.BatchWeek asc ";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmdAdd, "@ContainerID", DbType.Int32, entity.ContainerID);

                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                InCargoID = Convert.ToString(idr["InCargoID"]),//入库单
                                ContainerCode = entity.ContainerCode,
                                ContainerType = entity.ContainerType,
                                AreaID = entity.AreaID,
                                InPiece = entity.InPiece,
                                MaxPiece = entity.MaxPiece,
                                WarnPiece = entity.WarnPiece,
                                HouseID = entity.HouseID,
                                HouseName = entity.HouseName,
                                ParentAreaName = entity.ParentName,
                                FirstAreaName = entity.FirstAreaName,
                                AreaName = entity.AreaName,
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                InHouseTime = Convert.ToDateTime(idr["InHouseTime"]),
                                IsPrintInCargo = Convert.ToString(idr["IsPrintInCargo"]).Equals("1") ? true : false,
                                ProductName = Convert.ToString(idr["ProductName"]),
                                Model = Convert.ToString(idr["Model"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                TreadWidth = string.IsNullOrEmpty(Convert.ToString(idr["TreadWidth"])) ? 0 : Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = string.IsNullOrEmpty(Convert.ToString(idr["FlatRatio"])) ? 0 : Convert.ToInt32(idr["FlatRatio"]),
                                Meridian = Convert.ToString(idr["Meridian"]),
                                HubDiameter = string.IsNullOrEmpty(Convert.ToString(idr["HubDiameter"])) ? 0 : Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = string.IsNullOrEmpty(Convert.ToString(idr["SpeedMax"])) ? 0 : Convert.ToInt32(idr["SpeedMax"]),
                                Size = Convert.ToString(idr["Size"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                SourceOrderNo = Convert.ToString(idr["SourceOrderNo"]),
                                TypeName = Convert.ToString(idr["TypeName"])
                            });
                        }
                    }
                }
                return result;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 首先根据仓库和区域ID查询所有货位数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        private List<CargoContainerEntity> queryHouseAreaData(CargoContainerShowEntity entity)
        {
            List<CargoContainerEntity> result = new List<CargoContainerEntity>();
            try
            {
                string strSQL = @"select c.ContainerCode,c.ContainerType,c.ContainerID,c.AreaID,c.InPiece,c.MaxPiece,c.WarnPiece,a.Name as HouseName,b.Name as AreaName,b.ParentID,a.HouseID from Tbl_Cargo_House as a left join Tbl_Cargo_Area as b on a.HouseID=b.HouseID ";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " left join Tbl_Cargo_Area as d on b.ParentID=d.AreaID";
                    strSQL += " left join Tbl_Cargo_Area as e on d.ParentID=e.AreaID";
                }
                strSQL += " inner join Tbl_Cargo_Container as c on b.AreaID=c.AreaID where (1=1)";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " and e.AreaID=" + entity.FirstAreaID + "";
                }
                if (!entity.ParentAreaID.Equals(0))
                {
                    strSQL += " and d.AreaID=" + entity.ParentAreaID + "";
                }
                //if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=@HouseID"; }
                if (!string.IsNullOrEmpty(entity.CargoPermisID))
                {
                    strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")";
                }
                //if (!entity.AreaID.Equals(0)) { strSQL += " and (b.ParentID=@AreaID or b.AreaID=@AreaID)"; }
                if (!string.IsNullOrEmpty(entity.ContainerCode)) { strSQL += " and c.ContainerCode=@ContainerCode"; }
                if (!string.IsNullOrEmpty(entity.ContainerType)) { strSQL += " and c.ContainerType=@ContainerType"; }
                strSQL += " order by c.ContainerCode asc";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    //if (!entity.HouseID.Equals(0))
                    //{
                    //    conn.AddInParameter(cmdAdd, "@HouseID", DbType.Int32, entity.HouseID);
                    //}
                    //if (!entity.AreaID.Equals(0))
                    //{
                    //    conn.AddInParameter(cmdAdd, "@AreaID", DbType.Int32, entity.AreaID);
                    //}
                    if (!string.IsNullOrEmpty(entity.ContainerCode))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    }
                    if (!string.IsNullOrEmpty(entity.ContainerType))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerType", DbType.String, entity.ContainerType);
                    }
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            CargoAreaEntity cargoArea = new CargoAreaEntity();
                            CargoAreaEntity hArea = new CargoAreaEntity();
                            //如果父ID不为0，则查询父ID的区域名称
                            if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            {
                                cargoArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                                if (!cargoArea.ParentID.Equals(0))
                                {
                                    hArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                                }
                            }
                            result.Add(new CargoContainerEntity
                            {
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                InPiece = Convert.ToInt32(idr["InPiece"]),
                                MaxPiece = Convert.ToInt32(idr["MaxPiece"]),
                                WarnPiece = Convert.ToInt32(idr["WarnPiece"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                FirstAreaName = hArea.Name,
                                ParentName = cargoArea.Name,
                                AreaName = Convert.ToString(idr["AreaName"])
                            });
                        }
                    }
                }
                return result;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }
        /// <summary>
        /// 新增货位与产品类型关联数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoContainerGoods(CargoContainerGoodsEntity entity)
        {
            try
            {
                string strSQL = @"INSERT INTO Tbl_Cargo_ContainerGoods(ContainerID,TypeID,ProductID,Piece,Weight,InHouseTime,IsPrintInCargo,InCargoID) VALUES (@ContainerID,@TypeID,@ProductID,@Piece,@Weight,@InHouseTime,@IsPrintInCargo,@InCargoID)";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, entity.ContainerID);
                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int32, entity.ProductID);
                    conn.AddInParameter(cmd, "@Piece", DbType.Int32, entity.Piece);
                    conn.AddInParameter(cmd, "@Weight", DbType.Decimal, entity.Weight);
                    conn.AddInParameter(cmd, "@InHouseTime", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@IsPrintInCargo", DbType.String, entity.IsPrintInCargo ? "1" : "0");
                    conn.AddInParameter(cmd, "@InCargoID", DbType.String, entity.InCargoID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改该货位上的件数
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoContainerGoodsPiece(CargoContainerGoodsEntity entity)
        {
            try
            {
                string strSQL = @"UPDATE Tbl_Cargo_ContainerGoods SET ";
                if (entity.IsAdd) { strSQL += " Piece=Piece+@Piece, Piece_Date=getdate()"; }
                else { strSQL += " Piece=Piece-@Piece, Piece_Date=getdate()"; }
                strSQL += " Where ID=@ID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ID", DbType.Int32, entity.ID);
                    conn.AddInParameter(cmd, "@Piece", DbType.Int32, entity.Piece);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 根据仓库货位ID和产品ID更新在库产品数量
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoContainerGoodsPieceByID(CargoContainerGoodsEntity entity)
        {
            try
            {
                string strSQL = @"UPDATE Tbl_Cargo_ContainerGoods SET ";
                if (entity.IsAdd) { strSQL += " Piece=Piece+@Piece, Piece_Date=getdate()"; }
                else { strSQL += " Piece=Piece-@Piece, Piece_Date=getdate()"; }
                strSQL += " Where ContainerID=@ContainerID and ProductID=@ProductID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, entity.ContainerID);
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.AddInParameter(cmd, "@Piece", DbType.Int32, entity.Piece);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 判断目标货位在货位产品表中是否存在 根据目标货位ID，旧货位产品类型ID，产品ID判断
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoContainerGoodsEntity IsExistCargoContainerGoods(CargoContainerGoodsEntity entity)
        {
            CargoContainerGoodsEntity result = new CargoContainerGoodsEntity();
            string strQ = @"Select * from Tbl_Cargo_ContainerGoods Where (1=1)";
            if (!entity.ContainerID.Equals(0)) { strQ += " and ContainerID=@ContainerID "; }
            if (!entity.TypeID.Equals(0)) { strQ += " and TypeID=@TypeID "; }
            if (!entity.ProductID.Equals(0)) { strQ += " and ProductID=@ProductID "; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                if (!entity.ContainerID.Equals(0))
                {
                    conn.AddInParameter(cmdQ, "@ContainerID", DbType.Int32, entity.ContainerID);
                }
                if (!entity.TypeID.Equals(0))
                {
                    conn.AddInParameter(cmdQ, "@TypeID", DbType.Int32, entity.TypeID);
                }
                if (!entity.ProductID.Equals(0))
                {
                    conn.AddInParameter(cmdQ, "@ProductID", DbType.Int64, entity.ProductID);
                }
                using (DataTable dd = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.ID = Convert.ToInt64(idr["ID"]);
                        result.ContainerID = Convert.ToInt32(idr["ContainerID"]);
                        result.TypeID = Convert.ToInt32(idr["TypeID"]);
                        result.ProductID = Convert.ToInt64(idr["ProductID"]);
                        result.InCargoID = Convert.ToString(idr["InCargoID"]);
                        result.Piece = Convert.ToInt32(idr["Piece"]);
                        result.OP_DATE = Convert.ToDateTime(idr["OP_DATE"]);

                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 根据ID查询货位产品关联表数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoContainerGoodsEntity QueryCargoContainerGoods(CargoContainerGoodsEntity entity)
        {
            CargoContainerGoodsEntity result = new CargoContainerGoodsEntity();
            string strQ = @"Select * from Tbl_Cargo_ContainerGoods Where ID=@ID";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ID", DbType.Int32, entity.ID);
                using (DataTable dd = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.ID = Convert.ToInt32(idr["ID"]);
                        result.ContainerID = Convert.ToInt32(idr["ContainerID"]);
                        result.TypeID = Convert.ToInt32(idr["TypeID"]);
                        result.ProductID = Convert.ToInt64(idr["ProductID"]);
                        result.Piece = Convert.ToInt32(idr["Piece"]);
                        result.Weight = Convert.ToDecimal(idr["Weight"]);
                        result.InCargoID = Convert.ToString(idr["InCargoID"]);
                        result.InHouseTime = Convert.ToDateTime(idr["InHouseTime"]);
                        result.IsPrintInCargo = Convert.ToInt32(idr["IsPrintInCargo"]) == 0 ? false : true;

                        result.OP_DATE = Convert.ToDateTime(idr["OP_DATE"]);

                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 根据产品ID查询在库库存数量
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerGoodsEntity> QueryCargoContainerGoodsByProductID(CargoContainerGoodsEntity entity)
        {
            List<CargoContainerGoodsEntity> list = new List<CargoContainerGoodsEntity>();
            string strQ = @"Select * from Tbl_Cargo_ContainerGoods Where ProductID=@ProductID";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ProductID", DbType.Int64, entity.ProductID);
                using (DataTable dd = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        if (Convert.ToInt32(idr["Piece"]) <= 0) { continue; }
                        CargoContainerGoodsEntity result = new CargoContainerGoodsEntity();
                        result.ID = Convert.ToInt32(idr["ID"]);
                        result.ContainerID = Convert.ToInt32(idr["ContainerID"]);
                        result.TypeID = Convert.ToInt32(idr["TypeID"]);
                        result.ProductID = Convert.ToInt64(idr["ProductID"]);
                        result.Piece = Convert.ToInt32(idr["Piece"]);
                        result.Weight = Convert.ToDecimal(idr["Weight"]);
                        result.InCargoID = Convert.ToString(idr["InCargoID"]);
                        result.InHouseTime = Convert.ToDateTime(idr["InHouseTime"]);
                        result.IsPrintInCargo = Convert.ToInt32(idr["IsPrintInCargo"]) == 0 ? false : true;
                        result.OP_DATE = Convert.ToDateTime(idr["OP_DATE"]);
                        list.Add(result);
                    }
                }
            }
            return list;
        }
        /// <summary>
        /// 删除货位产品关联表数据根据ID
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoContainerGoods(CargoContainerGoodsEntity entity)
        {
            try
            {
                string strSQL = @"Delete from Tbl_Cargo_ContainerGoods where ID=@ID ";

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ID", DbType.Int32, entity.ID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除入库单
        /// </summary>
        /// <param name="InCargoID"></param>
        /// <param name="containID"></param>
        /// <param name="productID"></param>
        /// <param name="InHouseType"></param>
        public void DeleteInCargoData(string InCargoID, int containID, Int64 productID, string InHouseType)
        {
            string strSQL = @"DELETE FROM Tbl_Cargo_InContainerGoods Where InCargoID=@InCargoID and ContainerID=@ContainerID and ProductID=@ProductID and InHouseType=@InHouseType";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@InCargoID", DbType.String, InCargoID);
                conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, containID);
                conn.AddInParameter(cmd, "@ProductID", DbType.Int64, productID);
                conn.AddInParameter(cmd, "@InHouseType", DbType.String, InHouseType);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改入库表数量
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateInCargoGoodsPiece(CargoContainerGoodsEntity entity)
        {
            try
            {
                string strSQL = @"UPDATE Tbl_Cargo_InContainerGoods SET ";
                if (entity.IsAdd) { strSQL += " Piece=Piece+@Piece"; }
                else { strSQL += " Piece=Piece-@Piece"; }
                strSQL += " Where InCargoID=@InCargoID and ProductID=@ProductID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.AddInParameter(cmd, "@InCargoID", DbType.String, entity.InCargoID);
                    conn.AddInParameter(cmd, "@Piece", DbType.Int32, entity.Piece);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 根据在库表ID查询在库产品数据信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryInHouseProductByID(CargoContainerGoodsEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            try
            {
                string strSQL = @"select a.ID,a.ContainerID,a.TypeID,a.ProductID,a.Piece,a.InCargoID,b.ProductName,b.Model,b.GoodsCode,b.Specs,b.Figure,b.SpeedLevel,b.SpeedMax,b.UnitPrice,b.TradePrice,b.SalePrice,b.Batch,b.BatchYear,b.BatchWeek,c.ContainerCode,c.ContainerType,c.AreaID,d.Name as AreaName,d.HouseID,e.Name as HouseName,e.HouseCode,d.ParentID from Tbl_Cargo_ContainerGoods as a left join Tbl_Cargo_Product as b on a.ProductID=b.ProductID left join Tbl_Cargo_Container as c on a.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID left join Tbl_Cargo_House as e on d.HouseID=e.HouseID where a.ID=@ID ";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmdAdd, "@ID", DbType.Int64, entity.ID);

                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            CargoAreaEntity cargoArea = new CargoAreaEntity();
                            CargoAreaEntity hArea = new CargoAreaEntity();
                            //如果父ID不为0，则查询父ID的区域名称
                            if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            {
                                cargoArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                                if (!cargoArea.ParentID.Equals(0))
                                {
                                    hArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                                }
                            }
                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                InCargoID = Convert.ToString(idr["InCargoID"]),//入库单
                                ProductName = Convert.ToString(idr["ProductName"]),
                                Model = Convert.ToString(idr["Model"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = string.IsNullOrEmpty(Convert.ToString(idr["SpeedMax"])) ? 0 : Convert.ToInt32(idr["SpeedMax"]),
                                UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseCode = Convert.ToString(idr["HouseCode"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                BatchYear = Convert.ToInt32(idr["BatchYear"]),
                                BatchWeek = Convert.ToInt32(idr["BatchWeek"]),
                                FirstAreaName = hArea.Name,
                                ParentAreaName = cargoArea.Name,
                                AreaName = Convert.ToString(idr["AreaName"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 通过产品规格型号花纹类型 货位ID查询在库库存ID
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public int QueryContainerGoodsIDByProductInfo(CargoContainerGoodsEntity entity)
        {
            int result = 0;
            try
            {
                string strSQL = @"select top 1 b.ID from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID and a.TypeID=b.TypeID where b.ContainerID=@ContainerID and a.TypeID=@TypeID and a.Model=@Model and a.Specs=@Specs and a.Figure=@Figure ";
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch=@Batch"; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex=@LoadIndex "; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel=@SpeedLevel"; }
                using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmdQ, "@ContainerID", DbType.Int32, entity.ContainerID);
                    conn.AddInParameter(cmdQ, "@TypeID", DbType.Int32, entity.TypeID);
                    conn.AddInParameter(cmdQ, "@Model", DbType.String, entity.Model);
                    conn.AddInParameter(cmdQ, "@Specs", DbType.String, entity.Specs);
                    conn.AddInParameter(cmdQ, "@Figure", DbType.String, entity.Figure);
                    if (!string.IsNullOrEmpty(entity.Batch)) { conn.AddInParameter(cmdQ, "@Batch", DbType.String, entity.Batch); }
                    if (!string.IsNullOrEmpty(entity.LoadIndex)) { conn.AddInParameter(cmdQ, "@LoadIndex", DbType.String, entity.LoadIndex); }
                    if (!string.IsNullOrEmpty(entity.SpeedLevel)) { conn.AddInParameter(cmdQ, "@SpeedLevel", DbType.String, entity.SpeedLevel); }
                    using (DataTable dd = conn.ExecuteDataTable(cmdQ))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result = Convert.ToInt32(idr["ID"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询产品的货位数统计
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable queryStatisInHouseNum(int pIndex, int pNum, CargoContainerShowEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.ContainerNum DESC) AS RowNumber, b.TypeName,a.* from (select a.TypeID,a.Specs,a.Figure,a.Model,a.HouseID,COUNT(distinct b.ContainerID) as ContainerNum,SUM(b.Piece) as InPiece from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID inner join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID ";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID";
                    strSQL += " left join Tbl_Cargo_Area as h on g.ParentID=h.AreaID";
                }
                strSQL += " where (1=1) and b.Piece>0 ";
                if (!entity.FirstAreaID.Equals(0)) { strSQL += " and h.AreaID=" + entity.FirstAreaID + ""; }
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure = '" + entity.Figure + "'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode = '" + entity.GoodsCode + "'"; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and c.Batch = '" + entity.Batch + "'"; }
                strSQL += "group by a.TypeID,a.Specs,a.Model,a.Figure,a.HouseID) as a left join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID where (1=1) ";
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strSQL += " and b.ParentID=" + entity.TypeParentID; }
                if (!entity.ContainerNum.Equals(0)) { strSQL += " and a.ContainerNum=" + entity.ContainerNum; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoContainerShowEntity
                            {
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Model = Convert.ToString(idr["Model"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                ContainerNum = Convert.ToInt32(idr["ContainerNum"]),
                                InPiece = Convert.ToInt32(idr["InPiece"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from (select a.TypeID,a.Specs,a.Model,a.Figure,a.HouseID,COUNT(distinct b.ContainerID) as ContainerNum,SUM(b.Piece) as InPiece from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID inner join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID  ";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strCount += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID";
                    strCount += " left join Tbl_Cargo_Area as h on g.ParentID=h.AreaID";
                }
                strCount += " where (1=1) and b.Piece>0 ";
                if (!entity.FirstAreaID.Equals(0)) { strCount += " and h.AreaID=" + entity.FirstAreaID + ""; }
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs)) { strCount += " and a.Specs like '%" + entity.Specs + "%'"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strCount += " and a.Model like '%" + entity.Model + "%'"; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strCount += " and a.TypeID=" + entity.TypeID; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and a.Figure = '" + entity.Figure + "'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strCount += " and a.GoodsCode = '" + entity.GoodsCode + "'"; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strCount += " and c.Batch = '" + entity.Batch + "'"; }
                strCount += "group by a.TypeID,a.Specs,a.Model,a.Figure,a.HouseID) as a left join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID where (1=1) ";
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strCount += " and b.ParentID=" + entity.TypeParentID; }
                if (!entity.ContainerNum.Equals(0)) { strCount += " and a.ContainerNum=" + entity.ContainerNum; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 根据产品信息查询该规格和花纹所在的货位
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerEntity> QueryInContainerByProduct(CargoProductEntity entity)
        {
            List<CargoContainerEntity> result = new List<CargoContainerEntity>();

            try
            {
                string strSQL = @"select a.TypeID,c.ContainerCode,c.ContainerType,c.MaxPiece,c.InPiece,(c.MaxPiece-c.InPiece) as allowPiece,c.WarnPiece,a.HouseID,b.ContainerID,SUM(b.Piece) as Piece,c.AreaID,d.ParentID,d.Name from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID left join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID where (1=1)";
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID = " + entity.HouseID + ""; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID = " + entity.TypeID + ""; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs = '" + entity.Specs + "'"; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure = '" + entity.Figure + "'"; }
                strSQL += " group by a.TypeID,c.ContainerCode,c.ContainerType,c.MaxPiece,c.InPiece,c.WarnPiece,a.HouseID,b.ContainerID,c.AreaID,d.ParentID,d.Name order by SUM(b.Piece) desc";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            if (Convert.ToInt32(idr["allowPiece"]) <= 0)
                            {
                                continue;
                            }
                            CargoAreaEntity cargoArea = new CargoAreaEntity();
                            //如果父ID不为0，则查询父ID的区域名称
                            if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            {
                                cargoArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                            }
                            result.Add(new CargoContainerEntity
                            {
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                AreaName = Convert.ToString(idr["Name"]),
                                MaxPiece = Convert.ToInt32(idr["MaxPiece"]),
                                WarnPiece = Convert.ToInt32(idr["WarnPiece"]),
                                InPiece = Convert.ToInt32(idr["InPiece"]),
                                FirstAreaID = cargoArea.AreaID,
                                FirstAreaName = cargoArea.Name,
                                ProductPiece = Convert.ToInt32(idr["Piece"]),
                                allowPiece = Convert.ToInt32(idr["allowPiece"]),
                                TypeID = Convert.ToInt32(idr["TypeID"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 判断今天 是否有入库记录，如果有就递增数量一，如果 没有则新增一条
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoContainerGoodsEntity IsExistCargoInContainerCode(CargoContainerGoodsEntity entity)
        {
            CargoContainerGoodsEntity result = new CargoContainerGoodsEntity();
            //string strQ = @"Select * from Tbl_Cargo_InContainerGoods Where ContainerID=@ContainerID and ProductID=@ProductID and InHouseType='0' and InHouseTime>='" + DateTime.Now.ToString("yyyy-MM-dd") + "'";
            string strQ = @"Select * from Tbl_Cargo_InContainerGoods Where ContainerID=@ContainerID and ProductID=@ProductID and InHouseTime>='" + entity.InHouseTime.ToString("yyyy-MM-dd") + "' and InHouseTime<'" + entity.InHouseTime.AddDays(1).ToString("yyyy-MM-dd") + "'";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ContainerID", DbType.Int32, entity.ContainerID);
                conn.AddInParameter(cmdQ, "@ProductID", DbType.Int64, entity.ProductID);
                using (DataTable dd = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.ID = Convert.ToInt64(idr["ID"]);
                        result.ProductID = Convert.ToInt64(idr["ProductID"]);
                        result.ContainerID = Convert.ToInt32(idr["ContainerID"]);
                        result.InCargoID = Convert.ToString(idr["InCargoID"]);
                    }
                }
            }
            return result;
        }

        #endregion
        #region 出库管理操作方法集合

        /// <summary>
        /// 查询所有在库的产品数据
        /// </summary>
        public List<CargoContainerShowEntity> QueryALLHouseData(CargoContainerShowEntity entity)
        {
            CargoProductManager pro = new CargoProductManager();
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            try
            {
                string strSQL = @"select ISNULL(r.UpClientID,0) as UpClientID,b.ID,c.ContainerID,c.ContainerCode,c.ContainerType,b.Piece,d.AreaID,d.Name as AreaName,d.ParentID,e.Name as HouseName,e.HouseCode,e.BelongHouse,ISNULL(e.OverDayNum,0) as OverDayNum,ISNULL(e.OverDueUnitPrice,0) as OverDueUnitPrice,f.TypeName,f.ParentID as TypeParentID,m.SourceName,m.SourceCode,f.TypeParentName as TypeParentName,a.*,h.Name as FirstAreaName,h.AreaID as FirstAreaID,g.Name as ParentAreaName,g.AreaID as ParentAreaID,h.OrderCode,h.OrderDep,a.NextDayPrice from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID left join Tbl_Cargo_ProductSource as m on a.Source=m.Source inner join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID inner join Tbl_Cargo_Area as d on c.AreaID=d.AreaID ";
                //if (!entity.FirstAreaID.Equals(0))
                //{
                //    strSQL += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID";
                //}
                strSQL += " inner join Tbl_Cargo_Area as g on d.ParentID=g.AreaID inner join Tbl_Cargo_Area as h on g.ParentID=h.AreaID ";
                strSQL += " inner join Tbl_Cargo_House as e on d.HouseID=e.HouseID inner join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID  left join Tbl_Cargo_Client AS r on a.SuppClientNum=r.ClientNum  where (1=1) and b.Piece<>0 ";
                //strSQL += " inner join Tbl_Cargo_House as e on d.HouseID=e.HouseID inner join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID left join Tbl_Cargo_ProductType as k on f.ParentID=k.TypeID where (1=1) and b.Piece<>0 ";
                //if (!entity.FirstAreaID.Equals(0))
                //{
                //    strSQL += " and g.ParentID=" + entity.FirstAreaID + "";
                //}
                if (!string.IsNullOrEmpty(entity.ParamFirstAreaID)) { strSQL += $@" and h.AreaID in({entity.ParamFirstAreaID}) "; }
                else if (!entity.FirstAreaID.Equals(0)) { strSQL += " and h.AreaID = " + entity.FirstAreaID + ""; }
                //以产品名称为查询条件

                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and (a.ProductName like '%" + entity.ProductName + "%' or a.GoodsName like '%" + entity.ProductName + "%')"; }
                //以产品名称为查询条件
                //if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                if (entity.HouseID.Equals(62))
                {
                    if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                }
                else
                {
                    if (!string.IsNullOrWhiteSpace(entity.Specs))
                    {
                        string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                        if (res.Length <= 3)
                        {
                            if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
                        }
                        if (res.Length > 3 && res.Length <= 5)
                        {
                            strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                        }
                        if (res.Length > 5)
                        {
                            strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '" + entity.Specs + "')";
                        }
                    }
                }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strSQL += " and f.ParentID=" + entity.TypeParentID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                else if (!string.IsNullOrEmpty(entity.TypeIDs)) { strSQL += " and a.TypeID in (" + entity.TypeIDs + ")"; }
                if (!entity.ProductID.Equals(0)) { strSQL += " and a.ProductID=" + entity.ProductID; }
                if (!entity.TreadWidth.Equals(0)) { strSQL += " and a.TreadWidth=" + entity.TreadWidth; }
                if (!entity.TradePrice.Equals(0)) { strSQL += " and a.TradePrice=" + entity.TradePrice; }
                if (!entity.SalePrice.Equals(0)) { strSQL += " and a.SalePrice<=" + entity.SalePrice; }
                if (!entity.FlatRatio.Equals(0)) { strSQL += " and a.FlatRatio=" + entity.FlatRatio; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch = '" + entity.Batch + "'"; }
                if (!string.IsNullOrEmpty(entity.Born)) { strSQL += " and a.Born = '" + entity.Born + "'"; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.BelongDepart)) { strSQL += " and a.BelongDepart = '" + entity.BelongDepart + "'"; }
                if (!entity.BatchYear.Equals(0)) { strSQL += " and a.BatchYear=" + entity.BatchYear; }
                if (!entity.BatchWeek.Equals(0))
                {
                    if (entity.PriceType.Equals(0))
                    {
                        //半年前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-6,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(1))
                    {
                        //一年前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-12,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(2))
                    {
                        //10个月前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-10,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(3))
                    {
                        //30周前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(WEEK,-30,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(4))
                    {
                        //9个月前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-9,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(5))
                    {
                        //3个月前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-3,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                }
                if (!entity.HubDiameter.Equals(0)) { strSQL += " and a.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex='" + entity.LoadIndex + "'"; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and e.HouseID=@HouseID"; }
                if (!string.IsNullOrEmpty(entity.ParamParentAreaID)) { strSQL += $@" and d.ParentID in({entity.ParamParentAreaID}) "; }
                else if(!entity.ParentAreaID.Equals(0)) { strSQL += " and d.ParentID=" + entity.ParentAreaID + ""; }
                //if (!entity.AreaID.Equals(0)) { strSQL += " and (b.ParentID=@AreaID or b.AreaID=@AreaID)"; }
                if (!string.IsNullOrEmpty(entity.ContainerCode)) { strSQL += " and c.ContainerCode=@ContainerCode"; }
                if (!string.IsNullOrEmpty(entity.ContainerType)) { strSQL += " and c.ContainerType=@ContainerType"; }
                //锁定库存
                if (!string.IsNullOrEmpty(entity.IsLockStock)) { strSQL += " and a.IsLockStock='" + entity.IsLockStock + "'"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //所属公司
                if (!string.IsNullOrEmpty(entity.Company)) { strSQL += " and a.Company = '" + entity.Company + "'"; }
                //规格类型
                if (!string.IsNullOrEmpty(entity.SpecsType)) { strSQL += " and a.SpecsType='" + entity.SpecsType + "'"; }
                else
                {
                    strSQL += " and a.SpecsType<>5";
                }
                if (!string.IsNullOrEmpty(entity.IsShowStock)) { strSQL += " and h.IsShowStock='" + entity.IsShowStock + "'"; }
                if (!entity.SuppClientNum.Equals(0)) { strSQL += " and a.SuppClientNum=" + entity.SuppClientNum; }
                if (entity.FirstAreaID.Equals(3480)) { strSQL += " order by a.TypeID, case when a.ProductCode like 'LTSA%' then 0 else 1 end asc,a.ProductCode asc"; }
                else
                {
                    strSQL += " order by a.TypeID,a.Specs, a.Figure asc,a.BatchYear asc,a.BatchWeek asc,b.piece asc";
                }
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!entity.HouseID.Equals(0)) { conn.AddInParameter(cmdAdd, "@HouseID", DbType.Int32, entity.HouseID); }
                    if (!string.IsNullOrEmpty(entity.ContainerCode))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    }
                    if (!string.IsNullOrEmpty(entity.ContainerType))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerType", DbType.String, entity.ContainerType);
                    }
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            //CargoAreaEntity cargoArea = new CargoAreaEntity();
                            //CargoAreaEntity hArea = new CargoAreaEntity();
                            ////如果父ID不为0，则查询父ID的区域名称
                            //if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            //{
                            //    cargoArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                            //    if (!cargoArea.ParentID.Equals(0))
                            //    {
                            //        hArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                            //    }
                            //}
                            //CargoOrderGoodsEntity goods = new CargoOrderGoodsEntity();
                            //if (Convert.ToInt32(idr["HouseID"]).Equals(64))
                            //{
                            //    goods = QueryPrevOrderInfo(new CargoOrderEntity { HouseID = Convert.ToInt32(idr["HouseID"]), OrderModel = "0", TypeID = Convert.ToInt32(idr["TypeID"]), Specs = Convert.ToString(idr["Specs"]), Figure = Convert.ToString(idr["Figure"]), LoadIndex = Convert.ToString(idr["LoadIndex"]), SpeedLevel = Convert.ToString(idr["SpeedLevel"]), PayClientNum = entity.PayClientNum });
                            //}
                            //List<CargoProductTypeEntity> proTypeList = pro.QueryProductType(new CargoProductTypeEntity { TypeID = Convert.ToInt32(idr["TypeParentID"]) });
                            int inHouseDay = Convert.ToDateTime(DateTime.Now.ToShortDateString()).Subtract(Convert.ToDateTime(Convert.ToDateTime(idr["InHouseTime"]).ToShortDateString())).Days;
                            int OverDay = 0;
                            decimal OnlyOverDayFee = 0.00M;
                            if (!Convert.ToInt32(idr["OverDayNum"]).Equals(0) && !Convert.ToDecimal(idr["OverDueUnitPrice"]).Equals(0) && inHouseDay > Convert.ToInt32(idr["OverDayNum"]))
                            {
                                OverDay = inHouseDay - Convert.ToInt32(idr["OverDayNum"]);
                                OnlyOverDayFee = OverDay * Convert.ToDecimal(idr["OverDueUnitPrice"]) * Convert.ToInt32(idr["Piece"]);
                            }


                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                Piece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InPiece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InHouseTime = Convert.ToDateTime(idr["InHouseTime"]),//入库时间
                                InHouseDay = inHouseDay.ToString(),
                                OverDueFee = OnlyOverDayFee,
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                FirstAreaName = Convert.ToString(idr["FirstAreaName"]),
                                FirstAreaID = Convert.ToInt32(idr["FirstAreaID"]),
                                OrderCode = Convert.ToString(idr["OrderCode"]),
                                OrderDep = Convert.ToString(idr["OrderDep"]),
                                NextDayPrice = Convert.ToDecimal(idr["NextDayPrice"]),
                                ParentAreaID = Convert.ToInt32(idr["ParentAreaID"]),
                                ParentAreaName = Convert.ToString(idr["ParentAreaName"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseCode = Convert.ToString(idr["HouseCode"]),
                                BelongHouse = Convert.ToString(idr["BelongHouse"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                GoodsName = Convert.ToString(idr["GoodsName"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                TypeParentID = Convert.ToInt32(idr["TypeParentID"]),
                                TypeParentName = Convert.ToString(idr["TypeParentName"]),//proTypeList.Count > 0 ? proTypeList[0].TypeName : "",
                                Model = Convert.ToString(idr["Model"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                //TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                                //FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                                //Meridian = Convert.ToString(idr["Meridian"]),
                                //HubDiameter =  Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = Convert.ToInt32(idr["SpeedMax"]),
                                Source = Convert.ToString(idr["Source"]),
                                SourceName = Convert.ToString(idr["SourceName"]),
                                SourceCode = Convert.ToString(idr["SourceCode"]),
                                Size = Convert.ToString(idr["Size"]),
                                Weight = Convert.ToDecimal(idr["Weight"]),
                                UnitPrice = string.IsNullOrEmpty(Convert.ToString(idr["UnitPrice"])) ? 0 : Convert.ToDecimal(idr["UnitPrice"]),
                                Numbers = Convert.ToInt32(idr["Numbers"]),
                                CostPrice = string.IsNullOrEmpty(Convert.ToString(idr["CostPrice"])) ? 0 : Convert.ToDecimal(idr["CostPrice"]),
                                TradePrice = string.IsNullOrEmpty(Convert.ToString(idr["TradePrice"])) ? 0 : Convert.ToDecimal(idr["TradePrice"]),
                                SalePrice = string.IsNullOrEmpty(Convert.ToString(idr["SalePrice"])) ? 0 : Convert.ToDecimal(idr["SalePrice"]),
                                InHousePrice = string.IsNullOrEmpty(Convert.ToString(idr["InHousePrice"])) ? 0 : Convert.ToDecimal(idr["InHousePrice"]),
                                //SalePriceClient = goods.ActSalePrice,//上一销售价
                                //OrderNo = goods.OrderNo,
                                //PayClientName = goods.PayClientName,
                                Package = Convert.ToString(idr["Package"]),
                                PackageNum = string.IsNullOrEmpty(Convert.ToString(idr["PackageNum"])) ? 0 : Convert.ToInt32(idr["PackageNum"]),
                                PackageWeight = string.IsNullOrEmpty(Convert.ToString(idr["PackageWeight"])) ? 0 : Convert.ToDecimal(idr["PackageWeight"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                Born = Convert.ToString(idr["Born"]),
                                BatchYear = Convert.ToInt32(idr["BatchYear"]),
                                BatchWeek = Convert.ToInt32(idr["BatchWeek"]),
                                BelongDepart = Convert.ToString(idr["BelongDepart"]),
                                SourceOrderNo = Convert.ToString(idr["SourceOrderNo"]),
                                SpecsType = Convert.ToString(idr["SpecsType"]),
                                Supplier = Convert.ToString(idr["Supplier"]),
                                SuppClientNum = Convert.ToInt32(idr["SuppClientNum"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                UpClientID = Convert.ToInt32(idr["UpClientID"]),
                                IsLockStock = Convert.ToString(idr["IsLockStock"]),
                                OwnerShip = Convert.ToString(idr["OwnerShip"]),
                                GoodsClass = Convert.ToString(idr["GoodsClass"]),
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询所有库存数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public List<CargoContainerShowEntity> QueryALLHouseStockData(int pIndex, int pNum, CargoContainerShowEntity entity)
        {
            CargoProductManager pro = new CargoProductManager();
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            try
            {
                string strSQL = @"select TOP  " + pNum + " * from ( select distinct ROW_NUMBER() OVER(ORDER BY a.TypeID,a.Specs, a.Figure asc,a.BatchYear asc,a.BatchWeek asc,a.piece asc) AS RowNumber,COUNT(*) over() as TotalRowNum,DATEDIFF(DAY,a.InHouseTime,GETDATE()) as inHouseDay,SUM(a.Piece) over () as TotalPiece,a.OverDueUnitPrice*a.Piece*(case when a.OverDayNum!=0 and a.OverDueUnitPrice!=0 and DATEDIFF(DAY,a.InHouseTime,GETDATE())> a.OverDayNum then DATEDIFF(DAY,a.InHouseTime,GETDATE())-a.OverDayNum else 0 end) as OnlyOverDayFee,SUM(a.OverDueUnitPrice*a.Piece*(case when a.OverDayNum!=0 and a.OverDueUnitPrice!=0 and DATEDIFF(DAY,a.InHouseTime,GETDATE())> a.OverDayNum then DATEDIFF(DAY,a.InHouseTime,GETDATE())-a.OverDayNum else 0 end)) over () as TotalOnlyOverDayFee,a.* from (select ISNULL(r.UpClientID,0) as UpClientID,r.UpClientShortName,b.ID,c.ContainerID,c.ContainerCode,c.ContainerType,b.Piece,d.AreaID,d.Name as AreaName,d.ParentID,e.Name as HouseName,e.HouseCode,e.BelongHouse,ISNULL(e.OverDayNum,0) as OverDayNum,ISNULL(e.OverDueUnitPrice,0) as OverDueUnitPrice,f.TypeName,f.ParentID as TypeParentID,m.SourceName,m.SourceCode,f.TypeParentName as TypeParentName,a.*,h.Name as FirstAreaName,h.AreaID as FirstAreaID,g.Name as ParentAreaName,g.AreaID as ParentAreaID,h.OrderCode,h.OrderDep from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID left join Tbl_Cargo_ProductSource as m on a.Source=m.Source inner join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID inner join Tbl_Cargo_Area as d on c.AreaID=d.AreaID ";
                //if (!entity.FirstAreaID.Equals(0))
                //{
                //    strSQL += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID";
                //}
                strSQL += " inner join Tbl_Cargo_Area as g on d.ParentID=g.AreaID inner join Tbl_Cargo_Area as h on g.ParentID=h.AreaID ";
                strSQL += " inner join Tbl_Cargo_House as e on d.HouseID=e.HouseID inner join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID  left join Tbl_Cargo_Client AS r on a.SuppClientNum=r.ClientNum  where (1=1) and b.Piece<>0 ";
                //strSQL += " inner join Tbl_Cargo_House as e on d.HouseID=e.HouseID inner join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID left join Tbl_Cargo_ProductType as k on f.ParentID=k.TypeID where (1=1) and b.Piece<>0 ";
                //if (!entity.FirstAreaID.Equals(0))
                //{
                //    strSQL += " and g.ParentID=" + entity.FirstAreaID + "";
                //}
                if (!entity.FirstAreaID.Equals(0)) { strSQL += " and h.AreaID = " + entity.FirstAreaID + ""; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //以产品名称为查询条件
                //if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                if (entity.HouseID.Equals(62))
                {
                    if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                }
                else
                {
                    if (!string.IsNullOrWhiteSpace(entity.Specs))
                    {
                        string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                        if (res.Length <= 3)
                        {
                            if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
                        }
                        if (res.Length > 3 && res.Length <= 5)
                        {
                            strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                        }
                        if (res.Length > 5)
                        {
                            strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '" + entity.Specs + "')";
                        }
                    }
                }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strSQL += " and f.ParentID=" + entity.TypeParentID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                else if (!string.IsNullOrEmpty(entity.TypeIDs)) { strSQL += " and a.TypeID in (" + entity.TypeIDs + ")"; }
                if (!entity.ProductID.Equals(0)) { strSQL += " and a.ProductID=" + entity.ProductID; }
                if (!entity.TreadWidth.Equals(0)) { strSQL += " and a.TreadWidth=" + entity.TreadWidth; }
                if (!entity.TradePrice.Equals(0)) { strSQL += " and a.TradePrice=" + entity.TradePrice; }
                if (!entity.SalePrice.Equals(0)) { strSQL += " and a.SalePrice<=" + entity.SalePrice; }
                if (!entity.FlatRatio.Equals(0)) { strSQL += " and a.FlatRatio=" + entity.FlatRatio; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch = '" + entity.Batch + "'"; }
                if (!string.IsNullOrEmpty(entity.Born)) { strSQL += " and a.Born = '" + entity.Born + "'"; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.BelongDepart)) { strSQL += " and a.BelongDepart = '" + entity.BelongDepart + "'"; }
                if (!entity.BatchYear.Equals(0)) { strSQL += " and a.BatchYear=" + entity.BatchYear; }
                if (!entity.BatchWeek.Equals(0))
                {
                    if (entity.PriceType.Equals(0))
                    {
                        //半年前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-6,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(1))
                    {
                        //一年前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-12,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(2))
                    {
                        //10个月前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-10,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(3))
                    {
                        //30周前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(WEEK,-30,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(4))
                    {
                        //9个月前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-9,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(5))
                    {
                        //3个月前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-3,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                }
                if (!entity.HubDiameter.Equals(0)) { strSQL += " and a.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex='" + entity.LoadIndex + "'"; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and e.HouseID=@HouseID"; }
                if (!entity.ParentAreaID.Equals(0)) { strSQL += " and d.ParentID=" + entity.ParentAreaID + ""; }
                //if (!entity.AreaID.Equals(0)) { strSQL += " and (b.ParentID=@AreaID or b.AreaID=@AreaID)"; }
                if (!string.IsNullOrEmpty(entity.ContainerCode)) { strSQL += " and c.ContainerCode=@ContainerCode"; }
                if (!string.IsNullOrEmpty(entity.ContainerType)) { strSQL += " and c.ContainerType=@ContainerType"; }
                //锁定库存
                if (!string.IsNullOrEmpty(entity.IsLockStock)) { strSQL += " and a.IsLockStock='" + entity.IsLockStock + "'"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //所属公司
                if (!string.IsNullOrEmpty(entity.Company)) { strSQL += " and a.Company = '" + entity.Company + "'"; }
                //规格类型
                if (!string.IsNullOrEmpty(entity.SpecsType))
                {
                    strSQL += " and a.SpecsType='" + entity.SpecsType + "'";
                }
                else
                {
                    strSQL += " and a.SpecsType<>5";
                }
                if (!string.IsNullOrEmpty(entity.IsShowStock)) { strSQL += " and h.IsShowStock='" + entity.IsShowStock + "'"; }
                if (!entity.SuppClientNum.Equals(0)) { strSQL += " and a.SuppClientNum=" + entity.SuppClientNum; }
                //strSQL += " and UnitPrice<100";
                //if (entity.FirstAreaID.Equals(3480)) { strSQL += " order by a.TypeID, case when a.ProductCode like 'LTSA%' then 0 else 1 end asc,a.ProductCode asc"; }
                //else
                //{
                //    strSQL += " order by a.TypeID,a.Specs, a.Figure asc,a.BatchYear asc,a.BatchWeek asc,b.piece asc";
                //}
                strSQL += ") as A ) as b where b.RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!entity.HouseID.Equals(0)) { conn.AddInParameter(cmdAdd, "@HouseID", DbType.Int32, entity.HouseID); }
                    if (!string.IsNullOrEmpty(entity.ContainerCode))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    }
                    if (!string.IsNullOrEmpty(entity.ContainerType))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerType", DbType.String, entity.ContainerType);
                    }
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            //CargoAreaEntity cargoArea = new CargoAreaEntity();
                            //CargoAreaEntity hArea = new CargoAreaEntity();
                            ////如果父ID不为0，则查询父ID的区域名称
                            //if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            //{
                            //    cargoArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                            //    if (!cargoArea.ParentID.Equals(0))
                            //    {
                            //        hArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                            //    }
                            //}
                            //CargoOrderGoodsEntity goods = new CargoOrderGoodsEntity();
                            //if (Convert.ToInt32(idr["HouseID"]).Equals(64))
                            //{
                            //    goods = QueryPrevOrderInfo(new CargoOrderEntity { HouseID = Convert.ToInt32(idr["HouseID"]), OrderModel = "0", TypeID = Convert.ToInt32(idr["TypeID"]), Specs = Convert.ToString(idr["Specs"]), Figure = Convert.ToString(idr["Figure"]), LoadIndex = Convert.ToString(idr["LoadIndex"]), SpeedLevel = Convert.ToString(idr["SpeedLevel"]), PayClientNum = entity.PayClientNum });
                            //}
                            //List<CargoProductTypeEntity> proTypeList = pro.QueryProductType(new CargoProductTypeEntity { TypeID = Convert.ToInt32(idr["TypeParentID"]) });
                            //int inHouseDay = Convert.ToDateTime(DateTime.Now.ToShortDateString()).Subtract(Convert.ToDateTime(Convert.ToDateTime(idr["InHouseTime"]).ToShortDateString())).Days;
                            //int OverDay = 0;
                            //decimal OnlyOverDayFee = 0.00M;
                            //if (!Convert.ToInt32(idr["OverDayNum"]).Equals(0) && !Convert.ToDecimal(idr["OverDueUnitPrice"]).Equals(0) && inHouseDay > Convert.ToInt32(idr["OverDayNum"]))
                            //{
                            //    OverDay = inHouseDay - Convert.ToInt32(idr["OverDayNum"]);
                            //    OnlyOverDayFee = OverDay * Convert.ToDecimal(idr["OverDueUnitPrice"]) * Convert.ToInt32(idr["Piece"]);
                            //}


                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                TotalRowNum = Convert.ToInt32(idr["TotalRowNum"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                Piece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InPiece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                TotalPiece = Convert.ToInt32(idr["TotalPiece"]),
                                TotalOnlyOverDayFee = Convert.ToDecimal(idr["TotalOnlyOverDayFee"]),
                                InHouseTime = Convert.ToDateTime(idr["InHouseTime"]),//入库时间
                                InHouseDay = Convert.ToString(idr["InHouseDay"]),
                                OverDueFee = Convert.ToDecimal(idr["OnlyOverDayFee"]),
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                FirstAreaName = Convert.ToString(idr["FirstAreaName"]),
                                FirstAreaID = Convert.ToInt32(idr["FirstAreaID"]),
                                OrderCode = Convert.ToString(idr["OrderCode"]),
                                OrderDep = Convert.ToString(idr["OrderDep"]),
                                ParentAreaID = Convert.ToInt32(idr["ParentAreaID"]),
                                ParentAreaName = Convert.ToString(idr["ParentAreaName"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseCode = Convert.ToString(idr["HouseCode"]),
                                BelongHouse = Convert.ToString(idr["BelongHouse"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                TypeParentID = Convert.ToInt32(idr["TypeParentID"]),
                                TypeParentName = Convert.ToString(idr["TypeParentName"]),//proTypeList.Count > 0 ? proTypeList[0].TypeName : "",
                                Model = Convert.ToString(idr["Model"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                                Meridian = Convert.ToString(idr["Meridian"]),
                                HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = Convert.ToInt32(idr["SpeedMax"]),
                                Source = Convert.ToString(idr["Source"]),
                                SourceName = Convert.ToString(idr["SourceName"]),
                                SourceCode = Convert.ToString(idr["SourceCode"]),
                                Size = Convert.ToString(idr["Size"]),
                                Weight = Convert.ToDecimal(idr["Weight"]),
                                UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                                Numbers = Convert.ToInt32(idr["Numbers"]),
                                CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                InHousePrice = Convert.ToDecimal(idr["InHousePrice"]),
                                NextDayPrice = Convert.ToDecimal(idr["NextDayPrice"]),
                                //SalePriceClient = goods.ActSalePrice,//上一销售价
                                //OrderNo = goods.OrderNo,
                                //PayClientName = goods.PayClientName,
                                Package = Convert.ToString(idr["Package"]),
                                PackageNum = Convert.ToInt32(idr["PackageNum"]),
                                PackageWeight = Convert.ToDecimal(idr["PackageWeight"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                Born = Convert.ToString(idr["Born"]),
                                BatchYear = Convert.ToInt32(idr["BatchYear"]),
                                BatchWeek = Convert.ToInt32(idr["BatchWeek"]),
                                BelongDepart = Convert.ToString(idr["BelongDepart"]),
                                SourceOrderNo = Convert.ToString(idr["SourceOrderNo"]),
                                SpecsType = Convert.ToString(idr["SpecsType"]),
                                Supplier = Convert.ToString(idr["Supplier"]),
                                SuppClientNum = Convert.ToInt32(idr["SuppClientNum"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                UpClientID = Convert.ToInt32(idr["UpClientID"]),
                                UpClientShortName = Convert.ToString(idr["UpClientShortName"]),
                                IsLockStock = Convert.ToString(idr["IsLockStock"]),
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public List<CargoContainerShowEntity> QueryALLHouseData(int pIndex, int pNum, CargoContainerShowEntity entity)
        {
            CargoProductManager pro = new CargoProductManager();
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            try
            {
                string OrderByHouseStr = string.Empty;
                if (!string.IsNullOrEmpty(entity.OrderByHouseID))
                {
                    OrderByHouseStr = " case when a.HouseID=" + entity.OrderByHouseID + " then 0  else 1 end asc,";
                }
                string strSQL = @" SELECT TOP " + pNum + " * from (SELECT ROW_NUMBER() OVER (ORDER BY " + OrderByHouseStr + " a.TypeID,a.Specs, a.Figure asc,a.BatchYear asc,a.BatchWeek asc,b.piece ASC) AS RowNumber,b.ID,c.ContainerID,c.ContainerCode,c.ContainerType,b.Piece,d.AreaID,d.Name as AreaName,d.ParentID,e.Name as HouseName,e.HouseCode,e.BelongHouse,f.TypeName,f.ParentID as TypeParentID,m.SourceName,m.SourceCode,k.TypeName as TypeParentName,a.*,h.Name as FirstAreaName,h.AreaID as FirstAreaID,g.Name as ParentAreaName,g.AreaID as ParentAreaID,h.Longitude,h.Latitude,h.OrderCode,h.OrderDep from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID left join Tbl_Cargo_ProductSource as m on a.Source=m.Source inner join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID ";
                strSQL += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID left join Tbl_Cargo_Area as h on g.ParentID=h.AreaID ";
                strSQL += " left join Tbl_Cargo_House as e on d.HouseID=e.HouseID left join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID left join Tbl_Cargo_ProductType as k on f.ParentID=k.TypeID  where (1=1) and b.Piece<>0";
                if (!entity.FirstAreaID.Equals(0)) { strSQL += " and h.AreaID = " + entity.FirstAreaID + ""; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //以产品名称为查询条件
                if (entity.HouseID.Equals(62))
                {
                    if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                }
                else
                {
                    if (!string.IsNullOrWhiteSpace(entity.Specs))
                    {
                        string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "").Replace("L", "").Replace("T", "");
                        if (res.Length <= 3 || res.ToUpper().Contains("X"))
                        {
                            if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
                        }
                        if (res.Length > 3 && res.Length <= 5)
                        {
                            strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                        }
                        if (res.Length > 5)
                        {
                            strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '" + entity.Specs + "')";
                        }
                    }
                }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strSQL += " and f.ParentID=" + entity.TypeParentID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                else if (!string.IsNullOrEmpty(entity.TypeIDs)) { strSQL += " and a.TypeID in (" + entity.TypeIDs + ")"; }
                if (!entity.ProductID.Equals(0)) { strSQL += " and a.ProductID=" + entity.ProductID; }
                if (!entity.TreadWidth.Equals(0)) { strSQL += " and a.TreadWidth=" + entity.TreadWidth; }
                if (!entity.TradePrice.Equals(0)) { strSQL += " and a.TradePrice=" + entity.TradePrice; }
                if (!entity.SalePrice.Equals(0)) { strSQL += " and a.SalePrice<=" + entity.SalePrice; }
                if (!entity.FlatRatio.Equals(0)) { strSQL += " and a.FlatRatio=" + entity.FlatRatio; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch = '" + entity.Batch + "'"; }
                if (!string.IsNullOrEmpty(entity.Born)) { strSQL += " and a.Born = '" + entity.Born + "'"; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.BelongDepart)) { strSQL += " and a.BelongDepart = '" + entity.BelongDepart + "'"; }
                if (!entity.BatchYear.Equals(0)) { strSQL += " and a.BatchYear=" + entity.BatchYear; }
                if (!entity.BatchWeek.Equals(0))
                {
                    if (entity.PriceType.Equals(0))
                    {
                        //半年前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-6,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(1))
                    {
                        //一年前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-12,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(2))
                    {
                        //10个月前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(month,-10,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                    else if (entity.PriceType.Equals(3))
                    {
                        //30周前
                        strSQL += " and ((a.BatchWeek<DATEPART(week,DATEADD(WEEK,-30,getdate())) and BatchYear=" + entity.BatchWeek + ") or (BatchYear<" + entity.BatchWeek + "))";
                    }
                }
                if (!entity.HubDiameter.Equals(0)) { strSQL += " and a.HubDiameter=" + entity.HubDiameter; }
                if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex='" + entity.LoadIndex + "'"; }
                if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel = '" + entity.SpeedLevel + "'"; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and e.HouseID=@HouseID"; }
                if (!string.IsNullOrEmpty(entity.HouseIDStr)) { strSQL += " and e.HouseID in (" + entity.HouseIDStr + ")"; }
                if (!entity.ParentAreaID.Equals(0)) { strSQL += " and d.ParentID=" + entity.ParentAreaID + ""; }
                if (!string.IsNullOrEmpty(entity.ContainerCode)) { strSQL += " and c.ContainerCode=@ContainerCode"; }
                if (!string.IsNullOrEmpty(entity.ContainerType)) { strSQL += " and c.ContainerType=@ContainerType"; }
                //锁定库存
                if (!string.IsNullOrEmpty(entity.IsLockStock)) { strSQL += " and a.IsLockStock='" + entity.IsLockStock + "'"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //所属公司
                if (!string.IsNullOrEmpty(entity.Company)) { strSQL += " and a.Company = '" + entity.Company + "'"; }
                //规格类型
                if (!string.IsNullOrEmpty(entity.SpecsType)) { strSQL += " and a.SpecsType='" + entity.SpecsType + "'"; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!entity.HouseID.Equals(0)) { conn.AddInParameter(cmdAdd, "@HouseID", DbType.Int32, entity.HouseID); }
                    if (!string.IsNullOrEmpty(entity.ContainerCode))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    }
                    if (!string.IsNullOrEmpty(entity.ContainerType))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerType", DbType.String, entity.ContainerType);
                    }
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                Piece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InPiece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InHouseTime = Convert.ToDateTime(idr["InHouseTime"]),//入库时间
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                FirstAreaName = Convert.ToString(idr["FirstAreaName"]),
                                FirstAreaID = Convert.ToInt32(idr["FirstAreaID"]),
                                OrderCode = Convert.ToString(idr["OrderCode"]),
                                OrderDep = Convert.ToString(idr["OrderDep"]),
                                ParentAreaID = Convert.ToInt32(idr["ParentAreaID"]),
                                Longitude = Convert.ToString(idr["Longitude"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                ParentAreaName = Convert.ToString(idr["ParentAreaName"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseCode = Convert.ToString(idr["HouseCode"]),
                                BelongHouse = Convert.ToString(idr["BelongHouse"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                TypeParentID = Convert.ToInt32(idr["TypeParentID"]),
                                TypeParentName = Convert.ToString(idr["TypeParentName"]),//proTypeList.Count > 0 ? proTypeList[0].TypeName : "",
                                Model = Convert.ToString(idr["Model"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                                Meridian = Convert.ToString(idr["Meridian"]),
                                HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = Convert.ToInt32(idr["SpeedMax"]),
                                Source = Convert.ToString(idr["Source"]),
                                SourceName = Convert.ToString(idr["SourceName"]),
                                SourceCode = Convert.ToString(idr["SourceCode"]),
                                Size = Convert.ToString(idr["Size"]),
                                Weight = Convert.ToDecimal(idr["Weight"]),
                                UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                                Numbers = Convert.ToInt32(idr["Numbers"]),
                                CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                Package = Convert.ToString(idr["Package"]),
                                PackageNum = Convert.ToInt32(idr["PackageNum"]),
                                PackageWeight = Convert.ToDecimal(idr["PackageWeight"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                Born = Convert.ToString(idr["Born"]),
                                BatchYear = Convert.ToInt32(idr["BatchYear"]),
                                BatchWeek = Convert.ToInt32(idr["BatchWeek"]),
                                BelongDepart = Convert.ToString(idr["BelongDepart"]),
                                SourceOrderNo = Convert.ToString(idr["SourceOrderNo"]),
                                SpecsType = Convert.ToString(idr["SpecsType"]),
                                Supplier = Convert.ToString(idr["Supplier"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                //Thumbnail = Convert.ToString(idr["Thumbnail"]),
                                //DetailDrawing = Convert.ToString(idr["DetailDrawing"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 给小程序使用，按ProductCode汇总库存数据查询库存数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryHouseStockDataMiniPro(int pIndex, int pNum, CargoContainerShowEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();

            //string strSQL = @" SELECT TOP " + pNum + " * from (SELECT ROW_NUMBER() OVER (ORDER BY a.TypeID,b.Specs ASC) AS RowNumber,a.TypeID,c.TypeName,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,b.SalePrice,b.BatchYear,b.ProductCode,b.Supplier,b.SuppClientNum,b.SupplierAddress,b.HouseID,d.Thumbnail,SUM(a.Piece) as Piece,b.SpecsType,ISNULL(e.AccessCount,0) as AccessCount From Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID = b.ProductID and a.TypeID = b.TypeID inner join Tbl_Cargo_ProductType as c on c.TypeID = b.TypeID inner join Tbl_Cargo_ProductSpec as d on b.ProductCode = d.ProductCode left join Tbl_Cargo_ProductAccessCount as e on b.HouseID=e.HouseID and b.ProductCode=e.ProductCode and b.SuppClientNum=e.SuppClientNum where (1=1) and a.Piece>0";

            string strSQL = @" SELECT TOP " + pNum + " * from (SELECT ROW_NUMBER() OVER  ";
            //HouseIDASC
            strSQL += " ( ORDER BY";
            if (!string.IsNullOrEmpty(entity.HouseIDASC))
            {
                strSQL += @" CASE WHEN a.HouseID =" + entity.HouseIDASC + " THEN 0 ELSE 1 END ASC,";
            }
            if (entity.HouseID.Equals(101))
            {
                //汕头云仓的自定义排序规则驰风和康佩森居前
                strSQL += "  case when a.TypeID=648 then 0 when a.TypeID=582 then 1 when a.TypeID=539 then 1 else 2 end asc, a.AccessCount desc ";
            }
            //else if (entity.HouseID.Equals(93))
            //{
            //    //东平云仓的自定义排序规则康佩森居前
            //    strSQL += " (ORDER BY case when a.TypeID=582 then 0 when a.TypeID=539 then 0 else 1 end asc, a.AccessCount desc )";
            //}
            else
            {
                strSQL += "  case when a.TypeID=648 then 0 when a.TypeID=582 then 1 when a.TypeID=539 then 1 else 2 end asc, a.AccessCount desc ";
                //strSQL += " (ORDER BY a.AccessCount desc )";
            }
            strSQL += " )";
            strSQL += " AS RowNumber,* from (select ROW_NUMBER() over (partition by b.HouseID,b.ProductCode,b.BatchYear,b.SuppClientNum order by b.SalePrice desc,b.Batch asc) as RN,SUM(a.Piece) over (partition by b.HouseID,b.ProductCode,b.BatchYear,b.SuppClientNum) as Piece,a.TypeID,c.TypeName,c.ParentID as TypeParentID,d.Specs,d.Figure,d.LoadIndex,d.SpeedLevel,d.ProductName,b.SalePrice,b.NextDayPrice,b.InHousePrice,b.BatchYear,b.ProductCode,b.Supplier,b.SuppClientNum,b.SupplierAddress,b.HouseID,d.Thumbnail,b.SpecsType,ISNULL(e.AccessCount,0) as AccessCount,ISNULL( f.NextDayLogisFee, 0 ) AS NextDayLogisFee,f.Name as HouseName  From Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID = b.ProductID and a.TypeID = b.TypeID inner join Tbl_Cargo_ProductType as c on c.TypeID = b.TypeID inner join Tbl_Cargo_ProductSpec as d on b.ProductCode = d.ProductCode left join Tbl_Cargo_ProductAccessCount as e on b.HouseID=e.HouseID and b.ProductCode=e.ProductCode and b.SuppClientNum=e.SuppClientNum  INNER JOIN Tbl_Cargo_House AS f ON b.HouseID = f.HouseID where (1=1) and a.Piece>0";
            if (!string.IsNullOrWhiteSpace(entity.Specs))
            {
                string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "").Replace("L", "").Replace("T", "");
                if (res.Length <= 3 || res.ToUpper().Contains("X"))
                {
                    if (!string.IsNullOrEmpty(res)) { strSQL += " and b.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strSQL += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or b.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
                if (res.Length > 5)
                {
                    strSQL += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or b.Specs like '" + entity.Specs + "')";
                }
            }

            //以一级类型ID为查询条件
            if (!entity.TypeParentID.Equals(0)) { strSQL += " and c.ParentID  =" + entity.TypeParentID; }
            if (!string.IsNullOrEmpty(entity.WXTypeParentID)) { strSQL += " and c.ParentID  in (" + entity.WXTypeParentID + ")"; }

            //二级类型ID
            if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID=" + entity.HouseID; }
            if (!entity.BatchYear.Equals(0)) { strSQL += " and b.BatchYear=" + entity.BatchYear; }
            if (!entity.SalePrice.Equals(0)) { strSQL += " and b.SalePrice>" + entity.SalePrice; }
            if (!string.IsNullOrEmpty(entity.HouseIDStr)) { strSQL += " and b.HouseID in (" + entity.HouseIDStr + ")"; }
            //锁定库存
            if (!string.IsNullOrEmpty(entity.SpecsType)) { strSQL += " and b.SpecsType='" + entity.SpecsType + "'"; }
            if (!string.IsNullOrEmpty(entity.IsLockStock)) { strSQL += " and b.IsLockStock='" + entity.IsLockStock + "'"; }
            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and b.ProductCode='" + entity.ProductCode + "'"; }
            if (!entity.SuppClientNum.Equals(0)) { strSQL += " and b.SuppClientNum  =" + entity.SuppClientNum; }

            strSQL += " ) as a where a.RN=1 ";
            strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
            using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoContainerShowEntity
                        {
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            Specs = Convert.ToString(idr["Specs"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            Piece = Convert.ToInt32(idr["Piece"]),
                            SalePrice = Convert.ToDecimal(idr["SalePrice"]),//小程序价
                            InHousePrice = Convert.ToDecimal(idr["InHousePrice"]),//进仓价
                            BatchYear = Convert.ToInt32(idr["BatchYear"]),
                            Supplier = Convert.ToString(idr["Supplier"]),
                            SuppClientNum = Convert.ToInt32(idr["SuppClientNum"]),
                            SupplierAddress = Convert.ToString(idr["SupplierAddress"]),
                            ProductCode = Convert.ToString(idr["ProductCode"]),
                            SpecsType = Convert.ToString(idr["SpecsType"]),
                            Thumbnail = Convert.ToString(idr["Thumbnail"]),
                            Star = Convert.ToInt32(idr["AccessCount"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            HouseName = Convert.ToString(idr["HouseName"]),
                            NextDayLogisFee = Convert.ToDecimal(idr["NextDayLogisFee"]),
                            ProductName = Convert.ToString(idr["ProductName"]),
                            TypeParentID = Convert.ToInt32(idr["TypeParentID"]),
                            NextDayPrice = Convert.ToDecimal(idr["NextDayPrice"]),//云仓二批客户批发价
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 小程序特价促销商品查询方法
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryReduceSaleMiniPro(int pIndex, int pNum, CargoContainerShowEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();

            string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() over (order by la.AccessCount desc) as RowNumber,* from (select ROW_NUMBER() over (partition by b.HouseID,b.ProductCode,b.BatchYear,b.SuppClientNum order by b.ProductPrice desc,b.Batch asc) as RN,SUM(b.OnSaleNum) over (partition by b.HouseID,b.ProductCode,b.BatchYear,b.SuppClientNum) as TotalPiece,b.* from (select  DISTINCT  a.ID,a.OnSaleNum,a.ProductPrice,d.TypeName,d.ParentID as TypeParentID,b.ProductCode,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,b.GoodsCode,b.Thumbnail,b.ProductName,c.Batch,c.BatchYear,c.BatchWeek,c.SuppClientNum,c.Supplier,c.SupplierAddress,c.SpecsType,c.InHousePrice,c.SalePrice,c.HouseID,c.TypeID,ISNULL(f.AccessCount,0) as AccessCount,g.Name as HouseName,g.NextDayLogisFee from Tbl_Cargo_Shelves as a inner join Tbl_Cargo_ProductSpec as b on a.ProductCode=b.ProductCode inner join Tbl_Cargo_Product as c on a.ProductID=c.ProductID inner join Tbl_Cargo_ProductType as d on b.TypeID=d.TypeID inner join Tbl_Cargo_ContainerGoods as e on a.ProductID=e.ProductID inner join Tbl_Cargo_House as g on c.HouseID=g.HouseID left join Tbl_Cargo_ProductAccessCount as f on c.HouseID=f.HouseID and b.ProductCode=f.ProductCode and c.SuppClientNum=f.SuppClientNum where a.SaleType=1 ";
            if (!string.IsNullOrWhiteSpace(entity.Specs))
            {
                string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "").Replace("L", "").Replace("T", "");
                if (res.Length <= 3 || res.ToUpper().Contains("X"))
                {
                    if (!string.IsNullOrEmpty(res)) { strSQL += " and b.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strSQL += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or b.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
                if (res.Length > 5)
                {
                    strSQL += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or b.Specs like '" + entity.Specs + "')";
                }
            }

            //以一级类型ID为查询条件
            if (!entity.TypeParentID.Equals(0)) { strSQL += " and d.ParentID  =" + entity.TypeParentID; }
            if (!string.IsNullOrEmpty(entity.WXTypeParentID)) { strSQL += " and d.ParentID  in (" + entity.WXTypeParentID + ")"; }

            //二级类型ID
            if (!entity.TypeID.Equals(0)) { strSQL += " and b.TypeID=" + entity.TypeID; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and c.HouseID=" + entity.HouseID; }
            if (!entity.BatchYear.Equals(0)) { strSQL += " and c.BatchYear=" + entity.BatchYear; }
            if (!entity.SalePrice.Equals(0)) { strSQL += " and c.SalePrice>" + entity.SalePrice; }
            if (!entity.ProductPrice.Equals(0)) { strSQL += " and a.ProductPrice>" + entity.ProductPrice; }
            if (!string.IsNullOrEmpty(entity.HouseIDStr)) { strSQL += " and c.HouseID in (" + entity.HouseIDStr + ")"; }
            //锁定库存
            if (!string.IsNullOrEmpty(entity.SpecsType)) { strSQL += " and c.SpecsType='" + entity.SpecsType + "'"; }
            if (!string.IsNullOrEmpty(entity.IsLockStock)) { strSQL += " and c.IsLockStock='" + entity.IsLockStock + "'"; }
            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and b.ProductCode='" + entity.ProductCode + "'"; }
            if (!entity.SuppClientNum.Equals(0)) { strSQL += " and c.SuppClientNum  =" + entity.SuppClientNum; }

            //strSQL += " ) as a where a.RN=1 ";
            strSQL += " ) as b ) as la where la.RN=1 ) as ot  where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
            using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoContainerShowEntity
                        {
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            Specs = Convert.ToString(idr["Specs"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            Piece = Convert.ToInt32(idr["TotalPiece"]),//上架销售的数量
                            SalePrice = Convert.ToDecimal(idr["ProductPrice"]),//上架设置的销售价
                            InHousePrice = Convert.ToDecimal(idr["InHousePrice"]),
                            BatchYear = Convert.ToInt32(idr["BatchYear"]),
                            Supplier = Convert.ToString(idr["Supplier"]),
                            SuppClientNum = Convert.ToInt32(idr["SuppClientNum"]),
                            SupplierAddress = Convert.ToString(idr["SupplierAddress"]),
                            ProductCode = Convert.ToString(idr["ProductCode"]),
                            SpecsType = Convert.ToString(idr["SpecsType"]),
                            Thumbnail = Convert.ToString(idr["Thumbnail"]),
                            Star = Convert.ToInt32(idr["AccessCount"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            HouseName = Convert.ToString(idr["HouseName"]),
                            NextDayLogisFee = Convert.ToDecimal(idr["NextDayLogisFee"]),
                            ProductName = Convert.ToString(idr["ProductName"]),
                            TypeParentID = Convert.ToInt32(idr["TypeParentID"]),
                        });
                    }
                }
            }
            return result;
        }



        /// <summary>
        /// 查询某客户上一成交订单的某一规格花纹产品的销售价格
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        private CargoOrderGoodsEntity QueryPrevOrderInfo(CargoOrderEntity entity)
        {
            CargoOrderGoodsEntity result = new CargoOrderGoodsEntity();
            result.EnSafe();
            string strSQL = "select top 1 b.OrderNo,b.ActSalePrice,a.PayClientName From Tbl_Cargo_Order as a inner join Tbl_Cargo_OrderGoods as b on a.OrderNo=b.OrderNo inner join Tbl_Cargo_Product as c on b.ProductID=c.ProductID and b.HouseID = c.HouseID where (1=1) and a.ThrowGood<>1";
            if (!entity.PayClientNum.Equals(0)) { strSQL += " and a.PayClientNum= " + entity.PayClientNum; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and a.OrderModel='" + entity.OrderModel + "'"; }
            if (!entity.TypeID.Equals(0)) { strSQL += " and c.TypeID =" + entity.TypeID; }
            if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and c.Specs='" + entity.Specs + "'"; }
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and c.Figure='" + entity.Figure + "'"; }
            if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and c.LoadIndex='" + entity.LoadIndex + "'"; }
            if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and c.SpeedLevel='" + entity.SpeedLevel.Trim() + "'"; }
            strSQL += " order by CreateDate desc";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result = new CargoOrderGoodsEntity
                        {
                            OrderNo = Convert.ToString(idr["OrderNo"]),
                            ActSalePrice = Convert.ToDecimal(idr["ActSalePrice"]),
                            PayClientName = Convert.ToString(idr["PayClientName"])
                        };
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询上一进货单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        private CargoOrderGoodsEntity QueryPrePurchaseOrderInfo(CargoOrderEntity entity)
        {
            CargoOrderGoodsEntity result = new CargoOrderGoodsEntity();
            result.EnSafe();
            string strSQL = "select top 1 a.*,b.AcceptUnit,b.AcceptPeople From Tbl_Cargo_PurchaseOrderGoods as a inner join Tbl_Cargo_PurchaseOrder as b on a.OrderID=b.OrderID where (1=1)";
            //if (!entity.PayClientNum.Equals(0)) { strSQL += " and a.PayClientNum= " + entity.PayClientNum; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID =" + entity.HouseID; }
            //if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and a.OrderModel='" + entity.OrderModel + "'"; }
            if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID =" + entity.TypeID; }
            if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs='" + entity.Specs + "'"; }
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure='" + entity.Figure + "'"; }
            if (!string.IsNullOrEmpty(entity.LoadIndex)) { strSQL += " and a.LoadIndex='" + entity.LoadIndex + "'"; }
            if (!string.IsNullOrEmpty(entity.SpeedLevel)) { strSQL += " and a.SpeedLevel='" + entity.SpeedLevel.Trim() + "'"; }
            strSQL += " order by a.OP_DATE desc";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result = new CargoOrderGoodsEntity
                        {
                            UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                            PurchaserName = Convert.ToString(idr["AcceptPeople"])
                        };
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询所有产品数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> PreQueryALLProduct(CargoContainerShowEntity entity)
        {
            CargoProductManager pro = new CargoProductManager();
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            try
            {
                string strSQL = @"select b.ID,c.ContainerID,c.ContainerCode,c.ContainerType,b.InHouseTime,b.Piece,d.AreaID,d.Name as AreaName,d.ParentID,e.HouseID,e.Name as HouseName,e.HouseCode,f.TypeName,f.ParentID as TypeParentID,pp.CostPriceStore,k.TypeName as TypeParentName,a.* from Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID left join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID LEFT JOIN (select * from Tbl_Cargo_ProductPrice where PriceType=" + entity.PriceType + ") pp on a.GoodsCode=pp.ProductCode";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID";
                }
                strSQL += " left join Tbl_Cargo_House as e on d.HouseID=e.HouseID left join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID left join Tbl_Cargo_ProductType as k on f.ParentID=k.TypeID where (1=1) ";
                if (!entity.FirstAreaID.Equals(0))
                {
                    strSQL += " and g.ParentID=" + entity.FirstAreaID + "";
                }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and a.ProductName like '%" + entity.ProductName + "%'"; }
                //富添盛编码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strSQL += " and f.ParentID=" + entity.TypeParentID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                if (!entity.ProductID.Equals(0)) { strSQL += " and a.ProductID=" + entity.ProductID; }
                if (!entity.SalePrice.Equals(0)) { strSQL += " and a.SalePrice<=" + entity.SalePrice; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and e.HouseID=@HouseID"; }
                if (!entity.ParentAreaID.Equals(0)) { strSQL += " and d.ParentID=" + entity.ParentAreaID + ""; }
                if (!string.IsNullOrEmpty(entity.ContainerCode)) { strSQL += " and c.ContainerCode=@ContainerCode"; }
                if (!string.IsNullOrEmpty(entity.ContainerType)) { strSQL += " and c.ContainerType=@ContainerType"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                strSQL += " order by a.Figure asc,a.BatchYear asc,a.BatchWeek asc";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!entity.HouseID.Equals(0)) { conn.AddInParameter(cmdAdd, "@HouseID", DbType.Int32, entity.HouseID); }
                    if (!string.IsNullOrEmpty(entity.ContainerCode))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerCode", DbType.String, entity.ContainerCode);
                    }
                    if (!string.IsNullOrEmpty(entity.ContainerType))
                    {
                        conn.AddInParameter(cmdAdd, "@ContainerType", DbType.String, entity.ContainerType);
                    }
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        DataTable newData = dt.Clone();

                        for (int i = 0; i < dt.Rows.Count; i++)
                        {
                            DataRow drNew = newData.NewRow();
                            DataRow[] NewRows = newData.Select("GoodsCode='" + dt.Rows[i]["GoodsCode"].ToString() + "'");
                            if (NewRows.Count() <= 0)
                            {
                                newData.Rows.Add(dt.Rows[i].ItemArray);
                            }
                            else
                            {
                                for (int j = 0; j < NewRows.Length; j++)
                                {
                                    DataRow drEmployee = NewRows[j];
                                    drEmployee.BeginEdit();
                                    drEmployee["Piece"] = Convert.ToInt32(NewRows[0]["Piece"]) + Convert.ToInt32(dt.Rows[i]["Piece"]);
                                    drEmployee.EndEdit();
                                }
                            }
                        }

                        foreach (DataRow idr in newData.Rows)
                        {
                            CargoAreaEntity cargoArea = new CargoAreaEntity();
                            CargoAreaEntity hArea = new CargoAreaEntity();
                            //如果父ID不为0，则查询父ID的区域名称
                            if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            {
                                cargoArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                                if (!cargoArea.ParentID.Equals(0))
                                {
                                    hArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                                }
                            }
                            //List<CargoProductTypeEntity> proTypeList = pro.QueryProductType(new CargoProductTypeEntity { TypeID = Convert.ToInt32(idr["TypeParentID"]) });
                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                Piece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InPiece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InHouseTime = Convert.ToDateTime(idr["InHouseTime"]),//入库时间
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                FirstAreaName = hArea.Name,
                                FirstAreaID = hArea.AreaID,
                                OrderCode = hArea.OrderCode,
                                OrderDep = hArea.OrderDep,
                                ParentAreaID = cargoArea.AreaID,
                                ParentAreaName = cargoArea.Name,
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseCode = Convert.ToString(idr["HouseCode"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                TypeParentID = Convert.ToInt32(idr["TypeParentID"]),
                                TypeParentName = Convert.ToString(idr["TypeParentName"]), //proTypeList.Count > 0 ? proTypeList[0].TypeName : "",
                                Model = Convert.ToString(idr["Model"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                                Meridian = Convert.ToString(idr["Meridian"]),
                                HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = Convert.ToInt32(idr["SpeedMax"]),
                                Source = Convert.ToString(idr["Source"]),
                                Size = Convert.ToString(idr["Size"]),
                                Weight = Convert.ToDecimal(idr["Weight"]),
                                UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                                Numbers = Convert.ToInt32(idr["Numbers"]),
                                CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                CostPriceStore = string.IsNullOrEmpty(idr["CostPriceStore"].ToString()) ? 0.00M : Convert.ToDecimal(idr["CostPriceStore"]),
                                Package = Convert.ToString(idr["Package"]),
                                PackageNum = Convert.ToInt32(idr["PackageNum"]),
                                PackageWeight = Convert.ToDecimal(idr["PackageWeight"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                BatchYear = Convert.ToInt32(idr["BatchYear"]),
                                BatchWeek = Convert.ToInt32(idr["BatchWeek"]),
                                SourceOrderNo = Convert.ToString(idr["SourceOrderNo"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

            return result;

        }
        /// <summary>
        /// 保存出库单数据
        /// </summary>
        /// <param name="entity"></param>
        public void saveOutCargoData(List<CargoContainerShowEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"INSERT INTO Tbl_Cargo_OutContainerGoods(ContainerID,TypeID,ProductID,Piece,Weight,OutHouseTime,IsPrintOutCargo,OutCargoID) VALUES (@ContainerID,@TypeID,@ProductID,@Piece,@Weight,@OutHouseTime,@IsPrintOutCargo,@OutCargoID)";



                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, it.ContainerID);
                        conn.AddInParameter(cmd, "@TypeID", DbType.Int32, it.TypeID);
                        conn.AddInParameter(cmd, "@ProductID", DbType.Int32, it.ProductID);
                        conn.AddInParameter(cmd, "@Piece", DbType.Int32, it.Piece);
                        conn.AddInParameter(cmd, "@Weight", DbType.Decimal, it.Weight);
                        conn.AddInParameter(cmd, "@OutHouseTime", DbType.DateTime, DateTime.Now);
                        conn.AddInParameter(cmd, "@IsPrintOutCargo", DbType.String, it.IsPrintOutCargo ? "1" : "0");
                        conn.AddInParameter(cmd, "@OutCargoID", DbType.String, it.OutCargoID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 打印出库单
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryNoPrintOutCargoAwbData(CargoContainerShowEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            try
            {
                string strDel = @"select b.ProductName,c.TypeName,b.Model,b.GoodsCode,b.Specs,a.Piece,d.ContainerCode,d.ContainerType,e.Name as AreaName,f.Name as HouseName,a.OutHouseTime,a.ID,a.ContainerID,a.TypeID,a.ProductID,a.OutCargoID,e.Code,e.ParentID,e.HouseID from Tbl_Cargo_OutContainerGoods as a left join Tbl_Cargo_Product as b on a.TypeID=b.TypeID and a.ProductID=b.ProductID left join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID left join Tbl_Cargo_Container as d on a.ContainerID=d.ContainerID left join Tbl_Cargo_Area as e on d.AreaID=e.AreaID  left join Tbl_Cargo_House as f on e.HouseID=f.HouseID where a.IsPrintOutCargo=@IsPrintOutCargo order by a.OutHouseTime asc,TypeName asc";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                {
                    conn.AddInParameter(cmdAdd, "@IsPrintOutCargo", DbType.String, entity.IsPrintOutCargo ? "1" : "0");
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            CargoAreaEntity cargoArea = new CargoAreaEntity();
                            //如果父ID不为0，则查询父ID的区域名称
                            if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            {
                                cargoArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                            }
                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                OutCargoID = Convert.ToString(idr["OutCargoID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                Model = Convert.ToString(idr["Model"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                OutHouseTime = Convert.ToDateTime(idr["OutHouseTime"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                FirstAreaID = cargoArea.AreaID,
                                FirstAreaName = cargoArea.Name
                            });
                        }
                    }
                }
                return result;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 查询出库单数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryOutHouseData(int pIndex, int pNum, CargoContainerShowEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,b.ContainerCode,b.ContainerType,b.AreaID,e.ParentID,e.Name as AreaName,f.Name as HouseName,c.TypeName,d.ProductName,d.Model,d.GoodsCode,d.Specs,a.* from Tbl_Cargo_OutContainerGoods as a left join Tbl_Cargo_Container as b on a.ContainerID=b.ContainerID left join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID left join Tbl_Cargo_Product as d on a.ProductID=d.ProductID left join Tbl_Cargo_Area as e on b.AreaID=e.AreaID left join Tbl_Cargo_House as f on e.HouseID=f.HouseID WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.OutCargoID)) { strSQL += " and a.OutCargoID = '" + entity.OutCargoID + "'"; }
                //出库件数
                if (!entity.Piece.Equals(0)) { strSQL += " and a.Piece = " + entity.Piece + ""; }
                if (!string.IsNullOrEmpty(entity.IsPrint)) { strSQL += " and a.IsPrintOutCargo = '" + entity.IsPrint + "'"; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            CargoAreaEntity cargoArea = new CargoAreaEntity();
                            //如果父ID不为0，则查询父ID的区域名称
                            if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            {
                                cargoArea = QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                            }
                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                OutCargoID = Convert.ToString(idr["OutCargoID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                Model = Convert.ToString(idr["Model"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                FirstAreaName = cargoArea.Name,
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                IsPrintOutCargo = Convert.ToString(idr["IsPrintOutCargo"]).Equals("0") ? false : true,
                                OutHouseTime = Convert.ToDateTime(idr["OutHouseTime"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_OutContainerGoods as a Where (1=1)";
                if (!string.IsNullOrEmpty(entity.OutCargoID)) { strCount += " and a.OutCargoID = '" + entity.OutCargoID + "'"; }
                //出库件数
                if (!entity.Piece.Equals(0)) { strCount += " and a.Piece = " + entity.Piece + ""; }
                if (!string.IsNullOrEmpty(entity.IsPrint)) { strCount += " and a.IsPrintOutCargo = '" + entity.IsPrint + "'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 通过出库单号删除出库单数据
        /// </summary>
        /// <param name="good"></param>
        public void DeleteOutCargoData(string OutCargoID)
        {
            string strSQL = @"DELETE FROM Tbl_Cargo_OutContainerGoods Where OutCargoID=@OutCargoID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@OutCargoID", DbType.String, OutCargoID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 删除出库单数据
        /// </summary>
        /// <param name="OutCargoID">出库ID</param>
        /// <param name="containID">货位ID</param>
        /// <param name="productID">产品ID</param>
        /// <param name="piece">件数</param>
        public void DeleteOutCargoData(string OutCargoID, int containID, Int64 productID, int piece)
        {
            string strSQL = @"DELETE FROM Tbl_Cargo_OutContainerGoods Where OutCargoID=@OutCargoID and ContainerID=@ContainerID and ProductID=@ProductID and Piece=@Piece";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@OutCargoID", DbType.String, OutCargoID);
                conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, containID);
                conn.AddInParameter(cmd, "@ProductID", DbType.Int64, productID);
                conn.AddInParameter(cmd, "@Piece", DbType.Int32, piece);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 通过出库单号，货位ID，产品ID修改出库数量
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateOutCargoPieceByID(CargoContainerShowEntity entity)
        {
            try
            {
                string strSQL = @"UPDATE Tbl_Cargo_OutContainerGoods SET ";
                if (entity.IsAdd) { strSQL += " Piece=Piece+@Piece"; }
                else { strSQL += " Piece=Piece-@Piece"; }
                strSQL += " Where OutCargoID=@OutCargoID and ContainerID=@ContainerID and ProductID=@ProductID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@OutCargoID", DbType.String, entity.OutCargoID);
                    conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, entity.ContainerID);
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.AddInParameter(cmd, "@Piece", DbType.Int32, entity.Piece);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion
        #region 移库管理操作方法集合
        /// <summary>
        /// 保存移库数据记录
        /// </summary>
        /// <param name="entity"></param>
        public void AddMoveContainer(CargoMoveContainerEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"INSERT INTO Tbl_Cargo_MoveContainer(OldCCode,OldCID,ProductID,NewCCode,NewCID,MoveNum,MoveStatus,HouseID,OPID) VALUES (@OldCCode,@OldCID,@ProductID,@NewCCode,@NewCID,@MoveNum,@MoveStatus,@HouseID,@OPID)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@OldCCode", DbType.String, entity.OldCCode);
                    conn.AddInParameter(cmd, "@OldCID", DbType.Int32, entity.OldCID);
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.AddInParameter(cmd, "@NewCCode", DbType.String, entity.NewCCode);
                    conn.AddInParameter(cmd, "@NewCID", DbType.Int32, entity.NewCID);
                    conn.AddInParameter(cmd, "@MoveNum", DbType.Int32, entity.MoveNum);
                    conn.AddInParameter(cmd, "@MoveStatus", DbType.String, entity.MoveStatus);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@OPID", DbType.String, entity.OPID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion
        #region 安全库存操作方法集合
        /// <summary>
        /// 查询安全库存数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoSafeStockEntity> QuerySafeStockData(CargoSafeStockEntity entity)
        {
            List<CargoSafeStockEntity> result = new List<CargoSafeStockEntity>();
            string strSQL = "";
            //将库存总数量存放到临时表中
            strSQL += @"
SELECT
  * INTO #tempALLWhs
FROM
  (
    SELECT
      b.TypeID,
      b.ProductCode,
      b.GoodsCode,
      SUM(a.Piece) AS Piece
    FROM
      Tbl_Cargo_ContainerGoods AS a
      INNER JOIN Tbl_Cargo_Product AS b ON a.ProductID = b.ProductID
    WHERE
      (1 = 1)
      AND a.Piece > 0
      AND b.SpecsType <> '5'
    GROUP BY
      b.TypeID,
      b.ProductCode,
      b.GoodsCode
  ) a;
";

            strSQL += @"SELECT
  a.*,
  ISNULL(b.Piece, 0) AS CurNum,
  ISNULL(c.SaleNum, 0) AS SaleNum,
  ISNULL(c2.SaleNum, 0) AS WXSaleNum,
  ISNULL(b2.Piece, 0) AS TotalNum,
  ISNULL(c3.SaleNum, 0) AS TotalSaleNum,
  ISNULL(d.Piece, 0) AS MoveNum,
  --0 AS TotalSaleNum,
  CASE
    WHEN a.StockNum - ISNULL(b.Piece, 0) <= 0 THEN 0
    ELSE a.StockNum - ISNULL(b.Piece, 0)
  END AS LessNum
FROM";
            #region a 表 Tbl_Cargo_SafeStock 安全库存主数据
            strSQL += @"
  (
    SELECT
      s.SID,
      s.HouseID,
      h.Name AS HouseName,
      s.AreaID,
      a.Name AS AreaName,
      pt.ParentID,
      pt.TypeParentName AS ParentName,
      s.TypeID,
      pt.TypeName,
      s.Specs,
      s.Figure,
      s.GoodsCode,
      s.LoadIndex,
      s.SpeedLevel,
      s.StockNum,
      s.MaxStock,
      s.MinStock,
      s.OPID,
      s.OP_DATE,
      s.ProductCode
    FROM
      Tbl_Cargo_SafeStock s
      INNER JOIN Tbl_Cargo_House h ON s.HouseID = h.HouseID
      INNER JOIN Tbl_Cargo_Area a ON s.AreaID = a.AreaID
      INNER JOIN Tbl_Cargo_ProductType pt ON s.TypeID = pt.TypeID
    WHERE
      (1 = 1)";

            if (!string.IsNullOrEmpty(entity.HouseID)) { strSQL += " and s.HouseID  in (" + entity.HouseID + ")"; }
            if (!string.IsNullOrEmpty(entity.ParamAreaID)) { strSQL += " and a.AreaID in( " + entity.ParamAreaID + ")"; }
            else if (entity.AreaID != 0) { strSQL += " and a.AreaID = " + entity.AreaID; }
            //if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and s.Specs like '%" + entity.Specs + "%'"; }
            if (!string.IsNullOrWhiteSpace(entity.Specs))
            {
                string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                if (res.Length <= 3)
                {
                    if (!string.IsNullOrEmpty(res)) { strSQL += " and s.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strSQL += " and (s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or s.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
                if (res.Length > 5)
                {
                    strSQL += " and (s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or s.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or s.Specs like '" + entity.Specs + "')";
                }
            }
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and s.Figure like '%" + entity.Figure + "%'"; }
            if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and s.GoodsCode like '%" + entity.GoodsCode + "%'"; }
            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and s.ProductCode like '%" + entity.ProductCode + "%'"; }
            if (entity.TypeID != 0) { strSQL += " and s.TypeID = " + entity.TypeID; }
            if (entity.ParentID != 0) { strSQL += " and pt.ParentID = " + entity.ParentID; }

            strSQL += ") AS a";
            #endregion

            #region b表 Tbl_Cargo_ContainerGoods 当前仓库在库数量
            strSQL += @"
            LEFT JOIN (
  SELECT
    b.TypeID,
    b.HouseID,
    b.ProductCode,
    SUM(a.Piece) AS Piece
  FROM
    Tbl_Cargo_ContainerGoods AS a
    INNER JOIN Tbl_Cargo_Product AS b ON a.ProductID = b.ProductID
    AND a.Piece > 0
    AND b.SpecsType != 5
    INNER JOIN Tbl_Cargo_ProductType AS c ON b.TypeID = c.TypeID
    INNER JOIN Tbl_Cargo_Container AS d ON a.ContainerID = d.ContainerID
    INNER JOIN Tbl_Cargo_Area AS e ON d.AreaID = e.AreaID
    INNER JOIN Tbl_Cargo_Area AS f ON e.ParentID = f.AreaID
    INNER JOIN Tbl_Cargo_Area AS g ON f.ParentID = g.AreaID
    AND g.IsShowStock = 0
    AND g.HouseID = b.HouseID
  WHERE
    (1 = 1)";
            if (!string.IsNullOrEmpty(entity.HouseID)) { strSQL += " and b.HouseID  in (" + entity.HouseID + ")"; }
            if (entity.AreaID != 0) { strSQL += " and g.AreaID = " + entity.AreaID; }
            //if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and b.Specs like '%" + entity.Specs + "%'"; }
            if (!string.IsNullOrWhiteSpace(entity.Specs))
            {
                string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                if (res.Length <= 3)
                {
                    if (!string.IsNullOrEmpty(res)) { strSQL += " and b.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strSQL += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or b.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
                if (res.Length > 5)
                {
                    strSQL += " and (b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or b.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or b.Specs like '" + entity.Specs + "')";
                }
            }
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and b.Figure like '%" + entity.Figure + "%'"; }
            if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and b.GoodsCode like '%" + entity.GoodsCode + "%'"; }
            //if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and b.ProductCode like '%" + entity.ProductCode + "%'"; }
            if (entity.TypeID != 0) { strSQL += " and a.TypeID = " + entity.TypeID; }
            if (entity.ParentID != 0) { strSQL += " and c.ParentID = " + entity.ParentID; }
            strSQL += " group by b.TypeID,b.HouseID,b.ProductCode ) as b on a.HouseID=b.HouseID and a.TypeID=b.TypeID and a.ProductCode=b.ProductCode";
            #endregion

            #region b2表 全国在库数量
            strSQL += @"
LEFT JOIN #tempALLWhs AS b2 ON a.ProductCode = b2.ProductCode
AND a.TypeID = b2.TypeID
AND a.GoodsCode = b2.GoodsCode
";
            #endregion

            #region c表 Tbl_Cargo_Order 当前仓库产品销量
            strSQL += @" LEFT JOIN (
  SELECT
    SUM(b.Piece) AS SaleNum,
    c.TypeID,
    c.HouseID,
    c.ProductCode
  FROM
    Tbl_Cargo_Order AS a
    INNER JOIN Tbl_Cargo_OrderGoods AS b ON a.OrderNo = b.OrderNo
    AND a.OrderModel = 0
    AND a.ThrowGood != 25 ";
            if (!string.IsNullOrEmpty(entity.HouseID)) { strSQL += " and a.HouseID  in (" + entity.HouseID + ")"; }
            //制单日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += @" INNER JOIN Tbl_Cargo_Product AS c ON b.ProductID = c.ProductID
AND b.HouseID = c.HouseID
INNER JOIN Tbl_Cargo_ProductType AS d ON c.TypeID = d.TypeID
AND c.SpecsType != 5 ";
            //if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and c.Specs like '%" + entity.Specs + "%'"; }
            if (!string.IsNullOrWhiteSpace(entity.Specs))
            {
                string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                if (res.Length <= 3)
                {
                    if (!string.IsNullOrEmpty(res)) { strSQL += " and c.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strSQL += " and (c.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or c.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
                if (res.Length > 5)
                {
                    strSQL += " and (c.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or c.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or c.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or c.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or c.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or c.Specs like '" + entity.Specs + "')";
                }
            }
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and c.Figure like '%" + entity.Figure + "%'"; }
            if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and c.GoodsCode like '%" + entity.GoodsCode + "%'"; }
            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and c.ProductCode like '%" + entity.ProductCode + "%'"; }
            if (entity.TypeID != 0) { strSQL += " and c.TypeID = " + entity.TypeID; }
            if (entity.ParentID != 0) { strSQL += " and d.ParentID = " + entity.ParentID; }
            strSQL += " group by c.TypeID,c.HouseID,c.ProductCode) as c on a.HouseID=c.HouseID and a.TypeID=c.TypeID and a.ProductCode=c.ProductCode";
            #endregion

            #region c2表 Tbl_Cargo_Order 当前仓库小程序产品销量
            strSQL += @" LEFT JOIN (
  SELECT
    SUM(b.Piece) AS SaleNum,
    c.TypeID,
    c.HouseID,
    c.ProductCode
  FROM
    Tbl_Cargo_Order AS a
    INNER JOIN Tbl_Cargo_OrderGoods AS b ON a.OrderNo = b.OrderNo
    AND a.OrderType = 4
    AND a.OrderModel = 0
    AND a.ThrowGood != 25 ";
            if (!string.IsNullOrEmpty(entity.HouseID)) { strSQL += " and a.HouseID  in (" + entity.HouseID + ")"; }
            //制单日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += @" INNER JOIN Tbl_Cargo_Product AS c ON b.ProductID = c.ProductID
AND b.HouseID = c.HouseID
INNER JOIN Tbl_Cargo_ProductType AS d ON c.TypeID = d.TypeID
AND c.SpecsType != 5 ";
            //if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and c.Specs like '%" + entity.Specs + "%'"; }
            if (!string.IsNullOrWhiteSpace(entity.Specs))
            {
                string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                if (res.Length <= 3)
                {
                    if (!string.IsNullOrEmpty(res)) { strSQL += " and c.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strSQL += " and (c.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or c.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
                if (res.Length > 5)
                {
                    strSQL += " and (c.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or c.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or c.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or c.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or c.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or c.Specs like '" + entity.Specs + "')";
                }
            }
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and c.Figure like '%" + entity.Figure + "%'"; }
            if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and c.GoodsCode like '%" + entity.GoodsCode + "%'"; }
            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and c.ProductCode like '%" + entity.ProductCode + "%'"; }
            if (entity.TypeID != 0) { strSQL += " and c.TypeID = " + entity.TypeID; }
            if (entity.ParentID != 0) { strSQL += " and d.ParentID = " + entity.ParentID; }
            strSQL += " group by c.TypeID,c.HouseID,c.ProductCode) as c2 on a.HouseID=c2.HouseID and a.TypeID=c2.TypeID and a.ProductCode=c2.ProductCode";
            #endregion

            #region c3 Tbl_Cargo_Order 产品全国销量
            strSQL += @"
LEFT JOIN (
    SELECT
      SUM(b.Piece) AS SaleNum,
      c.TypeID,
      c.ProductCode,
      c.GoodsCode
    FROM
      Tbl_Cargo_Order AS a
      INNER JOIN Tbl_Cargo_OrderGoods AS b ON a.OrderNo = b.OrderNo
      AND a.OrderModel = 0
      AND a.ThrowGood != 25
      ";
            //制单日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }

            strSQL += @"
      INNER JOIN Tbl_Cargo_Product AS c ON b.ProductID = c.ProductID
      AND b.HouseID = c.HouseID
      INNER JOIN Tbl_Cargo_ProductType AS d ON c.TypeID = d.TypeID
      AND c.SpecsType != 5
    GROUP BY
      c.TypeID,
      c.ProductCode,
      c.GoodsCode
  ) AS c3 ON a.TypeID = c3.TypeID
  AND a.ProductCode = c3.ProductCode
  AND a.GoodsCode = c3.GoodsCode
";
            #endregion


            #region d表 Tbl_Cargo_MoveOrderGood 当前仓库在途数量
            strSQL += @"
            LEFT JOIN (
SELECT
  p.ProductCode,
  p.TypeID,
  mo2.NewHouseID HouseID,
  SUM(mo.Piece - mo.NewPiece) Piece
FROM
  Tbl_Cargo_MoveOrderGood mo
  INNER JOIN Tbl_Cargo_MoveOrder mo2 ON mo2.MoveNo = mo.MoveNo
  LEFT JOIN Tbl_Cargo_Product p ON mo.ProductID = p.ProductID
  INNER JOIN Tbl_Cargo_ProductType AS pt ON p.TypeID = pt.TypeID
  INNER JOIN Tbl_Cargo_Container AS c ON mo.ContainerID = c.ContainerID
  INNER JOIN Tbl_Cargo_Area AS a ON c.AreaID = a.AreaID
  INNER JOIN Tbl_Cargo_Area AS a2 ON a.ParentID = a2.AreaID
  INNER JOIN Tbl_Cargo_Area AS a3 ON a2.ParentID = a3.AreaID AND a3.HouseID = p.HouseID
WHERE
  1 = 1
  AND mo2.MoveStatus <> 2
  AND p.ProductCode IS NOT NULL
  AND p.ProductCode <> ''
  AND a3.IsShowStock = 0";
            if (!string.IsNullOrEmpty(entity.HouseID)) { strSQL += " and mo2.NewHouseID  in (" + entity.HouseID + ")"; }
            if (entity.AreaID != 0) { strSQL += " and a3.AreaID = " + entity.AreaID; }
            //if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and b.Specs like '%" + entity.Specs + "%'"; }
            if (!string.IsNullOrWhiteSpace(entity.Specs))
            {
                string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                if (res.Length <= 3)
                {
                    if (!string.IsNullOrEmpty(res)) { strSQL += " and p.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strSQL += " and (p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or p.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
                if (res.Length > 5)
                {
                    strSQL += " and (p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or p.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or p.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or p.Specs like '" + entity.Specs + "')";
                }
            }
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and p.Figure like '%" + entity.Figure + "%'"; }
            if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and p.GoodsCode like '%" + entity.GoodsCode + "%'"; }
            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and p.ProductCode like '%" + entity.ProductCode + "%'"; }
            if (entity.TypeID != 0) { strSQL += " and pt.TypeID = " + entity.TypeID; }
            if (entity.ParentID != 0) { strSQL += " and pt.ParentID = " + entity.ParentID; }
            strSQL += " GROUP BY p.ProductCode, p.TypeID, mo2.NewHouseID) as d on a.HouseID = d.HouseID and a.TypeID = d.TypeID and a.ProductCode = d.ProductCode";
            #endregion


            strSQL += " order by a.HouseID, a.StockNum-ISNULL(b.Piece,0) desc";
            using ( DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                #region 获取数据
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoSafeStockEntity
                        {
                            SID = Convert.ToInt64(idr["SID"]),
                            HouseID = Convert.ToString(idr["HouseID"]),
                            HouseName = Convert.ToString(idr["HouseName"]),
                            AreaID = Convert.ToInt32(idr["AreaID"]),
                            AreaName = Convert.ToString(idr["AreaName"]),
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            ParentID = Convert.ToInt32(idr["ParentID"]),
                            ParentName = Convert.ToString(idr["ParentName"]),
                            Specs = Convert.ToString(idr["Specs"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            GoodsCode = Convert.ToString(idr["GoodsCode"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            ProductCode = Convert.ToString(idr["ProductCode"]),
                            MaxStock = Convert.ToInt32(idr["MaxStock"]),
                            MinStock = Convert.ToInt32(idr["MinStock"]),
                            StockNum = Convert.ToInt32(idr["StockNum"]),//安全库存数
                            LessNum = Convert.ToInt32(idr["LessNum"]),//相差数
                            CurNum = Convert.ToInt32(idr["CurNum"]),//实际库存数
                            MoveNum = Convert.ToInt32(idr["MoveNum"]), //在途库存数
                            SaleNum = Convert.ToInt32(idr["SaleNum"]),//销售数量
                            WXSaleNum = Convert.ToInt32(idr["WXSaleNum"]),//销售数量
                            OPID = Convert.ToString(idr["OPID"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                            TotalNum = Convert.ToInt32(idr["TotalNum"]), //全国实际库存数
                            TotalSaleNum = Convert.ToInt32(idr["TotalSaleNum"]), //全国销售数量

                        });
                    }
                }
                #endregion
            }
            return result;
        }
        /// <summary>
        /// 查询是否存在指定数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistSafeStockData(CargoSafeStockEntity entity)
        {
            string strSQL = @"select * from Tbl_Cargo_SafeStock where 1=1";
            if (entity.SID != -1) { strSQL += " and SID != '" + entity.SID + "'"; }
            if (!string.IsNullOrEmpty(entity.HouseID)) { strSQL += " and HouseID  in (" + entity.HouseID + ")"; }
            if (entity.AreaID != -1) { strSQL += " and AreaID = '" + entity.AreaID + "'"; }
            if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and Specs = '" + entity.Specs + "'"; }
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and Figure = '" + entity.Figure + "'"; }
            if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and GoodsCode = '" + entity.GoodsCode + "'"; }
            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and ProductCode = '" + entity.ProductCode + "'"; }
            if (entity.TypeID != default) { strSQL += " and TypeID = '" + entity.TypeID + "'"; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 新增安全库存数据
        /// </summary>
        /// <param name="entity"></param>
        public void InsertSafeStockData(CargoSafeStockEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_SafeStock (HouseID,AreaID,TypeID,GoodsCode,Specs,Figure,LoadIndex,SpeedLevel,StockNum,OPID,OP_DATE,ProductCode,MinStock,MaxStock) VALUES (@HouseID,@AreaID,@TypeID,@GoodsCode,@Specs,@Figure,@LoadIndex,@SpeedLevel,@StockNum,@OPID,@OP_DATE,@ProductCode,@MinStock,@MaxStock)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID);
                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                    conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs);
                    conn.AddInParameter(cmd, "@Figure", DbType.String, entity.Figure);
                    conn.AddInParameter(cmd, "@GoodsCode", DbType.String, entity.GoodsCode);
                    conn.AddInParameter(cmd, "@LoadIndex", DbType.String, entity.LoadIndex);
                    conn.AddInParameter(cmd, "@SpeedLevel", DbType.String, entity.SpeedLevel);
                    conn.AddInParameter(cmd, "@StockNum", DbType.Int32, entity.StockNum);
                    conn.AddInParameter(cmd, "@OPID", DbType.String, entity.OPID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@MaxStock", DbType.Int32, entity.MaxStock);
                    conn.AddInParameter(cmd, "@MinStock", DbType.Int32, entity.MinStock);
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改安全库存数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateSafeStockData(CargoSafeStockEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_SafeStock SET HouseID=@HouseID,AreaID =@AreaID,TypeID =@TypeID,Specs =@Specs,Figure =@Figure,GoodsCode =@GoodsCode,LoadIndex =@LoadIndex,SpeedLevel =@SpeedLevel,StockNum =@StockNum,OPID =@OPID,OP_DATE =@OP_DATE,MaxStock=@MaxStock,MinStock=@MinStock,ProductCode=@ProductCode WHERE SID=@SID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@SID", DbType.Int64, entity.SID);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID);
                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                    conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs);
                    conn.AddInParameter(cmd, "@Figure", DbType.String, entity.Figure);
                    conn.AddInParameter(cmd, "@GoodsCode", DbType.String, entity.GoodsCode);
                    conn.AddInParameter(cmd, "@LoadIndex", DbType.String, entity.LoadIndex);
                    conn.AddInParameter(cmd, "@SpeedLevel", DbType.String, entity.SpeedLevel);
                    conn.AddInParameter(cmd, "@StockNum", DbType.Int32, entity.StockNum);
                    conn.AddInParameter(cmd, "@OPID", DbType.String, entity.OPID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, entity.OP_DATE);
                    conn.AddInParameter(cmd, "@MaxStock", DbType.Int32, entity.MaxStock);
                    conn.AddInParameter(cmd, "@MinStock", DbType.Int32, entity.MinStock);
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除安全库存数据
        /// </summary>
        /// <param name="entity"></param>
        public void DeleteSafeStockData(List<CargoSafeStockEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_SafeStock where SID=@SID ";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@SID", DbType.Int64, it.SID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 告警库存数据查询
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoSafeStockEntity> QueryWarnStockData(CargoSafeStockEntity entity)
        {
            List<CargoSafeStockEntity> result = new List<CargoSafeStockEntity>();
            string strSQL = "select g.Name as HouseName,h.Name as AreaName,j.TypeName,f.HouseID,f.AreaID,a.TypeID,a.GoodsCode,f.Specs,f.Figure,f.ProductCode,f.LoadIndex,f.SpeedLevel,f.StockNum,SUM(b.Piece) as CurNum,SUM(b.Piece)-f.StockNum as LessNum From Tbl_Cargo_Product as a inner join Tbl_Cargo_ContainerGoods as b on a.ProductID=b.ProductID inner join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID left join Tbl_Cargo_Area as e on d.ParentID=e.AreaID right join Tbl_Cargo_SafeStock as f on f.HouseID=a.HouseID ";
            if (!entity.HouseID.Equals("9")) { strSQL += " and f.AreaID=e.ParentID"; }
            strSQL += " and f.GoodsCode=a.GoodsCode left join Tbl_Cargo_House as g on f.HouseID=g.HouseID left join Tbl_Cargo_Area as h on f.AreaID=h.AreaID left join Tbl_Cargo_ProductType as j on a.TypeID=j.TypeID where (1=1)";
            if (!string.IsNullOrEmpty(entity.HouseID)) { strSQL += " and a.HouseID  in (" + entity.HouseID + ")"; }
            if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
            if (!string.IsNullOrEmpty(entity.ParamAreaID)) { strSQL += " and e.ParentID in(" + entity.ParamAreaID + ")"; }
            else if (!entity.AreaID.Equals(0) && !entity.HouseID.Equals("9")) { strSQL += " and e.ParentID in(" + entity.AreaID + ")"; }
            strSQL += " group by a.GoodsCode,f.HouseID,f.StockNum,f.AreaID,f.Specs,f.Figure,f.ProductCode,f.LoadIndex,f.SpeedLevel,a.TypeID,g.Name,h.Name,j.TypeName order by HouseID,  SUM(b.Piece)-f.StockNum asc";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                #region 获取数据
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        if (Convert.ToInt32(idr["LessNum"]) < 0)
                        {
                            result.Add(new CargoSafeStockEntity
                            {
                                HouseName = Convert.ToString(idr["HouseName"]),
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                StockNum = Convert.ToInt32(idr["StockNum"]),
                                CurNum = Convert.ToInt32(idr["CurNum"]),
                                LessNum = Convert.ToInt32(idr["LessNum"])
                            });
                        }
                    }
                }
                #endregion
            }

            return result;
        }
        /// <summary>
        /// 查询库存
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoProductEntity> QueryStockBookData(CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            //string strSQL = "select d.TypeName,a.Specs,a.Figure,a.LoadIndex,a.SpeedLevel,SUM(ISNULL(c.Piece,0)) as Piece,sum(ISNULL(c.Piece, 0) * ISNULL(b.CostPrice, 0)) as CostPrice,sum(ISNULL(c.Piece, 0) * ISNULL(b.UnitPrice, 0)) as UnitPrice From Tbl_Cargo_ProductSpec as a left join Tbl_Cargo_Product as b on a.TypeID = b.TypeID and a.Specs = b.Specs and a.Figure = b.Figure and a.LoadIndex = b.LoadIndex and a.SpeedLevel = b.SpeedLevel ";
            //string strSQL = "select h.Name as FirstAreaName,d.TypeName,a.TypeID,a.Specs,a.Figure,a.LoadIndex,a.SpeedLevel,SUM(ISNULL(c.Piece,0)) as Piece,ISNULL(AVG(b.UnitPrice),0) as UnitPrice From Tbl_Cargo_ProductSpec as a inner join Tbl_Cargo_Product as b on a.TypeID = b.TypeID and a.Specs = b.Specs and a.Figure = b.Figure and a.LoadIndex = b.LoadIndex and a.SpeedLevel = b.SpeedLevel and a.GoodsCode=b.GoodsCode ";
            //if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID =" + entity.HouseID; }
            //strSQL += " inner join Tbl_Cargo_ContainerGoods as c on b.ProductID = c.ProductID left join Tbl_Cargo_ProductType as d on a.TypeID = d.TypeID inner join Tbl_Cargo_Container as e on c.ContainerID=e.ContainerID inner join Tbl_Cargo_Area as f on e.AreaID=f.AreaID inner join Tbl_Cargo_Area as g on f.ParentID=g.AreaID inner join Tbl_Cargo_Area as h on g.ParentID=h.AreaID where (1=1)";
            //if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID =" + entity.TypeID; }
            ////if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
            //string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
            //if (res.Length <= 3)
            //{
            //    if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
            //}
            //if (res.Length > 3 && res.Length <= 5)
            //{
            //    strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
            //}
            //if (res.Length > 5)
            //{
            //    strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '" + entity.Specs + "')";
            //}
            //if (!entity.FirstAreaID.Equals(0)) { strSQL += " and h.AreaID =" + entity.FirstAreaID; }
            ////花纹,sum(c.piece * b.SalePrice) as SalePrice
            //if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
            //strSQL += " group by d.TypeName,a.TypeID,a.Specs,a.Figure,a.LoadIndex,a.SpeedLevel,h.Name";

            string strSQL = "select * From (select RANK()over (partition by d.TypeName,a.TypeID,a.Specs,a.Figure,a.LoadIndex,a.SpeedLevel,h.Name order by b.InHouseTime desc) as RN,AVG(b.UnitPrice) over (partition by d.TypeName,a.TypeID,a.Specs,a.Figure,a.LoadIndex,a.SpeedLevel,h.Name) as AVGUnitPrice,SUM(c.Piece)over (partition by d.TypeName,a.TypeID,a.Specs,a.Figure,a.LoadIndex,a.SpeedLevel,h.Name) as Piece,h.Name as FirstAreaName,d.TypeName,a.TypeID,a.Specs,a.Figure,a.LoadIndex,a.SpeedLevel,b.UnitPrice,b.InHouseTime,b.Supplier From Tbl_Cargo_ProductSpec as a inner join Tbl_Cargo_Product as b on a.TypeID = b.TypeID and a.Specs = b.Specs and a.Figure = b.Figure and a.LoadIndex = b.LoadIndex and a.SpeedLevel = b.SpeedLevel and a.GoodsCode=b.GoodsCode ";
            if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID =" + entity.HouseID; }
            strSQL += " inner join Tbl_Cargo_ContainerGoods as c on b.ProductID = c.ProductID left join Tbl_Cargo_ProductType as d on a.TypeID = d.TypeID inner join Tbl_Cargo_Container as e on c.ContainerID=e.ContainerID inner join Tbl_Cargo_Area as f on e.AreaID=f.AreaID inner join Tbl_Cargo_Area as g on f.ParentID=g.AreaID inner join Tbl_Cargo_Area as h on g.ParentID=h.AreaID where (1=1)";
            if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID =" + entity.TypeID; }
            //if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
            string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
            if (res.Length <= 3)
            {
                if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
            }
            if (res.Length > 3 && res.Length <= 5)
            {
                strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
            }
            if (res.Length > 5)
            {
                strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '" + entity.Specs + "')";
            }
            if (!entity.FirstAreaID.Equals(0)) { strSQL += " and h.AreaID =" + entity.FirstAreaID; }
            //花纹,sum(c.piece * b.SalePrice) as SalePrice
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
            strSQL += " ) as a where a.RN=1 order by a.FirstAreaName,a.TypeName,a.Specs,a.Figure";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                #region 获取数据
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        //CargoOrderGoodsEntity goods = new CargoOrderGoodsEntity();
                        //goods = QueryPrePurchaseOrderInfo(new CargoOrderEntity { HouseID = entity.HouseID, TypeID = Convert.ToInt32(idr["TypeID"]), Specs = Convert.ToString(idr["Specs"]), Figure = Convert.ToString(idr["Figure"]), LoadIndex = Convert.ToString(idr["LoadIndex"]), SpeedLevel = Convert.ToString(idr["SpeedLevel"]) });

                        result.Add(new CargoProductEntity
                        {
                            FirstAreaName = Convert.ToString(idr["FirstAreaName"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            Specs = Convert.ToString(idr["Specs"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            InPiece = Convert.ToInt32(idr["Piece"]),
                            //CostPrice = Convert.ToInt32(idr["Piece"]).Equals(0)?0: Convert.ToDecimal(idr["CostPrice"])/ Convert.ToInt32(idr["Piece"]),
                            UnitPrice = Math.Round(Convert.ToDecimal(idr["AVGUnitPrice"]), 2),
                            SalePrice = Math.Round(Convert.ToDecimal(idr["UnitPrice"]), 2),
                            PurchaserName = Convert.ToString(idr["Supplier"]),
                            OP_DATE = Convert.ToDateTime(idr["InHouseTime"])
                            //SalePrice = Convert.ToDecimal(idr["SalePrice"])
                        });
                    }
                }
                #endregion
            }
            return result;
        }

        public CargoSafeStockEntity QueryStockDataByProductCode(CargoSafeStockEntity entity)
        {
            CargoSafeStockEntity safeStockEntity = new CargoSafeStockEntity();

            string strSQL = "select a.*,b.MinStock,b.MaxStock,b.StockNum from (select b.HouseID,b.ProductCode,SUM(a.Piece) as Piece from Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID ";
            if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and b.ProductCode='" + entity.ProductCode + "'"; }
            if (!entity.HouseIDInt.Equals(0)) { strSQL += " and b.HouseID=" + entity.HouseIDInt; }
            strSQL += "  group by b.HouseID,b.ProductCode) as a inner join Tbl_Cargo_SafeStock as b on a.ProductCode=b.ProductCode and  a.HouseID=b.HouseID";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        safeStockEntity.ProductCode = Convert.ToString(idr["ProductCode"]);
                        safeStockEntity.CurNum = Convert.ToInt32(idr["Piece"]);
                        safeStockEntity.MinStock = Convert.ToInt32(idr["MinStock"]);
                        safeStockEntity.MaxStock = Convert.ToInt32(idr["MaxStock"]);
                        safeStockEntity.StockNum = Convert.ToInt32(idr["StockNum"]);
                    }
                }
            }
            return safeStockEntity;
        }

        #endregion
        #region 基础规格管理
        /// <summary>
        /// 查询当前基础数据表中每个品牌的最大顺序号
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public int GetMaxProductCodeNum(CargoProductEntity entity)
        {
            int result = 0;
            string strSQL = @"select ISNULL(MAX(CodeNum),0) as CodeNum from Tbl_Cargo_ProductSpec where BrandCode=@BrandCode ";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@BrandCode", DbType.String, entity.BrandCode);
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    if (dd.Rows.Count > 0) { result = Convert.ToInt32(dd.Rows[0]["CodeNum"]); }
                }
            }
            return result;
        }
        public Hashtable QueryALLProductData(int pIndex, int pNum, CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY SID DESC) AS RowNumber,a.*,b.TypeName,b.ParentID,b.TypeParentName as ParentName from tbl_Cargo_ProductSpec a inner join Tbl_Cargo_ProductType b on a.TypeID=b.TypeID where (1=1)";
                string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                if (res.Length <= 3)
                {
                    if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strSQL += " and a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%'";
                }
                if (res.Length > 5)
                {
                    strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%')";
                }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and a.ProductCode like '%" + entity.ProductCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strSQL += " and a.DelFlag = '" + entity.DelFlag + "'"; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                if (!entity.ParentID.Equals(0)) { strSQL += " and b.ParentID=" + entity.ParentID; }
                if (!entity.UpClientID.Equals(0)) { strSQL += " and a.UpClientID=" + entity.UpClientID; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoProductEntity
                            {
                                SID = Convert.ToInt32(idr["SID"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                ParentID = Convert.ToInt32(idr["ParentID"]),
                                ParentName = Convert.ToString(idr["ParentName"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Model = Convert.ToString(idr["Model"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                                TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                                ProductUnit = Convert.ToString(idr["ProductUnit"]),
                                BundleNum = Convert.ToInt32(idr["BundleNum"]),
                                Born = Convert.ToString(idr["Born"]),
                                CommType = Convert.ToString(idr["CommType"]),
                                Thumbnail = Convert.ToString(idr["Thumbnail"]),
                                DetailDrawing = Convert.ToString(idr["DetailDrawing"]),
                                Assort = Convert.ToString(idr["Assort"]),
                                TyreType = Convert.ToString(idr["TyreType"]),
                                UpClientID = string.IsNullOrEmpty(Convert.ToString(idr["UpClientID"])) ? 0 : Convert.ToInt32(idr["UpClientID"]),
                                UpClientShortName = Convert.ToString(idr["UpClientShortName"]),
                                SellerAddress = Convert.ToString(idr["SellerAddress"]),
                                Seller = Convert.ToString(idr["Seller"]),
                                Manufacturer = Convert.ToString(idr["Manufacturer"]),
                                CarModel = Convert.ToString(idr["CarModel"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                Servicer = Convert.ToString(idr["Servicer"]),
                                BrandCode = Convert.ToString(idr["BrandCode"]),
                                DelFlag = Convert.ToString(idr["DelFlag"]),
                                THeight = string.IsNullOrEmpty(Convert.ToString(idr["THeight"])) ? 0 : Convert.ToInt32(idr["THeight"]),

                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from tbl_Cargo_ProductSpec a inner join Tbl_Cargo_ProductType b on a.TypeID=b.TypeID  Where (1=1)";
                if (res.Length <= 3)
                {
                    if (!string.IsNullOrEmpty(res)) { strCount += " and a.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strCount += " and a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%'";
                }
                if (res.Length > 5)
                {
                    strCount += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%')";
                }
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and a.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Model)) { strCount += " and a.Model like '%" + entity.Model + "%'"; }
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strCount += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strCount += " and a.ProductCode like '%" + entity.ProductCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strCount += " and a.DelFlag = '" + entity.DelFlag + "'"; }
                if (!entity.TypeID.Equals(0)) { strCount += " and a.TypeID=" + entity.TypeID; }
                if (!entity.UpClientID.Equals(0)) { strCount += " and a.UpClientID=" + entity.UpClientID; }
                if (!entity.ParentID.Equals(0)) { strCount += " and b.ParentID=" + entity.ParentID; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 查询基础产品数据列表
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public List<CargoProductEntity> QueryALLProductData(CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            try
            {
                string strSQL = @"select a.*,b.TypeName,b.ParentID,b.TypeParentName as ParentName,spp.UnitPrice from tbl_Cargo_ProductSpec a inner join Tbl_Cargo_ProductType b on a.TypeID=b.TypeID left join tbl_Cargo_SupplierProductPrice spp on a.ProductCode=spp.ProductCode and spp.SupplierNum='" + entity.SuppClientNum + "' where (1=1) ";
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '" + entity.Specs + "')";
                    }
                }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.C_GoodsCode)) { strSQL += " and a.GoodsCode = '" + entity.C_GoodsCode + "'"; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                if (!string.IsNullOrEmpty(entity.TypeIDStr)) { strSQL += " and a.TypeID in (" + entity.TypeIDStr + ")"; }
                if (!string.IsNullOrEmpty(entity.CommType)) { strSQL += " and a.CommType=" + entity.CommType; }
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and a.ProductCode like '%" + entity.ProductCode + "%'"; }

                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoProductEntity
                            {
                                SID = Convert.ToInt32(idr["SID"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                ProductUnit = Convert.ToString(idr["ProductUnit"]),
                                BundleNum = Convert.ToInt32(idr["BundleNum"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                ParentID = Convert.ToInt32(idr["ParentID"]),
                                PinyinName = GetSpellCode(Convert.ToString(idr["TypeName"])).ToLower(),
                                Specs = Convert.ToString(idr["Specs"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Model = Convert.ToString(idr["Model"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                                Born = Convert.ToString(idr["Born"]),
                                CommType = Convert.ToString(idr["CommType"]),
                                Thumbnail = Convert.ToString(idr["Thumbnail"]),
                                DetailDrawing = Convert.ToString(idr["DetailDrawing"]),
                                Assort = Convert.ToString(idr["Assort"]),
                                SalePrice = string.IsNullOrEmpty(Convert.ToString(idr["UnitPrice"])) ? 0 : Convert.ToDecimal(idr["UnitPrice"])
                            });
                        }

                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

            return result;
        }

        public Hashtable QueryPageALLProductData(int pIndex, int pNum, CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                #region 组织查询数据
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.SID ASC) AS RowNumber,  a.*,b.TypeName,b.ParentID,b.TypeParentName as ParentName,spp.UnitPrice from tbl_Cargo_ProductSpec a inner join Tbl_Cargo_ProductType b on a.TypeID=b.TypeID left join tbl_Cargo_SupplierProductPrice spp on a.ProductCode=spp.ProductCode and spp.SupplierNum='" + entity.SuppClientNum + "' where (1=1) and spp.DelFlag=0";
                if (!entity.HouseID.Equals(0)) { strSQL += " and spp.HouseID=" + entity.HouseID; }
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strSQL += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strSQL += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '" + entity.Specs + "')";
                    }
                }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.C_GoodsCode)) { strSQL += " and a.GoodsCode = '" + entity.C_GoodsCode + "'"; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
                if (!string.IsNullOrEmpty(entity.TypeIDStr)) { strSQL += " and a.TypeID in (" + entity.TypeIDStr + ")"; }
                if (!string.IsNullOrEmpty(entity.CommType)) { strSQL += " and a.CommType=" + entity.CommType; }
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and a.ProductCode like '%" + entity.ProductCode + "%'"; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoProductEntity
                            {
                                SID = Convert.ToInt32(idr["SID"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                ParentID = Convert.ToInt32(idr["ParentID"]),
                                PinyinName = GetSpellCode(Convert.ToString(idr["TypeName"])).ToLower(),
                                Specs = Convert.ToString(idr["Specs"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Model = Convert.ToString(idr["Model"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                Born = Convert.ToString(idr["Born"]),
                                CommType = Convert.ToString(idr["CommType"]),
                                Thumbnail = Convert.ToString(idr["Thumbnail"]),
                                DetailDrawing = Convert.ToString(idr["DetailDrawing"]),
                                Assort = Convert.ToString(idr["Assort"]),
                                InHousePrice = string.IsNullOrEmpty(Convert.ToString(idr["UnitPrice"])) ? 0 : Convert.ToDecimal(idr["UnitPrice"])
                            });
                        }
                    }
                }
                #endregion
                resHT["rows"] = result;
                #region 查询总数
                string strCount = @"select count(*) as TotalCount from tbl_Cargo_ProductSpec a inner join Tbl_Cargo_ProductType b on a.TypeID=b.TypeID inner join Tbl_Cargo_ProductType c on b.ParentID=c.TypeID left join tbl_Cargo_SupplierProductPrice spp on a.ProductCode=spp.ProductCode and spp.SupplierNum='" + entity.SuppClientNum + "' where(1 = 1)  and spp.DelFlag=0 ";
                if (!entity.HouseID.Equals(0)) { strCount += " and spp.HouseID=" + entity.HouseID; }
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strCount += " and a.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strCount += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strCount += " and (a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%' or a.Specs like '" + entity.Specs + "')";
                    }
                }
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and a.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Model)) { strCount += " and a.Model like '%" + entity.Model + "%'"; }
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strCount += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.C_GoodsCode)) { strCount += " and a.GoodsCode = '" + entity.C_GoodsCode + "'"; }
                if (!entity.TypeID.Equals(0)) { strCount += " and a.TypeID=" + entity.TypeID; }
                if (!string.IsNullOrEmpty(entity.TypeIDStr)) { strCount += " and a.TypeID in (" + entity.TypeIDStr + ")"; }
                if (!string.IsNullOrEmpty(entity.CommType)) { strCount += " and a.CommType=" + entity.CommType; }
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strCount += " and a.ProductCode like '%" + entity.ProductCode + "%'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
                #endregion
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
            return resHT;
        }
        public List<CargoProductEntity> QueryALLProductSpecData(CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            try
            {
                string strSQL = @"select ROW_NUMBER() OVER (ORDER BY a.SID ASC) AS RowNumber,  a.*,b.TypeName,b.ParentID,c.TypeName as ParentName,spp.UnitPrice from tbl_Cargo_ProductSpec a inner join Tbl_Cargo_ProductType b on a.TypeID=b.TypeID  inner join Tbl_Cargo_ProductType c on b.ParentID=c.TypeID inner join tbl_Cargo_SupplierProductPrice spp on a.ProductCode=spp.ProductCode where (1=1) and spp.DelFlag=0";
                if (!entity.SuppClientNum.Equals(0))
                {
                    strSQL += " and spp.SupplierNum=" + entity.SuppClientNum;
                }
                if (!entity.HouseID.Equals(0))
                {
                    strSQL += " and spp.HouseID=" + entity.HouseID;
                }

                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoProductEntity
                            {
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                ParentID = Convert.ToInt32(idr["ParentID"]),
                                PinyinName = GetSpellCode(Convert.ToString(idr["TypeName"])).ToLower(),
                                Specs = Convert.ToString(idr["Specs"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Model = Convert.ToString(idr["Model"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                Born = Convert.ToString(idr["Born"]),
                                CommType = Convert.ToString(idr["CommType"]),
                                Thumbnail = Convert.ToString(idr["Thumbnail"]),
                                DetailDrawing = Convert.ToString(idr["DetailDrawing"]),
                                Assort = Convert.ToString(idr["Assort"]),
                                SalePrice = string.IsNullOrEmpty(Convert.ToString(idr["UnitPrice"])) ? 0 : Convert.ToDecimal(idr["UnitPrice"])
                            });
                        }

                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

            return result;
        }
        /// <summary>
        /// 查询仓库所有品牌
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public List<CargoProductEntity> QueryHouseALLProductName(CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            try
            {
                string strSQL = @"select p.TypeID,pt.TypeName from Tbl_Cargo_Product p inner join Tbl_Cargo_ProductType pt on p.TypeID=pt.TypeID inner join tbl_cargo_ContainerGoods cg on p.ProductID=cg.ProductID where cg.Piece>0 ";

                if (!entity.HouseID.Equals(0)) { strSQL += " and p.HouseID = " + entity.HouseID; }
                if (!string.IsNullOrEmpty(entity.HouseIDStr)) { strSQL += " and p.HouseID in (" + entity.HouseIDStr + ")"; }
                if (!string.IsNullOrEmpty(entity.BelongDepart)) { strSQL += " and p.BelongDepart='" + entity.BelongDepart + "'"; }
                if (!string.IsNullOrEmpty(entity.IsLockStock)) { strSQL += " and p.IsLockStock='" + entity.IsLockStock + "'"; }
                if (!entity.ParentID.Equals(0)) { strSQL += " and pt.ParentID = " + entity.ParentID; }
                strSQL += "group by p.TypeID,pt.TypeName order by TypeID";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoProductEntity
                            {
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"])
                            });
                        }

                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

            return result;
        }
        /// <summary>
        /// 新增产品规格
        /// </summary>
        /// <param name="entity"></param>
        public long AddCargoProductSpec(CargoProductEntity entity)
        {
            entity.EnSafe();
            Int64 did = 0;//ProductName,CarModel,Manufacturer,Seller,SellerAddress,Servicer,UpClientID,UpClientShortName
            string strSQL = @"INSERT INTO Tbl_Cargo_ProductSpec(TypeID,Model,GoodsCode,Specs,Figure,TreadWidth,FlatRatio,HubDiameter,LoadIndex,SpeedLevel,Born,CommType,Thumbnail,DetailDrawing,ProductName,CarModel,Manufacturer,Seller,SellerAddress,Servicer,UpClientID,UpClientShortName,BrandCode,TyreType,ProductCode,ProductUnit,BundleNum,THeight,DelFlag) VALUES (@TypeID,@Model,@GoodsCode,@Specs,@Figure,@TreadWidth,@FlatRatio,@HubDiameter,@LoadIndex,@SpeedLevel,@Born,@CommType,@Thumbnail,@DetailDrawing,@ProductName,@CarModel,@Manufacturer,@Seller,@SellerAddress,@Servicer,@UpClientID,@UpClientShortName,@BrandCode,@TyreType,@ProductCode,@ProductUnit,@BundleNum,@THeight,@DelFlag)SELECT @@IDENTITY";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);

                    conn.AddInParameter(cmd, "@UpClientID", DbType.Int32, entity.UpClientID);
                    conn.AddInParameter(cmd, "@ProductName", DbType.String, entity.ProductName.Trim());
                    conn.AddInParameter(cmd, "@BrandCode", DbType.String, entity.BrandCode.Trim());
                    conn.AddInParameter(cmd, "@CarModel", DbType.String, entity.CarModel.Trim());
                    conn.AddInParameter(cmd, "@Manufacturer", DbType.String, entity.Manufacturer.Trim());
                    conn.AddInParameter(cmd, "@Seller", DbType.String, entity.Seller.Trim());
                    conn.AddInParameter(cmd, "@SellerAddress", DbType.String, entity.SellerAddress.Trim());
                    conn.AddInParameter(cmd, "@Servicer", DbType.String, entity.Servicer.Trim());
                    conn.AddInParameter(cmd, "@UpClientShortName", DbType.String, entity.UpClientShortName.Trim());

                    conn.AddInParameter(cmd, "@Model", DbType.String, entity.Model.Trim());
                    conn.AddInParameter(cmd, "@GoodsCode", DbType.String, entity.GoodsCode.Trim());
                    conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs.Trim());
                    conn.AddInParameter(cmd, "@Figure", DbType.String, entity.Figure.Trim());
                    conn.AddInParameter(cmd, "@TreadWidth", DbType.Int32, entity.TreadWidth);
                    conn.AddInParameter(cmd, "@FlatRatio", DbType.Int32, entity.FlatRatio);
                    conn.AddInParameter(cmd, "@HubDiameter", DbType.Int32, entity.HubDiameter);
                    conn.AddInParameter(cmd, "@LoadIndex", DbType.String, entity.LoadIndex);
                    conn.AddInParameter(cmd, "@SpeedLevel", DbType.String, entity.SpeedLevel);
                    conn.AddInParameter(cmd, "@Born", DbType.String, entity.Born);
                    conn.AddInParameter(cmd, "@CommType", DbType.String, entity.CommType);
                    conn.AddInParameter(cmd, "@Thumbnail", DbType.String, entity.Thumbnail);
                    conn.AddInParameter(cmd, "@DetailDrawing", DbType.String, entity.DetailDrawing);
                    conn.AddInParameter(cmd, "@TyreType", DbType.String, entity.TyreType);
                    conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.AddInParameter(cmd, "@ProductUnit", DbType.String, entity.ProductUnit);
                    conn.AddInParameter(cmd, "@BundleNum", DbType.Int32, entity.BundleNum);
                    conn.AddInParameter(cmd, "@THeight", DbType.Int32, entity.THeight);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    //conn.ExecuteNonQuery(cmd);
                    did = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
                return did;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改产品规格
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoProductSpec(CargoProductEntity entity)
        {
            //ProductCode=@ProductCode,
            entity.EnSafe();
            string strSQL = @"UPDATE Tbl_Cargo_ProductSpec SET TypeID =@TypeID,Model =@Model,GoodsCode =@GoodsCode,Specs =@Specs,Figure =@Figure,TreadWidth =@TreadWidth,FlatRatio =@FlatRatio,HubDiameter =@HubDiameter,LoadIndex =@LoadIndex,SpeedLevel =@SpeedLevel,Born=@Born,CommType=@CommType,Assort=@Assort,ProductName=@ProductName,CarModel=@CarModel,Manufacturer=@Manufacturer,Seller=@Seller,SellerAddress=@SellerAddress,Servicer=@Servicer,UpClientID=@UpClientID,UpClientShortName=@UpClientShortName,BrandCode=@BrandCode,TyreType=@TyreType,ProductUnit=@ProductUnit,BundleNum=@BundleNum,DelFlag=@DelFlag ";
            if (!string.IsNullOrEmpty(entity.Thumbnail))
            {
                strSQL += ",Thumbnail=@Thumbnail";
            }
            if (!string.IsNullOrEmpty(entity.DetailDrawing))
            {
                strSQL += ",DetailDrawing=@DetailDrawing";
            }
            strSQL += " WHERE SID=@SID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@SID", DbType.Int32, entity.SID);
                    conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                    conn.AddInParameter(cmd, "@Model", DbType.String, entity.Model);
                    conn.AddInParameter(cmd, "@GoodsCode", DbType.String, entity.GoodsCode);
                    conn.AddInParameter(cmd, "@Specs", DbType.String, entity.Specs);
                    conn.AddInParameter(cmd, "@Figure", DbType.String, entity.Figure);
                    conn.AddInParameter(cmd, "@TreadWidth", DbType.Int32, entity.TreadWidth);
                    conn.AddInParameter(cmd, "@FlatRatio", DbType.Int32, entity.FlatRatio);
                    conn.AddInParameter(cmd, "@HubDiameter", DbType.Int32, entity.HubDiameter);
                    conn.AddInParameter(cmd, "@LoadIndex", DbType.String, entity.LoadIndex);
                    conn.AddInParameter(cmd, "@SpeedLevel", DbType.String, entity.SpeedLevel);
                    conn.AddInParameter(cmd, "@Born", DbType.String, entity.Born);
                    conn.AddInParameter(cmd, "@CommType", DbType.String, entity.CommType);
                    conn.AddInParameter(cmd, "@Assort", DbType.String, entity.Assort);

                    conn.AddInParameter(cmd, "@UpClientID", DbType.Int32, entity.UpClientID);
                    conn.AddInParameter(cmd, "@ProductName", DbType.String, entity.ProductName.Trim());
                    conn.AddInParameter(cmd, "@BrandCode", DbType.String, entity.BrandCode.Trim());
                    conn.AddInParameter(cmd, "@CarModel", DbType.String, entity.CarModel.Trim());
                    conn.AddInParameter(cmd, "@Manufacturer", DbType.String, entity.Manufacturer.Trim());
                    conn.AddInParameter(cmd, "@Seller", DbType.String, entity.Seller.Trim());
                    conn.AddInParameter(cmd, "@SellerAddress", DbType.String, entity.SellerAddress.Trim());
                    conn.AddInParameter(cmd, "@Servicer", DbType.String, entity.Servicer.Trim());
                    conn.AddInParameter(cmd, "@UpClientShortName", DbType.String, entity.UpClientShortName.Trim());
                    conn.AddInParameter(cmd, "@TyreType", DbType.String, entity.TyreType);
                    // conn.AddInParameter(cmd, "@ProductCode", DbType.String, entity.ProductCode);
                    conn.AddInParameter(cmd, "@ProductUnit", DbType.String, entity.ProductUnit);
                    conn.AddInParameter(cmd, "@BundleNum", DbType.Int32, entity.BundleNum);
                    if (!string.IsNullOrEmpty(entity.Thumbnail))
                    {
                        conn.AddInParameter(cmd, "@Thumbnail", DbType.String, entity.Thumbnail);
                    }
                    if (!string.IsNullOrEmpty(entity.DetailDrawing))
                    {
                        conn.AddInParameter(cmd, "@DetailDrawing", DbType.String, entity.DetailDrawing);
                    }
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除产品规格
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoProductSpec(List<CargoProductEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"UPDATE Tbl_Cargo_ProductSpec SET DelFlag='1' WHERE SID=@SID";
                    if (it.DelFlag.Equals("1"))//彻底删除
                    {
                        strSQL = @"Delete from Tbl_Cargo_ProductSpec where SID=@SID ";
                    }

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@SID", DbType.Int32, it.SID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        public List<CargoProductEntity> QueryALLProductSpecPieceData(CargoProductEntity entity)
        {
            List<CargoProductEntity> result = new List<CargoProductEntity>();
            try
            {
                string strSQL = @"select ps.*,pt.TypeName,isnull(p.Piece,0)Piece from tbl_Cargo_ProductSpec ps left join ( select p.Specs,p.Figure,p.GoodsCode,p.SpeedLevel,p.LoadIndex,SUM(cg.Piece)Piece from Tbl_Cargo_Product p left join tbl_cargo_ContainerGoods cg on p.ProductID=cg.ProductID where 1=1 ";
                if (!entity.HouseID.Equals(0)) { strSQL += " and p.HouseID=" + entity.HouseID; }
                strSQL += " group by p.Specs,p.Figure,p.GoodsCode,p.SpeedLevel,p.LoadIndex ) p on ps.Specs=p.Specs and ps.Figure=p.Figure and ps.GoodsCode=p.GoodsCode and ps.LoadIndex=p.LoadIndex and ps.SpeedLevel=p.SpeedLevel inner join Tbl_Cargo_ProductType pt on ps.TypeID=pt.TypeID where 1=1 ";
                if (!entity.TypeID.Equals(0)) { strSQL += " and ps.TypeID=" + entity.TypeID; }
                string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                if (res.Length <= 3)
                {
                    if (!string.IsNullOrEmpty(res)) { strSQL += " and ps.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strSQL += " and (ps.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or ps.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
                if (res.Length > 5)
                {
                    strSQL += " and (ps.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or ps.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or ps.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or ps.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or ps.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and ps.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and ps.Model like '%" + entity.Model + "%'"; }
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and ps.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                strSQL += " order by Specs,Piece";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoProductEntity
                            {
                                SID = Convert.ToInt32(idr["SID"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                PinyinName = GetSpellCode(Convert.ToString(idr["TypeName"])).ToLower(),
                                Specs = Convert.ToString(idr["Specs"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                Model = Convert.ToString(idr["Model"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                Born = Convert.ToString(idr["Born"]),
                                CommType = Convert.ToString(idr["CommType"]),
                                Assort = Convert.ToString(idr["Assort"])
                            });
                        }

                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

            return result;
        }

        public int ReturnMaxBasicSpecsNum(CargoProductEntity entity)
        {
            int result = 0;
            string strQ = @"select COUNT(*) as PNum from Tbl_Cargo_ProductSpec where TypeID=" + entity.TypeID + " and ProductCode like '" + entity.ProductCode + "%'";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                using (DataTable dd = conn.ExecuteDataTable(cmdQ))
                {
                    if (dd.Rows.Count > 0)
                    {
                        result = Convert.ToInt32(dd.Rows[0]["PNUM"]) + 1;

                    }
                    else
                    {
                        result = 1;
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询供应商 查询入驻仓库的某品牌的供应商
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoSupplierProductPrice> QueryHouseSupplier(CargoSupplierProductPrice entity)
        {
            List<CargoSupplierProductPrice> result = new List<CargoSupplierProductPrice>();
            string strSQL = "select a.SupplierID,a.SupplierNum,b.ClientShortName from Tbl_Cargo_SupplierProductPrice as a inner join Tbl_Cargo_Client as b on a.SupplierID=b.ClientID where (1=1)";
            if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID; }
            if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }
            strSQL += "group by a.SupplierID,a.SupplierNum,b.ClientShortName";
            using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoSupplierProductPrice
                        {
                            SupplierID = Convert.ToInt32(idr["SupplierID"]),
                            SupplierNum = Convert.ToInt32(idr["SupplierNum"]),
                            ClientShortName = Convert.ToString(idr["ClientShortName"])
                        });
                    }

                }
            }

            return result;
        }
        #endregion
        #region 获取字符串拼音

        /// <summary>
        /// 在指定的字符串列表CnStr中检索符合拼音索引字符串
        /// </summary>
        /// <param name="CnStr">汉字字符串</param>
        /// <returns>相对应的汉语拼音首字母串</returns>
        public static string GetSpellCode(string CnStr)
        {
            string strTemp = "";
            for (int i = 0; i < CnStr.Length; i++)
            {
                strTemp += GetCharSpellCode(CnStr.Substring(i, 1));
            }
            return strTemp;
        }
        /// <summary>
        /// 截取字符长度
        /// </summary>
        /// <param name="str">被截取的字符串</param>
        /// <param name="len">所截取的长度</param>
        /// <returns>子字符串</returns>
        public static string CutString(string str, int len)
        {
            if (str == null || str.Length == 0 || len <= 0)
            {
                return string.Empty;
            }
            int l = str.Length;
            #region 计算长度
            int clen = 0;
            while (clen < len && clen < l)
            {
                //每遇到一个中文，则将目标长度减一。
                if ((int)str[clen] > 128) { len--; }
                clen++;
            }
            #endregion

            if (clen < l)
            {
                return str.Substring(0, clen) + "...";
            }
            else
            {
                return str;
            }
        }
        /// <summary>
        /// 得到一个汉字的拼音第一个字母，如果是一个英文字母则直接返回大写字母
        /// </summary>
        /// <param name="CnChar">单个汉字</param>
        /// <returns>单个大写字母</returns>
        private static string GetCharSpellCode(string CnChar)
        {

            long iCnChar;

            byte[] ZW = System.Text.Encoding.Default.GetBytes(CnChar);

            //如果是字母，则直接返回首字母

            if (ZW.Length == 1)
            {

                return CutString(CnChar.ToUpper(), 1);

            }
            else
            {

                // get the array of byte from the single char

                int i1 = (short)(ZW[0]);

                int i2 = (short)(ZW[1]);

                iCnChar = i1 * 256 + i2;

            }

            // iCnChar match the constant

            if ((iCnChar >= 45217) && (iCnChar <= 45252)) { return "a"; }
            else if ((iCnChar >= 45253) && (iCnChar <= 45760)) { return "B"; }
            else if ((iCnChar >= 45761) && (iCnChar <= 46317))
            {

                return "C";

            }
            else if ((iCnChar >= 46318) && (iCnChar <= 46825))
            {

                return "D";

            }
            else if ((iCnChar >= 46826) && (iCnChar <= 47009))
            {

                return "E";

            }
            else if ((iCnChar >= 47010) && (iCnChar <= 47296))
            {

                return "F";

            }
            else if ((iCnChar >= 47297) && (iCnChar <= 47613))
            {

                return "G";

            }
            else if ((iCnChar >= 47614) && (iCnChar <= 48118))
            {

                return "H";

            }
            else if ((iCnChar >= 48119) && (iCnChar <= 49061))
            {

                return "J";

            }
            else if ((iCnChar >= 49062) && (iCnChar <= 49323))
            {

                return "K";

            }
            else if ((iCnChar >= 49324) && (iCnChar <= 49895))
            {

                return "L";

            }
            else if ((iCnChar >= 49896) && (iCnChar <= 50370))
            {

                return "M";

            }
            else if ((iCnChar >= 50371) && (iCnChar <= 50613))
            {

                return "N";

            }
            else if ((iCnChar >= 50614) && (iCnChar <= 50621))
            {

                return "O";

            }
            else if ((iCnChar >= 50622) && (iCnChar <= 50905))
            {

                return "P";

            }
            else if ((iCnChar >= 50906) && (iCnChar <= 51386))
            {

                return "Q";

            }
            else if ((iCnChar >= 51387) && (iCnChar <= 51445))
            {

                return "R";

            }
            else if ((iCnChar >= 51446) && (iCnChar <= 52217))
            {

                return "S";

            }
            else if ((iCnChar >= 52218) && (iCnChar <= 52697))
            {

                return "T";

            }
            else if ((iCnChar >= 52698) && (iCnChar <= 52979))
            {

                return "W";

            }
            else if ((iCnChar >= 52980) && (iCnChar <= 53640))
            {

                return "X";

            }
            else if ((iCnChar >= 53689) && (iCnChar <= 54480))
            {

                return "Y";

            }
            else if ((iCnChar >= 54481) && (iCnChar <= 55289))
            {

                return "Z";

            }
            else

                return ("?");

        }
        #endregion
        #region 盘点管理

        /// <summary>
        /// 生成盘点单
        /// </summary>
        /// <param name="entity">盘点单的实体对象</param>
        /// <param name="genType">
        /// 生成类型，取值说明：
        /// <c>full</c> 表示全量盘点生成；
        /// <c>par</c> 表示部分差异盘点生成。
        /// </param>

        public int SaveStockTake(CargoStockTakeEntity entity, string genType)
        {
            //判断是要所有标签盘点，还是有数量变化的标签盘点
            bool isFull = true;
            if (genType == "part")
            {
                isFull = false;
            }

            int StockID = AddStockTake(entity);
            string strSQL = "insert into Tbl_Cargo_StockTakeContainer(ContainerID,ContainerCode,StockNum,StockID) select a.ContainerID,b.ContainerCode,SUM(a.Piece) as StockNum," + StockID + @" from Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Container as b on a.ContainerID = b.ContainerID 
        inner join Tbl_Cargo_Product p ON a.ProductID = p.ProductID
        inner join Tbl_Cargo_Area as c on b.AreaID = c.AreaID ";
            if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID = " + entity.TypeID; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and c.HouseID = " + entity.HouseID; }
            strSQL += " inner join Tbl_Cargo_Area as d on c.ParentID = d.AreaID";
            if (!entity.AreaID.Equals(0)) { strSQL += " and d.AreaID=" + entity.AreaID; }
            strSQL += " inner join Tbl_Cargo_Area as f on d.ParentID = f.AreaID ";
            if (!entity.HeadHouseID.Equals(0)) { strSQL += "and f.AreaID=" + entity.HeadHouseID; }

            strSQL += " where (1=1) and p.SpecsType <> 5 and a.Piece>0 ";
            if (!isFull) { strSQL += " and a.Take_DATE IS NULL OR a.Take_DATE < COALESCE(a.Piece_DATE, a.OP_DATE)"; }
            strSQL += " group by a.ContainerID,b.ContainerCode";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.ExecuteNonQuery(cmd);
            }
            string strTagInsert = "insert into Tbl_Cargo_StockTakeTag(StockID,ProductID,TagCode,ContainerID) ";
            string strTag = "select " + StockID + @",a.ProductID,g.TagCode,a.ContainerID from Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Container as b on a.ContainerID = b.ContainerID
        inner join Tbl_Cargo_Product p ON a.ProductID = p.ProductID
        inner join Tbl_Cargo_Area as c on b.AreaID = c.AreaID ";
            if (!entity.TypeID.Equals(0)) { strTag += " and a.TypeID = " + entity.TypeID; }
            if (!entity.HouseID.Equals(0)) { strTag += " and c.HouseID = " + entity.HouseID; }
            strTag += " inner join Tbl_Cargo_Area as d on c.ParentID = d.AreaID";
            if (!entity.AreaID.Equals(0)) { strTag += " and d.AreaID=" + entity.AreaID; }
            strTag += " inner join Tbl_Cargo_Area as f on d.ParentID = f.AreaID ";
            if (!entity.HeadHouseID.Equals(0)) { strTag += " and f.AreaID=" + entity.HeadHouseID; }
            strTag += " inner join Tbl_Cargo_ProductTag as g on a.ProductID = g.ProductID and g.OutCargoStatus = 0 and a.ContainerID = g.ContainerID";

            strTag += " where (1=1) and p.SpecsType <> 5  and a.Piece > 0 ";
            if (!isFull) { strTag += " and a.Take_DATE IS NULL OR a.Take_DATE < COALESCE(a.Piece_DATE, a.OP_DATE)"; }

            //判断是否有需要盘点的标签数据
            using (DbCommand cmdTag = conn.GetSqlStringCommond(strTag))
            {
                using (var dataReader = conn.ExecuteReader(cmdTag))
                {
                    if (!dataReader.HasRows)
                    {
                        throw new ApplicationException("没有需要盘点的产品");
                    }
                }
            }
            string strTagMerge = strTagInsert + strTag;
            using (DbCommand cmdTag = conn.GetSqlStringCommond(strTagMerge))
            {
                conn.ExecuteNonQuery(cmdTag);
            }
            return StockID;
        }

        public void SaveStockTakeFile(CargoStockTakeFileEntity entity)
        {
            string inSQL = @"INSERT INTO Tbl_Cargo_StockTakeFile(StockID,Raw_FileName,FileName,FilePath,FileSize,FileType,OP_DATE,UploadUserID,UploadUserName) 
            values (@StockID,@Raw_FileName,@FileName,@FilePath,@FileSize,@FileType,getdate(),@UploadUserID,@UploadUserName)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(inSQL))
                {
                    conn.AddInParameter(cmd, "@StockID", DbType.Int64, entity.StockID);
                    conn.AddInParameter(cmd, "@Raw_FileName", DbType.String, entity.Raw_FileName);
                    conn.AddInParameter(cmd, "@FileName", DbType.String, entity.FileName);
                    conn.AddInParameter(cmd, "@FilePath", DbType.String, entity.FilePath);
                    conn.AddInParameter(cmd, "@FileSize", DbType.String, entity.FileSize);
                    conn.AddInParameter(cmd, "@FileType", DbType.String, entity.FileType);
                    conn.AddInParameter(cmd, "@UploadUserID", DbType.String, entity.UploadUserID.ToString());
                    conn.AddInParameter(cmd, "@UploadUserName", DbType.String, entity.UploadUserName);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void DelStockTakePics(int[] IDs)
        {
            if (IDs == null || IDs.Length == 0)
            {
                return; // 如果ID数组为空，直接返回
            }
            string inSQL = @"DELETE FROM Tbl_Cargo_StockTakeFile WHERE ID IN (@IDs)";

            try
            {
                string idList = string.Join(",", IDs);
                inSQL = inSQL.Replace("@IDs", idList);
                using (DbCommand cmd = conn.GetSqlStringCommond(inSQL))
                {
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (SqlException ex)
            {
                string errorMessage = $"删除盘点单图片时发生数据库错误: {ex.Message}";
                throw new ApplicationException(errorMessage, ex);
            }
            catch (Exception ex)
            {
                string errorMessage = $"删除盘点单图片时发生未知错误: {ex.Message}";
                throw new ApplicationException(errorMessage, ex);
            }
        }

        public List<CargoStockTakeFileEntity> QueryStockTakePics(int StockID)
        {
            List<CargoStockTakeFileEntity> result = new List<CargoStockTakeFileEntity>();
            string strSQL = @"SELECT * from Tbl_Cargo_StockTakeFile Where (1=1)";
            strSQL += " and StockID=" + StockID;
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        CargoStockTakeFileEntity row = new CargoStockTakeFileEntity
                        {
                            ID = Convert.ToInt32(idr["ID"]),
                            StockID = Convert.ToInt32(idr["StockID"]),
                            Raw_FileName = Convert.ToString(idr["Raw_FileName"]),
                            FileName = Convert.ToString(idr["FileName"]),
                            FilePath = Convert.ToString(idr["FilePath"]),
                            FileSize = Convert.ToInt32(idr["FileSize"]),
                            FileType = Convert.ToString(idr["FileType"]),
                            UploadUserID = Convert.ToString(idr["UploadUserID"]),
                            UploadUserName = Convert.ToString(idr["UploadUserName"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                        };
                        result.Add(row);
                    }
                }
            }

            return result;
        }

        public List<CargoStockTakeFileEntity> QueryStockTakePicsByIDs(int[] IDs)
        {
            if (IDs == null || IDs.Length == 0)
            {
                return new List<CargoStockTakeFileEntity>(); // 如果ID数组为空，直接返回
            }
            string idList = string.Join(",", IDs);

            List<CargoStockTakeFileEntity> result = new List<CargoStockTakeFileEntity>();
            string strSQL = @"SELECT * from Tbl_Cargo_StockTakeFile Where (1=1)";
            strSQL += " and ID in (@IDs)";
            strSQL = strSQL.Replace("@IDs", idList);
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        CargoStockTakeFileEntity row = new CargoStockTakeFileEntity
                        {
                            ID = Convert.ToInt32(idr["ID"]),
                            StockID = Convert.ToInt32(idr["StockID"]),
                            Raw_FileName = Convert.ToString(idr["Raw_FileName"]),
                            FileName = Convert.ToString(idr["FileName"]),
                            FilePath = Convert.ToString(idr["FilePath"]),
                            FileSize = Convert.ToInt32(idr["FileSize"]),
                            FileType = Convert.ToString(idr["FileType"]),
                            UploadUserID = Convert.ToString(idr["UploadUserID"]),
                            UploadUserName = Convert.ToString(idr["UploadUserName"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                        };
                        result.Add(row);
                    }
                }
            }

            return result;
        }


        private int AddStockTake(CargoStockTakeEntity entity)
        {
            int did = 0;
            //string strSQL = @"INSERT INTO Tbl_Cargo_StockTake(HouseID,HeadHouseID,HeadHouseName,AreaID,AreaName,CreateID,CreateName,CreateDate,TakeStatus,StockNum) Values (@HouseID,@HeadHouseID,@HeadHouseName,@AreaID,@AreaName,@CreateID,@CreateName,@CreateDate,@TakeStatus,@StockNum) SELECT @@IDENTITY";
            string strSQL = @"INSERT INTO Tbl_Cargo_StockTake(HouseID,HeadHouseID,HeadHouseName,AreaID,AreaName,CreateID,CreateName,CreateDate,TakeStatus,StockNum,TypeID,TypeName) Values (@HouseID,@HeadHouseID,@HeadHouseName,@AreaID,@AreaName,@CreateID,@CreateName,@CreateDate,@TakeStatus,@StockNum,@TypeID,@TypeName) SELECT @@IDENTITY";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmd, "@HeadHouseName", DbType.String, entity.HeadHouseName);
                conn.AddInParameter(cmd, "@HeadHouseID", DbType.Int32, entity.HeadHouseID);
                conn.AddInParameter(cmd, "@AreaName", DbType.String, entity.AreaName);
                conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID);
                conn.AddInParameter(cmd, "@CreateID", DbType.String, entity.CreateID);
                conn.AddInParameter(cmd, "@CreateName", DbType.String, entity.CreateName);
                conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, DateTime.Now);
                conn.AddInParameter(cmd, "@TakeStatus", DbType.String, entity.TakeStatus);
                conn.AddInParameter(cmd, "@StockNum", DbType.Int32, entity.StockNum);
                conn.AddInParameter(cmd, "@TypeID", DbType.Int32, entity.TypeID);
                conn.AddInParameter(cmd, "@TypeName", DbType.String, entity.TypeName);
                did = Convert.ToInt32(conn.ExecuteScalar(cmd));
            }
            return did;
        }
        /// <summary>
        /// 查询盘点表的总库存数
        /// </summary>
        /// <param name="stockID"></param>
        /// <returns></returns>
        public CargoStockTakeEntity QueryStockTakeNum(int stockID)
        {
            CargoStockTakeEntity result = new CargoStockTakeEntity();
            string strSQL = "select StockID,SUM(StockNum) as StockNum from Tbl_Cargo_StockTakeContainer where StockID=@StockID group by StockID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@StockID", DbType.Int32, stockID);
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.StockID = Convert.ToInt32(idr["StockID"]);
                        result.StockNum = Convert.ToInt32(idr["StockNum"]);
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 修改总的盘点库存数
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateStockTakeNum(CargoStockTakeEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_StockTake Set StockNum=@StockNum Where StockID=@StockID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@StockID", DbType.Int32, entity.StockID);
                conn.AddInParameter(cmd, "@StockNum", DbType.Int32, entity.StockNum);
                conn.ExecuteNonQuery(cmd);
            }
        }
        public Hashtable QueryStockTakeData(int pIndex, int pNum, CargoStockTakeEntity entity)
        {
            List<CargoStockTakeEntity> result = new List<CargoStockTakeEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.CreateDate DESC) AS RowNumber, a.*,b.Name as HouseName from Tbl_Cargo_StockTake as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID WHERE (1=1)";
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID = " + entity.HouseID; }
                if (!entity.HeadHouseID.Equals(0)) { strSQL += " and a.HeadHouseID = " + entity.HeadHouseID; }
                //以名称为查询条件
                if (!string.IsNullOrEmpty(entity.CreateName))
                {
                    strSQL += " and a.CreateName like '%" + entity.CreateName + "%'";
                }
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.TakeStatus))
                {
                    strSQL += " and a.TakeStatus ='" + entity.TakeStatus + "'";
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoStockTakeEntity
                            {
                                StockID = Convert.ToInt32(idr["StockID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HeadHouseID = Convert.ToInt32(idr["HeadHouseID"]),
                                HeadHouseName = Convert.ToString(idr["HeadHouseName"]),
                                //AreaID = Convert.ToInt32(idr["AreaID"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                CreateID = Convert.ToString(idr["CreateID"]),
                                CreateName = Convert.ToString(idr["CreateName"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                TakeStatus = Convert.ToString(idr["TakeStatus"]),
                                StockNum = Convert.ToInt32(idr["StockNum"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_StockTake as a Where (1=1)";
                if (!entity.HouseID.Equals(0)) { strCount += " and a.HouseID = " + entity.HouseID; }
                if (!entity.HeadHouseID.Equals(0)) { strCount += " and a.HeadHouseID = " + entity.HeadHouseID; }
                //以名称为查询条件
                if (!string.IsNullOrEmpty(entity.CreateName))
                {
                    strCount += " and a.CreateName like '%" + entity.CreateName + "%'";
                }
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.TakeStatus))
                {
                    strCount += " and a.TakeStatus ='" + entity.TakeStatus + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        public CargoStockTakeEntity QueryStockTake(CargoStockTakeEntity entity)
        {
            CargoStockTakeEntity result = new CargoStockTakeEntity();
            string strSQL = @"SELECT * from Tbl_Cargo_StockTake Where (1=1)";
            if (!entity.StockID.Equals(0)) { strSQL += " and StockID=" + entity.StockID; }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result = new CargoStockTakeEntity
                        {
                            StockID = Convert.ToInt32(idr["StockID"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            HeadHouseID = Convert.ToInt32(idr["HeadHouseID"]),
                            HeadHouseName = Convert.ToString(idr["HeadHouseName"]),
                            AreaName = Convert.ToString(idr["AreaName"]),
                            CreateID = Convert.ToString(idr["CreateID"]),
                            CreateName = Convert.ToString(idr["CreateName"]),
                            CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                            TakeStatus = Convert.ToString(idr["TakeStatus"]),
                            StockNum = Convert.ToInt32(idr["StockNum"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                        };
                    }
                }
            }

            return result;
        }
        /// <summary>
        /// 修改盘点单状态
        /// </summary>
        /// <param name="entity"></param>
        private void UpdateStockTakeStatus(CargoStockTakeEntity entity)
        {
            string strSQL = "update Tbl_Cargo_StockTake set TakeStatus=@TakeStatus where StockID=@StockID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@StockID", DbType.Int32, entity.StockID);
                conn.AddInParameter(cmd, "@TakeStatus", DbType.String, entity.TakeStatus);
                conn.ExecuteNonQuery(cmd);
            }
        }

        /// <summary>
        /// 删除盘点单
        /// </summary>
        /// <param name="entity"></param>
        public void DelStockTake(List<CargoStockTakeEntity> entity)
        {
            foreach (var it in entity)
            {
                string strSQL = @"Delete from Tbl_Cargo_StockTake where StockID=@StockID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@StockID", DbType.Int32, it.StockID);
                    conn.ExecuteNonQuery(cmd);
                }

                string strSQLA = @"Delete from Tbl_Cargo_StockTakeContainer where StockID=@StockID";
                using (DbCommand cmdA = conn.GetSqlStringCommond(strSQLA))
                {
                    conn.AddInParameter(cmdA, "@StockID", DbType.Int32, it.StockID);
                    conn.ExecuteNonQuery(cmdA);
                }

                string strSQLB = @"Delete from Tbl_Cargo_StockTakeTag where StockID=@StockID";
                using (DbCommand cmdB = conn.GetSqlStringCommond(strSQLB))
                {
                    conn.AddInParameter(cmdB, "@StockID", DbType.Int32, it.StockID);
                    conn.ExecuteNonQuery(cmdB);
                }
            }
        }
        /// <summary>
        /// 查询时间段所有的盘点单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoStockTakeEntity> QueryCargoStockTakeList(CargoStockTakeEntity entity)
        {
            List<CargoStockTakeEntity> result = new List<CargoStockTakeEntity>();
            string strSQL = "select a.*,b.Name as HouseName from Tbl_Cargo_StockTake as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID WHERE (1=1)";
            if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID = " + entity.HouseID; }
            if (!entity.HeadHouseID.Equals(0)) { strSQL += " and a.HeadHouseID = " + entity.HeadHouseID; }
            //以名称为查询条件
            if (!string.IsNullOrEmpty(entity.CreateName))
            {
                strSQL += " and a.CreateName like '%" + entity.CreateName + "%'";
            }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.TakeStatus))
            {
                strSQL += " and a.TakeStatus ='" + entity.TakeStatus + "'";
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoStockTakeEntity
                        {
                            StockID = Convert.ToInt32(idr["StockID"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            HeadHouseID = Convert.ToInt32(idr["HeadHouseID"]),
                            HeadHouseName = Convert.ToString(idr["HeadHouseName"]),
                            //AreaID = Convert.ToInt32(idr["AreaID"]),
                            AreaName = Convert.ToString(idr["AreaName"]),
                            HouseName = Convert.ToString(idr["HouseName"]),
                            CreateID = Convert.ToString(idr["CreateID"]),
                            CreateName = Convert.ToString(idr["CreateName"]),
                            CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                            TakeStatus = Convert.ToString(idr["TakeStatus"]),
                            StockNum = Convert.ToInt32(idr["StockNum"]),
                            StockTakeContainerList = QueryCargoStockTakeContainerList(new CargoStockTakeContainerEntity { StockID = Convert.ToInt32(idr["StockID"]) }),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询盘点单的货位数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoStockTakeContainerEntity> QueryCargoStockTakeContainerList(CargoStockTakeContainerEntity entity)
        {
            List<CargoStockTakeContainerEntity> result = new List<CargoStockTakeContainerEntity>();
            string strSQL = "select * from Tbl_Cargo_StockTakeContainer Where (1=1)";
            if (!entity.StockID.Equals(0)) { strSQL += " and StockID=" + entity.StockID; }
            if (!string.IsNullOrEmpty(entity.StockStatus)) { strSQL += " and StockStatus ='" + entity.StockStatus + "'"; }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoStockTakeContainerEntity
                        {
                            StockID = Convert.ToInt32(idr["StockID"]),
                            ContainerID = Convert.ToInt32(idr["ContainerID"]),
                            ContainerCode = Convert.ToString(idr["ContainerCode"]),
                            //AreaID = Convert.ToInt32(idr["AreaID"]),
                            StockStatus = Convert.ToString(idr["StockStatus"]),
                            StockNum = Convert.ToInt32(idr["StockNum"]),
                            StockDate = string.IsNullOrEmpty(Convert.ToString(idr["StockDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["StockDate"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询盘点的产品标签列表
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoStockTakeTagEntity> QueryCargoStockTagList(CargoStockTakeTagEntity entity)
        {
            List<CargoStockTakeTagEntity> result = new List<CargoStockTakeTagEntity>();
            string strSQL = "select a.StockID,a.ContainerID,a.ContainerCode,a.StockStatus as TakeSubmitStatus,b.ProductID,b.TagCode,b.ScanStatus,b.ScanUserName,b.ScanLoginName,c.ProductName,c.Batch,b.StockStatus,b.ScanDate,b.Remark,d.TypeName,c.Specs,c.Figure,c.LoadIndex,c.SpeedLevel,c.GoodsCode from Tbl_Cargo_StockTakeContainer as a inner join Tbl_Cargo_StockTakeTag as b on a.StockID=b.StockID and a.ContainerID=b.ContainerID left join Tbl_Cargo_Product as c on b.ProductID=c.ProductID inner join tbl_Cargo_ProductType as d on c.TypeID=d.TypeID where (1=1)";
            if (!entity.StockID.Equals(0)) { strSQL += " and a.StockID=" + entity.StockID; }
            if (!string.IsNullOrEmpty(entity.QueryStockID)) { strSQL += " and a.StockID in (" + entity.QueryStockID + ")"; }
            if (!string.IsNullOrEmpty(entity.ContainerCode)) { strSQL += " and a.ContainerCode ='" + entity.ContainerCode + "'"; }
            strSQL += " order by b.ScanStatus asc,b.StockStatus desc";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoStockTakeTagEntity
                        {
                            StockID = Convert.ToInt32(idr["StockID"]),
                            ContainerID = Convert.ToInt32(idr["ContainerID"]),
                            ContainerCode = Convert.ToString(idr["ContainerCode"]),
                            TakeSubmitStatus = Convert.ToString(idr["TakeSubmitStatus"]),
                            //AreaID = Convert.ToInt32(idr["AreaID"]),
                            TagCode = Convert.ToString(idr["TagCode"]),
                            ScanStatus = Convert.ToString(idr["ScanStatus"]),
                            ScanUserName = Convert.ToString(idr["ScanUserName"]),
                            ScanLoginName = Convert.ToString(idr["ScanLoginName"]),
                            StockStatus = Convert.ToString(idr["StockStatus"]),
                            ScanDate = string.IsNullOrEmpty(Convert.ToString(idr["ScanDate"])) ? default(DateTime) : Convert.ToDateTime(idr["ScanDate"]),
                            ProductName = Convert.ToString(idr["ProductName"]),
                            Batch = Convert.ToString(idr["Batch"]),
                            Remark = Convert.ToString(idr["Remark"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            Specs = Convert.ToString(idr["Specs"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            GoodsCode = Convert.ToString(idr["GoodsCode"]),
                            ProductID = Convert.ToInt64(idr["ProductID"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 修改盘点货位的提交状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateStockTakeStatus(CargoStockTakeContainerEntity entity)
        {
            string strSQL = "update Tbl_Cargo_StockTakeContainer set StockStatus=@StockStatus,StockDate=@StockDate where StockID=@StockID and ContainerCode=@ContainerCode";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@StockID", DbType.Int32, entity.StockID);
                conn.AddInParameter(cmd, "@ContainerCode", DbType.String, entity.ContainerCode);
                conn.AddInParameter(cmd, "@StockDate", DbType.String, DateTime.Now);
                conn.AddInParameter(cmd, "@StockStatus", DbType.String, entity.StockStatus);
                conn.ExecuteNonQuery(cmd);
            }
            if (!IsExistNoSubmitStockTakeContainerCode(new CargoStockTakeContainerEntity { StockID = entity.StockID, StockStatus = "0" }))
            {
                //全部提交了，修改盘点单状态为已盘点完成
                UpdateStockTakeStatus(new CargoStockTakeEntity { StockID = entity.StockID, TakeStatus = "2" });
            }
        }
        /// <summary>
        /// 判断是否存在未提交的盘点货位数据 false:不存在未扫描的，全部扫描，true：未全部扫描
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistNoSubmitStockTakeContainerCode(CargoStockTakeContainerEntity entity)
        {
            string strSQL = @"select StockID from Tbl_Cargo_StockTakeContainer where StockID=@StockID and StockStatus=@StockStatus";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmdQ, "@StockID", DbType.Int32, entity.StockID);
                conn.AddInParameter(cmdQ, "@StockStatus", DbType.String, entity.StockStatus);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 盘点单下的货位是否存在
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoStockTakeContainerEntity QueryStockTakeContainerCode(CargoStockTakeContainerEntity entity)
        {
            CargoStockTakeContainerEntity result = new CargoStockTakeContainerEntity();
            string strQ = @"Select * from Tbl_Cargo_StockTakeContainer Where (1=1)";
            if (!entity.StockID.Equals(0)) { strQ += " and StockID=" + entity.StockID; }
            if (!string.IsNullOrEmpty(entity.ContainerCode))
            {
                strQ += " and ContainerCode='" + entity.ContainerCode + "'";
            }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.StockID = Convert.ToInt32(idr["StockID"]);
                        result.StockNum = Convert.ToInt32(idr["StockNum"]);
                        result.ContainerID = Convert.ToInt32(idr["StockNum"]);
                        result.ContainerCode = Convert.ToString(idr["ContainerCode"]);
                        result.StockStatus = Convert.ToString(idr["StockStatus"]);
                        result.StockDate = string.IsNullOrEmpty(Convert.ToString(idr["StockDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["StockDate"]);
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 盘点标签表中是否存在标签数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistStockTakeTag(CargoStockTakeTagEntity entity)
        {
            string strSQL = @"select TagCode from Tbl_Cargo_StockTakeTag where TagCode=@TagCode and StockID=@StockID";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmdQ, "@TagCode", DbType.String, entity.TagCode);
                conn.AddInParameter(cmdQ, "@StockID", DbType.Int32, entity.StockID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 保存盘点标签数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddStockTakeTag(CargoStockTakeTagEntity entity)
        {
            if (!IsExistStockTakeTag(new CargoStockTakeTagEntity { TagCode = entity.TagCode, StockID = entity.StockID }))
            {
                string strSQL = "insert into Tbl_Cargo_StockTakeTag(StockID,ProductID,TagCode,ContainerID,ScanStatus,StockStatus,ScanLoginName,ScanUserName,ScanDate,Remark) values (@StockID,@ProductID,@TagCode,@ContainerID,@ScanStatus,@StockStatus,@ScanLoginName,@ScanUserName,@ScanDate,@Remark)";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@StockID", DbType.Int32, entity.StockID);
                    conn.AddInParameter(cmd, "@ProductID", DbType.Int64, entity.ProductID);
                    conn.AddInParameter(cmd, "@ContainerID", DbType.Int32, entity.ContainerID);
                    conn.AddInParameter(cmd, "@TagCode", DbType.String, entity.TagCode);
                    conn.AddInParameter(cmd, "@ScanStatus", DbType.String, entity.ScanStatus);
                    conn.AddInParameter(cmd, "@StockStatus", DbType.String, entity.StockStatus);
                    conn.AddInParameter(cmd, "@ScanLoginName", DbType.String, entity.ScanLoginName);
                    conn.AddInParameter(cmd, "@ScanUserName", DbType.String, entity.ScanUserName);
                    conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                    conn.AddInParameter(cmd, "@ScanDate", DbType.DateTime, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            else
            {
                UpdateStockTakeTagStatus(entity);
                CargoStockTakeEntity stock = QueryStockTake(new CargoStockTakeEntity { StockID = entity.StockID });
                if (stock.TakeStatus.Equals("0"))
                {
                    UpdateStockTakeStatus(new CargoStockTakeEntity { StockID = entity.StockID, TakeStatus = "1" });
                }
            }
        }
        /// <summary>
        /// 修改盘点标签表的扫描和盘点状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateStockTakeTagStatus(CargoStockTakeTagEntity entity)
        {
            entity.EnSafe();
            string strSQL = "update Tbl_Cargo_StockTakeTag set ScanStatus=@ScanStatus,StockStatus=@StockStatus,ScanLoginName=@ScanLoginName,ScanUserName=@ScanUserName,ScanDate = @ScanDate,Remark=@Remark where TagCode = @TagCode";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@TagCode", DbType.String, entity.TagCode);
                conn.AddInParameter(cmd, "@ScanStatus", DbType.String, entity.ScanStatus);
                conn.AddInParameter(cmd, "@StockStatus", DbType.String, entity.StockStatus);
                conn.AddInParameter(cmd, "@ScanLoginName", DbType.String, entity.ScanLoginName);
                conn.AddInParameter(cmd, "@ScanUserName", DbType.String, entity.ScanUserName);
                conn.AddInParameter(cmd, "@Remark", DbType.String, entity.Remark);
                conn.AddInParameter(cmd, "@ScanDate", DbType.DateTime, DateTime.Now);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 查询盘点标签数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoStockTakeTagEntity QueryStockTakeTagEntity(CargoStockTakeTagEntity entity)
        {
            CargoStockTakeTagEntity result = new CargoStockTakeTagEntity();
            string strQ = @"Select * from Tbl_Cargo_StockTakeTag Where (1=1)";
            if (!entity.StockID.Equals(0)) { strQ += " and StockID=" + entity.StockID; }
            if (!entity.ContainerID.Equals(0)) { strQ += " and ContainerID=" + entity.ContainerID; }
            if (!string.IsNullOrEmpty(entity.TagCode)) { strQ += " and TagCode='" + entity.TagCode + "'"; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmdQ))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.StockID = Convert.ToInt32(idr["StockID"]);
                        result.ContainerID = Convert.ToInt32(idr["ContainerID"]);
                        result.ProductID = Convert.ToInt64(idr["ProductID"]);
                        result.TagCode = Convert.ToString(idr["TagCode"]);
                        result.StockStatus = Convert.ToString(idr["StockStatus"]);
                        result.ScanStatus = Convert.ToString(idr["ScanStatus"]);
                        result.ScanLoginName = Convert.ToString(idr["ScanLoginName"]);
                        result.ScanUserName = Convert.ToString(idr["ScanUserName"]);
                        result.Remark = Convert.ToString(idr["Remark"]);
                        result.ScanDate = string.IsNullOrEmpty(Convert.ToString(idr["ScanDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["ScanDate"]);
                    }
                }
            }
            return result;
        }
        #endregion
        #region 销量统计
        public List<CargoContainerShowEntity> SaleStatistics(CargoContainerShowEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            try
            {
                string strSQL = @"select a12.*,isnull(a6.Piece,0) as a6Piece,isnull(a3.Piece,0) as a3Piece,isnull(a1.Piece,0) as a1Piece from 
(select TOP 100 PERCENT p.HouseID,h.Name,p.TypeID,pt.TypeName,p.Specs,p.Figure,p.GoodsCode,p.LoadIndex,p.SpeedLevel,SUM( og.Piece)as Piece from Tbl_Cargo_OrderGoods og inner join Tbl_Cargo_Product p on og.ProductID=p.ProductID inner join Tbl_Cargo_ProductType pt on p.TypeID=pt.TypeID inner join Tbl_Cargo_House h on p.HouseID=h.HouseID where DateDiff(mm,og.OP_DATE,getdate())<=12 and pt.ParentID=1 and og.HouseID=9 group by p.HouseID,h.Name,p.TypeID,pt.TypeName,p.Specs,p.Figure,p.GoodsCode,p.LoadIndex,p.SpeedLevel order by Piece desc)a12 left join(select TOP 100 PERCENT p.HouseID,h.Name,p.TypeID,pt.TypeName,p.Specs,p.Figure,p.GoodsCode,p.LoadIndex,p.SpeedLevel,SUM( og.Piece)as Piece from Tbl_Cargo_OrderGoods og inner join Tbl_Cargo_Product p on og.ProductID=p.ProductID inner join Tbl_Cargo_ProductType pt on p.TypeID=pt.TypeID inner join Tbl_Cargo_House h on p.HouseID=h.HouseID where DateDiff(mm,og.OP_DATE,getdate())<=6 and pt.ParentID=1 and og.HouseID=9 group by p.HouseID,h.Name,p.TypeID,pt.TypeName,p.Specs,p.Figure,p.GoodsCode,p.LoadIndex,p.SpeedLevel order by Piece desc)a6 on a12.HouseID=a6.HouseID and a12.TypeID=a6.TypeID and a12.Specs=a6.Specs and a12.Figure=a6.Figure and a12.GoodsCode=a6.GoodsCode and a12.LoadIndex=a6.LoadIndex and a12.SpeedLevel=a6.SpeedLevel left join(select TOP 100 PERCENT p.HouseID,h.Name,p.TypeID,pt.TypeName,p.Specs,p.Figure,p.GoodsCode,p.LoadIndex,p.SpeedLevel,SUM( og.Piece)as Piece from Tbl_Cargo_OrderGoods og inner join Tbl_Cargo_Product p on og.ProductID=p.ProductID inner join Tbl_Cargo_ProductType pt on p.TypeID=pt.TypeID inner join Tbl_Cargo_House h on p.HouseID=h.HouseID where DateDiff(mm,og.OP_DATE,getdate())<=3 and pt.ParentID=1 and og.HouseID=9 group by p.HouseID,h.Name,p.TypeID,pt.TypeName,p.Specs,p.Figure,p.GoodsCode,p.LoadIndex,p.SpeedLevel order by Piece desc)a3 on a6.HouseID=a3.HouseID and a6.TypeID=a3.TypeID and a6.Specs=a3.Specs and a6.Figure=a3.Figure and a6.GoodsCode=a3.GoodsCode and a6.LoadIndex=a3.LoadIndex and a6.SpeedLevel=a3.SpeedLevel left join (select TOP 100 PERCENT p.HouseID,h.Name,p.TypeID,pt.TypeName,p.Specs,p.Figure,p.GoodsCode,p.LoadIndex,p.SpeedLevel,SUM( og.Piece)as Piece from Tbl_Cargo_OrderGoods og inner join Tbl_Cargo_Product p on og.ProductID=p.ProductID inner join Tbl_Cargo_ProductType pt on p.TypeID=pt.TypeID inner join Tbl_Cargo_House h on p.HouseID=h.HouseID where DateDiff(mm,og.OP_DATE,getdate())=0 and pt.ParentID=1 and og.HouseID=9 group by p.HouseID,h.Name,p.TypeID,pt.TypeName,p.Specs,p.Figure,p.GoodsCode,p.LoadIndex,p.SpeedLevel order by Piece desc)a1 on a3.HouseID=a1.HouseID and a3.TypeID=a1.TypeID and a3.Specs=a1.Specs and a3.Figure=a1.Figure and a3.GoodsCode=a1.GoodsCode and a3.LoadIndex=a1.LoadIndex and a3.SpeedLevel=a1.SpeedLevel where (1=1) ";
                string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                if (res.Length <= 3)
                {
                    if (!string.IsNullOrEmpty(res)) { strSQL += " and a12.Specs like '%" + res + "%'"; }
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    strSQL += " and (a12.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or a12.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
                if (res.Length > 5)
                {
                    strSQL += " and (a12.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or a12.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or a12.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or a12.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or a12.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a12.Figure like '%" + entity.Figure + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a12.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a12.TypeID=" + entity.TypeID; }
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a12.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and a12.HouseID=" + entity.HouseID + ""; }
                if (string.IsNullOrEmpty(entity.SortType))
                {
                    strSQL += " order by a1Piece desc ";
                }
                else
                {
                    switch (entity.SortType)
                    {
                        case "-1":
                            strSQL += " order by HouseID desc ";
                            break;
                        case "0":
                            strSQL += " order by TypeID desc ";
                            break;
                        case "1":
                            strSQL += " order by a1Piece desc ";
                            break;
                        case "3":
                            strSQL += " order by a3Piece desc ";
                            break;
                        case "6":
                            strSQL += " order by a6Piece desc ";
                            break;
                        case "12":
                            strSQL += " order by Piece desc ";
                            break;
                        default:
                            strSQL += " order by a1Piece desc ";
                            break;
                    }
                }

                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoContainerShowEntity
                            {
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["Name"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                a12Piece = Convert.ToInt32(idr["Piece"]),
                                a6Piece = Convert.ToInt32(idr["a6Piece"]),
                                a3Piece = Convert.ToInt32(idr["a3Piece"]),
                                a1Piece = Convert.ToInt32(idr["a1Piece"]),
                            });
                        }
                    }
                }
                return result;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 插入小程序用户行为数据
        /// </summary>
        /// <param name="entity"></param>
        public void InsertCargoBehavior(CargoBehaviorEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"INSERT INTO Tbl_Cargo_Behavior(HouseID,ClientNum,wxOpenID,BehaType,OPDATE,KeyWord,TypeName,SearchResult) VALUES (@HouseID,@ClientNum,@wxOpenID,@BehaType,@OPDATE,@KeyWord,@TypeName,@SearchResult)";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                //conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID);
                conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                conn.AddInParameter(cmd, "@wxOpenID", DbType.String, entity.wxOpenID);
                conn.AddInParameter(cmd, "@BehaType", DbType.String, entity.BehaType);
                conn.AddInParameter(cmd, "@OPDATE", DbType.DateTime, entity.OPDATE);
                conn.AddInParameter(cmd, "@KeyWord", DbType.String, entity.KeyWord);
                conn.AddInParameter(cmd, "@TypeName", DbType.String, entity.TypeName);
                conn.AddInParameter(cmd, "@SearchResult", DbType.String, entity.SearchResult);
                conn.ExecuteNonQuery(cmd);
            }
        }

        #endregion
        #region 线路管理操作方法集合
        /// <summary>
        /// 判断线路名称是否有重复
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistCargoLogisLine(CargoLogisLineEntity entity)
        {
            string strQ = @"Select LineName from Tbl_Cargo_LogisLine Where LineName=@LineName and HouseID=@HouseID";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@LineName", DbType.String, entity.LineName);
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 新增线路数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoLogisLine(CargoLogisLineEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"INSERT INTO Tbl_Cargo_LogisLine(HouseID,LineName,Memo,DelFlag,OP_ID,LogisID,LogisticName) VALUES (@HouseID,@LineName,@Memo,@DelFlag,@OP_ID,@LogisID,@LogisticName)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    //conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID);
                    conn.AddInParameter(cmd, "@LogisID", DbType.Int32, entity.LogisID);
                    conn.AddInParameter(cmd, "@LogisticName", DbType.String, entity.LogisticName);
                    conn.AddInParameter(cmd, "@LineName", DbType.String, entity.LineName);
                    conn.AddInParameter(cmd, "@Memo", DbType.String, entity.Memo);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改线路数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoLogisLine(CargoLogisLineEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"UPDATE Tbl_Cargo_LogisLine SET LineName=@LineName,Memo=@Memo,DelFlag=@DelFlag,OP_ID=@OP_ID,LogisticName=@LogisticName,LogisID=@LogisID WHERE LineID=@LineID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@LineName", DbType.String, entity.LineName);
                    conn.AddInParameter(cmd, "@LogisID", DbType.Int32, entity.LogisID);
                    conn.AddInParameter(cmd, "@LogisticName", DbType.String, entity.LogisticName);
                    conn.AddInParameter(cmd, "@Memo", DbType.String, entity.Memo);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.AddInParameter(cmd, "@LineID", DbType.Int32, entity.LineID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除线路数据
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoLogisLine(List<CargoLogisLineEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"UPDATE Tbl_Cargo_LogisLine SET DelFlag='1' WHERE LineID=@LineID";
                    if (it.DelFlag.Equals("1"))//彻底删除
                    {
                        strSQL = @"Delete from Tbl_Cargo_LogisLine where LineID=@LineID ";
                    }
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@LineID", DbType.Int32, it.LineID);
                        conn.ExecuteNonQuery(cmd);
                    }

                    DelCargoLogisLineClient(new CargoLogisLineClientEntity { LineID = it.LineID });
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除线路客户关联数据
        /// </summary>
        /// <param name="entity"></param>
        public void DelCargoLogisLineClient(CargoLogisLineClientEntity entity)
        {
            string strSQL = @"Delete from Tbl_Cargo_LogisLineClient where LineID=@LineID ";
            if (!entity.ClientID.Equals(0)) { strSQL += " and ClientID=" + entity.ClientID; }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@LineID", DbType.Int32, entity.LineID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 查询线路数据
        /// </summary>
        /// <param name="houseID"></param>
        /// <returns></returns>
        public CargoLogisLineEntity QueryCargoLogisLineEntity(CargoLogisLineEntity entity)
        {
            CargoLogisLineEntity result = new CargoLogisLineEntity();
            string strSQL = @"SELECT * FROM Tbl_Cargo_LogisLine WHERE DelFlag='0' and HouseID=@HouseID ";
            if (!entity.LineID.Equals(0))
            {
                strSQL += " and LineID=" + entity.LineID;
            }
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.HouseID = Convert.ToInt32(idrCount["HouseID"]);
                            result.LineID = Convert.ToInt32(idrCount["LineID"]);
                            result.LogisID = Convert.ToInt32(idrCount["LogisID"]);
                            result.LineName = Convert.ToString(idrCount["LineName"]);
                            result.LogisticName = Convert.ToString(idrCount["LogisticName"]);
                            result.Memo = Convert.ToString(idrCount["Memo"]);
                            result.OP_ID = Convert.ToString(idrCount["OP_ID"]);
                            result.OP_DATE = Convert.ToDateTime(idrCount["OP_DATE"]);
                            result.DelFlag = Convert.ToString(idrCount["DelFlag"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询物流线路数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoLogisLineEntity> QueryCargoLogisLineList(CargoLogisLineEntity entity)
        {
            List<CargoLogisLineEntity> result = new List<CargoLogisLineEntity>();
            string strSQL = @"SELECT * FROM Tbl_Cargo_LogisLine WHERE DelFlag='0' ";
            if (!entity.HouseID.Equals(0)) { strSQL += " and HouseID=" + entity.HouseID; }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoLogisLineEntity
                        {
                            LineID = Convert.ToInt32(idr["LineID"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            LogisID = string.IsNullOrEmpty(Convert.ToString(idr["LogisID"])) ? 0 : Convert.ToInt32(idr["LogisID"]),
                            LogisticName = Convert.ToString(idr["LogisticName"]),
                            LineName = Convert.ToString(idr["LineName"]),
                            Memo = Convert.ToString(idr["Memo"]),
                            OP_ID = Convert.ToString(idr["OP_ID"]),
                            DelFlag = Convert.ToString(idr["DelFlag"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                        });
                    }
                }
            }
            return result;
        }

        /// <summary>
        /// 线路查询
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <param name="strCountWhere">查询总数的查询条件</param>
        /// <returns></returns>
        public Hashtable QueryCargoLogisLine(int pIndex, int pNum, CargoLogisLineEntity entity)
        {
            List<CargoLogisLineEntity> result = new List<CargoLogisLineEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.*,b.Name as HouseName FROM Tbl_Cargo_LogisLine as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID WHERE (1=1)";
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strSQL += " and a.DelFlag = '" + entity.DelFlag + "'"; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID = " + entity.HouseID; }
                //if (!entity.AreaID.Equals(0)) { strSQL += " and a.AreaID = " + entity.AreaID; }
                if (!entity.LogisID.Equals(0)) { strSQL += " and a.LogisID = " + entity.LogisID; }
                if (!string.IsNullOrEmpty(entity.LineName)) { strSQL += " and a.LineName like '%" + entity.LineName + "%'"; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoLogisLineEntity
                            {
                                LineID = Convert.ToInt32(idr["LineID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                //AreaID = Convert.ToInt32(idr["AreaID"]),
                                //AreaName = Convert.ToString(idr["AreaName"]),
                                LogisID = string.IsNullOrEmpty(Convert.ToString(idr["LogisID"])) ? 0 : Convert.ToInt32(idr["LogisID"]),
                                LogisticName = Convert.ToString(idr["LogisticName"]),
                                LineName = Convert.ToString(idr["LineName"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                DelFlag = Convert.ToString(idr["DelFlag"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_LogisLine Where (1=1)";
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strCount += " and DelFlag = '" + entity.DelFlag + "'"; }
                if (!entity.HouseID.Equals(0)) { strCount += " and HouseID = " + entity.HouseID; }
                //if (!entity.AreaID.Equals(0)) { strCount += " and AreaID = " + entity.AreaID; }
                if (!entity.LogisID.Equals(0)) { strCount += " and LogisID = " + entity.LogisID; }
                if (!string.IsNullOrEmpty(entity.LineName)) { strCount += " and LineName like '%" + entity.LineName + "%'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        /// <summary>
        /// 通过线路ID查询所有绑定的客户数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoLogisLineClientEntity> QueryLogisLineClientListData(CargoLogisLineClientEntity entity)
        {
            List<CargoLogisLineClientEntity> result = new List<CargoLogisLineClientEntity>();
            string strSQL = "select a.ID,a.LineID,a.ClientID,a.OP_ID,a.OP_DATE,b.ShopCode,b.ClientName,b.ClientShortName,b.Boss,b.Cellphone,b.Telephone,b.Province,b.City,b.Address from Tbl_Cargo_LogisLineClient as a inner join Tbl_Cargo_Client as b  on a.ClientID=b.ClientID where (1=1) ";
            if (!entity.LineID.Equals(0)) { strSQL += " and a.LineID=" + entity.LineID; }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoLogisLineClientEntity
                        {
                            LineID = Convert.ToInt32(idr["LineID"]),
                            ID = Convert.ToInt32(idr["ID"]),
                            ClientID = Convert.ToInt64(idr["ClientID"]),
                            ShopCode = Convert.ToString(idr["ShopCode"]),
                            ClientName = Convert.ToString(idr["ClientName"]),
                            ClientShortName = Convert.ToString(idr["ClientShortName"]),
                            Boss = Convert.ToString(idr["Boss"]),
                            Cellphone = Convert.ToString(idr["Cellphone"]),
                            Telephone = Convert.ToString(idr["Telephone"]),
                            Province = Convert.ToString(idr["Province"]),
                            City = Convert.ToString(idr["City"]),
                            Address = Convert.ToString(idr["Address"]),
                            OP_ID = Convert.ToString(idr["OP_ID"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 判断客户是否绑定线路
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistCargoLogisLineClient(CargoLogisLineClientEntity entity)
        {
            string strQ = @"Select * from Tbl_Cargo_LogisLineClient Where ClientID=@ClientID";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ClientID", DbType.Int32, entity.ClientID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 客户绑定线路数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoLogisLineClient(CargoLogisLineClientEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_LogisLineClient(LineID,ClientID,OP_ID) VALUES (@LineID,@ClientID,@OP_ID)";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@LineID", DbType.Int32, entity.LineID);
                conn.AddInParameter(cmd, "@ClientID", DbType.Int32, entity.ClientID);
                conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        public CargoLogisLineClientEntity QueryLogisLineClient(long ClientID)
        {
            CargoLogisLineClientEntity result = new CargoLogisLineClientEntity();
            string strSQL = @"SELECT * FROM Tbl_Cargo_LogisLineClient llc inner join Tbl_Cargo_LogisLine ll on llc.LineID=ll.LineID where ClientID=" + ClientID;
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.ID = Convert.ToInt32(idrCount["ID"]);
                            result.LineID = Convert.ToInt32(idrCount["LineID"]);
                            result.LineName = Convert.ToString(idrCount["LineName"]);
                            result.ClientID = Convert.ToInt64(idrCount["ClientID"]);
                            result.OP_ID = Convert.ToString(idrCount["OP_ID"]);
                            result.OP_DATE = Convert.ToDateTime(idrCount["OP_DATE"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        #endregion
        #region 线网关系操作方法
        /// <summary>
        /// 根据省，城市和仓库判断 是否已经存在
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistLineNetMapp(CargoLineNetMappingEntity entity)
        {
            string strQ = @"Select MID from Tbl_Cargo_HouseCityMapp Where ClientNum=@ClientNum and AreaID=@AreaID";

            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                //conn.AddInParameter(cmdQ, "@City", DbType.String, entity.City);
                //conn.AddInParameter(cmdQ, "@Province", DbType.String, entity.Province);
                conn.AddInParameter(cmdQ, "@ClientNum", DbType.Int32, entity.ClientNum);
                conn.AddInParameter(cmdQ, "@AreaID", DbType.Int32, entity.AreaID);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        public Hashtable QueryLineNetMapp(int pIndex, int pNum, CargoLineNetMappingEntity entity)
        {
            List<CargoLineNetMappingEntity> result = new List<CargoLineNetMappingEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY a.OPDATE DESC) AS RowNumber,a.*,b.Name as HouseName,c.Name as AreaName,d.ClientShortName,d.ClientName,d.ShopCode FROM Tbl_Cargo_HouseCityMapp as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID inner join Tbl_Cargo_Area as c on a.AreaID=c.AreaID inner join Tbl_Cargo_Client as d on a.ClientNum=d.ClientNum WHERE (1=1)";
                //if (!string.IsNullOrEmpty(entity.Province)) { strSQL += " and a.Province = '" + entity.Province + "'"; }
                //if (!string.IsNullOrEmpty(entity.City)) { strSQL += " and a.City = '" + entity.City + "'"; }
                if (!string.IsNullOrEmpty(entity.ShopCode)) { strSQL += " and d.ShopCode = '" + entity.ShopCode + "'"; }
                if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum=" + entity.ClientNum; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID; }
                if (!entity.AreaID.Equals(0)) { strSQL += " and a.AreaID=" + entity.AreaID; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoLineNetMappingEntity
                            {
                                MID = Convert.ToInt64(idr["MID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                //Province = Convert.ToString(idr["Province"]),
                                //City = Convert.ToString(idr["City"]),
                                OrderLevel = Convert.ToInt32(idr["OrderLevel"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                ClientShortName = Convert.ToString(idr["ClientShortName"]),
                                ShopCode = Convert.ToString(idr["ShopCode"]),
                                OPID = Convert.ToString(idr["OPID"]),
                                OPDATE = Convert.ToDateTime(idr["OPDATE"])
                            });
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_HouseCityMapp as a inner join Tbl_Cargo_Client as d on a.ClientNum=d.ClientNum Where (1=1)";
                if (!string.IsNullOrEmpty(entity.ShopCode)) { strCount += " and d.ShopCode = '" + entity.ShopCode + "'"; }
                if (!entity.ClientNum.Equals(0)) { strCount += " and a.ClientNum=" + entity.ClientNum; }
                if (!entity.HouseID.Equals(0)) { strCount += " and a.HouseID=" + entity.HouseID + ""; }
                if (!entity.AreaID.Equals(0)) { strCount += " and a.AreaID=" + entity.AreaID + ""; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 新增数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddLineNetMapp(CargoLineNetMappingEntity entity)
        {
            entity.EnSafe();
            //string strSQL = @"INSERT INTO Tbl_Cargo_HouseCityMapp(Province,City,AreaID,HouseID,OrderLevel,OPID) VALUES (@Province,@City,@AreaID,@HouseID,@OrderLevel,@OPID)";
            string strSQL = @"INSERT INTO Tbl_Cargo_HouseCityMapp(ClientNum,AreaID,HouseID,OrderLevel,OPID) VALUES (@ClientNum,@AreaID,@HouseID,@OrderLevel,@OPID)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(cmd, "@Province", DbType.String, entity.Province);
                    //conn.AddInParameter(cmd, "@City", DbType.String, entity.City);
                    conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                    conn.AddInParameter(cmd, "@AreaID", DbType.Int32, entity.AreaID);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@OrderLevel", DbType.Int32, entity.OrderLevel);
                    conn.AddInParameter(cmd, "@OPID", DbType.String, entity.OPID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateLineNetMapp(CargoLineNetMappingEntity entity)
        {
            entity.EnSafe();
            //string strSQL = @"UPDATE Tbl_Cargo_HouseCityMapp SET Province=@Province,City=@City,OPID=@OPID,OPDATE=@OPDATE WHERE MID=@MID";
            string strSQL = @"UPDATE Tbl_Cargo_HouseCityMapp SET OrderLevel=@OrderLevel,OPID=@OPID,OPDATE=@OPDATE WHERE MID=@MID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(cmd, "@Province", DbType.String, entity.Province);
                    conn.AddInParameter(cmd, "@OrderLevel", DbType.Int32, entity.OrderLevel);
                    conn.AddInParameter(cmd, "@OPID", DbType.String, entity.OPID);
                    conn.AddInParameter(cmd, "@OPDATE", DbType.DateTime, entity.OPDATE);
                    conn.AddInParameter(cmd, "@MID", DbType.Int64, entity.MID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除数据
        /// </summary>
        /// <param name="entity"></param>
        public void DelLineNetMapp(List<CargoLineNetMappingEntity> entity)
        {
            foreach (var it in entity)
            {
                string strSQL = @"Delete from Tbl_Cargo_HouseCityMapp where MID=@MID ";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@MID", DbType.Int64, it.MID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
        }
        #endregion
        #region 马牌同步方法
        public void UpdateContiOrderCreateData(saleOpenInfoResp entity)
        {
            string strSQL = "Update Tbl_Cargo_ContiOrder set ClientNum=@ClientNum,InCreateStatus=@InCreateStatus,CreateAwbID=@CreateAwbID,CreateAwb=@CreateAwb,CreateDate=@CreateDate,CargoOrderNo=@CargoOrderNo where orderCode=@orderCode";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ClientNum", DbType.Int32, entity.ClientNum);
                conn.AddInParameter(cmd, "@InCreateStatus", DbType.String, entity.InCreateStatus);
                conn.AddInParameter(cmd, "@CreateAwbID", DbType.String, entity.CreateAwbID);
                conn.AddInParameter(cmd, "@CreateAwb", DbType.String, entity.CreateAwb);
                conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, entity.CreateDate);
                conn.AddInParameter(cmd, "@CargoOrderNo", DbType.String, entity.CargoOrderNo);
                conn.AddInParameter(cmd, "@orderCode", DbType.String, entity.orderCode);
                conn.ExecuteNonQuery(cmd);
            }
        }
        #endregion

        #region 仓库订单语音播报
        /// <summary>
        /// 获取语音播报列表
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoVoiceBroadEntity> GetVoiceBroadList(CargoVoiceBroadEntity entity)
        {
            List<CargoVoiceBroadEntity> result = new List<CargoVoiceBroadEntity>();
            string strSQL = "Select * from Tbl_Cargo_VoiceBroad where (1=1)";
            if (!entity.HouseID.Equals(0))
            {
                strSQL += " and HouseID=" + entity.HouseID;
            }
            if (!string.IsNullOrEmpty(entity.LoginName))
            {
                strSQL += " and LoginName=" + entity.LoginName;
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoVoiceBroadEntity
                        {
                            HouseID = Convert.ToInt32(idrCount["HouseID"]),
                            LoginName = Convert.ToString(idrCount["LoginName"]),
                            UserName = Convert.ToString(idrCount["userName"]),
                            VoiceID = Convert.ToInt32(idrCount["VoiceID"]),
                        });
                    }
                }
            }
            return result;
        }

        /// <summary>
        /// 删除
        /// </summary>
        /// <param name="entity"></param>
        /// <exception cref="ApplicationException"></exception>
        public void DelCargoVoiceBroad(List<CargoVoiceBroadEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"DELETE FROM Tbl_Cargo_VoiceBroad WHERE VoiceID =@VoiceID";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@VoiceID", DbType.Int32, it.VoiceID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        /// <summary>
        /// 新增
        /// </summary>
        /// <param name="entity"></param>
        /// <exception cref="ApplicationException"></exception>
        public void AddCargoVoiceBroad(List<CargoVoiceBroadEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"INSERT INTO Tbl_Cargo_VoiceBroad ( LoginName, UserName, HouseID, OP_DATE) VALUES ( @LoginName, @UserName, @HouseID, GETDATE()); ";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@LoginName", DbType.String, it.LoginName);
                        conn.AddInParameter(cmd, "@UserName", DbType.String, it.UserName);
                        conn.AddInParameter(cmd, "@HouseID", DbType.Int32, it.HouseID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 
        /// </summary>
        /// <param name="housePermision"></param>
        /// <returns></returns>
        //public List<CargoHouseEntity> VoiceBroadHouseList(string housePermision)
        //{
        //    List<CargoHouseEntity> result = new List<CargoHouseEntity>();
        //    string strSQL = "Select * from Tbl_Cargo_VoiceBroad where (1=1)";
        //    if (!entity.HouseID.Equals(0))
        //    {
        //        strSQL += " and HouseID=" + entity.HouseID;
        //    }
        //    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
        //    {
        //        using (DataTable dt = conn.ExecuteDataTable(cmd))
        //        {
        //            foreach (DataRow idrCount in dt.Rows)
        //            {
        //                result.Add(new CargoVoiceBroadEntity
        //                {
        //                    HouseID = Convert.ToInt32(idrCount["HouseID"]),
        //                    LoginName = Convert.ToString(idrCount["LoginName"]),
        //                    UserName = Convert.ToString(idrCount["userName"]),
        //                    VoiceID = Convert.ToInt32(idrCount["VoiceID"]),
        //                });
        //            }
        //        }
        //    }
        //    return result;
        //}


        #endregion

        #region 仓库目标

        public List<CargoHouseAimEntity> QueryHouseAimList(CargoHouseAimEntity entity)
        {
            List<CargoHouseAimEntity> list = new List<CargoHouseAimEntity>();
            string strSQL = "select  * from Tbl_Cargo_HouseAim where HouseID=@HouseID order by OP_DATE desc";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@HouseID", DbType.String, entity.HouseID);
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        list.Add(new CargoHouseAimEntity()
                        {
                            ID = Convert.ToInt32(idr["ID"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            AimYear = Convert.ToInt32(idr["AimYear"]),
                            AimMonth = Convert.ToInt32(idr["AimMonth"]),
                            AimQuantity = Convert.ToInt32(idr["AimQuantity"]),
                            AimMoney = Convert.ToDecimal(Convert.ToString(idr["AimMoney"])),
                            OPID = Convert.ToString(idr["OPID"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                        });
                    }
                }
            }
            return list;
        }


        public bool IsExistCargoHouseAim(CargoHouseAimEntity entity)
        {
            string strQ = @"select AimYear,AimMonth from Tbl_Cargo_HouseAim where HouseID=@HouseID and AimYear=@AimYear and AimMonth=@AimMonth";

            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmdQ, "@AimYear", DbType.Int32, entity.AimYear);
                conn.AddInParameter(cmdQ, "@AimMonth", DbType.Int32, entity.AimMonth);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }


        public bool IsExistCargoHouseShare(CargoHouseBrandShareEntity entity)
        {
            string strQ = @"select  * from Tbl_Cargo_HouseBrandShare where MainHouseID=@MainHouseID and ShareHouseID=@ShareHouseID and BrandID=@BrandID";
            if (entity.ID != 0)
            {
                strQ += $@" and ID<>@ID ";
            }

            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@MainHouseID", DbType.Int32, entity.MainHouseID);
                conn.AddInParameter(cmdQ, "@ShareHouseID", DbType.Int32, entity.ShareHouseID);
                conn.AddInParameter(cmdQ, "@BrandID", DbType.Int32, entity.BrandID);
                if (entity.ID != 0)
                {
                    conn.AddInParameter(cmdQ, "@ID", DbType.Int32, entity.ID);
                }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 新增仓库目标数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoHouseAim(CargoHouseAimEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"INSERT INTO Tbl_Cargo_HouseAim(HouseID, AimYear, AimMonth, AimQuantity, AimMoney, OPID, OP_DATE) values (@HouseID, @AimYear, @AimMonth, @AimQuantity, @AimMoney, @OPID, @OP_DATE)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@AimYear", DbType.Int32, entity.AimYear);
                    conn.AddInParameter(cmd, "@AimMonth", DbType.Int32, entity.AimMonth);
                    conn.AddInParameter(cmd, "@AimQuantity", DbType.Int32, entity.AimQuantity);
                    conn.AddInParameter(cmd, "@AimMoney", DbType.Decimal, entity.AimMoney);
                    conn.AddInParameter(cmd, "@OPID", DbType.String, entity.OPID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, entity.OP_DATE);

                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 新增品牌共享仓库数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddCargoHouseShare(CargoHouseBrandShareEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"insert into Tbl_Cargo_HouseBrandShare (ShareHouseID, MainHouseID, BrandID, OPID, OP_DATE, DelFlag,UpPriceType,FixMoney,RatePrice) values (@ShareHouseID, @MainHouseID, @BrandID, @OPID, @OP_DATE, @DelFlag,@UpPriceType,@FixMoney,@RatePrice);";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ShareHouseID", DbType.Int32, entity.ShareHouseID);
                    conn.AddInParameter(cmd, "@MainHouseID", DbType.Int32, entity.MainHouseID);
                    conn.AddInParameter(cmd, "@BrandID", DbType.Int32, entity.BrandID);
                    conn.AddInParameter(cmd, "@OPID", DbType.Int32, entity.OPID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, entity.OP_DATE);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.Int32, entity.DelFlag);
                    conn.AddInParameter(cmd, "@UpPriceType", DbType.Int32, entity.UpPriceType);
                    conn.AddInParameter(cmd, "@FixMoney", DbType.Decimal, entity.FixMoney);
                    conn.AddInParameter(cmd, "@RatePrice", DbType.Decimal, entity.RatePrice);

                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改品牌共享仓库数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoHouseShare(CargoHouseBrandShareEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"update Tbl_Cargo_HouseBrandShare set ShareHouseID=@ShareHouseID,BrandID=@BrandID,UpPriceType=@UpPriceType,FixMoney=@FixMoney,RatePrice=@RatePrice where ID=@ID;";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ShareHouseID", DbType.Int32, entity.ShareHouseID);
                    conn.AddInParameter(cmd, "@BrandID", DbType.Int32, entity.BrandID);
                    conn.AddInParameter(cmd, "@UpPriceType", DbType.Int32, entity.UpPriceType);
                    conn.AddInParameter(cmd, "@FixMoney", DbType.Decimal, entity.FixMoney);
                    conn.AddInParameter(cmd, "@RatePrice", DbType.Decimal, entity.RatePrice);
                    conn.AddInParameter(cmd, "@ID", DbType.Int32, entity.ID);

                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }


        /// <summary>
        /// 删除
        /// </summary>
        /// <param name="entity"></param>
        /// <exception cref="ApplicationException"></exception>
        public void DelHouseAim(List<CargoHouseAimEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"DELETE FROM Tbl_Cargo_HouseAim WHERE ID =@ID";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ID", DbType.Int32, it.ID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        /// <summary>
        /// 删除
        /// </summary>
        /// <param name="entity"></param>
        /// <exception cref="ApplicationException"></exception>
        public void DelHouseShare(List<CargoHouseBrandShareEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    //string strSQL = @"update Tbl_Cargo_HouseBrandShare set DelFlag=1 where ID=@ID";
                    string strSQL = @"delete from Tbl_Cargo_HouseBrandShare where ID=@ID";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ID", DbType.Int32, it.ID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion

        #region 品牌仓库共享
        public List<CargoHouseBrandShareEntity> QueryHouseShareList(CargoHouseBrandShareEntity entity)
        {
            List<CargoHouseBrandShareEntity> list = new List<CargoHouseBrandShareEntity>();
            string strSQL = $@"select  a.*,b.Name MainHouseName,c.Name as ShareHouseName,d.TypeName as BrandName,UpPriceType,FixMoney,RatePrice from Tbl_Cargo_HouseBrandShare as a
                              inner join dbo.Tbl_Cargo_House b on a.MainHouseID=b.HouseID
                              inner join dbo.Tbl_Cargo_House c on a.ShareHouseID=c.HouseID
                              inner join dbo.Tbl_Cargo_ProductType d on a.BrandID=d.TypeID
                              where MainHouseID=@MainHouseID and a.DelFlag=0 order by OP_DATE desc";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@MainHouseID", DbType.String, entity.MainHouseID);
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        list.Add(new CargoHouseBrandShareEntity()
                        {
                            ID = Convert.ToInt32(idr["ID"]),
                            MainHouseID = Convert.ToInt32(idr["MainHouseID"]),
                            ShareHouseID = Convert.ToInt32(idr["ShareHouseID"]),
                            BrandID = Convert.ToInt32(idr["BrandID"]),
                            MainHouseName = Convert.ToString(idr["MainHouseName"]),
                            ShareHouseName = Convert.ToString(idr["ShareHouseName"]),
                            BrandName = Convert.ToString(idr["BrandName"]),
                            UpPriceType = Convert.ToInt32(idr["UpPriceType"]),
                            FixMoney = Convert.ToDecimal(idr["FixMoney"]),
                            RatePrice = Convert.ToDecimal(idr["RatePrice"]),
                            DelFlag = Convert.ToInt32(idr["DelFlag"]),
                            OPID = Convert.ToString(idr["OPID"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                        });
                    }
                }
            }
            return list;
        }


        #endregion
        public List<CargoAreaEntity> GetHouseAreaList()
        {
            List<CargoAreaEntity> list = new List<CargoAreaEntity>();
            string strSQL = $@"select  * from Tbl_Cargo_Area where 1=1";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        list.Add(new CargoAreaEntity()
                        {
                            AreaID = Convert.ToInt32(idr["AreaID"]),
                            Name = Convert.ToString(idr["Name"]),
                            Code = Convert.ToString(idr["Code"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            ParentID = Convert.ToInt32(idr["ParentID"]),
                            Remark = Convert.ToString(idr["Remark"]),
                            AreaType = Convert.ToString(idr["AreaType"]),
                            OrderCode = Convert.ToString(idr["OrderCode"]),
                            OrderDep = Convert.ToString(idr["OrderDep"]),
                            Longitude = Convert.ToString(idr["Longitude"]),
                            Latitude = Convert.ToString(idr["Latitude"]),
                            Address = Convert.ToString(idr["Address"]),
                            DelFlag = Convert.ToString(idr["DelFlag"]),
                            VirtualInventory = Convert.ToString(idr["VirtualInventory"]),
                            ContiHouseCode = Convert.ToString(idr["ContiHouseCode"]),
                            IsShowStock = Convert.ToString(idr["IsShowStock"])
                        });
                    }
                }
            }
            return list;
        }

        public CargoSafeStockEntity FirstSafeStock(CargoSafeStockEntity entity)
        {
            CargoSafeStockEntity cargo = null;
            string strSQL = $@"select  * from Tbl_Cargo_SafeStock where HouseID=@HouseID and AreaID=@AreaID and ProductCode=@ProductCode";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@AreaID", DbType.String, entity.AreaID);
                conn.AddInParameter(command, "@HouseID", DbType.String, entity.HouseID);
                conn.AddInParameter(command, "@ProductCode", DbType.String, entity.ProductCode);
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        cargo = (new CargoSafeStockEntity()
                        {
                            AreaID = Convert.ToInt32(idr["AreaID"]),
                            OPID = Convert.ToString(idr["OPID"]),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            GoodsCode = Convert.ToString(idr["GoodsCode"]),
                            Specs = Convert.ToString(idr["Specs"]),
                            ProductCode = Convert.ToString(idr["ProductCode"]),
                            HouseID = Convert.ToString(idr["HouseID"]),
                            SID = long.Parse(Convert.ToString(idr["SID"])),
                        });
                    }
                }
            }
            return cargo;
        }

        public string QueryHouseNameByID(int HouseID)
        {
            string strSQL = $"select Name from Tbl_Cargo_House where HouseID = @HouseID";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(command, "@HOuseID", DbType.Int32, HouseID);
                string HouseName = conn.ExecuteScalar(command)?.ToString();
                return HouseName;
            }
        }
    }

}
