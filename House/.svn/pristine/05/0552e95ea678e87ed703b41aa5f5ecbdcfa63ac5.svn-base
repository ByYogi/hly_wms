using House.DataAccess;
using House.Entity.Cargo;
using House.Entity.Cargo.Order;
using House.Entity.Dto;
using House.Entity.House;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Linq;
using System.Runtime.Remoting.Metadata.W3cXsd2001;
using System.Security.Cryptography;
using System.Text;

namespace House.Manager.Cargo
{
    /// <summary>
    /// 财务管理模块数据实现类
    /// </summary>
    public class CargoFinanceManager
    {
        private SqlHelper conn = new SqlHelper();
        #region 基础数据管理
        /// <summary>
        /// 查询基础数据
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <returns></returns>
        public Hashtable QueryFinanceBasicData(int pIndex, int pNum, CargoFinanceBasicDataEntity entity)
        {

            List<CargoFinanceBasicDataEntity> result = new List<CargoFinanceBasicDataEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select DISTINCT ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.*,b.Name as HouseName from Tbl_Cargo_BasicData as a left join Tbl_Cargo_House as b on a.HouseID=b.HouseID where (1=1) ";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.PermisBasicID)) { strSQL += " and a.BasicID in (" + entity.PermisBasicID + ")"; }
                //适用仓库
                if (!string.IsNullOrEmpty(entity.ApplyHouseID))
                {
                    strSQL += " and CHARINDEX(','+'" + entity.ApplyHouseID + "'+',' , ','+a.ApplyHouseID+',') > 0";
                }
                //状态
                if (!string.IsNullOrEmpty(entity.Status))
                {
                    strSQL += " and a.Status = '" + entity.Status + "'";
                }
                //卡类型
                if (!string.IsNullOrEmpty(entity.CardType))
                {
                    strSQL += " and a.CardType = '" + entity.CardType + "'";
                }
                strSQL += " ) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1))";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.Add(new CargoFinanceBasicDataEntity
                            {
                                BasicID = Convert.ToInt32(idr["BasicID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ApplyHouseID = Convert.ToString(idr["ApplyHouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                CardType = Convert.ToString(idr["CardType"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                Bank = Convert.ToString(idr["Bank"]),
                                CardName = Convert.ToString(idr["CardName"]),
                                OverMoney = Convert.ToDecimal(idr["OverMoney"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                Status = Convert.ToString(idr["Status"]),
                                CardNum = Convert.ToString(idr["CardNum"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                Aliases = Convert.ToString(idr["Aliases"])
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_BasicData as a  Where (1=1)";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.PermisBasicID)) { strCount += " and a.BasicID in (" + entity.PermisBasicID + ")"; }
                //状态
                if (!string.IsNullOrEmpty(entity.Status)) { strCount += " and a.Status = '" + entity.Status + "'"; }
                //卡类型
                if (!string.IsNullOrEmpty(entity.CardType)) { strCount += " and a.CardType = '" + entity.CardType + "'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 删除或作废，恢复财务基础数据
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="ty">0:注销1:彻底删除2:恢复数据</param>
        public void DelBasicData(List<CargoFinanceBasicDataEntity> entity, int ty)
        {

            try
            {
                foreach (var it in entity)
                {
                    it.EnSafe();
                    string strDel = @"UPDATE Tbl_Cargo_BasicData SET Status=1 WHERE BasicID=@BasicID";
                    if (ty.Equals(1))
                    {
                        strDel = @"Delete From Tbl_Cargo_BasicData WHERE BasicID=@BasicID";
                    }
                    if (ty.Equals(2))
                    {
                        strDel = @"UPDATE Tbl_Cargo_BasicData SET Status=0 WHERE BasicID=@BasicID";
                    }
                    using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                    {
                        conn.AddInParameter(cmdAdd, "@BasicID", DbType.Int32, it.BasicID);
                        conn.ExecuteNonQuery(cmdAdd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 按BasicID查询数据
        /// </summary>
        /// <param name="ItemID"></param>
        /// <returns></returns>
        public CargoFinanceBasicDataEntity GetFinanceBasicDataByID(int BasicID)
        {

            CargoFinanceBasicDataEntity result = new CargoFinanceBasicDataEntity();
            try
            {
                string strSQL = @"SELECT * from Tbl_Cargo_BasicData Where BasicID=@BasicID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@BasicID", DbType.Int32, BasicID);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result = new CargoFinanceBasicDataEntity
                            {
                                BasicID = Convert.ToInt32(idr["BasicID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ApplyHouseID = Convert.ToString(idr["ApplyHouseID"]),
                                CardType = Convert.ToString(idr["CardType"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                Bank = Convert.ToString(idr["Bank"]),
                                CardName = Convert.ToString(idr["CardName"]),
                                OverMoney = Convert.ToDecimal(idr["OverMoney"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                Status = Convert.ToString(idr["Status"]),
                                CardNum = Convert.ToString(idr["CardNum"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                Aliases = Convert.ToString(idr["Aliases"])
                            };
                        }
                    }

                }
                return result;
            }
            catch (ApplicationException ex)
            {
                throw new ApplicationException(ex.Message);
            }
        }
        /// <summary>
        /// 根据当前城市查询当前城市的现金账户
        /// </summary>
        /// <param name="citycode"></param>
        /// <param name="ty"></param>
        /// <returns></returns>
        public CargoFinanceBasicDataEntity GetFinanceBasicDataByCityCode(CargoFinanceBasicDataEntity entity)
        {

            CargoFinanceBasicDataEntity result = new CargoFinanceBasicDataEntity();
            try
            {
                string strSQL = @"SELECT * from Tbl_Cargo_BasicData Where (1=1) ";
                if (!string.IsNullOrEmpty(entity.CardType))
                {
                    strSQL += " and CardType=@CardType ";
                }
                if (!entity.HouseID.Equals(0))
                {
                    strSQL += " and HouseID=@HouseID";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!string.IsNullOrEmpty(entity.CardType))
                    {
                        conn.AddInParameter(cmd, "@CardType", DbType.String, entity.CardType);
                    }
                    if (!entity.HouseID.Equals(0))
                    {
                        conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    }
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result = new CargoFinanceBasicDataEntity
                            {
                                BasicID = Convert.ToInt32(idr["BasicID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ApplyHouseID = Convert.ToString(idr["ApplyHouseID"]),
                                CardType = Convert.ToString(idr["CardType"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                Bank = Convert.ToString(idr["Bank"]),
                                CardName = Convert.ToString(idr["CardName"]),
                                OverMoney = Convert.ToDecimal(idr["OverMoney"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                Status = Convert.ToString(idr["Status"]),
                                CardNum = Convert.ToString(idr["CardNum"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                Aliases = Convert.ToString(idr["Aliases"])
                            };
                        }
                    }

                }
                return result;
            }
            catch (ApplicationException ex)
            {
                throw new ApplicationException(ex.Message);
            }
        }
        /// <summary>
        /// 新增财务基础数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddFinanceBasicData(CargoFinanceBasicDataEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_BasicData(HouseID,ApplyHouseID,CardType,Aliases,Bank,CardName,CardNum,OverMoney,Memo,Status,OP_ID) VALUES (@HouseID,@ApplyHouseID,@CardType,@Aliases,@Bank,@CardName,@CardNum,@OverMoney,@Memo,@Status,@OP_ID)";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmd, "@ApplyHouseID", DbType.String, entity.ApplyHouseID);
                conn.AddInParameter(cmd, "@CardType", DbType.String, entity.CardType);
                conn.AddInParameter(cmd, "@Aliases", DbType.String, entity.Aliases);
                conn.AddInParameter(cmd, "@Bank", DbType.String, entity.Bank);
                conn.AddInParameter(cmd, "@CardName", DbType.String, entity.CardName);
                conn.AddInParameter(cmd, "@CardNum", DbType.String, entity.CardNum);
                conn.AddInParameter(cmd, "@OverMoney", DbType.Decimal, entity.OverMoney);
                conn.AddInParameter(cmd, "@Memo", DbType.String, entity.Memo);
                conn.AddInParameter(cmd, "@Status", DbType.String, entity.Status);
                conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 修改财务基础数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateFinanceBasicData(CargoFinanceBasicDataEntity entity)
        {

            string strSQL = @"UPDATE Tbl_Cargo_BasicData SET HouseID = @HouseID,ApplyHouseID = @ApplyHouseID,CardType = @CardType,Aliases = @Aliases,Bank = @Bank,CardName = @CardName,CardNum = @CardNum,OverMoney = @OverMoney,Memo = @Memo,Status = @Status,OP_ID = @OP_ID,OP_DATE = @OP_DATE WHERE BasicID=@BasicID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@ApplyHouseID", DbType.String, entity.ApplyHouseID);
                    conn.AddInParameter(cmd, "@CardType", DbType.String, entity.CardType);
                    conn.AddInParameter(cmd, "@Aliases", DbType.String, entity.Aliases);
                    conn.AddInParameter(cmd, "@Bank", DbType.String, entity.Bank);
                    conn.AddInParameter(cmd, "@CardName", DbType.String, entity.CardName);
                    conn.AddInParameter(cmd, "@CardNum", DbType.String, entity.CardNum);
                    conn.AddInParameter(cmd, "@OverMoney", DbType.Decimal, entity.OverMoney);
                    conn.AddInParameter(cmd, "@Memo", DbType.String, entity.Memo);
                    conn.AddInParameter(cmd, "@Status", DbType.String, entity.Status);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.AddInParameter(cmd, "@BasicID", DbType.Int32, entity.BasicID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);

                }
            }
            catch (ApplicationException ex)
            {
                throw new ApplicationException(ex.Message);
            }
        }

        public void saveCashManagePermis(SystemUserEntity entity)
        {
            string strSQL = "update Tbl_SysUser set PermisCashName=@PermisCashName where LoginName=@LoginName";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@PermisCashName", DbType.String, entity.PermisCashName);
                conn.AddInParameter(cmd, "@LoginName", DbType.String, entity.LoginName);
                conn.ExecuteNonQuery(cmd);

            }
        }

        #endregion
        #region 应收账款管理
        /// <summary>
        /// 应收帐款管理财务二次审核
        /// </summary>
        /// <param name="entity"></param>
        public void plSecondCheckOrder(List<CargoOrderEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    it.EnSafe();
                    string strDel = @"UPDATE Tbl_Cargo_Order SET FinanceSecondCheck=@FinanceSecondCheck,FinanceSecondCheckName=@FinanceSecondCheckName,FinanceSecondCheckDate=@FinanceSecondCheckDate WHERE OrderID=@OrderID and OrderNo=@OrderNo";
                    using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                    {
                        conn.AddInParameter(cmdAdd, "@FinanceSecondCheck", DbType.String, it.FinanceSecondCheck);
                        conn.AddInParameter(cmdAdd, "@FinanceSecondCheckName", DbType.String, it.FinanceSecondCheckName);
                        conn.AddInParameter(cmdAdd, "@FinanceSecondCheckDate", DbType.DateTime, DateTime.Now);
                        conn.AddInParameter(cmdAdd, "@OrderNo", DbType.String, it.OrderNo);
                        conn.AddInParameter(cmdAdd, "@OrderID", DbType.Int64, it.OrderID);
                        conn.ExecuteNonQuery(cmdAdd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 预订单 应收帐款管理财务二次审核
        /// </summary>
        /// <param name="entity"></param>
        public void plSecondCheckReserveOrder(List<CargoReserveOrderEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    it.EnSafe();
                    string strDel = @"UPDATE Tbl_Cargo_ReserveOrder SET FinanceSecondCheck=@FinanceSecondCheck,FinanceSecondCheckName=@FinanceSecondCheckName,FinanceSecondCheckDate=@FinanceSecondCheckDate WHERE OrderID=@OrderID and OrderNo=@OrderNo";
                    using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                    {
                        conn.AddInParameter(cmdAdd, "@FinanceSecondCheck", DbType.String, it.FinanceSecondCheck);
                        conn.AddInParameter(cmdAdd, "@FinanceSecondCheckName", DbType.String, it.FinanceSecondCheckName);
                        conn.AddInParameter(cmdAdd, "@FinanceSecondCheckDate", DbType.DateTime, DateTime.Now);
                        conn.AddInParameter(cmdAdd, "@OrderNo", DbType.String, it.OrderNo);
                        conn.AddInParameter(cmdAdd, "@OrderID", DbType.Int64, it.OrderID);
                        conn.ExecuteNonQuery(cmdAdd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 客户账单审批
        /// </summary>
        /// <param name="entity"></param>
        public void plCheckAccount(List<CargoClientAccountEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    it.EnSafe();
                    string strDel = @"UPDATE Tbl_Cargo_ClientAccount SET Status=@Status,NextCheckID=@NextCheckID,NextCheckName=@NextCheckName,NextCheckDate=@NextCheckDate WHERE AccountID=@AccountID";
                    using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                    {
                        conn.AddInParameter(cmdAdd, "@Status", DbType.String, it.Status);
                        conn.AddInParameter(cmdAdd, "@NextCheckID", DbType.String, it.NextCheckID);
                        conn.AddInParameter(cmdAdd, "@NextCheckName", DbType.String, it.NextCheckName);
                        conn.AddInParameter(cmdAdd, "@NextCheckDate", DbType.DateTime, DateTime.Now);
                        conn.AddInParameter(cmdAdd, "@AccountID", DbType.String, it.AccountID);
                        conn.ExecuteNonQuery(cmdAdd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion
        #region 出纳收款操作
        /// <summary>
        /// 查询财务二审通过的订单数据用以出纳收款操作
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderEntity> QueryOrderForCash(CargoOrderEntity entity)
        {
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();

            try
            {
                entity.EnSafe();
                string ar = string.Empty;
                string[] arr = entity.OrderNo.Split(',');
                for (int i = 0; i < arr.Length; i++)
                {
                    if (string.IsNullOrEmpty(arr[i])) { continue; }
                    if (i == arr.Length - 1) { ar += arr[i]; break; }
                    ar += arr[i] + "','";
                }
                #region 组装查询SQL语句

                string strSQL = @"Select a.*,ISNULL(b.PreReceiveMoney,0) as PreReceiveMoney,ISNULL(b.RebateMoney,0) as RebateMoney,c.WXPayOrderNo,c.PayWay,(case when a.CheckStatus=1 then a.TotalCharge else isnull ((select sum(fr.AffectCash+fr.AffectCard+fr.AffectWX+fr.AffectAlipay) from Tbl_Cargo_RecordAwbID ra inner join Tbl_Cargo_FinanceRecord fr on ra.RecordID=fr.RecordID where AffectNo=a.OrderNo and fr.RType=0 and fr.FromTO=0 and fr.RevokeType=0),0) end)as ReceivedMoney from Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum left join Tbl_WX_Order as c on a.WXOrderNo=c.OrderNo Where (1=1) ";
                //下单方式
                if (!string.IsNullOrEmpty(entity.AccountNo)) { strSQL += " and a.AccountNo = '" + entity.AccountNo + "'"; }
                if (!string.IsNullOrEmpty(entity.OrderType)) { strSQL += " and a.OrderType = '" + entity.OrderType + "'"; }
                //订单号 
                if (!string.IsNullOrEmpty(ar))
                {
                    //strSQL += " and a.AwbNo = '" + entity.AwbNo.ToUpper() + "'";
                    strSQL += " and a.OrderNo in ('" + ar + "')";
                }
                //收货单位,人
                if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strSQL += " and a.AcceptPeople like'%" + entity.AcceptPeople + "%'"; }
                if (!string.IsNullOrEmpty(entity.PayClientName)) { strSQL += " and a.PayClientName='" + entity.PayClientName + "'"; }
                if (!entity.PayClientNum.Equals(0)) { strSQL += " and a.PayClientNum=" + entity.PayClientNum; }
                //到达站
                if (!string.IsNullOrEmpty(entity.Dest))
                {
                    string[] ccs = entity.Dest.Split(',');
                    string res = string.Empty;
                    for (int i = 0; i < ccs.Length; i++)
                    {
                        res += ccs[i] + "','";
                    }
                    res = res.Substring(0, res.Length - 3);
                    strSQL += " and a.Dest in ('" + res + "')";
                }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //二审审核状态
                if (!string.IsNullOrEmpty(entity.FinanceSecondCheck))
                {
                    strSQL += " and a.FinanceSecondCheck=" + entity.FinanceSecondCheck + "";
                }
                //结算状态
                if (!string.IsNullOrEmpty(entity.CheckStatus)) { strSQL += " and a.CheckStatus=" + entity.CheckStatus + ""; }
                //订单类型
                if (!string.IsNullOrEmpty(entity.ThrowGood)) { strSQL += " and a.ThrowGood ='" + entity.ThrowGood + "'"; }
                strSQL += " Order by a.CreateDate Desc";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            //decimal ReceivedMoney = 0.00M;

                            #region 查询已收款 2022-12-01修改为sql关联查询
                            //if (idr["CheckStatus"].ToString() == "1")
                            //{
                            //    ReceivedMoney = Convert.ToDecimal(idr["TotalCharge"]);
                            //}
                            //else
                            //{
                            //    DataTable record = QueryFinanceRecordByNo(Convert.ToString(idr["OrderNo"]), entity.RType, entity.FromTO);
                            //    if (record != null)
                            //    {
                            //        foreach (DataRow drr in record.Rows)
                            //        {
                            //            ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                            //        }
                            //    }
                            //}
                            #endregion

                            #region 获取运单数据
                            result.Add(new CargoOrderEntity
                            {
                                OrderID = Convert.ToInt64(idr["OrderID"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                Dep = Convert.ToString(idr["Dep"]),
                                Dest = Convert.ToString(idr["Dest"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                ThrowGood = Convert.ToString(idr["ThrowGood"]),
                                InsuranceFee = Convert.ToDecimal(idr["InsuranceFee"]),
                                TransitFee = Convert.ToDecimal(idr["TransitFee"]),
                                TransportFee = Convert.ToDecimal(idr["TransportFee"]),
                                DeliveryFee = Convert.ToDecimal(idr["DeliveryFee"]),
                                OtherFee = Convert.ToDecimal(idr["OtherFee"]),
                                TotalCharge = Convert.ToDecimal(idr["TotalCharge"]),
                                Rebate = Convert.ToDecimal(idr["Rebate"]),
                                CheckOutType = Convert.ToString(idr["CheckOutType"]),
                                TrafficType = Convert.ToString(idr["TrafficType"]),
                                DeliveryType = Convert.ToString(idr["DeliveryType"]),
                                PayClientName = Convert.ToString(idr["PayClientName"]),
                                PayClientNum = Convert.ToInt32(idr["PayClientNum"]),
                                AcceptUnit = Convert.ToString(idr["AcceptUnit"]),
                                AcceptAddress = Convert.ToString(idr["AcceptAddress"]),
                                AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                                AcceptTelephone = Convert.ToString(idr["AcceptTelephone"]),
                                AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                AwbStatus = Convert.ToString(idr["AwbStatus"]),
                                CreateAwb = Convert.ToString(idr["CreateAwb"]),
                                SaleManID = Convert.ToString(idr["SaleManID"]),
                                SaleManName = Convert.ToString(idr["SaleManName"]),
                                OrderType = Convert.ToString(idr["OrderType"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                FinanceSecondCheck = Convert.ToString(idr["FinanceSecondCheck"]),
                                FinanceSecondCheckName = Convert.ToString(idr["FinanceSecondCheckName"]),
                                FinanceSecondCheckDate = string.IsNullOrEmpty(Convert.ToString(idr["FinanceSecondCheckDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["FinanceSecondCheckDate"]),
                                PreReceiveMoney = Convert.ToDecimal(idr["PreReceiveMoney"]),
                                RebateMoney = Convert.ToDecimal(idr["RebateMoney"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                WXOrderNo = Convert.ToString(idr["OrderType"]).Equals("0") || Convert.ToString(idr["OrderType"]).Equals("1") ? "" : Convert.ToString(idr["WXOrderNo"]),
                                PayWay = Convert.ToString(idr["PayWay"]),
                                WXPayOrderNo = Convert.ToString(idr["WXPayOrderNo"]),
                                ReceivedMoney = Convert.ToDecimal(idr["ReceivedMoney"])
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询客户账单
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoClientAccountEntity> QueryAccountForCash(CargoClientAccountEntity entity)
        {
            List<CargoClientAccountEntity> result = new List<CargoClientAccountEntity>();

            try
            {
                entity.EnSafe();
                string ar = string.Empty;
                string[] arr = entity.AccountID.Split(',');
                for (int i = 0; i < arr.Length; i++)
                {
                    if (string.IsNullOrEmpty(arr[i])) { continue; }
                    if (i == arr.Length - 1) { ar += arr[i]; break; }
                    ar += arr[i] + "','";
                }
                #region 组装查询SQL语句

                string strSQL = @"Select a.*,ISNULL(b.PreReceiveMoney,0) as PreReceiveMoney,ISNULL(b.RebateMoney,0) as RebateMoney,c.Name as HouseName,b.Boss from Tbl_Cargo_ClientAccount as a inner join Tbl_Cargo_Client as b on a.ClientID=b.ClientID inner join Tbl_Cargo_House as c on a.HouseID=c.HouseID ";
                //订单号 
                if (!string.IsNullOrEmpty(ar)) { strSQL += " and a.AccountID in ('" + ar + "')"; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID; }
                if (!entity.ClientID.Equals(0)) { strSQL += " and a.ClientID=" + entity.ClientID; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //审核状态
                if (!string.IsNullOrEmpty(entity.Status)) { strSQL += " and a.Status=" + entity.Status + ""; }
                //结算状态
                if (!string.IsNullOrEmpty(entity.CheckStatus)) { strSQL += " and a.CheckStatus=" + entity.CheckStatus + ""; }
                strSQL += " Order by a.CreateDate Desc";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            decimal ReceivedMoney = 0.00M;

                            #region 查询已收款
                            DataTable record = QueryFinanceRecordByNo(Convert.ToString(idr["AccountID"]), entity.RType, entity.FromTO);
                            if (record != null)
                            {
                                foreach (DataRow drr in record.Rows)
                                {
                                    ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                                }
                            }
                            #endregion

                            #region 获取运单数据
                            result.Add(new CargoClientAccountEntity
                            {
                                AccountID = Convert.ToString(idr["AccountID"]),
                                ClientID = Convert.ToInt64(idr["ClientID"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                ClientName = Convert.ToString(idr["Boss"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                AccountTitle = Convert.ToString(idr["AccountTitle"]),
                                //ARMoney = string.IsNullOrEmpty(Convert.ToString(idr["ARMoney"])) ? 0 : Convert.ToDecimal(idr["ARMoney"]),
                                Total = string.IsNullOrEmpty(Convert.ToString(idr["Total"])) ? 0 : Convert.ToDecimal(idr["Total"]),
                                RebateMoney = string.IsNullOrEmpty(Convert.ToString(idr["RebateMoney"])) ? 0 : Convert.ToDecimal(idr["RebateMoney"]),
                                PreReceiveMoney = string.IsNullOrEmpty(Convert.ToString(idr["PreReceiveMoney"])) ? 0 : Convert.ToDecimal(idr["PreReceiveMoney"]),
                                //TaxFee = string.IsNullOrEmpty(Convert.ToString(idr["TaxFee"])) ? 0 : Convert.ToDecimal(idr["TaxFee"]),
                                //OtherFee = string.IsNullOrEmpty(Convert.ToString(idr["OtherFee"])) ? 0 : Convert.ToDecimal(idr["OtherFee"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                Status = Convert.ToString(idr["Status"]),
                                NextCheckID = Convert.ToString(idr["NextCheckID"]),
                                NextCheckName = Convert.ToString(idr["NextCheckName"]),
                                NextCheckDate = string.IsNullOrEmpty(Convert.ToString(idr["NextCheckDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["NextCheckDate"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                OPID = Convert.ToString(idr["OPID"]),
                                OPDATE = Convert.ToDateTime(idr["OPDATE"]),
                                AType = Convert.ToString(idr["AType"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ReceivedMoney = ReceivedMoney
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询已经审核结束的报销单用以出纳收款
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoExpenseEntity> QueryExpenseForCash(CargoExpenseEntity entity)
        {
            List<CargoExpenseEntity> result = new List<CargoExpenseEntity>();
            try
            {
                entity.EnSafe();
                string ar = string.Empty;
                string[] arr = entity.ExpenseID.Split(',');
                for (int i = 0; i < arr.Length; i++)
                {
                    if (string.IsNullOrEmpty(arr[i]))
                    {
                        continue;
                    }
                    if (i == arr.Length - 1)
                    {
                        ar += arr[i];
                        break;
                    }
                    ar += arr[i] + ",";
                }

                #region 组装查询SQL语句
                string strSQL = @" SELECT a.ExID,a.ExName,a.ExDate,a.ReceiveName,a.ReceiveNumber,a.ChargeType,a.ExCharge,a.OperaID,a.OperaName,a.Reason,a.ExpenseDate,a.Status,a.CheckStatus,a.DenyReason,ISNULL(a.UserID,0) as UserID,a.UserName,a.CheckTime,a.OP_ID,a.NextCheckID,a.NextCheckName,a.ApproveID,a.ExType,ISNULL(a.ClientID,0) as ClientID,a.ClientName from Tbl_Cargo_Expense as a where (1=1) ";
                //报销单号
                if (!string.IsNullOrEmpty(ar)) { strSQL += " and a.ExID in (" + ar + ")"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //报销人
                if (!string.IsNullOrEmpty(entity.ExName)) { strSQL += " and a.ExName like  '%" + entity.ExName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveName)) { strSQL += " and a.ReceiveName like  '%" + entity.ReceiveName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveNumber)) { strSQL += " and a.ReceiveNumber like  '%" + entity.ReceiveNumber + "%'"; }
                //报销操作人ID
                if (!string.IsNullOrEmpty(entity.OperaID)) { strSQL += " and a.OperaID = '" + entity.OperaID + "'"; }
                //当前审批人ID
                if (!string.IsNullOrEmpty(entity.NextCheckID)) { strSQL += " and a.NextCheckID like '%" + entity.NextCheckID + "%'"; }
                ////报销类别
                //if (!string.IsNullOrEmpty(entity.CostName)) { strSQL += " and d.SName like  '%" + entity.CostName + "%'"; }
                //客户ID
                if (!entity.ClientID.Equals(0)) { strSQL += " and a.ClientID = '" + entity.ClientID + "'"; }
                //客户名称
                if (!string.IsNullOrEmpty(entity.ClientName)) { strSQL += " and a.ClientName = '" + entity.ClientName + "'"; }
                //报销单状态
                if (!string.IsNullOrEmpty(entity.Status)) { strSQL += " and a.Status = '" + entity.Status + "'"; }
                //结算状态
                if (!string.IsNullOrEmpty(entity.CheckStatus)) { strSQL += " and a.CheckStatus = '" + entity.CheckStatus + "'"; }
                //报销类型
                if (!string.IsNullOrEmpty(entity.ExType)) { strSQL += " and a.ExType = '" + entity.ExType + "'"; }
                //报销日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExpenseDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExpenseDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " order by a.ExpenseDate desc";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            string cn = string.Empty;
                            string sid = string.Empty;
                            List<CargoExpenseDetailEntity> detail = GetExpenseDetailById(Convert.ToInt64(idr["ExID"]));
                            foreach (var it in detail)
                            {
                                cn += it.SName + ",";
                                sid += it.SID + ",";
                            }
                            decimal ReceivedMoney = 0.00M;

                            #region 查询已收款
                            DataTable record = QueryFinanceRecordByNo(Convert.ToString(idr["ExID"]), entity.RType, entity.FromTO);
                            if (record != null)
                            {
                                foreach (DataRow drr in record.Rows)
                                {
                                    ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                                }
                            }
                            #endregion

                            #region 获取运单数据
                            result.Add(new CargoExpenseEntity
                            {
                                ExID = Convert.ToInt64(idr["ExID"]),
                                ExName = Convert.ToString(idr["ExName"]),
                                ExDate = Convert.ToDateTime(idr["ExDate"]),
                                ReceiveName = Convert.ToString(idr["ReceiveName"]),
                                ReceiveNumber = Convert.ToString(idr["ReceiveNumber"]),
                                CostName = string.IsNullOrEmpty(cn) ? "" : cn.Substring(0, cn.Length - 1),
                                CostSID = string.IsNullOrEmpty(sid) ? "" : sid.Substring(0, sid.Length - 1),
                                ChargeType = Convert.ToString(idr["ChargeType"]),
                                ExCharge = Convert.ToDecimal(idr["ExCharge"]),
                                OperaID = Convert.ToString(idr["OperaID"]),
                                OperaName = Convert.ToString(idr["OperaName"]),
                                ExpenseDate = Convert.ToDateTime(idr["ExpenseDate"]),
                                Status = Convert.ToString(idr["Status"]),
                                DenyReason = Convert.ToString(idr["DenyReason"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                Reason = Convert.ToString(idr["Reason"]),
                                ApproveID = Convert.ToInt32(idr["ApproveID"]),
                                NextCheckID = Convert.ToString(idr["NextCheckID"]),
                                NextCheckName = Convert.ToString(idr["NextCheckName"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                UserName = Convert.ToString(idr["UserName"]),
                                ExType = Convert.ToString(idr["ExType"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                ClientID = Convert.ToInt32(idr["ClientID"]),
                                CheckTime = string.IsNullOrEmpty(Convert.ToString(idr["CheckTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["CheckTime"]),
                                ReceivedMoney = ReceivedMoney
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public List<CargoOrderEntity> QueryPurchaseForCash(CargoOrderEntity entity)
        {
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();
            try
            {
                entity.EnSafe();
                string ar = string.Empty;
                string[] arr = entity.OrderNo.Split(',');
                for (int i = 0; i < arr.Length; i++)
                {
                    if (string.IsNullOrEmpty(arr[i]))
                    {
                        continue;
                    }
                    if (i == arr.Length - 1)
                    {
                        ar += arr[i];
                        break;
                    }
                    ar += arr[i] + ",";
                }

                #region 组装查询SQL语句
                string strSQL = @" SELECT a.* from Tbl_Cargo_PurchaseOrder as a inner join Tbl_Cargo_Client b on a.ClientNum=b.ClientNum where (1=1) ";
                //报销单号
                if (!string.IsNullOrEmpty(ar)) { strSQL += " and a.OrderID in (" + ar + ")"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!string.IsNullOrEmpty(entity.CreateAwb)) { strSQL += " and a.CreateAwb like  '%" + entity.CreateAwb + "%'"; }
                if (!entity.ClientID.Equals(0)) { strSQL += " and b.ClientNum = '" + entity.ClientID + "'"; }
                if (!string.IsNullOrEmpty(entity.AcceptUnit)) { strSQL += " and b.Boss ='" + entity.AcceptUnit + "'"; }
                //结算状态
                if (!string.IsNullOrEmpty(entity.CheckStatus)) { strSQL += " and a.CheckStatus = '" + entity.CheckStatus + "'"; }
                //报销日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " order by a.CreateDate desc";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            decimal ReceivedMoney = 0.00M;

                            #region 查询已收款
                            DataTable record = QueryFinanceRecordByNo(Convert.ToString(idr["OrderID"]), entity.RType, entity.FromTO);
                            if (record != null)
                            {
                                foreach (DataRow drr in record.Rows)
                                {
                                    ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                                }
                            }
                            #endregion

                            #region 获取运单数据
                            result.Add(new CargoOrderEntity
                            {
                                OrderID = Convert.ToInt64(idr["OrderID"]),
                                LogisAwbNo = Convert.ToString(idr["LogisAwbNo"]),
                                LogisID = Convert.ToInt32(idr["LogisID"]),
                                DeliverySettlement = Convert.ToString(idr["DeliverySettlement"]),
                                Dep = Convert.ToString(idr["Dep"]),
                                Dest = Convert.ToString(idr["Dest"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                TransitFee = Convert.ToDecimal(idr["TransitFee"]),
                                TransportFee = Convert.ToDecimal(idr["TransportFee"]),
                                HandFee = Convert.ToDecimal(idr["HandFee"]),
                                OtherFee = Convert.ToDecimal(idr["OtherFee"]),
                                TotalCharge = Convert.ToDecimal(idr["TotalCharge"]),
                                CheckOutType = Convert.ToString(idr["CheckOutType"]),
                                TrafficType = Convert.ToString(idr["TrafficType"]),
                                DeliveryType = Convert.ToString(idr["DeliveryType"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                AcceptUnit = Convert.ToString(idr["AcceptUnit"]),
                                AcceptAddress = Convert.ToString(idr["AcceptAddress"]),
                                AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                                AcceptTelephone = Convert.ToString(idr["AcceptTelephone"]),
                                AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                                CreateAwbID = Convert.ToString(idr["CreateAwbID"]),
                                CreateAwb = Convert.ToString(idr["CreateAwb"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                AccountNo = Convert.ToString(idr["AccountNo"]),
                                ReceivedMoney = ReceivedMoney
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 通过运单号或账单号查询收支明细
        /// </summary>
        /// <param name="no"></param>
        /// <param name="rtype"></param>
        /// <param name="fromto"></param>
        /// <returns></returns>
        public DataTable QueryFinanceRecordByNo(string no, string rtype, string fromto)
        {

            DataTable idr = new DataTable();
            try
            {
                string strSQL = @"SELECT (a.AffectCash+a.AffectCard+a.AffectWX+a.AffectAlipay) as AffectTotal,a.OP_ID,a.OP_DATE,a.UserName,a.TradeType FROM Tbl_Cargo_FinanceRecord as a inner join Tbl_Cargo_RecordAwbID as c on a.RecordID=c.RecordID Where a.RType='" + rtype + "' and a.FromTO='" + fromto + "' and a.RevokeType=0";
                if (!string.IsNullOrEmpty(no))
                {
                    strSQL += " and c.AffectNo ='" + no.ToUpper() + "'";
                    //strSQL += " and a.AffectAwbNO like '%" + no.ToUpper() + "%'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    idr = conn.ExecuteDataTable(cmd);
                }
                return idr;
            }
            catch (ApplicationException ex) { if (idr != null) { idr.Dispose(); } throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 客户预付款扣款
        /// </summary>
        /// <param name="awb"></param>
        public void SavePreClientCash(CargoCashierEntity awb)
        {
            CargoOrderManager order = new CargoOrderManager();
            CargoClientManager client = new CargoClientManager();
            CargoWeiXinManager weixin = new CargoWeiXinManager();
            if (awb.FromTO.Equals("0"))
            {
                #region 按订单结预收款
                foreach (var it in awb.OrderNo)
                {
                    string orderNoCheck = string.Empty;
                    CargoOrderEntity orderEnt = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = it });
                    if (orderEnt == null) { continue; }
                    CargoClientEntity clientEnt = client.QueryCargoClient(orderEnt.ClientID);
                    decimal ReceivedMoney = 0.00M;
                    #region 查询已收款
                    DataTable record = QueryFinanceRecordByNo(orderEnt.OrderNo, awb.RType, awb.FromTO);
                    if (record != null)
                    {
                        foreach (DataRow drr in record.Rows)
                        {
                            ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                            //uname = Convert.ToString(drr["UserName"]);
                            //opdate = Convert.ToDateTime(drr["OP_DATE"]);
                        }
                    }
                    #endregion
                    decimal Money = 0.00M;
                    decimal NoReceiveMoney = orderEnt.TransportFee - ReceivedMoney;//应收金额
                    if (NoReceiveMoney > orderEnt.PreReceiveMoney) { orderNoCheck = "2"; Money = orderEnt.PreReceiveMoney; } else { orderNoCheck = "1"; Money = NoReceiveMoney; }
                    //保存客户预收款的扣款记录
                    client.UpdateClientPreRecord(new CargoClientPreRecordEntity
                    {
                        ClientID = orderEnt.ClientID,
                        ExID = orderEnt.OrderNo,
                        Money = Money,
                        IsAdd = false,
                        RecordType = "1",
                        OperaType = "0",
                        OP_ID = awb.OP_ID
                    });
                    //保存交易记录
                    long cardID = 0;
                    CargoCashierEntity card = new CargoCashierEntity();
                    card.BasicID = orderEnt.ClientNum;
                    card.RType = awb.RType;
                    card.FromTO = awb.FromTO;
                    card.AffectAwbNO = orderEnt.OrderNo;
                    card.AffectCash = Money;
                    card.Memo = awb.Memo;
                    card.OP_ID = awb.OP_ID;
                    card.OP_DATE = awb.OP_DATE;
                    card.UserName = awb.UserName;
                    card.TradeType = "1";
                    cardID = AddCardInfo(card);
                    AddRecordAwbID(cardID, orderEnt.OrderNo);
                    //修改订单的结算状态
                    order.UpdateCheckStatusByOrderNo(orderEnt.OrderNo, orderNoCheck);
                    if (clientEnt.ClientType.Equals("1"))
                    {
                        //月结客户加回额度
                        weixin.UpdateClientLimitMoney(Money, clientEnt.ClientNum, "0");
                    }
                }
                #endregion
            }
            else if (awb.FromTO.Equals("5"))
            {
                #region 按账单结预收款

                foreach (var it in awb.OrderNo)
                {
                    string orderNoCheck = string.Empty;
                    CargoClientAccountEntity orderEnt = client.QueryCargoClientAccount(new CargoClientAccountEntity { AccountID = it });
                    if (orderEnt == null) { continue; }
                    CargoClientEntity clientEnt = client.QueryCargoClient(orderEnt.ClientID);
                    decimal ReceivedMoney = 0.00M;
                    #region 查询已收款
                    DataTable record = QueryFinanceRecordByNo(orderEnt.OrderNo, awb.RType, awb.FromTO);
                    if (record != null)
                    {
                        foreach (DataRow drr in record.Rows)
                        {
                            ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                            //uname = Convert.ToString(drr["UserName"]);
                            //opdate = Convert.ToDateTime(drr["OP_DATE"]);
                        }
                    }
                    #endregion
                    decimal Money = 0.00M;
                    decimal NoReceiveMoney = orderEnt.Total - ReceivedMoney;//应收金额
                    if (NoReceiveMoney > clientEnt.PreReceiveMoney) { orderNoCheck = "2"; Money = clientEnt.PreReceiveMoney; } else { orderNoCheck = "1"; Money = NoReceiveMoney; }
                    //保存客户预收款的扣款记录
                    client.UpdateClientPreRecord(new CargoClientPreRecordEntity
                    {
                        ClientID = orderEnt.ClientID,
                        ExID = orderEnt.AccountID,
                        Money = Money,
                        IsAdd = false,
                        RecordType = "1",
                        OperaType = "0",
                        OP_ID = awb.OP_ID
                    });
                    //保存交易记录
                    long cardID = 0;
                    CargoCashierEntity card = new CargoCashierEntity();
                    card.BasicID = orderEnt.ClientNum;
                    card.RType = awb.RType;
                    card.FromTO = awb.FromTO;
                    card.AffectAwbNO = orderEnt.AccountID;
                    card.AffectCash = Money;
                    card.Memo = awb.Memo;
                    card.OP_ID = awb.OP_ID;
                    card.OP_DATE = awb.OP_DATE;
                    card.UserName = awb.UserName;
                    card.TradeType = "1";
                    cardID = AddCardInfo(card);
                    AddRecordAwbID(cardID, orderEnt.AccountID);
                    //修改账单单的结算状态
                    client.UpdateClientAccountCheckStatus(orderEnt.AccountID, orderNoCheck);
                    if (clientEnt.ClientType.Equals("1"))
                    {
                        //月结客户加回额度
                        weixin.UpdateClientLimitMoney(Money, clientEnt.ClientNum, "0");
                    }
                }
                #endregion

            }
        }
        /// <summary>
        /// 客户返利款结款
        /// </summary>
        /// <param name="awb"></param>
        public void SaveRebateClientCash(CargoCashierEntity awb)
        {
            CargoOrderManager order = new CargoOrderManager();
            CargoClientManager client = new CargoClientManager();
            CargoWeiXinManager weixin = new CargoWeiXinManager();
            if (awb.FromTO.Equals("0"))
            {
                #region 按订单结返利

                foreach (var it in awb.OrderNo)
                {
                    string orderNoCheck = string.Empty;
                    CargoOrderEntity orderEnt = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = it });
                    if (orderEnt == null) { continue; }
                    CargoClientEntity clientEnt = client.QueryCargoClient(orderEnt.ClientID);
                    decimal ReceivedMoney = 0.00M;
                    #region 查询已收款
                    DataTable record = QueryFinanceRecordByNo(orderEnt.OrderNo, awb.RType, awb.FromTO);
                    if (record != null)
                    {
                        foreach (DataRow drr in record.Rows)
                        {
                            ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                            //uname = Convert.ToString(drr["UserName"]);
                            //opdate = Convert.ToDateTime(drr["OP_DATE"]);
                        }
                    }
                    #endregion
                    decimal Money = 0.00M;
                    decimal NoReceiveMoney = orderEnt.TotalCharge - ReceivedMoney;//应收金额
                    if (orderEnt.HouseID.Equals(82))
                    {
                        //华南城配仓下单时扣除返利
                        //orderEnt.RebateMoney += orderEnt.InsuranceFee;
                    }
                    if (NoReceiveMoney > orderEnt.RebateMoney)
                    { orderNoCheck = "2"; Money = orderEnt.RebateMoney; }
                    else { orderNoCheck = "1"; Money = NoReceiveMoney; }
                    //保存客户预收款的扣款记录
                    client.UpdateClientPreRecord(new CargoClientPreRecordEntity
                    {
                        ClientID = orderEnt.ClientID,
                        ExID = orderEnt.OrderNo,
                        Money = Money,
                        IsAdd = false,
                        RecordType = "1",
                        OperaType = "1",
                        Remark = awb.Memo,
                        OP_ID = awb.OP_ID
                    });

                    //保存交易记录
                    long cardID = 0;
                    CargoCashierEntity card = new CargoCashierEntity();
                    card.BasicID = orderEnt.ClientNum;
                    card.RType = awb.RType;
                    card.FromTO = awb.FromTO;
                    card.AffectAwbNO = orderEnt.OrderNo;
                    card.AffectCash = Money;
                    card.Memo = awb.Memo;
                    card.OP_ID = awb.OP_ID;
                    card.OP_DATE = awb.OP_DATE;
                    card.UserName = awb.UserName;
                    card.TradeType = "2";
                    cardID = AddCardInfo(card);
                    AddRecordAwbID(cardID, orderEnt.OrderNo);
                    //修改订单的结算状态
                    order.UpdateCheckStatusByOrderNo(orderEnt.OrderNo, orderNoCheck);
                    if (clientEnt.ClientType.Equals("1"))
                    {
                        //月结客户加回额度
                        weixin.UpdateClientLimitMoney(Money, clientEnt.ClientNum, "0");
                    }
                }
                #endregion
            }
            else if (awb.FromTO.Equals("5"))
            {
                #region 按账单结返利

                foreach (var it in awb.OrderNo)
                {
                    string orderNoCheck = string.Empty;
                    CargoClientAccountEntity orderEnt = client.QueryCargoClientAccount(new CargoClientAccountEntity { AccountID = it });
                    if (orderEnt == null) { continue; }
                    CargoClientEntity clientEnt = client.QueryCargoClient(orderEnt.ClientID);
                    decimal ReceivedMoney = 0.00M;
                    #region 查询已收款
                    DataTable record = QueryFinanceRecordByNo(orderEnt.AccountID, awb.RType, awb.FromTO);
                    if (record != null)
                    {
                        foreach (DataRow drr in record.Rows)
                        {
                            ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                            //uname = Convert.ToString(drr["UserName"]);
                            //opdate = Convert.ToDateTime(drr["OP_DATE"]);
                        }
                    }
                    #endregion
                    decimal Money = 0.00M;
                    decimal NoReceiveMoney = orderEnt.Total - ReceivedMoney;//应收金额
                    if (NoReceiveMoney > clientEnt.RebateMoney)
                    { orderNoCheck = "2"; Money = clientEnt.RebateMoney; }
                    else { orderNoCheck = "1"; Money = NoReceiveMoney; }
                    //保存客户预收款的扣款记录
                    client.UpdateClientPreRecord(new CargoClientPreRecordEntity
                    {
                        ClientID = orderEnt.ClientID,
                        ExID = orderEnt.AccountID,
                        Money = Money,
                        IsAdd = false,
                        RecordType = "1",
                        OperaType = "1",
                        Remark = awb.Memo,
                        OP_ID = awb.OP_ID
                    });
                    //保存交易记录
                    long cardID = 0;
                    CargoCashierEntity card = new CargoCashierEntity();
                    card.BasicID = orderEnt.ClientNum;
                    card.RType = awb.RType;
                    card.FromTO = awb.FromTO;
                    card.AffectAwbNO = orderEnt.AccountID;
                    card.AffectCash = Money;
                    card.Memo = awb.Memo;
                    card.OP_ID = awb.OP_ID;
                    card.OP_DATE = awb.OP_DATE;
                    card.UserName = awb.UserName;
                    card.TradeType = "2";
                    cardID = AddCardInfo(card);
                    AddRecordAwbID(cardID, orderEnt.AccountID);
                    //修改账单单的结算状态
                    client.UpdateClientAccountCheckStatus(orderEnt.AccountID, orderNoCheck);
                    if (clientEnt.ClientType.Equals("1"))
                    {
                        //月结客户加回额度
                        weixin.UpdateClientLimitMoney(Money, clientEnt.ClientNum, "0");
                    }
                }
                #endregion
            }
        }
        /// <summary>
        /// 出纳收款保存
        /// </summary>
        public void SaveCash(CargoCashierEntity awb)
        {
            CargoOrderManager order = new CargoOrderManager();
            CargoCashierEntity card = new CargoCashierEntity();
            CargoCashierEntity cash = new CargoCashierEntity();
            CargoCashierEntity wx = new CargoCashierEntity();
            CargoCashierEntity ali = new CargoCashierEntity();
            try
            {
                awb.EnSafe();
                //0.查询受影响前的银行卡余额
                if (awb.AffectCard != 0)
                {
                    CargoFinanceBasicDataEntity cashEnt = GetFinanceBasicDataByID(awb.BasicID);
                    card.BeforeMoney = cashEnt.OverMoney;
                    card.BasicID = cashEnt.BasicID;
                    card.AffectCard = awb.AffectCard;
                    card.AffectAwbNO = awb.AffectAwbNO;
                    card.AffectClient = awb.AffectClient;
                    card.RType = awb.RType;
                    card.OP_ID = awb.OP_ID;
                    card.FromTO = awb.FromTO;
                    card.Memo = awb.Memo;
                    card.TradeType = "0";
                    card.UserName = awb.UserName;
                    card.WxOrderNo = awb.WxOrderNo;
                }
                //1.当前仓库的现金账号
                if (awb.AffectCash != 0)
                {
                    CargoFinanceBasicDataEntity cashEnt = GetFinanceBasicDataByID(awb.CashID);
                    //FinanceBasicDataEntity cashEnt = GetFinanceBasicDataByCityCode(awb.City, "0");
                    cash.BasicID = cashEnt.BasicID;
                    cash.AffectCash = awb.AffectCash;
                    cash.AffectAwbNO = awb.AffectAwbNO;
                    cash.AffectClient = awb.AffectClient;
                    cash.RType = awb.RType;
                    cash.OP_ID = awb.OP_ID;
                    cash.FromTO = awb.FromTO;
                    cash.Memo = awb.Memo;
                    cash.BeforeMoney = cashEnt.OverMoney;
                    cash.UserName = awb.UserName;
                    cash.TradeType = "0";
                    cash.WxOrderNo = awb.WxOrderNo;
                }
                //微信
                if (awb.AffectWX != 0)
                {
                    CargoFinanceBasicDataEntity cashEnt = GetFinanceBasicDataByID(awb.WxID);
                    wx.BeforeMoney = cashEnt.OverMoney;
                    wx.BasicID = cashEnt.BasicID;
                    wx.AffectWX = awb.AffectWX;
                    wx.RType = awb.RType;
                    wx.OP_ID = awb.OP_ID;
                    wx.FromTO = awb.FromTO;
                    wx.Memo = awb.Memo;
                    wx.AffectAwbNO = awb.AffectAwbNO;
                    wx.AffectClient = awb.AffectClient;
                    wx.UserName = awb.UserName;
                    wx.TradeType = string.IsNullOrEmpty(awb.TradeType) ? "0" : awb.TradeType;
                    wx.WxOrderNo = awb.WxOrderNo;
                }
                //支付宝
                if (awb.AffectAlipay != 0)
                {
                    CargoFinanceBasicDataEntity cashEnt = GetFinanceBasicDataByID(awb.AliID);
                    ali.BeforeMoney = cashEnt.OverMoney;
                    ali.BasicID = cashEnt.BasicID;
                    ali.AffectAlipay = awb.AffectAlipay;
                    ali.RType = awb.RType;
                    ali.OP_ID = awb.OP_ID;
                    ali.FromTO = awb.FromTO;
                    ali.Memo = awb.Memo;
                    ali.AffectAwbNO = awb.AffectAwbNO;
                    ali.AffectClient = awb.AffectClient;
                    ali.UserName = awb.UserName;
                    ali.TradeType = "0";
                    ali.WxOrderNo = awb.WxOrderNo;
                }
                #region 收款  付款
                if (awb.FromTO == "0" || awb.FromTO == "2" || awb.FromTO == "5" || awb.FromTO == "8" || awb.FromTO == "13")
                {
                    //2.修改银行卡上的余额收款
                    if (awb.AffectCard != 0)
                    {
                        UpdateCardOverMoney(card.AffectCard, card.BasicID, "0");
                        card.OverMoney = card.BeforeMoney + awb.AffectCard;
                    }
                    //3.修改现金账户上的余额收款
                    if (awb.AffectCash != 0)
                    {
                        UpdateCardOverMoney(cash.AffectCash, cash.BasicID, "0");
                        cash.OverMoney = cash.BeforeMoney + awb.AffectCash;
                    }
                    //4.修改微信账户上的余额收款
                    if (awb.AffectWX != 0)
                    {
                        UpdateCardOverMoney(wx.AffectWX, wx.BasicID, "0");
                        wx.OverMoney = wx.BeforeMoney + awb.AffectWX;
                    }
                    //5.修改支付宝账户上的余额收款
                    if (awb.AffectAlipay != 0)
                    {
                        UpdateCardOverMoney(ali.AffectAlipay, ali.BasicID, "0");
                        ali.OverMoney = ali.BeforeMoney + awb.AffectAlipay;
                    }
                }
                else if (awb.FromTO == "3" || awb.FromTO == "4" || awb.FromTO == "6" || awb.FromTO == "7" || awb.FromTO == "14")
                {
                    //2.修改银行卡上的余额收款
                    if (awb.AffectCard != 0)
                    {
                        UpdateCardOverMoney(card.AffectCard, card.BasicID, "1");
                        card.OverMoney = card.BeforeMoney - awb.AffectCard;
                    }
                    //3.修改现金账户上的余额收款
                    if (awb.AffectCash != 0)
                    {
                        UpdateCardOverMoney(cash.AffectCash, cash.BasicID, "1");
                        cash.OverMoney = cash.BeforeMoney - awb.AffectCash;
                    }
                    //4.修改微信账户上的余额收款
                    if (awb.AffectWX != 0)
                    {
                        UpdateCardOverMoney(wx.AffectWX, wx.BasicID, "1");
                        wx.OverMoney = wx.BeforeMoney - awb.AffectWX;
                    }
                    //5.修改支付宝账户上的余额收款
                    if (awb.AffectAlipay != 0)
                    {
                        UpdateCardOverMoney(ali.AffectAlipay, ali.BasicID, "1");
                        ali.OverMoney = ali.BeforeMoney - awb.AffectAlipay;
                    }
                }
                //else if (awb.FromTO == "4")
                //{
                //    //2.修改银行卡上的余额收款
                //    if (awb.AffectCard > 0)
                //    {
                //        UpdateCardOverMoney(card.AffectCard, card.BasicID, "1");
                //        card.OverMoney = card.BeforeMoney - awb.AffectCard;
                //    }
                //    //3.修改现金账户上的余额收款
                //    if (awb.AffectCash > 0)
                //    {
                //        UpdateCardOverMoney(cash.AffectCash, cash.BasicID, "1");
                //        cash.OverMoney = cash.BeforeMoney - awb.AffectCash;
                //    }
                //    //4.修改微信账户上的余额收款
                //    if (awb.AffectWX > 0)
                //    {
                //        UpdateCardOverMoney(wx.AffectWX, wx.BasicID, "1");
                //        wx.OverMoney = wx.BeforeMoney - awb.AffectWX;
                //    }
                //    //5.修改支付宝账户上的余额收款
                //    if (awb.AffectAlipay > 0)
                //    {
                //        UpdateCardOverMoney(ali.AffectAlipay, ali.BasicID, "1");
                //        ali.OverMoney = ali.BeforeMoney - awb.AffectAlipay;
                //    }
                //}
                #endregion

                long bankID = 0;
                long cashID = 0;
                long wxID = 0;
                long aliID = 0;
                //5.增加出纳详细记录表，银行卡，现金和微信支付宝账户
                if (awb.AffectCard != 0)
                {
                    bankID = AddCardInfo(card);
                }
                if (awb.AffectCash != 0)
                {
                    cashID = AddCardInfo(cash);
                }
                if (awb.AffectWX != 0)
                {
                    wxID = AddCardInfo(wx);
                }
                if (awb.AffectAlipay != 0)
                {
                    aliID = AddCardInfo(ali);
                }
                if (!string.IsNullOrEmpty(awb.OldFromTO))
                {
                    UpdateRecordToRevoke(awb.RecordID, 1);
                    awb.FromTO = awb.OldFromTO;
                }
                switch (awb.FromTO)
                {
                    case "0":
                        //6.修改受影响的运单状态为已结算状态
                        foreach (var it in awb.OrderNo)
                        {
                            order.UpdateCheckStatusByOrderNo(it, awb.CheckStatus);
                            if (!bankID.Equals(0))
                            {
                                AddRecordAwbID(bankID, it.ToString());
                            }
                            if (!cashID.Equals(0))
                            {
                                AddRecordAwbID(cashID, it.ToString());
                            }
                            if (!wxID.Equals(0))
                            {
                                AddRecordAwbID(wxID, it.ToString());
                            }
                            if (!aliID.Equals(0))
                            {
                                AddRecordAwbID(aliID, it.ToString());
                            }
                        }
                        break;
                    case "2":
                        //2.修改报销单的结算状态
                        foreach (var it in awb.OrderNo)
                        {
                            UpdateCheckStatusByExID(Convert.ToInt32(it), awb.CheckStatus);
                            if (!bankID.Equals(0))
                            {
                                AddRecordAwbID(bankID, it.ToString());
                            }
                            if (!cashID.Equals(0))
                            {
                                AddRecordAwbID(cashID, it.ToString());
                            }
                            if (!wxID.Equals(0))
                            {
                                AddRecordAwbID(wxID, it.ToString());
                            }
                            if (!aliID.Equals(0))
                            {
                                AddRecordAwbID(aliID, it.ToString());
                            }
                        }
                        break;
                    case "3":
                        //2.修改报销单的结算状态
                        foreach (var it in awb.OrderNo)
                        {
                            UpdateCheckStatusByExID(Convert.ToInt32(it), awb.CheckStatus);
                            if (!bankID.Equals(0))
                            {
                                AddRecordAwbID(bankID, it.ToString());
                            }
                            if (!cashID.Equals(0))
                            {
                                AddRecordAwbID(cashID, it.ToString());
                            }
                            if (!wxID.Equals(0))
                            {
                                AddRecordAwbID(wxID, it.ToString());
                            }
                            if (!aliID.Equals(0))
                            {
                                AddRecordAwbID(aliID, it.ToString());
                            }
                        }
                        break;
                    case "4":
                        //2.修改物流账单的结算状态
                        foreach (var it in awb.OrderNo)
                        {
                            UpdateAccountCheckStatusByExID(it, awb.CheckStatus);
                            if (!bankID.Equals(0))
                            {
                                AddRecordAwbID(bankID, it.ToString());
                            }
                            if (!cashID.Equals(0))
                            {
                                AddRecordAwbID(cashID, it.ToString());
                            }
                            if (!wxID.Equals(0))
                            {
                                AddRecordAwbID(wxID, it.ToString());
                            }
                            if (!aliID.Equals(0))
                            {
                                AddRecordAwbID(aliID, it.ToString());
                            }
                        }
                        break;
                    case "5":
                        CargoClientManager clientMan = new CargoClientManager();
                        //6.修改受影响的运单状态为已结算状态
                        foreach (var it in awb.OrderNo)
                        {
                            clientMan.UpdateClientAccountCheckStatus(it, awb.CheckStatus);
                            if (!bankID.Equals(0))
                            {
                                AddRecordAwbID(bankID, it.ToString());
                            }
                            if (!cashID.Equals(0))
                            {
                                AddRecordAwbID(cashID, it.ToString());
                            }
                            if (!wxID.Equals(0))
                            {
                                AddRecordAwbID(wxID, it.ToString());
                            }
                            if (!aliID.Equals(0))
                            {
                                AddRecordAwbID(aliID, it.ToString());
                            }
                        }
                        break;
                    case "6":
                        //2.修改物流账单的结算状态
                        foreach (var it in awb.OrderNo)
                        {
                            UpdatePurchaseOrderCheckStatusByOrderID(it, awb.CheckStatus);
                            if (!bankID.Equals(0))
                            {
                                AddRecordAwbID(bankID, it.ToString());
                            }
                            if (!cashID.Equals(0))
                            {
                                AddRecordAwbID(cashID, it.ToString());
                            }
                            if (!wxID.Equals(0))
                            {
                                AddRecordAwbID(wxID, it.ToString());
                            }
                            if (!aliID.Equals(0))
                            {
                                AddRecordAwbID(aliID, it.ToString());
                            }
                        }
                        break;
                    case "13":
                        //13.修改其它业务收入结算状态
                        foreach (var it in awb.OrderNo)
                        {
                            UpdateFinanceOtherCheckStatusByID(it, awb.CheckStatus);
                            if (!bankID.Equals(0))
                            {
                                AddRecordAwbID(bankID, it.ToString());
                            }
                            if (!cashID.Equals(0))
                            {
                                AddRecordAwbID(cashID, it.ToString());
                            }
                            if (!wxID.Equals(0))
                            {
                                AddRecordAwbID(wxID, it.ToString());
                            }
                            if (!aliID.Equals(0))
                            {
                                AddRecordAwbID(aliID, it.ToString());
                            }
                        }
                        break;
                    case "14":
                        //14.修改其它业务支出结算状态
                        foreach (var it in awb.OrderNo)
                        {
                            UpdateFinanceOtherCheckStatusByID(it, awb.CheckStatus);
                            if (!bankID.Equals(0))
                            {
                                AddRecordAwbID(bankID, it.ToString());
                            }
                            if (!cashID.Equals(0))
                            {
                                AddRecordAwbID(cashID, it.ToString());
                            }
                            if (!wxID.Equals(0))
                            {
                                AddRecordAwbID(wxID, it.ToString());
                            }
                            if (!aliID.Equals(0))
                            {
                                AddRecordAwbID(aliID, it.ToString());
                            }
                        }
                        break;
                    default:
                        break;
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改明细撤销状态
        /// </summary>
        /// <param name="RecordID"></param>
        /// <param name="RevokeType"></param>
        public void UpdateRecordToRevoke(long RecordID, int RevokeType)
        {
            string strSQL = @"update Tbl_Cargo_FinanceRecord set RevokeType=@RevokeType where RecordID=@RecordID";
            using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmdAdd, "@RevokeType", DbType.Int32, RevokeType);
                conn.AddInParameter(cmdAdd, "@RecordID", DbType.Int64, RecordID);
                conn.ExecuteNonQuery(cmdAdd);
            }
        }
        /// <summary>
        /// 记录受影响的费用ID和收支记录表ID关系
        /// </summary>
        /// <param name="recordID"></param>
        /// <param name="awbID"></param>
        public void AddRecordAwbID(long recordID, string awbID)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_RecordAwbID(RecordID,AffectNo) VALUES (@RecordID,@AffectNo)";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@RecordID", DbType.Int64, recordID);
                conn.AddInParameter(cmd, "@AffectNo", DbType.String, awbID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 新增财务收支记录信息
        /// </summary>
        public long AddCardInfo(CargoCashierEntity awb)
        {
            awb.EnSafe();

            Int64 did = 0;
            string strSQL = @"INSERT INTO Tbl_Cargo_FinanceRecord(BasicID,RType,BeforeMoney,OverMoney,AffectWX,AffectCash,AffectCard,AffectAlipay,FromTO,AffectAwbNO,AffectClient,PayName,PayPhone,PayDate,Memo,OP_ID,UserName,TradeType,WxOrderNo) VALUES (@BasicID,@RType,@BeforeMoney,@OverMoney,@AffectWX,@AffectCash,@AffectCard,@AffectAlipay,@FromTO,@AffectAwbNO,@AffectClient,@PayName,@PayPhone,@PayDate,@Memo,@OP_ID,@UserName,@TradeType,@WxOrderNo)  SELECT @@IDENTITY";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@BasicID", DbType.Int32, awb.BasicID);
                conn.AddInParameter(cmd, "@RType", DbType.String, awb.RType);
                conn.AddInParameter(cmd, "@BeforeMoney", DbType.Decimal, awb.BeforeMoney);
                conn.AddInParameter(cmd, "@OverMoney", DbType.Decimal, awb.OverMoney);
                conn.AddInParameter(cmd, "@AffectWX", DbType.Decimal, awb.AffectWX);
                conn.AddInParameter(cmd, "@AffectCash", DbType.Decimal, awb.AffectCash);
                conn.AddInParameter(cmd, "@AffectCard", DbType.Decimal, awb.AffectCard);
                conn.AddInParameter(cmd, "@AffectAlipay", DbType.Decimal, awb.AffectAlipay);
                conn.AddInParameter(cmd, "@FromTO", DbType.String, awb.FromTO);
                conn.AddInParameter(cmd, "@AffectAwbNO", DbType.String, awb.AffectAwbNO);
                conn.AddInParameter(cmd, "@AffectClient", DbType.String, awb.AffectClient);
                conn.AddInParameter(cmd, "@OP_ID", DbType.String, awb.OP_ID);
                conn.AddInParameter(cmd, "@PayName", DbType.String, awb.PayName);
                conn.AddInParameter(cmd, "@PayPhone", DbType.String, awb.PayPhone);
                conn.AddInParameter(cmd, "@UserName", DbType.String, awb.UserName);
                conn.AddInParameter(cmd, "@TradeType", DbType.String, awb.TradeType);
                conn.AddInParameter(cmd, "@WxOrderNo", DbType.String, awb.WxOrderNo);
                conn.AddInParameter(cmd, "@PayDate", DbType.DateTime, (awb.PayDate.ToString("yyyy-MM-dd") == "0001-01-01" || awb.PayDate.ToString("yyyy-MM-dd") == "1900-01-01") ? DateTime.Now : awb.PayDate);
                conn.AddInParameter(cmd, "@Memo", DbType.String, awb.Memo);
                //conn.ExecuteNonQuery(cmd);
                did = Convert.ToInt64(conn.ExecuteScalar(cmd));
            }
            return did;
        }
        /// <summary>
        /// 修改银行账户上的余额
        /// </summary>
        /// <param name="awb"></param>
        /// <param name="ty">0：加1：减</param>
        private void UpdateCardOverMoney(decimal AffectMoney, int basicID, string ty)
        {

            string strDel = @"update Tbl_Cargo_BasicData set OverMoney=OverMoney+@Over where BasicID=@BasicID";
            if (ty == "1")
            {
                strDel = @"update Tbl_Cargo_BasicData set OverMoney=OverMoney-@Over where BasicID=@BasicID";
            }
            using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
            {
                conn.AddInParameter(cmdAdd, "@Over", DbType.Decimal, AffectMoney);
                conn.AddInParameter(cmdAdd, "@BasicID", DbType.Int32, basicID);
                conn.ExecuteNonQuery(cmdAdd);

            }
        }
        #endregion
        #region 出纳资金管理
        public void AddFinanceRecord(CargoCashierEntity awb)
        {
            UpdateCardOverMoney(awb.AffectWX, 337, "1");
            string strSQL = " SELECT * FROM Tbl_Cargo_BasicData WHERE BasicID=337";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        awb.OverMoney = Convert.ToDecimal(idr["OverMoney"]);
                        awb.BeforeMoney = awb.OverMoney + awb.AffectWX;
                    }
                }
            }
            AddCardInfo(awb);

        }
        public CargoOrderEntity QueryCenterOrder(CargoOrderEntity entity)
        {
            CargoOrderEntity reslut = new CargoOrderEntity();
            string strSQL = $@"select b.*
from Tbl_Cargo_Order as a
join Tbl_Cargo_Order as b on a.OpenOrderNo=b.OrderNo
where a.OpenOrderNo is not null and a.OpenOrderNo <> '' ";
            if (!string.IsNullOrEmpty(entity.OrderNo))
            {
                strSQL += $" and a.OrderNo='{entity.OrderNo}'";
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        reslut.OrderID = Convert.ToInt64(idr["OrderID"]);//
                        reslut.OrderNo = Convert.ToString(idr["OrderNo"]);//
                        reslut.HouseID = Convert.ToInt32(idr["HouseID"]);
                        //sreslut.goodsList = QuryOrderGoods(Convert.ToString(idr["AffectAwbNO"]));
                        reslut.goodsList = QuryOrderGoods(Convert.ToString(idr["OrderNo"]));
                    }
                }
            }
            return reslut;
        }
        public CargoOrderEntity QueryOrder(CargoOrderEntity entity)
        {
            CargoOrderEntity reslut = new CargoOrderEntity();
            string strSQL = "SELECT B.ThrowGood,B.OrderNo,A.HouseID,C.RefundType,ISNULL(B.TransportFee,0) as TransportFee,B.Piece,B.WXOrderNo AS AffectAwbNO,D.WXOrderNo,PayStatus,RefundCheckStatus,A.TransitFee,A.TotalCharge,WXPayOrderNo,A.* ,OrderNum ,B.AwbStatus,RefundCheckStatus,B.BusinessID,C.CargoDepart FROM Tbl_WX_Order  A LEFT JOIN Tbl_Cargo_FinanceRecord D on D.WxOrderNo=A.OrderNo  LEFT JOIN Tbl_Cargo_House C ON a.HouseID=C.HouseID left JOIN Tbl_Cargo_Order B ON A.OrderNo=B.WXOrderNo   where 1=1 ";
            if (entity.HouseID != 0)
            {
                strSQL += $" and A.HouseID='{entity.HouseID}'";
            }
            if (!string.IsNullOrEmpty(entity.OrderNo))
            {
                strSQL += $" and b.OrderNo='{entity.OrderNo}'";
            }
            if (!string.IsNullOrEmpty(entity.WXPayOrderNo))
            {
                strSQL += $" and a.WXPayOrderNo='{entity.WXPayOrderNo}'";
            }
            if (!string.IsNullOrEmpty(entity.WXOrderNo))
            {
                strSQL += $" and D.WXOrderNo='{entity.WXOrderNo}'";
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        reslut.OrderNo = Convert.ToString(idr["AffectAwbNO"]);//微信小程序订单号
                        //reslut.OrderNum = Convert.ToString(idr["OrderNum"]);
                        //reslut.OrderID = Convert.ToInt32(idr["OrderID"]);
                        reslut.OrderStatus = Convert.ToInt32(idr["OrderStatus"]);
                        reslut.TransitFee = Convert.ToDecimal(idr["TransitFee"]);
                        reslut.TotalCharge = Convert.ToDecimal(idr["TotalCharge"]);
                        reslut.TransportFee = Convert.ToDecimal(idr["TransportFee"]);
                        reslut.PayStatus = Convert.ToString(idr["PayStatus"]);
                        reslut.RefundCheckStatus = Convert.ToString(idr["RefundCheckStatus"]);
                        reslut.WXPayOrderNo = Convert.ToString(idr["WXPayOrderNo"]);
                        reslut.WXOrderNo = Convert.ToString(idr["WXOrderNo"]);//小程序订单号
                        reslut.RefundType = Convert.ToString(idr["RefundType"]);
                        reslut.HouseID = Convert.ToInt32(idr["HouseID"]);
                        //sreslut.goodsList = QuryOrderGoods(Convert.ToString(idr["AffectAwbNO"]));
                        reslut.goodsList = QuryOrderGoods(Convert.ToString(idr["OrderNo"]));
                        reslut.Piece = string.IsNullOrEmpty(Convert.ToString(idr["Piece"])) ? 0 : Convert.ToInt32(idr["Piece"]);
                        reslut.ThrowGood = Convert.ToString(idr["ThrowGood"]);
                        reslut.BusinessID = Convert.ToString(idr["BusinessID"]);
                        reslut.CargoDepart = Convert.ToString(idr["CargoDepart"]);
                        reslut.OrderNoStr = Convert.ToString(idr["OrderNo"]);//出库订单号
                    }
                }
            }
            return reslut;
        }
        public List<CargoOrderGoodsEntity> QuryOrderGoods(string OrderNo)
        {
            if (string.IsNullOrEmpty(OrderNo))
            {
                return new List<CargoOrderGoodsEntity>();
            }
            List<CargoOrderGoodsEntity> goodsList = new List<CargoOrderGoodsEntity>();
            string strSQL = $"SELECT E.Piece,E.SupplySalePrice,T.TypeName,T.TypeParentName,F.ProductCode,Batch,F.ProductID,F.Source,TT.SourceName,F.ProductName,F.Born,F.Assort,F.TypeID,F.Model,F.Specs,F.LoadIndex,F.SpeedLevel,F.Figure,F.GoodsCode,F.InHousePrice,UnitPrice,TradePrice,SalePrice,CostPrice,TaxCostPrice,NoTaxCostPrice,SpecsType,(case when isnull(Supplier,'')='' then tc.ClientName else Supplier end) as Supplier,SuppClientNum,SupplierAddress,E.HouseID,E.AreaID,E.ContainerCode,E.ActSalePrice,OrderNo,RuleID,RuleType,RuleTitle,F.BelongDepart,f.BelongMonth FROM Tbl_Cargo_OrderGoods E   JOIN  Tbl_Cargo_Product F ON F.ProductID=E.ProductID JOIN Tbl_Cargo_ProductType T ON T.TypeID = F.TypeID left JOIN Tbl_Cargo_ProductSource TT ON TT.Source = F.Source left join Tbl_Cargo_Client as TC on f.SuppClientNum=tc.ClientNum WHERE 1=1 AND E.OrderNo='{OrderNo}'";
            //JOIN  Tbl_Cargo_ProductSpec G ON G.GoodsCode=f.GoodsCode
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        goodsList.Add(new CargoOrderGoodsEntity
                        {
                            Batch = Convert.ToString(idr["Batch"]),
                            ProductID = Convert.ToInt32(idr["ProductID"]),
                            ProductName = Convert.ToString(idr["ProductName"]),
                            Born = Convert.ToString(idr["Born"]),
                            Assort = Convert.ToString(idr["Assort"]),
                            TypeID = Convert.ToInt32(idr["TypeID"]),
                            Model = Convert.ToString(idr["Model"]),
                            Specs = Convert.ToString(idr["Specs"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            Figure = Convert.ToString(idr["Figure"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            AreaID = Convert.ToInt32(idr["AreaID"]),
                            Piece = Convert.ToInt32(idr["Piece"]),
                            ContainerCode = Convert.ToString(idr["ContainerCode"]),
                            ActSalePrice = Convert.ToDecimal(idr["ActSalePrice"]),
                            GoodsCode = Convert.ToString(idr["GoodsCode"]),
                            UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                            TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                            SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                            CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                            TaxCostPrice = Convert.ToDecimal(idr["TaxCostPrice"]),
                            NoTaxCostPrice = Convert.ToDecimal(idr["NoTaxCostPrice"]),
                            InHousePrice = Convert.ToDecimal(idr["InHousePrice"]),
                            SupplySalePrice = Convert.ToDecimal(idr["SupplySalePrice"]),
                            SpecsType = Convert.ToString(idr["SpecsType"]),
                            Supplier = Convert.ToString(idr["Supplier"]),
                            SuppClientNum = Convert.ToInt32(idr["SuppClientNum"]),
                            SupplierAddress = Convert.ToString(idr["SupplierAddress"]),
                            ProductCode = Convert.ToString(idr["ProductCode"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            OrderNo = Convert.ToString(idr["OrderNo"]),
                            RuleType = Convert.ToString(idr["RuleType"]),
                            RuleID = Convert.ToString(idr["RuleID"]),
                            RuleTitle = Convert.ToString(idr["RuleTitle"]),
                            BelongDepart = Convert.ToString(idr["BelongDepart"]),
                            BelongMonth = Convert.ToString(idr["BelongMonth"]),
                            Source = Convert.ToString(idr["Source"]),
                            SourceName = Convert.ToString(idr["SourceName"]),
                        });
                    }
                }
            }
            return goodsList;
        }
        public void UpdatePayStatus(CargoOrderEntity entity)
        {
            string strSQL = "Update Tbl_WX_Order set PayStatus=3 where WXPayOrderNo=@WXPayOrderNo";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@WXPayOrderNo", DbType.String, entity.WXPayOrderNo);
                conn.ExecuteNonQuery(cmd);
            }

        }
        /// <summary>
        /// 收支明细查询
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <returns></returns>
        public Hashtable QueryIncomePayDetail(int pIndex, int pNum, CargoCashierEntity entity)
        {
            List<CargoCashierEntity> result = new List<CargoCashierEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select DISTINCT ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.*,b.CardType,b.Aliases,b.Bank,b.CardName,b.CardNum,c.Name as HouseName,c.HouseID  from Tbl_Cargo_FinanceRecord as a left join Tbl_Cargo_BasicData as b on a.BasicID=b.BasicID left join Tbl_Cargo_House as c on b.HouseID=c.HouseID where (1=1) ";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and b.HouseID in (" + entity.CargoPermisID + ")"; }
                //ID查询
                if (!entity.BasicID.Equals(0)) { strSQL += " and b.BasicID=" + entity.BasicID + ""; }
                //银行卡号
                if (!string.IsNullOrEmpty(entity.CardNum)) { strSQL += " and b.CardNum='" + entity.CardNum + "'"; }
                //卡类型
                if (!string.IsNullOrEmpty(entity.CardType)) { strSQL += " and b.CardType = '" + entity.CardType + "'"; }
                if (!string.IsNullOrEmpty(entity.RType)) { strSQL += " and a.RType='" + entity.RType + "'"; }
                if (!string.IsNullOrEmpty(entity.FromTO)) { strSQL += " and a.FromTO='" + entity.FromTO + "'"; }
                if (!string.IsNullOrEmpty(entity.AffectAwbNO)) { strSQL += " and a.AffectAwbNO like '%" + entity.AffectAwbNO + "%'"; }
                //报销日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OP_DATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " ) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1))";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.Add(new CargoCashierEntity
                            {
                                RecordID = Convert.ToInt32(idr["RecordID"]),
                                BasicID = Convert.ToInt32(idr["BasicID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                CardType = Convert.ToString(idr["CardType"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                Bank = Convert.ToString(idr["Bank"]),
                                CardName = Convert.ToString(idr["CardName"]),
                                BeforeMoney = Convert.ToDecimal(idr["BeforeMoney"]),
                                OverMoney = Convert.ToDecimal(idr["OverMoney"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                FromTO = Convert.ToString(idr["FromTO"]),
                                CardNum = Convert.ToString(idr["CardNum"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                RType = Convert.ToString(idr["RType"]),
                                PayName = Convert.ToString(idr["PayName"]),
                                AffectCash = (Convert.ToDecimal(idr["AffectCash"]) + Convert.ToDecimal(idr["AffectCard"]) + Convert.ToDecimal(idr["AffectAlipay"]) + Convert.ToDecimal(idr["AffectWX"])),
                                AffectAwbNO = Convert.ToString(idr["AffectAwbNO"]),
                                AffectClient = Convert.ToString(idr["AffectClient"]),
                                RevokeType = string.IsNullOrEmpty(Convert.ToString(idr["RevokeType"])) ? 0 : Convert.ToInt32(idr["RevokeType"]),
                                Aliases = Convert.ToString(idr["Aliases"]),
                                HouseID = Convert.ToString(idr["HouseID"]),
                                WxOrderNo = Convert.ToString(idr["WxOrderNo"])
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_FinanceRecord as a left join Tbl_Cargo_BasicData as b on a.BasicID=b.BasicID where (1=1) ";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and b.HouseID in (" + entity.CargoPermisID + ")"; }
                //ID查询
                if (!entity.BasicID.Equals(0)) { strSQL += " and b.BasicID=" + entity.BasicID + ""; }
                //银行卡号
                if (!string.IsNullOrEmpty(entity.CardNum)) { strCount += " and b.CardNum='" + entity.CardNum + "'"; }
                //卡类型
                if (!string.IsNullOrEmpty(entity.CardType)) { strCount += " and b.CardType = '" + entity.CardType + "'"; }
                if (!string.IsNullOrEmpty(entity.RType)) { strCount += " and a.RType='" + entity.RType + "'"; }
                if (!string.IsNullOrEmpty(entity.FromTO)) { strCount += " and a.FromTO='" + entity.FromTO + "'"; }
                if (!string.IsNullOrEmpty(entity.AffectAwbNO)) { strCount += " and a.AffectAwbNO like '%" + entity.AffectAwbNO + "%'"; }
                //报销日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.OP_DATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 收支明细查询导出方法
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoCashierEntity> QueryIncomePayDetailForExport(CargoCashierEntity entity)
        {
            List<CargoCashierEntity> result = new List<CargoCashierEntity>();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @" SELECT a.*,b.CardType,b.Aliases,b.Bank,b.CardName,b.CardNum,c.Name as HouseName from Tbl_Cargo_FinanceRecord as a left join Tbl_Cargo_BasicData as b on a.BasicID=b.BasicID left join Tbl_Cargo_House as c on b.HouseID=c.HouseID where (1=1) ";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and b.HouseID in (" + entity.CargoPermisID + ")"; }
                //ID查询
                if (!entity.BasicID.Equals(0)) { strSQL += " and b.BasicID=" + entity.BasicID + ""; }
                //银行卡号
                if (!string.IsNullOrEmpty(entity.CardNum)) { strSQL += " and b.CardNum='" + entity.CardNum + "'"; }
                //卡类型
                if (!string.IsNullOrEmpty(entity.CardType)) { strSQL += " and b.CardType = '" + entity.CardType + "'"; }
                if (!string.IsNullOrEmpty(entity.RType)) { strSQL += " and a.RType='" + entity.RType + "'"; }
                if (!string.IsNullOrEmpty(entity.FromTO)) { strSQL += " and a.FromTO='" + entity.FromTO + "'"; }
                if (!string.IsNullOrEmpty(entity.AffectAwbNO)) { strSQL += " and a.AffectAwbNO like '%" + entity.AffectAwbNO + "%'"; }
                //报销日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OP_DATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.Add(new CargoCashierEntity
                            {
                                BasicID = Convert.ToInt32(idr["BasicID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                CardType = Convert.ToString(idr["CardType"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                Bank = Convert.ToString(idr["Bank"]),
                                CardName = Convert.ToString(idr["CardName"]),
                                BeforeMoney = Convert.ToDecimal(idr["BeforeMoney"]),
                                OverMoney = Convert.ToDecimal(idr["OverMoney"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                FromTO = Convert.ToString(idr["FromTO"]),
                                CardNum = Convert.ToString(idr["CardNum"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                RType = Convert.ToString(idr["RType"]),
                                PayName = Convert.ToString(idr["PayName"]),
                                AffectCash = (Convert.ToDecimal(idr["AffectCash"]) + Convert.ToDecimal(idr["AffectCard"]) + Convert.ToDecimal(idr["AffectAlipay"]) + Convert.ToDecimal(idr["AffectWX"])),
                                AffectAwbNO = Convert.ToString(idr["AffectAwbNO"]),
                                AffectClient = Convert.ToString(idr["AffectClient"]),
                                Aliases = Convert.ToString(idr["Aliases"])
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public void JoinMoney(CargoCashierEntity joinEnt)
        {
            try
            {
                joinEnt.EnSafe();
                CargoFinanceBasicDataEntity intfbd = GetFinanceBasicDataByID(joinEnt.BasicID);
                joinEnt.BeforeMoney = intfbd.OverMoney;
                if (joinEnt.RType == "1")
                {
                    joinEnt.OverMoney = intfbd.OverMoney - joinEnt.AffectCash;
                    UpdateCardOverMoney(joinEnt.AffectCash, joinEnt.BasicID, "1");
                }
                else
                {
                    joinEnt.OverMoney = intfbd.OverMoney + joinEnt.AffectCash;
                    UpdateCardOverMoney(joinEnt.AffectCash, joinEnt.BasicID, "0");
                }

                switch (joinEnt.CardType)
                {
                    case "1":
                        joinEnt.AffectCard = joinEnt.AffectCash;
                        joinEnt.AffectCash = 0;
                        break;
                    case "2":
                        joinEnt.AffectWX = joinEnt.AffectCash;
                        joinEnt.AffectCash = 0;
                        break;
                    case "3":
                        joinEnt.AffectAlipay = joinEnt.AffectCash;
                        joinEnt.AffectCash = 0;
                        break;
                    default:
                        break;
                }
                //5.增加转入的详细记录表
                string intSQL = @"INSERT INTO Tbl_Cargo_FinanceRecord(BasicID,RType,BeforeMoney,OverMoney,AffectCard,AffectCash,AffectWX,AffectAlipay,FromTO,AffectAwbNO,AffectClient,PayName,PayPhone,PayDate,Memo,OP_ID,UserName) VALUES (@BasicID,@RType,@BeforeMoney,@OverMoney,@AffectCard,@AffectCash,@AffectWX,@AffectAlipay,@FromTO,@AffectAwbNO,@AffectClient,@PayName,@PayPhone,@PayDate,@Memo,@OP_ID,@UserName)";
                using (DbCommand cmd = conn.GetSqlStringCommond(intSQL))
                {
                    conn.AddInParameter(cmd, "@BasicID", DbType.Int32, joinEnt.BasicID);
                    conn.AddInParameter(cmd, "@RType", DbType.String, joinEnt.RType);
                    conn.AddInParameter(cmd, "@BeforeMoney", DbType.Decimal, joinEnt.BeforeMoney);
                    conn.AddInParameter(cmd, "@OverMoney", DbType.Decimal, joinEnt.OverMoney);
                    conn.AddInParameter(cmd, "@AffectCard", DbType.Decimal, joinEnt.AffectCard);
                    conn.AddInParameter(cmd, "@AffectCash", DbType.Decimal, joinEnt.AffectCash);
                    conn.AddInParameter(cmd, "@AffectWX", DbType.Decimal, joinEnt.AffectWX);
                    conn.AddInParameter(cmd, "@AffectAlipay", DbType.Decimal, joinEnt.AffectAlipay);
                    conn.AddInParameter(cmd, "@FromTO", DbType.String, joinEnt.FromTO);
                    conn.AddInParameter(cmd, "@AffectAwbNO", DbType.String, joinEnt.AffectAwbNO);
                    conn.AddInParameter(cmd, "@AffectClient", DbType.String, joinEnt.AffectClient);
                    conn.AddInParameter(cmd, "@PayName", DbType.String, joinEnt.PayName);
                    conn.AddInParameter(cmd, "@PayPhone", DbType.String, joinEnt.PayPhone);
                    conn.AddInParameter(cmd, "@PayDate", DbType.DateTime, (joinEnt.PayDate.ToString("yyyy-MM-dd") == "0001-01-01" || joinEnt.PayDate.ToString("yyyy-MM-dd") == "1900-01-01") ? DateTime.Now : joinEnt.PayDate);
                    conn.AddInParameter(cmd, "@Memo", DbType.String, joinEnt.Memo);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, joinEnt.OP_ID);
                    conn.AddInParameter(cmd, "@UserName", DbType.String, joinEnt.UserName);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 内部转账
        /// </summary>
        /// <param name="outEnt">转出</param>
        /// <param name="intEnt">转入</param>
        public void MoveMoney(CargoCashierEntity outEnt, CargoCashierEntity intEnt)
        {
            try
            {
                outEnt.EnSafe();
                intEnt.EnSafe();
                //0.查询受影响前的银行卡余额
                CargoFinanceBasicDataEntity fbd = GetFinanceBasicDataByID(outEnt.BasicID);
                outEnt.BeforeMoney = fbd.OverMoney;
                outEnt.OverMoney = fbd.OverMoney - outEnt.AffectCash;
                //1.修改银行卡上的余额收款先减去
                UpdateCardOverMoney(outEnt.AffectCash, outEnt.BasicID, "1");
                //2.计算受影响后的银行卡余额数据
                CargoFinanceBasicDataEntity intfbd = GetFinanceBasicDataByID(intEnt.BasicID);
                intEnt.BeforeMoney = intfbd.OverMoney;
                intEnt.OverMoney = intfbd.OverMoney + intEnt.AffectCash;
                //3.修改银行卡上的余额付款再加上
                UpdateCardOverMoney(intEnt.AffectCash, intEnt.BasicID, "0");
                switch (outEnt.CardType)
                {
                    case "1":
                        outEnt.AffectCard = outEnt.AffectCash;
                        outEnt.AffectCash = 0;
                        break;
                    case "2":
                        outEnt.AffectWX = outEnt.AffectCash;
                        outEnt.AffectCash = 0;
                        break;
                    case "3":
                        outEnt.AffectAlipay = outEnt.AffectCash;
                        outEnt.AffectCash = 0;
                        break;
                    default:
                        break;
                }
                //4.增加转出的详细记录表
                string strSQL = @"INSERT INTO Tbl_Cargo_FinanceRecord(BasicID,RType,BeforeMoney,OverMoney,AffectCard,AffectCash,AffectWX,AffectAlipay,FromTO,AffectAwbNO,PayName,PayPhone,PayDate,Memo,OP_ID,UserName) VALUES (@BasicID,@RType,@BeforeMoney,@OverMoney,@AffectCard,@AffectCash,@AffectWX,@AffectAlipay,@FromTO,@AffectAwbNO,@PayName,@PayPhone,@PayDate,@Memo,@OP_ID,@UserName)";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@BasicID", DbType.Int32, outEnt.BasicID);
                    conn.AddInParameter(cmd, "@RType", DbType.String, outEnt.RType);
                    conn.AddInParameter(cmd, "@BeforeMoney", DbType.Decimal, outEnt.BeforeMoney);
                    conn.AddInParameter(cmd, "@OverMoney", DbType.Decimal, outEnt.OverMoney);
                    conn.AddInParameter(cmd, "@AffectCard", DbType.Decimal, outEnt.AffectCard);
                    conn.AddInParameter(cmd, "@AffectCash", DbType.Decimal, outEnt.AffectCash);
                    conn.AddInParameter(cmd, "@AffectWX", DbType.Decimal, outEnt.AffectWX);
                    conn.AddInParameter(cmd, "@AffectAlipay", DbType.Decimal, outEnt.AffectAlipay);
                    conn.AddInParameter(cmd, "@FromTO", DbType.String, outEnt.FromTO);
                    conn.AddInParameter(cmd, "@AffectAwbNO", DbType.String, outEnt.AffectAwbNO);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, outEnt.OP_ID);
                    conn.AddInParameter(cmd, "@PayName", DbType.String, outEnt.PayName);
                    conn.AddInParameter(cmd, "@PayPhone", DbType.String, outEnt.PayPhone);
                    conn.AddInParameter(cmd, "@UserName", DbType.String, outEnt.UserName);
                    conn.AddInParameter(cmd, "@PayDate", DbType.DateTime, (outEnt.PayDate.ToString("yyyy-MM-dd") == "0001-01-01" || outEnt.PayDate.ToString("yyyy-MM-dd") == "1900-01-01") ? DateTime.Now : outEnt.PayDate);
                    conn.AddInParameter(cmd, "@Memo", DbType.String, outEnt.Memo);
                    conn.ExecuteNonQuery(cmd);
                }

                switch (intEnt.CardType)
                {
                    case "1":
                        intEnt.AffectCard = intEnt.AffectCash;
                        intEnt.AffectCash = 0;
                        break;
                    case "2":
                        intEnt.AffectWX = intEnt.AffectCash;
                        intEnt.AffectCash = 0;
                        break;
                    case "3":
                        intEnt.AffectAlipay = intEnt.AffectCash;
                        intEnt.AffectCash = 0;
                        break;
                    default:
                        break;
                }
                //5.增加转入的详细记录表
                string intSQL = @"INSERT INTO Tbl_Cargo_FinanceRecord(BasicID,RType,BeforeMoney,OverMoney,AffectCard,AffectCash,AffectWX,AffectAlipay,FromTO,AffectAwbNO,PayName,PayPhone,PayDate,Memo,OP_ID,UserName) VALUES (@BasicID,@RType,@BeforeMoney,@OverMoney,@AffectCard,@AffectCash,@AffectWX,@AffectAlipay,@FromTO,@AffectAwbNO,@PayName,@PayPhone,@PayDate,@Memo,@OP_ID,@UserName)";
                using (DbCommand cmd = conn.GetSqlStringCommond(intSQL))
                {
                    conn.AddInParameter(cmd, "@BasicID", DbType.Int32, intEnt.BasicID);
                    conn.AddInParameter(cmd, "@RType", DbType.String, intEnt.RType);
                    conn.AddInParameter(cmd, "@BeforeMoney", DbType.Decimal, intEnt.BeforeMoney);
                    conn.AddInParameter(cmd, "@OverMoney", DbType.Decimal, intEnt.OverMoney);
                    conn.AddInParameter(cmd, "@AffectCard", DbType.Decimal, intEnt.AffectCard);
                    conn.AddInParameter(cmd, "@AffectCash", DbType.Decimal, intEnt.AffectCash);
                    conn.AddInParameter(cmd, "@AffectWX", DbType.Decimal, intEnt.AffectWX);
                    conn.AddInParameter(cmd, "@AffectAlipay", DbType.Decimal, intEnt.AffectAlipay);
                    conn.AddInParameter(cmd, "@FromTO", DbType.String, intEnt.FromTO);
                    conn.AddInParameter(cmd, "@AffectAwbNO", DbType.String, intEnt.AffectAwbNO);
                    conn.AddInParameter(cmd, "@PayName", DbType.String, intEnt.PayName);
                    conn.AddInParameter(cmd, "@PayPhone", DbType.String, intEnt.PayPhone);
                    conn.AddInParameter(cmd, "@PayDate", DbType.DateTime, (intEnt.PayDate.ToString("yyyy-MM-dd") == "0001-01-01" || intEnt.PayDate.ToString("yyyy-MM-dd") == "1900-01-01") ? DateTime.Now : intEnt.PayDate);
                    conn.AddInParameter(cmd, "@Memo", DbType.String, intEnt.Memo);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, intEnt.OP_ID);
                    conn.AddInParameter(cmd, "@UserName", DbType.String, intEnt.UserName);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion
        #region 应收应付监督
        /// <summary>
        /// 订单应收监督数据查询
        /// </summary>
        public Hashtable QueryOrderReciveMonitor(int pIndex, int pNum, CargoReceivePayMonitorEntity entity)
        {
            Hashtable resHT = new Hashtable();
            List<CargoReceivePayMonitorEntity> result = new List<CargoReceivePayMonitorEntity>();
            try
            {
                entity.EnSafe();
                string ar = string.Empty;
                string[] arr = entity.OrderNo.Split(',');
                for (int i = 0; i < arr.Length; i++)
                {
                    if (string.IsNullOrEmpty(arr[i])) { continue; }
                    if (i == arr.Length - 1) { ar += arr[i]; break; }
                    ar += arr[i] + "','";
                }
                #region 组装查询SQL语句

                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select DISTINCT ROW_NUMBER() OVER (ORDER BY a.CreateDate DESC) AS RowNumber,a.*,ISNULL(b.PreReceiveMoney,0) as PreReceiveMoney,ISNULL(b.RebateMoney,0) as RebateMoney from Tbl_Cargo_Order as a left join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum where (1=1) ";
                //订单号 
                if (!string.IsNullOrEmpty(ar))
                {
                    //strSQL += " and a.AwbNo = '" + entity.AwbNo.ToUpper() + "'";
                    strSQL += " and a.OrderNo in ('" + ar + "')";
                }
                //收货单位,人
                if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strSQL += " and a.ClientNum = '" + entity.AcceptPeople + "'"; }
                //if (!entity.ClientNum.Equals(0)) { strSQL += " and a.PayClientNum=" + entity.ClientNum + ""; }
                //到达站
                if (!string.IsNullOrEmpty(entity.Dest))
                {
                    string[] ccs = entity.Dest.Split(',');
                    string res = string.Empty;
                    for (int i = 0; i < ccs.Length; i++)
                    {
                        res += ccs[i] + "','";
                    }
                    res = res.Substring(0, res.Length - 3);
                    strSQL += " and a.Dest in ('" + res + "')";
                }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //以业务员为查询条件
                if (!string.IsNullOrEmpty(entity.SaleManID)) { strSQL += " and a.SaleManID ='" + entity.SaleManID + "'"; }
                //以业务员为查询条件
                if (!string.IsNullOrEmpty(entity.OrderType)) { strSQL += " and a.OrderType ='" + entity.OrderType + "'"; }
                //二审审核状态
                if (!string.IsNullOrEmpty(entity.FinanceSecondCheck)) { strSQL += " and a.FinanceSecondCheck=" + entity.FinanceSecondCheck + ""; }
                //结算状态
                if (!string.IsNullOrEmpty(entity.CheckStatus)) { strSQL += " and a.CheckStatus=" + entity.CheckStatus + ""; }
                //公司类型
                if (!string.IsNullOrEmpty(entity.BelongHouse)) { strSQL += " and a.BelongHouse = " + entity.BelongHouse; }
                strSQL += " ) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            decimal ReceivedMoney = 0.00M;
                            string uname = string.Empty; string tradeType = string.Empty;
                            DateTime opdate = new DateTime();
                            #region 查询已收款
                            DataTable record = QueryFinanceRecordByNo(Convert.ToString(idr["OrderNo"]), entity.RType, entity.FromTO);
                            if (record != null)
                            {
                                foreach (DataRow drr in record.Rows)
                                {
                                    ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                                    uname = Convert.ToString(drr["UserName"]);
                                    opdate = Convert.ToDateTime(drr["OP_DATE"]);
                                    tradeType = Convert.ToString(drr["tradeType"]);
                                }
                            }
                            #endregion

                            #region 获取运单数据
                            result.Add(new CargoReceivePayMonitorEntity
                            {
                                RowNumber = Convert.ToInt32(idr["RowNumber"]),
                                OrderID = Convert.ToInt64(idr["OrderID"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                Dep = Convert.ToString(idr["Dep"]),
                                Dest = Convert.ToString(idr["Dest"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                TransitFee = Convert.ToDecimal(idr["TransitFee"]),
                                TransportFee = Convert.ToDecimal(idr["TransportFee"]),
                                TotalCharge = Convert.ToDecimal(idr["TotalCharge"]),
                                AcceptUnit = Convert.ToString(idr["AcceptUnit"]),
                                PayClientNum = Convert.ToInt32(idr["PayClientNum"]),
                                PayClientName = Convert.ToString(idr["PayClientName"]),
                                AcceptAddress = Convert.ToString(idr["AcceptAddress"]),
                                AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                                AcceptTelephone = Convert.ToString(idr["AcceptTelephone"]),
                                AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                                PreReceiveMoney = Convert.ToDecimal(idr["PreReceiveMoney"]),
                                RebateMoney = Convert.ToDecimal(idr["RebateMoney"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                OrderType = Convert.ToString(idr["OrderType"]),
                                CreateAwb = Convert.ToString(idr["CreateAwb"]),
                                SaleManID = Convert.ToString(idr["SaleManID"]),
                                SaleManName = Convert.ToString(idr["SaleManName"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                FinanceSecondCheck = Convert.ToString(idr["FinanceSecondCheck"]),
                                FinanceSecondCheckName = Convert.ToString(idr["FinanceSecondCheck"]).Equals("0") ? "" : Convert.ToString(idr["FinanceSecondCheckName"]),
                                FinanceSecondCheckDate = Convert.ToString(idr["FinanceSecondCheck"]).Equals("0") ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["FinanceSecondCheckDate"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                //OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                UserName = uname,//收款操作人姓名
                                OP_DATE = opdate,//收款操作时间
                                TradeType = tradeType,
                                ReceivedMoney = Convert.ToString(idr["CheckStatus"]).Equals("1") ? Convert.ToDecimal(idr["TotalCharge"]) : ReceivedMoney,
                                UncollectMoney = Convert.ToString(idr["CheckStatus"]).Equals("1") ? 0 : Convert.ToDecimal(idr["TotalCharge"]) - ReceivedMoney
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_Order as a  Where (1=1)";
                //订单号 
                if (!string.IsNullOrEmpty(ar))
                {
                    //strSQL += " and a.AwbNo = '" + entity.AwbNo.ToUpper() + "'";
                    strCount += " and a.OrderNo in ('" + ar + "')";
                }
                //收货单位,人
                if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strCount += " and (a.PayClientName like '%" + entity.AcceptPeople + "%' or a.AcceptPeople like '%" + entity.AcceptPeople + "%')"; }
                if (!entity.ClientNum.Equals(0)) { strCount += " and a.PayClientNum=" + entity.ClientNum + ""; }
                //到达站
                if (!string.IsNullOrEmpty(entity.Dest))
                {
                    string[] ccs = entity.Dest.Split(',');
                    string res = string.Empty;
                    for (int i = 0; i < ccs.Length; i++)
                    {
                        res += ccs[i] + "','";
                    }
                    res = res.Substring(0, res.Length - 3);
                    strCount += " and a.Dest in ('" + res + "')";
                }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //以业务员为查询条件
                if (!string.IsNullOrEmpty(entity.SaleManID)) { strCount += " and a.SaleManID ='" + entity.SaleManID + "'"; }
                //以业务员为查询条件
                if (!string.IsNullOrEmpty(entity.OrderType)) { strCount += " and a.OrderType ='" + entity.OrderType + "'"; }
                //二审审核状态
                if (!string.IsNullOrEmpty(entity.FinanceSecondCheck)) { strCount += " and a.FinanceSecondCheck=" + entity.FinanceSecondCheck + ""; }
                //结算状态
                if (!string.IsNullOrEmpty(entity.CheckStatus)) { strCount += " and a.CheckStatus=" + entity.CheckStatus + ""; }
                //公司类型
                if (!string.IsNullOrEmpty(entity.BelongHouse)) { strCount += " and a.BelongHouse = " + entity.BelongHouse; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
                #endregion
            }
            catch (ApplicationException ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return resHT;
        }
        /// <summary>
        /// 报销收款监督数据查询
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryExpenseReciveMonitor(int pIndex, int pNum, CargoExpenseEntity entity)
        {
            Hashtable resHT = new Hashtable();
            List<CargoExpenseEntity> result = new List<CargoExpenseEntity>();
            try
            {
                entity.EnSafe();
                string ar = string.Empty;
                string[] arr = entity.ExpenseID.Split(',');
                for (int i = 0; i < arr.Length; i++)
                {
                    if (string.IsNullOrEmpty(arr[i]))
                    {
                        continue;
                    }
                    if (i == arr.Length - 1)
                    {
                        ar += arr[i];
                        break;
                    }
                    ar += arr[i] + ",";
                }
                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select DISTINCT ROW_NUMBER() OVER (ORDER BY a.ExpenseDate DESC) AS RowNumber,a.ExID,a.ExName,a.ExDate,a.ReceiveName,a.ReceiveNumber,a.ChargeType,a.ExCharge,a.OperaID,a.OperaName,a.Reason,a.ExpenseDate,a.Status,a.CheckStatus,a.DenyReason,ISNULL(a.UserID,0) as UserID,a.UserName,a.CheckTime,a.OP_ID,a.NextCheckID,a.NextCheckName,a.ApproveID,a.ExType,ISNULL(a.ClientID,0) as ClientID,a.ClientName from Tbl_Cargo_Expense as a where (1=1) ";
                //报销单号
                if (!string.IsNullOrEmpty(ar))
                {
                    // strSQL += " and a.ExID = " + entity.ExID + "";
                    strSQL += " and a.ExID in (" + ar + ")";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //报销人
                if (!string.IsNullOrEmpty(entity.ExName)) { strSQL += " and a.ExName like  '%" + entity.ExName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveName)) { strSQL += " and a.ReceiveName like  '%" + entity.ReceiveName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveNumber)) { strSQL += " and a.ReceiveNumber like  '%" + entity.ReceiveNumber + "%'"; }
                //报销操作人ID
                if (!string.IsNullOrEmpty(entity.OperaID)) { strSQL += " and a.OperaID = '" + entity.OperaID + "'"; }
                //当前审批人ID
                if (!string.IsNullOrEmpty(entity.NextCheckID)) { strSQL += " and a.NextCheckID like '%" + entity.NextCheckID + "%'"; }
                ////报销类别
                //if (!string.IsNullOrEmpty(entity.CostName)) { strSQL += " and d.SName like  '%" + entity.CostName + "%'"; }
                //客户ID
                if (!entity.ClientID.Equals(0)) { strSQL += " and a.ClientID = '" + entity.ClientID + "'"; }
                //报销金额
                if (!entity.ExCharge.Equals(0)) { strSQL += " and a.ExCharge = '" + entity.ExCharge + "'"; }
                //报销单状态
                if (!string.IsNullOrEmpty(entity.Status))
                {
                    if (entity.Status.Equals("1"))
                    {
                        strSQL += " and a.Status in ('1','4','5')";
                    }
                    else
                    {
                        strSQL += " and a.Status = '" + entity.Status + "'";
                    }
                }
                //报销类型
                if (!string.IsNullOrEmpty(entity.ExType)) { strSQL += " and a.ExType = '" + entity.ExType + "'"; }
                //报销日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExpenseDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExpenseDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " ) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1))";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            string cn = string.Empty;
                            List<CargoExpenseDetailEntity> detail = GetExpenseDetailById(Convert.ToInt64(idr["ExID"]));
                            foreach (var it in detail)
                            {
                                cn += it.SName + ",";
                            }
                            decimal ReceivedMoney = 0.00M;
                            string uname = string.Empty;
                            DateTime opdate = new DateTime();
                            #region 查询已收款
                            DataTable record = QueryFinanceRecordByNo(Convert.ToString(idr["ExID"]), entity.RType, entity.FromTO);
                            if (record != null)
                            {
                                foreach (DataRow drr in record.Rows)
                                {
                                    ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                                    uname = Convert.ToString(drr["UserName"]);
                                    opdate = Convert.ToDateTime(drr["OP_DATE"]);
                                }
                            }
                            #endregion

                            #region 获取运单数据
                            result.Add(new CargoExpenseEntity
                            {
                                ExID = Convert.ToInt64(idr["ExID"]),
                                ExName = Convert.ToString(idr["ExName"]),
                                ExDate = Convert.ToDateTime(idr["ExDate"]),
                                ReceiveName = Convert.ToString(idr["ReceiveName"]),
                                ReceiveNumber = Convert.ToString(idr["ReceiveNumber"]),
                                CostName = string.IsNullOrEmpty(cn) ? "" : cn.Substring(0, cn.Length - 1),
                                ChargeType = Convert.ToString(idr["ChargeType"]),
                                ExCharge = Convert.ToDecimal(idr["ExCharge"]),
                                OperaID = Convert.ToString(idr["OperaID"]),
                                OperaName = Convert.ToString(idr["OperaName"]),
                                ExpenseDate = Convert.ToDateTime(idr["ExpenseDate"]),
                                Status = Convert.ToString(idr["Status"]),
                                DenyReason = Convert.ToString(idr["DenyReason"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                Reason = Convert.ToString(idr["Reason"]),
                                ApproveID = Convert.ToInt32(idr["ApproveID"]),
                                NextCheckID = Convert.ToString(idr["NextCheckID"]),
                                NextCheckName = Convert.ToString(idr["NextCheckName"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                UserName = Convert.ToString(idr["UserName"]),
                                ExType = Convert.ToString(idr["ExType"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                ClientID = Convert.ToInt32(idr["ClientID"]),
                                CheckTime = string.IsNullOrEmpty(Convert.ToString(idr["CheckTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["CheckTime"]),
                                //OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                LastUserName = uname,//收款操作人姓名
                                OP_DATE = opdate,//收款操作时间
                                ReceivedMoney = Convert.ToString(idr["CheckStatus"]).Equals("1") ? Convert.ToDecimal(idr["ExCharge"]) : ReceivedMoney,
                                UncollectMoney = Convert.ToString(idr["CheckStatus"]).Equals("1") ? 0 : Convert.ToDecimal(idr["ExCharge"]) - ReceivedMoney
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_Expense as a  Where (1=1)";
                //报销单号
                if (!string.IsNullOrEmpty(ar))
                {
                    // strSQL += " and a.ExID = " + entity.ExID + "";
                    strCount += " and a.ExID in (" + ar + ")";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //报销人
                if (!string.IsNullOrEmpty(entity.ExName)) { strCount += " and a.ExName like  '%" + entity.ExName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveName)) { strCount += " and a.ReceiveName like  '%" + entity.ReceiveName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveNumber)) { strCount += " and a.ReceiveNumber like  '%" + entity.ReceiveNumber + "%'"; }
                //报销操作人ID
                if (!string.IsNullOrEmpty(entity.OperaID)) { strCount += " and a.OperaID = '" + entity.OperaID + "'"; }
                //当前审批人ID
                if (!string.IsNullOrEmpty(entity.NextCheckID)) { strCount += " and a.NextCheckID like '%" + entity.NextCheckID + "%'"; }
                ////报销类别
                //if (!string.IsNullOrEmpty(entity.CostName)) { strSQL += " and d.SName like  '%" + entity.CostName + "%'"; }
                //客户ID
                if (!entity.ClientID.Equals(0)) { strCount += " and a.ClientID = '" + entity.ClientID + "'"; }
                //报销金额
                if (!entity.ExCharge.Equals(0)) { strCount += " and a.ExCharge = '" + entity.ExCharge + "'"; }
                //报销单状态
                if (!string.IsNullOrEmpty(entity.Status))
                {
                    if (entity.Status.Equals("1"))
                    {
                        strCount += " and a.Status in ('1','4','5')";
                    }
                    else
                    {
                        strCount += " and a.Status = '" + entity.Status + "'";
                    }
                }
                //报销类型
                if (!string.IsNullOrEmpty(entity.ExType)) { strCount += " and a.ExType = '" + entity.ExType + "'"; }
                //报销日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.ExpenseDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.ExpenseDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        #endregion
        #region 财务报销管理
        /// <summary>
        /// 检查单号是否已报销
        /// </summary>
        /// <param name="OrderNo"></param>
        /// <returns></returns>
        public DataTable CheckSummaryExist(string OrderNo, string ExID)
        {
            string strSQL = "select e.ExID,e.ExName,e.ExDate,e.ReceiveName,e.ExCharge,e.OperaID,e.OperaName,e.Status,e.CheckStatus,e.ExType,ed.ZID,ed.FID,ed.SID from Tbl_Cargo_ExpenseOrderID eo inner join Tbl_Cargo_Expense e on eo.ExID = e.ExID inner join Tbl_Cargo_ExpenseDetail ed on e.ExID = ed.ExID where eo.OrderNo=@OrderNo";
            if (!string.IsNullOrEmpty(ExID))
            {
                strSQL += " and e.ExID!=@ExID";
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@OrderNo", DbType.String, OrderNo);
                if (!string.IsNullOrEmpty(ExID))
                {
                    conn.AddInParameter(cmd, "@ExID", DbType.String, ExID);
                }
                return conn.ExecuteDataTable(cmd);
            }
        }
        /// <summary>
        /// 新增报销单申请
        /// </summary>
        public long AddExpense(CargoExpenseEntity entity)
        {
            Int64 did = 0;
            string strSQL = @"INSERT INTO Tbl_Cargo_Expense(ExName,ExDepart,ExDate,ReceiveName,CardBank,ReceiveNumber,ChargeType,ExCharge,Reason,OP_ID,OperaName,OperaID,ExpenseDate,ApproveID,OP_DATE,UserID,UserName,CheckTime,HouseID,NextCheckID,NextCheckName,ExType,ClientID,ClientName,ChargeUnit) VALUES (@ExName,@ExDepart,@ExDate,@ReceiveName,@CardBank,@ReceiveNumber,@ChargeType,@ExCharge,@Reason,@OP_ID,@OperaName,@OperaID,@ExpenseDate,@ApproveID,@OP_DATE,@UserID,@UserName,@CheckTime,@HouseID,@NextCheckID,@NextCheckName,@ExType,@ClientID,@ClientName,@ChargeUnit) SELECT @@IDENTITY";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ExName", DbType.String, entity.ExName);
                    conn.AddInParameter(cmd, "@ExDepart", DbType.String, entity.ExDepart);
                    conn.AddInParameter(cmd, "@ExDate", DbType.DateTime, entity.ExDate);
                    conn.AddInParameter(cmd, "@ReceiveName", DbType.String, entity.ReceiveName);
                    conn.AddInParameter(cmd, "@CardBank", DbType.String, entity.CardBank);
                    conn.AddInParameter(cmd, "@ReceiveNumber", DbType.String, entity.ReceiveNumber);
                    conn.AddInParameter(cmd, "@ChargeType", DbType.String, entity.ChargeType);
                    conn.AddInParameter(cmd, "@ExCharge", DbType.Decimal, entity.ExCharge);
                    conn.AddInParameter(cmd, "@Reason", DbType.String, entity.Reason);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    //conn.AddInParameter(cmd, "@CostType", DbType.Int32, entity.CostType);
                    //conn.AddInParameter(cmd, "@CostName", DbType.String, entity.CostName);
                    conn.AddInParameter(cmd, "@OperaName", DbType.String, entity.OperaName);
                    conn.AddInParameter(cmd, "@OperaID", DbType.String, entity.OperaID);
                    conn.AddInParameter(cmd, "@ExpenseDate", DbType.DateTime, entity.ExpenseDate);
                    conn.AddInParameter(cmd, "@ApproveID", DbType.Int32, entity.ApproveID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@UserID", DbType.String, entity.UserID);
                    conn.AddInParameter(cmd, "@UserName", DbType.String, entity.UserName);
                    conn.AddInParameter(cmd, "@CheckTime", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@NextCheckID", DbType.String, entity.NextCheckID);
                    conn.AddInParameter(cmd, "@NextCheckName", DbType.String, entity.NextCheckName);
                    conn.AddInParameter(cmd, "@ExType", DbType.String, entity.ExType);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@ClientID", DbType.Int32, entity.ClientID);
                    conn.AddInParameter(cmd, "@ClientName", DbType.String, entity.ClientName);
                    conn.AddInParameter(cmd, "@ChargeUnit", DbType.String, entity.ChargeUnit);
                    did = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
                //增加报销详细内容
                foreach (var it in entity.exDetail)
                {
                    it.SName = GetSIDNameByFID(it.FID, it.SID);
                    it.ExID = did;
                    long deID = AddExpenseDetail(it);
                    if (!string.IsNullOrEmpty(it.Summary))
                    {
                        string[] exawb = it.Summary.Split(',');
                        for (int i = 0; i < exawb.Length; i++)
                        {
                            if (!string.IsNullOrEmpty(exawb[i]))
                            {
                                CargoExpenseOrderIDEntity awb = new CargoExpenseOrderIDEntity();
                                awb.ExID = did;
                                awb.DetailID = deID;
                                awb.OrderNo = Convert.ToString(exawb[i]);
                                AddExpenseAwbID(awb);
                            }
                        }
                    }
                }
                //增加报销审批路线
                AddExpenseApproveRout(new CargoExpenseApproveRoutEntity
                {
                    ExID = did,
                    UserID = entity.OperaID,//当前操作人ID
                    UserName = entity.OperaName,//当前操作人姓名
                    Opera = "0",
                    ApproveType = "0",
                    Result = "提交报销单"
                });
                ////增加领导审批流程表
                //AddExpenseLeaderCheck(new ExpenseLeaderCheckEntity
                //{
                //    ExID = did,
                //    UserID = entity.UserID,
                //    BelongSystem = entity.BelongSystem,
                //    UserName = entity.UserName
                //    // DepartName = entity.DepartName//部门名称
                //});
                return did;
            }
            catch (ApplicationException ex)
            {
                throw new ApplicationException(ex.Message);
            }
        }
        /// <summary>
        /// 增加报销审批路线图数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddExpenseApproveRout(CargoExpenseApproveRoutEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_ExpenseApproveRout(ExID,UserID,UserName,Opera,OperaDate,Result,ApproveType) VALUES (@ExID,@UserID,@UserName,@Opera,@OperaDate,@Result,@ApproveType) SELECT @@IDENTITY";
            try
            {
                entity.EnSafe();

                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ExID", DbType.Int64, entity.ExID);
                    conn.AddInParameter(cmd, "@UserID", DbType.String, entity.UserID);
                    conn.AddInParameter(cmd, "@UserName", DbType.String, entity.UserName);
                    conn.AddInParameter(cmd, "@Opera", DbType.String, entity.Opera);
                    conn.AddInParameter(cmd, "@OperaDate", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@Result", DbType.String, entity.Result);
                    conn.AddInParameter(cmd, "@ApproveType", DbType.String, entity.ApproveType);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 新增报销单申请详细清单列表
        /// </summary>
        public long AddExpenseDetail(CargoExpenseDetailEntity entity)
        {
            Int64 deID = 0;
            string strSQL = @"INSERT INTO Tbl_Cargo_ExpenseDetail(ExID,HappenDate,Memo,Summary,DetailCharge,OP_ID,ZID,FID,SID,SName) VALUES (@ExID,@HappenDate,@Memo,@Summary,@DetailCharge,@OP_ID,@ZID,@FID,@SID,@SName)  SELECT @@IDENTITY";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ExID", DbType.Int64, entity.ExID);
                    conn.AddInParameter(cmd, "@HappenDate", DbType.DateTime, entity.HappenDate);
                    conn.AddInParameter(cmd, "@Memo", DbType.String, entity.Memo);
                    conn.AddInParameter(cmd, "@Summary", DbType.String, entity.Summary);
                    conn.AddInParameter(cmd, "@DetailCharge", DbType.Decimal, entity.DetailCharge);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.AddInParameter(cmd, "@ZID", DbType.Int32, entity.ZID);
                    conn.AddInParameter(cmd, "@FID", DbType.Int32, entity.FID);
                    conn.AddInParameter(cmd, "@SID", DbType.Int32, entity.SID);
                    conn.AddInParameter(cmd, "@SName", DbType.String, entity.SName);
                    deID = Convert.ToInt64(conn.ExecuteScalar(cmd));
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return deID;
        }

        /// <summary>
        /// 报销单关联表
        /// </summary>
        public void AddExpenseAwbID(CargoExpenseOrderIDEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_ExpenseOrderID(ExID,DetailID,OrderNo) VALUES (@ExID,@DetailID,@OrderNo)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ExID", DbType.Int64, entity.ExID);
                    conn.AddInParameter(cmd, "@DetailID", DbType.Int64, entity.DetailID);
                    conn.AddInParameter(cmd, "@OrderNo", DbType.String, entity.OrderNo);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        /// <summary>
        /// 修改报销单申请,申请状态为待审，拒绝原因设为空
        /// </summary>
        public void UpdateExpense(CargoExpenseEntity entity)
        {
            string strSQL = @"Update Tbl_Cargo_Expense set ExName=@ExName,ExDepart=@ExDepart,ExDate=@ExDate,ChargeType=@ChargeType,ExCharge=@ExCharge,ReceiveName=@ReceiveName,CardBank=@CardBank,ReceiveNumber=@ReceiveNumber,Reason=@Reason,OP_ID=@OP_ID,OP_DATE=@OP_DATE,Status=@Status,DenyReason=@DenyReason,UserID=@UserID,UserName=@UserName,CheckTime=@CheckTime,NextCheckID=@NextCheckID,NextCheckName=@NextCheckName,ChargeUnit=@ChargeUnit Where ExID=@ExID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ReceiveName", DbType.String, entity.ReceiveName);
                    conn.AddInParameter(cmd, "@ReceiveNumber", DbType.String, entity.ReceiveNumber);
                    conn.AddInParameter(cmd, "@CardBank", DbType.String, entity.CardBank);
                    conn.AddInParameter(cmd, "@ExName", DbType.String, entity.ExName);
                    conn.AddInParameter(cmd, "@ExDepart", DbType.String, entity.ExDepart);
                    conn.AddInParameter(cmd, "@ExDate", DbType.DateTime, entity.ExDate);
                    conn.AddInParameter(cmd, "@ChargeType", DbType.String, entity.ChargeType);
                    conn.AddInParameter(cmd, "@ExCharge", DbType.Decimal, entity.ExCharge);
                    conn.AddInParameter(cmd, "@Reason", DbType.String, entity.Reason);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    //conn.AddInParameter(cmd, "@CostType", DbType.Int32, entity.CostType);
                    //conn.AddInParameter(cmd, "@CostName", DbType.String, entity.CostName);
                    //conn.AddInParameter(cmd, "@OperaName", DbType.String, entity.OperaName);
                    //conn.AddInParameter(cmd, "@OperaID", DbType.String, entity.OperaID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@Status", DbType.String, "0");
                    conn.AddInParameter(cmd, "@DenyReason", DbType.String, "");
                    conn.AddInParameter(cmd, "@ExID", DbType.Int64, entity.ExID);
                    conn.AddInParameter(cmd, "@UserID", DbType.Int32, entity.UserID);
                    conn.AddInParameter(cmd, "@UserName", DbType.String, entity.UserName);
                    conn.AddInParameter(cmd, "@NextCheckID", DbType.String, entity.NextCheckID);
                    conn.AddInParameter(cmd, "@NextCheckName", DbType.String, entity.NextCheckName);
                    conn.AddInParameter(cmd, "@CheckTime", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@ChargeUnit", DbType.String, entity.ChargeUnit);
                    conn.ExecuteNonQuery(cmd);

                }
                //删除报销详细数据
                DelExpenseAwbDetail(entity.ExID);
                //删除报销单与订单关联表数据
                DelExpenseAwbID(entity.ExID);
                //再新增
                foreach (var it in entity.exDetail)
                {
                    it.SName = GetSIDNameByFID(it.FID, it.SID);
                    it.ExID = entity.ExID;
                    long deID = AddExpenseDetail(it);
                    if (!string.IsNullOrEmpty(it.Summary))
                    {
                        string[] exawb = it.Summary.Split(',');
                        for (int i = 0; i < exawb.Length; i++)
                        {
                            if (!string.IsNullOrEmpty(exawb[i]))
                            {
                                CargoExpenseOrderIDEntity awb = new CargoExpenseOrderIDEntity();
                                awb.ExID = entity.ExID;
                                awb.DetailID = deID;
                                awb.OrderNo = Convert.ToString(exawb[i]);
                                AddExpenseAwbID(awb);
                            }
                        }
                    }
                }
                //增加报销审批路线
                AddExpenseApproveRout(new CargoExpenseApproveRoutEntity
                {
                    ExID = entity.ExID,
                    UserID = entity.OperaID,//当前操作人ID
                    UserName = entity.OperaName,//当前操作人姓名
                    //DepartName = entity.DepName,//部门名称
                    Opera = "0",
                    Result = "修改报销单"
                });
                //先删除该报销ID的领导审批数据，再增加领导审批流程数据
                //DelExpenseLeaderCheckByExID(entity.ExID);
                //AddExpenseLeaderCheck(new ExpenseLeaderCheckEntity
                //{
                //    ExID = entity.ExID,
                //    UserID = entity.UserID,
                //    BelongSystem = entity.BelongSystem,
                //    UserName = entity.UserName
                //    //DepartName = entity.DepartName//部门名称
                //});
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public Hashtable QueryOnlyMyExpense(int pIndex, int pNum, CargoExpenseEntity entity)
        {
            List<CargoExpenseEntity> result = new List<CargoExpenseEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                string ar = string.Empty;
                string[] arr = entity.ExpenseID.Split(',');
                for (int i = 0; i < arr.Length; i++)
                {
                    if (string.IsNullOrEmpty(arr[i]))
                    {
                        continue;
                    }
                    if (i == arr.Length - 1)
                    {
                        ar += arr[i];
                        break;
                    }
                    ar += arr[i] + ",";
                }

                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select DISTINCT ROW_NUMBER() OVER (ORDER BY a.ExpenseDate DESC) AS RowNumber,a.ExID,a.ExName,a.ExDepart,a.ExDate,a.ReceiveName,a.ReceiveNumber,a.ChargeType,a.ExCharge,a.OperaID,a.OperaName,a.Reason,a.ExpenseDate,a.Status,a.CheckStatus,a.DenyReason,ISNULL(a.UserID,0) as UserID,a.UserName,a.CheckTime,a.OP_ID,a.NextCheckID,a.NextCheckName,a.ApproveID,b.ApproveName,a.ExType,ISNULL(a.ClientID,0) as ClientID,a.ClientName,a.HouseID,a.ChargeUnit from Tbl_Cargo_Expense as a inner join Tbl_Cargo_ExpenseApproveSet as b on a.ApproveID=b.ID where (1=1)";
                //报销单号
                if (!string.IsNullOrEmpty(ar))
                {
                    // strSQL += " and a.ExID = " + entity.ExID + "";
                    strSQL += " and a.ExID in (" + ar + ")";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //报销人
                if (!string.IsNullOrEmpty(entity.ExName)) { strSQL += " and a.ExName like  '%" + entity.ExName + "%'"; }
                //报销部门
                if (!string.IsNullOrEmpty(entity.ExDepart)) { strSQL += " and a.ExDepart like  '%" + entity.ExDepart + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveName)) { strSQL += " and a.ReceiveName like  '%" + entity.ReceiveName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveNumber)) { strSQL += " and a.ReceiveNumber like  '%" + entity.ReceiveNumber + "%'"; }
                //报销操作人ID
                if (!string.IsNullOrEmpty(entity.OperaID)) { strSQL += " and a.OperaID = '" + entity.OperaID + "'"; }
                //当前审批人ID
                //if (!string.IsNullOrEmpty(entity.NextCheckID)) { strSQL += " and c.CheckUserID = '" + entity.NextCheckID + "'"; }
                ////报销类别
                //if (!string.IsNullOrEmpty(entity.CostName)) { strSQL += " and d.SName like  '%" + entity.CostName + "%'"; }
                //报销金额
                if (!entity.ExCharge.Equals(0)) { strSQL += " and a.ExCharge = '" + entity.ExCharge + "'"; }
                //报销单状态
                if (!string.IsNullOrEmpty(entity.Status))
                {
                    if (entity.Status.Equals("1"))
                    {
                        strSQL += " and a.Status in ('1','4','5')";
                    }
                    else
                    {
                        strSQL += " and a.Status = '" + entity.Status + "'";
                    }
                }
                //报销类型
                if (!string.IsNullOrEmpty(entity.ExType)) { strSQL += " and a.ExType = '" + entity.ExType + "'"; }
                //报销日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExpenseDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExpenseDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " ) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1))";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            if (result.Where(c => c.ExID == Convert.ToInt64(idr["ExID"])).Count() > 0)
                            {
                                continue;
                            }
                            string cn = string.Empty;
                            List<CargoExpenseDetailEntity> detail = GetExpenseDetailById(Convert.ToInt64(idr["ExID"]));
                            foreach (var it in detail)
                            {
                                cn += it.SName + ",";
                            }
                            #region 获取报销单数据
                            result.Add(new CargoExpenseEntity
                            {
                                ExID = Convert.ToInt64(idr["ExID"]),
                                ExName = Convert.ToString(idr["ExName"]),
                                ExDepart = Convert.ToString(idr["ExDepart"]),
                                ExDate = Convert.ToDateTime(idr["ExDate"]),
                                ReceiveName = Convert.ToString(idr["ReceiveName"]),
                                ReceiveNumber = Convert.ToString(idr["ReceiveNumber"]),
                                CostName = string.IsNullOrEmpty(cn) ? "" : cn.Substring(0, cn.Length - 1),
                                ChargeType = Convert.ToString(idr["ChargeType"]),
                                ExCharge = Convert.ToDecimal(idr["ExCharge"]),
                                OperaID = Convert.ToString(idr["OperaID"]),
                                OperaName = Convert.ToString(idr["OperaName"]),
                                ExpenseDate = Convert.ToDateTime(idr["ExpenseDate"]),
                                Status = Convert.ToString(idr["Status"]),
                                DenyReason = Convert.ToString(idr["DenyReason"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                Reason = Convert.ToString(idr["Reason"]),
                                ApproveID = Convert.ToInt32(idr["ApproveID"]),
                                ApproveName = Convert.ToString(idr["ApproveName"]),
                                NextCheckID = Convert.ToString(idr["NextCheckID"]),
                                NextCheckName = Convert.ToString(idr["NextCheckName"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                UserName = Convert.ToString(idr["UserName"]),
                                ExType = Convert.ToString(idr["ExType"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                ClientID = Convert.ToInt32(idr["ClientID"]),
                                //CheckType = Convert.ToString(idr["CheckType"]),
                                //ReadStatus = Convert.ToString(idr["ReadStatus"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ChargeUnit = Convert.ToString(idr["ChargeUnit"]),
                                CheckTime = string.IsNullOrEmpty(Convert.ToString(idr["CheckTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["CheckTime"])
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"Select Count(distinct a.ExID) as TotalCount from Tbl_Cargo_Expense as a where (1=1)";
                if (!string.IsNullOrEmpty(ar))
                {
                    // strSQL += " and a.ExID = " + entity.ExID + "";
                    strCount += " and a.ExID in (" + ar + ")";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //报销人
                if (!string.IsNullOrEmpty(entity.ExName))
                {
                    strCount += " and a.ExName like  '%" + entity.ExName + "%'";
                }
                //报销部门
                if (!string.IsNullOrEmpty(entity.ExDepart)) { strCount += " and a.ExDepart like  '%" + entity.ExDepart + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveName)) { strCount += " and a.ReceiveName like  '%" + entity.ReceiveName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveNumber)) { strCount += " and a.ReceiveNumber like  '%" + entity.ReceiveNumber + "%'"; }
                //报销操作人ID
                if (!string.IsNullOrEmpty(entity.OperaID)) { strCount += " and a.OperaID = '" + entity.OperaID + "'"; }
                //当前审批人ID
                //if (!string.IsNullOrEmpty(entity.UserID)) { strCount += " and a.UserID like '%" + entity.UserID + "%'"; }
                //if (!string.IsNullOrEmpty(entity.NextCheckID)) { strSQL += " and c.CheckUserID = '" + entity.NextCheckID + "'"; }
                ////报销类别
                //if (!string.IsNullOrEmpty(entity.CostName))
                //{
                //    strCount += " and b.SName like  '%" + entity.CostName + "%'";
                //}
                //报销金额
                if (!entity.ExCharge.Equals(0)) { strCount += " and a.ExCharge = '" + entity.ExCharge + "'"; }
                //报销单状态
                if (!string.IsNullOrEmpty(entity.Status))
                {
                    if (entity.Status.Equals("1"))
                    {
                        strCount += " and a.Status in ('1','4','5')";
                    }
                    else
                    {
                        strCount += " and a.Status = '" + entity.Status + "'";
                    }
                }

                //报销类型
                if (!string.IsNullOrEmpty(entity.ExType)) { strCount += " and a.ExType = '" + entity.ExType + "'"; }
                //报销日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.ExpenseDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.ExpenseDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 查询我的报销数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryMyExpense(int pIndex, int pNum, CargoExpenseEntity entity)
        {
            List<CargoExpenseEntity> result = new List<CargoExpenseEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                string ar = string.Empty;
                string[] arr = entity.ExpenseID.Split(',');
                for (int i = 0; i < arr.Length; i++)
                {
                    if (string.IsNullOrEmpty(arr[i]))
                    {
                        continue;
                    }
                    if (i == arr.Length - 1)
                    {
                        ar += arr[i];
                        break;
                    }
                    ar += arr[i] + ",";
                }

                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select DISTINCT ROW_NUMBER() OVER (ORDER BY a.ExpenseDate DESC) AS RowNumber,a.ExID,a.ExName,a.ExDepart,a.ExDate,a.ReceiveName,a.ReceiveNumber,a.ChargeType,a.ExCharge,a.OperaID,a.OperaName,a.Reason,a.ExpenseDate,a.Status,a.CheckStatus,a.DenyReason,ISNULL(a.UserID,0) as UserID,a.UserName,a.CheckTime,a.OP_ID,a.NextCheckID,a.NextCheckName,a.ApproveID,b.ApproveName,a.ExType,ISNULL(a.ClientID,0) as ClientID,a.ClientName,c.CheckType,c.ReadStatus,a.HouseID,a.ChargeUnit,d.Name AS HouseName from Tbl_Cargo_Expense as a inner join Tbl_Cargo_ExpenseApproveSet as b on a.ApproveID=b.ID inner join Tbl_Cargo_ApproveCheck as c on a.ExID=c.ApproveID LEFT JOIN Tbl_Cargo_House AS d ON a.HouseID= d.HouseID  where (1=1) and c.ApproveType='0'";
                //报销单号
                if (!string.IsNullOrEmpty(ar))
                {
                    // strSQL += " and a.ExID = " + entity.ExID + "";
                    strSQL += " and a.ExID in (" + ar + ")";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //报销人
                if (!string.IsNullOrEmpty(entity.ExName)) { strSQL += " and a.ExName like  '%" + entity.ExName + "%'"; }
                //报销部门
                if (!string.IsNullOrEmpty(entity.ExDepart)) { strSQL += " and a.ExDepart like  '%" + entity.ExDepart + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveName)) { strSQL += " and a.ReceiveName like  '%" + entity.ReceiveName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveNumber)) { strSQL += " and a.ReceiveNumber like  '%" + entity.ReceiveNumber + "%'"; }
                //报销操作人ID
                if (!string.IsNullOrEmpty(entity.OperaID)) { strSQL += " and a.OperaID = '" + entity.OperaID + "'"; }
                //当前审批人ID
                if (!string.IsNullOrEmpty(entity.NextCheckID)) { strSQL += " and c.CheckUserID = '" + entity.NextCheckID + "'"; }
                ////报销类别
                //if (!string.IsNullOrEmpty(entity.CostName)) { strSQL += " and d.SName like  '%" + entity.CostName + "%'"; }
                //报销金额
                if (!entity.ExCharge.Equals(0)) { strSQL += " and a.ExCharge = '" + entity.ExCharge + "'"; }
                //报销单状态
                if (!string.IsNullOrEmpty(entity.Status))
                {
                    if (entity.Status.Equals("1"))
                    {
                        strSQL += " and a.Status in ('1','4','5')";
                    }
                    else
                    {
                        strSQL += " and a.Status = '" + entity.Status + "'";
                    }
                }
                //报销类型
                if (!string.IsNullOrEmpty(entity.ExType)) { strSQL += " and a.ExType = '" + entity.ExType + "'"; }
                //报销日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExpenseDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExpenseDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " ) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1))";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            if (result.Where(c => c.ExID == Convert.ToInt64(idr["ExID"])).Count() > 0)
                            {
                                continue;
                            }
                            string cn = string.Empty;
                            List<CargoExpenseDetailEntity> detail = GetExpenseDetailById(Convert.ToInt64(idr["ExID"]));
                            foreach (var it in detail)
                            {
                                cn += it.SName + ",";
                            }
                            #region 获取报销单数据
                            result.Add(new CargoExpenseEntity
                            {
                                ExID = Convert.ToInt64(idr["ExID"]),
                                ExName = Convert.ToString(idr["ExName"]),
                                ExDepart = Convert.ToString(idr["ExDepart"]),
                                ExDate = Convert.ToDateTime(idr["ExDate"]),
                                ReceiveName = Convert.ToString(idr["ReceiveName"]),
                                ReceiveNumber = Convert.ToString(idr["ReceiveNumber"]),
                                CostName = string.IsNullOrEmpty(cn) ? "" : cn.Substring(0, cn.Length - 1),
                                ChargeType = Convert.ToString(idr["ChargeType"]),
                                ExCharge = Convert.ToDecimal(idr["ExCharge"]),
                                OperaID = Convert.ToString(idr["OperaID"]),
                                OperaName = Convert.ToString(idr["OperaName"]),
                                ExpenseDate = Convert.ToDateTime(idr["ExpenseDate"]),
                                Status = Convert.ToString(idr["Status"]),
                                DenyReason = Convert.ToString(idr["DenyReason"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                Reason = Convert.ToString(idr["Reason"]),
                                ApproveID = Convert.ToInt32(idr["ApproveID"]),
                                ApproveName = Convert.ToString(idr["ApproveName"]),
                                NextCheckID = Convert.ToString(idr["NextCheckID"]),
                                NextCheckName = Convert.ToString(idr["NextCheckName"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                UserName = Convert.ToString(idr["UserName"]),
                                ExType = Convert.ToString(idr["ExType"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                ClientID = Convert.ToInt32(idr["ClientID"]),
                                CheckType = Convert.ToString(idr["CheckType"]),
                                ReadStatus = Convert.ToString(idr["ReadStatus"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                ChargeUnit = Convert.ToString(idr["ChargeUnit"]),
                                CheckTime = string.IsNullOrEmpty(Convert.ToString(idr["CheckTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["CheckTime"])
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"Select Count(distinct a.ExID) as TotalCount from Tbl_Cargo_Expense as a inner join Tbl_Cargo_ApproveCheck as c on a.ExID=c.ApproveID where (1=1) and c.ApproveType='0'";
                if (!string.IsNullOrEmpty(ar))
                {
                    // strSQL += " and a.ExID = " + entity.ExID + "";
                    strCount += " and a.ExID in (" + ar + ")";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //报销人
                if (!string.IsNullOrEmpty(entity.ExName))
                {
                    strCount += " and a.ExName like  '%" + entity.ExName + "%'";
                }
                //报销部门
                if (!string.IsNullOrEmpty(entity.ExDepart)) { strCount += " and a.ExDepart like  '%" + entity.ExDepart + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveName)) { strCount += " and a.ReceiveName like  '%" + entity.ReceiveName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveNumber)) { strCount += " and a.ReceiveNumber like  '%" + entity.ReceiveNumber + "%'"; }
                //报销操作人ID
                if (!string.IsNullOrEmpty(entity.OperaID)) { strCount += " and a.OperaID = '" + entity.OperaID + "'"; }
                //当前审批人ID
                //if (!string.IsNullOrEmpty(entity.UserID)) { strCount += " and a.UserID like '%" + entity.UserID + "%'"; }
                if (!string.IsNullOrEmpty(entity.NextCheckID)) { strSQL += " and c.CheckUserID = '" + entity.NextCheckID + "'"; }
                ////报销类别
                //if (!string.IsNullOrEmpty(entity.CostName))
                //{
                //    strCount += " and b.SName like  '%" + entity.CostName + "%'";
                //}
                //报销金额
                if (!entity.ExCharge.Equals(0)) { strCount += " and a.ExCharge = '" + entity.ExCharge + "'"; }
                //报销单状态
                if (!string.IsNullOrEmpty(entity.Status))
                {
                    if (entity.Status.Equals("1"))
                    {
                        strCount += " and a.Status in ('1','4','5')";
                    }
                    else
                    {
                        strCount += " and a.Status = '" + entity.Status + "'";
                    }
                }

                //报销类型
                if (!string.IsNullOrEmpty(entity.ExType)) { strCount += " and a.ExType = '" + entity.ExType + "'"; }
                //报销日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.ExpenseDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.ExpenseDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 通过ID号获取某一报销单数据
        /// </summary>
        /// <param name="ExID"></param>
        /// <returns></returns>
        public CargoExpenseEntity GetExpenseById(Int64 ExID)
        {
            CargoExpenseEntity result = new CargoExpenseEntity();
            try
            {
                string strSQL = @"SELECT a.*,b.ApproveName,b.OneCheckID,b.OneCheckName,b.TwoCheckID,b.TwoCheckName,b.ThreeCheckID,b.ThreeCheckName,b.FourCheckID,b.FourCheckName,b.FiveCheckID,b.FiveCheckName,b.SixCheckID,b.SixCheckName,b.SevenCheckID,b.SevenCheckName,b.EightCheckID,b.EightCheckName,b.NineCheckID,b.NineCheckName,b.TenCheckID,b.TenCheckName,b.ApproveType,b.CopyCheck,b.CopyCheckName,b.CopyUserID,b.CopyUserName from Tbl_Cargo_Expense as a left join Tbl_Cargo_ExpenseApproveSet as b on a.ApproveID=b.ID Where ExID=@ExID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ExID", DbType.Int64, ExID);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        #region 赋值
                        foreach (DataRow idr in dt.Rows)
                        {
                            result = new CargoExpenseEntity
                            {
                                ExID = Convert.ToInt64(idr["ExID"]),
                                ExName = Convert.ToString(idr["ExName"]),
                                ExDepart = Convert.ToString(idr["ExDepart"]),
                                ReceiveName = Convert.ToString(idr["ReceiveName"]),
                                ReceiveNumber = Convert.ToString(idr["ReceiveNumber"]),
                                CardBank = Convert.ToString(idr["CardBank"]),
                                ExDate = Convert.ToDateTime(idr["ExDate"]),
                                ChargeType = Convert.ToString(idr["ChargeType"]),
                                ExCharge = Convert.ToDecimal(idr["ExCharge"]),
                                //CostType = Convert.ToInt32(idr["CostType"]),
                                //CostName = Convert.ToString(idr["CostName"]),
                                Reason = Convert.ToString(idr["Reason"]),
                                OperaID = Convert.ToString(idr["OperaID"]),
                                OperaName = Convert.ToString(idr["OperaName"]),
                                ExpenseDate = Convert.ToDateTime(idr["ExpenseDate"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                Status = Convert.ToString(idr["Status"]),
                                DenyReason = Convert.ToString(idr["DenyReason"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                NextCheckID = Convert.ToString(idr["NextCheckID"]),
                                NextCheckName = Convert.ToString(idr["NextCheckName"]),
                                ApproveID = Convert.ToInt32(idr["ApproveID"]),
                                ApproveName = Convert.ToString(idr["ApproveName"]),
                                //LeaderName = Convert.ToString(idr["LeaderName"]),
                                //FinanceName = Convert.ToString(idr["FinanceName"]),
                                //SupervisorName = Convert.ToString(idr["SupervisorName"]),
                                OneCheckID = Convert.ToString(idr["OneCheckID"]),
                                OneCheckName = Convert.ToString(idr["OneCheckName"]),
                                TwoCheckID = Convert.ToString(idr["TwoCheckID"]),
                                TwoCheckName = Convert.ToString(idr["TwoCheckName"]),
                                ThreeCheckID = Convert.ToString(idr["ThreeCheckID"]),
                                ThreeCheckName = Convert.ToString(idr["ThreeCheckName"]),
                                FourCheckID = Convert.ToString(idr["FourCheckID"]),
                                FourCheckName = Convert.ToString(idr["FourCheckName"]),
                                FiveCheckID = Convert.ToString(idr["FiveCheckID"]),
                                FiveCheckName = Convert.ToString(idr["FiveCheckName"]),
                                SixCheckID = Convert.ToString(idr["SixCheckID"]),
                                SixCheckName = Convert.ToString(idr["SixCheckName"]),
                                SevenCheckID = Convert.ToString(idr["SevenCheckID"]),
                                SevenCheckName = Convert.ToString(idr["SevenCheckName"]),
                                EightCheckID = Convert.ToString(idr["EightCheckID"]),
                                EightCheckName = Convert.ToString(idr["EightCheckName"]),
                                NineCheckID = Convert.ToString(idr["NineCheckID"]),
                                NineCheckName = Convert.ToString(idr["NineCheckName"]),
                                TenCheckID = Convert.ToString(idr["TenCheckID"]),
                                TenCheckName = Convert.ToString(idr["TenCheckName"]),
                                CopyUserName = Convert.ToString(idr["CopyUserName"]),
                                CopyCheckName = Convert.ToString(idr["CopyCheckName"]),
                                CopyCheck = Convert.ToString(idr["CopyCheck"]),
                                CopyUserID = Convert.ToString(idr["CopyUserID"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                ExType = Convert.ToString(idr["ExType"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                ClientID = Convert.ToInt32(idr["ClientID"]),
                                UserName = Convert.ToString(idr["UserName"]),
                                ChargeUnit = Convert.ToString(idr["ChargeUnit"])
                            };
                        }
                        #endregion
                    }

                }
                result.exDetail = GetExpenseDetailById(ExID);
                return result;
            }
            catch (ApplicationException ex)
            {
                throw new ApplicationException(ex.Message);
            }
        }
        /// <summary>
        /// 通过ID号获取某一报销单详细数据
        /// </summary>
        /// <param name="ExID"></param>
        /// <returns></returns>
        public List<CargoExpenseDetailEntity> GetExpenseDetailById(Int64 ExID)
        {
            List<CargoExpenseDetailEntity> result = new List<CargoExpenseDetailEntity>();
            try
            {
                string strSQL = @"SELECT a.*,b.FName,c.ZName,d.SName as SSName from Tbl_Cargo_ExpenseDetail as a Left Join Tbl_Cargo_FirstSubject as b on a.FID=b.FID left join Tbl_Cargo_ZeroSubject as c on a.ZID=c.ZID left join Tbl_Cargo_SecondSubject as d on a.SID=d.SID Where a.ExID=@ExID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ExID", DbType.Int64, ExID);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoExpenseDetailEntity
                            {
                                ExID = Convert.ToInt64(idr["ExID"]),
                                ZID = Convert.ToInt32(idr["ZID"]),
                                ZName = Convert.ToString(idr["ZName"]),
                                FID = Convert.ToInt32(idr["FID"]),
                                SID = Convert.ToInt32(idr["SID"]),
                                SName = Convert.ToString(idr["SSName"]),
                                FName = Convert.ToString(idr["FName"]),
                                DetailID = Convert.ToInt64(idr["DetailID"]),
                                HappenDate = Convert.ToDateTime(idr["HappenDate"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                Summary = Convert.ToString(idr["Summary"]),
                                DetailCharge = Convert.ToDecimal(idr["DetailCharge"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                        }
                    }

                }
                return result;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 通过报销ID获取报销单的状态
        /// 0：待审
        /// 1：审批中
        /// 2：拒审
        /// 3：结束
        /// </summary>
        /// <param name="ExID"></param>
        /// <returns></returns>
        public string GetExpenseStatusByID(Int64 ExID)
        {
            string result = string.Empty;
            try
            {
                string strSQL = @"SELECT Status from Tbl_Cargo_Expense  Where ExID=@ExID";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ExID", DbType.Int64, ExID);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        #region 赋值
                        foreach (DataRow idr in dt.Rows)
                        {
                            result = Convert.ToString(idr["Status"]);
                            break;
                        }
                        #endregion
                    }
                }
                return result;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        /// <summary>
        /// 删除或作废财务报销单
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="ty">0:作废运单1:彻底删除运单</param>
        public void DelCargoMyExpense(List<CargoExpenseEntity> entity, int ty)
        {
            try
            {
                foreach (var it in entity)
                {
                    it.EnSafe();
                    //设置订单表的删除标志为1 表示删除或作废
                    //string strDel = @"UPDATE Tbl_Cargo_Expense SET DelFlag=1 WHERE ExID=@ExID";
                    //if (ty.Equals(1))
                    //{
                    //    strDel = @"Delete From Tbl_Cargo_Expense WHERE ExID=@ExID";
                    //}
                    string strDel = @"Delete From Tbl_Cargo_Expense WHERE ExID=@ExID";
                    using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                    {
                        conn.AddInParameter(cmdAdd, "@ExID", DbType.Int64, it.ExID);
                        conn.ExecuteNonQuery(cmdAdd);

                    }
                    if (ty.Equals(1))
                    {
                        //删除报销单明细
                        DelExpenseAwbDetail(it.ExID);
                        DelExpenseAwbID(it.ExID);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除或作废财务报销单详细记录
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="ty">0:作废运单1:彻底删除运单</param>
        public void DelExpenseAwbDetail(Int64 exid)
        {
            try
            {
                string strDel = @"Delete From Tbl_Cargo_ExpenseDetail WHERE ExID=@ExID";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                {
                    conn.AddInParameter(cmdAdd, "@ExID", DbType.Int64, exid);
                    conn.ExecuteNonQuery(cmdAdd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除报销关联运单表
        /// </summary>
        /// <param name="exid"></param>
        public void DelExpenseAwbID(Int64 exid)
        {
            try
            {
                string strDel = @"Delete From Tbl_Cargo_ExpenseOrderID WHERE ExID=@ExID";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                {
                    conn.AddInParameter(cmdAdd, "@ExID", DbType.Int64, exid);
                    conn.ExecuteNonQuery(cmdAdd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        /// <summary>
        /// 根据报销ID查询该报销的流程图
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoExpenseApproveRoutEntity> QueryExpenseRout(CargoExpenseApproveRoutEntity entity)
        {
            List<CargoExpenseApproveRoutEntity> result = new List<CargoExpenseApproveRoutEntity>();
            string strSQL = @" select * from Tbl_Cargo_ExpenseApproveRout where ExID=@ExID and ApproveType=@ApproveType order by OperaDate desc";

            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ExID", DbType.Int64, entity.ExID);
                    conn.AddInParameter(cmd, "@ApproveType", DbType.String, entity.ApproveType);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoExpenseApproveRoutEntity
                            {
                                ExID = Convert.ToInt64(idr["ExID"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                UserName = Convert.ToString(idr["UserName"]),
                                Opera = Convert.ToString(idr["Opera"]),
                                OperaDate = Convert.ToDateTime(idr["OperaDate"]),
                                ApproveType = Convert.ToString(idr["ApproveType"]),
                                Result = Convert.ToString(idr["Result"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 根据订单号查询该订单的流程图
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoExpenseApproveRoutEntity> QueryExpenseRoutAtOrderNo(CargoOrderEntity entity)
        {
            List<CargoExpenseApproveRoutEntity> result = new List<CargoExpenseApproveRoutEntity>();
            string strSQL = @" select ear.*,oup.OrderCheckType from Tbl_Cargo_ExpenseApproveRout ear inner join Tbl_QY_OrderUpdatePrice oup on oup.OID=ear.ExID where ear.ApproveType=1 and oup.OrderNo=@OrderNo order by OperaDate desc";

            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@OrderNo", DbType.String, entity.OrderNo);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoExpenseApproveRoutEntity
                            {
                                ExID = Convert.ToInt64(idr["ExID"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                UserName = Convert.ToString(idr["UserName"]),
                                Opera = Convert.ToString(idr["Opera"]),
                                OperaDate = Convert.ToDateTime(idr["OperaDate"]),
                                ApproveType = Convert.ToString(idr["ApproveType"]),
                                Result = Convert.ToString(idr["Result"]),
                                OrderCheckType = Convert.ToString(idr["OrderCheckType"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public List<CargoExpenseApproveRoutEntity> QueryExpenseRoutAtExID(CargoExpenseApproveRoutEntity entity)
        {
            List<CargoExpenseApproveRoutEntity> result = new List<CargoExpenseApproveRoutEntity>();
            string strSQL = @" select * from Tbl_Cargo_ExpenseApproveRout where ApproveType=@ApproveType and ExID=@ExID order by OperaDate desc";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@ApproveType", DbType.String, entity.ApproveType);
                    conn.AddInParameter(cmd, "@ExID", DbType.String, entity.ExID);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoExpenseApproveRoutEntity
                            {
                                ExID = Convert.ToInt64(idr["ExID"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                UserName = Convert.ToString(idr["UserName"]),
                                Opera = Convert.ToString(idr["Opera"]),
                                OperaDate = Convert.ToDateTime(idr["OperaDate"]),
                                ApproveType = Convert.ToString(idr["ApproveType"]),
                                Result = Convert.ToString(idr["Result"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        /// <summary>
        /// 我的工作台报销界面导出的查询方法
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoExpenseEntity> QueryExpenseMyCheckForExport(CargoExpenseEntity entity)
        {
            List<CargoExpenseEntity> result = new List<CargoExpenseEntity>();

            try
            {
                entity.EnSafe();
                string ar = string.Empty;
                string[] arr = entity.ExpenseID.Split(',');
                for (int i = 0; i < arr.Length; i++)
                {
                    if (string.IsNullOrEmpty(arr[i]))
                    {
                        continue;
                    }
                    if (i == arr.Length - 1)
                    {
                        ar += arr[i];
                        break;
                    }
                    ar += arr[i] + ",";
                }
                #region 组装查询SQL语句
                string strSQL = @"select DISTINCT a.ExDepart,a.ExID,a.ExName,a.ExDate,a.ReceiveName,a.ReceiveNumber,a.ChargeType,a.ExCharge,a.Reason,a.Status,a.DenyReason,a.CheckStatus,a.UserID,a.UserName,a.NextCheckID,a.NextCheckName,a.ExType,a.ClientID,a.ClientName,a.OperaID,a.ExpenseDate,a.OperaName,b.ZID,b.FID,b.SID,b.SName,b.HappenDate,b.Memo,b.Summary,b.DetailCharge,a.CheckTime,f.FName,a.ChargeUnit,d.Name AS HouseName from Tbl_Cargo_Expense as a inner join Tbl_Cargo_ExpenseDetail as b on a.ExID=b.ExID left join Tbl_Cargo_FirstSubject as f on b.FID=f.FID inner join Tbl_Cargo_ApproveCheck as c on a.ExID=c.ApproveID  LEFT JOIN Tbl_Cargo_House AS d ON a.HouseID= d.HouseID  where (1=1) and c.ApproveType='0' ";
                //报销单号
                if (!string.IsNullOrEmpty(ar))
                {
                    // strSQL += " and a.ExID = " + entity.ExID + "";
                    strSQL += " and a.ExID in (" + ar + ")";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //报销部门
                if (!string.IsNullOrEmpty(entity.ExDepart)) { strSQL += " and a.ExDepart like  '%" + entity.ExDepart + "%'"; }
                //报销人
                if (!string.IsNullOrEmpty(entity.ExName)) { strSQL += " and a.ExName like  '%" + entity.ExName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveName)) { strSQL += " and a.ReceiveName like  '%" + entity.ReceiveName + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveNumber)) { strSQL += " and a.ReceiveNumber like  '%" + entity.ReceiveNumber + "%'"; }
                //报销操作人ID
                if (!string.IsNullOrEmpty(entity.OperaID)) { strSQL += " and a.OperaID = '" + entity.OperaID + "'"; }
                //当前审批人ID
                //if (!string.IsNullOrEmpty(entity.NextCheckID)) { strSQL += " and a.NextCheckID ='" + entity.NextCheckID + "'"; }
                if (!string.IsNullOrEmpty(entity.NextCheckID)) { strSQL += " and c.CheckUserID = '" + entity.NextCheckID + "'"; }
                ////报销类别
                //if (!string.IsNullOrEmpty(entity.CostName)) { strSQL += " and d.SName like  '%" + entity.CostName + "%'"; }
                //报销金额
                if (!entity.ExCharge.Equals(0)) { strSQL += " and a.ExCharge = '" + entity.ExCharge + "'"; }
                //报销单状态
                if (!string.IsNullOrEmpty(entity.Status))
                {
                    if (entity.Status.Equals("1"))
                    {
                        strSQL += " and a.Status in ('1','4','5')";
                    }
                    else
                    {
                        strSQL += " and a.Status = '" + entity.Status + "'";
                    }
                }
                //报销类型
                if (!string.IsNullOrEmpty(entity.ExType)) { strSQL += " and a.ExType = '" + entity.ExType + "'"; }
                //报销日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExpenseDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExpenseDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            //if (result.Exists(c => c.ExID.Equals(Convert.ToInt64(idr["ExID"])) && c.SID.Equals(Convert.ToInt32(idr["SID"])) && c.FID.Equals(Convert.ToInt32(idr["FID"])))) { continue; }
                            #region 获取报销单数据
                            result.Add(new CargoExpenseEntity
                            {
                                ExID = Convert.ToInt64(idr["ExID"]),
                                ExName = Convert.ToString(idr["ExName"]),
                                ExDepart = Convert.ToString(idr["ExDepart"]),
                                ExDate = Convert.ToDateTime(idr["ExDate"]),
                                ReceiveName = Convert.ToString(idr["ReceiveName"]),
                                ReceiveNumber = Convert.ToString(idr["ReceiveNumber"]),
                                ChargeType = Convert.ToString(idr["ChargeType"]),
                                ExCharge = Convert.ToDecimal(idr["ExCharge"]),
                                OperaID = Convert.ToString(idr["OperaID"]),
                                OperaName = Convert.ToString(idr["OperaName"]),
                                ExpenseDate = Convert.ToDateTime(idr["ExpenseDate"]),
                                Status = Convert.ToString(idr["Status"]),
                                DenyReason = Convert.ToString(idr["DenyReason"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                Reason = Convert.ToString(idr["Reason"]),
                                NextCheckID = Convert.ToString(idr["NextCheckID"]),
                                NextCheckName = Convert.ToString(idr["NextCheckName"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                UserName = Convert.ToString(idr["UserName"]),
                                ExType = Convert.ToString(idr["ExType"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                ClientID = Convert.ToInt32(idr["ClientID"]),
                                CheckTime = string.IsNullOrEmpty(Convert.ToString(idr["CheckTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["CheckTime"]),
                                HappenDate = string.IsNullOrEmpty(Convert.ToString(idr["HappenDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["HappenDate"]),
                                SName = Convert.ToString(idr["SName"]),
                                SID = Convert.ToInt32(idr["SID"]),
                                FID = Convert.ToInt32(idr["FID"]),
                                ZID = Convert.ToInt32(idr["ZID"]),
                                //ZName = Convert.ToString(idr["ZName"]),
                                FName = Convert.ToString(idr["FName"]),
                                Memo = Convert.ToString(idr["Memo"]),
                                Summary = Convert.ToString(idr["Summary"]),
                                ChargeUnit = Convert.ToString(idr["ChargeUnit"]),
                                DetailCharge = Convert.ToDecimal(idr["DetailCharge"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        /// <summary>
        /// 根据操作人查询所有收款人
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoExpenseEntity> QueryAllReceiveName(CargoExpenseEntity entity)
        {
            List<CargoExpenseEntity> result = new List<CargoExpenseEntity>();
            try
            {
                string strSQL = @" select ReceiveName from (select * from Tbl_Cargo_Expense  where ReceiveName !='' ) a group by ReceiveName";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(command, "@OP_ID", DbType.String, entity.OP_ID);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoExpenseEntity
                            {
                                ReceiveName = Convert.ToString(idr["ReceiveName"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 根据收款人查询收款账号
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoExpenseEntity> QueryAllReceiveNumber(CargoExpenseEntity entity)
        {
            List<CargoExpenseEntity> result = new List<CargoExpenseEntity>();
            try
            {
                //string strSQL = @" select ReceiveNumber,CardBank from (select * from Tbl_Cargo_Expense  where ReceiveNumber !='' and ReceiveName=@ReceiveName ) a group by ReceiveNumber,CardBank";
                string strSQL = @"select DISTINCT ROW_NUMBER() OVER (ORDER BY CardNum DESC) AS RowNumber,CardNum,CardBank,CardName from Tbl_Cargo_Payment where CardNum!='' and LEN(CardNum)>1 and CardName=@ReceiveName group by CardNum,CardName,CardBank";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(command, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.AddInParameter(command, "@ReceiveName", DbType.String, entity.ReceiveName);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoExpenseEntity
                            {
                                ExID = Convert.ToInt64(idr["RowNumber"]),
                                ReceiveNumber = Convert.ToString(idr["CardNum"]),
                                CardBank = Convert.ToString(idr["CardBank"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        #endregion
        #region 财务报销审批

        /// <summary>
        /// 通过审核和拒审报销单
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="ty">1:通过报销单2:拒审报销单</param>
        public void updateExpenseStatus(CargoExpenseEntity entity)
        {
            string strDel = @"UPDATE Tbl_Cargo_Expense SET Status=@Status,DenyReason=@DenyReason,UserID=@UserID,UserName=@UserName,CheckTime=@CheckTime,NextCheckID=@NextCheckID,NextCheckName=@NextCheckName WHERE ExID=@ExID";
            using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
            {
                conn.AddInParameter(cmdAdd, "@Status", DbType.String, entity.Status);
                conn.AddInParameter(cmdAdd, "@DenyReason", DbType.String, entity.DenyReason);
                conn.AddInParameter(cmdAdd, "@UserID", DbType.String, entity.UserID);//下一审批人
                conn.AddInParameter(cmdAdd, "@UserName", DbType.String, entity.UserName);
                conn.AddInParameter(cmdAdd, "@ExID", DbType.Int64, entity.ExID);
                conn.AddInParameter(cmdAdd, "@CheckTime", DbType.DateTime, DateTime.Now);
                conn.AddInParameter(cmdAdd, "@NextCheckID", DbType.String, entity.NextCheckID);
                conn.AddInParameter(cmdAdd, "@NextCheckName", DbType.String, entity.NextCheckName);
                conn.ExecuteNonQuery(cmdAdd);

            }
        }
        /// <summary>
        /// 修改报销单的结算状态
        /// </summary>
        /// <param name="exID"></param>
        /// <param name="CheckStatus"></param>
        public void UpdateCheckStatusByExID(int exID, string CheckStatus)
        {
            try
            {
                string strDel = @"UPDATE Tbl_Cargo_Expense SET CheckStatus=@CheckStatus WHERE ExID=@ExID";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                {
                    conn.AddInParameter(cmdAdd, "@CheckStatus", DbType.String, CheckStatus);
                    conn.AddInParameter(cmdAdd, "@ExID", DbType.Int32, exID);
                    conn.ExecuteNonQuery(cmdAdd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }
        /// <summary>
        /// 设置到出纳
        /// </summary>
        /// <param name="entity"></param>
        public void updateExpenseCashier(List<CargoExpenseEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strDel = @"UPDATE Tbl_Cargo_Expense SET Status=@Status,NextCheckID='',NextCheckName='' WHERE ExID=@ExID";
                    using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                    {
                        conn.AddInParameter(cmdAdd, "@Status", DbType.String, "3");
                        conn.AddInParameter(cmdAdd, "@ExID", DbType.Int64, it.ExID);
                        conn.ExecuteNonQuery(cmdAdd);
                    }
                    //增加报销审批路线
                    AddExpenseApproveRout(new CargoExpenseApproveRoutEntity
                    {
                        ExID = it.ExID,
                        UserID = it.OperaID,//当前操作人ID
                        UserName = it.OperaName,//当前操作人姓名
                        Opera = "2",
                        Result = "结束"
                    });
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 判断 是否存在申请单 与审批人数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistApproveCheck(CargoApproveCheckEntity entity)
        {
            string strQ = @"SELECT ApproveID FROM Tbl_Cargo_ApproveCheck WHERE ApproveID=@ApproveID AND CheckUserID=@CheckUserID";
            if (!string.IsNullOrEmpty(entity.CheckType))
            {
                strQ += " and CheckType=@CheckType";
            }
            if (!string.IsNullOrEmpty(entity.ApproveType))
            {
                strQ += " and ApproveType=@ApproveType";
            }

            using (DbCommand cmdQ = conn.GetSqlStringCommond(strQ))
            {
                conn.AddInParameter(cmdQ, "@ApproveID", DbType.Int64, entity.ApproveID);
                conn.AddInParameter(cmdQ, "@CheckUserID", DbType.String, entity.CheckUserID);
                if (!string.IsNullOrEmpty(entity.CheckType))
                {
                    conn.AddInParameter(cmdQ, "@CheckType", DbType.String, entity.CheckType);
                }
                if (!string.IsNullOrEmpty(entity.ApproveType))
                {
                    conn.AddInParameter(cmdQ, "@ApproveType", DbType.String, entity.ApproveType);
                }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        public void AddApproveCheck(CargoApproveCheckEntity entity)
        {
            entity.EnSafe();
            string strSQL = @"Insert Into Tbl_Cargo_ApproveCheck(ApproveID,CheckUserID,CheckName,OP_DATE,CheckType,ReadStatus,ApproveType) Values (@ApproveID,@CheckUserID,@CheckName,@OP_DATE,@CheckType,@ReadStatus,@ApproveType)";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ApproveID", DbType.Int64, entity.ApproveID);
                conn.AddInParameter(cmd, "@CheckUserID", DbType.String, entity.CheckUserID);
                conn.AddInParameter(cmd, "@CheckName", DbType.String, entity.CheckName);
                conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                conn.AddInParameter(cmd, "@CheckType", DbType.String, entity.CheckType);
                conn.AddInParameter(cmd, "@ReadStatus", DbType.String, entity.ReadStatus);
                conn.AddInParameter(cmd, "@ApproveType", DbType.String, entity.ApproveType);
                conn.ExecuteNonQuery(cmd);
            }
        }
        #endregion
        #region 报销科目查询
        /// <summary>
        /// 科目查询
        /// </summary>
        /// <returns></returns>
        public List<CargoZeroSubjectEntity> GetZeroSubject()
        {
            List<CargoZeroSubjectEntity> result = new List<CargoZeroSubjectEntity>();
            try
            {
                string strSQL = @"select * from Tbl_Cargo_ZeroSubject";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoZeroSubjectEntity
                            {
                                ZID = Convert.ToInt32(idr["ZID"]),
                                ZName = Convert.ToString(idr["ZName"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return result;
        }
        /// <summary>
        /// 根据科目ID查询一级科目数据
        /// </summary>
        /// <param name="fid"></param>
        /// <returns></returns>
        public List<CargoFirstSubjectEntity> GetFIDByZID(int zid)
        {
            List<CargoFirstSubjectEntity> result = new List<CargoFirstSubjectEntity>();
            try
            {
                string strSQL = @"select * from Tbl_Cargo_FirstSubject where ZID=@ZID";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@ZID", DbType.Int32, zid);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoFirstSubjectEntity
                            {
                                FID = Convert.ToInt32(idr["FID"]),
                                ZID = Convert.ToInt32(idr["ZID"]),
                                FName = Convert.ToString(idr["FName"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 根据一类ID和超级科目ID查询一类科目名称
        /// </summary>
        /// <param name="fid"></param>
        /// <param name="sid"></param>
        /// <returns></returns>
        public string GetFIDNameByZID(int zid, int fid)
        {
            string result = string.Empty;
            try
            {
                string strSQL = @"select FName from Tbl_Cargo_FirstSubject where FID=@FID and Zid=@Zid";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(command, "@BelongSystem", DbType.String, BelongSystem);
                    conn.AddInParameter(command, "@FID", DbType.Int32, fid);
                    conn.AddInParameter(command, "@Zid", DbType.Int32, zid);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        if (dt.Rows.Count > 0)
                        {
                            result = Convert.ToString(dt.Rows[0]["FName"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 一级科目查询
        /// </summary>
        /// <returns></returns>
        public List<CargoFirstSubjectEntity> GetFirstSubject()
        {
            List<CargoFirstSubjectEntity> result = new List<CargoFirstSubjectEntity>();
            try
            {
                string strSQL = @"select * from Tbl_Cargo_FirstSubject";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(command, "@BelongSystem", DbType.String, BelongSystem);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoFirstSubjectEntity
                            {
                                FID = Convert.ToInt32(idr["FID"]),
                                FName = Convert.ToString(idr["FName"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return result;
        }
        /// <summary>
        /// 根据一级科目ID查询二级科目数据
        /// </summary>
        /// <param name="fid"></param>
        /// <returns></returns>
        public List<CargoSecondSubjectEntity> GetSIDByFID(int fid)
        {

            List<CargoSecondSubjectEntity> result = new List<CargoSecondSubjectEntity>();
            try
            {
                string strSQL = @"select * from Tbl_Cargo_SecondSubject where FID=@FID";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(command, "@BelongSystem", DbType.String, BelongSystem);
                    conn.AddInParameter(command, "@FID", DbType.Int32, fid);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoSecondSubjectEntity
                            {
                                FID = Convert.ToInt32(idr["FID"]),
                                SID = Convert.ToInt32(idr["SID"]),
                                SName = Convert.ToString(idr["SName"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询所有二级科目
        /// </summary>
        /// <param name="BelongSystem"></param>
        /// <returns></returns>
        public List<CargoSecondSubjectEntity> GetSecondSubject()
        {
            List<CargoSecondSubjectEntity> result = new List<CargoSecondSubjectEntity>();
            try
            {
                string strSQL = @"select * from Tbl_Cargo_SecondSubject";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoSecondSubjectEntity
                            {
                                FID = Convert.ToInt32(idr["FID"]),
                                SID = Convert.ToInt32(idr["SID"]),
                                SName = Convert.ToString(idr["SName"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 根据一类ID和二类ID查询二类科目名称
        /// </summary>
        /// <param name="fid"></param>
        /// <param name="sid"></param>
        /// <returns></returns>
        public string GetSIDNameByFID(int fid, int sid)
        {

            string result = string.Empty;
            try
            {
                string strSQL = @"select SName from Tbl_Cargo_SecondSubject where FID=@FID and SID=@SID";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(command, "@BelongSystem", DbType.String, BelongSystem);
                    conn.AddInParameter(command, "@FID", DbType.Int32, fid);
                    conn.AddInParameter(command, "@SID", DbType.Int32, sid);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        if (dt.Rows.Count > 0)
                        {
                            result = Convert.ToString(dt.Rows[0]["SName"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        #endregion
        #region 审批流程设置
        /// <summary>
        /// 查询审批流程数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryFinanceApproveSet(int pIndex, int pNum, CargoApproveSetEntity entity)
        {
            List<CargoApproveSetEntity> result = new List<CargoApproveSetEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select DISTINCT ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.*,b.Name as HouseName from Tbl_Cargo_ExpenseApproveSet as a left join Tbl_Cargo_House as b on a.HouseID=b.HouseID where (1=1) ";
                //审批流程名称
                if (!string.IsNullOrEmpty(entity.ApproveName)) { strSQL += " and a.ApproveName like '%" + entity.ApproveName + "%'"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //审批类型
                if (!string.IsNullOrEmpty(entity.ApproveType)) { strSQL += " and a.ApproveType = '" + entity.ApproveType + "'"; }
                //状态
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strSQL += " and a.DelFlag = '" + entity.DelFlag + "'"; }
                strSQL += " ) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1))";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.Add(new CargoApproveSetEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                ApproveName = Convert.ToString(idr["ApproveName"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                ApproveType = Convert.ToString(idr["ApproveType"]),
                                DelFlag = Convert.ToString(idr["DelFlag"]),
                                OneCheckID = Convert.ToString(idr["OneCheckID"]),
                                OneCheckName = Convert.ToString(idr["OneCheckName"]),
                                TwoCheckID = Convert.ToString(idr["TwoCheckID"]),
                                TwoCheckName = Convert.ToString(idr["TwoCheckName"]),
                                ThreeCheckID = Convert.ToString(idr["ThreeCheckID"]),
                                ThreeCheckName = Convert.ToString(idr["ThreeCheckName"]),
                                FourCheckID = Convert.ToString(idr["FourCheckID"]),
                                FourCheckName = Convert.ToString(idr["FourCheckName"]),
                                FiveCheckID = Convert.ToString(idr["FiveCheckID"]),
                                FiveCheckName = Convert.ToString(idr["FiveCheckName"]),
                                SixCheckID = Convert.ToString(idr["SixCheckID"]),
                                SixCheckName = Convert.ToString(idr["SixCheckName"]),
                                SevenCheckID = Convert.ToString(idr["SevenCheckID"]),
                                SevenCheckName = Convert.ToString(idr["SevenCheckName"]),
                                EightCheckID = Convert.ToString(idr["EightCheckID"]),
                                EightCheckName = Convert.ToString(idr["EightCheckName"]),
                                NineCheckID = Convert.ToString(idr["NineCheckID"]),
                                NineCheckName = Convert.ToString(idr["NineCheckName"]),
                                TenCheckID = Convert.ToString(idr["TenCheckID"]),
                                TenCheckName = Convert.ToString(idr["TenCheckName"]),
                                CopyUserName = Convert.ToString(idr["CopyUserName"]),
                                CopyCheckName = Convert.ToString(idr["CopyCheckName"]),
                                AutoPassID = Convert.ToString(idr["AutoPassID"]),
                                AutoPassName = Convert.ToString(idr["AutoPassName"]),
                                CopyCheck = Convert.ToString(idr["CopyCheck"]),
                                CopyUserID = Convert.ToString(idr["CopyUserID"])
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_ExpenseApproveSet as a  Where (1=1)";
                //审批流程名称
                if (!string.IsNullOrEmpty(entity.ApproveName)) { strCount += " and a.ApproveName like '%" + entity.ApproveName + "%'"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //审批类型
                if (!string.IsNullOrEmpty(entity.ApproveType)) { strCount += " and a.ApproveType = '" + entity.ApproveType + "'"; }
                //状态
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strCount += " and a.DelFlag = '" + entity.DelFlag + "'"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 新增审批流程数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddFinanceApproveSet(CargoApproveSetEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_ExpenseApproveSet(HouseID,ApproveName,OneCheckID,OneCheckName,TwoCheckID,TwoCheckName,ThreeCheckID,ThreeCheckName,FourCheckID,CopyCheck,CopyUserID,FourCheckName,FiveCheckID,FiveCheckName,SixCheckID,SixCheckName,SevenCheckID,SevenCheckName,EightCheckID,EightCheckName,NineCheckID,NineCheckName,TenCheckID,TenCheckName,ApproveType,DelFlag,OP_DATE,CopyCheckName,CopyUserName,AutoPassID,AutoPassName) VALUES (@HouseID,@ApproveName,@OneCheckID,@OneCheckName,@TwoCheckID,@TwoCheckName,@ThreeCheckID,@ThreeCheckName,@FourCheckID,@CopyCheck,@CopyUserID,@FourCheckName,@FiveCheckID,@FiveCheckName,@SixCheckID,@SixCheckName,@SevenCheckID,@SevenCheckName,@EightCheckID,@EightCheckName,@NineCheckID,@NineCheckName,@TenCheckID,@TenCheckName,@ApproveType,@DelFlag,@OP_DATE,@CopyCheckName,@CopyUserName,@AutoPassID,@AutoPassName)";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@ApproveName", DbType.String, entity.ApproveName);
                    conn.AddInParameter(cmd, "@OneCheckID", DbType.String, entity.OneCheckID);
                    conn.AddInParameter(cmd, "@OneCheckName", DbType.String, entity.OneCheckName);
                    conn.AddInParameter(cmd, "@TwoCheckID", DbType.String, entity.TwoCheckID);
                    conn.AddInParameter(cmd, "@TwoCheckName", DbType.String, entity.TwoCheckName);
                    conn.AddInParameter(cmd, "@ThreeCheckID", DbType.String, entity.ThreeCheckID);
                    conn.AddInParameter(cmd, "@ThreeCheckName", DbType.String, entity.ThreeCheckName);
                    conn.AddInParameter(cmd, "@FourCheckID", DbType.String, entity.FourCheckID);
                    conn.AddInParameter(cmd, "@FourCheckName", DbType.String, entity.FourCheckName);
                    conn.AddInParameter(cmd, "@FiveCheckID", DbType.String, entity.FiveCheckID);
                    conn.AddInParameter(cmd, "@FiveCheckName", DbType.String, entity.FiveCheckName);
                    conn.AddInParameter(cmd, "@SixCheckID", DbType.String, entity.SixCheckID);
                    conn.AddInParameter(cmd, "@SixCheckName", DbType.String, entity.SixCheckName);
                    conn.AddInParameter(cmd, "@SevenCheckID", DbType.String, entity.SevenCheckID);
                    conn.AddInParameter(cmd, "@SevenCheckName", DbType.String, entity.SevenCheckName);
                    conn.AddInParameter(cmd, "@EightCheckID", DbType.String, entity.EightCheckID);
                    conn.AddInParameter(cmd, "@EightCheckName", DbType.String, entity.EightCheckName);
                    conn.AddInParameter(cmd, "@NineCheckID", DbType.String, entity.NineCheckID);
                    conn.AddInParameter(cmd, "@NineCheckName", DbType.String, entity.NineCheckName);
                    conn.AddInParameter(cmd, "@TenCheckID", DbType.String, entity.TenCheckID);
                    conn.AddInParameter(cmd, "@TenCheckName", DbType.String, entity.TenCheckName);
                    conn.AddInParameter(cmd, "@CopyCheck", DbType.String, entity.CopyCheck);
                    conn.AddInParameter(cmd, "@CopyUserID", DbType.String, entity.CopyUserID);
                    conn.AddInParameter(cmd, "@CopyCheckName", DbType.String, entity.CopyCheckName);
                    conn.AddInParameter(cmd, "@CopyUserName", DbType.String, entity.CopyUserName);
                    conn.AddInParameter(cmd, "@AutoPassID", DbType.String, entity.AutoPassID);
                    conn.AddInParameter(cmd, "@AutoPassName", DbType.String, entity.AutoPassName);

                    conn.AddInParameter(cmd, "@ApproveType", DbType.String, entity.ApproveType);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.String, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改审批流程设置 
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateFinanceApproveSet(CargoApproveSetEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_ExpenseApproveSet SET HouseID = @HouseID,ApproveName = @ApproveName,OneCheckID = @OneCheckID,OneCheckName = @OneCheckName,TwoCheckID = @TwoCheckID,TwoCheckName = @TwoCheckName,ThreeCheckID = @ThreeCheckID,ThreeCheckName = @ThreeCheckName,FourCheckID=@FourCheckID,FourCheckName=@FourCheckName,FiveCheckID=@FiveCheckID,FiveCheckName=@FiveCheckName,SixCheckID=@SixCheckID,SixCheckName=@SixCheckName,SevenCheckID=@SevenCheckID,SevenCheckName=@SevenCheckName,EightCheckID=@EightCheckID,EightCheckName=@EightCheckName,NineCheckID=@NineCheckID,NineCheckName=@NineCheckName,TenCheckID=@TenCheckID,TenCheckName=@TenCheckName,CopyCheck=@CopyCheck,CopyUserID=@CopyUserID,ApproveType = @ApproveType,DelFlag = @DelFlag,OP_DATE = @OP_DATE,CopyUserName=@CopyUserName,CopyCheckName=@CopyCheckName,AutoPassID=@AutoPassID,AutoPassName=@AutoPassName WHERE ID=@ID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@ApproveName", DbType.String, entity.ApproveName);
                    conn.AddInParameter(cmd, "@OneCheckID", DbType.String, entity.OneCheckID);
                    conn.AddInParameter(cmd, "@OneCheckName", DbType.String, entity.OneCheckName);
                    conn.AddInParameter(cmd, "@TwoCheckID", DbType.String, entity.TwoCheckID);
                    conn.AddInParameter(cmd, "@TwoCheckName", DbType.String, entity.TwoCheckName);
                    conn.AddInParameter(cmd, "@ThreeCheckID", DbType.String, entity.ThreeCheckID);
                    conn.AddInParameter(cmd, "@ThreeCheckName", DbType.String, entity.ThreeCheckName);
                    conn.AddInParameter(cmd, "@FourCheckID", DbType.String, entity.FourCheckID);
                    conn.AddInParameter(cmd, "@FourCheckName", DbType.String, entity.FourCheckName);
                    conn.AddInParameter(cmd, "@FiveCheckID", DbType.String, entity.FiveCheckID);
                    conn.AddInParameter(cmd, "@FiveCheckName", DbType.String, entity.FiveCheckName);
                    conn.AddInParameter(cmd, "@SixCheckID", DbType.String, entity.SixCheckID);
                    conn.AddInParameter(cmd, "@SixCheckName", DbType.String, entity.SixCheckName);
                    conn.AddInParameter(cmd, "@SevenCheckID", DbType.String, entity.SevenCheckID);
                    conn.AddInParameter(cmd, "@SevenCheckName", DbType.String, entity.SevenCheckName);
                    conn.AddInParameter(cmd, "@EightCheckID", DbType.String, entity.EightCheckID);
                    conn.AddInParameter(cmd, "@EightCheckName", DbType.String, entity.EightCheckName);
                    conn.AddInParameter(cmd, "@NineCheckID", DbType.String, entity.NineCheckID);
                    conn.AddInParameter(cmd, "@NineCheckName", DbType.String, entity.NineCheckName);
                    conn.AddInParameter(cmd, "@TenCheckID", DbType.String, entity.TenCheckID);
                    conn.AddInParameter(cmd, "@TenCheckName", DbType.String, entity.TenCheckName);
                    conn.AddInParameter(cmd, "@CopyCheck", DbType.String, entity.CopyCheck);
                    conn.AddInParameter(cmd, "@CopyUserID", DbType.String, entity.CopyUserID);
                    conn.AddInParameter(cmd, "@ApproveType", DbType.String, entity.ApproveType);
                    conn.AddInParameter(cmd, "@DelFlag", DbType.String, entity.DelFlag);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.String, DateTime.Now);
                    conn.AddInParameter(cmd, "@CopyCheckName", DbType.String, entity.CopyCheckName);
                    conn.AddInParameter(cmd, "@CopyUserName", DbType.String, entity.CopyUserName);
                    conn.AddInParameter(cmd, "@AutoPassID", DbType.String, entity.AutoPassID);
                    conn.AddInParameter(cmd, "@AutoPassName", DbType.String, entity.AutoPassName);
                    conn.AddInParameter(cmd, "@ID", DbType.Int32, entity.ID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 删除审批流程数据
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="ty"></param>
        public void DelFinanceApproveSet(List<CargoApproveSetEntity> entity, int ty)
        {
            try
            {
                foreach (var it in entity)
                {
                    it.EnSafe();
                    string strDel = @"UPDATE Tbl_Cargo_ExpenseApproveSet SET DelFlag=1 WHERE ID=@ID";
                    if (ty.Equals(1))
                    {
                        strDel = @"Delete From Tbl_Cargo_ExpenseApproveSet WHERE ID=@ID";
                    }
                    if (ty.Equals(2))
                    {
                        strDel = @"UPDATE Tbl_Cargo_ExpenseApproveSet SET DelFlag=0 WHERE ID=@ID";
                    }
                    using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                    {
                        conn.AddInParameter(cmdAdd, "@ID", DbType.Int32, it.ID);
                        conn.ExecuteNonQuery(cmdAdd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 根据流程ID查询审批流程数据
        /// </summary>
        /// <param name="approveID"></param>
        /// <returns></returns>
        public CargoApproveSetEntity QueryApproveSetByID(int approveID)
        {
            CargoApproveSetEntity result = new CargoApproveSetEntity();
            try
            {
                string strSQL = @"Select * from Tbl_Cargo_ExpenseApproveSet where ID=@ID and DelFlag='0'";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@ID", DbType.Int32, approveID);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.ID = Convert.ToInt32(idr["ID"]);
                            result.HouseID = Convert.ToInt32(idr["HouseID"]);
                            result.ApproveName = Convert.ToString(idr["ApproveName"]);
                            result.OP_DATE = Convert.ToDateTime(idr["OP_DATE"]);
                            result.ApproveType = Convert.ToString(idr["ApproveType"]);
                            result.DelFlag = Convert.ToString(idr["DelFlag"]);
                            result.OneCheckID = Convert.ToString(idr["OneCheckID"]);
                            result.OneCheckName = Convert.ToString(idr["OneCheckName"]);
                            result.TwoCheckID = Convert.ToString(idr["TwoCheckID"]);
                            result.TwoCheckName = Convert.ToString(idr["TwoCheckName"]);
                            result.ThreeCheckID = Convert.ToString(idr["ThreeCheckID"]);
                            result.ThreeCheckName = Convert.ToString(idr["ThreeCheckName"]);
                            result.FourCheckID = Convert.ToString(idr["FourCheckID"]);
                            result.FourCheckName = Convert.ToString(idr["FourCheckName"]);
                            result.FiveCheckID = Convert.ToString(idr["FiveCheckID"]);
                            result.FiveCheckName = Convert.ToString(idr["FiveCheckName"]);
                            result.SixCheckID = Convert.ToString(idr["SixCheckID"]);
                            result.SixCheckName = Convert.ToString(idr["SixCheckName"]);
                            result.SevenCheckID = Convert.ToString(idr["SevenCheckID"]);
                            result.SevenCheckName = Convert.ToString(idr["SevenCheckName"]);
                            result.EightCheckID = Convert.ToString(idr["EightCheckID"]);
                            result.EightCheckName = Convert.ToString(idr["EightCheckName"]);
                            result.NineCheckID = Convert.ToString(idr["NineCheckID"]);
                            result.NineCheckName = Convert.ToString(idr["NineCheckName"]);
                            result.TenCheckID = Convert.ToString(idr["TenCheckID"]);
                            result.TenCheckName = Convert.ToString(idr["TenCheckName"]);
                            result.CopyCheck = Convert.ToString(idr["CopyCheck"]);
                            result.CopyCheckName = Convert.ToString(idr["CopyCheckName"]);
                            result.CopyUserName = Convert.ToString(idr["CopyUserName"]);
                            result.CopyUserID = Convert.ToString(idr["CopyUserID"]);
                            result.AutoPassID = Convert.ToString(idr["AutoPassID"]);
                            result.AutoPassName = Convert.ToString(idr["AutoPassName"]);

                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询可用的审批流程
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoApproveSetEntity> QueryApproveSet(CargoApproveSetEntity entity)
        {
            List<CargoApproveSetEntity> result = new List<CargoApproveSetEntity>();
            try
            {
                string strSQL = @"Select * from Tbl_Cargo_ExpenseApproveSet where 1=1 ";
                if (!entity.HouseID.Equals(0)) { strSQL += " and HouseID = " + entity.HouseID; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and HouseID in (" + entity.CargoPermisID + ")"; }
                //审批类型
                if (!string.IsNullOrEmpty(entity.ApproveType)) { strSQL += " and ApproveType = '" + entity.ApproveType + "'"; }
                //状态
                if (!string.IsNullOrEmpty(entity.DelFlag)) { strSQL += " and DelFlag = '" + entity.DelFlag + "'"; }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.Add(new CargoApproveSetEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ApproveName = Convert.ToString(idr["ApproveName"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                ApproveType = Convert.ToString(idr["ApproveType"]),
                                DelFlag = Convert.ToString(idr["DelFlag"]),
                                OneCheckID = Convert.ToString(idr["OneCheckID"]),
                                OneCheckName = Convert.ToString(idr["OneCheckName"]),
                                TwoCheckID = Convert.ToString(idr["TwoCheckID"]),
                                TwoCheckName = Convert.ToString(idr["TwoCheckName"]),
                                ThreeCheckID = Convert.ToString(idr["ThreeCheckID"]),
                                ThreeCheckName = Convert.ToString(idr["ThreeCheckName"]),
                                FourCheckID = Convert.ToString(idr["FourCheckID"]),
                                FourCheckName = Convert.ToString(idr["FourCheckName"]),
                                FiveCheckID = Convert.ToString(idr["FiveCheckID"]),
                                FiveCheckName = Convert.ToString(idr["FiveCheckName"]),
                                SixCheckID = Convert.ToString(idr["SixCheckID"]),
                                SixCheckName = Convert.ToString(idr["SixCheckName"]),
                                SevenCheckID = Convert.ToString(idr["SevenCheckID"]),
                                SevenCheckName = Convert.ToString(idr["SevenCheckName"]),
                                EightCheckID = Convert.ToString(idr["EightCheckID"]),
                                EightCheckName = Convert.ToString(idr["EightCheckName"]),
                                NineCheckID = Convert.ToString(idr["NineCheckID"]),
                                NineCheckName = Convert.ToString(idr["NineCheckName"]),
                                TenCheckID = Convert.ToString(idr["TenCheckID"]),
                                TenCheckName = Convert.ToString(idr["TenCheckName"]),
                                AutoPassName = Convert.ToString(idr["AutoPassName"]),
                                AutoPassID = Convert.ToString(idr["AutoPassID"]),
                                CopyCheck = Convert.ToString(idr["CopyCheck"]),
                                CopyUserID = Convert.ToString(idr["CopyUserID"])
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        #endregion
        #region 付款申请书
        /// <summary>
        /// 查询收款人数据用于缓存
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoReceiveInfoEntity> QueryReceiveNameList(CargoReceiveInfoEntity entity)
        {
            List<CargoReceiveInfoEntity> result = new List<CargoReceiveInfoEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @"select distinct CardName From Tbl_Cargo_ReceiveInfo Where HouseID=@HouseID";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@HouseID", DbType.Int32, entity.HouseID);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoReceiveInfoEntity
                            {
                                CardName = Convert.ToString(idr["CardName"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 根据收款人姓名查询该收款人名下的所有银行卡信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoReceiveInfoEntity> QueryReceiveInfo(CargoReceiveInfoEntity entity)
        {
            List<CargoReceiveInfoEntity> result = new List<CargoReceiveInfoEntity>();
            try
            {
                entity.EnSafe();
                string strSQL = @"select * From Tbl_Cargo_ReceiveInfo Where HouseID=@HouseID";
                if (!string.IsNullOrEmpty(entity.CardName)) { strSQL += " and CardName='" + entity.CardName + "'"; }
                if (!string.IsNullOrEmpty(entity.CardType)) { strSQL += " and CardType='" + entity.CardType + "'"; }
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@HouseID", DbType.Int32, entity.HouseID);
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoReceiveInfoEntity
                            {
                                CardName = Convert.ToString(idr["CardName"]),
                                CardBank = Convert.ToString(idr["CardBank"]),
                                ReceiveUnit = Convert.ToString(idr["ReceiveUnit"]),
                                CardNum = Convert.ToString(idr["CardNum"]),
                                CardType = Convert.ToString(idr["CardType"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 根据收款人姓名和银行卡号判断是否存在，如果存在就过，不存在就保存
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistReceiveInfo(CargoReceiveInfoEntity entity)
        {
            string strSQL = "Select ID from Tbl_Cargo_ReceiveInfo where HouseID=@HouseID and CardName=@CardName and CardNum=@CardNum";
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmdQ, "@CardNum", DbType.String, entity.CardNum);
                conn.AddInParameter(cmdQ, "@CardName", DbType.String, entity.CardName);
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 保存收款人信息
        /// </summary>
        /// <param name="entity"></param>
        public void AddReveiveInfo(CargoReceiveInfoEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_ReceiveInfo(ReceiveUnit,CardName,CardBank,CardNum,CardType,HouseID) VALUES (@ReceiveUnit,@CardName,@CardBank,@CardNum,@CardType,@HouseID)";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmd, "@ReceiveUnit", DbType.String, entity.ReceiveUnit);
                conn.AddInParameter(cmd, "@CardBank", DbType.String, entity.CardBank);
                conn.AddInParameter(cmd, "@CardName", DbType.String, entity.CardName);
                conn.AddInParameter(cmd, "@CardNum", DbType.String, entity.CardNum);
                conn.AddInParameter(cmd, "@CardType", DbType.String, entity.CardType);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 保存付款申请书记录
        /// </summary>
        /// <param name="entity"></param>
        public long SavePayment(CargoPaymentEntity entity)
        {
            Int64 did = 0;
            string strSQL = @"INSERT INTO Tbl_Cargo_Payment(ApplyDep,ApplyPeople,ReceiveUnit,CardName,CardBank,CardNum,PayMoney,PayWay,PayMemo,RelateAwb,HouseID) VALUES (@ApplyDep,@ApplyPeople,@ReceiveUnit,@CardName,@CardBank,@CardNum,@PayMoney,@PayWay,@PayMemo,@RelateAwb,@HouseID) SELECT @@IDENTITY";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmd, "@ApplyDep", DbType.String, entity.ApplyDep);
                conn.AddInParameter(cmd, "@ApplyPeople", DbType.String, entity.ApplyPeople);
                conn.AddInParameter(cmd, "@ReceiveUnit", DbType.String, entity.ReceiveUnit);
                conn.AddInParameter(cmd, "@CardBank", DbType.String, entity.CardBank);
                conn.AddInParameter(cmd, "@CardName", DbType.String, entity.CardName);
                conn.AddInParameter(cmd, "@CardNum", DbType.String, entity.CardNum);
                conn.AddInParameter(cmd, "@PayMoney", DbType.Decimal, entity.PayMoney);
                conn.AddInParameter(cmd, "@PayWay", DbType.String, entity.PayWay);
                conn.AddInParameter(cmd, "@PayMemo", DbType.String, entity.PayMemo);
                conn.AddInParameter(cmd, "@RelateAwb", DbType.String, entity.RelateAwb);
                //conn.ExecuteNonQuery(cmd);
                did = Convert.ToInt64(conn.ExecuteScalar(cmd));
            }
            return did;
        }
        /// <summary>
        /// 修改报销付款涵
        /// </summary>
        /// <param name="entity"></param>
        public void UpdatePayment(CargoPaymentEntity entity)
        {
            string strSQL = @"Update Tbl_Cargo_Payment set ApplyDep=@ApplyDep,ReceiveUnit=@ReceiveUnit,CardName=@CardName,CardBank=@CardBank,CardNum=@CardNum,PayWay=@PayWay,PayMemo=@PayMemo,PayMoney=@PayMoney Where ID=@ID";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ApplyDep", DbType.String, entity.ApplyDep);
                conn.AddInParameter(cmd, "@ReceiveUnit", DbType.String, entity.ReceiveUnit);
                conn.AddInParameter(cmd, "@CardBank", DbType.String, entity.CardBank);
                conn.AddInParameter(cmd, "@CardName", DbType.String, entity.CardName);
                conn.AddInParameter(cmd, "@CardNum", DbType.String, entity.CardNum);
                conn.AddInParameter(cmd, "@PayWay", DbType.String, entity.PayWay);
                conn.AddInParameter(cmd, "@PayMemo", DbType.String, entity.PayMemo);
                conn.AddInParameter(cmd, "@PayMoney", DbType.Decimal, entity.PayMoney);
                conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 根据仓库ID和关联单号查询付款申请书
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoPaymentEntity QueryPaymentEntity(CargoPaymentEntity entity)
        {
            CargoPaymentEntity result = new CargoPaymentEntity();
            string strSQL = "Select * from Tbl_Cargo_Payment where (1=1)";
            if (!entity.HouseID.Equals(0)) { strSQL += " and HouseID=@HouseID"; }
            if (!string.IsNullOrEmpty(entity.RelateAwb)) { strSQL += " and RelateAwb=@RelateAwb"; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                if (!entity.HouseID.Equals(0)) { conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID); }
                if (!string.IsNullOrEmpty(entity.RelateAwb)) { conn.AddInParameter(cmdQ, "@RelateAwb", DbType.String, entity.RelateAwb); }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr.Rows.Count > 0)
                    {
                        result.ID = Convert.ToInt64(idr.Rows[0]["ID"]);
                        result.ApplyDep = Convert.ToString(idr.Rows[0]["ApplyDep"]);
                        result.ApplyPeople = Convert.ToString(idr.Rows[0]["ApplyPeople"]);
                        result.ReceiveUnit = Convert.ToString(idr.Rows[0]["ReceiveUnit"]);
                        result.CardBank = Convert.ToString(idr.Rows[0]["CardBank"]);
                        result.CardName = Convert.ToString(idr.Rows[0]["CardName"]);
                        result.CardNum = Convert.ToString(idr.Rows[0]["CardNum"]);
                        result.RelateAwb = Convert.ToString(idr.Rows[0]["RelateAwb"]);
                        result.HouseID = Convert.ToInt32(idr.Rows[0]["HouseID"]);
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 判断是否存在相同的付款申请书
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistPayment(CargoPaymentEntity entity)
        {
            string strSQL = "Select ID from Tbl_Cargo_Payment where (1=1)";
            if (!entity.HouseID.Equals(0)) { strSQL += " and HouseID=@HouseID"; }
            if (!string.IsNullOrEmpty(entity.RelateAwb)) { strSQL += " and RelateAwb=@RelateAwb"; }
            using (DbCommand cmdQ = conn.GetSqlStringCommond(strSQL))
            {
                if (!entity.HouseID.Equals(0)) { conn.AddInParameter(cmdQ, "@HouseID", DbType.Int32, entity.HouseID); }
                if (!string.IsNullOrEmpty(entity.RelateAwb)) { conn.AddInParameter(cmdQ, "@RelateAwb", DbType.String, entity.RelateAwb); }
                using (DataTable idr = conn.ExecuteDataTable(cmdQ))
                {
                    if (idr == null)
                    {
                        return false;
                    }
                    if (idr.Rows.Count <= 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
        /// <summary>
        /// 更新打印次数
        /// </summary>
        /// <param name="entity"></param>
        public void UpdatePaymentPrintNum(CargoPaymentEntity entity)
        {
            entity.EnSafe();
            string strSQL = "Update Tbl_Cargo_Payment Set PrintNum=PrintNum+@PrintNum Where ID=@ID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@PrintNum", DbType.Int32, entity.PrintNum);
                conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 新增付款申请与单号关联数据
        /// </summary>
        /// <param name="pay"></param>
        public void AddPayRelateAwb(List<CargoPayRelateAwbEntity> pay)
        {
            foreach (var it in pay)
            {
                it.EnSafe();
                string strSQL = @"INSERT INTO Tbl_Cargo_PayRelateAwb(PayID,RelateAwb) VALUES (@PayID,@RelateAwb)";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@PayID", DbType.Int64, it.PayID);
                    conn.AddInParameter(cmd, "@RelateAwb", DbType.String, it.RelateAwb);
                    conn.ExecuteNonQuery(cmd);
                }
            }
        }
        /// <summary>
        /// 保存付款申请书打印数据记录
        /// </summary>
        /// <param name="entity"></param>
        public void AddPayPrintInfo(CargoPayPrintInfoEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_PayPrintInfo(PayID,PrintName) VALUES (@PayID,@PrintName)";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@PayID", DbType.Int64, entity.PayID);
                conn.AddInParameter(cmd, "@PrintName", DbType.String, entity.PrintName);
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 查询付款涵数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable RemitQuery(int pIndex, int pNum, CargoPaymentEntity entity)
        {
            List<CargoPaymentEntity> result = new List<CargoPaymentEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select DISTINCT ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.*,b.Name as HouseName from Tbl_Cargo_Payment as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID where (1=1) ";
                if (!string.IsNullOrEmpty(entity.RelateAwb)) { strSQL += " and a.RelateAwb like '%" + entity.RelateAwb + "%'"; }
                if (!string.IsNullOrEmpty(entity.ApplyPeople)) { strSQL += " and a.ApplyPeople like '%" + entity.ApplyPeople + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveUnit)) { strSQL += " and a.ReceiveUnit like '%" + entity.ReceiveUnit + "%'"; }
                if (!string.IsNullOrEmpty(entity.CardName)) { strSQL += " and a.CardName like '%" + entity.CardName + "%'"; }
                if (!string.IsNullOrEmpty(entity.CardNum)) { strSQL += " and a.CardNum like '%" + entity.CardNum + "%'"; }
                if (!string.IsNullOrEmpty(entity.CardBank)) { strSQL += " and a.CardBank like '%" + entity.CardBank + "%'"; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID =" + entity.HouseID; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OP_DATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " ) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1))";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.Add(new CargoPaymentEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                ApplyPeople = Convert.ToString(idr["ApplyPeople"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                ApplyDep = Convert.ToString(idr["ApplyDep"]),
                                CardBank = Convert.ToString(idr["CardBank"]),
                                ReceiveUnit = Convert.ToString(idr["ReceiveUnit"]),
                                CardName = Convert.ToString(idr["CardName"]),
                                PayMoney = Convert.ToDecimal(idr["PayMoney"]),
                                PayMemo = Convert.ToString(idr["PayMemo"]),
                                PayWay = Convert.ToString(idr["PayWay"]),
                                CardNum = Convert.ToString(idr["CardNum"]),
                                RelateAwb = Convert.ToString(idr["RelateAwb"]),
                                PrintNum = Convert.ToInt32(idr["PrintNum"])
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_Payment as a  Where (1=1)";
                if (!string.IsNullOrEmpty(entity.RelateAwb)) { strCount += " and a.RelateAwb like '%" + entity.RelateAwb + "%'"; }
                if (!string.IsNullOrEmpty(entity.ApplyPeople)) { strCount += " and a.ApplyPeople like '%" + entity.ApplyPeople + "%'"; }
                if (!string.IsNullOrEmpty(entity.ReceiveUnit)) { strCount += " and a.ReceiveUnit like '%" + entity.ReceiveUnit + "%'"; }
                if (!string.IsNullOrEmpty(entity.CardName)) { strCount += " and a.CardName like '%" + entity.CardName + "%'"; }
                if (!string.IsNullOrEmpty(entity.CardNum)) { strCount += " and a.CardNum like '%" + entity.CardNum + "%'"; }
                if (!string.IsNullOrEmpty(entity.CardBank)) { strCount += " and a.CardBank like '%" + entity.CardBank + "%'"; }
                if (!entity.HouseID.Equals(0)) { strCount += " and a.HouseID =" + entity.HouseID; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.OP_DATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        #endregion
        #region 物流账单
        /// <summary>
        /// 查询物流账单信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoAccountEntity> QueryAccountList(CargoAccountEntity entity)
        {
            List<CargoAccountEntity> result = new List<CargoAccountEntity>();
            string strSQL = "select * from Tbl_Cargo_Account a where 1=1";

            //制单日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.AccountNo))
            {
                strSQL += " and a.AccountNo like '%" + entity.AccountNo + "%'";
            }
            if (!string.IsNullOrEmpty(entity.OrderNo))
            {
                strSQL += " and a.AccountNo = (select AccountNo from Tbl_Cargo_Order  where OrderNo ='" + entity.OrderNo + "')";
            }
            if (!string.IsNullOrEmpty(entity.CheckStatus))
            {
                strSQL += " and a.CheckStatus = '" + entity.CheckStatus + "'";
            }
            if (!string.IsNullOrEmpty(entity.Name))
            {
                strSQL += " and a.Name = '" + entity.Name + "'";
            }
            strSQL += " ORDER BY a.OP_DATE DESC";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        decimal ReceivedMoney = 0.00M;
                        #region 查询已收款
                        DataTable record = QueryFinanceRecordByNo(Convert.ToString(idr["AccountNo"]), "1", "4");
                        if (record != null)
                        {
                            foreach (DataRow drr in record.Rows)
                            {
                                ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                            }
                        }
                        #endregion
                        result.Add(new CargoAccountEntity
                        {
                            ID = Convert.ToInt32(idr["ID"]),
                            AccountNo = Convert.ToString(idr["AccountNo"]),
                            Title = Convert.ToString(idr["Title"]),
                            CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                            Name = Convert.ToString(idr["Name"]).Trim(),
                            Total = string.IsNullOrEmpty(Convert.ToString(idr["Total"])) ? 0 : Convert.ToDouble(idr["Total"]),
                            TaxFee = string.IsNullOrEmpty(Convert.ToString(idr["TaxFee"])) ? 0 : Convert.ToDouble(idr["TaxFee"]),
                            OtherFee = string.IsNullOrEmpty(Convert.ToString(idr["OtherFee"])) ? 0 : Convert.ToDouble(idr["OtherFee"]),
                            CollectMoney = string.IsNullOrEmpty(Convert.ToString(idr["CollectMoney"])) ? 0 : Convert.ToDouble(idr["CollectMoney"]),
                            PayMoney = string.IsNullOrEmpty(Convert.ToString(idr["PayMoney"])) ? 0 : Convert.ToDouble(idr["PayMoney"]),
                            Memo = Convert.ToString(idr["Memo"]).Trim(),
                            ApplyStatus = Convert.ToString(idr["ApplyStatus"]),
                            CheckName = Convert.ToString(idr["CheckName"]).Trim(),
                            CheckDate = string.IsNullOrEmpty(Convert.ToString(idr["CheckDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["CheckDate"]),
                            CheckStatus = Convert.ToString(idr["CheckStatus"]),
                            OP_ID = Convert.ToString(idr["OP_ID"]).Trim(),
                            OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                            ReceivedMoney = ReceivedMoney,
                            AType = Convert.ToInt32(idr["AType"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询订单信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderEntity> QueryOrderList(CargoOrderEntity entity)
        {
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();
            string strSQL = "select a.OrderID,a.OrderNo,a.ClientNum,a.AcceptUnit,ISNULL(b.LogisticName,'')as LogisticName,a.LogisAwbNo,a.Dep,a.Dest,a.Piece,a.DeliveryFee from Tbl_Cargo_Order a left join Tbl_Cargo_Logistic b on a.LogisID=b.ID where 1=1 and DeliveryType=0 ";

            if (!string.IsNullOrEmpty(entity.AccountNo))
            {
                strSQL += " and a.AccountNo = '" + entity.AccountNo + "'";
            }
            else
            {
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                strSQL += " and AccountNo is null";
            }

            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoOrderEntity
                        {
                            OrderID = Convert.ToInt64(idr["OrderID"]),
                            OrderNo = Convert.ToString(idr["OrderNo"]),
                            AcceptUnit = Convert.ToString(idr["AcceptUnit"]).Trim(),
                            LogisAwbNo = Convert.ToString(idr["LogisAwbNo"]).Trim(),
                            LogisticName = Convert.ToString(idr["LogisticName"]).Trim(),
                            Dep = Convert.ToString(idr["Dep"]).Trim(),
                            Dest = Convert.ToString(idr["Dest"]).Trim(),
                            Piece = Convert.ToInt32(idr["Piece"]),
                            DeliveryFee = Convert.ToDecimal(idr["DeliveryFee"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询当前日期最大账单号
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public int GetMaxAccountNumByDate(CargoAccountEntity entity)
        {
            int result = 0;
            try
            {
                string strSQL = @"select ISNULL(MAX(ID),0) as ID from Tbl_Cargo_Account where AType=@AType ";
                strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(command, "@AType", DbType.Int32, entity.AType);
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        if (dd.Rows.Count > 0) { result = Convert.ToInt32(dd.Rows[0]["ID"]); }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 新增账单
        /// </summary>
        /// <param name="entity"></param>
        public void InsertAccountData(CargoAccountEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_Account (AccountNo,Title,CreateDate,Name,Total,TaxFee,OtherFee,Memo,OP_ID,OP_DATE,AType) VALUES (@AccountNo,@Title,@CreateDate,@Name,@Total,@TaxFee,@OtherFee,@Memo,@OP_ID,@OP_DATE,@AType)";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@AccountNo", DbType.String, entity.AccountNo);
                    conn.AddInParameter(cmd, "@Title", DbType.String, entity.Title);
                    conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@Name", DbType.String, entity.Name);
                    conn.AddInParameter(cmd, "@Total", DbType.Double, entity.Total);
                    conn.AddInParameter(cmd, "@TaxFee", DbType.Double, entity.TaxFee);
                    conn.AddInParameter(cmd, "@OtherFee", DbType.Double, entity.OtherFee);
                    conn.AddInParameter(cmd, "@Memo", DbType.String, entity.Memo);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@AType", DbType.Int32, entity.AType);
                    conn.ExecuteNonQuery(cmd);
                }
                if (entity.orderList != null)
                {
                    foreach (var item in entity.orderList)
                    {
                        UpdateOrderAccountNo(entity.AccountNo, item.OrderNo);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        /// <summary>
        /// 编辑账单
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateAccountData(CargoAccountEntity entity)
        {
            string strSQL = @"UPDATE Tbl_Cargo_Account set Title=@Title,Name=@Name,Total=@Total,TaxFee=@TaxFee,OtherFee=@OtherFee,Memo=@Memo,OP_ID=@OP_ID,OP_DATE=@OP_DATE,AType=@AType where AccountNo=@AccountNo";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@AccountNo", DbType.String, entity.AccountNo);
                    conn.AddInParameter(cmd, "@Title", DbType.String, entity.Title);
                    conn.AddInParameter(cmd, "@Name", DbType.String, entity.Name);
                    conn.AddInParameter(cmd, "@Total", DbType.Double, entity.Total);
                    conn.AddInParameter(cmd, "@TaxFee", DbType.Double, entity.TaxFee);
                    conn.AddInParameter(cmd, "@OtherFee", DbType.Double, entity.OtherFee);
                    conn.AddInParameter(cmd, "@Memo", DbType.String, entity.Memo);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.AddInParameter(cmd, "@AType", DbType.Int32, entity.AType);
                    conn.ExecuteNonQuery(cmd);
                }
                if (entity.orderList != null)
                {
                    foreach (var item in entity.orderList)
                    {
                        UpdateOrderAccountNo(entity.AccountNo, item.OrderNo);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        /// <summary>
        /// 修改订单账单号
        /// </summary>
        /// <param name="AccountNo"></param>
        /// <param name="OrderNo"></param>
        public void UpdateOrderAccountNo(string AccountNo, string OrderNo)
        {
            if (!string.IsNullOrEmpty(AccountNo))
            {
                string strSQL = "";
                if (!string.IsNullOrEmpty(OrderNo))
                {
                    strSQL = @"UPDATE Tbl_Cargo_Order Set AccountNo=@AccountNo Where OrderNo=@OrderNo";
                }
                else
                {
                    strSQL = @"UPDATE Tbl_Cargo_Order Set AccountNo=null Where AccountNo=@AccountNo";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!string.IsNullOrEmpty(OrderNo))
                    {
                        conn.AddInParameter(cmd, "@AccountNo", DbType.String, AccountNo);
                        conn.AddInParameter(cmd, "@OrderNo", DbType.String, OrderNo);
                    }
                    else
                    {
                        conn.AddInParameter(cmd, "@AccountNo", DbType.String, AccountNo);
                    }
                    conn.ExecuteNonQuery(cmd);
                }
            }
        }

        /// <summary>
        /// 删除
        /// </summary>
        /// <param name="entity"></param>
        public void DeleteAccountData(List<CargoAccountEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_Account where AccountNo=@AccountNo ";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@AccountNo", DbType.String, it.AccountNo);
                        conn.ExecuteNonQuery(cmd);
                    }

                    UpdateOrderAccountNo(it.AccountNo, null);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        /// <summary>
        /// 修改物流账单的结算状态
        /// </summary>
        /// <param name="exID"></param>
        /// <param name="CheckStatus"></param>
        public void UpdateAccountCheckStatusByExID(string AccountNo, string CheckStatus)
        {
            try
            {
                string strDel = @"UPDATE Tbl_Cargo_Account SET CheckStatus=@CheckStatus WHERE AccountNo=@AccountNo";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                {
                    conn.AddInParameter(cmdAdd, "@CheckStatus", DbType.String, CheckStatus);
                    conn.AddInParameter(cmdAdd, "@AccountNo", DbType.String, AccountNo);
                    conn.ExecuteNonQuery(cmdAdd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }
        /// <summary>
        /// 修改进货单的结算状态
        /// </summary>
        /// <param name="exID"></param>
        /// <param name="CheckStatus"></param>
        public void UpdatePurchaseOrderCheckStatusByOrderID(string OrderID, string CheckStatus)
        {
            try
            {
                string strDel = @"UPDATE Tbl_Cargo_PurchaseOrder SET CheckStatus=@CheckStatus WHERE OrderID=@OrderID";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                {
                    conn.AddInParameter(cmdAdd, "@CheckStatus", DbType.String, CheckStatus);
                    conn.AddInParameter(cmdAdd, "@OrderID", DbType.String, OrderID);
                    conn.ExecuteNonQuery(cmdAdd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }

        }
        #endregion
        #region 

        /// <summary>
        /// 采购销售查询
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <returns></returns>
        public Hashtable QueryPurSelFeeData(CargoOrderEntity entity)
        {
            List<CargoClientEntity> result = new List<CargoClientEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @"select DISTINCT ROW_NUMBER() OVER (ORDER BY a.TotalCharge DESC) AS RowNumber,isnull(a.HouseID,b.HouseID) HouseID,isnull(a.ClientNum,b.ClientNum) ClientNum, isnull(a.ClientName,b.ClientName) ClientName, isnull(a.Boss,b.Boss) Boss, isnull(a.Cellphone,b.Cellphone) Cellphone, isnull(a.Telephone,b.Telephone) Telephone,isnull(a.Address,b.Address) Address,isnull(a.City,b.City) City,isnull(a.Province,b.Province) Province,isnull(a.UserID,b.UserID) UserID, isnull(a.UserName,b.UserName) UserName, isnull(a.TotalCharge,0) SelFee,isnull((select sum(c.AffectCash+c.AffectCard+c.AffectWX+c.AffectAlipay) as AffectTotal from Tbl_Cargo_FinanceRecord c inner join ( select distinct RecordID from Tbl_Cargo_RecordAwbID a inner join ( select OrderNo from Tbl_Cargo_Order where ClientNum=isnull(a.ClientNum,b.ClientNum)";
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += ")b on a.AffectNo=b.OrderNo)d on c.RecordID=d.RecordID where (c.RevokeType = 0 OR c.RevokeType is NULL) and c.FromTO=0),0)SelAffectTotal, isnull(b.TransportFee,0) PurFee,isnull((select sum(c.AffectCash+c.AffectCard+c.AffectWX+c.AffectAlipay) as AffectTotal from Tbl_Cargo_FinanceRecord c inner join ( select distinct RecordID from Tbl_Cargo_RecordAwbID a inner join ( select OrderID from tbl_cargo_PurchaseOrder where ClientNum=isnull(a.ClientNum,b.ClientNum)";
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += ")b on a.AffectNo=CAST(b.OrderID AS varchar))d on c.RecordID=d.RecordID where (c.RevokeType = 0 OR c.RevokeType is NULL) and c.FromTO=6),0)PurAffectTotal from (select c.HouseID,c.ClientNum,c.ClientName,c.Boss,c.Cellphone,c.Telephone,c.Address,c.City,c.Province,c.UserID,c.UserName,a.TotalCharge from Tbl_Cargo_Client c inner join ( select a.ClientNum,SUM(case a.OrderModel when '0' then a.TotalCharge when '1' then a.TotalCharge*-1 end)as TotalCharge from Tbl_Cargo_Order a where 1=1 ";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID ='" + entity.CargoPermisID + "'"; }
                //客户名称
                if (!string.IsNullOrEmpty(entity.AcceptUnit)) { strSQL += " and a.AcceptUnit ='" + entity.AcceptUnit + "'"; }
                if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum ='" + entity.ClientNum + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " group by a.ClientNum)a on c.ClientNum=a.ClientNum)a full JOIN(SELECT c.HouseID, c.ClientNum, c.ClientName, c.Boss, c.Cellphone, c.Telephone, c.Address, c.City, c.Province, c.UserID, c.UserName, a.TransportFee FROM Tbl_Cargo_Client c INNER JOIN (select ClientNum,sum(case when TrafficType=2 then TransportFee*-1 else TransportFee end)as TransportFee from (select a.ClientNum,ISNULL(sum( InPiece* UnitPrice),sum(a.TotalCharge))as TransportFee,a.TrafficType from Tbl_Cargo_FactoryOrder fo right join(SELECT a.ClientNum, FacOrderNo,a.TrafficType,sum( a.TotalCharge)as TotalCharge FROM tbl_cargo_PurchaseOrder a WHERE 1=1";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID ='" + entity.CargoPermisID + "'"; }
                //客户名称
                if (!string.IsNullOrEmpty(entity.AcceptUnit)) { strSQL += " and a.AcceptUnit ='" + entity.AcceptUnit + "'"; }
                if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum ='" + entity.ClientNum + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " GROUP BY a.ClientNum ,a.FacOrderNo,a.TrafficType)a on a.FacOrderNo=fo.FacOrderNo group by ClientNum,a.TrafficType)a group by ClientNum)a ON c.ClientNum=a.ClientNum)b ON a.ClientNum=b.ClientNum";


                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.Add(new CargoClientEntity
                            {

                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                Address = Convert.ToString(idr["Address"]),
                                Telephone = Convert.ToString(idr["Telephone"]),
                                Boss = Convert.ToString(idr["Boss"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                City = Convert.ToString(idr["City"]),
                                Province = Convert.ToString(idr["Province"]),
                                UserID = Convert.ToString(idr["UserID"]),
                                UserName = Convert.ToString(idr["UserName"]),
                                PurFee = Convert.ToDecimal(idr["PurFee"]),
                                SelAffectTotal = Convert.ToDecimal(idr["SelAffectTotal"]),
                                SelFee = Convert.ToDecimal(idr["SelFee"]),
                                PurAffectTotal = Convert.ToDecimal(idr["PurAffectTotal"]),
                                Weight = Convert.ToDecimal(idr["SelFee"]) - Convert.ToDecimal(idr["SelAffectTotal"]) - Convert.ToDecimal(idr["PurFee"]) + Convert.ToDecimal(idr["PurAffectTotal"])
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        public Hashtable QueryPurSelFeeOrderData(int pIndex, int pNum, CargoOrderEntity entity)
        {
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select DISTINCT ROW_NUMBER() OVER (ORDER BY CreateDate DESC) AS RowNumber,* from (select (case when TrafficType=2 then  '退货单' when TrafficType=3 then '进货单'end)as OrderType,CAST(OrderID as varchar)as OrderNo,Piece,(case when TrafficType=2 then  TransportFee*-1 when TrafficType=3 then TransportFee end)as TransportFee,(case when TrafficType=2 then  TransitFee*-1 when TrafficType=3 then TransitFee end)as TransitFee,(case when TrafficType=2 then  HandFee*-1 when TrafficType=3 then HandFee end)as HandFee,(case when TrafficType=2 then  TotalCharge*-1 when TrafficType=3 then TotalCharge end)as TotalCharge,CreateDate from tbl_cargo_PurchaseOrder where 1=1 ";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and HouseID in (" + entity.CargoPermisID + ")"; }
                //收货单位,人
                if (!entity.ClientNum.Equals(0)) { strSQL += " and ClientNum ='" + entity.ClientNum + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " Union All select (case when OrderModel=0 then '销售单' when OrderModel=1 then '退货单'end)as OrderType,OrderNo,Piece,(case when OrderModel=1 then  TransportFee*-1 when OrderModel=0 then TransportFee end)as TransportFee,(case when OrderModel=1 then  TransitFee*-1 when OrderModel=0 then TransitFee end)as TransitFee,(case when OrderModel=1 then  DeliveryFee*-1 when OrderModel=0 then DeliveryFee end)as DeliveryFee,(case when OrderModel=1 then  TotalCharge*-1 when OrderModel=0 then TotalCharge end)as TotalCharge,CreateDate from Tbl_Cargo_Order where 1=1";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and HouseID in (" + entity.CargoPermisID + ")"; }
                //收货单位,人
                if (!entity.ClientNum.Equals(0)) { strSQL += " and ClientNum ='" + entity.ClientNum + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " )c ";

                strSQL += " ) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1))";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.Add(new CargoOrderEntity
                            {
                                OrderType = Convert.ToString(idr["OrderType"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                TransportFee = Convert.ToDecimal(idr["TransportFee"]),
                                TransitFee = Convert.ToDecimal(idr["TransitFee"]),
                                HandFee = Convert.ToDecimal(idr["HandFee"]),
                                TotalCharge = Convert.ToDecimal(idr["TotalCharge"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"])
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"Select Count(*) as TotalCount from (select '销售单'as OrderType,CAST(OrderID as varchar)as OrderNo,Piece,TransportFee,TransitFee,HandFee,TotalCharge,CreateDate from tbl_cargo_PurchaseOrder where 1=1 ";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and HouseID in (" + entity.CargoPermisID + ")"; }
                //收货单位,人
                if (!entity.ClientNum.Equals(0)) { strCount += " and ClientNum ='" + entity.ClientNum + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strCount += " Union All select '进货单'as OrderType,OrderNo,Piece,TransportFee,TransitFee,DeliveryFee,TotalCharge,CreateDate from Tbl_Cargo_Order where 1=1";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and HouseID in (" + entity.CargoPermisID + ")"; }
                //收货单位,人
                if (!entity.ClientNum.Equals(0)) { strCount += " and ClientNum ='" + entity.ClientNum + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strCount += " )c ";
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        #endregion
        #region 其它业务管理

        public Hashtable QueryFinanceOther(int pIndex, int pNum, FinanceOtherEntity entity)
        {
            List<FinanceOtherEntity> result = new List<FinanceOtherEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select DISTINCT ROW_NUMBER() OVER (ORDER BY a.OP_DATE DESC) AS RowNumber,a.* from Tbl_Cargo_OtherBusiness as a where (1=1)";
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum = '" + entity.ClientNum + "'"; }
                if (!string.IsNullOrEmpty(entity.CheckStatus)) { strSQL += " and a.CheckStatus = '" + entity.CheckStatus + "'"; }
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.HappenDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.HappenDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " ) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1))";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取报销单数据
                            result.Add(new FinanceOtherEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ProjectType = Convert.ToString(idr["ProjectType"]),
                                ProjectCategory = Convert.ToString(idr["ProjectCategory"]),
                                HappenDate = Convert.ToDateTime(idr["HappenDate"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                AcceptUnit = Convert.ToString(idr["AcceptUnit"]),
                                AmountInvolved = Convert.ToDecimal(idr["AmountInvolved"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"])
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"Select Count(distinct a.ID) as TotalCount from Tbl_Cargo_OtherBusiness as a where (1=1)";
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!entity.ClientNum.Equals(0)) { strCount += " and a.ClientNum = '" + entity.ClientNum + "'"; }
                if (!entity.CheckStatus.Equals("-1")) { strCount += " and a.CheckStatus = '" + entity.CheckStatus + "'"; }
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.HappenDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.HappenDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        public void AddFinanceOtherData(FinanceOtherEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_OtherBusiness(HouseID,ProjectType,ProjectCategory,HappenDate,ClientNum,AcceptUnit,AmountInvolved,OP_ID) VALUES (@HouseID,@ProjectType,@ProjectCategory,@HappenDate,@ClientNum,@AcceptUnit,@AmountInvolved,@OP_ID)";
            entity.EnSafe();
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmd, "@ProjectType", DbType.Int32, entity.ProjectType);
                conn.AddInParameter(cmd, "@ProjectCategory", DbType.Int32, entity.ProjectCategory);
                conn.AddInParameter(cmd, "@HappenDate", DbType.DateTime, entity.HappenDate);
                conn.AddInParameter(cmd, "@ClientNum", DbType.String, entity.ClientNum);
                conn.AddInParameter(cmd, "@AcceptUnit", DbType.String, entity.AcceptUnit);
                conn.AddInParameter(cmd, "@AmountInvolved", DbType.Decimal, entity.AmountInvolved);
                conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                conn.ExecuteNonQuery(cmd);
            }
        }
        public void UpdateFinanceOtherData(FinanceOtherEntity entity)
        {

            string strSQL = @"UPDATE Tbl_Cargo_OtherBusiness SET HouseID = @HouseID,ProjectType = @ProjectType,ProjectCategory = @ProjectCategory,HappenDate = @HappenDate,ClientNum = @ClientNum,AcceptUnit = @AcceptUnit,AmountInvolved = @AmountInvolved,OP_ID = @OP_ID,OP_DATE = @OP_DATE WHERE ID=@ID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    conn.AddInParameter(cmd, "@ProjectType", DbType.Int32, entity.ProjectType);
                    conn.AddInParameter(cmd, "@ProjectCategory", DbType.Int32, entity.ProjectCategory);
                    conn.AddInParameter(cmd, "@HappenDate", DbType.DateTime, entity.HappenDate);
                    conn.AddInParameter(cmd, "@ClientNum", DbType.String, entity.ClientNum);
                    conn.AddInParameter(cmd, "@AcceptUnit", DbType.String, entity.AcceptUnit);
                    conn.AddInParameter(cmd, "@AmountInvolved", DbType.Decimal, entity.AmountInvolved);
                    conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                    conn.AddInParameter(cmd, "@ID", DbType.Int32, entity.ID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (ApplicationException ex)
            {
                throw new ApplicationException(ex.Message);
            }
        }
        public List<FinanceOtherEntity> QueryFinanceOtherDataForCash(FinanceOtherEntity entity)
        {
            List<FinanceOtherEntity> result = new List<FinanceOtherEntity>();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string ar = string.Empty;
                string[] arr = entity.IDs.Split(',');
                for (int i = 0; i < arr.Length; i++)
                {
                    if (string.IsNullOrEmpty(arr[i]))
                    {
                        continue;
                    }
                    if (i == arr.Length - 1)
                    {
                        ar += arr[i];
                        break;
                    }
                    ar += arr[i] + ",";
                }

                string strSQL = @"Select a.* from Tbl_Cargo_OtherBusiness as a Where (1=1)";
                if (!string.IsNullOrEmpty(ar)) { strSQL += " and a.ID in (" + ar + ")"; }
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!entity.ClientNum.Equals(0)) { strSQL += " and a.ClientNum = '" + entity.ClientNum + "'"; }
                if (!string.IsNullOrEmpty(entity.ProjectType)) { strSQL += " and a.ProjectType = '" + entity.ProjectType + "'"; }
                if (!string.IsNullOrEmpty(entity.CheckStatus)) { strSQL += " and a.CheckStatus = '" + entity.CheckStatus + "'"; }
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.HappenDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.HappenDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " Order by a.OP_DATE Desc";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            decimal ReceivedMoney = 0.00M;

                            #region 查询已收款
                            if (idr["CheckStatus"].ToString() == "1")
                            {
                                ReceivedMoney = Convert.ToDecimal(idr["AmountInvolved"]);
                            }
                            else
                            {
                                DataTable record = QueryFinanceRecordByNo(Convert.ToString(idr["ID"]), entity.ProjectType.ToString(), "13");
                                if (record != null)
                                {
                                    foreach (DataRow drr in record.Rows)
                                    {
                                        ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                                    }
                                }
                            }
                            #endregion

                            #region 获取运单数据
                            result.Add(new FinanceOtherEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ProjectType = Convert.ToString(idr["ProjectType"]),
                                ProjectCategory = Convert.ToString(idr["ProjectCategory"]),
                                HappenDate = Convert.ToDateTime(idr["HappenDate"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                AcceptUnit = Convert.ToString(idr["AcceptUnit"]),
                                AmountInvolved = Convert.ToDecimal(idr["AmountInvolved"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                ReceivedMoney = ReceivedMoney
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public void UpdateFinanceOtherCheckStatusByID(string ID, string CheckStatus)
        {
            try
            {
                string strDel = @"UPDATE Tbl_Cargo_OtherBusiness SET CheckStatus=@CheckStatus WHERE ID=@ID";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strDel))
                {
                    conn.AddInParameter(cmdAdd, "@CheckStatus", DbType.String, CheckStatus);
                    conn.AddInParameter(cmdAdd, "@ID", DbType.String, ID);
                    conn.ExecuteNonQuery(cmdAdd);
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        public void DeleteFinanceOtherData(List<FinanceOtherEntity> entity)
        {
            try
            {
                foreach (var it in entity)
                {
                    string strSQL = @"Delete from Tbl_Cargo_OtherBusiness where ID=@ID ";

                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@ID", DbType.String, it.ID);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }
        #endregion
        #region 退款审核管理
        /// <summary>
        /// 查询退款审核记录
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryRefundCheckData(int pIndex, int pNum, WXOrderEntity entity)
        {
            List<WXOrderEntity> result = new List<WXOrderEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select ROW_NUMBER() OVER (ORDER BY o.RefundDate DESC) AS RowNumber, co.OrderModel, f.InCargoStatus, co.OrderID, co.OrderNo as CargoOrderNo, h.Name as HouseName, c.Name as ClientName, o.*, co.ShareHouseID, co.ShareHouseName, gg.AwbStatus OpenOrderAwbStatus, co.OpenOrderNo, co.AwbStatus, co.ClientNum, co.CheckOutType,0 as isReserve from Tbl_WX_Order as o inner join Tbl_WX_Client as c on o.WXID = c.ID inner join Tbl_Cargo_House as h on o.HouseID = h.HouseID left join Tbl_Cargo_Order as co on o.OrderNo = co.WXOrderNo and co.OrderModel = 0 left join Tbl_Cargo_FactoryOrder as f on o.FacOrderNo = f.FacOrderNo left join Tbl_Cargo_Order as gg on co.OpenOrderNo is not null and co.OpenOrderNo <> '' and co.OpenOrderNo = gg.OrderNo where (1 = 1)";


                if (!string.IsNullOrEmpty(entity.CargoOrderNo))//仓储订单号
                {
                    strSQL += " and co.OrderNo ='" + entity.CargoOrderNo + "'";
                }
                if (!string.IsNullOrEmpty(entity.OrderNo))//微信订单号
                {
                    strSQL += " and o.OrderNo  like  '%" + entity.OrderNo + "%'";
                }
                if (!string.IsNullOrEmpty(entity.WXPayOrderNo))//微信支付号
                {
                    strSQL += " and o.WXPayOrderNo  like  '%" + entity.WXPayOrderNo + "%'";
                }
                if (!string.IsNullOrEmpty(entity.ClientName))//客户名称
                {
                    strSQL += " and c.Name  like  '%" + entity.ClientName + "%'";
                }
                if (!string.IsNullOrEmpty(entity.CargoPermisID))//所属仓库ID
                {
                    strSQL += "  and o.HouseID in (" + entity.CargoPermisID + ")";
                }
                if (!string.IsNullOrEmpty(entity.RefundReason) && entity.RefundReason != "-1")//退款原因
                {
                    strSQL += " and o.RefundReason=" + entity.RefundReason;
                }
                if (!string.IsNullOrEmpty(Convert.ToString(entity.RefundCheckStatus)) && entity.RefundCheckStatus != "-1")//退款状态
                {
                    strSQL += " and o.RefundCheckStatus=" + entity.RefundCheckStatus;
                }
                //退款提交日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += "  and o.RefundDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += "  and o.RefundDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.PayStatus))//付款状态
                {
                    strSQL += " and o.PayStatus in (" + entity.PayStatus + ")";
                }
                //订单类型
                if (!entity.OrderType.Equals("0"))
                {
                    strSQL += " and o.OrderType = " + entity.OrderType;
                }
                //即日达、次日达
                if (!string.IsNullOrEmpty(entity.ThrowGood))
                {
                    strSQL += " and o.ThrowGood in  (" + entity.ThrowGood + ")";
                }
                strSQL += " ) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1))";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取数据
                            result.Add(new WXOrderEntity
                            {
                                ID = Convert.ToInt32(idr["ID"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                ShareHouseName = string.IsNullOrEmpty(Convert.ToString(idr["ShareHouseName"])) ? "" : Convert.ToString(idr["ShareHouseName"]),
                                OP_DATE = string.IsNullOrEmpty(Convert.ToString(idr["OP_DATE"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["OP_DATE"]),
                                CreateDate = string.IsNullOrEmpty(Convert.ToString(idr["CreateDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["CreateDate"]),
                                RefundDate = string.IsNullOrEmpty(Convert.ToString(idr["RefundDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["RefundDate"]),
                                Piece = string.IsNullOrEmpty(Convert.ToString(idr["Piece"])) ? 0 : Convert.ToInt32(idr["Piece"]),
                                TransitFee = string.IsNullOrEmpty(Convert.ToString(idr["TransitFee"])) ? 0 : Convert.ToDecimal(idr["TransitFee"]),
                                TotalCharge = string.IsNullOrEmpty(Convert.ToString(idr["TotalCharge"])) ? 0 : Convert.ToDecimal(idr["TotalCharge"]),
                                PayStatus = string.IsNullOrEmpty(Convert.ToString(idr["PayStatus"])) ? "0" : Convert.ToString(idr["PayStatus"]),
                                OrderType = string.IsNullOrEmpty(Convert.ToString(idr["OrderType"])) ? "0" : Convert.ToString(idr["OrderType"]),
                                ThrowGood = string.IsNullOrEmpty(Convert.ToString(idr["ThrowGood"])) ? "0" : Convert.ToString(idr["ThrowGood"]),
                                PayWay = string.IsNullOrEmpty(Convert.ToString(idr["PayWay"])) ? "0" : Convert.ToString(idr["PayWay"]),
                                OrderStatus = Convert.ToString(idr["OrderStatus"]),
                                RefundReason = string.IsNullOrEmpty(Convert.ToString(idr["RefundReason"])) ? "" : Convert.ToString(idr["RefundReason"]),
                                RefundMemo = Convert.ToString(idr["RefundMemo"]),
                                RefundCheckID = Convert.ToString(idr["RefundCheckID"]),
                                RefundCheckName = Convert.ToString(idr["RefundCheckName"]),
                                RefundCheckDate = string.IsNullOrEmpty(Convert.ToString(idr["RefundCheckDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["RefundDate"]),
                                WXPayOrderNo = Convert.ToString(idr["WXPayOrderNo"]),
                                Trxid = Convert.ToString(idr["Trxid"]),
                                ClientName = string.IsNullOrEmpty(Convert.ToString(idr["ClientName"])) ? "" : Convert.ToString(idr["ClientName"]),
                                RefundCheckStatus = Convert.ToString(idr["RefundCheckStatus"]),
                                CargoOrderNo = string.IsNullOrEmpty(Convert.ToString(idr["CargoOrderNo"])) ? "" : Convert.ToString(idr["CargoOrderNo"]),
                                OrderID = string.IsNullOrEmpty(Convert.ToString(idr["OrderID"])) ? 0 : Convert.ToInt64(idr["OrderID"]),
                                HouseID = string.IsNullOrEmpty(Convert.ToString(idr["HouseID"])) ? 0 : Convert.ToInt32(idr["HouseID"]),
                                ShareHouseID = string.IsNullOrEmpty(Convert.ToString(idr["ShareHouseID"])) ? 0 : Convert.ToInt32(idr["ShareHouseID"]),
                                ClientNum = string.IsNullOrEmpty(Convert.ToString(idr["ClientNum"])) ? 0 : Convert.ToInt32(idr["ClientNum"]),
                                CheckOutType = string.IsNullOrEmpty(Convert.ToString(idr["CheckOutType"])) ? 0 : Convert.ToInt32(idr["CheckOutType"]),
                                FacOrderNo = string.IsNullOrEmpty(Convert.ToString(idr["FacOrderNo"])) ? "" : Convert.ToString(idr["FacOrderNo"]),
                                InCargoStatus = string.IsNullOrEmpty(Convert.ToString(idr["InCargoStatus"])) ? "" : Convert.ToString(idr["InCargoStatus"]),
                                OpenOrderAwbStatus = string.IsNullOrEmpty(Convert.ToString(idr["OpenOrderAwbStatus"])) ? "" : Convert.ToString(idr["OpenOrderAwbStatus"]),
                                AwbStatus = string.IsNullOrEmpty(Convert.ToString(idr["AwbStatus"])) ? "" : Convert.ToString(idr["AwbStatus"]),
                                OpenOrderNo = string.IsNullOrEmpty(Convert.ToString(idr["OpenOrderNo"])) ? "" : Convert.ToString(idr["OpenOrderNo"]),
                                isReserve = string.IsNullOrEmpty(Convert.ToString(idr["IsReserve"])) ? false : Convert.ToBoolean(idr["IsReserve"]),
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"Select Count(*) as TotalCount from Tbl_WX_Order as o inner join Tbl_WX_Client as c on o.WXID = c.ID   inner join Tbl_Cargo_House as h on o.HouseID = h.HouseID  left join Tbl_Cargo_Order as co on o.OrderNo = co.WXOrderNo and co.OrderModel = 0  left join Tbl_Cargo_FactoryOrder as f on o.FacOrderNo = f.FacOrderNo where (1=1) ";
                if (!string.IsNullOrEmpty(entity.CargoOrderNo))//仓储订单号
                {
                    strCount += " and co.OrderNo='" + entity.CargoOrderNo + "'";
                }
                if (!string.IsNullOrEmpty(entity.OrderNo))//微信订单号
                {
                    strCount += " and o.OrderNo  like  '%" + entity.OrderNo + "%'";
                }
                if (!string.IsNullOrEmpty(entity.WXPayOrderNo))//微信支付号
                {
                    strCount += " and o.WXPayOrderNo  like  '%" + entity.WXPayOrderNo + "%'";
                }
                if (!string.IsNullOrEmpty(entity.ClientName))//客户名称
                {
                    strCount += " and c.Name  like  '%" + entity.ClientName + "%'";
                }
                if (!string.IsNullOrEmpty(entity.CargoPermisID))//所属仓库ID
                {
                    strCount += "  and o.HouseID in (" + entity.CargoPermisID + ")";
                }
                if (!string.IsNullOrEmpty(entity.RefundReason) && entity.RefundReason != "-1")//退款原因
                {
                    strCount += " and o.RefundReason=" + entity.RefundReason;
                }
                if (!string.IsNullOrEmpty(Convert.ToString(entity.RefundCheckStatus)) && entity.RefundCheckStatus != "-1")//退款状态
                {
                    strCount += " and o.RefundCheckStatus=" + entity.RefundCheckStatus;
                }
                //退款提交日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += "  and o.RefundDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += "  and o.RefundDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.PayStatus))//付款状态
                {
                    strCount += " and o.PayStatus in (" + entity.PayStatus + ")";
                }
                if (!entity.OrderType.Equals("0")) //订单类型
                {
                    strCount += " and o.OrderType = " + entity.OrderType;
                }
                if (!string.IsNullOrEmpty(entity.ThrowGood))//即日达、次日达
                {
                    strCount += " and o.ThrowGood in  (" + entity.ThrowGood + ")";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
                #endregion
            }
            catch (Exception ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return resHT;
        }

        /// <summary>
        /// 更新退款审核状态（仅变更已审核状态、及审核时间人）
        /// </summary>
        /// <summary>
        public void UpdateRefundCheckStatus(WXOrderEntity entity)
        {
            string strSQL = @"update Tbl_WX_Order set RefundCheckStatus=@RefundCheckStatus, RefundCheckDate=@RefundCheckDate,RefundCheckName=@RefundCheckName,OP_DATE=@OP_DATE,RefundCheckID=@RefundCheckID where ID =@ID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@RefundCheckID", DbType.String, entity.RefundCheckID);
                    conn.AddInParameter(cmd, "@RefundCheckStatus", DbType.Int32, entity.RefundCheckStatus);
                    conn.AddInParameter(cmd, "@RefundCheckDate", DbType.DateTime, entity.RefundCheckDate);
                    conn.AddInParameter(cmd, "@RefundCheckName", DbType.String, entity.RefundCheckName);
                    conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                    conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (Exception ex)
            {
                throw new ApplicationException(ex.Message);
            }
        }
        /// <summary>
        /// 新增仓储订单退货单（OrderModel=1）
        /// </summary>
        /// <param name="entity"></param>
        public void AddReturnCargoOrder(CargoOrderEntity entity)
        {//, FinanceSecondCheck, FinanceSecondCheckName, FinanceSecondCheckDate
            string strSQL = "Insert into Tbl_Cargo_Order(OrderNo, OrderNum, HAwbNo, LogisAwbNo, LogisID, Dep, Dest, Piece, Weight, Volume, InsuranceFee,TransitFee, TransportFee, DeliveryFee, OtherFee, TotalCharge, Rebate, CheckOutType, TrafficType, DeliveryType, AcceptUnit, AcceptPeople, AcceptTelephone, AcceptCellphone, AcceptAddress, CreateAwb, CreateDate,Signer, SignTime, OP_ID, OP_DATE, AwbStatus, Remark, SaleManID, SaleManName, SaleCellphone, HouseID,CreateAwbID, OrderType, OrderModel,ClientNum, WXOrderNo, ThrowGood, TranHouse, OutHouseName, ModifyPriceStatus, PayClientNum, PayClientName,BelongHouse, IsPrintPrice, AccountNo, PostponeShip, OutCargoTime, DeliverySettlement, OrderAging, PrintNum,PollStatus, PickStatus, LineID, LineName, ShopCode, SuppClientNum,BusinessID";
            if (entity.CheckStatus=="1")
            {
                strSQL += $@", CheckStatus, CheckDate";
            }
            if (entity.FinanceSecondCheck == "1")
            {
                strSQL += $@",FinanceSecondCheck,FinanceSecondCheckName,FinanceSecondCheckDate";
            }
            strSQL += " )(SELECT '" + entity.OrderNo + "', '" + entity.OrderNum + "', B.HAwbNo, B.LogisAwbNo, B.LogisID, B.Dep, B.Dest, @Piece, B.Weight, B.Volume,B.InsuranceFee, B.TransitFee, @TransportFee, B.DeliveryFee, B.OtherFee, @TotalCharge, B.Rebate, B.CheckOutType,B.TrafficType, B.DeliveryType, B.AcceptUnit, B.AcceptPeople, B.AcceptTelephone, B.AcceptCellphone, B.AcceptAddress,'" + entity.CreateAwb + "', getdate(),  B.Signer, B.SignTime, '" + entity.CreateAwbID + "',  getdate(), B.AwbStatus, B.Remark, B.SaleManID, B.SaleManName, B.SaleCellphone, B.HouseID,'" + entity.CreateAwbID + "', B.OrderType, '" + entity.OrderModel + "', B.ClientNum, B.WXOrderNo, '" + entity.ThrowGood + "',B.TranHouse, B.OutHouseName, B.ModifyPriceStatus, B.PayClientNum, B.PayClientName, B.BelongHouse,B.IsPrintPrice, B.AccountNo, B.PostponeShip, B.OutCargoTime, B.DeliverySettlement, B.OrderAging, B.PrintNum,B.PollStatus, B.PickStatus, B.LineID, B.LineName, B.ShopCode, B.SuppClientNum,B.BusinessID ";
            if (entity.CheckStatus == "1")
            {
                strSQL += $@", @CheckStatus, @CheckDate";
            }
            if (entity.FinanceSecondCheck == "1")
            {
                strSQL += $@",@FinanceSecondCheck,@FinanceSecondCheckName,@FinanceSecondCheckDate";
            }
            strSQL +=$@"FROM Tbl_WX_Order AS A INNER JOIN  Tbl_Cargo_Order AS B ON A.OrderNo = B.WXOrderNo INNER JOIN Tbl_Cargo_House AS C ON B.HouseID = C.HouseID WHERE   (B.HouseID =@HouseID) AND (A.WXPayOrderNo =@WXPayOrderNo) )";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@TransportFee", DbType.Decimal, entity.TransportFee);
                conn.AddInParameter(cmd, "@TotalCharge", DbType.Decimal, entity.TotalCharge);
                conn.AddInParameter(cmd, "@Piece", DbType.Int32, entity.Piece);
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmd, "@WXPayOrderNo", DbType.String, entity.WXPayOrderNo);
                if (entity.CheckStatus == "1")
                {
                    conn.AddInParameter(cmd, "@CheckStatus", DbType.Int32, entity.CheckStatus);
                    conn.AddInParameter(cmd, "@CheckDate", DbType.DateTime, entity.CheckDate);
                }
                if (entity.FinanceSecondCheck == "1")
                {
                    conn.AddInParameter(cmd, "@FinanceSecondCheck", DbType.Int32, entity.FinanceSecondCheck);
                    conn.AddInParameter(cmd, "@FinanceSecondCheckName", DbType.String, entity.FinanceSecondCheckName);
                    conn.AddInParameter(cmd, "@FinanceSecondCheckDate", DbType.DateTime, entity.FinanceSecondCheckDate);
                }
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 新增仓储订单退货单（OrderModel=1）2
        /// </summary>
        /// <param name="entity"></param>
        public void AddReturnCargoOrderV2(CargoOrderEntity entity)
        {
            string strSQL = "Insert into Tbl_Cargo_Order(OrderNo, OrderNum, HAwbNo, LogisAwbNo, LogisID, Dep, Dest, Piece, Weight, Volume, InsuranceFee,TransitFee, TransportFee, DeliveryFee, OtherFee, TotalCharge, Rebate, CheckOutType, TrafficType, DeliveryType, AcceptUnit, AcceptPeople, AcceptTelephone, AcceptCellphone, AcceptAddress, CreateAwb, CreateDate,Signer, SignTime, OP_ID, OP_DATE, AwbStatus, Remark, SaleManID, SaleManName, SaleCellphone, HouseID,CreateAwbID, OrderType, OrderModel,ClientNum, WXOrderNo, ThrowGood, TranHouse, OutHouseName, ModifyPriceStatus, PayClientNum, PayClientName,BelongHouse, IsPrintPrice, AccountNo, PostponeShip, OutCargoTime, DeliverySettlement, OrderAging, PrintNum,PollStatus, PickStatus, LineID, LineName, ShopCode, SuppClientNum,BusinessID,IsTransitFee";
            if (entity.CheckStatus == "1")
            {
                strSQL += $@", CheckStatus, CheckDate";
            }
            if (entity.FinanceSecondCheck == "1")
            {
                strSQL += $@",FinanceSecondCheck,FinanceSecondCheckName,FinanceSecondCheckDate";
            }
            strSQL += " )(SELECT '" + entity.OrderNo + "', '" + entity.OrderNum + "', B.HAwbNo, B.LogisAwbNo, B.LogisID, B.Dep, B.Dest, @Piece, B.Weight, B.Volume,B.InsuranceFee, B.TransitFee, @TransportFee, B.DeliveryFee, B.OtherFee, @TotalCharge, B.Rebate, B.CheckOutType,B.TrafficType, B.DeliveryType, B.AcceptUnit, B.AcceptPeople, B.AcceptTelephone, B.AcceptCellphone, B.AcceptAddress,'" + entity.CreateAwb + "', getdate(), B.Signer, B.SignTime, '" + entity.CreateAwbID + "',  getdate(), B.AwbStatus, B.Remark, B.SaleManID, B.SaleManName, B.SaleCellphone, @SHouseID,'" + entity.CreateAwbID + "', B.OrderType, '" + entity.OrderModel + "', B.ClientNum, B.WXOrderNo, '" + entity.ThrowGood + $@"',B.TranHouse, @OutHouseName, B.ModifyPriceStatus, B.PayClientNum, B.PayClientName, B.BelongHouse,B.IsPrintPrice, B.AccountNo, B.PostponeShip, B.OutCargoTime, B.DeliverySettlement, B.OrderAging, B.PrintNum,B.PollStatus, B.PickStatus, B.LineID, B.LineName, B.ShopCode, B.SuppClientNum,B.BusinessID,@IsTransitFee ";
            if (entity.CheckStatus == "1")
            {
                strSQL += $@", @CheckStatus, @CheckDate";
            }
            if (entity.FinanceSecondCheck == "1")
            {
                strSQL += $@",@FinanceSecondCheck,@FinanceSecondCheckName,@FinanceSecondCheckDate ";
            }
            strSQL += $@"FROM Tbl_WX_Order AS A INNER JOIN  Tbl_Cargo_Order AS B ON A.OrderNo = B.WXOrderNo INNER JOIN Tbl_Cargo_House AS C ON B.HouseID = C.HouseID WHERE   (B.HouseID =@HouseID) {(!string.IsNullOrEmpty(entity.WXPayOrderNo) ? "AND (A.WXPayOrderNo =@WXPayOrderNo)" : " AND (A.OrderNo = @WXOrderNo)")} )";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@TransportFee", DbType.Decimal, entity.TransportFee);
                conn.AddInParameter(cmd, "@TotalCharge", DbType.Decimal, entity.TotalCharge);
                conn.AddInParameter(cmd, "@Piece", DbType.Int32, entity.Piece);
                conn.AddInParameter(cmd, "@SHouseID", DbType.Int32, entity.HouseID);
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseIDStr);
                if (!string.IsNullOrEmpty(entity.WXPayOrderNo))
                    conn.AddInParameter(cmd, "@WXPayOrderNo", DbType.String, entity.WXPayOrderNo);
                else
                    conn.AddInParameter(cmd, "@WXOrderNo", DbType.String, entity.WXOrderNo);
                conn.AddInParameter(cmd, "@IsTransitFee", DbType.Int32, entity.IsTransitFee);
                conn.AddInParameter(cmd, "@OutHouseName", DbType.String, entity.OutHouseName);
                if (entity.CheckStatus == "1")
                {
                    conn.AddInParameter(cmd, "@CheckStatus", DbType.Int32, entity.CheckStatus);
                    conn.AddInParameter(cmd, "@CheckDate", DbType.DateTime, entity.CheckDate);
                }
                if (entity.FinanceSecondCheck == "1")
                {
                    conn.AddInParameter(cmd, "@FinanceSecondCheck", DbType.Int32, entity.FinanceSecondCheck);
                    conn.AddInParameter(cmd, "@FinanceSecondCheckName", DbType.String, entity.FinanceSecondCheckName);
                    conn.AddInParameter(cmd, "@FinanceSecondCheckDate", DbType.DateTime, entity.FinanceSecondCheckDate);
                }
                var rsult = conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 撤销申请
        /// </summary>
        /// <summary>
        public void RevokeRefundApply(WXOrderEntity entity)
        {
            string strSQL = @"update Tbl_WX_Order set PayStatus=@PayStatus,RefundMemo=@RefundMemo where ID =@ID";
            try
            {
                entity.EnSafe();
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@PayStatus", DbType.Int32, entity.PayStatus);
                    conn.AddInParameter(cmd, "@RefundMemo", DbType.String, entity.RefundMemo);
                    conn.AddInParameter(cmd, "@ID", DbType.Int64, entity.ID);
                    conn.ExecuteNonQuery(cmd);
                }
            }
            catch (Exception ex)
            {
                throw new ApplicationException(ex.Message);
            }
        }
        #endregion
        #region 余额分账 BILL
        public List<CargoOrderEntity> QueryOrderForBillCash(CargoOrderEntity entity)
        {
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();

            try
            {
                entity.EnSafe();
                string ar = string.Empty;
                string[] arr = entity.OrderNo.Split(',');
                for (int i = 0; i < arr.Length; i++)
                {
                    if (string.IsNullOrEmpty(arr[i])) { continue; }
                    if (i == arr.Length - 1) { ar += arr[i]; break; }
                    ar += arr[i] + "','";
                }
                #region 组装查询SQL语句

                string strSQL = @"SELECT DISTINCT  b.ClientID as AClientID,p.Supplier,p.SuppClientNum,b.ClientNum as AClientNum,g.RelateOrderNo, a.* FROM Tbl_Cargo_OrderGoods AS g LEFT JOIN Tbl_Cargo_Order AS a ON a.OrderNo = g.OrderNo LEFT JOIN Tbl_Cargo_Product AS p ON g.ProductID = p.ProductID LEFT JOIN Tbl_Cargo_Client AS b ON a.SuppClientNum = b.ClientNum LEFT JOIN Tbl_WX_Order AS c ON a.WXOrderNo = c.OrderNo WHERE (1 = 1) ";
                //下单方式
                if (!string.IsNullOrEmpty(entity.AccountNo)) { strSQL += " and a.AccountNo = '" + entity.AccountNo + "'"; }
                if (!string.IsNullOrEmpty(entity.OrderType)) { strSQL += " and a.OrderType = '" + entity.OrderType + "'"; }
                //订单号 
                if (!string.IsNullOrEmpty(ar))
                {
                    //strSQL += " and a.AwbNo = '" + entity.AwbNo.ToUpper() + "'";
                    strSQL += " and a.OrderNo in ('" + ar + "')";
                }
                //收货单位,人
                if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strSQL += " and a.AcceptPeople like'%" + entity.AcceptPeople + "%'"; }
                if (!string.IsNullOrEmpty(entity.PayClientName)) { strSQL += " and a.PayClientName='" + entity.PayClientName + "'"; }
                if (!entity.PayClientNum.Equals(0)) { strSQL += " and a.SuppClientNum=" + entity.PayClientNum; }
                //到达站
                if (!string.IsNullOrEmpty(entity.Dest))
                {
                    string[] ccs = entity.Dest.Split(',');
                    string res = string.Empty;
                    for (int i = 0; i < ccs.Length; i++)
                    {
                        res += ccs[i] + "','";
                    }
                    res = res.Substring(0, res.Length - 3);
                    strSQL += " and a.Dest in ('" + res + "')";
                }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //二审审核状态
                if (!string.IsNullOrEmpty(entity.FinanceSecondCheck))
                {
                    strSQL += " and a.FinanceSecondCheck=" + entity.FinanceSecondCheck + "";
                }
                //结算状态
                if (!string.IsNullOrEmpty(entity.CheckStatus)) { strSQL += " and a.CheckStatus=" + entity.CheckStatus + ""; }
                //订单类型
                if (!string.IsNullOrEmpty(entity.ThrowGood)) { strSQL += " and a.ThrowGood ='" + entity.ThrowGood + "'"; }
                //供应商是否已分账
                if (!entity.IsSupplierType.Equals(-1)) { strSQL += " and a.IsSupplierType=" + entity.IsSupplierType; }
                //仓库是否已分账
                if (!entity.IsHouseType.Equals(-1)) { strSQL += " and a.IsHouseType=" + entity.IsHouseType; }
                //下单方式
                if (!entity.OrderType.Equals(-1)) { strSQL += " and a.OrderType=" + entity.OrderType; }
                strSQL += " Order by a.CreateDate Desc";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            //decimal ReceivedMoney = 0.00M;

                            #region 查询已收款 2022-12-01修改为sql关联查询
                            //if (idr["CheckStatus"].ToString() == "1")
                            //{
                            //    ReceivedMoney = Convert.ToDecimal(idr["TotalCharge"]);
                            //}
                            //else
                            //{
                            //    DataTable record = QueryFinanceRecordByNo(Convert.ToString(idr["OrderNo"]), entity.RType, entity.FromTO);
                            //    if (record != null)
                            //    {
                            //        foreach (DataRow drr in record.Rows)
                            //        {
                            //            ReceivedMoney += Convert.ToDecimal(drr["AffectTotal"]);
                            //        }
                            //    }
                            //}
                            #endregion

                            #region 获取运单数据
                            int a = Convert.ToInt32(idr["AClientID"]);
                            int b = Convert.ToInt32(idr["AClientNum"]);
                            result.Add(new CargoOrderEntity
                            {
                                OrderID = Convert.ToInt64(idr["OrderID"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                Dep = Convert.ToString(idr["Dep"]),
                                Dest = Convert.ToString(idr["Dest"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                ThrowGood = Convert.ToString(idr["ThrowGood"]),
                                InsuranceFee = Convert.ToDecimal(idr["InsuranceFee"]),
                                TransitFee = Convert.ToDecimal(idr["TransitFee"]),
                                TransportFee = Convert.ToDecimal(idr["TransportFee"]),
                                DeliveryFee = Convert.ToDecimal(idr["DeliveryFee"]),
                                OtherFee = Convert.ToDecimal(idr["OtherFee"]),
                                TotalCharge = Convert.ToDecimal(idr["TotalCharge"]),
                                Rebate = Convert.ToDecimal(idr["Rebate"]),
                                CheckOutType = Convert.ToString(idr["CheckOutType"]),
                                TrafficType = Convert.ToString(idr["TrafficType"]),
                                DeliveryType = Convert.ToString(idr["DeliveryType"]),
                                PayClientName = Convert.ToString(idr["PayClientName"]),
                                PayClientNum = Convert.ToInt32(idr["PayClientNum"]),
                                AcceptUnit = Convert.ToString(idr["AcceptUnit"]),
                                AcceptAddress = Convert.ToString(idr["AcceptAddress"]),
                                AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                                AcceptTelephone = Convert.ToString(idr["AcceptTelephone"]),
                                AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                AwbStatus = Convert.ToString(idr["AwbStatus"]),
                                CreateAwb = Convert.ToString(idr["CreateAwb"]),
                                SaleManID = Convert.ToString(idr["SaleManID"]),
                                SaleManName = Convert.ToString(idr["SaleManName"]),
                                OrderType = Convert.ToString(idr["OrderType"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                FinanceSecondCheck = Convert.ToString(idr["FinanceSecondCheck"]),
                                FinanceSecondCheckName = Convert.ToString(idr["FinanceSecondCheckName"]),
                                FinanceSecondCheckDate = string.IsNullOrEmpty(Convert.ToString(idr["FinanceSecondCheckDate"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["FinanceSecondCheckDate"]),

                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                WXOrderNo = Convert.ToString(idr["OrderType"]).Equals("0") || Convert.ToString(idr["OrderType"]).Equals("1") ? "" : Convert.ToString(idr["WXOrderNo"]),

                                CouponType = Convert.ToString(idr["CouponType"]),
                                ClientID = Convert.ToInt32(idr["AClientID"]),
                                ClientNum = Convert.ToInt32(idr["AClientNum"]),
                                SuppClientNum = Convert.ToInt32(idr["SuppClientNum"]),
                                Supplier = Convert.ToString(idr["Supplier"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                OutHouseName = Convert.ToString(idr["OutHouseName"]),
                                //SuppClientNum = Convert.ToInt32(idr["SuppClientNum"]),
                                RelateOrderNo = Convert.ToString(idr["RelateOrderNo"]),
                                OverDueFee = Convert.ToDecimal(idr["OverDueFee"]),
                                IsTransitFee = Convert.ToInt32(idr["IsTransitFee"]),
                                OpenOrderNo = Convert.ToString(idr["OpenOrderNo"]),
                                ShareHouseID = Convert.ToInt32(idr["ShareHouseID"]),
                                //InHousePrice=Convert.ToDecimal(idr["InHousePrice"]),
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }





        #endregion

        public List<CargoSuppClientAccountGoodsEntity> QueryBillOrderByAccountGoods(CargoSuppClientAccountEntity entity)
        {
            List<CargoSuppClientAccountGoodsEntity> result = new List<CargoSuppClientAccountGoodsEntity>();

            try
            {
                #region 组装查询SQL语句

                string strSQL = $@"select  * from Tbl_Cargo_SuppClientAccountGoods where AccountNO='{entity.AccountNO}' ";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            #region 获取账单数据
                            result.Add(new CargoSuppClientAccountGoodsEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                AccountNO = Convert.ToString(idr["AccountNO"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                ProductID = Convert.ToInt32(idr["ProductID"]),
                                Total = Convert.ToDecimal(idr["Total"]),
                                InsuranceFee = Convert.ToInt32(idr["InsuranceFee"]),
                                TransitFee = Convert.ToDecimal(idr["TransitFee"]),
                                DeliveryFee = Convert.ToDecimal(idr["DeliveryFee"]),
                                OverDueFee = Convert.ToDecimal(idr["OverDueFee"]),
                                OutStorageFee = Convert.ToDecimal(idr["OutStorageFee"]),
                                StoReleaseFee = Convert.ToDecimal(idr["StoReleaseFee"]),
                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                OtherExpensesFee = Convert.ToDecimal(idr["OtherExpensesFee"]),
                                OtherFee = Convert.ToDecimal(idr["OtherFee"]),
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        public List<CargoExpenseDetailEntity> GetExpenseDetailList(List<string> ids)
        {
            List<CargoExpenseDetailEntity> result = new List<CargoExpenseDetailEntity>();

            try
            {
                #region 组装查询SQL语句

                string strSQL = $@"
                SELECT a.*, b.FName, c.ZName, d.SName as SSName
                from Tbl_Cargo_ExpenseDetail as a
                         Left Join Tbl_Cargo_FirstSubject as b on a.FID = b.FID
                         left join Tbl_Cargo_ZeroSubject as c on a.ZID = c.ZID
                         left join Tbl_Cargo_SecondSubject as d on a.SID = d.SID
                Where a.ExID in({string.Join(",", ids)})
                ";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            #region 获取账单数据
                            result.Add(new CargoExpenseDetailEntity
                            {
                                ExID = Convert.ToInt64(idr["ExID"]),
                                ZID = Convert.ToInt32(idr["ZID"]),
                                FID = Convert.ToInt32(idr["FID"]),
                                SID = Convert.ToInt32(idr["SID"]),
                                SName = Convert.ToString(idr["SName"]),
                                DetailCharge = Convert.ToDecimal(idr["DetailCharge"]),
                                FName = Convert.ToString(idr["FName"]),
                                ZName = Convert.ToString(idr["ZName"]),
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public Hashtable QueryReturnOrderDetail(WXOrderEntity entity)
        {
            List<CargoReturnOrderEntity> result = new List<CargoReturnOrderEntity>();
            Hashtable hashtable = new Hashtable();
            try
            {
                #region 组装查询SQL语句

                string strSQL = $@"
                 select aa.Piece,aa.OverDayNum,ActSalePrice , a.*,b.Name HouseName,c.ClientName,aa.OverDueFee,aa.ProductID ,d.ProductCode,e.ProductName,d.GoodsCode,d.TypeID,f.TypeName
             ,d.Born,d.Assort ,d.Model,d.Specs ,d.LoadIndex,d.SpeedLevel ,d.Figure,d.Batch ,d.UnitPrice,d.TradePrice ,d.SalePrice,d.InHousePrice
                  ,d.CostPrice,d.TaxCostPrice     ,d.NoTaxCostPrice,d.Supplier,d.SupplierAddress,f.TypeName,ContainerCode,aa.AreaID
              from Tbl_Cargo_Order as a
                  inner join Tbl_Cargo_OrderGoods as aa on a.OrderNo=aa.OrderNo
         inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID
         inner join Tbl_Cargo_Client as c on a.ClientNum=c.ClientNum
         inner join Tbl_Cargo_Product as d on aa.ProductID=d.ProductID
         inner join Tbl_Cargo_ProductSpec as e on d.ProductCode=e.ProductCode
         inner join Tbl_Cargo_ProductType as f on d.TypeID=f.TypeID where WXOrderNo='{entity.OrderNo}' and a.OrderModel=0
                ";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            #region 获取账单数据
                            result.Add(new CargoReturnOrderEntity
                            {
                                OrderID = Convert.ToInt64(idr["OrderID"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                TotalCharge = string.IsNullOrEmpty(idr["TotalCharge"].ToString()) ? 0 : Convert.ToDecimal(idr["TotalCharge"]),
                                TrafficType = Convert.ToString(idr["TrafficType"]),
                                ClientNum = string.IsNullOrEmpty(idr["ClientNum"].ToString()) ? 0 : Convert.ToInt32(idr["ClientNum"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                ThrowGood = Convert.ToString(idr["ThrowGood"]),
                                HouseID = string.IsNullOrEmpty(idr["HouseID"].ToString()) ? 0 : Convert.ToInt32(idr["HouseID"]),
                                AreaID = string.IsNullOrEmpty(idr["AreaID"].ToString()) ? 0 : Convert.ToInt32(idr["AreaID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                ShareHouseID = string.IsNullOrEmpty(idr["ShareHouseID"].ToString()) ? 0 : Convert.ToInt32(idr["ShareHouseID"]),
                                ShareHouseName = Convert.ToString(idr["ShareHouseName"]),
                                ActSalePrice = string.IsNullOrEmpty(idr["ActSalePrice"].ToString()) ? 0 : Convert.ToDecimal(idr["ActSalePrice"]),
                                OverDueFee = string.IsNullOrEmpty(idr["OverDueFee"].ToString()) ? 0 : Convert.ToDecimal(idr["OverDueFee"]),
                                TransitFee = string.IsNullOrEmpty(idr["TransitFee"].ToString()) ? 0 : Convert.ToDecimal(idr["TransitFee"]),
                                OtherFee = string.IsNullOrEmpty(idr["OtherFee"].ToString()) ? 0 : Convert.ToDecimal(idr["OtherFee"]),
                                Born = Convert.ToString(idr["Born"]),
                                Assort = Convert.ToString(idr["Assort"]),
                                Model = Convert.ToString(idr["Model"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                UnitPrice = string.IsNullOrEmpty(idr["UnitPrice"].ToString()) ? 0 : Convert.ToDecimal(idr["UnitPrice"]),
                                TradePrice = string.IsNullOrEmpty(idr["TradePrice"].ToString()) ? 0 : Convert.ToDecimal(idr["TradePrice"]),
                                SalePrice = string.IsNullOrEmpty(idr["SalePrice"].ToString()) ? 0 : Convert.ToDecimal(idr["SalePrice"]),
                                InHousePrice = string.IsNullOrEmpty(idr["InHousePrice"].ToString()) ? 0 : Convert.ToDecimal(idr["InHousePrice"]),
                                CostPrice = string.IsNullOrEmpty(idr["CostPrice"].ToString()) ? 0 : Convert.ToDecimal(idr["CostPrice"]),
                                TaxCostPrice = string.IsNullOrEmpty(idr["TaxCostPrice"].ToString()) ? 0 : Convert.ToDecimal(idr["TaxCostPrice"]),
                                NoTaxCostPrice = string.IsNullOrEmpty(idr["NoTaxCostPrice"].ToString()) ? 0 : Convert.ToDecimal(idr["NoTaxCostPrice"]),
                                Supplier = Convert.ToString(idr["Supplier"]),
                                SupplierAddress = Convert.ToString(idr["SupplierAddress"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                            });
                            #endregion
                        }
                    }
                }
                hashtable["rows"] = result;
                hashtable["total"] = result.Count;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return hashtable;
        }
        public List<CargoOrderEntity> GetOrderInfos(List<string> entity)
        {
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();
            try
            {
                #region 组装查询SQL语句

                string strSQL = $@"
              select b.Piece,b.ActSalePrice,a.* from Tbl_Cargo_Order as a
                       inner join Tbl_Cargo_OrderGoods as b on a.OrderNo=b.OrderNo where OrderID in({string.Join(",", entity)})
                ";

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            #region 获取账单数据
                            result.Add(new CargoOrderEntity
                            {
                                OrderID = Convert.ToInt64(idr["OrderID"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                TransitFee = Convert.ToDecimal(idr["TransitFee"]),
                                InsuranceFee = Convert.ToDecimal(idr["InsuranceFee"]),
                                TotalCharge = Convert.ToDecimal(idr["TotalCharge"]),
                                ActSalePrice = Convert.ToDecimal(idr["ActSalePrice"]),
                                TrafficType = Convert.ToString(idr["TrafficType"]),
                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                ThrowGood = Convert.ToString(idr["ThrowGood"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                ShareHouseID = Convert.ToInt32(idr["ShareHouseID"]),
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        public CargoAreaEntity GetAreaData(int HouseID)
        {
            CargoAreaEntity result = new CargoAreaEntity();
            try
            {
                #region 组装查询SQL语句

                string strSQL = $@"select b.Person,users.LoginName,b.Cellphone,IsCassAutoOrder,  a.* from Tbl_Cargo_Area as a
         inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID
                      left join (select ltrim(rtrim(UserName)) UserName, max(LoginName) LoginName
                          from Tbl_SysUser
                          group by ltrim(rtrim(UserName))) as users on b.Person = users.UserName where a.ParentID=0 and a.HouseID=" + HouseID;

                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dtt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dtt.Rows)
                        {
                            #region 获取账单数据
                            result = new CargoAreaEntity
                            {
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                Name = Convert.ToString(idr["Name"]),
                                Code = Convert.ToString(idr["Code"]),
                                LoginName = Convert.ToString(idr["LoginName"]),
                                Cellphone = Convert.ToString(idr["Cellphone"]),
                                Person = Convert.ToString(idr["Person"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                IsCassAutoOrder = Convert.ToInt32(idr["IsCassAutoOrder"]),
                            };
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }


        #region 预订单

        /// <summary>
        /// 出纳收款保存
        /// </summary>
        public void SaveCash_Advance(CargoCashierEntity awb)
        {
            CargoOrderManager order = new CargoOrderManager();
            CargoCashierEntity card = new CargoCashierEntity();
            CargoCashierEntity cash = new CargoCashierEntity();
            CargoCashierEntity wx = new CargoCashierEntity();
            CargoCashierEntity ali = new CargoCashierEntity();
            try
            {
                awb.EnSafe();
                //微信
                if (awb.AffectWX != 0)
                {
                    CargoFinanceBasicDataEntity cashEnt = GetFinanceBasicDataByID(awb.WxID);
                    wx.BeforeMoney = cashEnt.OverMoney;
                    wx.BasicID = cashEnt.BasicID;
                    wx.AffectWX = awb.AffectWX;
                    wx.RType = awb.RType;
                    wx.OP_ID = awb.OP_ID;
                    wx.FromTO = awb.FromTO;
                    wx.Memo = awb.Memo;
                    wx.AffectAwbNO = awb.AffectAwbNO;
                    wx.AffectClient = awb.AffectClient;
                    wx.UserName = awb.UserName;
                    wx.TradeType = string.IsNullOrEmpty(awb.TradeType) ? "0" : awb.TradeType;
                    wx.WxOrderNo = awb.WxOrderNo;
                }
                #region 收款  付款
                if (awb.FromTO == "0" || awb.FromTO == "2" || awb.FromTO == "5" || awb.FromTO == "8" || awb.FromTO == "13")
                {
                    //4.修改微信账户上的余额收款
                    if (awb.AffectWX != 0)
                    {
                        UpdateCardOverMoney(wx.AffectWX, wx.BasicID, "0");
                        wx.OverMoney = wx.BeforeMoney + awb.AffectWX;
                    }
                }

                #endregion

                long bankID = 0;
                long cashID = 0;
                long wxID = 0;
                long aliID = 0;
                //5.增加出纳详细记录表，银行卡，现金和微信支付宝账户
                if (awb.AffectWX != 0)
                {
                    wxID = AddCardInfo(wx);
                }
                if (!string.IsNullOrEmpty(awb.OldFromTO))
                {
                    UpdateRecordToRevoke(awb.RecordID, 1);
                    awb.FromTO = awb.OldFromTO;
                }
                switch (awb.FromTO)
                {
                    case "0":
                        //6.修改受影响的运单状态为已结算状态
                        foreach (var it in awb.OrderNo)
                        {
                            //order.UpdateCheckStatusByOrderNo(it, awb.CheckStatus);
                            if (!wxID.Equals(0))
                            {
                                AddRecordAwbID(wxID, it.ToString());
                                //新增预订单支付信息
                                AddReservePaymentRecord(new CargoReserveOrderPaymentRecordEntity { OrderNo = awb.CargoOrderNo, WXPayOrderNo = awb.WXPayOrderNo, WxOrderNo = awb.WxOrderNo, PaymentType = Convert.ToInt32(awb.PaymentType), Trxid = awb.Trxid, OP_ID = awb.OP_ID, PaymentAmount = awb.AffectWX });
                                // 回写预订单金额
                                UpdateReserveTotal(new CargoReserveOrderPaymentRecordEntity { OrderNo = awb.CargoOrderNo,WxOrderNo = awb.WxOrderNo });
                            }
                        }
                        break;
                    default:
                        break;
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
        }

        #endregion

        #region 预订单

        /// <summary>
        /// 新增预订单 支付明细 数据
        /// </summary>
        /// <param name="recordID"></param>
        /// <param name="awbID"></param>
        public void AddReservePaymentRecord(CargoReserveOrderPaymentRecordEntity entity)
        {
            string strSQL = @"INSERT INTO Tbl_Cargo_ReserveOrderPaymentRecord(ORDERNO, WxOrderNo, WXPAYORDERNO, PaymentType, TRXID, OP_ID, OP_DATE,PaymentAmount) 
                                VALUES (@ORDERNO, @WxOrderNo, @WXPAYORDERNO, @PaymentType, @TRXID, @OP_ID, @OP_DATE,@PaymentAmount)";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@ORDERNO", DbType.String, entity.OrderNo);
                conn.AddInParameter(cmd, "@WxOrderNo", DbType.String, entity.WxOrderNo);
                conn.AddInParameter(cmd, "@WXPAYORDERNO", DbType.String, entity.WXPayOrderNo);
                conn.AddInParameter(cmd, "@PaymentType", DbType.Int32, entity.PaymentType);
                conn.AddInParameter(cmd, "@TRXID", DbType.String, entity.Trxid);
                conn.AddInParameter(cmd, "@OP_ID", DbType.String, entity.OP_ID);
                conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                conn.AddInParameter(cmd, "@PaymentAmount", DbType.Decimal, entity.PaymentAmount);

                conn.ExecuteNonQuery(cmd);
            }
        }

        /// <summary>
        /// 回写预订单金额
        /// </summary>
        /// <param name="recordID"></param>
        /// <param name="awbID"></param>
        public void UpdateReserveTotal(CargoReserveOrderPaymentRecordEntity entity)
        {
            string strSQL = $@";update a set TotalCharge=(select sum(isnull(re.PaymentAmount,0)) as PaymentAmount from Tbl_Cargo_ReserveOrderPaymentRecord as re where a.OrderNo=re.OrderNo and a.WXOrderNo=re.WxOrderNo) from Tbl_Cargo_ReserveOrder as a where OrderNo=@OrderNo
;update a set TotalCharge=(select sum(isnull(re.PaymentAmount,0)) as PaymentAmount from Tbl_Cargo_ReserveOrderPaymentRecord as re where a.OrderNo=re.WxOrderNo) from Tbl_WX_Order as a where OrderNo=@WxOrderNo";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@OrderNo", DbType.String, entity.OrderNo);
                conn.AddInParameter(cmd, "@WxOrderNo", DbType.String, entity.WxOrderNo);

                conn.ExecuteNonQuery(cmd);
            }
        }

        #endregion
    }
}
