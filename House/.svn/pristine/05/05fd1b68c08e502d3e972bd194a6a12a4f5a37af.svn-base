using ClosedXML.Excel;
using House.Business;
using House.Business.Cargo;
using House.Business.Log;
using House.Entity;
using House.Entity.Cargo;
using House.Entity.Cargo.House;
using House.Entity.Cargo.Interface;
using House.Entity.Cargo.Product;
using House.Entity.Dto.Tuhu;
using HouseServices.Common;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using Senparc.Weixin.Annotations;
using Senparc.Weixin.HttpUtility;
using Senparc.Weixin.MP.AdvancedAPIs.MerChant;
using Senparc.Weixin.MP.AdvancedAPIs.TemplateMessage;
using Senparc.Weixin.MP.Entities;
using Senparc.Weixin.MP.TenPayLibV3;
using Senparc.Weixin.QY.AdvancedAPIs;
using Senparc.Weixin.QY.CommonAPIs;
using StackExchange.Redis;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Configuration;
using System.Data;
using System.Diagnostics;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.Mime;
using System.Net.Security;
using System.Runtime.CompilerServices;
using System.Runtime.Remoting.Contexts;
using System.Security.Cryptography;
using System.Security.Policy;
using System.ServiceModel;
using System.ServiceProcess;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Timers;
using System.Web;
using System.Web.Script.Serialization;
using System.Windows.Forms;
using static System.Windows.Forms.VisualStyles.VisualStyleElement;
using static System.Windows.Forms.VisualStyles.VisualStyleElement.Tab;

namespace HouseServices
{
    public partial class Service1 : ServiceBase
    {
        public string RobotID = Convert.ToString(ConfigurationSettings.AppSettings["RobotID"]);
        public string RobotName = Convert.ToString(ConfigurationSettings.AppSettings["RobotName"]);
        public string KD100_Key = Convert.ToString(ConfigurationSettings.AppSettings["KD100_Key"]);
        public string KD100_PollAddress = Convert.ToString(ConfigurationSettings.AppSettings["KD100_PollAddress"]);
        public Service1()
        {
            InitializeComponent();

            TuhuSync tuhuSync = new TuhuSync();
            tuhuSync.TuhuFullSync();
            return;

            System.Timers.Timer time = new System.Timers.Timer();
            System.Timers.Timer snapTime = new System.Timers.Timer();
            System.Timers.Timer pushFiveTime = new System.Timers.Timer();
            System.Timers.Timer mallClientTime = new System.Timers.Timer();
            System.Timers.Timer ContiTime = new System.Timers.Timer();
            System.Timers.Timer checkinTime = new System.Timers.Timer();
            System.Timers.Timer OrderPushTime = new System.Timers.Timer();
            System.Timers.Timer ContiOrderPushTime = new System.Timers.Timer();
            System.Timers.Timer PushNextDatTime = new System.Timers.Timer();
            System.Timers.Timer RemoveOrderQuotaTime = new System.Timers.Timer();
            System.Timers.Timer AutomaticAvoidance = new System.Timers.Timer();
            System.Timers.Timer SalePieceStaticTime = new System.Timers.Timer();
            System.Timers.Timer TuhuFullSyncTime = new System.Timers.Timer();
            System.Timers.Timer TuhuIncrementalSyncTime = new System.Timers.Timer();

            //马牌订单和库存同步接口定时器
            ContiTime.Elapsed += ContiTime_Elapsed;
            ContiTime.Interval = 1000 * 60 * 10;//10分钟跳动一下
            ContiTime.Enabled = true;

            time.Elapsed += time_Elapsed;
            time.Interval = 60 * 60 * 1000;//每一小时跳动一下
            //time.Interval = 5 * 60 * 1000;//每一小时跳动一下
            time.Enabled = true;

            snapTime.Elapsed += snapTime_Elapsed;
            snapTime.Interval = 20 * 60 * 1000;//10分钟跳动一次
            snapTime.Enabled = true;

            //订单推送到新陆程和好来运的定时作业
            pushFiveTime.Elapsed += pushFiveTime_Elapsed;
            pushFiveTime.Interval = 5 * 60 * 1000;//5分钟跳动一次
            pushFiveTime.Enabled = true;

            //处理商城客户订单是否结清，额度付款是否冻结
            mallClientTime.Elapsed += mallClientTime_Elapsed;
            mallClientTime.Interval = 60 * 60 * 1000;//1小时跳动一次
            mallClientTime.Enabled = true;
            //订单推送的定时程序
            OrderPushTime.Elapsed += OrderPushTime_Elapsed;
            OrderPushTime.Interval = 60 * 1000;//1分钟跳动一次
            OrderPushTime.Enabled = true;

            //定时删除小程序下单十分钟未付款订单  马牌订单同步
            ContiOrderPushTime.Elapsed += RemoveTimeoutUnpaidOrder_Elapsed;
            ContiOrderPushTime.Interval = 60 * 1000;//1分钟跳动一次
            ContiOrderPushTime.Enabled = true;

            ////同步考勤数据
            //checkinTime.Elapsed += SyncCheckinTime_Elapsed;
            //checkinTime.Interval = 60 * 60 * 1000;//1小时跳动一次
            //checkinTime.Enabled = true;

            //每月清零优惠额度 慧采共享仓库库存同步
            checkinTime.Elapsed += ClearClentQuotaTime_Elapsed;
            checkinTime.Interval = 60 * 60 * 1000;//1小时跳动一次
            checkinTime.Enabled = true;

            //慧采云仓共享仓库订单定时生成
            RemoveOrderQuotaTime.Elapsed += RemoveOrderQuotaTime_Elapsed;
            RemoveOrderQuotaTime.Interval = 60 * 1000;//1分钟跳动一次
            RemoveOrderQuotaTime.Enabled = true;

            /////每日0点定时推送数据至开思平台
            //PushStockTime.Elapsed += PushStock_Elapsed;
            //PushStockTime.Interval = 60 * 60 * 1000 * 2;//4小时跳动一次
            //PushStockTime.Enabled = true;

            ///每日0点定时推送数据至开思平台每小时删除锦湖开单72小时为付款订单
            PushNextDatTime.Elapsed += PushNextData_Elapsed;
            PushNextDatTime.Interval = 60 * 60 * 1000;//1小时跳动一次
            PushNextDatTime.Enabled = true;

            ///优惠卷失效
            AutomaticAvoidance.Elapsed += AutomaticAvoidance_Elapsed;
            AutomaticAvoidance.Interval = 60 * 60 * 1000;//1小时跳动一次
            AutomaticAvoidance.Enabled = true;

            //每月和每日销量 生成静态化销量数据
            SalePieceStaticTime.Elapsed += GenerateDailySalesSnapshot;
            SalePieceStaticTime.Elapsed += GenerateMonthlySalesSnapshot;
            SalePieceStaticTime.Interval = 60 * 60 * 1000 * 1;//1小时跳动一次
            SalePieceStaticTime.Enabled = true;

            //途虎商品同步
            TuhuIncrementalSyncTime.Elapsed += TuhuFullSync_Task; //增量同步
            TuhuIncrementalSyncTime.Interval = 60 * 1000 * 5;//5分钟跳动一次
            TuhuIncrementalSyncTime.Enabled = true;
            TuhuFullSyncTime.Elapsed += TuhuIncrementalSync_Task; //全量同步
            TuhuFullSyncTime.Interval = 60 * 60 * 1000;//1小时跳动一次
            TuhuFullSyncTime.Enabled = true;
        }


        /// <summary>
        /// 1.删除超时未付款订单
        /// 2.同步订单出库标签数据至马牌系统
        /// 3.获取马牌系统订单同步仓储系统
        /// 4.获取马牌出库订单数据更新出库CKD订单号
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        void RemoveTimeoutUnpaidOrder_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            CargoInterfaceBus nwBus = new CargoInterfaceBus();
            CargoHouseBus houseBus = new CargoHouseBus();
            CargoClientBus clientBus = new CargoClientBus();
            CargoOrderBus bus = new CargoOrderBus();
            #region 定时作废超过10分钟未付款云仓订单
            try
            {
                LogEntity log = new LogEntity();
                log.IPAddress = "";
                log.Moudle = "服务管理";
                log.Status = "0";
                log.NvgPage = "定时作废超过10分钟未付款订单";
                log.UserID = RobotID;
                log.Operate = "D";
                List<CargoOrderEntity> orderList = bus.QueryWxOrderDataInfo(new CargoOrderEntity { BelongHouse = "6", PayStatus = "0", CheckOutType = "5", CreateDate = DateTime.Now.AddMinutes(-10), StartDate = DateTime.Now, EndDate = DateTime.Now });
                List<CargoOrderEntity> list = new List<CargoOrderEntity>();
                foreach (CargoOrderEntity item in orderList)
                {
                    list.Add(new CargoOrderEntity
                    {
                        OrderID = item.OrderID,
                        OrderNo = item.OrderNo,
                        Dep = item.Dep,
                        Dest = item.Dest,
                        Piece = item.Piece,
                        TransportFee = item.TransportFee,
                        TransitFee = item.TransitFee,
                        DeliveryFee = item.DeliveryFee,
                        InsuranceFee = item.InsuranceFee,
                        OtherFee = item.OtherFee,
                        TotalCharge = item.TotalCharge,
                        AcceptUnit = item.AcceptUnit,
                        AcceptPeople = item.AcceptPeople,
                        AcceptTelephone = item.AcceptTelephone,
                        AcceptCellphone = item.AcceptCellphone,
                        AcceptAddress = item.AcceptAddress,
                        SaleManName = item.SaleManName,
                        CreateAwb = item.CreateAwb,
                        CreateAwbID = item.CreateAwbID,
                        CreateDate = item.CreateDate,
                        LogisAwbNo = item.LogisAwbNo,
                        LogisticName = item.LogisticName,
                        WXOrderNo = item.WXOrderNo,
                        OutHouseName = item.OutHouseName,
                        Remark = item.Remark,
                        ThrowGood = item.ThrowGood,
                        HouseID = item.HouseID,
                        TrafficType = item.TrafficType,
                        DeleteID = RobotID,
                        DeleteName = RobotName,
                        PayClientNum = item.PayClientNum,
                        CheckStatus = item.CheckStatus,
                    });

                    //仓库同步缓存
                    CargoHouseBus house = new CargoHouseBus();
                    List<CargoProductEntity> syncProduct = house.SyncTypeOrderNo(item.OrderNo);
                    foreach (CargoProductEntity product in syncProduct)
                    {

                        if (product.SyncType == "2" || (product.SyncType == "1" && product.TypeID == 34))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + product.HouseID + "_" + product.TypeID + "_" + product.ProductCode + "", product.GoodsCode);
                        }
                    }
                }

                bus.DeleteOrderInfo(list, log);

                foreach (var it in list)
                {
                    bus.UpdateCargoOrderPush(new CargoOrderPushEntity { OrderNo = it.OrderNo, PushType = "2", PushStatus = "0", Dest = it.Dest, Piece = it.Piece, AcceptUnit = it.AcceptUnit, AcceptAddress = it.AcceptAddress, AcceptPeople = it.AcceptPeople, AcceptTelephone = it.AcceptTelephone, AcceptCellphone = it.AcceptCellphone, ClientNum = it.ClientNum.ToString(), LogisID = it.LogisID }, log);
                }
            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("定时作废超过10分钟未付款订单失败，错误信息" + ex.Message);
            }
            #endregion

            #region 同步订单出库标签数据至马牌系统
            try
            {
                //机器人账号
                LogEntity log = new LogEntity();
                log.IPAddress = "";
                log.Moudle = "服务管理";
                log.Status = "0";
                log.NvgPage = "马牌订单出库同步";
                log.UserID = RobotID;
                log.Operate = "A";

                saleOpenInfoResp mapai = new saleOpenInfoResp();
                //mapai.HouseIDStr = "9,45,84,83,91,93,95,97,101";
                mapai.StartDate = DateTime.Now.AddDays(-5);
                mapai.InCreateStatus = "1";
                mapai.IsPushOutTag = "0";
                //List<saleOpenInfoResp> infoResps = new List<saleOpenInfoResp>();
                List<saleOpenInfoResp> infoResps = nwBus.QueryContiOutOrderInfo(mapai);
                if (infoResps.Count > 0)
                {
                    LogHelper.WriteLog("出库标签数据开始同步");
                    foreach (var res in infoResps)
                    {
                        //if (res.CargoOrderNo != "LH240702004"){continue;}
                        OutOrderStatus outOrder = new OutOrderStatus();
                        outOrder.doNo = res.doNo;
                        outOrder.deliveryType = 4;
                        outOrder.contractName = res.SaleManName;
                        outOrder.contractMobile = res.SaleCellphone;
                        //if (res.PayClientName.Contains("京东2024"))
                        //{
                        //    //判断是否是京东客户订单，并同时判断是否填写快递名称和快递单号，如果其中有一个为空，则跳过
                        //    if (string.IsNullOrEmpty(res.OpenExpressName) || string.IsNullOrEmpty(res.OpenExpressNum))
                        //    {
                        //        continue;
                        //    }
                        //    outOrder.deliveryType = 3;
                        //    outOrder.logisticsCompany = res.OpenExpressName;
                        //    outOrder.logisticsNo = res.OpenExpressNum;
                        //}
                        //else
                        //{
                        //    outOrder.deliveryType = 4;
                        //    outOrder.contractName = res.SaleManName;
                        //    outOrder.contractMobile = res.SaleCellphone;
                        //}

                        List<OutDetail> outs = new List<OutDetail>();
                        List<CargoProductTagEntity> result = nwBus.QueryContiOutOrderDetail(new saleOpenInfoResp { CargoOrderNo = res.CargoOrderNo });
                        if (result.Count > 0)
                        {
                            var groupedItems = result.GroupBy(item => item.GoodsCode).Select(group => new { GoodsCode = group.Key, Count = group.Count() });
                            var keysCount = groupedItems.Sum(a => a.Count);
                            if (keysCount != res.OrderPiece) continue;
                            foreach (var group in groupedItems)
                            {
                                OutDetail outD = new OutDetail();
                                outD.outNum = group.Count;
                                outD.skuCode = group.GoodsCode.Substring(0, 7);

                                List<BarCodeEntity> barCodeEntities = new List<BarCodeEntity>();
                                List<CargoProductTagEntity> cpt = result.Where(c => c.GoodsCode == group.GoodsCode).ToList();
                                foreach (var cp in cpt)
                                {
                                    barCodeEntities.Add(new BarCodeEntity
                                    {
                                        barCode = cp.TyreCode,
                                        dot = cp.Batch,
                                        scanTime = cp.OutCargoTime.ToString("yyyy-MM-dd HH:mm:ss")
                                    });
                                }
                                outD.barCodeList = barCodeEntities;
                                outs.Add(outD);
                            }
                        }
                        if (outs.Count <= 0)
                        {
                            continue;
                        }
                        outOrder.doDetails = outs;

                        //处理Json推送到马牌系统
                        string postJson = JsonConvert.SerializeObject(outOrder);
                        string contiUrl = "https://cdms.continental-tires.cn/api/openapi/out/sync";
                        string oks = wxHttpUtility.ContiSendPostHttpRequest(contiUrl, "application/json", postJson);
                        if (oks.Contains("10000"))
                        {
                            //成功
                            LogHelper.WriteLog(res.orderCode + "出库标签同步成功");
                            nwBus.UpdateContiOutOrderPushStatus(new saleOpenInfoResp { IsPushOutTag = "1", orderCode = res.orderCode }, log);
                        }
                        else if (oks.Contains("10025"))
                        {
                            LogHelper.WriteLog(res.orderCode + oks);
                            nwBus.UpdateContiOutOrderPushStatus(new saleOpenInfoResp { IsPushOutTag = "1", orderCode = res.orderCode }, log);
                        }
                        else
                        {
                            LogHelper.WriteLog(res.orderCode + "出库标签同步失败：" + oks);
                        }

                    }
                }

            }
            catch (ApplicationException ex)
            {
                LogHelper.WriteLog("同步订单出库标签数据至马牌系统失败");
            }

            #endregion

            #region 获取广州马牌系统订单同步仓储系统
            try
            {
                //机器人账号
                LogEntity log = new LogEntity();
                log.IPAddress = "";
                log.Moudle = "服务管理";
                log.Status = "0";
                log.NvgPage = "定单推送服务";
                log.UserID = RobotID;
                log.Operate = "A";
                string contiUrl = GetContiUrl() + GetContiOrderSync();
                //取最新一条同步数据
                saleOrderStatusOpenQueryResp queryResp = nwBus.QuerySaleOrderStatusOpenData(new saleOrderStatusOpenQueryResp { companyId = 113757 });
                string body = "{\"updateTime\": \"" + queryResp.nextUpdateTime + "\",	\"orderStatus\": [30,40],	\"distributorSoldTo\": \"\",\"size\": 30}";
                string contistr = wxHttpUtility.ContiSendPostHttpRequest(contiUrl, "application/json", body);
                ContiOrderEntity contiOrder = JsonConvert.DeserializeObject<ContiOrderEntity>(contistr);

                List<saleOpenInfoResp> conti = new List<saleOpenInfoResp>();
                if (contiOrder.code.Equals(10000))
                {
                    //销售订单主表数据 配置区域,客户等字段
                    if (contiOrder.data.saleOpenInfoResp.Count > 0)
                    {
                        foreach (var saleorder in contiOrder.data.saleOpenInfoResp)
                        {
                            if (!saleorder.orderType.Equals("1") && !saleorder.orderType.Equals("3") && !saleorder.orderType.Equals("6") && !saleorder.orderType.Equals("4"))
                            {
                                // 1   普通订单 3   调拨订单 6   NA订单  4   加急配送订单 5   长尾订单 7   resell订单
                                continue;
                            }
                            //1. 根据仓库代码查询该仓库的库存并生成该仓库订单
                            //2. 根据客户编码查询客户数据是否存在，不存在新增。
                            //saleorder.customerCode
                            //saleorder.warehouseCode
                            if (string.IsNullOrEmpty(saleorder.warehouseCode))
                            {
                                //写日志 没有出库仓库。
                                LogHelper.WriteLog(saleorder.orderCode + " " + saleorder.warehouseName + "无出库仓库");
                                continue;
                            }
                            //获取马牌仓库区域
                            CargoAreaEntity areaEntity = houseBus.QueryHouseByDeliveryArea(new CargoAreaEntity { ContiHouseCode = saleorder.warehouseCode });
                            if (areaEntity.AreaID.Equals(0))
                            {
                                //写日志 没有配置仓库
                                LogHelper.WriteLog(saleorder.orderCode + " " + saleorder.warehouseName + "无配置出库仓库");
                                continue;
                            }
                            //获取客户信息
                            List<CargoClientEntity> clientEntities = clientBus.QueryCargoClientList(new CargoClientEntity { TryeClientCode = saleorder.customerCode, DelFlag = "0", HouseIDStr = "" });
                            if (clientEntities.Count > 0)
                            {
                                saleorder.BidClientNum = clientEntities[0].ClientNum;
                                saleorder.BidClientName = clientEntities[0].ClientName;
                            }
                            saleorder.AreaID = areaEntity.AreaID;
                            saleorder.HouseID = areaEntity.HouseID;
                            saleorder.InCreateStatus = "0";
                            saleorder.OrderPiece = saleorder.saleSkuOpenInfoResp.Sum(c => c.skuNum);
                            saleorder.freightAmount = string.IsNullOrEmpty(saleorder.freightAmount) ? "0" : saleorder.freightAmount;
                            //优惠券金额明细
                            if (saleorder.saleOpenPromotionAmountList.Count > 0)
                            {
                                //couponAmount:优惠券总金额
                                saleorder.couponAmount = saleorder.saleOpenPromotionAmountList[0].couponAmount;
                            }
                            conti.Add(saleorder);
                        }
                    }
                    //Tbl_Cargo_ContiOrder 创建马牌订单数据
                    nwBus.AddContiSaleOrderInfo(conti, log);
                    //Tbl_Cargo_ContiOrderPush 更新 马牌出库单数据同步表
                    nwBus.AddContiOrderPushInfo(new saleOrderStatusOpenQueryResp { currentUpdateTime = contiOrder.data.saleOrderStatusOpenQueryResp.currentUpdateTime, companyId = contiOrder.data.saleOrderStatusOpenQueryResp.companyId, tenantId = contiOrder.data.saleOrderStatusOpenQueryResp.tenantId, nextUpdateTime = contiOrder.data.saleOrderStatusOpenQueryResp.nextUpdateTime, ResJson = contistr }, log);
                }
            }
            catch (ApplicationException ex)
            {
                LogHelper.WriteLog("同步马牌订单数据出错" + ex.Message);
            }
            #endregion

            #region 获取马牌出库订单数据更新出库CKD订单号
            try
            {
                //机器人账号
                LogEntity log = new LogEntity();
                log.IPAddress = "";
                log.Moudle = "服务管理";
                log.Status = "0";
                log.NvgPage = "马牌定时服务";
                log.UserID = RobotID;
                log.Operate = "A";

                string contiOutUrl = GetContiUrl() + GetContiOutHouseOrderSync();
                string outbody = "{\"updateStartTime\": \"" + DateTime.Now.AddMinutes(-5).ToString("yyyy-MM-dd HH:mm:ss") + "\",	\"updateEndTime\": \"" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "\",	\"pageNum\": 1,\"pageSize\": 100}";
                string contistr = wxHttpUtility.ContiSendPostHttpRequest(contiOutUrl, "application/json", outbody);
                //LogHelper.WriteLog("获取马牌出库订单成功：" + contistr);
                contiOutOrderEntity contiOrder = JsonConvert.DeserializeObject<contiOutOrderEntity>(contistr);
                if (contiOrder.code.Equals(10000))
                {
                    nwBus.UpdateContiOrderOutData(contiOrder.data.list, log);
                }
            }
            catch (ApplicationException ex)
            {
                LogHelper.WriteLog("获取马牌出库订单失败");
            }

            #endregion

            #region 获取湖北马牌系统订单同步仓储系统
            try
            {
                //机器人账号
                LogEntity log = new LogEntity();
                log.IPAddress = "";
                log.Moudle = "服务管理";
                log.Status = "0";
                log.NvgPage = "定单推送服务";
                log.UserID = RobotID;
                log.Operate = "A";
                string contiUrl = GetContiUrl() + GetContiOrderSync();
                //取最新一条同步数据
                saleOrderStatusOpenQueryResp queryResp = nwBus.QuerySaleOrderStatusOpenData(new saleOrderStatusOpenQueryResp { companyId = 254592 });
                string nut = string.IsNullOrEmpty(queryResp.nextUpdateTime) ? DateTime.Now.AddHours(-1).ToString("yyyy-MM-dd HH:mm:ss") : queryResp.nextUpdateTime;
                string body = "{\"updateTime\": \"" + nut + "\",	\"orderStatus\": [30,40],	\"distributorSoldTo\": \"\",\"size\": 30}";
                string contistr = wxHttpUtility.HuBeiContiSendPostHttpRequest(contiUrl, "application/json", body);
                ContiOrderEntity contiOrder = JsonConvert.DeserializeObject<ContiOrderEntity>(contistr);

                List<saleOpenInfoResp> conti = new List<saleOpenInfoResp>();
                if (contiOrder.code.Equals(10000))
                {
                    //销售订单主表数据 配置区域,客户等字段
                    if (contiOrder.data.saleOpenInfoResp.Count > 0)
                    {
                        foreach (var saleorder in contiOrder.data.saleOpenInfoResp)
                        {
                            if (!saleorder.orderType.Equals("1") && !saleorder.orderType.Equals("3") && !saleorder.orderType.Equals("6") && !saleorder.orderType.Equals("4"))
                            {
                                // 1   普通订单 3   调拨订单 6   NA订单  4   加急配送订单 5   长尾订单 7   resell订单
                                continue;
                            }
                            //1. 根据仓库代码查询该仓库的库存并生成该仓库订单
                            //2. 根据客户编码查询客户数据是否存在，不存在新增。
                            //saleorder.customerCode
                            //saleorder.warehouseCode
                            if (string.IsNullOrEmpty(saleorder.warehouseCode))
                            {
                                //写日志 没有出库仓库。
                                LogHelper.WriteLog(saleorder.orderCode + " " + saleorder.warehouseName + "无出库仓库");
                                continue;
                            }
                            //获取马牌仓库区域
                            CargoAreaEntity areaEntity = houseBus.QueryHouseByDeliveryArea(new CargoAreaEntity { ContiHouseCode = saleorder.warehouseCode });
                            if (areaEntity.AreaID.Equals(0))
                            {
                                //写日志 没有配置仓库
                                LogHelper.WriteLog(saleorder.orderCode + " " + saleorder.warehouseName + "无配置出库仓库");
                                continue;
                            }
                            //获取客户信息
                            List<CargoClientEntity> clientEntities = clientBus.QueryCargoClientList(new CargoClientEntity { TryeClientCode = saleorder.customerCode, DelFlag = "0", HouseIDStr = "" });
                            if (clientEntities.Count > 0)
                            {
                                saleorder.BidClientNum = clientEntities[0].ClientNum;
                                saleorder.BidClientName = clientEntities[0].ClientName;
                            }
                            saleorder.AreaID = areaEntity.AreaID;
                            saleorder.HouseID = areaEntity.HouseID;
                            saleorder.InCreateStatus = "0";
                            saleorder.OrderPiece = saleorder.saleSkuOpenInfoResp.Sum(c => c.skuNum);
                            saleorder.freightAmount = string.IsNullOrEmpty(saleorder.freightAmount) ? "0" : saleorder.freightAmount;
                            //优惠券金额明细
                            if (saleorder.saleOpenPromotionAmountList.Count > 0)
                            {
                                //couponAmount:优惠券总金额
                                saleorder.couponAmount = saleorder.saleOpenPromotionAmountList[0].couponAmount;
                            }
                            conti.Add(saleorder);
                        }
                    }
                    //Tbl_Cargo_ContiOrder 创建马牌订单数据
                    nwBus.AddContiSaleOrderInfo(conti, log);
                    //Tbl_Cargo_ContiOrderPush 更新 马牌出库单数据同步表
                    nwBus.AddContiOrderPushInfo(new saleOrderStatusOpenQueryResp { currentUpdateTime = contiOrder.data.saleOrderStatusOpenQueryResp.currentUpdateTime, companyId = contiOrder.data.saleOrderStatusOpenQueryResp.companyId, tenantId = contiOrder.data.saleOrderStatusOpenQueryResp.tenantId, nextUpdateTime = contiOrder.data.saleOrderStatusOpenQueryResp.nextUpdateTime, ResJson = contistr }, log);
                }
            }
            catch (ApplicationException ex)
            {
                LogHelper.WriteLog("同步马牌订单数据出错" + ex.Message);
            }
            #endregion

        }
        /// <summary>
        /// 慧采云仓共享仓库订单定时生成
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        void RemoveOrderQuotaTime_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            //机器人账号
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "次日达订单";
            log.UserID = RobotID;
            log.Operate = "A";

            CargoInterfaceBus bus = new CargoInterfaceBus();
            CargoOrderBus orderBus = new CargoOrderBus();
            CargoHouseBus house = new CargoHouseBus();

            #region 前置仓次日达订单自动同步共享仓生成订单
            RedisValue[] redisValues = RedisHelper.HashKeys("NextDayOrderShareSync");
            foreach (RedisValue redisValue in redisValues)
            {
                string key = redisValue.ToString();//ST250729043_101_93   订单key
                string goodsList = Convert.ToString(RedisHelper.HashGet("NextDayOrderShareSync", key));//订单明细

                string oriOrderNo = Convert.ToString(key.Split('_')[0]);
                int oriHouseID = Convert.ToInt32(key.Split('_')[1]);
                int ShareHouseID = Convert.ToInt32(key.Split('_')[2]);
                //保存生成仓库订单
                List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
                List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();

                CargoOrderEntity ent = orderBus.QueryOrderInfo(new CargoOrderEntity { OrderNo = oriOrderNo });
                if (ent.OrderID.Equals(0))
                {
                    RedisHelper.HashDelete("NextDayOrderShareSync", key);
                    continue;
                }
                if (!ent.CheckStatus.Equals("1"))
                {
                    //如果次日达订单没有支付就跳过
                    continue;
                }
                int OrderNum = 0;

                CargoHouseEntity houseEnt = house.QueryCargoHouseByID(ShareHouseID);
                ent.HouseID = ShareHouseID;
                ent.OrignHouseID = oriHouseID;
                ent.OrignHouseName = "";
                ent.ShareHouseID = 0;
                ent.ShareHouseName = "";
                ent.Dep = houseEnt.DepCity;
                ent.OpenOrderNo = oriOrderNo;
                ent.LogisID = houseEnt.HouseID.Equals(97) || houseEnt.HouseID.Equals(95) || houseEnt.HouseID.Equals(101) ? 62 : houseEnt.HouseID.Equals(136) ? 383 : 34;
                ent.CreateDate = DateTime.Now;

                List<CargoInterfaceEntity> goods = new List<CargoInterfaceEntity>();
                ArrayList rows = (ArrayList)JSON.Decode(goodsList);

                bool IsAllTrue = false;
                foreach (Hashtable row in rows)
                {
                    int piece = Convert.ToInt32(row["StockNum"]);
                    CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                    {
                        ProductCode = Convert.ToString(row["ProductCode"]),
                        HouseID = houseEnt.HouseID,
                        //TypeID = productBasic[0].TypeID,
                        BatchYear = Convert.ToInt32(row["BatchYear"]),
                        ParentID = 1,
                        SuppClientNum = ent.SuppClientNum.ToString(),
                        SpecsType = "4",
                    };
                    List<CargoInterfaceEntity> stockList = bus.queryCargoStock(queryEntity);
                    if (stockList.Count <= 0)
                    {
                        IsAllTrue = false;
                        LogHelper.WriteLog(Convert.ToString(row["ProductCode"]) + "商品库存不足");
                        continue;
                    }
                    if (stockList.Sum(c => c.StockNum) < piece)
                    {
                        IsAllTrue = false;
                        LogHelper.WriteLog(Convert.ToString(row["ProductCode"]) + "商品库存不足");
                        continue;
                    }
                    IsAllTrue = true;
                    break;
                }
                if (!IsAllTrue)
                {
                    continue;
                }

                string outID = DateTime.Now.ToString("yyMMdd") + GetRandomFourNumString();//出库单号
                ent.OrderNo = GetMaxOrderNumByCurrentDate(houseEnt.HouseID, houseEnt.HouseCode, out OrderNum);
                ent.OutHouseName = houseEnt.Name;
                ent.OrderNum = OrderNum;

                decimal originalPrice = 0M;
                foreach (Hashtable row in rows)
                {
                    int piece = Convert.ToInt32(row["StockNum"]);
                    decimal ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                    CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                    {
                        ProductCode = Convert.ToString(row["ProductCode"]),
                        HouseID = houseEnt.HouseID,
                        //TypeID = productBasic[0].TypeID,
                        BatchYear = Convert.ToInt32(row["BatchYear"]),
                        ParentID = 1,
                        SuppClientNum = ent.SuppClientNum.ToString(),
                        SpecsType = "4",
                    };
                    List<CargoInterfaceEntity> stockList = bus.queryCargoStock(queryEntity);
                    if (stockList.Count <= 0)
                    {
                        LogHelper.WriteLog("商品库存不足");
                        continue;
                    }
                    if (stockList.Sum(c => c.StockNum) < piece)
                    {
                        LogHelper.WriteLog("商品库存不足");
                        //LogHelper.WriteLog(productBasic[0].Specs + " " + productBasic[0].Figure + "库存不足");
                        continue;
                    }
                    //减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                    foreach (var it in stockList)
                    {
                        if (it.StockNum <= 0) { continue; }

                        CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                        cargo.OrderNo = ent.OrderNo;//订单号
                        cargo.OutCargoID = outID;
                        cargo.ContainerID = it.ContainerID;
                        cargo.TypeID = it.TypeID;
                        cargo.ProductID = it.ProductID;

                        cargo.ID = it.ContainerGoodsID;//库存表ID

                        //cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                        cargo.HouseName = houseEnt.Name;
                        //cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                        cargo.ProductName = it.ProductName;
                        cargo.Model = it.Model;
                        cargo.Specs = it.Specs;
                        cargo.Figure = it.Figure;
                        int inHouseDay = (int)(DateTime.Now - it.InHouseTime).TotalDays;
                        int OverDay = 0;
                        decimal OnlyOverDayFee = 0;

                        #region 减库存逻辑
                        if (piece < it.StockNum)
                        {
                            //部分出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = piece,
                                //ActSalePrice = it.SalePrice,
                                ActSalePrice = ActSalePrice,
                                SupplySalePrice = it.InHousePrice,
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                OP_ID = log.UserID,
                                OverDayNum = OverDay,
                                OverDueFee = OnlyOverDayFee,
                            });

                            cargo.Piece = piece;
                            cargo.InPiece = it.StockNum;
                            originalPrice += piece * it.InHousePrice;//计算成本价
                            outHouseList.Add(cargo);
                            break;
                        }
                        if (piece.Equals(it.StockNum))
                        {
                            //要出库件数和第一条库存件数刚刚好，则就全部出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = piece,
                                //ActSalePrice = it.SalePrice,
                                SupplySalePrice = it.InHousePrice,
                                ActSalePrice = ActSalePrice,
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,

                                OP_ID = log.UserID,
                                OverDayNum = OverDay,
                                OverDueFee = OnlyOverDayFee,
                            });
                            cargo.Piece = piece;
                            cargo.InPiece = it.StockNum;
                            originalPrice += piece * it.InHousePrice;//计算成本价

                            outHouseList.Add(cargo);
                            break;
                        }
                        if (piece > it.StockNum)
                        {
                            //全部出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = it.StockNum,
                                //ActSalePrice = it.SalePrice,
                                SupplySalePrice = it.InHousePrice,
                                ActSalePrice = ActSalePrice,
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,

                                OP_ID = log.UserID,
                                OverDayNum = OverDay,
                                OverDueFee = OnlyOverDayFee,
                            });
                            cargo.Piece = it.StockNum;
                            cargo.InPiece = it.StockNum;
                            cargo.GoodsName = it.GoodsName;
                            originalPrice += it.StockNum * it.InHousePrice;//计算成本价
                            outHouseList.Add(cargo);
                            piece = piece - it.StockNum;
                            continue;
                        }
                        #endregion
                    }
                }
                if (entDest.Count <= 0)
                {
                    continue;
                }
                ent.WXOrderNo = "";
                ent.OrderType = "0";
                ent.OpenOrderSource = "1";


                ent.goodsList = entDest;

                //保存生成仓库出库订单
                orderBus.AddOrderInfo(ent, outHouseList, log);

                #region 推送好来运系统

                if (ent.HouseID.Equals(93))
                {
                    //内部订单 || ent.HouseID.Equals(98)
                    orderBus.SaveHlyOrderData(outHouseList, ent);
                }
                else
                {
                    orderBus.InsertCargoOrderPush(new CargoOrderPushEntity
                    {
                        OrderNo = ent.OrderNo,
                        Dep = ent.Dep,
                        Dest = ent.Dest,
                        Piece = ent.Piece,
                        TransportFee = ent.TransportFee,
                        ClientNum = ent.ClientNum.ToString(),
                        AcceptAddress = ent.AcceptAddress,
                        AcceptCellphone = ent.AcceptCellphone,
                        AcceptTelephone = ent.AcceptTelephone,
                        AcceptPeople = ent.AcceptPeople,
                        AcceptUnit = ent.AcceptUnit,
                        HouseID = ent.HouseID.ToString(),
                        HouseName = ent.OutHouseName,
                        OP_ID = RobotID,
                        PushType = "0",
                        PushStatus = "0",
                        LogisID = houseEnt.HouseID.Equals(97) || houseEnt.HouseID.Equals(95) || houseEnt.HouseID.Equals(101) ? 62 : houseEnt.HouseID.Equals(136) ? 383 : 34
                    }, log);

                }

                #endregion

                //更新原仓库订单的关联订单
                bus.UpdateOrderOpenNo(new CargoOrderEntity { HouseID = oriHouseID, OrderNo = oriOrderNo, OpenOrderNo = ent.OrderNo });

                //删除已经保存订单成功的Key
                RedisHelper.HashDelete("NextDayOrderShareSync", key);
                LogHelper.WriteLog("订单：" + oriOrderNo + "保存成功");


                #region 次日达订单推送
                //CargoHouseEntity houseEnt = house.QueryCargoHouseByID(ord.HouseID);
                string fkfs = ent.CheckOutType.Equals("3") ? "货到付款" : ent.CheckOutType.Equals("10") ? "预付款" : "现付";
                string shf = "次日达";
                string tit = "次日达";
                QySendInfoEntity send = new QySendInfoEntity();
                send.title = tit + " 有新订单";
                //推送给提交人
                send.msgType = msgType.textcard;
                send.agentID = "1000003";//消息通知的应用
                send.AgentSecret = "VkkRCESh5hxT8FStrYa0jWjIg0ux--M670SoFFyuimM";
                //send.toUser = qup.ApplyID;<div>订单金额：" + ord.TotalCharge.ToString("F2") + "</div>
                send.toTag = houseEnt.HCYCOrderPushTagID.ToString();
                //send.toTag = "19";
                send.content = "<div></div><div>出库仓库：" + houseEnt.Name + "-出库" + "</div><div>商城订单号：" + ent.WXOrderNo + "</div><div>出库订单号：" + ent.OrderNo + "</div><div>订单数量：" + ent.Piece.ToString() + "</div><div>订单金额：" + ent.TotalCharge.ToString("F2") + "</div><div>货物信息：" + outHouseList.FirstOrDefault().GoodsName + "</div><div>付款方式：" + fkfs + "</div><div>送货方式：" + shf + "</div><div>门店名称：" + ent.AcceptUnit + "</div><div>收货信息：" + ent.AcceptPeople + " " + ent.AcceptCellphone + "</div><div>收货地址：" + ent.AcceptAddress + "</div><div>请仓管人员留意尽快出库！</div>";
                send.url = "http://dlt.neway5.com/QY/qyScanOrderSign.aspx?OrderNo=" + ent.OrderNo;
                LogHelper.WriteLog("次日达订单通知：" + send.content);
                WXQYSendHelper.DLTQYPushInfo(send);
                #endregion

            }
            #endregion

            LogHelper.WriteLog("开始增量同步共享仓库存至前置仓");


            #region 增量同步共享仓库存至前置仓
            //以TypeID为Key，ProductCode为Value
            Dictionary<int, string> DPdicCass = new Dictionary<int, string>();//东平
            Dictionary<int, string> SJdicCass = new Dictionary<int, string>();//顺捷
            Dictionary<int, string> XYdicCass = new Dictionary<int, string>();//秀英
            Dictionary<int, string> LHdicCass = new Dictionary<int, string>();//龙华
            string StProductCode = string.Empty;
            RedisValue[] HCYCredisValues = RedisHelper.HashKeys("HCYCHouseStockSyc");
            foreach (RedisValue redisValue in HCYCredisValues)
            {
                string key = redisValue.ToString();//93_34_LTCT245452005
                string ProductCodeV = Convert.ToString(RedisHelper.HashGet("HCYCHouseStockSyc", key));
                int HouseID = Convert.ToInt32(key.Split('_')[0]);
                //品牌ID
                int TypeID = Convert.ToInt32(key.Split('_')[1]);
                //产品编码
                string ProductCode = Convert.ToString(key.Split('_')[2]);

                //处理东平云仓和顺捷云仓库存数据
                if (HouseID.Equals(93))
                {
                    if (DPdicCass.ContainsKey(TypeID))
                    {
                        // 获取当前Key的内容
                        string currentValue = DPdicCass[TypeID];

                        // 更新内容
                        string updatedValue = currentValue + "','" + ProductCode;
                        DPdicCass[TypeID] = updatedValue;
                    }
                    else
                    {
                        DPdicCass.Add(TypeID, ProductCode);
                    }
                }
                else if (HouseID.Equals(100))
                {
                    if (SJdicCass.ContainsKey(TypeID))
                    {
                        // 获取当前Key的内容
                        string currentValue = SJdicCass[TypeID];

                        // 更新内容
                        string updatedValue = currentValue + "','" + ProductCode;
                        SJdicCass[TypeID] = updatedValue;
                    }
                    else
                    {
                        SJdicCass.Add(TypeID, ProductCode);
                    }
                }
                else if (HouseID.Equals(133))
                {
                    if (XYdicCass.ContainsKey(TypeID))
                    {
                        // 获取当前Key的内容
                        string currentValue = XYdicCass[TypeID];

                        // 更新内容
                        string updatedValue = currentValue + "','" + ProductCode;
                        XYdicCass[TypeID] = updatedValue;
                    }
                    else
                    {
                        XYdicCass.Add(TypeID, ProductCode);
                    }
                }
                else if (HouseID.Equals(91))
                {
                    if (LHdicCass.ContainsKey(TypeID))
                    {
                        // 获取当前Key的内容
                        string currentValue = LHdicCass[TypeID];

                        // 更新内容
                        string updatedValue = currentValue + "','" + ProductCode;
                        LHdicCass[TypeID] = updatedValue;
                    }
                    else
                    {
                        LHdicCass.Add(TypeID, ProductCode);
                    }
                }

            }
            List<CargoHouseBrandShareEntity> list = house.QueryHouseShareList(new CargoHouseBrandShareEntity { ShareHouseID = 93 }).GroupBy(c => c.MainHouseID).Select(c => new CargoHouseBrandShareEntity { MainHouseID = c.Key }).ToList();
            //开始同步东平仓增量库存
            foreach (var cass in DPdicCass)
            {
                List<CargoProductEntity> entities = bus.QueryNextDayStockSync(new CargoProductEntity { HouseID = 93, TypeID = cass.Key, ProductCode = cass.Value });
                if (entities.Count > 0)
                {
                    bus.SaveNextDayProductData(entities, false);
                }
                else
                {

                    foreach (var shid in list)
                    {
                        bus.SetNextDayStockZero(new House.Entity.Cargo.House.CargoHouseBrandShareEntity { MainHouseID = shid.MainHouseID, BrandID = cass.Key, ProductCode = cass.Value });
                    }
                }
            }
            list = house.QueryHouseShareList(new CargoHouseBrandShareEntity { ShareHouseID = 100 }).GroupBy(c => c.MainHouseID).Select(c => new CargoHouseBrandShareEntity { MainHouseID = c.Key }).ToList();
            //开始同步顺捷仓增量库存
            foreach (var cass in SJdicCass)
            {
                List<CargoProductEntity> entities = bus.QueryNextDayStockSync(new CargoProductEntity { HouseID = 100, TypeID = cass.Key, ProductCode = cass.Value });
                if (entities.Count > 0)
                {
                    bus.SaveNextDayProductData(entities, false);
                }
                else
                {
                    foreach (var shid in list)
                    {
                        bus.SetNextDayStockZero(new House.Entity.Cargo.House.CargoHouseBrandShareEntity { MainHouseID = shid.MainHouseID, BrandID = cass.Key, ProductCode = cass.Value });
                    }
                }
            }

            //开始同步秀英仓增量库存
            list = house.QueryHouseShareList(new CargoHouseBrandShareEntity { ShareHouseID = 133 }).GroupBy(c => c.MainHouseID).Select(c => new CargoHouseBrandShareEntity { MainHouseID = c.Key }).ToList();
            foreach (var cass in XYdicCass)
            {
                List<CargoProductEntity> entities = bus.QueryNextDayStockSync(new CargoProductEntity { HouseID = 133, TypeID = cass.Key, ProductCode = cass.Value });
                if (entities.Count > 0)
                {
                    bus.SaveNextDayProductData(entities, false);
                }
                else
                {
                    foreach (var shid in list)
                    {
                        bus.SetNextDayStockZero(new House.Entity.Cargo.House.CargoHouseBrandShareEntity { MainHouseID = shid.MainHouseID, BrandID = cass.Key, ProductCode = cass.Value });
                    }
                }
            }

            //开始同步龙华仓增量库存
            list = house.QueryHouseShareList(new CargoHouseBrandShareEntity { ShareHouseID = 91 }).GroupBy(c => c.MainHouseID).Select(c => new CargoHouseBrandShareEntity { MainHouseID = c.Key }).ToList();
            foreach (var cass in LHdicCass)
            {
                List<CargoProductEntity> entities = bus.QueryNextDayStockSync(new CargoProductEntity { HouseID = 91, TypeID = cass.Key, ProductCode = cass.Value });
                if (entities.Count > 0)
                {
                    bus.SaveNextDayProductData(entities, false);
                }
                else
                {
                    foreach (var shid in list)
                    {
                        bus.SetNextDayStockZero(new House.Entity.Cargo.House.CargoHouseBrandShareEntity { MainHouseID = shid.MainHouseID, BrandID = cass.Key, ProductCode = cass.Value });
                    }
                }
            }
            RedisHelper.KeyDelete("HCYCHouseStockSyc");
            LogHelper.WriteLog("HCYCHouseStockSyc缓存删除成功");
            #endregion
        }
        /// <summary>
        /// 每月清零优惠额度
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        void ClearClentQuotaTime_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            CargoOrderBus bus = new CargoOrderBus();
            CargoStaticBus staticBus = new CargoStaticBus();
            CargoClientBus clientBus = new CargoClientBus();
            CargoInterfaceBus nwBus = new CargoInterfaceBus();

            #region 处理云仓用户货到付款权限控制
            try
            {
                clientBus.UpdateClientArriveLimit();
                LogHelper.WriteLog("处理云仓客户货到付款权限成功");
            }
            catch (ApplicationException ex)
            {
                LogHelper.WriteLog("处理云仓客户货到付款权限失败");
            }

            #endregion

            #region 同步联盈系统运单数据到新陆程系统
            if (DateTime.Now.Hour.Equals(20) || DateTime.Now.Hour.Equals(21) || DateTime.Now.Hour.Equals(22) || DateTime.Now.Hour.Equals(23) || DateTime.Now.Hour.Equals(0) || DateTime.Now.Hour.Equals(1) || DateTime.Now.Hour.Equals(2) || DateTime.Now.Hour.Equals(3))
            {
                LogHelper.WriteLog("开始处理联盈运单数据");
                //每天零辰0点获取联盈数据保存至新陆程系统
                string IFUrl = "http://open.facai56.com/winlogicapi-open/v2/open/getOrderList";
                string starDate = DateTime.Now.Hour.Equals(20) || DateTime.Now.Hour.Equals(21) || DateTime.Now.Hour.Equals(22) || DateTime.Now.Hour.Equals(23) ? DateTime.Now.ToString("yyyy-MM-dd") : DateTime.Now.AddHours(-1).ToString("yyyy-MM-dd HH:mm");
                string endDate = DateTime.Now.Hour.Equals(20) ? DateTime.Now.ToString("yyyy-MM-dd HH:mm") : DateTime.Now.ToString("yyyy-MM-dd HH:mm");


                CargoLYEntity lYEntity = new CargoLYEntity();

                lYEntity.ak = System.Web.HttpUtility.UrlEncode("uF+yrA2mpicKwWA5vmTPmw==");
                lYEntity.start = System.Web.HttpUtility.UrlEncode(starDate);
                lYEntity.end = System.Web.HttpUtility.UrlEncode(endDate);
                lYEntity.company = System.Web.HttpUtility.UrlEncode("新陆程物流");
                string jss = JsonConvert.SerializeObject(lYEntity);
                string data = "data=" + jss;
                try
                {

                    string xlcawbno = wxHttpUtility.SendPostHttpRequest(IFUrl, "application/x-www-form-urlencoded", data);
                    if (!string.IsNullOrEmpty(xlcawbno))
                    {
                        ArrayList GridRows = (ArrayList)JSON.Decode("[" + xlcawbno + "]");
                        foreach (Hashtable row in GridRows)
                        {
                            ArrayList awbNos = (ArrayList)row["dataList"];
                            foreach (Hashtable awb in awbNos)
                            {
                                string key = Convert.ToString(awb["billNo"]);
                                if (RedisHelper.HashExists("NewayLYAwbSync", key))
                                {
                                    continue;
                                }

                                string goods = !string.IsNullOrEmpty(Convert.ToString(awb["goods"])) ? Convert.ToString(awb["goods"]) : "配件";
                                string caseType = !string.IsNullOrEmpty(Convert.ToString(awb["caseType"])) ? Convert.ToString(awb["caseType"]) : "无";

                                string paymentType = "0";

                                switch (Convert.ToString(awb["paymentType"]))
                                {
                                    case "到付": paymentType = "3"; break;
                                    case "现金": paymentType = "0"; break;
                                    case "现付月结": paymentType = "2"; break;
                                    default:
                                        break;
                                }

                                #region 明细
                                string go = "[";
                                go += "{\"Goods\":\"" + goods + "\",\"Package\":\"" + caseType + "\",\"Piece\":\"" + Convert.ToString(awb["qty"]) + "\",\"Weight\":\"" + Convert.ToString(awb["weight"]) + "\",\"WeightPrice\":\"" + Convert.ToString(awb["weightPrice"]) + "\",\"Volume\":\"" + Convert.ToString(awb["cube"]) + "\",\"VolumePrice\":\"" + Convert.ToString(awb["cubePrice"]) + "\",\"DeclareValue\":\"" + Convert.ToString(awb["insurance"]) + "\",\"OP_DATE\":\"" + Convert.ToString(awb["billDate"]) + "\"},";
                                go = go.Substring(0, go.Length - 1);
                                go += "]";
                                #endregion

                                string ss = "{\"HAwbNo\":\"" + Convert.ToString(awb["billNo"]) + "\",\"Dep\":\"" + Convert.ToString(awb["startStoreName"]) + "\",\"Dest\":\"" + Convert.ToString(awb["dest"]) + "\",\"Transit\":\"" + Convert.ToString(awb["transhipDest"]) + "\",\"Piece\":\"" + Convert.ToString(awb["qty"]) + "\",\"InsuranceFee\":\"" + Convert.ToString(awb["insuranceFee"]) + "\",\"TransitFee\":\"0\",\"TransportFee\":\"" + Convert.ToString(awb["freight"]) + "\",\"DeliverFee\":\"" + Convert.ToString(awb["deliveryFee"]) + "\",\"OtherFee\":\"" + Convert.ToString(awb["otherFee"]) + "\",\"TotalCharge\":\"" + Convert.ToString(awb["totalFee"]) + "\",\"CollectMoney\":\"" + Convert.ToString(awb["codAmount"]) + "\",\"CheckOutType\":\"" + paymentType + "\",\"ReturnAwb\":\"\",\"ShipperName\":\"" + Convert.ToString(awb["shipper"]) + "\",\"ShipperUnit\":\"市场快线部\",\"ShipperTelephone\":\"" + Convert.ToString(awb["shipperTel"]) + "\",\"ShipperCellphone\":\"" + Convert.ToString(awb["shipperTel"]) + "\",\"ShipperAddress\":\"" + Convert.ToString(awb["shipperAddr"]) + "\",\"AcceptUnit\":\"" + Convert.ToString(awb["consignee"]) + "\",\"AcceptPeople\":\"" + Convert.ToString(awb["consignee"]) + "\",\"AcceptTelephone\":\"" + Convert.ToString(awb["consigneeTel"]) + "\",\"AcceptCellphone\":\"" + Convert.ToString(awb["consigneeTel"]) + "\",\"AcceptAddress\":\"" + Convert.ToString(awb["consigneeAddr"]) + "\",\"HandleTime\":\"" + Convert.ToString(awb["billDate"]) + "\",\"Remark\":\"" + Convert.ToString(awb["remarks"]) + "\",\"Goods\":" + go + "}";
                                //\"DelFlag\":\"3\",\"AwbStatus\":\"3\",
                                string dataa = "cmd=SaveNewayAwbNo&OrderList=[" + ss + "]&Belong=NW&OPID=YLRJ";
                                string lyres = wxHttpUtility.SendHttpRequest("http://xt.neway5.com/Interface/OMSInterface.ashx", dataa);
                                LogHelper.WriteLog("联盈系统保存结果：" + Convert.ToString(awb["billNo"]) + "，新陆程单号：" + lyres);
                                RedisHelper.HashSet("NewayLYAwbSync", key, key);

                                Thread.Sleep(1000);
                            }
                        }

                    }

                }
                catch (ApplicationException ex)
                {

                    LogHelper.WriteLog("同步联盈系统运单数据失败" + ex.Message);
                }
            }
            #endregion

            #region 查询联盈系统运单物流跟踪状态更新至新陆程系统运单状态
            //查询新陆程联盈运单未签收状态5天内的数据
            try
            {
                string OrderIFUrl = "http://open.facai56.com/winlogicapi-open/v2/open/order";
                List<CargoKD100Entity> noPoll = nwBus.QueryLYAwbNoData(new CargoNewayDataPush { BelongSystem = "NW", Status = "3", UserName = "YLRJ", StartTime = DateTime.Now.AddDays(-7) });
                //LogHelper.WriteLog("开始同步联盈运单数据状态");
                if (noPoll.Count > 0)
                {
                    //LogHelper.WriteLog("开始同步联盈运单数据状态" + noPoll.Count.ToString());
                    foreach (var it in noPoll)
                    {
                        //string OData = "data={'ak':'uF+yrA2mpicKwWA5vmTPmw==','billNo':'" + it.OrderNo + "','shipperTel':'" + it.ComCode + "','company':'新陆程物流'}";
                        CargoLYAwbEntity lYEntity = new CargoLYAwbEntity();

                        lYEntity.ak = System.Web.HttpUtility.UrlEncode("uF+yrA2mpicKwWA5vmTPmw==");
                        lYEntity.billNo = System.Web.HttpUtility.UrlEncode(it.OrderNo);
                        lYEntity.shipperTel = System.Web.HttpUtility.UrlEncode(it.ComCode);
                        lYEntity.company = System.Web.HttpUtility.UrlEncode("新陆程物流");
                        string jss = JsonConvert.SerializeObject(lYEntity);
                        string data = "data=" + jss;
                        string xlcawbno = wxHttpUtility.SendPostHttpRequest(OrderIFUrl, "application/x-www-form-urlencoded", data);
                        //LogHelper.WriteLog(xlcawbno);
                        ArrayList nod = (ArrayList)JSON.Decode("[" + xlcawbno + "]");
                        foreach (Hashtable noit in nod)
                        {
                            if (noit.ContainsKey("data") && noit["data"] is Hashtable item)
                            {
                                if (Convert.ToString(item["billState"]).Contains("签收"))
                                {
                                    //回调状态是签收状态
                                    CargoKD100Entity sig = new CargoKD100Entity();
                                    //已签收
                                    ArrayList awbNos = (ArrayList)item["logisticsStatesList"];
                                    foreach (Hashtable awb in awbNos)
                                    {
                                        //取签收时间
                                        if (Convert.ToString(awb["state"]).Contains("签收"))
                                        {
                                            sig.ArriveTime = Convert.ToDateTime(awb["dT"]);
                                            sig.DetailInfo = Convert.ToString(awb["msg"]);
                                            break;
                                        }
                                    }
                                    sig.AwbID = it.AwbID;
                                    sig.AwbNo = it.AwbNo;
                                    sig.Signer = "YLRJ";
                                    sig.TruckFlag = "7";
                                    sig.BelongSystem = it.BelongSystem;
                                    sig.OP_ID = it.OP_ID;
                                    nwBus.SaveLYAwbStatusTruck(sig);
                                    LogHelper.WriteLog(it.AwbNo + "更新签收成功");
                                }
                            }
                        }
                    }
                }
            }
            catch (ApplicationException ex)
            {
                LogHelper.WriteLog("更新联盈系统跟踪数据失败" + ex.Message);
            }
            #endregion


            #region 全量同步库存数据，慧采共享仓同步前置仓
            try
            {
                //每天零辰2点同步慧采共享仓库存至前置仓
                if (DateTime.Now.Hour.Equals(2))
                {
                    nwBus.SetNextDayStockZero();

                    LogHelper.loginfo.Info("开始慧采共享仓库存同步");
                    List<CargoProductEntity> entities = nwBus.QueryNextDayStockSync(new CargoProductEntity { });
                    nwBus.SaveNextDayProductData(entities);
                    LogHelper.loginfo.Info("慧采共享仓库存同步成功");
                }
            }
            catch (ApplicationException ex)
            {
                LogHelper.loginfo.Info("慧采共享仓库存同步出错");
            }
            #endregion

            #region 检查锦湖来货与缺货清单数据并向客户推送到货通知
            //try
            //{
            //    LogEntity log = new LogEntity();
            //    log.IPAddress = "";
            //    log.Moudle = "服务管理";
            //    log.Status = "0";
            //    log.NvgPage = "到货通知";
            //    log.UserID = RobotID;
            //    log.Operate = "U";

            //    ShortageListEntity queryEntity = new ShortageListEntity();
            //    //82：华南配件仓锦湖轮胎项目 10：西安仓库安泰路斯项目
            //    queryEntity.PermissionHouseID = "82,10";
            //    queryEntity.StartDate = DateTime.Now;
            //    List<ShortageListEntity> result = bus.QueryCurrDayArrivalData(queryEntity);
            //    if (result.Count > 0)
            //    {
            //        string SaleManID = string.Empty;
            //        string ClientNum = string.Empty;
            //        string memo = string.Empty;
            //        string salememo = string.Empty;
            //        CargoNoticeEntity notice = new CargoNoticeEntity();
            //        CargoNoticeEntity Salenotice = new CargoNoticeEntity();
            //        foreach (var re in result)
            //        {
            //            if (string.IsNullOrEmpty(ClientNum))
            //            {
            //                notice.ClientNum = Convert.ToInt32(re.ClientNum);
            //                notice.Title = DateTime.Today.ToLongDateString() + " 到货通知";
            //                notice.NoticeType = "1";
            //                notice.HouseID = re.HouseID;
            //                notice.OPName = RobotName;
            //                ClientNum = re.ClientNum;
            //                memo = "<p><strong><span style=\"font-size:18px;\">尊敬的" + re.ClientName + "：</span></strong></p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style=\"font-size:14px;\">您的缺货清单列表中下列规格于今日到货入库，请及时下单，谢谢！</span></p><p><table style=\"width:100%;\" cellpadding=\"2\" cellspacing=\"0\" border=\"1\" bordercolor=\"#000000\"><tbody><tr><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>品牌</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>货品代码</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>规格</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>花纹</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>载速</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>状态</strong></span></td></tr><tr><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.TypeName + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.GoodsCode + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.Specs + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.Figure + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.LoadIndex + re.SpeedLevel + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">已入库</span></td></tr>";
            //            }
            //            else
            //            {
            //                if (ClientNum.Equals(re.ClientNum))
            //                {
            //                    //说明是同一个客户的
            //                    memo += "<tr><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.TypeName + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.GoodsCode + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.Specs + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.Figure + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.LoadIndex + re.SpeedLevel + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">已入库</span></td></tr>";
            //                }
            //                else
            //                {
            //                    //不是同一个客户 先推送再处理下一个客户
            //                    memo += "</tbody></table></p><p style=\"text-align:right;\"><span style=\"font-size:16px;\"><br /></span></p><p style=\"text-align:right;\"><span style=\"font-size:16px;\">" + DateTime.Today.ToLongDateString() + "</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p>";
            //                    //新增公告表
            //                    notice.Memo = memo;
            //                    staticBus.AddNotice(notice, log);
            //                    //Reload
            //                    ClientNum = re.ClientNum;
            //                    notice = new CargoNoticeEntity();
            //                    memo = string.Empty;
            //                    notice.ClientNum = Convert.ToInt32(re.ClientNum);
            //                    notice.Title = DateTime.Today.ToLongDateString() + " 到货通知";
            //                    notice.NoticeType = "1";
            //                    notice.HouseID = re.HouseID;
            //                    notice.OPName = RobotName;
            //                    memo = "<p><strong><span style=\"font-size:18px;\">尊敬的" + re.ClientName + "：</span></strong></p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style=\"font-size:14px;\">您的缺货清单列表中下列规格于今日到货入库，请及时下单，谢谢！</span></p><p><table style=\"width:100%;\" cellpadding=\"2\" cellspacing=\"0\" border=\"1\" bordercolor=\"#000000\"><tbody><tr><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>品牌</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>货品代码</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>规格</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>花纹</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>载速</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>状态</strong></span></td></tr><tr><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.TypeName + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.GoodsCode + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.Specs + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.Figure + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.LoadIndex + re.SpeedLevel + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">已入库</span></td></tr>";
            //                }
            //            }
            //            if (string.IsNullOrEmpty(SaleManID))
            //            {
            //                SaleManID = Convert.ToString(re.SaleManID);
            //                Salenotice.ClientNum = re.SaleManID;
            //                Salenotice.Title = DateTime.Today.ToLongDateString() + " 到货通知";
            //                Salenotice.NoticeType = "1";
            //                Salenotice.HouseID = re.HouseID;
            //                Salenotice.OPName = RobotName;
            //                salememo = "<p><strong><span style=\"font-size:18px;\">尊敬的销售经理" + re.SaleManName + "：</span></strong></p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style=\"font-size:14px;\">您的客户缺货清单列表中有以下规格于今日到货入库，请及时通知客户下单，谢谢！</span></p><p><table style=\"width:100%;\" cellpadding=\"2\" cellspacing=\"0\" border=\"1\" bordercolor=\"#000000\"><tbody><tr><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>客户名称</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>品牌</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>货品代码</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>规格</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>花纹</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>载速</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>状态</strong></span></td></tr><tr><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.ClientName + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.TypeName + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.GoodsCode + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.Specs + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.Figure + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.LoadIndex + re.SpeedLevel + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">已入库</span></td></tr>";
            //            }
            //            else
            //            {
            //                if (SaleManID.Equals(Convert.ToString(re.SaleManID)))
            //                {
            //                    //说明是同一个业务员下的客户
            //                    salememo += "<tr><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.ClientName + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.TypeName + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.GoodsCode + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.Specs + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.Figure + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.LoadIndex + re.SpeedLevel + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">已入库</span></td></tr>";
            //                }
            //                else
            //                {
            //                    //不是同一个业务员下的 先推送再处理下一个业务员
            //                    salememo += "</tbody></table></p><p style=\"text-align:right;\"><span style=\"font-size:16px;\"><br /></span></p><p style=\"text-align:right;\"><span style=\"font-size:16px;\">" + DateTime.Today.ToLongDateString() + "</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p>";
            //                    //新增公告表
            //                    Salenotice.Memo = salememo;
            //                    staticBus.AddNotice(Salenotice, log);
            //                    //Reload
            //                    SaleManID = Convert.ToString(re.SaleManID);
            //                    Salenotice = new CargoNoticeEntity();
            //                    salememo = string.Empty;
            //                    Salenotice.ClientNum = re.SaleManID;
            //                    Salenotice.Title = DateTime.Today.ToLongDateString() + " 到货通知";
            //                    Salenotice.NoticeType = "1";
            //                    Salenotice.HouseID = re.HouseID;
            //                    Salenotice.OPName = RobotName;
            //                    salememo = "<p><strong><span style=\"font-size:18px;\">尊敬的销售经理" + re.SaleManName + "：</span></strong></p><p>&nbsp; &nbsp; &nbsp; &nbsp; <span style=\"font-size:14px;\">您的客户缺货清单列表中有以下规格于今日到货入库，请及时通知客户下单，谢谢！</span></p><p><table style=\"width:100%;\" cellpadding=\"2\" cellspacing=\"0\" border=\"1\" bordercolor=\"#000000\"><tbody><tr><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>客户名称</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>品牌</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>货品代码</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>规格</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>花纹</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>载速</strong></span></td><td style=\"text-align:center;\"><span style=\"font-size:14px;\"><strong>状态</strong></span></td></tr><tr><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.ClientName + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.TypeName + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.GoodsCode + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.Specs + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.Figure + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">" + re.LoadIndex + re.SpeedLevel + "</span></td><td style=\"text-align:center;\"><span style=\"font-size:16px;\">已入库</span></td></tr>";
            //                }
            //            }

            //            //删除缺货清单数据
            //            bus.DeleteShortageList(re, log);
            //        }

            //        //处理最后一个客户
            //        memo += "</tbody></table></p><p style=\"text-align:right;\"><span style=\"font-size:16px;\"><br /></span></p><p style=\"text-align:right;\"><span style=\"font-size:16px;\">" + DateTime.Today.ToLongDateString() + "</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p>";
            //        //新增公告表
            //        notice.Memo = memo;
            //        staticBus.AddNotice(notice, log);

            //        //处理最后一个业务员
            //        salememo += "</tbody></table></p><p style=\"text-align:right;\"><span style=\"font-size:16px;\"><br /></span></p><p style=\"text-align:right;\"><span style=\"font-size:16px;\">" + DateTime.Today.ToLongDateString() + "</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p>";
            //        //新增公告表
            //        Salenotice.Memo = salememo;
            //        staticBus.AddNotice(Salenotice, log);

            //    }
            //}
            //catch (Exception)
            //{
            //    LogHelper.WriteLog("到货通知推送失败");
            //    //PushWeixinNotice("0");
            //}
            #endregion

            //if (DateTime.Now.Hour.Equals(0) && DateTime.Now.Day.Equals(1))
            //{
            //    LogEntity log = new LogEntity();
            //    log.IPAddress = "";
            //    log.Moudle = "服务管理";
            //    log.Status = "0";
            //    log.NvgPage = "清零锦湖优惠额度";
            //    log.UserID = RobotID;
            //    log.Operate = "U";
            //    clientBus.ClearClentQuota(new CargoClientEntity { HouseID = 82, LimitMoney = 0 }, log);
            //}
        }

        void PushStock_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            CargoInterfaceBus bus = new CargoInterfaceBus();

            #region 龙华云仓库存同步开思
            ///龙华云仓Session：1f7bd12607104fd3a152daf7c1896bb0
            try
            {
                List<StockApiEntity> res = bus.QueryYunCangStockSync(new CargoProductEntity { HouseID = 91 });
                StockApiResponseEntity entity = new StockApiResponseEntity();
                entity.Params = new Params();
                entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                entity.data = new List<Data>();

                if (res.Count > 0)
                {
                    entity.Params.firstData = true;
                    entity.Params.lastData = true;
                    entity.Params.updateMode = "CHANGE";
                    long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                    string strRes = string.Empty;
                    entity.Params.tpsBatchId = tpsBatchId;
                    int cou = 0;
                    for (int i = 0; i < res.Count; i++)
                    {
                        if (cou == 500)
                        {
                            LogHelper.WriteLog("龙华云仓开思推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                            cou = 0;
                            strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "1f7bd12607104fd3a152daf7c1896bb0");
                            //string cpStrRes500 = wxHttpUtility.SendPostHttpRequest("https://cp.neway5.com/Interface/OpenApi.ashx?cmd=StockDataSync", "application/json", JsonConvert.SerializeObject(entity));

                            entity = new StockApiResponseEntity();
                            entity.Params = new Params();
                            entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                            entity.data = new List<Data>();
                            if (strRes.IndexOf("200") >= 0)
                            {
                                tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                entity.Params.tpsBatchId = tpsBatchId;
                                entity.Params.firstData = true;
                                entity.Params.lastData = true;
                                entity.Params.updateMode = "CHANGE";
                            }
                        }
                        string casscode = res[i].CassProductCode;
                        if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                        {
                            casscode = res[i].GoodsCode;
                        }
                        else
                        {
                            casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                        }
                        string typename = res[i].TypeName;
                        if (res[i].TypeID.Equals(9))
                        {
                            typename = "横滨/优科豪马";
                        }
                        else if (res[i].TypeID.Equals(66))
                        {
                            typename = "固铂轮胎";
                        }
                        entity.data.Add(new Data
                        {
                            CassProductCode = casscode,
                            ProductName = res[i].ProductName,
                            TypeName = typename,
                            SalePrice = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice()),
                            StockNum = res[i].StockNum,
                            Batch = res[i].Batch,
                            HouseID = res[i].HouseID,//龙华云仓+ Convert.ToDecimal(GetContiPrice())
                        });
                        //entity.data.Add(new Data
                        //{
                        //    CassProductCode = res[i].CassProductCode,
                        //    ProductName = res[i].ProductName,
                        //    TypeName = res[i].TypeName,
                        //    SalePrice = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice()),
                        //    StockNum = res[i].StockNum,
                        //    Batch = res[i].Batch,
                        //    HouseID = 91,//龙华云配仓
                        //});
                        LogHelper.WriteLog("龙华云仓开思推送ID:" + tpsBatchId + ",本次推送金额:" + Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice()) + ",加价金额:" + GetContiPrice());
                        cou++;



                    }
                    strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "1f7bd12607104fd3a152daf7c1896bb0");

                    // string data = JsonConvert.SerializeObject(entity);

                    //string cpStrRes = wxHttpUtility.SendPostHttpRequest("https://cp.neway5.com/Interface/OpenApi.ashx?cmd=StockDataSync", "application/json", data);

                    LogHelper.WriteLog("龙华云仓开思推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                    if (strRes.IndexOf("200") >= 0)
                    {
                        bus.UpdateStatus(res);
                        LogHelper.WriteLog("龙华云仓开思推送成功!共计" + res.Count + "条数据");
                    }
                    //if (cpStrRes.IndexOf("1000") >= 0)
                    //{
                    //    //bus.UpdateStatus(res);
                    //    LogHelper.WriteLog("城配快送推送成功!共计" + res.Count + "条数据");
                    //}
                }

            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("开思推送出现错误!Message" + ex.Message);
                throw;
            }
            #endregion

            #region 汕头仓库存同步开思
            ///汕头仓Session：67d89f8d06ca4360ae0358279b7d283c
            try
            {
                List<StockApiEntity> res = bus.QueryYunCangStockSync(new CargoProductEntity { HouseID = 101 });
                //StockApiResponseEntity STentity = new StockApiResponseEntity();
                //STentity.Params = new Params();
                //STentity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                //STentity.data = new List<Data>();
                StockApiResponseEntity entity = new StockApiResponseEntity();
                entity.Params = new Params();
                entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                entity.data = new List<Data>();

                if (res.Count > 0)
                {
                    entity.Params.firstData = true;
                    entity.Params.lastData = true;
                    entity.Params.updateMode = "CHANGE";
                    long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                    string strRes = string.Empty;
                    entity.Params.tpsBatchId = tpsBatchId;
                    int cou = 0;
                    for (int i = 0; i < res.Count; i++)
                    {
                        if (cou == 500)
                        {
                            LogHelper.WriteLog("汕头仓开思推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                            cou = 0;
                            strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "67d89f8d06ca4360ae0358279b7d283c");
                            //string cpStrRes500 = wxHttpUtility.SendPostHttpRequest("https://cp.neway5.com/Interface/OpenApi.ashx?cmd=StockDataSync", "application/json", JsonConvert.SerializeObject(STentity));

                            //STentity = new StockApiResponseEntity();
                            //STentity.Params = new Params();
                            //STentity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                            //STentity.data = new List<Data>();

                            entity = new StockApiResponseEntity();
                            entity.Params = new Params();
                            entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                            entity.data = new List<Data>();
                            if (strRes.IndexOf("200") >= 0)
                            {
                                tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                entity.Params.tpsBatchId = tpsBatchId;
                                entity.Params.firstData = true;
                                entity.Params.lastData = true;
                                entity.Params.updateMode = "CHANGE";
                            }
                        }

                        //STentity.data.Add(new Data
                        //{
                        //    CassProductCode = res[i].ProductCode,
                        //    ProductName = res[i].ProductName,
                        //    TypeName = res[i].TypeName,
                        //    SalePrice = Convert.ToDecimal(res[i].SalePrice) + 10,
                        //    StockNum = res[i].StockNum,
                        //    Batch = res[i].Batch,
                        //    HouseID = res[i].HouseID,//汕头仓+ Convert.ToDecimal(GetContiPrice())
                        //});
                        string casscode = res[i].CassProductCode;
                        if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                        {
                            casscode = res[i].GoodsCode;
                        }
                        else
                        {
                            casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                        }
                        string typename = res[i].TypeName;
                        if (res[i].TypeID.Equals(9))
                        {
                            typename = "横滨/优科豪马";
                        }
                        else if (res[i].TypeID.Equals(66))
                        {
                            typename = "固铂轮胎";
                        }
                        decimal sp = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice());
                        entity.data.Add(new Data
                        {
                            CassProductCode = casscode,
                            ProductName = res[i].ProductName,
                            TypeName = typename,
                            SalePrice = sp,//Math.Ceiling(sp * Convert.ToDecimal(1.005)),
                            StockNum = res[i].StockNum,
                            Batch = res[i].Batch,
                            HouseID = res[i].HouseID,//汕头仓+ Convert.ToDecimal(GetContiPrice())
                        });
                        LogHelper.WriteLog("汕头仓开思推送ID:" + casscode + "，库存：" + res[i].StockNum.ToString() + "，周期：" + res[i].Batch + ",本次推送金额:" + Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice()) + ",加价金额:15");
                        cou++;

                    }
                    strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "67d89f8d06ca4360ae0358279b7d283c");

                    //string data = JsonConvert.SerializeObject(STentity);

                    //string cpStrRes = wxHttpUtility.SendPostHttpRequest("https://cp.neway5.com/Interface/OpenApi.ashx?cmd=StockDataSync", "application/json", data);

                    LogHelper.WriteLog("汕头仓开思推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                    if (strRes.IndexOf("200") >= 0)
                    {
                        bus.UpdateStatus(res);
                        LogHelper.WriteLog("汕头仓开思推送成功!共计" + res.Count + "条数据");
                    }
                    //if (cpStrRes.IndexOf("1000") >= 0)
                    //{
                    //    //bus.UpdateStatus(res);
                    //    LogHelper.WriteLog("汕头仓城配快送推送成功!共计" + res.Count + "条数据");
                    //}
                }

            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("汕头仓开思推送出现错误!Message" + ex.Message);
                throw;
            }
            #endregion

            #region 南宁云仓库存同步开思
            try
            {
                List<StockApiEntity> res = bus.QueryYunCangStockSync(new CargoProductEntity { HouseID = 136 });
                StockApiResponseEntity entity = new StockApiResponseEntity();
                entity.Params = new Params();
                entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                entity.data = new List<Data>();

                if (res.Count > 0)
                {
                    entity.Params.firstData = true;
                    entity.Params.lastData = true;
                    entity.Params.updateMode = "CHANGE";
                    long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                    string strRes = string.Empty;
                    entity.Params.tpsBatchId = tpsBatchId;
                    int cou = 0;
                    for (int i = 0; i < res.Count; i++)
                    {
                        if (cou == 500)
                        {
                            LogHelper.WriteLog("南宁云仓开思推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                            cou = 0;
                            strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "2b2b36889e304645b28f94bfdd2ead9e");

                            entity = new StockApiResponseEntity();
                            entity.Params = new Params();
                            entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                            entity.data = new List<Data>();
                            if (strRes.IndexOf("200") >= 0)
                            {
                                tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                entity.Params.tpsBatchId = tpsBatchId;
                                entity.Params.firstData = true;
                                entity.Params.lastData = true;
                                entity.Params.updateMode = "CHANGE";
                            }
                        }

                        string casscode = res[i].CassProductCode;
                        if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                        {
                            casscode = res[i].GoodsCode;
                        }
                        else
                        {
                            casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                        }
                        string typename = res[i].TypeName;
                        if (res[i].TypeID.Equals(9))
                        {
                            typename = "横滨/优科豪马";
                        }
                        else if (res[i].TypeID.Equals(66))
                        {
                            typename = "固铂轮胎";
                        }
                        decimal saleprice = 0.00M;
                        if (GetNanNingMarkupType().Equals(0))
                        {
                            //按百分比
                            saleprice = Math.Ceiling(res[i].SalePrice * (1 + GetNanNingMarkupPrice() / 100));

                        }
                        else
                        {
                            saleprice = res[i].SalePrice + GetNanNingMarkupPrice();
                        }
                        entity.data.Add(new Data
                        {
                            CassProductCode = casscode,
                            ProductName = res[i].ProductName,
                            TypeName = typename,
                            SalePrice = saleprice,
                            StockNum = res[i].StockNum,
                            Batch = res[i].Batch,
                            HouseID = res[i].HouseID,
                        });
                        LogHelper.WriteLog("南宁云仓开思推送ID:" + casscode + "，库存：" + res[i].StockNum.ToString() + "，周期：" + res[i].Batch + ",本次推送金额:" + saleprice.ToString());
                        cou++;

                    }
                    strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "2b2b36889e304645b28f94bfdd2ead9e");

                    LogHelper.WriteLog("南宁云仓开思推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                    if (strRes.IndexOf("200") >= 0)
                    {
                        bus.UpdateStatus(res);
                        LogHelper.WriteLog("南宁云仓开思推送成功!共计" + res.Count + "条数据");
                    }
                }

            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("南宁云仓开思推送出现错误!Message" + ex.Message);
                throw;
            }
            #endregion

            #region 揭阳云仓库存同步开思
            try
            {
                List<StockApiEntity> res = bus.QueryYunCangStockSync(new CargoProductEntity { HouseID = 135 });
                StockApiResponseEntity entity = new StockApiResponseEntity();
                entity.Params = new Params();
                entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                entity.data = new List<Data>();

                if (res.Count > 0)
                {
                    entity.Params.firstData = true;
                    entity.Params.lastData = true;
                    entity.Params.updateMode = "CHANGE";
                    long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                    string strRes = string.Empty;
                    entity.Params.tpsBatchId = tpsBatchId;
                    int cou = 0;
                    for (int i = 0; i < res.Count; i++)
                    {
                        if (cou == 500)
                        {
                            LogHelper.WriteLog("揭阳云仓开思推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                            cou = 0;
                            strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "2b2b36889e304645b28f94bfdd2ead9e");

                            entity = new StockApiResponseEntity();
                            entity.Params = new Params();
                            entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                            entity.data = new List<Data>();
                            if (strRes.IndexOf("200") >= 0)
                            {
                                tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                entity.Params.tpsBatchId = tpsBatchId;
                                entity.Params.firstData = true;
                                entity.Params.lastData = true;
                                entity.Params.updateMode = "CHANGE";
                            }
                        }

                        string casscode = res[i].CassProductCode;
                        if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                        {
                            casscode = res[i].GoodsCode;
                        }
                        else
                        {
                            casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                        }
                        string typename = res[i].TypeName;
                        if (res[i].TypeID.Equals(9))
                        {
                            typename = "横滨/优科豪马";
                        }
                        else if (res[i].TypeID.Equals(66))
                        {
                            typename = "固铂轮胎";
                        }
                        decimal saleprice = 0.00M;
                        if (GetNanNingMarkupType().Equals(0))
                        {
                            //按百分比
                            saleprice = Math.Ceiling(res[i].SalePrice * (1 + GetNanNingMarkupPrice() / 100));

                        }
                        else
                        {
                            saleprice = res[i].SalePrice + GetNanNingMarkupPrice();
                        }
                        entity.data.Add(new Data
                        {
                            CassProductCode = casscode,
                            ProductName = res[i].ProductName,
                            TypeName = typename,
                            SalePrice = saleprice,
                            StockNum = res[i].StockNum,
                            Batch = res[i].Batch,
                            HouseID = res[i].HouseID,
                        });
                        LogHelper.WriteLog("南宁云仓开思推送ID:" + casscode + "，库存：" + res[i].StockNum.ToString() + "，周期：" + res[i].Batch + ",本次推送金额:" + saleprice.ToString());
                        cou++;

                    }
                    strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "2b2b36889e304645b28f94bfdd2ead9e");

                    LogHelper.WriteLog("南宁云仓开思推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                    if (strRes.IndexOf("200") >= 0)
                    {
                        bus.UpdateStatus(res);
                        LogHelper.WriteLog("南宁云仓开思推送成功!共计" + res.Count + "条数据");
                    }
                }

            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("南宁云仓开思推送出现错误!Message" + ex.Message);
                throw;
            }
            #endregion

        }
        /// <summary>
        /// 推送变更库存数据
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        void PushNextData_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            CargoOrderBus orderBus = new CargoOrderBus();
            CargoInterfaceBus bus = new CargoInterfaceBus();

            #region 全量向开思同步汕头，龙华和南宁库存数据
            if (DateTime.Now.Hour.Equals(1))
            {
                //每天零辰全量向开思同步库存和价格数据
                LogHelper.WriteLog("开始全量处理龙华云仓库存数据");
                #region 龙华云仓库存同步开思
                ///龙华云仓Session：1f7bd12607104fd3a152daf7c1896bb0
                try
                {
                    List<StockApiEntity> res = bus.QueryYunCangStockSync(new CargoProductEntity { HouseID = 91, SalePrice = 100 });
                    StockApiResponseEntity entity = new StockApiResponseEntity();
                    entity.Params = new Params();
                    entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                    entity.data = new List<Data>();

                    if (res.Count > 0)
                    {
                        entity.Params.firstData = true;
                        entity.Params.lastData = false;
                        entity.Params.updateMode = "ALL";
                        long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                        string strRes = string.Empty;
                        entity.Params.tpsBatchId = tpsBatchId;
                        int cou = 0;
                        for (int i = 0; i < res.Count; i++)
                        {
                            if (cou == 500)
                            {
                                cou = 0;
                                strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "1f7bd12607104fd3a152daf7c1896bb0");
                                //string cpStrRes500 = wxHttpUtility.SendPostHttpRequest("https://cp.neway5.com/Interface/OpenApi.ashx?cmd=StockDataSync", "application/json", JsonConvert.SerializeObject(entity));

                                entity = new StockApiResponseEntity();
                                entity.Params = new Params();
                                entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                entity.data = new List<Data>();
                                if (strRes.IndexOf("200") >= 0)
                                {
                                    //tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                    entity.Params.tpsBatchId = tpsBatchId;
                                    entity.Params.firstData = false;
                                    entity.Params.lastData = false;
                                    entity.Params.updateMode = "ALL";
                                }
                            }
                            string casscode = res[i].CassProductCode;
                            if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                            {
                                casscode = res[i].GoodsCode;
                            }
                            else
                            {
                                casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                            }
                            string typename = res[i].TypeName;
                            if (res[i].TypeID.Equals(9))
                            {
                                typename = "横滨/优科豪马";
                            }
                            else if (res[i].TypeID.Equals(66))
                            {
                                typename = "固铂轮胎";
                            }
                            entity.data.Add(new Data
                            {
                                CassProductCode = casscode,
                                ProductName = res[i].ProductName,
                                TypeName = typename,
                                SalePrice = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice()),
                                StockNum = res[i].StockNum,
                                Batch = res[i].Batch,
                                HouseID = res[i].HouseID,//龙华云仓+ Convert.ToDecimal(GetContiPrice())
                            });
                            //entity.data.Add(new Data
                            //{
                            //    CassProductCode = res[i].CassProductCode,
                            //    ProductName = res[i].ProductName,
                            //    TypeName = res[i].TypeName,
                            //    SalePrice = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice()),
                            //    StockNum = res[i].StockNum,
                            //    Batch = res[i].Batch,
                            //    HouseID = 91,//龙华云配仓
                            //});
                            //LogHelper.WriteLog("龙华云仓开思全量推送ID:" + tpsBatchId + ",本次推送金额:" + Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice()) + ",加价金额:" + GetContiPrice());
                            cou++;

                        }
                        entity.Params.lastData = true;
                        strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "1f7bd12607104fd3a152daf7c1896bb0");

                        // string data = JsonConvert.SerializeObject(entity);

                        //string cpStrRes = wxHttpUtility.SendPostHttpRequest("https://cp.neway5.com/Interface/OpenApi.ashx?cmd=StockDataSync", "application/json", data);

                        if (strRes.IndexOf("200") >= 0)
                        {
                            //bus.UpdateStatus(res);
                            LogHelper.WriteLog("龙华云仓开思全量推送成功!共计" + res.Count + "条数据");
                        }
                        //if (cpStrRes.IndexOf("1000") >= 0)
                        //{
                        //    //bus.UpdateStatus(res);
                        //    LogHelper.WriteLog("城配快送推送成功!共计" + res.Count + "条数据");
                        //}
                    }
                }
                catch (Exception ex)
                {
                    LogHelper.WriteLog("开思推送出现错误!Message" + ex.Message);
                    throw;
                }
                #endregion

                LogHelper.WriteLog("开始全量处理汕头云仓库存数据");
                #region 汕头仓库存同步开思
                ///汕头仓Session：67d89f8d06ca4360ae0358279b7d283c
                try
                {
                    List<StockApiEntity> res = bus.QueryYunCangStockSync(new CargoProductEntity { HouseID = 101, SalePrice = 100 });
                    //StockApiResponseEntity STentity = new StockApiResponseEntity();
                    //STentity.Params = new Params();
                    //STentity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                    //STentity.data = new List<Data>();
                    StockApiResponseEntity entity = new StockApiResponseEntity();
                    entity.Params = new Params();
                    entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                    entity.data = new List<Data>();

                    if (res.Count > 0)
                    {
                        entity.Params.firstData = true;
                        entity.Params.lastData = false;
                        entity.Params.updateMode = "ALL";
                        long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                        string strRes = string.Empty;
                        entity.Params.tpsBatchId = tpsBatchId;
                        int cou = 0;
                        for (int i = 0; i < res.Count; i++)
                        {
                            if (cou == 500)
                            {
                                cou = 0;
                                strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "67d89f8d06ca4360ae0358279b7d283c");
                                //string cpStrRes500 = wxHttpUtility.SendPostHttpRequest("https://cp.neway5.com/Interface/OpenApi.ashx?cmd=StockDataSync", "application/json", JsonConvert.SerializeObject(STentity));

                                //STentity = new StockApiResponseEntity();
                                //STentity.Params = new Params();
                                //STentity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                //STentity.data = new List<Data>();

                                entity = new StockApiResponseEntity();
                                entity.Params = new Params();
                                entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                entity.data = new List<Data>();
                                if (strRes.IndexOf("200") >= 0)
                                {
                                    //tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                    entity.Params.tpsBatchId = tpsBatchId;
                                    entity.Params.firstData = false;
                                    entity.Params.lastData = false;
                                    entity.Params.updateMode = "ALL";
                                }
                            }

                            //STentity.data.Add(new Data
                            //{
                            //    CassProductCode = res[i].ProductCode,
                            //    ProductName = res[i].ProductName,
                            //    TypeName = res[i].TypeName,
                            //    SalePrice = Convert.ToDecimal(res[i].SalePrice) + 10,
                            //    StockNum = res[i].StockNum,
                            //    Batch = res[i].Batch,
                            //    HouseID = res[i].HouseID,//汕头仓+ Convert.ToDecimal(GetContiPrice())
                            //});
                            string casscode = res[i].CassProductCode;
                            if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                            {
                                casscode = res[i].GoodsCode;
                            }
                            else
                            {
                                casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                            }
                            string typename = res[i].TypeName;
                            if (res[i].TypeID.Equals(9))
                            {
                                typename = "横滨/优科豪马";
                            }
                            else if (res[i].TypeID.Equals(66))
                            {
                                typename = "固铂轮胎";
                            }
                            decimal sp = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice());

                            entity.data.Add(new Data
                            {
                                CassProductCode = casscode,
                                ProductName = res[i].ProductName,
                                TypeName = typename,
                                SalePrice = sp,//Math.Ceiling(sp * Convert.ToDecimal(1.005)),
                                StockNum = res[i].StockNum,
                                Batch = res[i].Batch,
                                HouseID = res[i].HouseID,//汕头仓+ Convert.ToDecimal(GetContiPrice())
                            });
                            //LogHelper.WriteLog("汕头仓开思全量推送ID:" + casscode + "，库存：" + res[i].StockNum.ToString() + "，周期：" + res[i].Batch + ",本次推送金额:" + Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice()) + ",加价金额:15");
                            cou++;

                        }
                        entity.Params.lastData = true;
                        strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "67d89f8d06ca4360ae0358279b7d283c");

                        //string data = JsonConvert.SerializeObject(STentity);

                        //string cpStrRes = wxHttpUtility.SendPostHttpRequest("https://cp.neway5.com/Interface/OpenApi.ashx?cmd=StockDataSync", "application/json", data);

                        if (strRes.IndexOf("200") >= 0)
                        {
                            //bus.UpdateStatus(res);
                            LogHelper.WriteLog("汕头仓全量开思推送成功!共计" + res.Count + "条数据");
                        }
                        //if (cpStrRes.IndexOf("1000") >= 0)
                        //{
                        //    //bus.UpdateStatus(res);
                        //    LogHelper.WriteLog("汕头仓城配快送推送成功!共计" + res.Count + "条数据");
                        //}
                    }

                }
                catch (Exception ex)
                {
                    LogHelper.WriteLog("汕头仓开思推送出现错误!Message" + ex.Message);
                    throw;
                }
                #endregion

                LogHelper.WriteLog("开始全量处理南宁云仓库存数据");
                #region 南宁云仓库存同步开思
                try
                {
                    List<StockApiEntity> res = bus.QueryYunCangStockSync(new CargoProductEntity { HouseID = 136, SalePrice = 100 });
                    StockApiResponseEntity entity = new StockApiResponseEntity();
                    entity.Params = new Params();
                    entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                    entity.data = new List<Data>();

                    if (res.Count > 0)
                    {
                        entity.Params.firstData = true;
                        entity.Params.lastData = false;
                        entity.Params.updateMode = "ALL";
                        long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                        string strRes = string.Empty;
                        entity.Params.tpsBatchId = tpsBatchId;
                        int cou = 0;
                        for (int i = 0; i < res.Count; i++)
                        {
                            if (cou == 500)
                            {
                                cou = 0;
                                strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "2b2b36889e304645b28f94bfdd2ead9e");

                                entity = new StockApiResponseEntity();
                                entity.Params = new Params();
                                entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                entity.data = new List<Data>();
                                if (strRes.IndexOf("200") >= 0)
                                {
                                    //tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                    entity.Params.tpsBatchId = tpsBatchId;
                                    entity.Params.firstData = false;
                                    entity.Params.lastData = false;
                                    entity.Params.updateMode = "ALL";
                                }
                            }

                            string casscode = res[i].CassProductCode;
                            if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                            {
                                casscode = res[i].GoodsCode;
                            }
                            else
                            {
                                casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                            }
                            string typename = res[i].TypeName;
                            if (res[i].TypeID.Equals(9))
                            {
                                typename = "横滨/优科豪马";
                            }
                            else if (res[i].TypeID.Equals(66))
                            {
                                typename = "固铂轮胎";
                            }
                            decimal saleprice = 0.00M;
                            if (GetNanNingMarkupType().Equals(0))
                            {
                                //按百分比
                                saleprice = Math.Ceiling(res[i].SalePrice * (1 + GetNanNingMarkupPrice() / 100));

                            }
                            else
                            {
                                saleprice = res[i].SalePrice + GetNanNingMarkupPrice();
                            }
                            entity.data.Add(new Data
                            {
                                CassProductCode = casscode,
                                ProductName = res[i].ProductName,
                                TypeName = typename,
                                SalePrice = saleprice,
                                StockNum = res[i].StockNum,
                                Batch = res[i].Batch,
                                HouseID = res[i].HouseID,
                            });
                            //LogHelper.WriteLog("南宁云仓开思全量推送ID:" + casscode + "，库存：" + res[i].StockNum.ToString() + "，周期：" + res[i].Batch + ",本次推送金额:" + saleprice.ToString());
                            cou++;

                        }
                        entity.Params.lastData = true;
                        strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "2b2b36889e304645b28f94bfdd2ead9e");

                        if (strRes.IndexOf("200") >= 0)
                        {
                            //bus.UpdateStatus(res);
                            LogHelper.WriteLog("南宁云仓全量开思推送成功!共计" + res.Count + "条数据");
                        }
                    }

                }
                catch (Exception ex)
                {
                    LogHelper.WriteLog("南宁云仓开思推送出现错误!Message" + ex.Message);
                    throw;
                }
                #endregion

                LogHelper.WriteLog("开始全量处理揭阳云仓库存数据");
                #region 揭阳云仓库存同步开思
                try
                {
                    List<StockApiEntity> res = bus.QueryYunCangStockSync(new CargoProductEntity { HouseID = 135, SalePrice = 100 });
                    StockApiResponseEntity entity = new StockApiResponseEntity();
                    entity.Params = new Params();
                    entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                    entity.data = new List<Data>();

                    if (res.Count > 0)
                    {
                        entity.Params.firstData = true;
                        entity.Params.lastData = false;
                        entity.Params.updateMode = "ALL";
                        long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                        string strRes = string.Empty;
                        entity.Params.tpsBatchId = tpsBatchId;
                        int cou = 0;
                        for (int i = 0; i < res.Count; i++)
                        {
                            if (cou == 500)
                            {
                                cou = 0;
                                strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "a027b23d19f941a59a361268fb94ab10");

                                entity = new StockApiResponseEntity();
                                entity.Params = new Params();
                                entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                entity.data = new List<Data>();
                                if (strRes.IndexOf("200") >= 0)
                                {
                                    //tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                    entity.Params.tpsBatchId = tpsBatchId;
                                    entity.Params.firstData = false;
                                    entity.Params.lastData = false;
                                    entity.Params.updateMode = "ALL";
                                }
                            }

                            string casscode = res[i].CassProductCode;
                            if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                            {
                                casscode = res[i].GoodsCode;
                            }
                            else
                            {
                                casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                            }
                            string typename = res[i].TypeName;
                            if (res[i].TypeID.Equals(9))
                            {
                                typename = "横滨/优科豪马";
                            }
                            else if (res[i].TypeID.Equals(66))
                            {
                                typename = "固铂轮胎";
                            }
                            //decimal saleprice = 0.00M;
                            //if (GetNanNingMarkupType().Equals(0))
                            //{
                            //    //按百分比
                            //    saleprice = Math.Ceiling(res[i].SalePrice * (1 + GetNanNingMarkupPrice() / 100));

                            //}
                            //else
                            //{
                            //    saleprice = res[i].SalePrice + GetNanNingMarkupPrice();
                            //}
                            entity.data.Add(new Data
                            {
                                CassProductCode = casscode,
                                ProductName = res[i].ProductName,
                                TypeName = typename,
                                SalePrice = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice()),
                                StockNum = res[i].StockNum,
                                Batch = res[i].Batch,
                                HouseID = res[i].HouseID,
                            });
                            cou++;

                        }
                        entity.Params.lastData = true;
                        strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "a027b23d19f941a59a361268fb94ab10");

                        if (strRes.IndexOf("200") >= 0)
                        {
                            //bus.UpdateStatus(res);
                            LogHelper.WriteLog("揭阳云仓全量开思推送成功!共计" + res.Count + "条数据");
                        }
                    }

                }
                catch (Exception ex)
                {
                    LogHelper.WriteLog("揭阳云仓开思推送出现错误!Message" + ex.Message);
                    throw;
                }
                #endregion

                LogHelper.WriteLog("开始全量处理东平和从化云仓库存数据");
                #region 东平和从化云仓库存同步开思
                try
                {
                    List<StockApiEntity> resCH = bus.QueryYunCangStockSync(new CargoProductEntity { HouseID = 107, SalePrice = 100 });
                    List<StockApiEntity> res = bus.QueryYunCangStockSync(new CargoProductEntity { HouseID = 93, SalePrice = 100 });
                    res.AddRange(resCH);
                    StockApiResponseEntity entity = new StockApiResponseEntity();
                    entity.Params = new Params();
                    entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                    entity.data = new List<Data>();

                    if (res.Count > 0)
                    {
                        entity.Params.firstData = true;
                        entity.Params.lastData = false;
                        entity.Params.updateMode = "ALL";
                        long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                        string strRes = string.Empty;
                        entity.Params.tpsBatchId = tpsBatchId;
                        int cou = 0;
                        for (int i = 0; i < res.Count; i++)
                        {
                            if (cou == 500)
                            {
                                cou = 0;
                                strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "43b87acafffe4919926ec17de7b6f930");

                                entity = new StockApiResponseEntity();
                                entity.Params = new Params();
                                entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                entity.data = new List<Data>();
                                if (strRes.IndexOf("200") >= 0)
                                {
                                    //tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                    entity.Params.tpsBatchId = tpsBatchId;
                                    entity.Params.firstData = false;
                                    entity.Params.lastData = false;
                                    entity.Params.updateMode = "ALL";
                                }
                            }

                            string casscode = res[i].CassProductCode;
                            if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                            {
                                casscode = res[i].GoodsCode;
                            }
                            else
                            {
                                casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                            }
                            string typename = res[i].TypeName;
                            if (res[i].TypeID.Equals(9))
                            {
                                typename = "横滨/优科豪马";
                            }
                            else if (res[i].TypeID.Equals(66))
                            {
                                typename = "固铂轮胎";
                            }
                            //decimal saleprice = 0.00M;
                            //if (GetNanNingMarkupType().Equals(0))
                            //{
                            //    //按百分比
                            //    saleprice = Math.Ceiling(res[i].SalePrice * (1 + GetNanNingMarkupPrice() / 100));

                            //}
                            //else
                            //{
                            //    saleprice = res[i].SalePrice + GetNanNingMarkupPrice();
                            //}
                            entity.data.Add(new Data
                            {
                                CassProductCode = casscode,
                                ProductName = res[i].ProductName,
                                TypeName = typename,
                                SalePrice = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(15),//GetContiPrice()
                                StockNum = res[i].StockNum,
                                Batch = res[i].Batch,
                                HouseID = res[i].HouseID,
                            });
                            cou++;

                        }
                        entity.Params.lastData = true;
                        strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "43b87acafffe4919926ec17de7b6f930");

                        if (strRes.IndexOf("200") >= 0)
                        {
                            //bus.UpdateStatus(res);
                            LogHelper.WriteLog("东平云仓全量开思推送成功!共计" + res.Count + "条数据");
                        }
                    }

                }
                catch (Exception ex)
                {
                    LogHelper.WriteLog("东平云仓开思推送出现错误!Message" + ex.Message);
                    throw;
                }
                #endregion

                //LogHelper.WriteLog("开始全量处理从化云仓库存数据");
                //#region 从化云仓库存同步开思
                //try
                //{
                //    List<StockApiEntity> res = bus.QueryYunCangStockSync(new CargoProductEntity { HouseID = 107, SalePrice = 100 });
                //    StockApiResponseEntity entity = new StockApiResponseEntity();
                //    entity.Params = new Params();
                //    entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                //    entity.data = new List<Data>();

                //    if (res.Count > 0)
                //    {
                //        entity.Params.firstData = true;
                //        entity.Params.lastData = false;
                //        entity.Params.updateMode = "ALL";
                //        long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                //        string strRes = string.Empty;
                //        entity.Params.tpsBatchId = tpsBatchId;
                //        int cou = 0;
                //        for (int i = 0; i < res.Count; i++)
                //        {
                //            if (cou == 500)
                //            {
                //                cou = 0;
                //                strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "43b87acafffe4919926ec17de7b6f930");

                //                entity = new StockApiResponseEntity();
                //                entity.Params = new Params();
                //                entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                //                entity.data = new List<Data>();
                //                if (strRes.IndexOf("200") >= 0)
                //                {
                //                    //tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                //                    entity.Params.tpsBatchId = tpsBatchId;
                //                    entity.Params.firstData = false;
                //                    entity.Params.lastData = false;
                //                    entity.Params.updateMode = "ALL";
                //                }
                //            }

                //            string casscode = res[i].CassProductCode;
                //            if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                //            {
                //                casscode = res[i].GoodsCode;
                //            }
                //            else
                //            {
                //                casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                //            }
                //            string typename = res[i].TypeName;
                //            if (res[i].TypeID.Equals(9))
                //            {
                //                typename = "横滨/优科豪马";
                //            }
                //            else if (res[i].TypeID.Equals(66))
                //            {
                //                typename = "固铂轮胎";
                //            }
                //            //decimal saleprice = 0.00M;
                //            //if (GetNanNingMarkupType().Equals(0))
                //            //{
                //            //    //按百分比
                //            //    saleprice = Math.Ceiling(res[i].SalePrice * (1 + GetNanNingMarkupPrice() / 100));

                //            //}
                //            //else
                //            //{
                //            //    saleprice = res[i].SalePrice + GetNanNingMarkupPrice();
                //            //}
                //            entity.data.Add(new Data
                //            {
                //                CassProductCode = casscode,
                //                ProductName = res[i].ProductName,
                //                TypeName = typename,
                //                SalePrice = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(15),//GetContiPrice()
                //                StockNum = res[i].StockNum,
                //                Batch = res[i].Batch,
                //                HouseID = res[i].HouseID,
                //            });
                //            cou++;

                //        }
                //        entity.Params.lastData = true;
                //        strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "43b87acafffe4919926ec17de7b6f930");

                //        if (strRes.IndexOf("200") >= 0)
                //        {
                //            //bus.UpdateStatus(res);
                //            LogHelper.WriteLog("从化云仓全量开思推送成功!共计" + res.Count + "条数据");
                //        }
                //    }

                //}
                //catch (Exception ex)
                //{
                //    LogHelper.WriteLog("从化云仓开思推送出现错误!Message" + ex.Message);
                //    throw;
                //}
                //#endregion
            }
            #endregion

            #region 作废华南配件仓库超过72小时未付款订货单
            try
            {
                LogEntity log = new LogEntity();
                log.IPAddress = "";
                log.Moudle = "服务管理";
                log.Status = "0";
                log.NvgPage = "作废未结算订单";
                log.UserID = RobotID;
                log.Operate = "D";
                List<CargoOrderEntity> orderList = orderBus.QueryOrderDataInfo(new CargoOrderEntity { HouseID = 82, CheckStatus = "0", ThrowGood = "21", AwbStatus = "0", CreateDate = DateTime.Now.AddHours(-72) });
                List<CargoOrderEntity> list = new List<CargoOrderEntity>();
                foreach (CargoOrderEntity item in orderList)
                {
                    list.Add(new CargoOrderEntity
                    {
                        OrderID = item.OrderID,
                        OrderNo = item.OrderNo,
                        Dep = item.Dep,
                        Dest = item.Dest,
                        Piece = item.Piece,
                        TransportFee = item.TransportFee,
                        TransitFee = item.TransitFee,
                        DeliveryFee = item.DeliveryFee,
                        InsuranceFee = item.InsuranceFee,
                        OtherFee = item.OtherFee,
                        TotalCharge = item.TotalCharge,
                        AcceptUnit = item.AcceptUnit,
                        AcceptPeople = item.AcceptPeople,
                        AcceptTelephone = item.AcceptTelephone,
                        AcceptCellphone = item.AcceptCellphone,
                        AcceptAddress = item.AcceptAddress,
                        SaleManName = item.SaleManName,
                        CreateAwb = item.CreateAwb,
                        CreateAwbID = item.CreateAwbID,
                        CreateDate = item.CreateDate,
                        LogisAwbNo = item.LogisAwbNo,
                        LogisticName = item.LogisticName,
                        WXOrderNo = item.WXOrderNo,
                        OutHouseName = item.OutHouseName,
                        Remark = item.Remark,
                        ThrowGood = item.ThrowGood,
                        HouseID = item.HouseID,
                        TrafficType = item.TrafficType,
                        DeleteID = RobotID,
                        DeleteName = RobotName,
                        PayClientNum = item.PayClientNum,
                    });

                    //仓库同步缓存
                    CargoHouseBus house = new CargoHouseBus();
                    List<CargoProductEntity> syncProduct = house.SyncTypeOrderNo(item.OrderNo);
                    foreach (CargoProductEntity product in syncProduct)
                    {

                        if (product.SyncType == "2" || (product.SyncType == "1" && product.TypeID == 34))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + product.HouseID + "_" + product.TypeID + "_" + product.ProductCode + "", product.GoodsCode);
                        }
                    }
                }
                orderBus.DeleteOrderInfo(list, log);
            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("定时作废超过72小时未结算订单失败，错误信息" + ex.Message);
            }
            #endregion

            #region 向云配推送数据
            //CargoInterfaceBus bus = new CargoInterfaceBus();
            //List<CargoInterfaceEntity> List = bus.QueryChangeStock();
            //Dictionary<string, object> pairs = new Dictionary<string, object>();
            //string updateMode = string.Empty;
            //NextChangeStock nextChange = new NextChangeStock();
            //JavaScriptSerializer js = new JavaScriptSerializer();
            //List = (from a in List
            //        where a.StockNum > 0
            //        select a).ToList();
            //if (DateTime.Now.Hour == 0)//每日0点全量推送
            //{
            //    updateMode = "ALL";
            //}
            //else
            //{
            //    updateMode = "CHANGE";//否则增量推送
            //}
            //try
            //{
            //    if (List.Count > 0)
            //    {
            //        pairs.Add("updateMode", updateMode);
            //        int pageNum = 1;
            //        int num = 1;
            //        string result = string.Empty;
            //        List<Dictionary<string, object>> data = new List<Dictionary<string, object>>();
            //        string PushBatchID = Guid.NewGuid().ToString();
            //        for (int i = 0; i < List.Count; i++)
            //        {
            //            if (num == 300)
            //            {
            //                pairs.Add("data", data);
            //                pairs.Add("pageNum", pageNum);
            //                result = wxHttpUtility.NextDataPostHttpRequest("http://gys.cmy123.cn/api/crdgoods/push_save", JSON.Encode(pairs));
            //                pairs = new Dictionary<string, object>();
            //                data = new List<Dictionary<string, object>>();
            //                num = 1;
            //                pairs.Add("updateMode", updateMode);
            //                pageNum++;
            //                LogHelper.WriteLog("----------\n次日达数据推送结果:" + result + "本次推送第" + pageNum + "页，推送批次ID:" + PushBatchID + "----------\n");
            //                nextChange = js.Deserialize<NextChangeStock>(result);
            //                if (nextChange.data.failRow == 0)
            //                {
            //                    LogHelper.WriteLog("----------\n次日达数据推送成功推送批次ID:" + PushBatchID + "----------\n");
            //                }
            //                else
            //                {
            //                    LogHelper.WriteLog("----------\n次日达数据推送数据错误推送批次ID:" + PushBatchID + ",错误数据:" + nextChange.data.failRow + "----------\n");
            //                }
            //                bus.UpdateChangeStock(List);
            //                PushBatchID = Guid.NewGuid().ToString();
            //                Thread.Sleep(300000);//五分钟执行一次
            //            }
            //            else
            //            {
            //                List[i].PushBatchID = PushBatchID;
            //                data.Add(new Dictionary<string, object>
            //                {
            //                    {"goodsCode",List[i].ProductCode },
            //                    {"makeDate",List[i].Batch },
            //                    {"qty",List[i].StockNum },
            //                    {"salesPrice",List[i].SalePrice },
            //                });
            //                num++;
            //            }
            //        }
            //        pairs.Add("data", data);
            //        pairs.Add("pageNum", pageNum);
            //        result = wxHttpUtility.NextDataPostHttpRequest("http://gys.cmy123.cn/api/crdgoods/push_save", JSON.Encode(pairs));
            //        LogHelper.WriteLog("----------\n次日达数据推送结果:" + result + "本次推送第" + pageNum + "页，推送批次ID:" + PushBatchID + "----------\n");
            //        nextChange = js.Deserialize<NextChangeStock>(result);
            //        if (nextChange.data.failRow == 0)
            //        {
            //            LogHelper.WriteLog("----------\n次日达数据推送成功推送批次ID:" + PushBatchID + "----------\n");
            //        }
            //        else
            //        {
            //            LogHelper.WriteLog("----------\n次日达数据推送数据错误推送批次ID:" + PushBatchID + ",错误数据:" + nextChange.data.failRow + "----------\n");
            //        }
            //        bus.UpdateChangeStock(List);

            //    }
            //}
            //catch (Exception)
            //{

            //    throw;
            //}
            #endregion
        }
        private string GetContiUrl()
        {
            return ConfigurationSettings.AppSettings["ContiUrl"];
        }
        private string GetContiStockSync()
        {
            return ConfigurationSettings.AppSettings["ContiStockSync"];
        }
        private string GetContiOutHouseOrderSync()
        {
            return ConfigurationSettings.AppSettings["ContiOutHouseOrderSync"];
        }
        private decimal GetContiPrice()
        {
            return Convert.ToDecimal(ConfigurationSettings.AppSettings["MarkupPrice"]);
        }

        /// <summary>
        /// 南宁云仓加价类型
        /// </summary>
        /// <returns></returns>
        private int GetNanNingMarkupType()
        {
            return Convert.ToInt32(ConfigurationSettings.AppSettings["NanNingMarkupType"]);
        }
        /// <summary>
        /// 南宁云仓加价百分比或加价金额
        /// </summary>
        /// <returns></returns>
        private decimal GetNanNingMarkupPrice()
        {
            return Convert.ToDecimal(ConfigurationSettings.AppSettings["NanNingMarkupPrice"]);
        }
        private string GetContiStockDOTSync()
        {
            return ConfigurationSettings.AppSettings["ContiStockDOTSync"];
        }
        private string GetContiOrderSync()
        {
            return ConfigurationSettings.AppSettings["ContiOrderSync"];
        }
        /// <summary>
        /// 马牌接口订单计时器
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        void ContiTime_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            //机器人账号
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "马牌定时服务";
            log.UserID = RobotID;
            log.Operate = "A";

            #region 马牌同步库存旧接口，只同步库存不同步DOT

            //// 批量获取订单详情
            //String body = "{\"cusorId\":1,\"size\":20}";
            //// 批量获取订单详情的url
            //String url = "https://merchant-demo.yunquecloud.com/api/saas-dms-admin/remote/openPlatform/saleOrderList";  
            //string contiUrl = GetContiUrl() + GetContiStockSync();
            //#region 零辰1点触发马牌和维京库存数据同步
            //if (DateTime.Now.Hour.Equals(1))
            //{
            //    CargoContiStockSyncEntity stockSync = new CargoContiStockSyncEntity();
            //    stockSync.outNo = Guid.NewGuid().ToString().Replace("-", "");
            //    List<CargoContiStockListEntity> stockList = new List<CargoContiStockListEntity>();
            //    List<CargoContiStockSKUEntity> sKUEntities = new List<CargoContiStockSKUEntity>();//东莞
            //    List<CargoContiStockSKUEntity> SZsKUEntities = new List<CargoContiStockSKUEntity>();//深圳
            //    List<CargoContiStockSKUEntity> JYsKUEntities = new List<CargoContiStockSKUEntity>();//揭阳
            //    List<CargoContiStockSKUEntity> GZsKUEntities = new List<CargoContiStockSKUEntity>();//广州
            //    List<CargoContiStockSKUEntity> HNsKUEntities = new List<CargoContiStockSKUEntity>();//华南二仓
            //    //维京
            //    //List<CargoContiStockSKUEntity> dgWjEntity = new List<CargoContiStockSKUEntity>();
            //    //List<CargoContiStockSKUEntity> gzWjEntity = new List<CargoContiStockSKUEntity>();
            //    //List<CargoContiStockSKUEntity> jyWjEntity = new List<CargoContiStockSKUEntity>();

            //    CargoInterfaceBus interBus = new CargoInterfaceBus();
            //    //广东仓下的东莞仓和深圳仓
            //    List<CargoSafeStockEntity> stockEntities = interBus.QueryContiStockData(new CargoSafeStockEntity { HouseID = "45" });
            //    if (stockEntities.Count > 0)
            //    {
            //        foreach (var stock in stockEntities)
            //        {
            //            if (string.IsNullOrEmpty(stock.GoodsCode) || stock.GoodsCode.Length < 7) { continue; }
            //            if (stock.AreaID.Equals(2843))
            //            {
            //                //东莞仓马牌和维京
            //                if (sKUEntities.Exists(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7))))
            //                {
            //                    CargoContiStockSKUEntity existEntity = sKUEntities.Find(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7)));
            //                    existEntity.qty += stock.StockNum;
            //                }
            //                else
            //                {
            //                    sKUEntities.Add(new CargoContiStockSKUEntity
            //                    {
            //                        skuCode = stock.GoodsCode.Substring(0, 7),
            //                        qty = stock.StockNum
            //                    });
            //                }
            //                //if (stock.TypeID.Equals(34))
            //                //{
            //                //    sKUEntities.Add(new CargoContiStockSKUEntity
            //                //    {
            //                //        skuCode = stock.GoodsCode.Substring(0, 7),
            //                //        qty = stock.StockNum
            //                //    });
            //                //}
            //                //else if (stock.TypeID.Equals(345))
            //                //{
            //                //    //东莞维京
            //                //    dgWjEntity.Add(new CargoContiStockSKUEntity
            //                //    {
            //                //        skuCode = stock.GoodsCode.Substring(0, 7),
            //                //        qty = stock.StockNum
            //                //    });
            //                //}

            //            }
            //            else if (stock.AreaID.Equals(3241))
            //            {
            //                //深圳仓
            //                if (SZsKUEntities.Exists(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7))))
            //                {
            //                    CargoContiStockSKUEntity existEntity = SZsKUEntities.Find(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7)));
            //                    existEntity.qty += stock.StockNum;
            //                }
            //                else
            //                {
            //                    SZsKUEntities.Add(new CargoContiStockSKUEntity
            //                    {
            //                        skuCode = stock.GoodsCode.Substring(0, 7),
            //                        qty = stock.StockNum
            //                    });
            //                }

            //                //if (stock.TypeID.Equals(34))
            //                //{
            //                //    SZsKUEntities.Add(new CargoContiStockSKUEntity
            //                //    {
            //                //        skuCode = stock.GoodsCode.Substring(0, 7),
            //                //        qty = stock.StockNum
            //                //    });
            //                //}
            //            }
            //        }
            //    }

            //    stockList.Add(new CargoContiStockListEntity
            //    {
            //        warehouseName = "厚街仓",
            //        skuQtyList = sKUEntities
            //    });
            //    //stockList.Add(new CargoContiStockListEntity
            //    //{
            //    //    warehouseName = "维京东莞仓",
            //    //    skuQtyList = dgWjEntity
            //    //});
            //    stockList.Add(new CargoContiStockListEntity
            //    {
            //        warehouseName = "深圳龙华仓库",
            //        skuQtyList = SZsKUEntities
            //    });
            //    stockSync.stockList = stockList;
            //    String body = JSON.Encode(stockSync);
            //    try
            //    {
            //        string res = wxHttpUtility.ContiSendPostHttpRequest(contiUrl, "application/json", body);
            //        LogHelper.WriteLog("东莞和深圳马牌维京库存同步成功");
            //    }
            //    catch (ApplicationException ex)
            //    {
            //        LogHelper.WriteLog("东莞和深圳马牌维京库存同步失败");
            //    }

            //    //揭阳仓
            //    stockSync = new CargoContiStockSyncEntity();
            //    stockSync.outNo = Guid.NewGuid().ToString().Replace("-", "");
            //    stockList = new List<CargoContiStockListEntity>();
            //    List<CargoSafeStockEntity> jyStock = interBus.QueryContiStockData(new CargoSafeStockEntity { HouseID = "44" });
            //    if (jyStock.Count > 0)
            //    {
            //        foreach (var stock in jyStock)
            //        {
            //            //揭阳仓马牌和维京
            //            if (string.IsNullOrEmpty(stock.GoodsCode) || stock.GoodsCode.Length < 7) { continue; }

            //            if (JYsKUEntities.Exists(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7))))
            //            {
            //                CargoContiStockSKUEntity existEntity = JYsKUEntities.Find(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7)));
            //                existEntity.qty += stock.StockNum;
            //            }
            //            else
            //            {
            //                JYsKUEntities.Add(new CargoContiStockSKUEntity
            //                {
            //                    skuCode = stock.GoodsCode.Substring(0, 7),
            //                    qty = stock.StockNum
            //                });
            //            }
            //            //if (stock.TypeID.Equals(34))
            //            //{
            //            //    JYsKUEntities.Add(new CargoContiStockSKUEntity
            //            //    {
            //            //        skuCode = stock.GoodsCode.Substring(0, 7),
            //            //        qty = stock.StockNum
            //            //    });
            //            //}
            //            //else if (stock.TypeID.Equals(345))
            //            //{
            //            //    jyWjEntity.Add(new CargoContiStockSKUEntity
            //            //    {
            //            //        skuCode = stock.GoodsCode.Substring(0, 7),
            //            //        qty = stock.StockNum
            //            //    });
            //            //}
            //        }
            //    }
            //    stockList.Add(new CargoContiStockListEntity
            //    {
            //        warehouseName = "揭阳仓",
            //        skuQtyList = JYsKUEntities
            //    });
            //    //stockList.Add(new CargoContiStockListEntity
            //    //{
            //    //    warehouseName = "维京揭阳仓",
            //    //    skuQtyList = jyWjEntity
            //    //});
            //    stockSync.stockList = stockList;
            //    body = JSON.Encode(stockSync);
            //    try
            //    {
            //        string res = wxHttpUtility.ContiSendPostHttpRequest(contiUrl, "application/json", body);
            //        LogHelper.WriteLog("揭阳马牌维京库存同步成功");
            //    }
            //    catch (ApplicationException ex)
            //    {
            //        LogHelper.WriteLog("揭阳马牌维京库存同步失败");
            //    }

            //    //广州仓
            //    stockSync = new CargoContiStockSyncEntity();
            //    stockSync.outNo = Guid.NewGuid().ToString().Replace("-", "");
            //    stockList = new List<CargoContiStockListEntity>();
            //    List<CargoSafeStockEntity> hnStock = interBus.QueryGZContiStockData(new CargoSafeStockEntity { HouseID = "9" });
            //    if (hnStock.Count > 0)
            //    {
            //        foreach (var stock in hnStock)
            //        {
            //            if (string.IsNullOrEmpty(stock.GoodsCode) || stock.GoodsCode.Length < 7) { continue; }
            //            //广州仓马牌

            //            if (GZsKUEntities.Exists(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7))))
            //            {
            //                CargoContiStockSKUEntity existEntity = GZsKUEntities.Find(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7)));
            //                existEntity.qty += stock.StockNum;
            //            }
            //            else
            //            {
            //                GZsKUEntities.Add(new CargoContiStockSKUEntity
            //                {
            //                    skuCode = stock.GoodsCode.Substring(0, 7),
            //                    qty = stock.StockNum
            //                });
            //            }
            //            //if (stock.TypeID.Equals(34))
            //            //{
            //            //    GZsKUEntities.Add(new CargoContiStockSKUEntity
            //            //    {
            //            //        skuCode = stock.GoodsCode.Substring(0, 7),
            //            //        qty = stock.StockNum
            //            //    });
            //            //}
            //            //else if (stock.TypeID.Equals(345))
            //            //{
            //            //    gzWjEntity.Add(new CargoContiStockSKUEntity
            //            //    {
            //            //        skuCode = stock.GoodsCode.Substring(0, 7),
            //            //        qty = stock.StockNum
            //            //    });
            //            //}
            //        }
            //    }
            //    stockList.Add(new CargoContiStockListEntity
            //    {
            //        warehouseName = "广州仓",
            //        skuQtyList = GZsKUEntities
            //    });
            //    //stockList.Add(new CargoContiStockListEntity
            //    //{
            //    //    warehouseName = "维京广州仓",
            //    //    skuQtyList = gzWjEntity
            //    //});
            //    stockSync.stockList = stockList;
            //    body = JSON.Encode(stockSync);
            //    try
            //    {
            //        string res = wxHttpUtility.ContiSendPostHttpRequest(contiUrl, "application/json", body);
            //        LogHelper.WriteLog("广州马牌维京库存同步成功");
            //    }
            //    catch (ApplicationException ex)
            //    {
            //        LogHelper.WriteLog("广州马牌维京库存同步失败");
            //    }

            //    //华南配件二仓
            //    stockSync = new CargoContiStockSyncEntity();
            //    stockSync.outNo = Guid.NewGuid().ToString().Replace("-", "");
            //    stockList = new List<CargoContiStockListEntity>();
            //    List<CargoSafeStockEntity> gzStock = interBus.QueryGZContiStockData(new CargoSafeStockEntity { HouseID = "84" });
            //    if (gzStock.Count > 0)
            //    {
            //        foreach (var stock in gzStock)
            //        {
            //            if (string.IsNullOrEmpty(stock.GoodsCode) || stock.GoodsCode.Length < 7) { continue; }
            //            //广州仓马牌

            //            if (HNsKUEntities.Exists(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7))))
            //            {
            //                CargoContiStockSKUEntity existEntity = HNsKUEntities.Find(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7)));
            //                existEntity.qty += stock.StockNum;
            //            }
            //            else
            //            {
            //                HNsKUEntities.Add(new CargoContiStockSKUEntity
            //                {
            //                    skuCode = stock.GoodsCode.Substring(0, 7),
            //                    qty = stock.StockNum
            //                });
            //            }
            //        }
            //    }
            //    stockList.Add(new CargoContiStockListEntity
            //    {
            //        warehouseName = "华南二仓",
            //        skuQtyList = HNsKUEntities
            //    });
            //    //stockList.Add(new CargoContiStockListEntity
            //    //{
            //    //    warehouseName = "维京广州仓",
            //    //    skuQtyList = gzWjEntity
            //    //});
            //    stockSync.stockList = stockList;
            //    body = JSON.Encode(stockSync);
            //    try
            //    {
            //        string res = wxHttpUtility.ContiSendPostHttpRequest(contiUrl, "application/json", body);
            //        LogHelper.WriteLog("华南二仓马牌维京库存同步成功");
            //    }
            //    catch (ApplicationException ex)
            //    {
            //        LogHelper.WriteLog("华南二仓马牌维京库存同步失败");
            //    }
            //}
            //#endregion
            #endregion
            CargoInterfaceBus interBus = new CargoInterfaceBus();

            #region 马牌同步库存新接口，同步库存和DOT
            string contiUrl = GetContiUrl() + GetContiStockDOTSync();

            //马牌仓库名称字典
            Dictionary<string, string> dicContiHouseName = new Dictionary<string, string>();
            //dicContiHouseName.Add("45", "深圳龙岗众汇前置仓");
            dicContiHouseName.Add("135", "揭阳仓");//智能系统揭阳云仓
            //dicContiHouseName.Add("93,9", "广州仓");
            dicContiHouseName.Add("93", "广州仓");//东平云仓
            //dicContiHouseName.Add("84", "华南二仓");
            dicContiHouseName.Add("97", "华南二仓");//增城云仓
            dicContiHouseName.Add("91", "深圳龙华云配仓库");//龙华云仓
            dicContiHouseName.Add("101", "汕头仓库");
            dicContiHouseName.Add("106", "南沙仓库");
            dicContiHouseName.Add("107", "从化仓库");
            //dicContiHouseName.Add("108", "佛山南海云仓");
            //dicContiHouseName.Add("120", "深圳宝安南山仓库");
            dicContiHouseName.Add("129", "花都仓库");//花都云仓
            dicContiHouseName.Add("138", "肇庆仓库");//肇庆云仓
            dicContiHouseName.Add("132", "深圳光明仓");//光明云仓

            foreach (var conti in dicContiHouseName)
            {
                CargoContiStockSyncEntity stockSync = new CargoContiStockSyncEntity();
                stockSync.outNo = Guid.NewGuid().ToString().Replace("-", "");
                List<CargoContiStockListEntity> stockList = new List<CargoContiStockListEntity>();
                List<CargoContiStockSKUEntity> sKUEntities = new List<CargoContiStockSKUEntity>();
                if (conti.Key.Equals("45"))
                {
                    stockSync = new CargoContiStockSyncEntity();
                    stockSync.outNo = Guid.NewGuid().ToString().Replace("-", "");
                    stockList = new List<CargoContiStockListEntity>();
                    sKUEntities = new List<CargoContiStockSKUEntity>();
                    List<CargoSafeStockEntity> stockEntities = interBus.QueryContiStockData(new CargoSafeStockEntity { HouseID = conti.Key });
                    if (stockEntities.Count > 0)
                    {
                        foreach (var stock in stockEntities)
                        {
                            if (string.IsNullOrEmpty(stock.GoodsCode) || stock.GoodsCode.Length < 7) { continue; }
                            if (stock.AreaID.Equals(3446))
                            {
                                //众汇前置仓马牌和维京
                                if (sKUEntities.Exists(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7))))
                                {
                                    CargoContiStockSKUEntity existEntity = sKUEntities.Find(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7)));
                                    existEntity.dots.Add(new CargoContiStockDOTEntity { dot = stock.Batch, qty = stock.StockNum });
                                }
                                else
                                {
                                    sKUEntities.Add(new CargoContiStockSKUEntity
                                    {
                                        skuCode = stock.GoodsCode.Substring(0, 7),
                                        dots = new List<CargoContiStockDOTEntity> { new CargoContiStockDOTEntity { dot = stock.Batch, qty = stock.StockNum } }
                                    }); ;
                                }
                            }
                        }
                    }
                    //众汇前置仓
                    stockList.Add(new CargoContiStockListEntity
                    {

                        warehouseName = conti.Value,// "深圳龙岗众汇前置仓",
                        skuQtyList = sKUEntities
                    });

                    stockSync.stockList = stockList;
                    String body = JSON.Encode(stockSync);
                    try
                    {
                        string res = wxHttpUtility.ContiSendPostHttpRequest(contiUrl, "application/json", body);
                        LogHelper.WriteLog("马牌维京库存同步成功");
                    }
                    catch (ApplicationException ex)
                    {
                        LogHelper.WriteLog("马牌维京库存同步失败");
                    }
                }
                else
                {

                    //广州仓,东平云仓，南沙，从化，花都，肇庆,106,107,129,131
                    stockSync = new CargoContiStockSyncEntity();
                    stockSync.outNo = Guid.NewGuid().ToString().Replace("-", "");
                    stockList = new List<CargoContiStockListEntity>();
                    sKUEntities = new List<CargoContiStockSKUEntity>();
                    List<CargoSafeStockEntity> hnStock = interBus.QueryGZContiStockData(new CargoSafeStockEntity { HouseIDStr = conti.Key });
                    if (hnStock.Count > 0)
                    {
                        foreach (var stock in hnStock)
                        {
                            if (string.IsNullOrEmpty(stock.GoodsCode) || stock.GoodsCode.Length < 7) { continue; }
                            //广州仓马牌

                            if (sKUEntities.Exists(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7))))
                            {
                                CargoContiStockSKUEntity existEntity = sKUEntities.Find(c => c.skuCode.Equals(stock.GoodsCode.Substring(0, 7)));
                                existEntity.dots.Add(new CargoContiStockDOTEntity { dot = stock.Batch, qty = stock.StockNum });
                                //existEntity.qty += stock.StockNum;
                            }
                            else
                            {
                                sKUEntities.Add(new CargoContiStockSKUEntity
                                {
                                    skuCode = stock.GoodsCode.Substring(0, 7),
                                    dots = new List<CargoContiStockDOTEntity> { new CargoContiStockDOTEntity { dot = stock.Batch, qty = stock.StockNum } }
                                    //qty = stock.StockNum
                                });
                            }
                        }
                    }
                    stockList.Add(new CargoContiStockListEntity
                    {
                        warehouseName = conti.Value,//"广州仓",
                        skuQtyList = sKUEntities
                    });
                    stockSync.stockList = stockList;
                    string body = JSON.Encode(stockSync);
                    try
                    {
                        string res = wxHttpUtility.ContiSendPostHttpRequest(contiUrl, "application/json", body);
                        LogHelper.WriteLog(conti.Value + "马牌维京库存同步成功");
                    }
                    catch (ApplicationException ex)
                    {
                        LogHelper.WriteLog(conti.Value + "马牌维京库存同步失败");
                    }
                }

                if (conti.Key.Equals("107"))
                {
                    Thread.Sleep(20000);
                }
            }




            #endregion

        }
        void OrderPushTime_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            //机器人账号
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "定单推送服务";
            log.UserID = RobotID;
            log.Operate = "A";
            CargoOrderBus order = new CargoOrderBus();

            #region 推送全国统采订单
            //每天上午10点半，下午2点半，5点推送统采订单
            if (DateTime.Now.ToString("HH:mm").Equals("10:30") || DateTime.Now.ToString("HH:mm").Equals("14:30") || DateTime.Now.ToString("HH:mm").Equals("17:00"))
            {
                List<CargoOrderEntity> oesOrderList = order.QueryOrderDataInfo(new CargoOrderEntity { StartDate = DateTime.Now.AddDays(-10), TrafficType = "2", PostponeShip = "-1" });
                if (oesOrderList.Count > 0)
                {
                    foreach (var it in oesOrderList)
                    {
                        try
                        {
                            //1.保存订单数据到好来运Tbl_ProductOrder表
                            //2.推送提货通知
                            List<CargoContainerShowEntity> orderContainerList = order.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = it.OrderNo });
                            //CargoOrderEntity orderEnt = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = it.OrderNo });
                            order.SaveHlyOrderData(orderContainerList, it);

                            List<CargoContainerShowEntity> cargoShow = order.QueryOesPreOrderByOrderNo(new CargoOrderEntity { OrderNo = it.OrderNo });
                            //采购订单 向好来运企业微信推送提货通知
                            if (cargoShow.Count > 0)
                            {
                                int TPiece = 0;
                                int tag = 2;
                                switch (cargoShow[0].HouseID)
                                {
                                    case 9: tag = 2; break;//广州
                                    case 91: tag = 2; break;//广州
                                    case 97: tag = 2; break;//广州
                                    case 106: tag = 2; break;//广州
                                    case 107: tag = 2; break;//广州
                                    case 129: tag = 2; break;//广州
                                    case 31: tag = 4; break;//北京
                                    case 109: tag = 4; break;//北京
                                    case 24: tag = 33; break;//福州
                                    case 123: tag = 33; break;//福州
                                    case 25: tag = 5; break;//常熟
                                    case 118: tag = 5; break;//常熟
                                    case 14: tag = 6; break;//成都
                                    case 121: tag = 6; break;//成都
                                    case 32: tag = 8; break;//杭州
                                    case 119: tag = 8; break;//杭州
                                    case 69: tag = 9; break;//合肥
                                    case 29: tag = 10; break;//济南
                                    case 114: tag = 10; break;//济南
                                    case 70: tag = 12; break;//兰州
                                    case 124: tag = 12; break;//兰州
                                    case 68: tag = 13; break;//南昌
                                    case 55: tag = 20; break;//厦门
                                    case 15: tag = 14; break;//上海
                                    case 117: tag = 14; break;//上海
                                    case 23: tag = 15; break;//沈阳
                                    case 113: tag = 15; break;//沈阳
                                    case 30: tag = 16; break;//武汉
                                    case 99: tag = 16; break;//武汉
                                    case 130: tag = 16; break;//武汉
                                    case 10: tag = 17; break;//西安
                                    case 98: tag = 17; break;//西安
                                    case 102: tag = 17; break;//西安
                                    case 27: tag = 3; break;//长沙
                                    case 96: tag = 3; break;//长沙
                                    case 100: tag = 3; break;//长沙
                                    case 33: tag = 18; break;//郑州
                                    case 48: tag = 19; break;//郑州
                                    case 50: tag = 7; break;//贵阳
                                    case 53: tag = 11; break;//贵阳
                                    case 71: tag = 21; break;//贵阳
                                    case 72: tag = 22; break;//石家庄
                                    case 112: tag = 22; break;//石家庄
                                    case 73: tag = 23; break;//南京仓库
                                    case 74: tag = 24; break;//宁波仓库
                                    case 75: tag = 25; break;//大连仓库
                                    case 76: tag = 26; break;//哈尔滨仓库
                                    case 77: tag = 27; break;//长春仓库
                                    case 110: tag = 27; break;//长春仓库
                                    case 78: tag = 29; break;//呼和浩特仓库
                                    case 79: tag = 28; break;//西宁仓库
                                    case 43: tag = 30; break;//新疆仓库
                                    case 80: tag = 31; break;//银川仓库
                                    case 81: tag = 32; break;//太原仓库
                                    case 115: tag = 32; break;//太原仓库
                                    case 13: tag = 34; break;//天津仓库
                                    case 105: tag = 34; break;//天津仓库
                                    case 127: tag = 34; break;//天津仓库
                                    default:
                                        break;
                                }
                                string good = string.Empty;
                                foreach (var itt in cargoShow)
                                {
                                    good += "品牌：" + itt.TypeName + "，规格：" + itt.Specs + "，" + itt.Figure + "，" + itt.LoadIndex + itt.SpeedLevel + "，数量：" + itt.Piece.ToString() + " |";
                                    TPiece += itt.Piece;
                                }
                                //微信企业号推送
                                QySendInfoEntity send = new QySendInfoEntity();
                                send.title = "提货通知";
                                send.msgType = msgType.textcard;
                                //send.toUser = "1000";
                                send.toTag = Convert.ToString(tag);
                                send.content = "<div>出库仓库：" + it.OutHouseName + "</div><div>订单号码：" + it.OrderNo + "</div><div>下单时间：" + it.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>提货联系人：" + cargoShow[0].PurchaserBoss + " " + cargoShow[0].PurchaserCellphone + "</div><div>提货地址：" + cargoShow[0].PurchaserAddress + "</div><div>提货数量：" + TPiece + " 条</div><div>物品明细：" + good + "</div><div>收货人：" + it.AcceptPeople + " " + it.AcceptCellphone + "</div><div>收货地址：" + it.AcceptAddress + "</div><div>备注说明：" + it.Remark + "</div>";
                                send.url = "http://oa.hlyex.com/HLYQY/OESDelivery/DeliverySure.aspx?OrderNo=" + it.OrderNo + "&AgentID=1000021";
                                QyConfigEntity agentEnt = new QyConfigEntity();
                                agentEnt.AgentID = "1000021";
                                agentEnt.AgentSecret = "0iV_tGVHzE6-kJsrdWADQZOG5U-vz939_gIMSRnQXc0";
                                WXQYSendHelper.HLYQYPushInfo(agentEnt, send);

                            }
                            order.UpdateCargoOrderPostponeShipStatus(new CargoOrderEntity { OrderNo = it.OrderNo, PostponeShip = "2" }, log);
                        }
                        catch (ApplicationException ex)
                        {
                            LogHelper.WriteLog("推送提货通知失败：" + it.OrderNo);
                            continue;
                        }
                    }
                }
            }
            #endregion

            #region 推送订单到好来运系统和新陆程系统作业
            List<CargoOrderPushEntity> result = order.QueryCargoOrderPushInfoList(new CargoOrderPushEntity { PushStatus = "0" });
            if (result.Count > 0)
            {
                foreach (var it in result)
                {
                    #region 废弃
                    //if (it.HouseID.Equals(9) || it.HouseID.Equals(93))
                    //{
                    //    List<CargoOrderPushEntity> resultList = order.QueryCargoOrderPushInfoList(new CargoOrderPushEntity { PushStatus = "0", Type = 1 });
                    //    if (resultList.Count > 0)
                    //    {
                    //        foreach (var item in resultList)
                    //        {
                    //            if (item.PushType.Equals("0"))
                    //            {
                    //                List<CargoContainerShowEntity> GoodsList = order.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = item.OrderNo });

                    //                List<HLYAddPlanOutOrderDetails> detailsList = new List<HLYAddPlanOutOrderDetails>();
                    //                foreach (var cargo in GoodsList)
                    //                {
                    //                    detailsList.Add(new HLYAddPlanOutOrderDetails
                    //                    {
                    //                        Batch = cargo.Batch,
                    //                        Model = cargo.Model,
                    //                        Piece = cargo.Piece,
                    //                        GoodsCode = cargo.GoodsCode,
                    //                        TypeID = cargo.TypeID.ToString(),
                    //                        TypeName = cargo.TypeName,
                    //                        Specs = cargo.Specs,
                    //                        Figure = cargo.Figure,
                    //                        LoadIndex = cargo.LoadIndex,
                    //                        SpeedLevel = cargo.SpeedLevel,
                    //                        BelongDepart = cargo.BelongDepart,
                    //                        ProductName = cargo.ProductName,
                    //                        Brand = cargo.TypeName,
                    //                        Unit = "条",
                    //                        BoxType = "s01",
                    //                        QtyInUint = 1,
                    //                        SupplierCode = "DLQF"
                    //                    });
                    //                }
                    //                CargoOrderEntity orderInfo = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = item.OrderNo });
                    //                HLYAddPlanOutOrder planOutOrder = new HLYAddPlanOutOrder();
                    //                //planOutOrder.DepartmentID = ent.CargoDepart;
                    //                planOutOrder.DepartmentID = "B0002";
                    //                planOutOrder.StoreType = 1;
                    //                //planOutOrder.BusinessID = ent.CargoDepart;
                    //                planOutOrder.BusinessID = "151";
                    //                planOutOrder.HouseCode = orderInfo.HouseCode;
                    //                planOutOrder.HouseName = orderInfo.HouseName;
                    //                planOutOrder.CustomerCode = "迪乐泰";
                    //                planOutOrder.GtmcNo = orderInfo.OrderNo;
                    //                planOutOrder.SupplierCode = "DLQF";
                    //                planOutOrder.SupplierName = "迪乐泰";
                    //                planOutOrder.TakeTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    //                planOutOrder.DepartTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    //                planOutOrder.Piece = orderInfo.Piece;
                    //                planOutOrder.InputType = 1;
                    //                planOutOrder.OrderType = 0;
                    //                planOutOrder.Remark = orderInfo.Remark;
                    //                planOutOrder.ToGuestID = orderInfo.ClientNum;
                    //                planOutOrder.ToGuestName = orderInfo.AcceptUnit;
                    //                planOutOrder.Toname = orderInfo.AcceptPeople;
                    //                planOutOrder.Toaddress = orderInfo.AcceptAddress;
                    //                planOutOrder.Totel = orderInfo.AcceptTelephone;
                    //                planOutOrder.ToMobile = orderInfo.AcceptCellphone;
                    //                planOutOrder.Provinces = orderInfo.Province;
                    //                planOutOrder.City = orderInfo.City;
                    //                planOutOrder.CreateBy = RobotName;
                    //                planOutOrder.TakeNo = "01";
                    //                if (!orderInfo.LogisID.Equals(34))
                    //                {
                    //                    planOutOrder.TransportCompany = 1;
                    //                }
                    //                planOutOrder.Fdep = orderInfo.Dep;
                    //                planOutOrder.details = detailsList;

                    //                string jsonString = JsonConvert.SerializeObject(planOutOrder);
                    //                string hlyres = wxHttpUtility.SendHttpRequest(ConfigurationSettings.AppSettings["HLYAPI"] + "/api/CargoInterface/AddPlanOutOrder", jsonString, "application/json");
                    //                JavaScriptSerializer js = new JavaScriptSerializer();
                    //                HLYAddPlanOutOrderReturn HLYReturn = js.Deserialize<HLYAddPlanOutOrderReturn>(hlyres);
                    //                if (HLYReturn.State)
                    //                {
                    //                    log.IPAddress = "";
                    //                    log.Moudle = "服务管理";
                    //                    log.Status = "0";
                    //                    log.NvgPage = "定单推送服务";
                    //                    log.UserID = Convert.ToString(ConfigurationSettings.AppSettings["RobotID"]);
                    //                    log.Operate = "U";
                    //                    string planOrderNo = HLYReturn.data.PlanOrderNo;
                    //                    order.UpdateHLYPlanOrderNo(item.OrderNo, planOrderNo, log);
                    //                }
                    //            }
                    //            //修改
                    //            else if (item.PushType.Equals("1"))
                    //            {
                    //                CargoOrderEntity orderInfo = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = item.OrderNo });
                    //                string hlyres = wxHttpUtility.SendGetHttpRequest(ConfigurationSettings.AppSettings["HLYAPI"] + "/api/CargoInterface/DeletePlanOutOrder?PlanOrderNo=" + orderInfo.PlanOrderNo, "application/json");
                    //                JavaScriptSerializer js = new JavaScriptSerializer();
                    //                HLYgetByOrderNoReturn HLYReturn = js.Deserialize<HLYgetByOrderNoReturn>(hlyres);
                    //                if (HLYReturn.State)
                    //                {
                    //                    List<CargoContainerShowEntity> GoodsList = order.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = item.OrderNo });
                    //                    List<HLYAddPlanOutOrderDetails> detailsList = new List<HLYAddPlanOutOrderDetails>();
                    //                    foreach (var cargo in GoodsList)
                    //                    {
                    //                        detailsList.Add(new HLYAddPlanOutOrderDetails
                    //                        {
                    //                            Batch = cargo.Batch,
                    //                            Model = cargo.Model,
                    //                            Piece = cargo.Piece,
                    //                            GoodsCode = cargo.GoodsCode,
                    //                            TypeID = cargo.TypeID.ToString(),
                    //                            TypeName = cargo.TypeName,
                    //                            Specs = cargo.Specs,
                    //                            Figure = cargo.Figure,
                    //                            LoadIndex = cargo.LoadIndex,
                    //                            SpeedLevel = cargo.SpeedLevel,
                    //                            BelongDepart = cargo.BelongDepart,
                    //                            ProductName = cargo.ProductName,
                    //                            Brand = cargo.TypeName,
                    //                            Unit = "条",
                    //                            BoxType = "s01",
                    //                            QtyInUint = 1,
                    //                            SupplierCode = "DLQF"
                    //                        });
                    //                    }
                    //                    HLYAddPlanOutOrder planOutOrder = new HLYAddPlanOutOrder();
                    //                    //planOutOrder.DepartmentID = ent.CargoDepart;
                    //                    planOutOrder.DepartmentID = "B0002";
                    //                    planOutOrder.StoreType = 1;
                    //                    //planOutOrder.BusinessID = ent.CargoDepart;
                    //                    planOutOrder.BusinessID = "151";
                    //                    planOutOrder.HouseCode = orderInfo.HouseCode;
                    //                    planOutOrder.HouseName = orderInfo.HouseName;
                    //                    planOutOrder.CustomerCode = "迪乐泰";
                    //                    planOutOrder.GtmcNo = orderInfo.OrderNo;
                    //                    planOutOrder.SupplierCode = "DLQF";
                    //                    planOutOrder.SupplierName = "迪乐泰";
                    //                    planOutOrder.TakeTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    //                    planOutOrder.DepartTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    //                    planOutOrder.Piece = orderInfo.Piece;
                    //                    planOutOrder.InputType = 1;
                    //                    planOutOrder.OrderType = 0;
                    //                    planOutOrder.Remark = orderInfo.Remark;
                    //                    planOutOrder.ToGuestID = orderInfo.ClientNum;
                    //                    planOutOrder.ToGuestName = orderInfo.AcceptUnit;
                    //                    planOutOrder.Toname = orderInfo.AcceptPeople;
                    //                    planOutOrder.Toaddress = orderInfo.AcceptAddress;
                    //                    planOutOrder.Totel = orderInfo.AcceptTelephone;
                    //                    planOutOrder.ToMobile = orderInfo.AcceptCellphone;
                    //                    planOutOrder.Provinces = orderInfo.Province;// Convert.ToString(Request["HiddenProvince"]);
                    //                    planOutOrder.City = orderInfo.City;// Convert.ToString(Request["HiddenCity"]);
                    //                    planOutOrder.CreateBy = ConfigurationSettings.AppSettings["RobotName"];
                    //                    planOutOrder.TakeNo = "01";
                    //                    if (!orderInfo.LogisID.Equals(34))
                    //                    {
                    //                        planOutOrder.TransportCompany = 1;
                    //                    }
                    //                    planOutOrder.Fdep = orderInfo.Dep;

                    //                    planOutOrder.details = detailsList;

                    //                    string jsonString = JsonConvert.SerializeObject(planOutOrder);
                    //                    hlyres = wxHttpUtility.SendHttpRequest(ConfigurationSettings.AppSettings["HLYAPI"] + "/api/CargoInterface/AddPlanOutOrder", jsonString, "application/json");
                    //                    HLYAddPlanOutOrderReturn HLYPlanReturn = js.Deserialize<HLYAddPlanOutOrderReturn>(hlyres);
                    //                    if (HLYPlanReturn.State)
                    //                    {
                    //                        log.IPAddress = "";
                    //                        log.Moudle = "服务管理";
                    //                        log.Status = "0";
                    //                        log.NvgPage = "定单推送服务";
                    //                        log.UserID = Convert.ToString(ConfigurationSettings.AppSettings["RobotID"]);
                    //                        log.Operate = "U";
                    //                        string planOrderNo = HLYPlanReturn.data.PlanOrderNo;
                    //                        order.UpdateHLYPlanOrderNo(item.OrderNo, planOrderNo, log);
                    //                    }
                    //                }
                    //            }
                    //            //删除
                    //            else if (item.PushType.Equals("2"))
                    //            {
                    //                CargoOrderEntity orderInfo = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = item.OrderNo });
                    //                string hlyres = wxHttpUtility.SendGetHttpRequest(ConfigurationSettings.AppSettings["HLYAPI"] + "/api/CargoInterface/DeletePlanOutOrder?PlanOrderNo=" + orderInfo.PlanOrderNo, "application/json");
                    //                JavaScriptSerializer js = new JavaScriptSerializer();
                    //                HLYgetByOrderNoReturn HLYReturn = js.Deserialize<HLYgetByOrderNoReturn>(hlyres);
                    //            }
                    //        }
                    //    }
                    //}
                    #endregion

                    if (it.HouseName.Equals("广州仓库") && it.Type != 2)
                    {
                        order.UpdateCargoOrderPushAwbNo(new CargoOrderPushEntity { OrderNo = it.OrderNo, PushStatus = "1" }, log);
                        continue;
                    }
                    try
                    {
                        #region 推送到新陆城配
                        if (it.HouseName.Equals("新陆城配"))
                        {
                            string Belong = "CP";
                            //推送到TMS新陆城配系统快速配送
                            if (it.PushType.Equals("0"))
                            {
                                //新增
                                AddTMSAwbNo(it);
                            }
                            else if (it.PushType.Equals("2"))
                            {
                                //删除
                                LogHelper.WriteLog("Begin 删除新陆城配订单号：" + it.OrderNo);
                                //删除
                                //string awbno = OEnt.LogisID.Equals(62) ? OEnt.LogisAwbNo : OEnt.HAwbNo;
                                string data = "cmd=DelTmsAwbNo&AwbNo=" + it.OrderNo + "&Belong=" + Belong;
                                string res = wxHttpUtility.SendHttpRequest("http://tms.hlyex.com/webSer/tmsAPI.ashx", data);
                            }
                            order.UpdateCargoOrderPushAwbNo(new CargoOrderPushEntity { OrderNo = it.OrderNo, PushStatus = "1" }, log);
                        }
                        #endregion
                        #region 推送到南宁好来运TMS系统
                        if (it.HouseName.Trim().Equals("南宁云仓"))
                        {
                            if (it.PushType.Equals("0"))
                            {
                                //新增
                                AddTMSAwbNo(it);
                            }
                            else if (it.PushType.Equals("1"))
                            {
                                //修改
                                AddTMSAwbNo(it);
                            }
                            else if (it.PushType.Equals("2"))
                            {
                                //删除
                                LogHelper.WriteLog("Begin 删除TMS订单号：" + it.OrderNo);
                                //删除
                                //string awbno = OEnt.LogisID.Equals(62) ? OEnt.LogisAwbNo : OEnt.HAwbNo;
                                string data = "cmd=DelTmsAwbNo&AwbNo=" + it.OrderNo + "&Belong=NN";
                                string res = wxHttpUtility.SendHttpRequest("http://tms.hlyex.com/webSer/tmsAPI.ashx", data);
                            }
                            order.UpdateCargoOrderPushAwbNo(new CargoOrderPushEntity { OrderNo = it.OrderNo, PushStatus = "1" }, log);

                        }
                        #endregion

                        #region 推送到新陆程系统
                        //   if (it.HouseName.Trim().Equals("海南迪乐泰") || (it.HouseName.Trim().Equals("广东仓库") && (it.OrderNo.Contains("DG") || it.OrderNo.Contains("GD"))) || it.HouseName.Trim().Equals("揭阳仓库") || it.HouseName.Trim().Equals("海口城配仓库") || it.HouseName.Trim().Equals("华南配件仓") || it.HouseName.Trim().Equals("华南枢纽仓"))it.HouseName.Trim().Equals("龙华云仓") || it.HouseName.Trim().Equals("揭阳云仓") || 
                        if (it.HouseName.Trim().Equals("海南迪乐泰") || (it.HouseName.Trim().Equals("广东仓库") && (it.OrderNo.Contains("DG") || it.OrderNo.Contains("SZ") || it.OrderNo.Contains("GD"))) || it.HouseName.Trim().Equals("揭阳仓库") || it.HouseName.Trim().Equals("揭阳城配仓") || it.HouseName.Trim().Equals("海口城配仓库") || it.HouseName.Trim().Equals("华南配件仓") || it.HouseName.Trim().Equals("华南枢纽仓") || it.HouseName.Trim().Equals("沙井云仓") || it.HouseName.Trim().Equals("增城云仓") || it.HouseName.Trim().Equals("汕头云仓") || (it.OrderNo.ToUpper().Contains("DL") && it.LogisID.Equals(62)))
                        {
                            if (it.PushType.Equals("0"))
                            {
                                AddNewyayAwbNo(it);
                            }
                            else if (it.PushType.Equals("1"))
                            {
                                //深圳仓库 是福建新陆程 ，揭阳、海口和东莞是广州新陆程 
                                string Belong = "NW";
                                //if (it.OrderNo.Contains("SZ"))
                                //{ Belong = "FJ"; }
                                //修改先删除 再新增 
                                string data = "cmd=DelNewayAwbNo&AwbNo=" + it.OrderNo + "&Belong=" + Belong;
                                string res = wxHttpUtility.SendHttpRequest("http://xt.neway5.com/Interface/OMSInterface.ashx", data);

                                AddNewyayAwbNo(it);
                            }
                            else if (it.PushType.Equals("2"))
                            {
                                LogHelper.WriteLog("Begin 删除新陆程订单号：" + it.OrderNo);
                                string Belong = "NW";
                                //if (it.OrderNo.Contains("SZ"))
                                //{ Belong = "FJ"; }
                                //删除
                                //string awbno = OEnt.LogisID.Equals(62) ? OEnt.LogisAwbNo : OEnt.HAwbNo;
                                string data = "cmd=DelNewayAwbNo&AwbNo=" + it.OrderNo + "&Belong=" + Belong;
                                string res = wxHttpUtility.SendHttpRequest("http://xt.neway5.com/Interface/OMSInterface.ashx", data);
                            }
                            order.UpdateCargoOrderPushAwbNo(new CargoOrderPushEntity { OrderNo = it.OrderNo, PushStatus = "1" }, log);
                        }
                        #endregion
                        #region 推送信息
                        if (it.PushType.Equals("0"))
                        {
                            LogHelper.WriteLog("Begin 上传新增订单号：" + it.OrderNo);
                            string DeliveryDepartment = string.Empty;
                            //if (it.HouseName.Equals("西安仓库"))
                            //{
                            //    DeliveryDepartment = "好来运安泰路斯轮胎西安仓业务部";
                            //}
                            if (it.HouseID.Equals("65"))
                            {
                                DeliveryDepartment = it.HLYSendUnit;
                            }
                            string OPID = it.OP_ID;
                            if (it.OP_ID.Length > 3)
                            {
                                OPID = it.OP_ID.Substring(0, 3);
                            }

                            //新增
                            string url = "http://apphome.hlyex.com:9891/api.ashx?action=SaveCargoToAwbno&token=jgds$jh";
                            url += "&OrderNO=" + it.OrderNo + "&Fdep=" + it.Dep + "&Fdest=" + it.Dest + "&Transport=汽运&Department=" + it.HouseName + "&Toname=" + it.AcceptPeople + "&Totel=" + it.AcceptTelephone + "&Tomobile=" + it.AcceptCellphone + "&Toaddress=" + it.AcceptAddress + "&Guestid=" + it.ClientNum + "&Guestname=" + it.AcceptUnit + "&User=" + OPID + "&CarrierCompany=&Pcs=" + it.Piece.ToString() + "&Weight=0&Volume=0&grossfee=" + it.TransportFee.ToString("F2") + "&DeliveryDepartment=" + DeliveryDepartment + "&HouseID=" + it.HouseID + "&HouseName=" + it.HouseName;
                            //LogHelper.WriteLog("URL：" + url);
                            string awbno = wxHttpUtility.GetData(url);
                            LogHelper.WriteLog("订单号：" + it.OrderNo + "返回运单号：" + awbno);
                            if (!string.IsNullOrEmpty(awbno) && it.Type != 2)
                            {
                                ArrayList GridRows = (ArrayList)JSON.Decode("[" + awbno + "]");
                                foreach (Hashtable row in GridRows)
                                {
                                    if (Convert.ToString(row["state"]).Equals("true"))
                                    {
                                        order.UpdateCargoOrderPushAwbNo(new CargoOrderPushEntity { OrderNo = it.OrderNo, AwbNo = Convert.ToString(row["awbno"]), PushStatus = "1" }, log);
                                        if (it.LogisID.Equals(34))
                                        {
                                            order.UpdateLogisAwbNo(it.OrderNo, Convert.ToString(row["awbno"]), "", log);
                                        }
                                    }
                                }

                            }
                            if (!string.IsNullOrEmpty(awbno) && it.Type == 2)
                            {
                                ArrayList GridRows = (ArrayList)JSON.Decode("[" + awbno + "]");
                                foreach (Hashtable row in GridRows)
                                {
                                    if (Convert.ToString(row["state"]).Equals("true"))
                                    {
                                        order.UpdateCargoOrderPushAwbNo(new CargoOrderPushEntity { OrderNo = it.OrderNo, AwbNo = Convert.ToString(row["awbno"]), PushStatus = "1" }, log);
                                        order.UpdateMoveOrderLogis(new CargoMoveOrderEntity() { MoveNo = it.OrderNo, LogisAwbNo = Convert.ToString(row["awbno"]) }, log);
                                    }
                                }

                            }
                            //if (it.HouseName.Equals("西安仓库"))
                            //{
                            //    //1.保存订单数据到好来运Tbl_ProductOrder表
                            //    List<CargoContainerShowEntity> orderContainerList = order.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = it.OrderNo });
                            //    CargoOrderEntity cargoOrderEntity = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = it.OrderNo });
                            //    order.SaveHlyOrderData(orderContainerList, cargoOrderEntity);
                            //}
                        }
                        else if (it.PushType.Equals("1"))
                        {
                            //删除
                            string url = "http://apphome.hlyex.com:9891/api.ashx?action=DelCargoToAwbno&token=jgds$jh";
                            url += "&OrderNO=" + it.OrderNo + "&Awbno=" + it.AwbNo;
                            string awbno = wxHttpUtility.GetData(url);

                            string DeliveryDepartment = string.Empty;
                            if (it.HouseName.Equals("西安仓库"))
                            {
                                DeliveryDepartment = "好来运安泰路斯轮胎西安仓业务部";
                            }
                            if (it.HouseID.Equals("65"))
                            {
                                DeliveryDepartment = it.HLYSendUnit;
                            }
                            string OPID = it.OP_ID;
                            if (it.OP_ID.Length > 3)
                            {
                                OPID = it.OP_ID.Substring(0, 3);
                            }
                            //新增
                            string Addurl = "http://apphome.hlyex.com:9891/api.ashx?action=SaveCargoToAwbno&token=jgds$jh";
                            Addurl += "&OrderNO=" + it.OrderNo + "&Fdep=" + it.Dep + "&Fdest=" + it.Dest + "&Transport=汽运&Department=" + it.HouseName + "&Toname=" + it.AcceptPeople + "&Totel=" + it.AcceptTelephone + "&Tomobile=" + it.AcceptCellphone + "&Toaddress=" + it.AcceptAddress + "&Guestid=" + it.ClientNum + "&Guestname=" + it.AcceptUnit + "&User=" + OPID + "&CarrierCompany=&Pcs=" + it.Piece.ToString() + "&Weight=0&Volume=0&grossfee=" + it.TransportFee.ToString("F2") + "&DeliveryDepartment=" + DeliveryDepartment + "&HouseID=" + it.HouseID + "&HouseName=" + it.HouseName;
                            string awbawbno = wxHttpUtility.GetData(Addurl);
                            LogHelper.WriteLog("修改订单号：" + it.OrderNo + "返回运单号：" + awbawbno);

                            LogHelper.WriteLog("Begin 上传修改订单号：" + it.OrderNo);
                            ////修改
                            //string url = "http://apphome.hlyex.com:9891/api.ashx?action=UpdateCargoToAwbno&token=jgds$jh";
                            //url += "&OrderNO=" + it.OrderNo + "&Awbno=" + it.AwbNo + "&Pcs=" + it.Piece.ToString() + "&Weight=0&Volume=0";
                            //string awbno = wxHttpUtility.GetData(url);
                            order.UpdateCargoOrderPushAwbNo(new CargoOrderPushEntity { OrderNo = it.OrderNo, PushStatus = "1" }, log);
                        }
                        else if (it.PushType.Equals("2"))
                        {
                            LogHelper.WriteLog("Begin 上传删除订单号：" + it.OrderNo);
                            //删除
                            string url = "http://apphome.hlyex.com:9891/api.ashx?action=DelCargoToAwbno&token=jgds$jh";
                            url += "&OrderNO=" + it.OrderNo + "&Awbno=" + it.AwbNo;
                            string awbno = wxHttpUtility.GetData(url);
                            order.UpdateCargoOrderPushAwbNo(new CargoOrderPushEntity { OrderNo = it.OrderNo, PushStatus = "1" }, log);
                        }
                        #endregion

                    }
                    catch (ApplicationException ex)
                    {
                        LogHelper.WriteLog("订单上传出错" + it.OrderNo);
                        //PushWeixinNotice("7");
                        continue;
                    }
                }
            }
            #endregion

            #region 大屏可视化订单数据作业
            foreach (var itt in result)
            {
                if (itt.PushType.Equals("0"))
                {
                    //订单不存在，狄乐云仓虚拟的订单，退仓单
                    CargoOrderEntity OEnt = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = itt.OrderNo });
                    if (OEnt.OrderID.Equals(0)) { continue; }
                    if (OEnt.OutHouseName.Equals("狄乐云仓")) { continue; }
                    if (OEnt.ThrowGood.Equals("25")) { continue; }
                    //新增
                    LogHelper.WriteLog("Begin 订单号：" + itt.OrderNo + "推送到大屏可视化");
                    order.AddOwlOrderData(itt.OrderNo);
                }
                else if (itt.PushType.Equals("2"))
                {
                    //删除
                    LogHelper.WriteLog("Begin 删除大屏可视化订单号：" + itt.OrderNo);
                    order.DeleteOwlOrderData(itt.OrderNo);
                }
            }
            #endregion

            #region 供应商销售补货数据通知每天晚上18:01分推送
            try
            {
                if (DateTime.Now.ToString("HH:mm").Equals("18:01"))
                {
                    LogHelper.WriteLog("开始供应商销售补货数据通知");
                    SendSalesMessage();
                }
                if (DateTime.Now.ToString("HH:mm").Equals("23:01"))
                {
                    LogHelper.WriteLog("开始生成狄乐库存文件");
                    DiLeInventoryExport();
                }
            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("供应商销售补货数据通知:" + ex.Message);
            }

            #endregion
        }

        private void AddTMSAwbNoInfo(CargoOrderPushEntity it)
        {
            //机器人账号
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "定单推送服务";
            log.UserID = RobotID;
            log.Operate = "A";
            CargoOrderBus order = new CargoOrderBus();

            CargoOrderEntity OEnt = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = it.OrderNo });
            if (OEnt.OrderID.Equals(0)) { return; }
            if (OEnt.HouseID.Equals(84) && OEnt.OutHouseName.Equals("狄乐云仓"))
            {
                return;
            }
            List<CargoContainerShowEntity> OEntGoods = order.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = it.OrderNo });
            //2020-06-19 修改产品单价，轮胎12元一条itt.ActSalePrice.ToString("F2")
            string ShipperName = string.Empty;
            string ShipperUnit = string.Empty;
            string ShipperCellphone = string.Empty;
            string ShipperAddress = string.Empty;
            string Belong = "NN";
            string ClientNum = "";
            decimal UnitP = 0.00M;
            //string dest = "海口,澄迈,临高,儋州,洋浦,昌江,东方,八所,乐东,九所,黄流,崖城,三亚,保亭,陵水,万宁,琼海,定安,文昌,屯昌,琼中,五指山,白沙";
            string De = string.Empty;
            //if (dest.Contains(OEnt.Dest)) { De = "海口"; }
            if (it.OrderNo.Contains("NG"))
            {
                //南宁批发仓 推送到南宁分公司TMS系统 12元一条
                De = "南宁";
                UnitP = 0;
                ShipperName = "南宁分公司";
                ShipperUnit = "南宁分公司";
                ShipperCellphone = "13113333081";
                ShipperAddress = "广西南宁市西乡塘区南武大道永宁小学背后容顺物流园右侧一栋5-6号";
                ClientNum = "132208";
            }
            else if (it.OrderNo.Contains("YZ"))
            {
                //增城云仓
                De = "广州";
                string[] strings = { "揭阳", "汕头", "潮州", "梅州", "汕尾", "普宁", "河源", "茂名", "湛江", "阳江" };

                if (!OEnt.Province.Equals("广东"))
                {
                    De = OEnt.Dest;
                }
                UnitP = 0;
                ShipperName = "广州迪乐泰";
                ShipperUnit = "广州迪乐泰";
                ShipperCellphone = "13265180164";
                ShipperAddress = "增城区广百骏盈现代物流园";
            }
            decimal hz = Convert.ToDecimal(OEnt.Piece * UnitP);//轮胎运输费用汇总
            #region 明细
            string go = "[";
            if (OEntGoods.Count > 0)
            {
                foreach (var itt in OEntGoods)
                {
                    go += "{\"Goods\":\"" + itt.TypeName + " " + itt.Specs + " " + itt.Figure + " " + itt.LoadIndex + itt.SpeedLevel + "\",\"Package\":\"无\",\"Piece\":\"" + itt.Piece.ToString() + "\",\"PiecePrice\":\"" + UnitP + "\",\"OP_DATE\":\"" + itt.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss") + "\",\"ProductName\":\"" + itt.ProductName + "\",\"Model\":\"" + itt.Model + "\",\"GoodsCode\":\"" + itt.GoodsCode + "\",\"Specs\":\"" + itt.Specs + "\",\"Figure\":\"" + itt.Figure + "\",\"LoadIndex\":\"" + itt.LoadIndex + "\",\"SpeedLevel\":\"" + itt.SpeedLevel + "\",\"Batch\":\"" + itt.Batch + "\",\"ContainerCode\":\"" + itt.ContainerCode + "\",\"TypeName\":\"" + itt.TypeName + "\"},";
                }
                go = go.Substring(0, go.Length - 1);
            }
            go += "]";
            #endregion

            string ss = "{\"HAwbNo\":\"" + OEnt.OrderNo + "\",\"Dep\":\"" + OEnt.Dep + "\",\"Dest\":\"" + De + "\",\"Transit\":\"" + OEnt.Dest + "\",\"Piece\":\"" + OEnt.Piece.ToString() + "\",\"TimeLimit\":\"3\",\"InsuranceFee\":\"0\",\"TransitFee\":\"0\",\"TransportFee\":\"" + hz.ToString("F2") + "\",\"DeliverFee\":\"0\",\"OtherFee\":\"0\",\"TotalCharge\":\"" + hz.ToString("F2") + "\",\"CheckOutType\":\"2\",\"ReturnAwb\":\"\",\"ShipperName\":\"" + ShipperName + "\",\"ShipperUnit\":\"" + ShipperUnit + "\",\"ShipperTelephone\":\"" + ShipperCellphone + "\",\"ShipperCellphone\":\"" + ShipperCellphone + "\",\"ShipperAddress\":\"" + ShipperAddress + "\",\"AcceptUnit\":\"" + OEnt.AcceptUnit + "\",\"AcceptPeople\":\"" + OEnt.AcceptPeople + "\",\"AcceptTelephone\":\"" + OEnt.AcceptTelephone + "\",\"AcceptCellphone\":\"" + OEnt.AcceptCellphone + "\",\"AcceptAddress\":\"" + OEnt.AcceptAddress + "\",\"HandleTime\":\"" + OEnt.CreateDate.ToString("yyyy-MM-dd HH:mm:ss") + "\",\"Remark\":\"" + OEnt.Remark + "\",\"UserID\":\"" + OEnt.CreateAwbID + "\",\"UserName\":\"" + OEnt.CreateAwb + "\",\"CreateAwb\":\"" + OEnt.CreateAwb + "\",\"ClientNum\":\"" + ClientNum + "\",\"Goods\":" + go + "}";

            string data = "cmd=SaveTmsAwbNoData&OrderList=[" + ss + "]&Belong=" + Belong;
            string xlcawbno = wxHttpUtility.SendHttpRequest("http://tms.hlyex.com/webSer/tmsAPI.ashx", data);
            LogHelper.WriteLog("返回TMS运单号" + it.OrderNo);

            if (!string.IsNullOrEmpty(xlcawbno))
            {
                ArrayList GridRows = (ArrayList)JSON.Decode("[" + xlcawbno + "]");
                foreach (Hashtable row in GridRows)
                {
                    if (Convert.ToBoolean(row["Result"]))
                    {
                        //更新新陆程 运单 号回仓储系统订单
                        if (OEnt.LogisID.Equals(62) || OEnt.LogisID.Equals(24) || OEnt.LogisID.Equals(26) || OEnt.LogisID.Equals(383))
                        {
                            order.UpdateLogisAwbNo(it.OrderNo, Convert.ToString(row["Message"]), "", log);
                        }
                        else
                        {
                            order.UpdateHAwbNo(it.OrderNo, Convert.ToString(row["Message"]), log);
                        }
                        LogHelper.WriteLog("返回TMS运单号" + it.OrderNo + Convert.ToString(row["Message"]));
                    }
                }

            }
            LogHelper.WriteLog("上传TMS成功" + it.OrderNo);
        }

        /// <summary>
        /// 同步企业微信每日考勤数据与
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        void SyncCheckinTime_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            #region 先注释
            //if (DateTime.Now.Hour.Equals(4))
            //{
            //    QiyeBus bus = new QiyeBus();
            //    QyDepartEntity departEntity = new QyDepartEntity();
            //    departEntity.Parentid = 15;
            //    List<QyDepartEntity> departList = bus.QueryDepartList(departEntity);
            //    string departStr = "";
            //    foreach (var item in departList)
            //    {
            //        departStr += "'" + item.Id + "',";
            //    }
            //    departStr = departStr.TrimEnd(',');
            //    List<QyUserEntity> userList = bus.QueryDepartAllUserList(departStr);
            //    string userStr = "[";
            //    foreach (var item in userList)
            //    {
            //        userStr += "\"" + item.UserID + "\",";
            //    }
            //    userStr = userStr.TrimEnd(',');
            //    userStr += "]";
            //    string token = GetWeixinToken(GetdltAPPID(), "MiwmXdN9HasI7x16VuTvZAosC2K8qVD9WoV0sQ_AsvQ");
            //    #region 同步每日详细考勤
            //    try
            //    {
            //        List<QYCheckinDataEntity> result = new List<QYCheckinDataEntity>();
            //        string Url = "https://qyapi.weixin.qq.com/cgi-bin/checkin/getcheckindata?access_token=";

            //        long startUnixTime = (DateTime.Now.Date.AddHours(3).AddMinutes(59).AddSeconds(59).ToUniversalTime().Ticks - 621355968000000000) / 10000000;
            //        long endUnixTime = (DateTime.Now.Date.AddDays(-1).ToUniversalTime().Ticks - 621355968000000000) / 10000000;
            //        string jsonData = "{\"opencheckindatatype\": 3,\"starttime\": " + startUnixTime + ",\"endtime\": " + endUnixTime + ",\"useridlist\": " + userStr + "}";
            //        string returnJson = wxHttpUtility.SendPostHttpRequest(Url + token, "application/json", jsonData);
            //        JavaScriptSerializer js = new JavaScriptSerializer();
            //        CheckintListReturnJson list = js.Deserialize<CheckintListReturnJson>(returnJson);
            //        string errcode = list.errcode;
            //        string errmsg = list.errmsg;
            //        List<checkindata> checkindata = list.checkindata;

            //        if (errmsg == "ok" && checkindata.Count > 0)
            //        {
            //            foreach (var item in checkindata)
            //            {
            //                string MediaPath = item.mediaids.Count > 0 ? item.userid + TimeZone.CurrentTimeZone.ToLocalTime(new DateTime(1970, 1, 1)).AddSeconds(item.checkin_time).ToString("yyyyMMddHHmmss") + ".png" : "";
            //                if (item.mediaids.Count > 0)
            //                {
            //                    SaveWxPicture(token, item.mediaids[0], MediaPath, System.Web.HttpContext.Current.Server.MapPath("/") + "CheckinImage\\");
            //                }
            //                result.Add(new QYCheckinDataEntity { UserID = item.userid, GroupName = item.groupname, CheckinType = item.checkin_type, ExceptionType = item.exception_type, CheckinTime = TimeZone.CurrentTimeZone.ToLocalTime(new DateTime(1970, 1, 1)).AddSeconds(item.checkin_time), LocationTitle = item.location_title, LocationDetail = item.location_detail, WifiName = item.wifiname, Notes = item.notes, WifiMac = item.wifimac, MediaIDs = item.mediaids.Count > 0 ? item.mediaids[0] : "", MediaPath = MediaPath, Lat = item.lat, Lng = item.lng, DeviceID = item.deviceid, SchCheckinTime = TimeZone.CurrentTimeZone.ToLocalTime(new DateTime(1970, 1, 1)).AddSeconds(item.sch_checkin_time), GroupID = item.groupid, TimelineID = item.timeline_id });
            //            }
            //            bus.SyncCheckinData(result);
            //        }
            //    }
            //    catch (Exception ex)
            //    {
            //        LogHelper.WriteLog("同步企业号每日考勤数据出错" + ex.Message);
            //    }
            //    #endregion
            //    #region 同步汇总考勤
            //    try
            //    {
            //        long startUnixTime = (DateTime.Now.AddDays(1 - DateTime.Now.Day).Date.ToUniversalTime().Ticks - 621355968000000000) / 10000000;
            //        long endUnixTime = (DateTime.Now.AddDays(1 - DateTime.Now.Day).Date.AddMonths(1).AddSeconds(-1).ToUniversalTime().Ticks - 621355968000000000) / 10000000;
            //        string Url = "https://qyapi.weixin.qq.com/cgi-bin/checkin/getcheckin_monthdata?access_token=";
            //        string jsonData = "{\"starttime\": " + startUnixTime + ",\"endtime\": " + endUnixTime + ",\"useridlist\": " + userStr + "}";
            //        string returnJson = wxHttpUtility.SendPostHttpRequest(Url + token, "application/json", jsonData);
            //        JavaScriptSerializer js = new JavaScriptSerializer();
            //        CheckintMonthlyReportReturnJson list = js.Deserialize<CheckintMonthlyReportReturnJson>(returnJson);
            //        string errcode = list.errcode;
            //        string errmsg = list.errmsg;
            //        List<datas> checkindata = list.datas;
            //        List<QYCheckinMonthlyReportEntity> result = new List<QYCheckinMonthlyReportEntity>();

            //        foreach (var item in checkindata)
            //        {
            //            QYCheckinMonthlyReportEntity entity = new QYCheckinMonthlyReportEntity();
            //            var base_info = item.base_info;
            //            var summary_info = item.summary_info;
            //            entity.RecordType = base_info.record_type;
            //            entity.Name = base_info.name;
            //            entity.NameEx = base_info.name_ex;
            //            entity.UserID = base_info.acctid;
            //            entity.WorkDays = summary_info.work_days;
            //            entity.RegularDays = summary_info.regular_days;
            //            entity.ExceptDays = summary_info.except_days;
            //            entity.RegularWorkSec = summary_info.regular_work_sec;
            //            entity.StandardWorkSec = summary_info.standard_work_sec;
            //            var exception_infos = item.exception_infos;
            //            foreach (var eitem in exception_infos)
            //            {
            //                switch (eitem.exception)
            //                {
            //                    case 1:
            //                        entity.LateCount = eitem.count;
            //                        entity.LateDuration = eitem.duration;
            //                        break;
            //                    case 2:
            //                        entity.LeaveEarlyCount = eitem.count;
            //                        entity.LeaveEarlyDuration = eitem.duration;
            //                        break;
            //                    case 3:
            //                        entity.AbsenceCount = eitem.count;
            //                        break;
            //                    case 4:
            //                        entity.AbsenteeismCount = eitem.count;
            //                        entity.AbsenteeismDuration = eitem.duration;
            //                        break;
            //                    case 5:
            //                        entity.LocationAbnormalCount = eitem.count;
            //                        break;
            //                    case 6:
            //                        entity.EquipmentAbnormalCount = eitem.count;
            //                        break;
            //                }
            //            }
            //            var sp_items = item.sp_items;
            //            foreach (var sitem in sp_items)
            //            {
            //                switch (sitem.type)
            //                {
            //                    case 1:
            //                        switch (sitem.name)
            //                        {
            //                            case "年假":
            //                                entity.AnnualLeaveCount = sitem.count;
            //                                entity.AnnualLeaveDuration = sitem.duration;
            //                                entity.AnnualLeaveTimeType = sitem.time_type;
            //                                break;
            //                            case "事假":
            //                                entity.CompassionateLeaveCount = sitem.count;
            //                                entity.CompassionateLeaveDuration = sitem.duration;
            //                                entity.CompassionateLeaveTimeType = sitem.time_type;
            //                                break;
            //                            case "病假":
            //                                entity.SickLeaveCount = sitem.count;
            //                                entity.SickLeaveDuration = sitem.duration;
            //                                entity.SickLeaveTimeType = sitem.time_type;
            //                                break;
            //                            case "调休假":
            //                                entity.CompensatoryLeaveCount = sitem.count;
            //                                entity.CompensatoryLeaveDuration = sitem.duration;
            //                                entity.CompensatoryLeaveTimeType = sitem.time_type;
            //                                break;
            //                            case "婚假":
            //                                entity.MarriageHolidayCount = sitem.count;
            //                                entity.MarriageHolidayDuration = sitem.duration;
            //                                entity.MarriageHolidayTimeType = sitem.time_type;
            //                                break;
            //                            case "产假":
            //                                entity.MaternityLeaveCount = sitem.count;
            //                                entity.MaternityLeaveDuration = sitem.duration;
            //                                entity.MaternityLeaveTimeType = sitem.time_type;
            //                                break;
            //                            case "陪产假":
            //                                entity.PaternityLeaveCount = sitem.count;
            //                                entity.PaternityLeaveDuration = sitem.duration;
            //                                entity.PaternityLeaveTimeType = sitem.time_type;
            //                                break;
            //                            case "其他":
            //                                entity.OtherLeaveCount = sitem.count;
            //                                entity.OtherLeaveDuration = sitem.duration;
            //                                entity.OtherLeaveTimeType = sitem.time_type;
            //                                break;
            //                        }
            //                        break;
            //                    case 2:
            //                        entity.CardReplacementCount = sitem.count;
            //                        break;
            //                    case 3:
            //                        entity.BusinessCount = sitem.count;
            //                        entity.BusinessDuration = sitem.duration;
            //                        entity.BusinessTimeType = sitem.time_type;
            //                        break;
            //                    case 4:
            //                        entity.EgressCount = sitem.count;
            //                        entity.EgressDuration = sitem.duration;
            //                        entity.EgressTimeType = sitem.time_type;
            //                        break;
            //                    case 100:
            //                        entity.FieldCount = sitem.count;
            //                        entity.FieldDuration = sitem.duration;
            //                        entity.FieldTimeType = sitem.time_type;
            //                        break;
            //                }
            //            }
            //            var overwork_info = item.overwork_info;
            //            entity.WorkdayOverSec = overwork_info.workday_over_sec;
            //            entity.HolidaysOverSec = overwork_info.holidays_over_sec;
            //            entity.RestdaysOverSec = overwork_info.restdays_over_sec;
            //            entity.ReportTime = DateTime.Now.ToString("yyyyMM");
            //            result.Add(entity);
            //        }
            //        bus.SyncCheckinReport(result);
            //    }
            //    #endregion
            //    catch (Exception ex)
            //    {
            //        LogHelper.WriteLog("同步企业号汇总考勤数据出错" + ex.Message);
            //    }
            //} 
            #endregion
        }
        /// <summary>
        /// 下载微信考勤附件图片
        /// </summary>
        /// <param name="mediaID"></param>
        /// <param name="imgName"></param>
        /// <param name="imgPath"></param>
        public void SaveWxPicture(string token, string mediaID, string imgName, string imgPath)
        {
            try
            {
                using (MemoryStream ms = new MemoryStream())
                {
                    MediaApi.Get(token, mediaID, ms);

                    if (!Directory.Exists(imgPath))
                    {
                        Directory.CreateDirectory(imgPath);
                    }
                    //保存到文件
                    using (FileStream fs = new FileStream(imgPath + imgName, FileMode.Create))
                    {
                        ms.Position = 0;
                        byte[] buffer = new byte[1024];
                        int bytesRead = 0;
                        while ((bytesRead = ms.Read(buffer, 0, buffer.Length)) != 0)
                        {
                            fs.Write(buffer, 0, bytesRead);
                        }
                        fs.Flush();
                    }
                }
            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("同步企业号考勤图片出错" + ex.Message);
            }
        }
        /// <summary>
        /// 检查商城订单是否有微信付款未确认的订单
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void MakeSureMallOrder()
        {
            //机器人账号
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "微信商城订单";
            log.Status = "0";
            log.NvgPage = "仓库确认订单";
            log.UserID = RobotID;
            log.Operate = "A";

            WXOrderManagerEntity queryEntity = new WXOrderManagerEntity();
            queryEntity.PayStatus = "1";
            queryEntity.PayWay = "0";
            queryEntity.OrderStatus = "0";
            queryEntity.StartDate = DateTime.Now.AddDays(-3);
            queryEntity.EndDate = DateTime.Now;
            queryEntity.CargoPermisID = "1,3,9,11,12,34,44";
            #region 确认订单

            CargoOrderBus bus = new CargoOrderBus();
            CargoHouseBus house = new CargoHouseBus();
            SendTempleteMessage send = new SendTempleteMessage();
            string token = GetWeixinToken(GetdltAPPID(), GetdltAppSecret());
            List<WXOrderManagerEntity> list = bus.QueryWeixinOrderInfo(queryEntity);
            foreach (var itO in list)
            {
                List<WXOrderManagerEntity> wxOrderList = bus.QueryContainerGoodsMakeSureWeixinOrder(new WXOrderManagerEntity { OrderNo = itO.OrderNo });
                if (wxOrderList.Count <= 0)
                {
                    LogHelper.WriteLog("订单数据有误");
                    break;
                }
                if (!wxOrderList[0].OrderStatus.Equals("0"))
                {
                    LogHelper.WriteLog("商城订单号：" + itO.OrderNo + "已确认");
                    break;
                }
                CargoAreaEntity careaEnt = new CargoAreaEntity();
                List<CargoAreaEntity> areaList = new List<CargoAreaEntity>();
                //1.根据城市查询该城市是否在仓库配送区域，在则从该仓库出库，不在
                //2.根据区域查询 该区域是否在仓库配送区域 ，在则从该仓库出库，不在，则直接返回
                //deliv = house.IsExistDeliveryArea(new CargoAreaEntity { HouseID = houseID, DeliveryArea = Country });
                careaEnt = house.QueryAreaByDeliveryArea(new CargoAreaEntity { HouseID = wxOrderList[0].HouseID, DeliveryArea = wxOrderList[0].Country });
                if (careaEnt.AreaID.Equals(0))
                {
                    careaEnt = house.QueryAreaByDeliveryArea(new CargoAreaEntity { HouseID = wxOrderList[0].HouseID, DeliveryArea = wxOrderList[0].City });
                    if (careaEnt.AreaID.Equals(0))
                    {
                        LogHelper.WriteLog(wxOrderList[0].City + "该省份未开放购买权限");
                        break;
                    }
                }
                areaList = house.QueryAreaListByDeliveryArea(new CargoAreaEntity { HouseID = wxOrderList[0].HouseID, DeliveryArea = wxOrderList[0].City });
                CargoWeiXinBus wx = new CargoWeiXinBus();
                WXCouponEntity coupon = new WXCouponEntity();
                if (!wxOrderList[0].CouponID.Equals(0))
                {
                    coupon = wx.QueryCouponByID(new WXCouponEntity { ID = wxOrderList[0].CouponID });
                }
                CargoHouseEntity houseEnt = house.QueryCargoHouseByID(wxOrderList[0].HouseID);
                CargoOrderEntity order = new CargoOrderEntity();
                int OrderNum = 0;
                order.OrderNo = GetMaxOrderNumByCurrentDate(wxOrderList[0].HouseID, houseEnt.HouseCode, out OrderNum); //生成最新顺序订单号
                order.OrderNum = OrderNum;//最新订单顺序号
                order.WXOrderNo = itO.OrderNo;
                order.HAwbNo = "";
                order.Dep = houseEnt.DepCity; order.Dest = wxOrderList[0].City;
                order.Piece = wxOrderList[0].Piece; order.Weight = order.Volume = order.TransitFee = order.DeliveryFee = order.InsuranceFee = order.OtherFee = order.Rebate = 0.00M;
                //order.TransportFee = order.TotalCharge = wxOrderList[0].TotalCharge;
                order.TransitFee = wxOrderList[0].TransitFee;
                order.InsuranceFee = Convert.ToDecimal(coupon.Money);
                order.TransportFee = wxOrderList[0].TotalCharge - wxOrderList[0].TransitFee + Convert.ToDecimal(coupon.Money);
                order.TotalCharge = wxOrderList[0].TotalCharge;
                order.CheckOutType = "0";
                if (wxOrderList[0].PayWay.Equals("0"))
                {
                    order.CheckOutType = "5";
                }
                else if (wxOrderList[0].PayWay.Equals("1"))
                {
                    order.CheckOutType = "6";
                }
                order.TrafficType = order.DeliveryType = "0";
                order.ClientNum = wxOrderList[0].ClientNum;
                order.PayClientNum = wxOrderList[0].ClientNum;
                order.PayClientName = wxOrderList[0].Name;
                order.AcceptUnit = order.AcceptPeople = wxOrderList[0].Name;
                order.AcceptTelephone = order.AcceptCellphone = wxOrderList[0].Cellphone;
                order.AcceptAddress = wxOrderList[0].AcceptAddress;
                order.HouseID = wxOrderList[0].HouseID;
                order.PayWay = wxOrderList[0].PayWay;
                order.PayStatus = wxOrderList[0].PayStatus;
                if ((wxOrderList[0].PayWay.Equals("0") && wxOrderList[0].PayStatus.Equals("1")) || wxOrderList[0].PayWay.Equals("2"))
                {
                    //微信付款并且支付成功
                    order.FinanceSecondCheck = "1";
                    order.FinanceSecondCheckName = RobotName;
                    order.FinanceSecondCheckDate = DateTime.Now;
                }
                order.OP_ID = RobotID;
                order.AwbStatus = "1";//正在备货
                order.OrderType = wxOrderList[0].OrderType;// "2";//微信公众号下单 
                order.OrderModel = "0";//订货单 
                order.Remark = wxOrderList[0].Memo;
                order.LogisID = wxOrderList[0].LogisID;
                order.CreateAwbID = RobotID;
                order.CreateAwb = RobotName;
                order.CreateDate = DateTime.Now;
                order.IsAppFirstOrder = wxOrderList[0].IsAppFirstOrder;
                order.CouponID = wxOrderList[0].CouponID;
                WXUserAddressEntity clerkEntity = wx.QueryWxAreaClient(new WXUserAddressEntity { Province = wxOrderList[0].Province, City = wxOrderList[0].City });
                if (!string.IsNullOrEmpty(clerkEntity.LoginName))
                {
                    order.SaleManID = clerkEntity.LoginName;
                    order.SaleManName = clerkEntity.UserName;
                }
                string OutHouseName = careaEnt.Name;//出库仓库名称

                List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
                List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
                string outID = DateTime.Now.ToString("yyMMdd") + GetRandomFourNumString();//出库单号
                CargoInterfaceBus interBus = new CargoInterfaceBus();
                bool bz = false;
                foreach (var it in wxOrderList)
                {
                    if (it.HouseID.Equals(9) && it.TypeID.Equals(34)) { bz = true; }
                    int piece = it.OrderNum;
                    if (it.SaleType.Equals("1") || it.PayWay.Equals("2"))
                    {
                        #region 直接出库
                        entDest.Add(new CargoOrderGoodsEntity
                        {
                            OrderNo = order.OrderNo,
                            ProductID = it.ProductID,
                            HouseID = it.HouseID,
                            AreaID = it.AreaID,
                            Piece = it.OrderNum,
                            ActSalePrice = it.OrderPrice,
                            ContainerCode = it.ContainerCode,
                            OutCargoID = outID,
                            OP_ID = RobotID
                        });

                        CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                        cargo.OrderNo = order.OrderNo;//订单号
                        cargo.OutCargoID = outID;
                        cargo.ContainerID = it.ContainerID;
                        cargo.TypeID = it.TypeID;
                        cargo.ProductID = it.ProductID;
                        cargo.Piece = it.OrderNum;//出库件数
                        cargo.ActSalePrice = it.OrderPrice;
                        cargo.InPiece = it.InCargoPiece;
                        cargo.ID = it.InContainID;

                        //cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                        cargo.HouseName = houseEnt.Name;
                        cargo.AreaName = it.AreaName;
                        cargo.ProductName = it.ProductName;
                        cargo.Model = it.Model;
                        cargo.Specs = it.Specs;
                        cargo.Figure = it.Figure;
                        outHouseList.Add(cargo);
                        CargoAreaEntity cae = house.QueryHouseByAreaID(new CargoAreaEntity { AreaID = it.AreaID });
                        if (!cae.AreaID.Equals(0))
                        {
                            OutHouseName = cae.Name;
                        }
                        #endregion
                    }
                    else
                    {
                        #region 优先出库方法
                        bool noTyre = false;//没有库存
                        CargoInterfaceEntity stockEntity = new CargoInterfaceEntity
                        {
                            HouseID = it.HouseID,
                            AreaID = careaEnt.AreaID,
                            //GoodsCode = it.GoodsCode,
                            Specs = it.Specs,
                            TypeID = it.TypeID,
                            Figure = it.Figure,
                            BatchYear = it.BatchYear,
                            //LoadIndex = it.LoadIndex,
                            //SpeedLevel = it.SpeedLevel,
                        };
                        List<CargoInterfaceEntity> stockList = interBus.queryMiniCargoStock(stockEntity);
                        if (stockList.Count <= 0)
                        {
                            LogHelper.WriteLog("商品名称：" + it.Title + "库存为空");
                            noTyre = true;
                        }
                        if (stockList.Sum(c => c.StockNum) < piece)
                        {
                            LogHelper.WriteLog("商品名称：" + it.Title + "库存不足，库存只剩：" + stockList.Sum(c => c.StockNum).ToString());
                            noTyre = true;
                        }
                        bool HaveTyre = false;
                        //查询另外仓库
                        if (noTyre)
                        {
                            foreach (var area in areaList)
                            {
                                if (area.AreaID.Equals(careaEnt.AreaID))
                                {
                                    continue;
                                }
                                CargoInterfaceEntity stockEntityA = new CargoInterfaceEntity
                                {
                                    HouseID = it.HouseID,
                                    AreaID = area.AreaID,
                                    //GoodsCode = it.GoodsCode,
                                    Specs = it.Specs,
                                    TypeID = it.TypeID,
                                    Figure = it.Figure,
                                    BatchYear = it.BatchYear,
                                    //LoadIndex = it.LoadIndex,
                                    //SpeedLevel = it.SpeedLevel,
                                };
                                int curKC = stockList.Sum(c => c.StockNum);//现在库存
                                List<CargoInterfaceEntity> stock = interBus.queryMiniCargoStock(stockEntityA);
                                if (stock.Count <= 0)
                                {
                                    LogHelper.WriteLog("商品名称：" + it.Title + "库存为空");
                                    continue;
                                }
                                stockList.AddRange(stock);
                                if (stock.Sum(c => c.StockNum) + curKC < piece)
                                {
                                    LogHelper.WriteLog("商品名称：" + it.Title + "库存不足，库存只剩：" + stockList.Sum(c => c.StockNum).ToString());
                                    continue;
                                }
                                HaveTyre = true; break;
                            }
                        }
                        if (!noTyre || (noTyre && HaveTyre))
                        {
                            //减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                            foreach (var kc in stockList)
                            {
                                if (kc.StockNum <= 0)
                                {
                                    continue;
                                }
                                CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                                cargo.OrderNo = order.OrderNo;//订单号
                                cargo.OutCargoID = outID;
                                cargo.ContainerID = kc.ContainerID;
                                cargo.TypeID = kc.TypeID;
                                cargo.ProductID = kc.ProductID;

                                cargo.ID = kc.ContainerGoodsID;//库存表ID

                                //cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                                cargo.HouseName = houseEnt.Name;
                                //cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                                cargo.ProductName = kc.ProductName;
                                cargo.GoodsCode = kc.GoodsCode;
                                cargo.Model = kc.Model;
                                cargo.Specs = kc.Specs;
                                cargo.Figure = kc.Figure;
                                #region 减库存逻辑
                                if (piece < kc.StockNum)
                                {
                                    //部分出
                                    entDest.Add(new CargoOrderGoodsEntity
                                    {
                                        OrderNo = order.OrderNo,
                                        ProductID = kc.ProductID,
                                        HouseID = order.HouseID,
                                        AreaID = kc.AreaID,
                                        Piece = piece,
                                        ActSalePrice = it.OrderPrice,
                                        ContainerCode = kc.ContainerCode,
                                        OutCargoID = outID,
                                        OP_ID = log.UserID
                                    });
                                    cargo.Piece = piece;
                                    cargo.ActSalePrice = it.OrderPrice;
                                    cargo.InPiece = kc.StockNum;

                                    outHouseList.Add(cargo);
                                    break;
                                }
                                if (piece.Equals(kc.StockNum))
                                {
                                    //要出库件数和第一条库存件数刚刚好，则就全部出
                                    entDest.Add(new CargoOrderGoodsEntity
                                    {
                                        OrderNo = order.OrderNo,
                                        ProductID = kc.ProductID,
                                        HouseID = order.HouseID,
                                        AreaID = kc.AreaID,
                                        Piece = piece,
                                        ActSalePrice = it.OrderPrice,
                                        ContainerCode = kc.ContainerCode,
                                        OutCargoID = outID,
                                        OP_ID = log.UserID
                                    });
                                    cargo.Piece = piece;
                                    cargo.ActSalePrice = it.OrderPrice;
                                    cargo.InPiece = kc.StockNum;

                                    outHouseList.Add(cargo);
                                    break;
                                }
                                if (piece > kc.StockNum)
                                {
                                    //全部出
                                    entDest.Add(new CargoOrderGoodsEntity
                                    {
                                        OrderNo = order.OrderNo,
                                        ProductID = kc.ProductID,
                                        HouseID = order.HouseID,
                                        AreaID = kc.AreaID,
                                        Piece = kc.StockNum,
                                        ActSalePrice = it.OrderPrice,
                                        ContainerCode = kc.ContainerCode,
                                        OutCargoID = outID,
                                        OP_ID = log.UserID
                                    });
                                    cargo.Piece = kc.StockNum;
                                    cargo.InPiece = kc.StockNum;
                                    cargo.ActSalePrice = it.OrderPrice;

                                    outHouseList.Add(cargo);
                                    piece = piece - kc.StockNum;
                                    continue;
                                }
                                #endregion
                            }
                            CargoAreaEntity cae = house.QueryHouseByAreaID(new CargoAreaEntity { AreaID = stockList[0].AreaID });
                            if (!cae.AreaID.Equals(0))
                            {
                                OutHouseName = cae.Name;
                            }
                        }
                        else
                        {
                            LogHelper.WriteLog("出库出错");
                            return;
                        }

                        #endregion
                    }
                }
                order.OutHouseName = OutHouseName;//出库仓库名称
                if (bz) { order.Remark += "  打包装"; }
                order.goodsList = entDest;
                //仓库同步缓存
                foreach (CargoContainerShowEntity time in outHouseList)
                {
                    CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                    //34 马牌  1 同步马牌  2 同步全部品牌
                    if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                    {
                        RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                    }
                }
                bus.makeSureWxOrder(order, outHouseList, log);

                if (order.HouseID.Equals(9) || order.HouseID.Equals(15) || order.HouseID.Equals(49) || order.HouseID.Equals(50) || order.HouseID.Equals(51) || order.HouseID.Equals(52) || order.HouseID.Equals(53) || order.HouseID.Equals(54) || order.HouseID.Equals(13) || order.HouseID.Equals(14) || order.HouseID.Equals(15) || order.HouseID.Equals(23) || order.HouseID.Equals(30))
                {
                    //内部订单
                    bus.SaveHlyOrderData(outHouseList, order);
                }
                else
                {
                    bus.InsertCargoOrderPush(new CargoOrderPushEntity
                    {
                        OrderNo = order.OrderNo,
                        Dep = order.Dep,
                        Dest = order.Dest,
                        Piece = order.Piece,
                        ClientNum = order.ClientNum.ToString(),
                        AcceptAddress = order.AcceptAddress,
                        AcceptCellphone = order.AcceptCellphone,
                        AcceptTelephone = order.AcceptTelephone,
                        AcceptPeople = order.AcceptPeople,
                        AcceptUnit = order.AcceptUnit,
                        HouseID = order.HouseID.ToString(),
                        HouseName = houseEnt.Name,
                        OP_ID = RobotID,
                        PushType = "0",
                        PushStatus = "0",
                        LogisID = order.LogisID
                    }, log);
                }
                try
                {
                    //推送客户消息
                    TemplateMsg tmMsg = new TemplateMsg
                    {
                        first = new TemplateDataItem("尊敬的迪乐泰客户，您的订单仓库已确认！~正在秒速为您安排发货，请耐心等待哦~", "#173177"),
                        keyword1 = new TemplateDataItem(wxOrderList[0].Title, "#173177"),
                        keyword2 = new TemplateDataItem(wxOrderList[0].TotalCharge.ToString("F2") + "元", "#173177"),
                        keyword3 = new TemplateDataItem(wxOrderList[0].OrderNo, "#173177"),
                        remark = new TemplateDataItem("点击查看物流跟踪详情!", "#173177")
                    };
                    //oo1LEt_z6Yhx-g_qdgrYhLaYaazE//测试
                    string errmsg = send.SendMessage(token, wxOrderList[0].wxOpenID, "heDfICkOgVf3gfod4kM6CL4MiK4YikrFGm6k9QgUZ8A", "http://dlt.neway5.com/Weixin/OrderInfo.aspx?orderNo=" + wxOrderList[0].OrderNo, tmMsg);
                }
                catch (Exception)
                {
                    continue;
                }

            }
            #endregion
        }
        private string GetdltAPPID()
        {
            return ConfigurationSettings.AppSettings["dltAPPID"];
        }
        private string GetdltSalesModelID()
        {
            return ConfigurationSettings.AppSettings["dltSalesModelID"];
        }
        private string GetdltBillModelID()
        {
            return ConfigurationSettings.AppSettings["dltBillModelID"];
        }
        private string GetdltSerViceSupplierDay()
        {
            return ConfigurationSettings.AppSettings["SerViceSupplierDay"];
        }
        private string GetdltServiceToUrl()
        {
            return ConfigurationSettings.AppSettings["dltServiceToUrl"];
        }
        private string GetdltServiceBillToUrl()
        {
            return ConfigurationSettings.AppSettings["dltServiceBillToUrl"];
        }
        private string GetdltAppSecret()
        {
            return ConfigurationSettings.AppSettings["dltAppSecret"];
        }
        public static string GetWeixinToken(string appID, string appSecret)
        {
            string token = string.Empty;
            //string token = Senparc.Weixin.MP.Containers.AccessTokenContainer.TryGetAccessToken(appid, appsecret);
            try
            {
                token = Senparc.Weixin.MP.Containers.AccessTokenContainer.TryGetAccessToken(appID, appSecret);
                Senparc.Weixin.MP.Entities.GetCallBackIpResult bip = Senparc.Weixin.MP.CommonAPIs.CommonApi.GetCallBackIp(token);
                if (bip.errcode.Equals("40001"))
                {
                    //WriteTextLog(bip.errcode.ToString());
                    Senparc.Weixin.MP.Containers.AccessTokenContainer.Register(appID, appSecret, "DLTWxToken");
                    token = Senparc.Weixin.MP.Containers.AccessTokenContainer.TryGetAccessToken(appID, appSecret);
                }
            }
            catch (Exception ex)
            {
                //WriteTextLog("Token:" + ex.Message);
                Senparc.Weixin.MP.Containers.AccessTokenContainer.Register(appID, appSecret, "DLTWxToken");
                token = Senparc.Weixin.MP.Containers.AccessTokenContainer.TryGetAccessToken(appID, appSecret);
            }
            return token;
        }
        /// <summary>
        /// 处理商城客户订单是否结清，额度付款是否冻结
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        void mallClientTime_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            //机器人账号
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "定单推送服务";
            log.UserID = RobotID;
            log.Operate = "A";
            CargoOrderBus order = new CargoOrderBus();
            CargoHouseBus houseBus = new CargoHouseBus();

            #region 20251113注释，不再向小程序推送发货订单
            try
            {
                //处理所有云仓订单
                List<WXOrderEntity> wXOrders = order.QueryMiniOrderSendWx(new WXOrderEntity { CreateDate = DateTime.Now.AddDays(-10), OrderStatus = "2" });
                if (wXOrders.Count > 0)
                {
                    LogHelper.WriteLog("开始向小程序推送订单发货状态");
                    //慧采云仓小程序AppID和Secret
                    string acctoken = Senparc.Weixin.MP.Containers.AccessTokenContainer.TryGetAccessToken(ConfigurationSettings.AppSettings["HCYCAppID"], ConfigurationSettings.AppSettings["HCYCAppSecret"]);
                    foreach (var it in wXOrders)
                    {
                        if (string.IsNullOrEmpty(it.WXPayOrderNo))
                        {
                            continue;
                        }
                        try
                        {
                            string ps = "{\"order_key\": {\"order_number_type\": 2,\"transaction_id\": \"" + it.WXPayOrderNo + "\"},\"delivery_mode\": 1,\"logistics_type\": 2,\"shipping_list\": [{\"item_desc\": \"" + it.Memo + "\"}],\"upload_time\": \"" + DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ssK") + "\",\"payer\": {\"openid\": \"" + it.wxOpenID + "\"}}";
                            string wxReturnStr = wxHttpUtility.SendHttpRequest("https://api.weixin.qq.com/wxa/sec/order/upload_shipping_info?access_token=" + acctoken, ps);
                            if (!string.IsNullOrEmpty(wxReturnStr))
                            {
                                ArrayList GridRows = (ArrayList)JSON.Decode("[" + wxReturnStr + "]");
                                foreach (Hashtable row in GridRows)
                                {
                                    if (Convert.ToString(row["errcode"]).Equals("0"))
                                    {
                                        LogHelper.WriteLog("向小程序推送订单发货状态成功" + it.CargoOrderNo);
                                        //推送成功
                                        order.UpdateOrderStatusWxPushStatus(new CargoOrderStatusEntity { ID = it.ID, WxSendStatusPush = "1", OrderNo = it.CargoOrderNo, WXOrderNo = it.OrderNo }, log);
                                    }
                                    else
                                    {
                                        LogHelper.WriteLog("向小程序推送订单发货状态失败" + it.CargoOrderNo + Convert.ToString(row["errmsg"]));
                                    }

                                }
                            }
                        }
                        catch (ApplicationException ex)
                        {
                            LogHelper.WriteLog("向小程序推送订单发货状态失败" + it.CargoOrderNo);
                            continue;
                        }
                    }
                }
            }
            catch (ApplicationException ex)
            {
                LogHelper.WriteLog("向小程序推送订单发货状态失败");
            }
            #endregion

            //每天早上零辰2点处理当前时间的仓库库存数据保存
            #region 每天早上零辰2点处理当前时间的仓库库存数据保存
            if (DateTime.Now.Hour.Equals(2))
            {
                CargoReportBus report = new CargoReportBus();
                CargoHouseBus house = new CargoHouseBus();
                try
                {
                    List<CargoDayStockEntity> result = new List<CargoDayStockEntity>();
                    //统计迪乐泰仓库和云仓仓库的库存数据
                    List<CargoHouseEntity> YChouseList = house.QueryALLHouse(new CargoHouseEntity { BelongHouse = "0,6" });
                    foreach (var it in YChouseList)
                    {
                        if (it.HouseID.Equals(45))
                        {
                            ////广东仓库下的东莞和深圳仓库 
                            //CargoDayStockEntity dgdayEnt = report.QueryDayCargoStockList(new CargoDayStockEntity { HouseID = it.HouseID, ParentID = 2843 });
                            //dgdayEnt.HouseID = it.HouseID;
                            //dgdayEnt.Name = "东莞仓库";
                            //dgdayEnt.StatisDate = DateTime.Now.AddDays(-1);
                            //result.Add(dgdayEnt);
                            ////深圳仓库
                            //CargoDayStockEntity szdayEnt = report.QueryDayCargoStockList(new CargoDayStockEntity { HouseID = it.HouseID, ParentID = 2872 });
                            //szdayEnt.HouseID = it.HouseID;
                            //szdayEnt.Name = "深圳仓库";
                            //szdayEnt.StatisDate = DateTime.Now.AddDays(-1);
                            //result.Add(szdayEnt);

                            //查询所有广东仓库一级区域
                            List<CargoAreaEntity> areaList = house.QueryALLArea(new CargoAreaEntity { ParentID = 0, HouseID = it.HouseID });
                            foreach (var area in areaList)
                            {
                                //东莞高埗前置仓、东莞寮步前置仓、东莞塘厦前置仓已停用不统计
                                if (area.AreaID != 2821 && area.AreaID != 2836 && area.AreaID != 2695)
                                {
                                    CargoDayStockEntity dayEnt = report.QueryDayCargoStockList(new CargoDayStockEntity { HouseID = it.HouseID, ParentID = area.AreaID });
                                    dayEnt.HouseID = it.HouseID;
                                    dayEnt.Name = area.Name;
                                    dayEnt.StatisDate = DateTime.Now.AddDays(-1);
                                    result.Add(dayEnt);
                                }
                            }
                        }
                        else if (it.HouseID.Equals(84))
                        {
                            //查询所有华南枢纽仓一级区域 统计新陆城配仓和汕头科矿仓
                            List<CargoAreaEntity> areaList = house.QueryALLArea(new CargoAreaEntity { ParentID = 0, HouseID = it.HouseID });
                            foreach (var area in areaList)
                            {
                                CargoDayStockEntity dayEnt = report.QueryDayCargoStockList(new CargoDayStockEntity { HouseID = it.HouseID, ParentID = area.AreaID });
                                dayEnt.HouseID = it.HouseID;
                                dayEnt.Name = area.Name;
                                dayEnt.StatisDate = DateTime.Now.AddDays(-1);
                                result.Add(dayEnt);
                            }
                        }
                        else if (it.HouseID.Equals(44))
                        {
                            //查询所有揭阳仓库一级区域
                            List<CargoAreaEntity> areaList = house.QueryALLArea(new CargoAreaEntity { ParentID = 0, HouseID = it.HouseID });
                            foreach (var area in areaList)
                            {
                                CargoDayStockEntity dayEnt = report.QueryDayCargoStockList(new CargoDayStockEntity { HouseID = it.HouseID, ParentID = area.AreaID });
                                dayEnt.HouseID = it.HouseID;
                                dayEnt.Name = area.Name;
                                dayEnt.StatisDate = DateTime.Now.AddDays(-1);
                                result.Add(dayEnt);
                            }
                        }
                        else
                        {
                            CargoDayStockEntity dayEnt = report.QueryDayCargoStockList(new CargoDayStockEntity { HouseID = it.HouseID });
                            dayEnt.HouseID = it.HouseID;
                            dayEnt.Name = it.Name;
                            if (it.HouseID.Equals(59))
                            {
                                dayEnt.SmallTyreSum = dayEnt.TotalSum - dayEnt.BigTyreSum;
                            }
                            dayEnt.StatisDate = DateTime.Now.AddDays(-1);
                            if (dayEnt.TotalSum > 0) { result.Add(dayEnt); }
                        }
                    }

                    report.SaveDayCargoStock(result);
                }
                catch (Exception)
                {
                    LogHelper.WriteLog("统计每日迪乐泰仓库库存数据报错");
                }
            }
            #endregion
            #region 确定商城订单
            try
            {
                //确定商城订单
                MakeSureMallOrder();
            }
            catch (Exception)
            {
                LogHelper.WriteLog("确定商城订单报错");
                //PushWeixinNotice("0");
            }
            #endregion
            //每天早上零辰5点处理昨天商城订单统计数据
            #region 每天早上零辰5点处理昨天商城订单统计数据
            if (DateTime.Now.Hour.Equals(5))
            {
                try
                {
                    HandleWxMallStatis();
                }
                catch (Exception)
                {
                    LogHelper.WriteLog("处理昨天商城订单统计数据报错");
                    //PushWeixinNotice("5");
                }
            }
            #endregion

            #region 每天早上零辰3点和中午12点同步好来运签收数据
            //if (DateTime.Now.Hour.Equals(3) || DateTime.Now.Hour.Equals(10) || DateTime.Now.Hour.Equals(12) || DateTime.Now.Hour.Equals(16))
            //{

            //}
            //查询所有云仓仓库
            //List<CargoHouseEntity> houseList = houseBus.QueryALLHouse(new CargoHouseEntity { BelongHouse = "6" });
            List<CargoHouseEntity> houseList = houseBus.QueryALLHouse();
            string cper = "9";
            foreach (var it in houseList)
            {
                cper += "," + it.HouseID.ToString();
            }
            try
            {
                int XLCDay = Convert.ToInt32(ConfigurationSettings.AppSettings["XLCDay"]);
                CargoOrderEntity entity = new CargoOrderEntity();
                entity.BelongHouse = "0";
                entity.CargoPermisID = cper;
                entity.StartDate = DateTime.Now.AddDays(-XLCDay);
                entity.LogisID = 34;
                order.SetOrderSignByHLY(entity);
                LogHelper.WriteLog("同步好来运签收数据成功");
            }
            catch (Exception)
            {
                LogHelper.WriteLog("同步好来运签收数据出错");
            }
            #endregion

            #region 获取订单发货状态
            try
            {
                CargoOrderEntity entity = new CargoOrderEntity();
                entity.BelongHouse = "0";
                //entity.CargoPermisID = "9,93";
                entity.CargoPermisID = cper;
                //entity.StartDate = DateTime.Now.AddDays(-10);
                entity.LogisID = 34;
                order.SetOrderStatusByHLY(entity);
                LogHelper.WriteLog("每小时同步好来运发车数据成功");
            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("获取订单发货状态出错：" + ex.Message);
            }
            #endregion

            //每天早上9点推送每日商城日报表
            #region 每天早上9点推送每日商城日报表 已注释
            //if (DateTime.Now.Hour.Equals(7))
            //{
            //    try
            //    {
            //        List<Article> artList = new List<Article>();
            //        artList.Add(new Article
            //        {
            //            Title = "迪乐泰微信商城每日数据统计",
            //            Url = "http://dlt.neway5.com/Weixin/WxDailyReport.aspx",
            //            Description = "实时统计销售数据报表，增长曲线！",
            //            PicUrl = "https://mmbiz.qpic.cn/mmbiz_jpg/NgtueXpWXucEQVUdRLtJcEjVOsSiaO6R5O9gEbAPwgJy2vCR8pUxqdSwGrzgiauGlSy7F6yFaK4alloHakr8XiaOA/0?wx_fmt=jpeg"
            //        });
            //        PushWeixinNews(artList);
            //    }
            //    catch (Exception)
            //    {
            //        LogHelper.WriteLog("推送微信商城每日数据统计报错");
            //        PushWeixinNotice("8");
            //    }

            //} 
            #endregion
            CargoClientBus bus = new CargoClientBus();
            #region 每月28号零辰2点处理当月客户订单结清情况
            //if (DateTime.Now.Day.Equals(28) && DateTime.Now.Hour.Equals(2))
            //{
            //    //每月28号零辰2点处理当月客户订单结清情况
            //    bus.UpdateClientQuotaLimit("1");
            //}
            //try
            //{
            //    //处理已结清的客户的额度付款权限
            //    bus.UpdateClientQuotaLimit("0");
            //}
            //catch (Exception)
            //{
            //    LogHelper.WriteLog("处理已结清的客户的额度付款权限报错");
            //    //PushWeixinNotice("1");
            //}
            #endregion
            #region 推送上月账单
            try
            {
                //每月5号早上9点推送上月账单
                if (DateTime.Now.Day.Equals(5) && DateTime.Now.Hour.Equals(9))
                {
                    DateTime dt = DateTime.Now;
                    string dtm = dt.AddMonths(-1).AddDays(-(dt.Day - 1)).ToString("yyyy-MM-dd") + "----" + dt.AddDays(-dt.Day).ToString("yyyy-MM-dd");
                    CargoWeiXinBus wx = new CargoWeiXinBus();
                    CargoClientEntity queryEntity = new CargoClientEntity();
                    queryEntity.DelFlag = "0";
                    queryEntity.PushAccount = "1";
                    queryEntity.HouseIDStr = "9,44,45,3";
                    List<CargoClientEntity> result = bus.QueryCargoClientList(queryEntity);
                    if (result.Count <= 0) { return; }
                    string token = GetWeixinToken(GetdltAPPID(), GetdltAppSecret());
                    foreach (var it in result)
                    {
                        List<WXUserEntity> wxUser = wx.QueryWeixinUserInfo(new WXUserEntity { ClientNum = it.ClientNum });
                        if (wxUser.Count <= 0) { continue; }

                        CargoOrderEntity oEn = new CargoOrderEntity();
                        oEn.PayClientNum = it.ClientNum;
                        oEn.StartDate = dt.AddMonths(-1).AddDays(-(dt.Day - 1)).AddMonths(-3);
                        oEn.EndDate = dt.AddDays(-dt.Day);
                        List<CargoOrderEntity> oResult = order.QueryOrderAccount(oEn);
                        int oP = 0;
                        decimal oC = 0.00M;
                        if (oResult.Count <= 0) { continue; }
                        foreach (var ot in oResult)
                        {
                            if (ot.OrderModel.Equals("0"))
                            {
                                oP += ot.Piece;
                                oC += ot.TotalCharge;
                            }
                        }
                        //推送客户消息
                        TemplateMsg tmMsg = new TemplateMsg
                        {
                            first = new TemplateDataItem("尊敬的客户，您的" + DateTime.Now.AddMonths(-1).ToString("yyyy-M") + "月对账单已生成！", "#173177"),
                            keyword1 = new TemplateDataItem(oC + "元" + "----" + oP + "条", "#173177"),
                            //keyword1 = new TemplateDataItem(result[0].TotalCharge.ToString("F2") + "元", "#173177"),
                            keyword2 = new TemplateDataItem(dtm, "#173177"),
                            remark = new TemplateDataItem("点击查看对账单详情!", "#173177")
                        };
                        SendTempleteMessage send = new SendTempleteMessage();
                        foreach (var ie in wxUser)
                        {
                            try
                            {
                                string errmsg = send.SendMessage(token, ie.wxOpenID, "4ON-evCCfwwCFCRhWixl4di-XPCr_ZMjUkTDfMFqFyk", "http://dlt.neway5.com/Weixin/AccountManager.aspx?ClientNum=" + it.ClientNum + "&StartDate=" + DateTime.Now.AddMonths(-1), tmMsg);

                            }
                            catch (Exception)
                            {
                                continue;
                            }
                        }

                    }
                }
            }
            catch (Exception)
            {
            }
            #endregion
            //每月最后一天，零辰2点自动保存快照
            #region 每月最后一天零辰2点自动保存快照
            try
            {
                if (DateTime.Now.Day == 1 && DateTime.Now.Hour.Equals(2))
                {

                    log.NvgPage = "快照定时服务";
                    log.Memo = "保存" + DateTime.Now.ToString("yyyy-MM") + "月末快照";
                    CargoReportBus report = new CargoReportBus();
                    string CargoPermisID = Convert.ToString(ConfigurationSettings.AppSettings["HouseID"]);
                    report.SaveStockSnapData(CargoPermisID, log);
                }
            }
            catch (Exception)
            {
                //PushWeixinNotice("6");
                //throw;
            }
            #endregion

        }
        /// <summary>
        /// 处理昨天微信商城订单数据统计
        /// </summary>
        private void HandleWxMallStatis()
        {
            CargoWeixinMallReportEntity queryEntity = new CargoWeixinMallReportEntity();
            queryEntity.StartDate = DateTime.Now.AddDays(-1);
            queryEntity.EndDate = DateTime.Now.AddDays(-1);
            CargoReportBus bus = new CargoReportBus();
            bus.HandleWxMallStatis(queryEntity);
        }
        /// <summary>
        /// 推送微信通知
        /// </summary>
        private void PushWeixinNews(List<Article> articleList)
        {
            WxCustomSend send = new WxCustomSend();
            string token = GetWeixinToken(GetdltAPPID(), GetdltAppSecret());
            string AcceptNotice = Convert.ToString(ConfigurationSettings.AppSettings["AcceptNotice"]);
            string[] acc = AcceptNotice.Split('/');
            if (acc.Length > 0)
            {
                for (int i = 0; i < acc.Length; i++)
                {
                    if (string.IsNullOrEmpty(acc[i])) { continue; }
                    send.SendWeiXinInfo(token, acc[i], new QySendInfoEntity { msgType = msgType.news }, articleList);
                }
            }
        }
        /// <summary>
        /// 推送微信通知
        /// </summary>
        private void PushWeixinNotice(string noticeType)
        {
            //string cont = string.Empty;
            //switch (noticeType)
            //{
            //    case "0": cont = "机器人确定商城订单报错"; break;
            //    case "1": cont = "处理已结清的客户的额度付款权限报错"; break;
            //    case "2": cont = "开始启动机器人"; break;
            //    case "3": cont = "处理迪乐泰仓储统计数据出错"; break;
            //    case "4": cont = "处理迪乐泰微信商城上架数据出错"; break;
            //    case "5": cont = "处理昨天商城订单统计数据报错"; break;
            //    case "6": cont = "保存10日快照出错"; break;
            //    case "7": cont = "订单上传出错"; break;
            //    case "8": cont = "推送微信商城每日数据统计报错"; break;
            //    case "9": cont = "自动处理商品上架出错"; break;
            //    case "10": cont = "推送订单已出库状态出错"; break;
            //    default: cont = "新年快乐"; break;
            //}
            //WxCustomSend send = new WxCustomSend();
            //string token = GetWeixinToken(GetdltAPPID(), GetdltAppSecret());
            //string AcceptNotice = Convert.ToString(ConfigurationSettings.AppSettings["AcceptNotice"]);
            //string[] acc = AcceptNotice.Split('/');
            //if (acc.Length > 0)
            //{
            //    for (int i = 0; i < acc.Length; i++)
            //    {
            //        if (string.IsNullOrEmpty(acc[i])) { continue; }
            //        send.SendWeiXinInfo(token, acc[i], new QySendInfoEntity { content = cont, msgType = msgType.text }, null);
            //    }
            //}
        }
        void pushFiveTime_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            //机器人账号
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "定单推送服务";
            log.UserID = RobotID;
            log.Operate = "A";
            CargoOrderBus order = new CargoOrderBus();
            CargoStaticBus s = new CargoStaticBus();
            CargoInterfaceBus nwBus = new CargoInterfaceBus();
            //CargoInterfaceBus interfaceBus = new CargoInterfaceBus();

            //CargoOrderBus orderBus = new CargoOrderBus();

            #region 查询新陆程未订阅成功的中转单号
            try
            {
                List<NWTransitEntity> noPoll = nwBus.QueryNwTransitList(new NWTransitEntity { BelongSystem = "NW", PollStatus = "0", StartDate = DateTime.Now.AddDays(-6) });
                if (noPoll.Count > 0)
                {
                    //开始订阅
                    foreach (var it in noPoll)
                    {
                        //2.订阅状态
                        String param = "";
                        param += "{";
                        param += "\"company\":\"" + it.ComCode + "\",";
                        param += "\"number\":\"" + it.TransitNo + "\",";
                        param += "\"from\":\"\",";
                        param += "\"to\":\"\",";
                        param += "\"key\":\"" + KD100_Key + "\",";
                        param += "\"parameters\":{\"callbackurl\":\"http://dlt.neway5.com/Interface/Kuaidi100.ashx?TransitID=" + it.TransitID.ToString() + "\",\"phone\":\"\"}";
                        param += "}";
                        //WriteTextLog(param, DateTime.Now);
                        string qc = string.Format("schema={0}&param={1}", "json", param);
                        LogHelper.WriteLog("订阅" + qc);
                        string ress = wxHttpUtility.SendHttpRequest(KD100_PollAddress, qc);
                        LogHelper.WriteLog("订阅" + ress);
                        ArrayList nod = (ArrayList)JSON.Decode("[" + ress + "]");
                        foreach (Hashtable item in nod)
                        {
                            if (Convert.ToString(item["result"]).Equals("True"))
                            {
                                LogHelper.WriteLog(it.TransitNo + "订阅成功" + it.TransitID.ToString());
                                //result.Message = "订阅成功";
                                //记录订阅记录
                                nwBus.UpdateNwTransitPollStatus(new NWTransitEntity { TransitID = it.TransitID, PollStatus = "1" });
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                LogHelper.WriteLog("订阅失败");
            }
            #endregion

            #region 查询迪乐泰订单订阅物流
            try
            {
                List<CargoOrderEntity> noPoll = order.QueryCargoOrderKuaidi100(new CargoOrderEntity { PollStatus = "0", StartDate = DateTime.Now.AddDays(-6) });
                if (noPoll.Count > 0)
                {
                    //开始订阅
                    foreach (var it in noPoll)
                    {
                        //2.订阅状态
                        String param = "";
                        param += "{";
                        param += "\"company\":\"" + it.ComCode + "\",";
                        param += "\"number\":\"" + it.LogisAwbNo + "\",";
                        param += "\"from\":\"\",";
                        param += "\"to\":\"\",";
                        param += "\"key\":\"" + KD100_Key + "\",";
                        param += "\"parameters\":{\"callbackurl\":\"http://dlt.neway5.com/Interface/Kuaidi100.ashx?TransitID=" + it.OrderNo + "\",\"phone\":\"\"}";
                        param += "}";
                        //WriteTextLog(param, DateTime.Now);
                        string qc = string.Format("schema={0}&param={1}", "json", param);
                        //LogHelper.WriteLog("订阅" + qc);
                        string ress = wxHttpUtility.SendHttpRequest(KD100_PollAddress, qc);
                        //LogHelper.WriteLog("订阅" + ress);
                        ArrayList nod = (ArrayList)JSON.Decode("[" + ress + "]");
                        foreach (Hashtable item in nod)
                        {
                            if (Convert.ToString(item["result"]).Equals("True"))
                            {
                                LogHelper.WriteLog(it.LogisAwbNo + "订阅成功" + it.OrderNo);
                                //result.Message = "订阅成功";
                                //记录订阅记录
                                order.UpdateCargoOrderPostponeShipStatus(new CargoOrderEntity { OrderNo = it.OrderNo, PollStatus = "1" }, log);
                            }
                        }
                    }
                }
            }
            catch (Exception)
            {
                LogHelper.WriteLog("迪乐泰订单物流订阅失败");
            }
            #endregion

            #region 推送订单出库状态
            try
            {
                List<CargoPushDataEntity> pushList = s.QueryPushData(new CargoPushDataEntity { PushType = "0", PushStatus = "0" });
                if (pushList.Count > 0)
                {
                    string token = GetWeixinToken(GetdltAPPID(), GetdltAppSecret());
                    SendTempleteMessage send = new SendTempleteMessage();
                    foreach (var p in pushList)
                    {
                        if (string.IsNullOrEmpty(p.wxOpenID)) { continue; }
                        //仓库确认成功向客户微信发送推送消息
                        //推送客户消息
                        TemplateMsg tmMsg = new TemplateMsg
                        {
                            first = new TemplateDataItem(p.PushTitle, "#173177"),
                            keyword1 = new TemplateDataItem(p.OrderInfo, "#173177"),
                            keyword2 = new TemplateDataItem(p.TotalCharge.ToString("F2") + "元", "#173177"),
                            keyword3 = new TemplateDataItem(p.WXOrderNo, "#173177"),
                            remark = new TemplateDataItem("点击查看物流跟踪详情!", "#173177")
                        };
                        try
                        {
                            string errmsg = send.SendMessage(token, p.wxOpenID, p.TemplateID, "http://dlt.neway5.com/Weixin/OrderInfo.aspx?orderNo=" + p.WXOrderNo, tmMsg);
                            LogHelper.WriteLog("推送订单已出库：" + p.WXOrderNo + errmsg);
                        }
                        catch (Exception ex)
                        {
                            LogHelper.WriteLog("推送订单已出库状态出错" + ex.Message);
                            p.PushStatus = "1";
                            s.UpdatePushStatus(p, log);
                            //PushWeixinNotice("10");
                            continue;
                        }
                        p.PushStatus = "1";
                        s.UpdatePushStatus(p, log);
                    }
                }

            }
            catch (ApplicationException ex)
            {
                LogHelper.WriteLog("推送订单出库状态");
            }
            #endregion

            #region 自动上架作业
            //log.NvgPage = "自动上架";
            //CargoProductEntity queryEntity = new CargoProductEntity();
            //queryEntity.CargoPermisID = "1,3,11,44,9,46,45";//湖南，湖北，西北，海南，揭阳
            //queryEntity.StartDate = DateTime.Now;
            //List<CargoProductEntity> productList = bus.QueryCurDayInHouseProduct(queryEntity);
            //if (productList.Count > 0)
            //{
            //    foreach (var pro in productList)
            //    {
            //        try
            //        {
            //            //不是广州仓库，或者 广州仓库下的马牌轮胎
            //            if (!pro.HouseID.Equals(9) || (pro.HouseID.Equals(9) && (pro.TypeID.Equals(34) || pro.TypeID.Equals(178) || pro.TypeID.Equals(180) || pro.TypeID.Equals(171))))
            //            {
            //                if (!bus.IsExistShelveProduct(new CargoProductEntity { HouseID = pro.HouseID, TypeID = pro.TypeID, Specs = pro.Specs, Figure = pro.Figure, LoadIndex = pro.LoadIndex, SpeedLevel = pro.SpeedLevel, BatchYear = pro.BatchYear }))
            //                {
            //                    //添加上架
            //                    CargoProductShelvesEntity shelve = new CargoProductShelvesEntity();
            //                    CargoProductShelvesEntity trye = bus.QueryTryePic(new CargoProductShelvesEntity { Figure = pro.Figure, TypeID = pro.TypeID });
            //                    if (!string.IsNullOrEmpty(trye.FileName))
            //                    {
            //                        shelve.FileName = trye.FileName;
            //                    }
            //                    else
            //                    {
            //                        //如果程序 没有取默认的图片
            //                        switch (pro.TypeID)
            //                        {

            //                            case 9: shelve.FileName = "/upload/trye/ykhm/A580.png"; break;//优科豪马A580.png
            //                            case 18: shelve.FileName = "/upload/trye/plst/T001.png"; break;//普利司通T001
            //                            case 19: shelve.FileName = "/upload/trye/baotong/GENESYS208.png"; break;//宝通GENESYS208
            //                            case 31: shelve.FileName = "/upload/trye/hantai/H728.png"; break;//韩泰H728
            //                            case 34: shelve.FileName = "/upload/trye/mapai/MC6.png"; break;//马牌MC6
            //                            case 66: shelve.FileName = "/upload/trye/gubo/C7.png"; break;//固铂C7
            //                            case 157: shelve.FileName = "/upload/trye/jiatong/GitiComfort228.png"; break;//佳通
            //                            case 164: shelve.FileName = "/upload/trye/sanjiao/TR258.png"; break;//三角TR258
            //                            case 171: shelve.FileName = "/upload/image/20201009/20201009105905_5889.png"; break;//达迈
            //                            case 180: shelve.FileName = "/upload/trye/wkt/S07.png"; break;//沃凯途TR258
            //                            default:
            //                                shelve.FileName = "/upload/trye/hantai/H728.png"; break;//沃凯途TR258
            //                        }
            //                    }
            //                    shelve.ProductID = pro.ProductID;
            //                    shelve.TypeID = pro.TypeID;
            //                    shelve.ProductName = pro.ProductName;
            //                    shelve.OnSaleNum = pro.OnSaleNum;
            //                    shelve.Title = pro.TypeName + pro.Specs + " " + pro.Figure + " " + pro.LoadIndex.ToString() + pro.SpeedLevel;
            //                    shelve.SaleType = "0";
            //                    shelve.ShelveStatus = "0";
            //                    shelve.Memo = "<img alt=\"\" src=\".." + shelve.FileName + "\" />";
            //                    List<CargoProductFileEntity> file = new List<CargoProductFileEntity>();
            //                    file.Add(new CargoProductFileEntity { FileName = shelve.FileName, ProductID = pro.ProductID, FilePath = ".." + shelve.FileName, FileType = "0" });
            //                    shelve.productFile = file;
            //                    bus.AddCargoProductShelves(shelve, log);
            //                }
            //            }
            //        }
            //        catch (ApplicationException ex)
            //        {
            //            LogHelper.WriteLog("自动上架出错" + pro.Specs + "/" + pro.Figure + "/" + pro.ProductID.ToString() + "/" + pro.TypeID.ToString());
            //            PushWeixinNotice("9");
            //            continue;
            //        }
            //    }
            //}
            #endregion

            #region 马牌系统库存和汕头云仓开思库存增量同步
            LogHelper.WriteLog("汕头南宁云仓开思增量推送开始");

            //马牌库存字典
            Dictionary<int, string> dicConti = new Dictionary<int, string>();
            Dictionary<string, string> dicContiComp = new Dictionary<string, string>();
            //汕头,龙华仓开思库存字典
            Dictionary<int, string> dicCass = new Dictionary<int, string>();
            string StProductCode = string.Empty;
            RedisValue[] redisValues = RedisHelper.HashKeys("OpenSystemStockSyc");
            foreach (RedisValue redisValue in redisValues)
            {
                string key = redisValue.ToString();//93_34_LTCT245452005
                string goodscode = Convert.ToString(RedisHelper.HashGet("OpenSystemStockSyc", key));//货品代码：03118970000
                                                                                                    //仓库ID
                int HouseID = Convert.ToInt32(key.Split('_')[0]);
                //品牌ID
                int TypeID = Convert.ToInt32(key.Split('_')[1]);
                //产品编码
                string ProductCode = Convert.ToString(key.Split('_')[2]);
                //处理马牌库存数据
                //if (dicConti.ContainsKey(HouseID))
                //{
                //    if (TypeID.Equals(34) || TypeID.Equals(345))
                //    {
                //        // 获取当前Key的内容
                //        string currentValue = dicConti[HouseID];

                //        // 更新内容
                //        string updatedValue = currentValue + "','" + goodscode;
                //        dicConti[HouseID] = updatedValue;
                //    }

                //}
                //else
                //{
                //    dicConti.Add(HouseID, goodscode);
                //}

                //处理龙华仓和汕头开思库存数据
                if (HouseID.Equals(91) || HouseID.Equals(101) || HouseID.Equals(136) || HouseID.Equals(93) || HouseID.Equals(107))
                {
                    if (dicCass.ContainsKey(HouseID))
                    {
                        // 获取当前Key的内容
                        string currentValue = dicCass[HouseID];

                        // 更新内容
                        string updatedValue = currentValue + "','" + ProductCode;
                        dicCass[HouseID] = updatedValue;
                    }
                    else
                    {
                        dicCass.Add(HouseID, ProductCode);
                    }
                }
            }

            //开始同步开思库存
            foreach (var cass in dicCass)
            {
                //调用汕头开思接口同步库存
                if (cass.Key.Equals(101))
                {
                    #region 汕头仓库存同步开思
                    ///汕头仓Session：67d89f8d06ca4360ae0358279b7d283c
                    try
                    {
                        List<StockApiEntity> res = nwBus.QueryYunCangStockSync(new CargoProductEntity { HouseID = cass.Key, ProductCode = cass.Value, SalePrice = 100 });
                        //StockApiResponseEntity STentity = new StockApiResponseEntity();
                        //STentity.Params = new Params();
                        //STentity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                        //STentity.data = new List<Data>();
                        StockApiResponseEntity entity = new StockApiResponseEntity();
                        entity.Params = new Params();
                        entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                        entity.data = new List<Data>();

                        if (res.Count > 0)
                        {
                            entity.Params.firstData = true;
                            entity.Params.lastData = true;
                            entity.Params.updateMode = "CHANGE";
                            long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                            string strRes = string.Empty;
                            entity.Params.tpsBatchId = tpsBatchId;
                            int cou = 0;
                            for (int i = 0; i < res.Count; i++)
                            {
                                if (cou == 500)
                                {
                                    // LogHelper.WriteLog("汕头仓开思推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                                    cou = 0;
                                    strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "67d89f8d06ca4360ae0358279b7d283c");
                                    //string cpStrRes500 = wxHttpUtility.SendPostHttpRequest("https://cp.neway5.com/Interface/OpenApi.ashx?cmd=StockDataSync", "application/json", JsonConvert.SerializeObject(STentity));

                                    //STentity = new StockApiResponseEntity();
                                    //STentity.Params = new Params();
                                    //STentity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                    //STentity.data = new List<Data>();

                                    entity = new StockApiResponseEntity();
                                    entity.Params = new Params();
                                    entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                    entity.data = new List<Data>();
                                    if (strRes.IndexOf("200") >= 0)
                                    {
                                        tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                        entity.Params.tpsBatchId = tpsBatchId;
                                        entity.Params.firstData = true;
                                        entity.Params.lastData = true;
                                        entity.Params.updateMode = "CHANGE";
                                    }
                                }

                                //STentity.data.Add(new Data
                                //{
                                //    CassProductCode = res[i].ProductCode,
                                //    ProductName = res[i].ProductName,
                                //    TypeName = res[i].TypeName,
                                //    SalePrice = Convert.ToDecimal(res[i].SalePrice) + 10,
                                //    StockNum = res[i].StockNum,
                                //    Batch = res[i].Batch,
                                //    HouseID = res[i].HouseID,//汕头仓+ Convert.ToDecimal(GetContiPrice())
                                //});
                                string casscode = res[i].CassProductCode;
                                if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                                {
                                    casscode = res[i].GoodsCode;
                                }
                                else
                                {
                                    casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                                }
                                string typename = res[i].TypeName;
                                if (res[i].TypeID.Equals(9))
                                {
                                    typename = "横滨/优科豪马";
                                }
                                else if (res[i].TypeID.Equals(66))
                                {
                                    typename = "固铂轮胎";
                                }
                                entity.data.Add(new Data
                                {
                                    CassProductCode = casscode,
                                    ProductName = res[i].ProductName,
                                    TypeName = typename,
                                    SalePrice = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice()),
                                    StockNum = res[i].StockNum,
                                    Batch = res[i].Batch,
                                    HouseID = res[i].HouseID,//汕头仓+ Convert.ToDecimal(GetContiPrice())
                                });
                                LogHelper.WriteLog("汕头仓开思增量推送ID:" + casscode + "，库存：" + res[i].StockNum.ToString() + "，周期：" + res[i].Batch + ",本次推送金额:" + Convert.ToDecimal(res[i].SalePrice) + ",加价金额:15");
                                cou++;

                            }
                            strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "67d89f8d06ca4360ae0358279b7d283c");

                            //string data = JsonConvert.SerializeObject(STentity);

                            //string cpStrRes = wxHttpUtility.SendPostHttpRequest("https://cp.neway5.com/Interface/OpenApi.ashx?cmd=StockDataSync", "application/json", data);

                            LogHelper.WriteLog("汕头仓开思增量推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                            if (strRes.IndexOf("200") >= 0)
                            {
                                nwBus.UpdateStatus(res);
                                LogHelper.WriteLog("汕头仓开思增量推送成功!共计" + res.Count + "条数据");
                            }
                            //if (cpStrRes.IndexOf("1000") >= 0)
                            //{
                            //    //bus.UpdateStatus(res);
                            //    LogHelper.WriteLog("汕头仓城配快送推送成功!共计" + res.Count + "条数据");
                            //}
                        }

                    }
                    catch (Exception ex)
                    {
                        LogHelper.WriteLog("汕头仓开思增量推送出现错误!Message" + ex.Message);
                        continue;
                    }
                    #endregion
                }
                else if (cass.Key.Equals(91))
                {
                    #region 龙华云仓库存同步开思
                    try
                    {
                        List<StockApiEntity> res = nwBus.QueryYunCangStockSync(new CargoProductEntity { HouseID = cass.Key, ProductCode = cass.Value, SalePrice = 100 });

                        StockApiResponseEntity entity = new StockApiResponseEntity();
                        entity.Params = new Params();
                        entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                        entity.data = new List<Data>();

                        if (res.Count > 0)
                        {
                            entity.Params.firstData = true;
                            entity.Params.lastData = true;
                            entity.Params.updateMode = "CHANGE";
                            long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                            string strRes = string.Empty;
                            entity.Params.tpsBatchId = tpsBatchId;
                            int cou = 0;
                            for (int i = 0; i < res.Count; i++)
                            {
                                if (cou == 500)
                                {
                                    // LogHelper.WriteLog("汕头仓开思推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                                    cou = 0;
                                    strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "1f7bd12607104fd3a152daf7c1896bb0");

                                    entity = new StockApiResponseEntity();
                                    entity.Params = new Params();
                                    entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                    entity.data = new List<Data>();
                                    if (strRes.IndexOf("200") >= 0)
                                    {
                                        tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                        entity.Params.tpsBatchId = tpsBatchId;
                                        entity.Params.firstData = true;
                                        entity.Params.lastData = true;
                                        entity.Params.updateMode = "CHANGE";
                                    }
                                }
                                string casscode = res[i].CassProductCode;
                                if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                                {
                                    casscode = res[i].GoodsCode;
                                }
                                else
                                {
                                    casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                                }
                                string typename = res[i].TypeName;
                                if (res[i].TypeID.Equals(9))
                                {
                                    typename = "横滨/优科豪马";
                                }
                                else if (res[i].TypeID.Equals(66))
                                {
                                    typename = "固铂轮胎";
                                }
                                entity.data.Add(new Data
                                {
                                    CassProductCode = casscode,
                                    ProductName = res[i].ProductName,
                                    TypeName = typename,
                                    SalePrice = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice()),
                                    StockNum = res[i].StockNum,
                                    Batch = res[i].Batch,
                                    HouseID = res[i].HouseID,//汕头仓+ Convert.ToDecimal(GetContiPrice())
                                });
                                LogHelper.WriteLog("龙华云仓开思增量推送ID:" + casscode + "，库存：" + res[i].StockNum.ToString() + "，周期：" + res[i].Batch + ",本次推送金额:" + Convert.ToDecimal(res[i].SalePrice) + ",加价金额:" + GetContiPrice().ToString());
                                cou++;

                            }
                            strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "1f7bd12607104fd3a152daf7c1896bb0");


                            LogHelper.WriteLog("龙华云仓开思增量推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                            if (strRes.IndexOf("200") >= 0)
                            {
                                nwBus.UpdateStatus(res);
                                LogHelper.WriteLog("龙华云仓开思增量推送成功!共计" + res.Count + "条数据");
                            }
                        }

                    }
                    catch (Exception ex)
                    {
                        LogHelper.WriteLog("龙华云仓开思增量推送出现错误!Message" + ex.Message);
                        continue;
                    }
                    #endregion
                }
                else if (cass.Key.Equals(136))
                {
                    #region 南宁云仓库存同步开思
                    try
                    {
                        List<StockApiEntity> res = nwBus.QueryYunCangStockSync(new CargoProductEntity { HouseID = cass.Key, ProductCode = cass.Value, SalePrice = 100 });
                        StockApiResponseEntity entity = new StockApiResponseEntity();
                        entity.Params = new Params();
                        entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                        entity.data = new List<Data>();

                        if (res.Count > 0)
                        {
                            entity.Params.firstData = true;
                            entity.Params.lastData = true;
                            entity.Params.updateMode = "CHANGE";
                            long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                            string strRes = string.Empty;
                            entity.Params.tpsBatchId = tpsBatchId;
                            int cou = 0;
                            for (int i = 0; i < res.Count; i++)
                            {
                                if (cou == 500)
                                {
                                    cou = 0;
                                    strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "2b2b36889e304645b28f94bfdd2ead9e");

                                    entity = new StockApiResponseEntity();
                                    entity.Params = new Params();
                                    entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                    entity.data = new List<Data>();
                                    if (strRes.IndexOf("200") >= 0)
                                    {
                                        tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                        entity.Params.tpsBatchId = tpsBatchId;
                                        entity.Params.firstData = true;
                                        entity.Params.lastData = true;
                                        entity.Params.updateMode = "CHANGE";
                                    }
                                }
                                string casscode = res[i].CassProductCode;
                                if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                                {
                                    casscode = res[i].GoodsCode;
                                }
                                else
                                {
                                    casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                                }
                                string typename = res[i].TypeName;
                                if (res[i].TypeID.Equals(9))
                                {
                                    typename = "横滨/优科豪马";
                                }
                                else if (res[i].TypeID.Equals(66))
                                {
                                    typename = "固铂轮胎";
                                }
                                decimal saleprice = 0.00M;
                                if (GetNanNingMarkupType().Equals(0))
                                {
                                    //按百分比
                                    saleprice = Math.Ceiling(res[i].SalePrice * (1 + GetNanNingMarkupPrice() / 100));

                                }
                                else
                                {
                                    saleprice = res[i].SalePrice + GetNanNingMarkupPrice();
                                }
                                entity.data.Add(new Data
                                {
                                    CassProductCode = casscode,
                                    ProductName = res[i].ProductName,
                                    TypeName = typename,
                                    SalePrice = saleprice,
                                    StockNum = res[i].StockNum,
                                    Batch = res[i].Batch,
                                    HouseID = res[i].HouseID,
                                });
                                LogHelper.WriteLog("南宁云仓开思增量推送ID:" + casscode + "，库存：" + res[i].StockNum.ToString() + "，周期：" + res[i].Batch + ",本次推送金额:" + saleprice.ToString());
                                cou++;

                            }
                            strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "2b2b36889e304645b28f94bfdd2ead9e");


                            LogHelper.WriteLog("南宁云仓开思增量推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                            if (strRes.IndexOf("200") >= 0)
                            {
                                nwBus.UpdateStatus(res);
                                LogHelper.WriteLog("南宁云仓开思增量推送成功!共计" + res.Count + "条数据");
                            }
                        }

                    }
                    catch (Exception ex)
                    {
                        LogHelper.WriteLog("南宁云仓开思增量推送出现错误!Message" + ex.Message);
                        continue;
                    }
                    #endregion
                }
                else if (cass.Key.Equals(135))
                {
                    #region 揭阳云仓库存同步开思
                    try
                    {
                        List<StockApiEntity> res = nwBus.QueryYunCangStockSync(new CargoProductEntity { HouseID = cass.Key, ProductCode = cass.Value, SalePrice = 100 });
                        StockApiResponseEntity entity = new StockApiResponseEntity();
                        entity.Params = new Params();
                        entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                        entity.data = new List<Data>();

                        if (res.Count > 0)
                        {
                            entity.Params.firstData = true;
                            entity.Params.lastData = true;
                            entity.Params.updateMode = "CHANGE";
                            long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                            string strRes = string.Empty;
                            entity.Params.tpsBatchId = tpsBatchId;
                            int cou = 0;
                            for (int i = 0; i < res.Count; i++)
                            {
                                if (cou == 500)
                                {
                                    cou = 0;
                                    strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "a027b23d19f941a59a361268fb94ab10");

                                    entity = new StockApiResponseEntity();
                                    entity.Params = new Params();
                                    entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                    entity.data = new List<Data>();
                                    if (strRes.IndexOf("200") >= 0)
                                    {
                                        tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                        entity.Params.tpsBatchId = tpsBatchId;
                                        entity.Params.firstData = true;
                                        entity.Params.lastData = true;
                                        entity.Params.updateMode = "CHANGE";
                                    }
                                }
                                string casscode = res[i].CassProductCode;
                                if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                                {
                                    casscode = res[i].GoodsCode;
                                }
                                else
                                {
                                    casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                                }
                                string typename = res[i].TypeName;
                                if (res[i].TypeID.Equals(9))
                                {
                                    typename = "横滨/优科豪马";
                                }
                                else if (res[i].TypeID.Equals(66))
                                {
                                    typename = "固铂轮胎";
                                }
                                //decimal saleprice = 0.00M;
                                //if (GetNanNingMarkupType().Equals(0))
                                //{
                                //    //按百分比
                                //    saleprice = Math.Ceiling(res[i].SalePrice * (1 + GetNanNingMarkupPrice() / 100));

                                //}
                                //else
                                //{
                                //    saleprice = res[i].SalePrice + GetNanNingMarkupPrice();
                                //}
                                entity.data.Add(new Data
                                {
                                    CassProductCode = casscode,
                                    ProductName = res[i].ProductName,
                                    TypeName = typename,
                                    SalePrice = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(GetContiPrice()),
                                    StockNum = res[i].StockNum,
                                    Batch = res[i].Batch,
                                    HouseID = res[i].HouseID,
                                });
                                LogHelper.WriteLog("揭阳云仓开思增量推送ID:" + casscode + "，库存：" + res[i].StockNum.ToString() + "，周期：" + res[i].Batch + ",本次推送金额:" + Convert.ToDecimal(res[i].SalePrice) + ",加价金额:15");
                                cou++;

                            }
                            strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "a027b23d19f941a59a361268fb94ab10");


                            LogHelper.WriteLog("揭阳云仓开思增量推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                            if (strRes.IndexOf("200") >= 0)
                            {
                                //nwBus.UpdateStatus(res);
                                LogHelper.WriteLog("揭阳云仓开思增量推送成功!共计" + res.Count + "条数据");
                            }
                        }

                    }
                    catch (Exception ex)
                    {
                        LogHelper.WriteLog("揭阳云仓开思增量推送出现错误!Message" + ex.Message);
                        continue;
                    }
                    #endregion
                }
                else if (cass.Key.Equals(93))
                {
                    #region 东平云仓库存同步开思
                    try
                    {
                        List<StockApiEntity> res = nwBus.QueryYunCangStockSync(new CargoProductEntity { HouseID = cass.Key, ProductCode = cass.Value, SalePrice = 100 });
                        StockApiResponseEntity entity = new StockApiResponseEntity();
                        entity.Params = new Params();
                        entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                        entity.data = new List<Data>();

                        if (res.Count > 0)
                        {
                            entity.Params.firstData = true;
                            entity.Params.lastData = true;
                            entity.Params.updateMode = "CHANGE";
                            long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                            string strRes = string.Empty;
                            entity.Params.tpsBatchId = tpsBatchId;
                            int cou = 0;
                            for (int i = 0; i < res.Count; i++)
                            {
                                if (cou == 500)
                                {
                                    cou = 0;
                                    strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "43b87acafffe4919926ec17de7b6f930");

                                    entity = new StockApiResponseEntity();
                                    entity.Params = new Params();
                                    entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                    entity.data = new List<Data>();
                                    if (strRes.IndexOf("200") >= 0)
                                    {
                                        tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                        entity.Params.tpsBatchId = tpsBatchId;
                                        entity.Params.firstData = true;
                                        entity.Params.lastData = true;
                                        entity.Params.updateMode = "CHANGE";
                                    }
                                }
                                string casscode = res[i].CassProductCode;
                                if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                                {
                                    casscode = res[i].GoodsCode;
                                }
                                else
                                {
                                    casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                                }
                                string typename = res[i].TypeName;
                                if (res[i].TypeID.Equals(9))
                                {
                                    typename = "横滨/优科豪马";
                                }
                                else if (res[i].TypeID.Equals(66))
                                {
                                    typename = "固铂轮胎";
                                }
                                //decimal saleprice = 0.00M;
                                //if (GetNanNingMarkupType().Equals(0))
                                //{
                                //    //按百分比
                                //    saleprice = Math.Ceiling(res[i].SalePrice * (1 + GetNanNingMarkupPrice() / 100));

                                //}
                                //else
                                //{
                                //    saleprice = res[i].SalePrice + GetNanNingMarkupPrice();
                                //}
                                entity.data.Add(new Data
                                {
                                    CassProductCode = casscode,
                                    ProductName = res[i].ProductName,
                                    TypeName = typename,
                                    SalePrice = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(15),//GetContiPrice()
                                    StockNum = res[i].StockNum,
                                    Batch = res[i].Batch,
                                    HouseID = res[i].HouseID,
                                });
                                LogHelper.WriteLog("东平云仓开思增量推送ID:" + casscode + "，库存：" + res[i].StockNum.ToString() + "，周期：" + res[i].Batch + ",本次推送金额:" + Convert.ToDecimal(res[i].SalePrice) + ",加价金额:15");
                                cou++;

                            }
                            strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "43b87acafffe4919926ec17de7b6f930");


                            LogHelper.WriteLog("东平云仓开思增量推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                            if (strRes.IndexOf("200") >= 0)
                            {
                                //nwBus.UpdateStatus(res);
                                LogHelper.WriteLog("东平云仓开思增量推送成功!共计" + res.Count + "条数据");
                            }
                        }

                    }
                    catch (Exception ex)
                    {
                        LogHelper.WriteLog("东平云仓开思增量推送出现错误!Message" + ex.Message);
                        continue;
                    }
                    #endregion
                }
                else if (cass.Key.Equals(107))
                {
                    #region 从化云仓库存同步开思
                    try
                    {
                        List<StockApiEntity> res = nwBus.QueryYunCangStockSync(new CargoProductEntity { HouseID = cass.Key, ProductCode = cass.Value, SalePrice = 100 });
                        StockApiResponseEntity entity = new StockApiResponseEntity();
                        entity.Params = new Params();
                        entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                        entity.data = new List<Data>();

                        if (res.Count > 0)
                        {
                            entity.Params.firstData = true;
                            entity.Params.lastData = true;
                            entity.Params.updateMode = "CHANGE";
                            long tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                            string strRes = string.Empty;
                            entity.Params.tpsBatchId = tpsBatchId;
                            int cou = 0;
                            for (int i = 0; i < res.Count; i++)
                            {
                                if (cou == 500)
                                {
                                    cou = 0;
                                    strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "43b87acafffe4919926ec17de7b6f930");

                                    entity = new StockApiResponseEntity();
                                    entity.Params = new Params();
                                    entity.Params.thirdPartySystemParams = new ThirdPartySystemParams();
                                    entity.data = new List<Data>();
                                    if (strRes.IndexOf("200") >= 0)
                                    {
                                        tpsBatchId = Convert.ToInt64((DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds);
                                        entity.Params.tpsBatchId = tpsBatchId;
                                        entity.Params.firstData = true;
                                        entity.Params.lastData = true;
                                        entity.Params.updateMode = "CHANGE";
                                    }
                                }
                                string casscode = res[i].CassProductCode;
                                if (res[i].TypeID.Equals(34) || res[i].TypeID.Equals(345) || res[i].TypeID.Equals(163))
                                {
                                    casscode = res[i].GoodsCode;
                                }
                                else
                                {
                                    casscode = string.IsNullOrEmpty(res[i].CassProductCode) ? res[i].ProductCode : res[i].CassProductCode;

                                }
                                string typename = res[i].TypeName;
                                if (res[i].TypeID.Equals(9))
                                {
                                    typename = "横滨/优科豪马";
                                }
                                else if (res[i].TypeID.Equals(66))
                                {
                                    typename = "固铂轮胎";
                                }
                                //decimal saleprice = 0.00M;
                                //if (GetNanNingMarkupType().Equals(0))
                                //{
                                //    //按百分比
                                //    saleprice = Math.Ceiling(res[i].SalePrice * (1 + GetNanNingMarkupPrice() / 100));

                                //}
                                //else
                                //{
                                //    saleprice = res[i].SalePrice + GetNanNingMarkupPrice();
                                //}
                                entity.data.Add(new Data
                                {
                                    CassProductCode = casscode,
                                    ProductName = res[i].ProductName,
                                    TypeName = typename,
                                    SalePrice = Convert.ToDecimal(res[i].SalePrice) + Convert.ToDecimal(15),//GetContiPrice()
                                    StockNum = res[i].StockNum,
                                    Batch = res[i].Batch,
                                    HouseID = res[i].HouseID,
                                });
                                LogHelper.WriteLog("从化云仓开思增量推送ID:" + casscode + "，库存：" + res[i].StockNum.ToString() + "，周期：" + res[i].Batch + ",本次推送金额:" + Convert.ToDecimal(res[i].SalePrice) + ",加价金额:15");
                                cou++;

                            }
                            strRes = wxHttpUtility.PostHttpRequest("https://api.cassmall.com/api", "application/json", JSON.Encode(entity).Replace("Params", "params").Replace("thirdPartySystemparams", "thirdPartySystemParams"), "43b87acafffe4919926ec17de7b6f930");


                            LogHelper.WriteLog("从化云仓开思增量推送ID:" + tpsBatchId + ",本次推送条数:" + cou);
                            if (strRes.IndexOf("200") >= 0)
                            {
                                //nwBus.UpdateStatus(res);
                                LogHelper.WriteLog("从化云仓开思增量推送成功!共计" + res.Count + "条数据");
                            }
                        }

                    }
                    catch (Exception ex)
                    {
                        LogHelper.WriteLog("从化云仓开思增量推送出现错误!Message" + ex.Message);
                        continue;
                    }
                    #endregion
                }
            }

            RedisHelper.KeyDelete("OpenSystemStockSyc");
            LogHelper.WriteLog("Redis缓存删除成功");
            #endregion

        }
        /// <summary>
        /// 向TMS推送运单数据
        /// </summary>
        /// <param name="it"></param>
        private void AddTMSAwbNo(CargoOrderPushEntity it)
        {
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "定单推送服务";
            log.UserID = RobotID;
            log.Operate = "A";
            CargoOrderBus order = new CargoOrderBus();

            CargoOrderEntity OEnt = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = it.OrderNo });
            if (OEnt.OrderID.Equals(0)) { return; }
            if (OEnt.OutHouseName.Equals("狄乐云仓")) { return; }

            List<CargoContainerShowEntity> OEntGoods = order.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = it.OrderNo });
            string ShipperName = string.Empty;
            string ShipperUnit = string.Empty;
            string ShipperCellphone = string.Empty;
            string ShipperAddress = string.Empty;
            string Belong = "CP";
            decimal UnitP = 0.00M;
            string De = "";
            UnitP = 15;
            ShipperName = "邱小彬";
            ShipperUnit = "新陆城配";
            ShipperCellphone = "13631442958";
            ShipperAddress = "广州市白云区东平北路";
            string ClientNum = "";
            if (it.OrderNo.Contains("NG"))
            {
                //南宁批发仓 推送到南宁分公司TMS系统 12元一条
                Belong = "NN";
                De = "南宁";
                UnitP = 0;
                ShipperName = "南宁分公司";
                ShipperUnit = "南宁分公司";
                ShipperCellphone = "13113333081";
                ShipperAddress = "广西南宁市西乡塘区南武大道永宁小学背后容顺物流园右侧一栋5-6号";
                ClientNum = "132208";
            }
            else if (it.OrderNo.Contains("YZ"))
            {
                //增城云仓
                De = "广州";
                string[] strings = { "揭阳", "汕头", "潮州", "梅州", "汕尾", "普宁", "河源", "茂名", "湛江", "阳江" };

                if (!OEnt.Province.Equals("广东"))
                {
                    De = OEnt.Dest;
                }
                UnitP = 0;
                ShipperName = "广州迪乐泰";
                ShipperUnit = "广州迪乐泰";
                ShipperCellphone = "13265180164";
                ShipperAddress = "增城区广百骏盈现代物流园";
            }

            decimal hz = Convert.ToDecimal(UnitP);//轮胎运输费用汇总


            #region 明细
            string go = "[";
            if (OEntGoods.Count > 0)
            {
                foreach (var itt in OEntGoods)
                {
                    //go += "{\"Goods\":\"" + itt.TypeName + itt.Specs + itt.Figure + "\",\"Piece\":\"" + itt.Piece.ToString() + "\",\"OPDATE\":\"" + itt.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss") + "\"},";

                    go += "{\"Goods\":\"" + itt.TypeName + " " + itt.Specs + " " + itt.Figure + " " + itt.LoadIndex + itt.SpeedLevel + "\",\"Package\":\"无\",\"Piece\":\"" + itt.Piece.ToString() + "\",\"PiecePrice\":\"" + UnitP + "\",\"OP_DATE\":\"" + itt.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss") + "\",\"ProductName\":\"" + itt.ProductName + "\",\"Model\":\"" + itt.Model + "\",\"GoodsCode\":\"" + itt.GoodsCode + "\",\"Specs\":\"" + itt.Specs + "\",\"Figure\":\"" + itt.Figure + "\",\"LoadIndex\":\"" + itt.LoadIndex + "\",\"SpeedLevel\":\"" + itt.SpeedLevel + "\",\"Batch\":\"" + itt.Batch + "\",\"ContainerCode\":\"" + itt.ContainerCode + "\",\"TypeName\":\"" + itt.TypeName + "\"},";
                }
                go = go.Substring(0, go.Length - 1);
            }
            go += "]";
            #endregion

            string ss = "{\"HAwbNo\":\"" + OEnt.OrderNo + "\",\"Dep\":\"" + OEnt.Dep + "\",\"Dest\":\"" + De + "\",\"Transit\":\"" + OEnt.Dest + "\",\"Piece\":\"" + OEnt.Piece.ToString() + "\",\"AwbPiece\":\"" + OEnt.Piece.ToString() + "\",\"InsuranceFee\":\"0\",\"TransportFee\":\"" + hz.ToString("F2") + "\",\"OtherFee\":\"0\",\"TotalCharge\":\"" + hz.ToString("F2") + "\",\"ShipperName\":\"" + ShipperName + "\",\"ShipperUnit\":\"" + ShipperUnit + "\",\"ShipperTelephone\":\"" + ShipperCellphone + "\",\"ShipperCellphone\":\"" + ShipperCellphone + "\",\"ShipperAddress\":\"" + ShipperAddress + "\",\"AcceptUnit\":\"" + OEnt.AcceptUnit + "\",\"AcceptPeople\":\"" + OEnt.AcceptPeople + "\",\"AcceptTelephone\":\"" + OEnt.AcceptTelephone + "\",\"AcceptCellphone\":\"" + OEnt.AcceptCellphone + "\",\"AcceptAddress\":\"" + OEnt.AcceptAddress + "\",\"HandleTime\":\"" + OEnt.CreateDate.ToString("yyyy-MM-dd HH:mm:ss") + "\",\"Remark\":\"" + OEnt.Remark + "\",\"ClientNum\":\"" + ClientNum + "\",\"Goods\":" + go + "}";

            string data = "cmd=SaveTmsAwbNoData&OrderList=[" + ss + "]&Belong=" + Belong;
            string xlcawbno = wxHttpUtility.SendHttpRequest("http://tms.hlyex.com/webSer/tmsAPI.ashx", data);
            if (!string.IsNullOrEmpty(xlcawbno))
            {
                ArrayList GridRows = (ArrayList)JSON.Decode("[" + xlcawbno + "]");
                foreach (Hashtable row in GridRows)
                {
                    if (Convert.ToBoolean(row["Result"]))
                    {
                        //更新新陆程 运单 号回仓储系统订单
                        if (OEnt.LogisID.Equals(283) || OEnt.LogisID.Equals(383))
                        {
                            order.UpdateLogisAwbNo(it.OrderNo, Convert.ToString(row["Message"]), "", log);
                        }
                        else
                        {
                            order.UpdateHAwbNo(it.OrderNo, Convert.ToString(row["Message"]), log);
                        }
                        order.UpdateCargoOrderPushAwbNo(new CargoOrderPushEntity { OrderNo = it.OrderNo, AwbNo = Convert.ToString(row["Message"]), PushStatus = "1" }, log);
                    }
                }

            }
        }
        /// <summary>
        /// 新增推送新陆程 运单 
        /// </summary>
        /// <param name="it"></param>
        private void AddNewyayAwbNo(CargoOrderPushEntity it)
        {
            //if (it.OrderNo.Contains("GD"))
            //{
            //    //非东莞和深圳仓库订单，直接返回
            //    return;
            //}
            //机器人账号
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "定单推送服务";
            log.UserID = RobotID;
            log.Operate = "A";
            CargoOrderBus order = new CargoOrderBus();

            CargoOrderEntity OEnt = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = it.OrderNo });
            if (OEnt.OrderID.Equals(0)) { return; }
            if (OEnt.HouseID.Equals(84) && OEnt.OutHouseName.Equals("狄乐云仓"))
            {
                return;
            }
            List<CargoContainerShowEntity> OEntGoods = order.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = it.OrderNo });
            //2020-06-19 修改产品单价，轮胎12元一条itt.ActSalePrice.ToString("F2")
            string ShipperName = string.Empty;
            string ShipperUnit = string.Empty;
            string ShipperCellphone = string.Empty;
            string ShipperAddress = string.Empty;
            string Belong = "NW";
            decimal UnitP = 0.00M;
            //string dest = "海口,澄迈,临高,儋州,洋浦,昌江,东方,八所,乐东,九所,黄流,崖城,三亚,保亭,陵水,万宁,琼海,定安,文昌,屯昌,琼中,五指山,白沙";
            string De = string.Empty;
            //if (dest.Contains(OEnt.Dest)) { De = "海口"; }
            if (it.OrderNo.Contains("HN"))
            {
                //海南仓库 12元一条
                De = "海口";
                UnitP = 12;
                ShipperName = "文佳";
                ShipperUnit = "海南迪乐泰";
                ShipperCellphone = "13597131644";
                ShipperAddress = "港澳开发区兴业路21号新陆程物流";
            }
            else if (it.OrderNo.Contains("HC"))
            {
                //海口城配仓库 16元一条
                De = "海口";
                UnitP = 6.7M;
                ShipperName = "邬茜";
                ShipperUnit = "海口新陆程";
                ShipperCellphone = "15595958682";
                ShipperAddress = "海口高新区兴海路19-2号";
            }
            //else if (it.OrderNo.Contains("JY"))
            //{
            //    //揭阳仓库 16元一条
            //    De = "揭阳";
            //    UnitP = 16;
            //    ShipperName = "陆卓珩";
            //    ShipperUnit = "揭阳马牌";
            //    ShipperCellphone = "17876086775";
            //    ShipperAddress = "揭阳新陆程物流";
            //}
            //else if (it.OrderNo.Contains("JE"))
            //{
            //    //揭阳仓库 16元一条
            //    De = "揭阳";
            //    UnitP = 0;
            //    ShipperName = "吴少聪";
            //    ShipperUnit = "吴少聪";
            //    ShipperCellphone = "13790699286";
            //    ShipperAddress = "揭阳新陆程物流";
            //}
            //else if (it.OrderNo.Contains("JC"))
            //{
            //    //揭阳仓库 16元一条
            //    De = "揭阳";
            //    UnitP = 1;
            //    ShipperName = "陆卓珩";
            //    ShipperUnit = "揭阳马牌";
            //    ShipperCellphone = "17876086775";
            //    ShipperAddress = "揭阳新陆程物流";
            //}
            else if (it.OrderNo.Contains("DG") || it.OrderNo.Contains("GD"))
            {
                //东莞仓库，市内10元
                De = "东莞";
                UnitP = 10;
                if (!OEnt.Dest.Contains(De))
                {
                    //市外16
                    UnitP = 16;
                }
                ShipperName = "吴少勇";
                ShipperUnit = "东莞新陆程";
                ShipperCellphone = "13712021315";
                ShipperAddress = "东莞市厚街镇寮厦村三杰物业C区8-2门新陆程物流";
            }
            else if (it.OrderNo.Contains("SZ"))
            {
                //深圳仓库
                De = "深圳";
                UnitP = 30;
                if (!OEnt.Dest.Contains(De))
                {
                    //市外16
                    UnitP = 30;
                }
                ShipperName = "吴少勇";
                ShipperUnit = "新陆程";
                ShipperCellphone = "13712021315";
                ShipperAddress = "深圳市龙华区老围第二工业区(联围街西)";
                //ShipperName = "广州迪乐泰";
                //ShipperUnit = "广州迪乐泰";
                //ShipperCellphone = "13265180164";
                //ShipperAddress = "东莞市鹿苑路162号亚力通科技园";
                //Belong = "FJ";
            }
            else if (it.OrderNo.Contains("LH"))
            {
                //深圳仓库
                De = "深圳";
                UnitP = 30;
                if (!OEnt.Dest.Contains(De))
                {
                    //市外16
                    UnitP = 30;
                }
                ShipperName = "唐国其";
                ShipperUnit = "新陆程";
                ShipperCellphone = "17377729274";
                ShipperAddress = "深圳市龙华区民治街道景龙中环路第五工业区1区16号概念孵化空间6栋2楼";
                //ShipperName = "广州迪乐泰";
                //ShipperUnit = "广州迪乐泰";
                //ShipperCellphone = "13265180164";
                //ShipperAddress = "东莞市鹿苑路162号亚力通科技园";
                //Belong = "FJ";
            }
            else if (it.OrderNo.Contains("YS"))
            {
                //深圳沙井云仓 16元一条
                De = "深圳";
                UnitP = 0;
                ShipperName = "吴少勇";
                ShipperUnit = "新陆程";
                ShipperCellphone = "13712021315";
                ShipperAddress = "深圳市龙华区老围第二工业区(联围街西)";
            }
            //else if (it.OrderNo.Contains("NS"))
            //{
            //    //深圳沙井云仓 16元一条
            //    De = "深圳";
            //    UnitP = 0;
            //    ShipperName = "洪康华";
            //    ShipperUnit = "新陆程";
            //    ShipperCellphone = "19854795302";
            //    ShipperAddress = "广东省深圳市宝安区洪浪北地铁站C口步行400米";
            //}
            else if (it.OrderNo.Contains("HP"))
            {
                //华南配件仓
                //揭阳，汕头，潮州，梅州，汕尾，普宁，河源，茂名，湛江，阳江
                De = "广州";
                string[] strings = { "揭阳", "汕头", "潮州", "梅州", "汕尾", "普宁", "河源", "茂名", "湛江", "阳江" };

                if (!OEnt.Province.Equals("广东") || strings.Contains(OEnt.Dest))
                {
                    De = OEnt.Dest;
                }
                UnitP = 0;
                ShipperName = "官总";
                ShipperUnit = "狄乐汽服广州";
                ShipperCellphone = "";
                ShipperAddress = "增城仓库";
            }
            else if (it.OrderNo.Contains("XL") || it.OrderNo.Contains("KK"))
            {
                //华南配件仓
                //揭阳，汕头，潮州，梅州，汕尾，普宁，河源，茂名，湛江，阳江
                De = "广州";
                string[] strings = { "揭阳", "汕头", "潮州", "梅州", "汕尾", "普宁", "河源", "茂名", "湛江", "阳江" };

                if (!OEnt.Province.Equals("广东"))
                {
                    De = OEnt.Dest;
                }
                UnitP = 0;
                ShipperName = "广州迪乐泰";
                ShipperUnit = "广州迪乐泰";
                ShipperCellphone = "13265180164";
                ShipperAddress = "增城区广百骏盈现代物流园";
            }
            else if (it.OrderNo.Contains("DL"))
            {
                //狄乐汽服仓
                //广州，东莞，深圳，惠州，中山 自送，推送过去直接到达，做到达配送
                De = "广州";
                //string[] strings = { "广州", "东莞", "深圳", "惠州", "中山" };
                string[] strings = { "广州" };

                if (!strings.Contains(OEnt.Dest))
                {
                    De = OEnt.Dest;
                }
                //if (!OEnt.Province.Equals("广东"))
                //{
                //    De = OEnt.Dest;
                //}
                UnitP = 0;
                ShipperName = "罗总";
                ShipperUnit = "狄乐汽服广州";
                ShipperCellphone = "13265180164";
                ShipperAddress = "增城区广百骏盈现代物流园";
            }
            else if (it.OrderNo.Contains("YZ"))
            {
                //增城云仓
                De = "增城";
                string[] strings = { "广州", "东莞" };

                if (!strings.Contains(OEnt.Dest))
                {
                    De = OEnt.Dest;
                }
                UnitP = 0;
                ShipperName = "广州迪乐泰";
                ShipperUnit = "广州迪乐泰";
                ShipperCellphone = "13265180164";
                ShipperAddress = "增城区广百骏盈现代物流园";
            }
            else if (it.OrderNo.Contains("ST"))
            {
                //汕头云仓
                De = "汕头";
                //string[] strings = { "揭阳", "汕头", "潮州", "梅州", "汕尾", "普宁", "河源", "茂名", "湛江", "阳江" };

                //if (!OEnt.Province.Equals("广东"))
                //{
                //    De = OEnt.Dest;
                //}
                UnitP = 0;
                ShipperName = "吴少聪";
                ShipperUnit = "吴少聪";
                ShipperCellphone = "13790699286";
                ShipperAddress = "广东省汕头市龙湖区新津街道 新津路南侧牡丹围8号";
            }
            decimal hz = Convert.ToDecimal(OEnt.Piece * UnitP);//轮胎运输费用汇总
            #region 明细
            string go = "[";
            if (OEntGoods.Count > 0)
            {
                foreach (var itt in OEntGoods)
                {
                    go += "{\"Goods\":\"" + itt.TypeName + itt.Specs + itt.Figure + "\",\"Package\":\"无\",\"Piece\":\"" + itt.Piece.ToString() + "\",\"PiecePrice\":\"" + UnitP + "\",\"OP_DATE\":\"" + itt.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss") + "\",\"ProductName\":\"" + itt.ProductName + "\",\"Model\":\"" + itt.Model + "\",\"GoodsCode\":\"" + itt.GoodsCode + "\",\"Specs\":\"" + itt.Specs + "\",\"Figure\":\"" + itt.Figure + "\",\"LoadIndex\":\"" + itt.LoadIndex + "\",\"SpeedLevel\":\"" + itt.SpeedLevel + "\",\"Batch\":\"" + itt.Batch + "\",\"ContainerCode\":\"" + itt.ContainerCode + "\",\"TypeName\":\"" + itt.TypeName + "\"},";
                }
                go = go.Substring(0, go.Length - 1);
            }
            go += "]";
            #endregion

            string ss = "{\"HAwbNo\":\"" + OEnt.OrderNo + "\",\"Dep\":\"" + OEnt.Dep + "\",\"Dest\":\"" + De + "\",\"Transit\":\"" + OEnt.Dest + "\",\"Piece\":\"" + OEnt.Piece.ToString() + "\",\"InsuranceFee\":\"0\",\"TransitFee\":\"0\",\"TransportFee\":\"" + hz.ToString("F2") + "\",\"DeliverFee\":\"0\",\"OtherFee\":\"0\",\"TotalCharge\":\"" + hz.ToString("F2") + "\",\"CheckOutType\":\"2\",\"ReturnAwb\":\"\",\"ShipperName\":\"" + ShipperName + "\",\"ShipperUnit\":\"" + ShipperUnit + "\",\"ShipperTelephone\":\"" + ShipperCellphone + "\",\"ShipperCellphone\":\"" + ShipperCellphone + "\",\"ShipperAddress\":\"" + ShipperAddress + "\",\"AcceptUnit\":\"" + OEnt.AcceptUnit + "\",\"AcceptPeople\":\"" + OEnt.AcceptPeople + "\",\"AcceptTelephone\":\"" + OEnt.AcceptTelephone + "\",\"AcceptCellphone\":\"" + OEnt.AcceptCellphone + "\",\"AcceptAddress\":\"" + OEnt.AcceptAddress + "\",\"HandleTime\":\"" + OEnt.CreateDate.ToString("yyyy-MM-dd HH:mm:ss") + "\",\"Remark\":\"" + OEnt.Remark + "\",\"Goods\":" + go + "}";

            string data = "cmd=SaveNewayAwbNo&OrderList=[" + ss + "]&Belong=" + Belong;
            string xlcawbno = wxHttpUtility.SendHttpRequest("http://xt.neway5.com/Interface/OMSInterface.ashx", data);
            LogHelper.WriteLog("返回新陆程运单号" + it.OrderNo);

            if (!string.IsNullOrEmpty(xlcawbno))
            {
                ArrayList GridRows = (ArrayList)JSON.Decode("[" + xlcawbno + "]");
                foreach (Hashtable row in GridRows)
                {
                    if (Convert.ToBoolean(row["Result"]))
                    {
                        //更新新陆程 运单 号回仓储系统订单
                        if (OEnt.LogisID.Equals(62) || OEnt.LogisID.Equals(24) || OEnt.LogisID.Equals(26))
                        {
                            order.UpdateLogisAwbNo(it.OrderNo, Convert.ToString(row["Message"]), "", log);
                        }
                        else
                        {
                            order.UpdateHAwbNo(it.OrderNo, Convert.ToString(row["Message"]), log);
                        }
                        LogHelper.WriteLog("返回新陆程运单号" + it.OrderNo + Convert.ToString(row["Message"]));
                    }
                }

            }
            LogHelper.WriteLog("上传新陆程成功" + it.OrderNo);
        }
        /// <summary>
        /// 推送运单数据 将新陆程 和123成都的运单跟踪数据 自动 推送到好来运系统
        /// 慧采云仓订单发货状态推送至小程序
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        void snapTime_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            //机器人账号
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "定单推送服务";
            log.UserID = RobotID;
            log.Operate = "A";
            CargoInterfaceBus inter = new CargoInterfaceBus();

            #region 自动下架
            try
            {
                AutoUnShelve();
            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("自动下架出错:" + ex.Message);
            }
            #endregion

            //更新特价库存数  10分钟一次
            LogHelper.WriteLog("开始 更新特价库存数");
            HandleWeixinShelveData();


            try
            {
                string HLYAwbStatusURL = Convert.ToString(ConfigurationSettings.AppSettings["HLYAwbStatusURL"]);
                string HLYToken = Convert.ToString(ConfigurationSettings.AppSettings["HLYToken"]);
                string HLYAwbURL = Convert.ToString(ConfigurationSettings.AppSettings["HLYAwbURL"]);
                List<CargoNewayDataPush> entity = inter.QueryNewayDataPush();
                if (entity.Count > 0)
                {
                    foreach (var it in entity)
                    {
                        try
                        {
                            string Company = "新陆程";
                            if (it.BelongSystem.Equals("NW")) { Company = "新陆程"; it.UserName = "新陆程"; }
                            else if (it.BelongSystem.Equals("CD")) { Company = "一二三成都"; it.UserName = "一二三"; }
                            if (it.Status.Equals("0") || it.Status.Equals("1"))
                            {
                                #region 推送手工和扫描开单

                                try
                                {
                                    HlyEntity hly = new HlyEntity();
                                    hly.Token = HLYToken;
                                    hly.ExAwbno = it.NwAwbNo;
                                    hly.Awbno = it.HlyAwbNo.Replace(" ", "").Replace("/", ",").Replace("，", ",").Replace("|", ",").Replace("；", ",").Replace("、", ",").Replace("-", ",").Replace("*", ",").Replace("%", ",").Replace("&", ",");
                                    hly.Toname = it.AcceptPeople;
                                    hly.ToPhone = it.AcceptCellphone;
                                    hly.ToAddress = it.AcceptAddress;
                                    hly.Shipper = it.ShipperName;
                                    hly.Pcs = it.Piece;
                                    hly.Weight = it.Weight;
                                    hly.City = it.CurCity;
                                    hly.Cuser = it.UserName;
                                    hly.Other = it.Remark;
                                    hly.BelongSystem = it.BelongSystem;
                                    hly.fdest = it.Dest;
                                    hly.SplitCB = it.SplitCB;
                                    hly.Createuser = it.UserName;
                                    hly.Company = Company;
                                    //string postData = "orderdata=" + JSON.Encode(hly);
                                    string postData = JSON.Encode(hly);
                                    string hlyres = wxHttpUtility.SendPostHttpRequest(HLYAwbURL, "application/json", postData);
                                    //string hlyres = wxHttpUtility.SendHttpRequest(HLYAwbURL, postData);
                                    //Hashtable hlyRow = (Hashtable)JSON.Decode(hlyres);
                                    if (hlyres.Contains("1000"))
                                    {
                                        //保存成功
                                        //log.Content = "运单保存成功，新陆程运单号：" + entity.Xawbno + "，好来运单号：" + entity.Hawbno + "，运单状态：" + entity.State + "，操作人：" + entity.Cuser + "，操作时间" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                                        LogHelper.loginfo.Info("运单保存成功，新陆程运单号：" + it.NwAwbNo + "，好来运单号：" + it.HlyAwbNo);
                                    }
                                    else
                                    {
                                        LogHelper.loginfo.Info("运单保存失败,失败原因:" + hlyres + "，新陆程运单号：" + it.NwAwbNo + "，好来运单号：" + it.HlyAwbNo);
                                    }
                                }
                                catch (ApplicationException ex)
                                {
                                    LogHelper.loginfo.Info("InsertAwbnoData接口调用失败" + ex.Message);
                                    continue;
                                }
                                #endregion
                            }
                            else
                            {

                                #region 推送运单状态
                                try
                                {
                                    HlyEntity hly = new HlyEntity();
                                    //hly.Xawbno = it.NwAwbNo;
                                    hly.ExAwbno = it.NwAwbNo;
                                    hly.Awbno = it.HlyAwbNo.Replace(" ", "").Replace("/", ",").Replace("，", ",").Replace("|", ",").Replace("；", ",").Replace("、", ",").Replace("-", ",").Replace("*", ",").Replace("%", ",").Replace("&", ",");
                                    hly.City = it.CurCity;
                                    hly.Cuser = it.UserName;
                                    hly.Cdatetime = it.StartTime;
                                    hly.Other = it.Remark;
                                    hly.State = it.Status;
                                    hly.BelongSystem = it.BelongSystem;
                                    hly.Company = Company;
                                    hly.fdest = it.Dest;
                                    hly.SplitCB = it.SplitCB;
                                    if (it.Status.Equals("7"))
                                    {
                                        hly.SignName = it.UserName;
                                        hly.SignDate = it.StartTime;
                                    }
                                    hly.Token = HLYToken;
                                    //string postData = "orderdata=" + JSON.Encode(hly);
                                    string postData = JSON.Encode(hly);
                                    string hlyres = wxHttpUtility.SendPostHttpRequest(HLYAwbStatusURL, "application/json", postData);
                                    //string hlyres = wxHttpUtility.SendHttpRequest(HLYAwbStatusURL, postData);
                                    //Hashtable hlyRow = (Hashtable)JSON.Decode(hlyres);
                                    if (hlyres.Contains("1000"))
                                    {
                                        LogHelper.loginfo.Info("状态保存成功，新陆程运单号：" + it.NwAwbNo + "，好来运单号：" + hly.Awbno + "，运单状态:" + it.Status);
                                    }
                                    else
                                    {
                                        LogHelper.loginfo.Info("状态保存失败,失败原因:" + hlyres + "，新陆程运单号：" + it.NwAwbNo + "，好来运单号：" + it.HlyAwbNo + ",运单状态:" + it.Status);
                                    }

                                }
                                catch (ApplicationException ex)
                                {
                                    LogHelper.loginfo.Info("InsertAwbnoStateData接口调用失败" + ex.Message);
                                    continue;
                                }

                                #endregion
                            }
                            inter.UpdateNewayDataPush(new CargoNewayDataPush { ID = it.ID, PushStatus = "1" });
                        }
                        catch (Exception ex)
                        {
                            LogHelper.loginfo.Info("失败" + it.NwAwbNo + "，好来运单号：" + it.HlyAwbNo + "，运单状态:" + it.Status);
                            inter.UpdateNewayDataPush(new CargoNewayDataPush { ID = it.ID, PushStatus = "1" });
                            continue;
                        }
                    }
                }

            }
            catch (ApplicationException ex)
            {
                LogHelper.loginfo.Info("推送好来运系统失败");
            }

            //try
            //{
            //    log.Moudle = "订单管理";
            //    log.NvgPage = "定时任务批量开单";

            //    List<CargoGtmcProOrderEntity> list = factoryBus.QueryExterOrderDataList(new CargoGtmcProOrderEntity
            //    {
            //        OrderType = "10",
            //        AutoOrderHandleStatus = "0",
            //        StartDate = DateTime.Now.AddDays(-10),
            //        EndDate = DateTime.Now,
            //    });
            //    if (list.Count > 0)
            //    {
            //        //处理合并数据一起开单
            //        Dictionary<string, List<CargoGtmcProOrderEntity>> listDic = new Dictionary<string, List<CargoGtmcProOrderEntity>>();
            //        foreach (var it in list)
            //        {
            //            //SourceCode：店代码，GtmcNo：发票号，GoodsCode：货品代码 
            //            if (factoryBus.QueryBatchImportOrderType(new CargoGtmcProOrderEntity { HouseID = it.HouseID, SourceCode = it.SourceCode, GtmcNo = it.GtmcNo, GoodsCode = it.GoodsCode }))
            //            {
            //                LogHelper.loginfo.Info(it.SourceCode + " " + it.GtmcNo + " " + it.GoodsCode + " 已有开单数据");
            //                continue;
            //            }
            //            string BusinessID = it.BusinessID;
            //            if (listDic.ContainsKey(it.SourceCode))
            //            {
            //                listDic.TryGetValue(it.SourceCode, out List<CargoGtmcProOrderEntity> orderList);
            //                listDic.Remove(it.SourceCode);
            //                bool type = true;
            //                foreach (CargoGtmcProOrderEntity item in orderList)
            //                {
            //                    if (item.GoodsCode.Equals(it.GoodsCode))
            //                    {
            //                        type = false;
            //                        item.ID = item.ID + "," + it.TID.ToString();
            //                        item.GtmcNo = (item.GtmcNo + "," + Convert.ToString(it.GtmcNo).Replace(item.GtmcNo, "")).Replace(",,", ",");
            //                        item.Piece = item.Piece + it.Piece;
            //                    }
            //                }
            //                if (type)
            //                {
            //                    CargoGtmcProOrderEntity orderEntity = new CargoGtmcProOrderEntity();
            //                    orderEntity.SourceCode = it.SourceCode;
            //                    orderEntity.GoodsCode = it.GoodsCode;
            //                    orderEntity.HouseID = it.HouseID;
            //                    orderEntity.TID = it.TID;
            //                    orderEntity.ID = it.TID.ToString();
            //                    orderEntity.GtmcNo = it.GtmcNo;
            //                    orderEntity.Piece = it.Piece;
            //                    orderEntity.ProductCode = it.ProductCode;
            //                    orderEntity.Memo = it.Memo;
            //                    orderEntity.BusinessID = BusinessID;
            //                    orderEntity.TypeName = it.TypeName;
            //                    orderList.Add(orderEntity);
            //                }
            //                listDic.Add(it.SourceCode, orderList);
            //            }
            //            else
            //            {
            //                CargoGtmcProOrderEntity orderEntity = new CargoGtmcProOrderEntity();
            //                orderEntity.SourceCode = it.SourceCode;
            //                orderEntity.GtmcNo = it.GtmcNo;
            //                orderEntity.Piece = it.Piece;
            //                orderEntity.GoodsCode = it.GoodsCode;
            //                orderEntity.TID = it.TID;
            //                orderEntity.ID = it.TID.ToString();
            //                orderEntity.HouseID = it.HouseID;
            //                orderEntity.ProductCode = it.ProductCode;
            //                orderEntity.Memo = it.Memo;
            //                orderEntity.BusinessID = BusinessID;
            //                orderEntity.TypeName = it.TypeName;
            //                listDic.Add(it.SourceCode, new List<CargoGtmcProOrderEntity> { orderEntity });
            //            }
            //        }

            //        //开单逻辑代码 
            //        string message = string.Empty;
            //        string HAwbNo = string.Empty;

            //        foreach (var item in listDic)
            //        {
            //            //1.循环每一个客户代码
            //            CargoHouseEntity houseEnt = house.QueryCargoHouseByID(listDic[item.Key][0].HouseID);
            //            string HouseIDStr = houseEnt.HouseID.ToString() + ",65";
            //            CargoClientEntity clientEntity = clientBus.QueryCargoClient(new CargoClientEntity { ShopCode = item.Key, HouseIDStr = HouseIDStr });
            //            if (clientEntity.LogisLineLogisID.Equals(0))
            //            {
            //                message += "客户" + item.Key + "未绑定线路\r\n";
            //                continue;
            //            }
            //            //2024-05-23 根据客户编码查询该客户的出库顺序仓库
            //            //CargoAreaEntity careaEnt = new CargoAreaEntity();
            //            List<CargoAreaEntity> areaEntities = house.QueryOutHouseLevelList(new CargoAreaEntity { ClientNum = clientEntity.ClientNum });
            //            //List<CargoAreaEntity> areaEntities = house.QueryOutHouseLevelList(new CargoAreaEntity { HouseID = houseEnt.HouseID, ClientNum = clientEntity.ClientNum });
            //            if (areaEntities.Count <= 0)
            //            {
            //                CargoAreaEntity areaEntity = house.QueryHouseByDeliveryArea(new CargoAreaEntity { HouseID = houseEnt.HouseID, DeliveryArea = clientEntity.City });
            //                if (areaEntity.AreaID.Equals(0))
            //                {
            //                    message += "客户" + item.Key + "城市无配送区域\r\n";
            //                    continue;
            //                }
            //                CargoAreaEntity careaEnt = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = areaEntity.AreaID });
            //                areaEntities.Add(careaEnt);
            //            }
            //            string HouseCode = houseEnt.HouseCode;
            //            string OrderDep = houseEnt.DepCity;

            //            //确定有库存的仓库，以仓库AreaID为键，货品列表为值
            //            Dictionary<int, List<CargoGtmcProOrderEntity>> outHouseDic = new Dictionary<int, List<CargoGtmcProOrderEntity>>();
            //            // 已处理的商品规格集合
            //            HashSet<string> processedSpecifications = new HashSet<string>();
            //            //20240525 轮询仓库判断每个商品的库存情况，找到同时满足每个商品都有库存的仓库
            //            //20250123 修改为，先查询一级仓库是否满足库存，满足则开单，再查询二级仓库是否满足库存，满足则开单，否则异常
            //            //先根据货品代码第一要素查询库存是否满足，库存不够，查询共享编码的库存
            //            foreach (var houid in areaEntities)
            //            {
            //                string faultMessage = "";
            //                foreach (var gds in item.Value)
            //                {
            //                    if (processedSpecifications.Contains(gds.GoodsCode)) { continue; }
            //                    //先根据货品代码第一要素查询库存是否满足，满足则直接跳出
            //                    List<CargoInterfaceEntity> stockList = inter.queryCargoStock(new CargoInterfaceEntity { ParentID = 1, HouseID = houid.HouseID, GoodsCode = gds.GoodsCode, AreaID = houid.AreaID, BatckWeek = 0, LastMonth = 9, SuppClientNumStr = "551098,130453,891524,542207" });
            //                    if (stockList.Sum(c => c.StockNum) >= gds.Piece)
            //                    {
            //                        if (!outHouseDic.ContainsKey(houid.AreaID))
            //                        {
            //                            List<CargoGtmcProOrderEntity> gdsList = new List<CargoGtmcProOrderEntity>();
            //                            gdsList.Add(gds);
            //                            outHouseDic.Add(houid.AreaID, gdsList);
            //                        }
            //                        else
            //                        {
            //                            outHouseDic[houid.AreaID].Add(gds);
            //                        }
            //                        processedSpecifications.Add(gds.GoodsCode);
            //                        continue;
            //                    }
            //                    //第一要素库存不够，查询共享编码的库存，满足则直接跳出
            //                    string ProductCodeStr = string.Empty;
            //                    List<CargoProductMappingEntity> mappingEntities = product.QueryProductShareCode(new CargoProductMappingEntity { CassCode = gds.GoodsCode });
            //                    if (mappingEntities.Count <= 0)
            //                    {
            //                        //共享库存也没有库存
            //                        faultMessage = gds.GoodsCode + "库存不足\r\n"; continue;
            //                        //message += gds.GoodsCode + "库存不足\r\n"; break;
            //                    }

            //                    foreach (var map in mappingEntities)
            //                    {
            //                        if (map.CassCode.Equals(gds.GoodsCode))
            //                        {
            //                            if (!ProductCodeStr.Contains(map.ProductCode))
            //                            {
            //                                ProductCodeStr += map.ShareCode + "','";
            //                            }
            //                            continue;
            //                        }
            //                        if (ProductCodeStr.Contains(map.ProductCode))
            //                        {
            //                            ProductCodeStr += map.ShareCode + "','";
            //                        }
            //                        else
            //                        {
            //                            ProductCodeStr += map.ProductCode + "','";
            //                        }
            //                    }

            //                    if (!string.IsNullOrEmpty(ProductCodeStr))
            //                    {
            //                        ProductCodeStr = ProductCodeStr.Substring(0, ProductCodeStr.Length - 3);
            //                    }
            //                    //查询共享库存
            //                    stockList = inter.queryCargoStock(new CargoInterfaceEntity { ParentID = 1, HouseID = houid.HouseID, ProductCodeStr = ProductCodeStr, AreaID = houid.AreaID, BatckWeek = 0, LastMonth = 9, SuppClientNumStr = "551098,130453,891524,542207" });

            //                    if (stockList.Sum(c => c.StockNum) >= gds.Piece)
            //                    {
            //                        gds.ProductCodeStr = ProductCodeStr;
            //                        if (!outHouseDic.ContainsKey(houid.AreaID))
            //                        {
            //                            List<CargoGtmcProOrderEntity> gdsList = new List<CargoGtmcProOrderEntity>();
            //                            gdsList.Add(gds);
            //                            outHouseDic.Add(houid.AreaID, gdsList);
            //                        }
            //                        else
            //                        {
            //                            outHouseDic[houid.AreaID].Add(gds);
            //                        }
            //                        processedSpecifications.Add(gds.GoodsCode);
            //                        faultMessage = "";
            //                        continue;
            //                    }
            //                    else
            //                    {
            //                        faultMessage = gds.GoodsCode + houid.HouseName + "共享库存也不足\r\n"; continue;
            //                        //message += gds.GoodsCode + houid.HouseName + "共享库存也不足\r\n"; break; 

            //                    }
            //                }
            //                message += faultMessage;
            //            }

            //            //处理开单
            //            if (outHouseDic.Count > 0)
            //            {
            //                foreach (var orderItem in outHouseDic)
            //                {
            //                    //依次对仓库进行开单  开单实体赋值
            //                    CargoOrderEntity orderEnt = new CargoOrderEntity();
            //                    orderEnt.EnSafe();
            //                    orderEnt.ClientID = clientEntity.ClientID;
            //                    orderEnt.ClientNum = clientEntity.ClientNum;
            //                    orderEnt.AcceptUnit = clientEntity.ClientName;
            //                    orderEnt.AcceptAddress = clientEntity.Address;
            //                    orderEnt.AcceptPeople = clientEntity.Boss;
            //                    orderEnt.AcceptTelephone = clientEntity.Telephone;
            //                    orderEnt.AcceptCellphone = clientEntity.Cellphone;
            //                    orderEnt.PayClientNum = clientEntity.ClientNum;
            //                    orderEnt.PayClientName = clientEntity.ClientName;

            //                    orderEnt.LogisAwbNo = "";
            //                    orderEnt.LogisID = clientEntity.LogisLineLogisID;
            //                    orderEnt.Dest = clientEntity.City;
            //                    orderEnt.Weight = orderEnt.Volume = orderEnt.InsuranceFee = orderEnt.TransitFee = orderEnt.TransportFee = orderEnt.DeliveryFee = orderEnt.OtherFee = orderEnt.TotalCharge = orderEnt.Rebate = 0;
            //                    orderEnt.CheckOutType = "";
            //                    orderEnt.TrafficType = "0";
            //                    orderEnt.DeliveryType = "2";
            //                    orderEnt.CreateAwbID = RobotID;
            //                    orderEnt.CreateAwb = RobotName;
            //                    orderEnt.CreateDate = DateTime.Now;
            //                    orderEnt.CheckStatus = "0";
            //                    orderEnt.SaleManID = clientEntity.UserID;
            //                    orderEnt.SaleManName = clientEntity.UserName;
            //                    orderEnt.LineID = clientEntity.LineID;
            //                    orderEnt.LineName = clientEntity.LineName;
            //                    orderEnt.HouseID = houseEnt.HouseID;
            //                    orderEnt.OP_ID = RobotID;
            //                    orderEnt.OP_DATE = DateTime.Now;
            //                    orderEnt.AwbStatus = "0";
            //                    orderEnt.OrderType = "0";//电脑开单
            //                    orderEnt.OrderModel = "0";//销售单
            //                    orderEnt.ThrowGood = "12";//OES客户单
            //                    orderEnt.BelongHouse = "0";
            //                    orderEnt.IsPrintPrice = 0;
            //                    orderEnt.PostponeShip = "0";
            //                    orderEnt.ModifyPriceStatus = "0";
            //                    orderEnt.ShopCode = item.Key;//店代码 
            //                    orderEnt.Remark = item.Key + " ";
            //                    string outID = DateTime.Now.ToString("yyMMdd") + GetRandomFourNumString();//出库单号
            //                    CargoPriceBus cargoPriceBus = new CargoPriceBus();
            //                    List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            //                    List<CargoOrderGoodsEntity> orderGoods = new List<CargoOrderGoodsEntity>();
            //                    int pieceSum = 0;
            //                    decimal trFee = 0.00M;
            //                    ArrayList tidList = new ArrayList();
            //                    int AID = orderItem.Key;//确定出库仓库ID
            //                    string memo = string.Empty;
            //                    foreach (var goods in orderItem.Value)
            //                    {
            //                        //业务ID
            //                        orderEnt.BusinessID = goods.BusinessID;

            //                        tidList.Add(goods.ID);
            //                        if (!orderEnt.HAwbNo.Contains(goods.GtmcNo))
            //                        {
            //                            orderEnt.HAwbNo += goods.GtmcNo + ",";
            //                        }
            //                        memo = goods.Memo;
            //                        // List<CargoInterfaceEntity> stockList = new List<CargoInterfaceEntity>();
            //                        CargoAreaEntity arit = areaEntities.Find(c => c.AreaID.Equals(AID));
            //                        List<CargoInterfaceEntity> stockList = inter.queryCargoStock(new CargoInterfaceEntity { ParentID = 1, HouseID = arit.HouseID, GoodsCode = goods.GoodsCode, AreaID = AID, BatckWeek = 0, LastMonth = 9, SuppClientNumStr = "551098,130453,891524,542207" });
            //                        if (stockList.Sum(c => c.StockNum) < goods.Piece)
            //                        {
            //                            stockList = inter.queryCargoStock(new CargoInterfaceEntity { ParentID = 1, HouseID = arit.HouseID, ProductCodeStr = goods.ProductCodeStr, AreaID = AID, BatckWeek = 0, LastMonth = 9, SuppClientNumStr = "551098,130453,891524,542207" });
            //                        }

            //                        if (string.IsNullOrEmpty(orderEnt.OrderNo))
            //                        {
            //                            //2024-05-23这里生成订单号
            //                            if (!string.IsNullOrEmpty(arit.OrderCode) && !string.IsNullOrEmpty(arit.OrderDep))
            //                            {
            //                                HouseCode = arit.OrderCode;
            //                                OrderDep = arit.OrderDep;
            //                            }
            //                            CargoAreaEntity areaTop = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = AID });
            //                            orderEnt.LogisID = areaTop.LogisID;
            //                            orderEnt.LogisticName = areaTop.LogisticName;
            //                            orderEnt.OrderNo = GetMaxOrderNumByCurrentDate(areaTop.HouseID, HouseCode, out int OrderNum);
            //                            orderEnt.OrderNum = OrderNum;
            //                            orderEnt.OutHouseName = arit.Name;
            //                            orderEnt.Dep = OrderDep;
            //                            orderEnt.HouseID = areaTop.HouseID;
            //                            orderEnt.OrderType = areaTop.HouseID.Equals(65) || areaTop.HouseID.Equals(84) ? "0" : "4";//小程序订单
            //                        }

            //                        int piece = goods.Piece;
            //                        foreach (var it in stockList)
            //                        {
            //                            if (it.StockNum <= 0) { continue; }
            //                            CargoContainerShowEntity cargo = new CargoContainerShowEntity();
            //                            cargo.OrderNo = orderEnt.OrderNo;//订单号
            //                            cargo.OutCargoID = outID;
            //                            cargo.ContainerID = it.ContainerID;
            //                            cargo.TypeID = it.TypeID;
            //                            cargo.ProductID = it.ProductID;

            //                            cargo.ID = it.ContainerGoodsID;//库存表ID

            //                            cargo.HouseName = houseEnt.Name;
            //                            cargo.ProductName = it.ProductName;
            //                            cargo.Model = it.Model;
            //                            cargo.Specs = it.Specs;
            //                            cargo.Figure = it.Figure;
            //                            orderEnt.SuppClientNum = orderEnt.HouseID.Equals(65) ? 0 : Convert.ToInt32(it.SuppClientNum);

            //                            #region 减库存逻辑
            //                            if (piece < it.StockNum)
            //                            {
            //                                //部分出
            //                                orderGoods.Add(new CargoOrderGoodsEntity
            //                                {
            //                                    OrderNo = orderEnt.OrderNo,
            //                                    ProductID = it.ProductID,
            //                                    HouseID = orderEnt.HouseID,
            //                                    AreaID = it.AreaID,
            //                                    Piece = piece,
            //                                    ActSalePrice = it.TradePrice,//20241108修改为门店价it.SalePrice,
            //                                    ContainerCode = it.ContainerCode,
            //                                    OutCargoID = outID,
            //                                    OP_ID = log.UserID,
            //                                    ShowGoodsCode = goods.GoodsCode,
            //                                    ShowProductCode = goods.ProductCode,
            //                                    ShowTypeName = goods.TypeName,
            //                                });
            //                                cargo.Piece = piece;
            //                                cargo.InPiece = it.StockNum;

            //                                outHouseList.Add(cargo);
            //                                pieceSum += cargo.Piece;
            //                                trFee += cargo.Piece * it.TradePrice;
            //                                break;
            //                            }
            //                            if (piece.Equals(it.StockNum))
            //                            {
            //                                //要出库件数和第一条库存件数刚刚好，则就全部出
            //                                orderGoods.Add(new CargoOrderGoodsEntity
            //                                {
            //                                    OrderNo = orderEnt.OrderNo,
            //                                    ProductID = it.ProductID,
            //                                    HouseID = orderEnt.HouseID,
            //                                    AreaID = it.AreaID,
            //                                    Piece = piece,
            //                                    ActSalePrice = it.TradePrice,//20241108修改为门店价it.SalePrice,
            //                                    ContainerCode = it.ContainerCode,
            //                                    ShowGoodsCode = goods.GoodsCode,
            //                                    ShowProductCode = goods.ProductCode,
            //                                    ShowTypeName = goods.TypeName,
            //                                    OutCargoID = outID,
            //                                    OP_ID = log.UserID
            //                                });
            //                                cargo.Piece = piece;
            //                                cargo.InPiece = it.StockNum;

            //                                outHouseList.Add(cargo);
            //                                pieceSum += cargo.Piece;
            //                                trFee += cargo.Piece * it.TradePrice;
            //                                break;
            //                            }
            //                            if (piece > it.StockNum)
            //                            {
            //                                //全部出
            //                                orderGoods.Add(new CargoOrderGoodsEntity
            //                                {
            //                                    OrderNo = orderEnt.OrderNo,
            //                                    ProductID = it.ProductID,
            //                                    HouseID = orderEnt.HouseID,
            //                                    AreaID = it.AreaID,
            //                                    Piece = it.StockNum,
            //                                    ActSalePrice = it.TradePrice,//20241108修改为门店价it.SalePrice,
            //                                    ContainerCode = it.ContainerCode,
            //                                    ShowGoodsCode = goods.GoodsCode,
            //                                    ShowProductCode = goods.ProductCode,
            //                                    ShowTypeName = goods.TypeName,
            //                                    OutCargoID = outID,
            //                                    OP_ID = log.UserID
            //                                });
            //                                cargo.Piece = it.StockNum;
            //                                cargo.InPiece = it.StockNum;

            //                                outHouseList.Add(cargo);
            //                                pieceSum += cargo.Piece;
            //                                trFee += cargo.Piece * it.TradePrice;
            //                                piece = piece - it.StockNum;
            //                                continue;
            //                            }
            //                            #endregion
            //                        }
            //                    }
            //                    orderEnt.Remark += memo;
            //                    orderEnt.goodsList = orderGoods;
            //                    orderEnt.Piece = pieceSum;
            //                    orderEnt.TransportFee = trFee;
            //                    orderEnt.TotalCharge = trFee;
            //                    //orderEnt.BusinessID = "0";
            //                    orderEnt.HAwbNo = orderEnt.HAwbNo.TrimEnd(',');

            //                    //仓库同步缓存
            //                    foreach (CargoContainerShowEntity time in outHouseList)
            //                    {
            //                        CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
            //                        //34 马牌  1 同步马牌  2 同步全部品牌
            //                        if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
            //                        {
            //                            RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
            //                        }
            //                    }

            //                    bus.AddOrderInfo(orderEnt, outHouseList, log);
            //                    foreach (string tids in tidList)
            //                    {
            //                        string[] IDStr = tids.Split(',');
            //                        foreach (var tid in IDStr)
            //                        {
            //                            factoryBus.UpdateGtmcProOrderStatus(new CargoGtmcProOrderEntity { TID = Convert.ToInt64(tid), OrderNo = orderEnt.OrderNo, OrderStatus = "1", AutoOrderHandleStatus = "1", OrderHandleType = "1", AutoOrderHandleTime = DateTime.Now });
            //                        }
            //                    }
            //                    if (orderEnt.HouseID.Equals(9))
            //                    {
            //                        //内部订单
            //                        bus.SaveHlyOrderData(outHouseList, orderEnt);
            //                    }
            //                    else
            //                    {
            //                        bus.InsertCargoOrderPush(new CargoOrderPushEntity
            //                        {
            //                            OrderNo = orderEnt.OrderNo,
            //                            Dep = orderEnt.Dep,
            //                            Dest = orderEnt.Dest,
            //                            Piece = orderEnt.Piece,
            //                            TransportFee = orderEnt.TransportFee,
            //                            ClientNum = orderEnt.ClientNum.ToString(),
            //                            AcceptAddress = orderEnt.AcceptAddress,
            //                            AcceptCellphone = orderEnt.AcceptCellphone,
            //                            AcceptTelephone = orderEnt.AcceptTelephone,
            //                            AcceptPeople = orderEnt.AcceptPeople,
            //                            AcceptUnit = orderEnt.AcceptUnit,
            //                            HouseID = orderEnt.HouseID.ToString(),
            //                            HouseName = house.QueryCargoHouseByID(orderEnt.HouseID).Name,// orderEnt.HouseID.Equals(65) || orderEnt.HouseID.Equals(84) ? houseEnt.Name : orderEnt.OutHouseName,
            //                            OP_ID = RobotID,
            //                            HLYSendUnit = orderEnt.HouseID.Equals(65) ? outHouseList[0].ProductName : outHouseList[0].ProductName,
            //                            PushType = "0",
            //                            PushStatus = "0",
            //                            LogisID = orderEnt.LogisID
            //                        }, log);
            //                    }
            //                    LogHelper.loginfo.Info(orderEnt.ShopCode + " " + orderEnt.HAwbNo + " " + "开单成功");

            //                }
            //            }
            //        }
            //        if (string.IsNullOrEmpty(message))
            //        {
            //            LogHelper.loginfo.Info("服务商定时开单成功");
            //        }
            //        else
            //        {
            //            LogHelper.loginfo.Info(message);
            //        }

            //    }
            //}
            //catch (ApplicationException ex)
            //{
            //    LogHelper.loginfo.Info("服务商定时开单失败");
            //}


            #region 推送扫描运单 20240624删除此段代码 
            //HlyEntity en = new HlyEntity();
            //en.Token = HLYToken;
            //en.Awbno = it.HlyAwbNo;
            //en.Xawbno = it.NwAwbNo;
            //if (it.BelongSystem.Equals("NW")) { en.Company = "新陆程"; }
            //else if (it.BelongSystem.Equals("CD")) { en.Company = "一二三成都"; }
            //try
            //{
            //    string postData = "orderdata=" + JSON.Encode(en);
            //    string hlyres = wxHttpUtility.SendHttpRequest("http://xlc.hlyex.net/Order.ashx?action=InsertExternalAwbno", postData);
            //    //string hlyres = wxHttpUtility.GetData(HLYAwbStatusURL + "&orderdata=" + JSON.Encode(entity));
            //    Hashtable hlyRow = (Hashtable)JSON.Decode(hlyres);
            //    if (hlyRow["state"].ToString().ToUpper().Equals("TRUE"))
            //    {
            //        LogHelper.loginfo.Info("数据上传成功，新陆程运单号：" + it.NwAwbNo + "，好来运单号：" + it.HlyAwbNo);
            //    }
            //    else
            //    {
            //        LogHelper.loginfo.Info("数据上传失败,失败原因:" + Convert.ToString(hlyRow["errmsg"]) + "，新陆程运单号：" + it.NwAwbNo + "，好来运单号：" + it.HlyAwbNo);
            //    }
            //}
            //catch (ApplicationException ex)
            //{
            //    bus.UpdateNewayDataPush(new CargoNewayDataPush { ID = it.ID, PushStatus = "1" });
            //    LogHelper.loginfo.Info("InsertExternalAwbno接口调用失败" + ex.Message);
            //    continue;
            //}

            #endregion


        }

        private bool isNext = false;
        protected override void OnStart(string[] args)
        {
            isNext = true;
            LogHelper.WriteLog(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + " 启动服务");
            PushWeixinNotice("2");
        }
        protected override void OnStop()
        {
            isNext = false;
        }
        /// <summary>
        /// 自动下架
        /// </summary>
        private void AutoUnShelve()
        {
            CargoProductBus bus = new CargoProductBus();
            //List<CargoProductEntity> product = bus.QueryShelveProductData();
            //List<CargoProductShelvesEntity> product = bus.QueryInCargoProductSpecial();
            LogHelper.WriteLog("获取数据完成");

            List<CargoProductShelvesEntity> shelve = bus.QueryInCargoProductSpecial();
            #region 废弃
            //if (product.Count <= 0) { return; }
            //foreach (var it in product)
            //{
            //    try
            //    {
            //        CargoProductEntity pro = bus.QueryInCargoProduct(it);
            //        if (!pro.ProductID.Equals(0))
            //        {
            //            if (!pro.ProductID.Equals(it.ProductID))
            //            {
            //                bus.UpdateShelvesProductID(new CargoProductEntity { ProductID = pro.ProductID, ShelvesID = it.ShelvesID });
            //            }
            //        }
            //        else
            //        {
            //            shelve.Add(new CargoProductShelvesEntity { ID = it.ShelvesID });
            //        }
            //    }
            //    catch (ApplicationException ex)
            //    {
            //        LogHelper.WriteLog(it.Specs + it.Figure + it.ProductID.ToString());
            //        continue;
            //    }

            //}
            #endregion
            if (shelve.Count > 0)
            {
                LogEntity log = new LogEntity();
                log.IPAddress = "";
                log.Moudle = "服务管理";
                log.Status = "0";
                log.NvgPage = "定时服务";
                log.UserID = "2029";
                log.Operate = "A";
                bus.Unshelves(shelve, log);
            }
        }
        void time_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            CargoHouseBus houseBus = new CargoHouseBus();

            #region 获取新陆程物流跟踪状态
            try
            {
                QueryNewayAwbStatus();
            }
            catch (Exception ex)
            {
                //isNext = false;
                LogHelper.WriteLog("Error:" + ex.Message);
            }
            #endregion
            LogHelper.WriteLog("获取新陆程物流跟踪状态任务完成");

            #region 每天8点推送未发货订单
            try
            {
                #region 推送未发货订单
                if (DateTime.Now.Hour.Equals(8))
                {
                    //早上8点处理前两天的未发货订单并推送
                    QiyeBus bus = new QiyeBus();
                    CargoOrderEntity queryEntity = new CargoOrderEntity();
                    queryEntity.CargoPermisID = "32,29,13,33,14,10,30,43,15,25,23,27,24,9,58";
                    queryEntity.StartDate = DateTime.Now.AddDays(-10);
                    queryEntity.EndDate = DateTime.Now;
                    queryEntity.PostponeShip = "0";
                    queryEntity.OrderModel = "0";
                    queryEntity.BelongHouse = "1";
                    List<CargoOrderEntity> orderlist = bus.QueryUnSendOrderInfo(queryEntity);
                    List<QyPushConfigEntity> push = bus.QueryPushConfigList(new QyPushConfigEntity { PushType = "0", QYKind = "1" });
                    List<CargoOrderEntity> existOrder = new List<CargoOrderEntity>();
                    QySendInfoEntity send = new QySendInfoEntity();
                    send.url = "http://dlt.neway5.com";
                    send.msgType = msgType.textcard;
                    send.content = "";
                    string HouseName = string.Empty;
                    int HouseID = 0;
                    int i = 0;
                    foreach (var it in orderlist)
                    {
                        if (it.LogisID.Equals(24)) { continue; }
                        i++;
                        try
                        {
                            if (!existOrder.Exists(c => c.HouseID.Equals(it.HouseID)))
                            {
                                if (existOrder.Count > 0)
                                {
                                    //推送通知并添加进去
                                    send.title = HouseName + "未发货订单";
                                    if (string.IsNullOrEmpty(push.Find(c => c.HouseID.Equals(HouseID)).PushPerson))
                                    {
                                        continue;
                                    }
                                    send.toUser = push.Find(c => c.HouseID.Equals(HouseID)).PushPerson;
                                    WXQYSendHelper.PushInfo("0", "4", send);
                                }
                                existOrder.Add(new CargoOrderEntity { HouseID = it.HouseID });
                                send.content = "<div></div><div>订单号：" + it.OrderNo + " " + it.Dest + " " + it.AcceptPeople + " " + it.Piece.ToString() + "</div>";
                                HouseName = it.HouseName;
                                HouseID = it.HouseID;
                            }
                            else
                            {
                                send.content += "<div>订单号：" + it.OrderNo + " " + it.Dest + " " + it.AcceptPeople + " " + it.Piece.ToString() + "</div>";
                                if (i == orderlist.Count)
                                {
                                    //推送通知并添加进去
                                    send.title = HouseName + "未发货订单";
                                    if (string.IsNullOrEmpty(push.Find(c => c.HouseID.Equals(it.HouseID)).PushPerson))
                                    {
                                        continue;
                                    }
                                    send.toUser = push.Find(c => c.HouseID.Equals(it.HouseID)).PushPerson;
                                    WXQYSendHelper.PushInfo("0", "4", send);
                                }
                            }
                        }
                        catch (Exception)
                        {
                            continue;
                        }
                    }
                }
                #endregion
            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("推送未发货订单出错:" + ex.Message);
            }
            #endregion
            //处理迪乐泰仓储统计数据
            #region 处理迪乐泰仓储统计数据
            try
            {
                int nowYear = DateTime.Now.Year;
                int nowMonth = DateTime.Now.Month;
                int nowDay = DateTime.Now.Day;
                int nowHour = DateTime.Now.Hour;
                int fixTime = Convert.ToInt32(ConfigurationSettings.AppSettings["FixTime"]);
                int fixHour = Convert.ToInt32(ConfigurationSettings.AppSettings["FixHour"]);

                //每个月的2号零辰2点执行任务 处理迪乐泰仓储统计数据
                if (nowDay.Equals(fixTime) && nowHour.Equals(fixHour))
                {
                    LogHelper.WriteLog(DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + " 开始处理迪乐泰仓储统计数据");
                    HandleDLTCargoData();
                }
            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("Error:" + ex.Message);
                PushWeixinNotice("3");
            }
            #endregion

            #region 更新新陆程系统签收照片
            try
            {
                HandleNoSignPiceData();
            }
            catch (Exception ex)
            {
                //isNext = false;
                LogHelper.WriteLog("更新新陆程系统签收照片:" + ex.Message);
            }
            #endregion

            #region 云仓订单数据获取 
            try
            {
                if (DateTime.Now.Hour.Equals(1))
                {
                    GenerateOrderDayStatistics();
                }

            }
            catch (Exception ex)
            {
                LogHelper.WriteLog("供应商销售补货数据通知:" + ex.Message);
            }

            #endregion

            #region 更新自有和进驻数据
            try
            {
                if (DateTime.Now.Hour > 0 && DateTime.Now.Hour < 5)
                {
                    CargoInterfaceBus bus = new CargoInterfaceBus();

                    bus.HandleGoodsClassData();
                    LogHelper.WriteLog("处理自有进驻数据出库完成");
                }
            }
            catch (ApplicationException ex)
            {
                LogHelper.WriteLog("处理自有进驻数据出库:" + ex.Message);
            }
            #endregion

            #region 每月18 28号湖南顺捷云仓，衡阳云仓 星沙云仓会员日 急送费免费
            if (DateTime.Now.Day.Equals(18) || DateTime.Now.Day.Equals(28))
            {
                if (DateTime.Now.Hour.Equals(0))
                {
                    //18 28号零点修改仓库运费为0
                    houseBus.UpdateHouseHCYCLogisFee(new CargoHouseEntity { HouseID = 96, LogisFee = 0, TwoLogisFee = 0, ThreeLogisFee = 0 });
                    houseBus.UpdateHouseHCYCLogisFee(new CargoHouseEntity { HouseID = 100, LogisFee = 0, TwoLogisFee = 0, ThreeLogisFee = 0 });
                    houseBus.UpdateHouseHCYCLogisFee(new CargoHouseEntity { HouseID = 116, LogisFee = 0, TwoLogisFee = 0, ThreeLogisFee = 0 });
                }
            }
            if (DateTime.Now.Day.Equals(19) || DateTime.Now.Day.Equals(29) || DateTime.Now.Day.Equals(1))
            {
                if (DateTime.Now.Hour.Equals(0))
                {
                    //19 29 号修改仓库运费为正常
                    houseBus.UpdateHouseHCYCLogisFee(new CargoHouseEntity { HouseID = 96, LogisFee = 10, TwoLogisFee = 15, ThreeLogisFee = 20 });
                    houseBus.UpdateHouseHCYCLogisFee(new CargoHouseEntity { HouseID = 100, LogisFee = 10, TwoLogisFee = 15, ThreeLogisFee = 20 });
                    houseBus.UpdateHouseHCYCLogisFee(new CargoHouseEntity { HouseID = 116, LogisFee = 10, TwoLogisFee = 15, ThreeLogisFee = 20 });
                }
            }
            #endregion

        }
        /// <summary>
        /// 处理微信商城上架的产品数据
        /// </summary>
        private void HandleWeixinShelveData()
        {
            CargoProductBus bus = new CargoProductBus();
            //处理商城特价商品在售数量
            bus.HandleWxMallOnSaleNum();
        }
        /// <summary>
        /// 处理迪乐泰仓储统计数据
        /// </summary>
        private void HandleDLTCargoData()
        {
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "定时服务";
            log.UserID = "2029";
            log.Operate = "A";

            List<CargoMonthStatisEntity> monthStatisList = new List<CargoMonthStatisEntity>();
            CargoHouseBus house = new CargoHouseBus();
            //List<CargoHouseEntity> houselist = house.QueryALLHouse();
            //湖南，湖北，广东，揭阳，广通慧采，狄乐汽服仓，华南配件仓，华南枢纽，佛山云配，中山云配
            string houseArr = "1,3,45,44,64,65,82,83,84,86,87,90,91,93,95,96,97,98,99,100,101";
            CargoLeaderCookpitEntity coo = new CargoLeaderCookpitEntity();
            coo.StartDate = DateTime.Now.AddMonths(-1);
            coo.EndDate = DateTime.Now.AddDays(1 - DateTime.Now.Day);
            coo.CargoPermisID = houseArr;
            LogHelper.WriteLog("Begin 开始取数据");
            monthStatisList.AddRange(queryByProductType(coo));
            monthStatisList.AddRange(queryBySaleMan(coo));
            monthStatisList.AddRange(queryByClient(coo));
            LogHelper.WriteLog("End 结束取数据");
            CargoReportBus report = new CargoReportBus();
            report.saveMonthStatis(monthStatisList, log);
            LogHelper.WriteLog("End 保存数据");

            coo.StartDate = DateTime.Now.AddMonths(-3);
            coo.EndDate = DateTime.Now.AddMonths(-2).AddDays(1 - DateTime.Now.AddMonths(-2).Day);
            LogHelper.WriteLog("Begin 开始取3月前数据");
            monthStatisList.AddRange(queryByProductType(coo));
            monthStatisList.AddRange(queryBySaleMan(coo));
            monthStatisList.AddRange(queryByClient(coo));
            LogHelper.WriteLog("End 结束取3月前数据");
            report.updateMonthStatis(monthStatisList, log);
            LogHelper.WriteLog("End 保存3月前数据");
        }
        /// <summary>
        /// 查询新陆程系统运单物流跟踪状态保存在订单状态表中
        /// </summary>
        private void QueryNewayAwbStatus()
        {
            int[] CargoPermisID = { 45, 44, 82, 83, 84, 65, 95, 91, 97, 101 };
            foreach (var cps in CargoPermisID)
            {
                int XLCDay = Convert.ToInt32(ConfigurationSettings.AppSettings["XLCDay"]);
                CargoOrderBus bus = new CargoOrderBus();
                CargoOrderEntity ent = new CargoOrderEntity();
                ent.HouseID = cps;//东莞，深圳，揭阳，华南配件仓，华南二仓
                ent.LogisID = 62;
                //ent.CargoPermisID = "45,44,82,83,84,65,95,91,97,101";
                ent.StartDate = DateTime.Now.AddDays(-XLCDay);
                ent.EndDate = DateTime.Now;
                List<CargoOrderEntity> orderList = bus.QueryCargoOrderTen(ent);
                if (orderList.Count > 0)
                {
                    LogHelper.WriteLog("本次处理数量：" + orderList.Count.ToString());

                    LogEntity log = new LogEntity();
                    log.IPAddress = "";
                    log.Moudle = "订单管理";
                    log.NvgPage = "订单状态跟踪";
                    log.UserID = "XLC";
                    log.Status = "0";
                    log.Operate = "U";
                    Neway.newaySoapClient dd = new Neway.newaySoapClient();
                    foreach (var it in orderList)
                    {
                        try
                        {

                            if (string.IsNullOrEmpty(it.LogisAwbNo)) { continue; }
                            if (it.AwbStatus.Equals("0") || it.AwbStatus.Equals("1") || it.AwbStatus.Equals("6") || it.AwbStatus.Equals("5")) { continue; }
                            string belong = "NW";
                            //if (it.OrderNo.Contains("SZ")) { belong = "FJ"; }
                            LogHelper.WriteLog(it.LogisAwbNo + "开始获取运单状态");
                            Neway.AwbStatus[] awb = dd.QueryAwbStatusList(new Neway.AuthHeader { UserName = "neway5com" }, it.LogisAwbNo.Trim(), belong);//10315345
                            LogHelper.WriteLog(it.LogisAwbNo + "运单状态获取成功");
                            if (awb.Length > 0)
                            {
                                //awb = awb.OrderBy(c => c.OP_DATE).ToArray();//按操作时间的正序循环
                                for (int i = 0; i < awb.Length; i++)
                                {
                                    #region MyRegion
                                    CargoOrderStatusEntity orderStatus = new CargoOrderStatusEntity();
                                    orderStatus.OrderID = it.OrderID;
                                    orderStatus.OrderNo = it.OrderNo;
                                    orderStatus.OP_ID = awb[i].OP_ID;
                                    orderStatus.OP_Name = awb[i].OP_ID;
                                    orderStatus.OP_DATE = awb[i].OP_DATE;
                                    //if (awb[i].TruckFlag.Equals("7") || awb[i].TruckFlag.Equals("6"))
                                    //{
                                    //    orderStatus.OP_DATE = (DateTime)awb[i].SignTime;
                                    //    LogHelper.WriteLog("3：" + awb[i].TruckFlag);
                                    //}
                                    //if (awb[i].TruckFlag.Equals("3"))
                                    //{
                                    //    //到达
                                    //    if (awb[i].CurrentLocation.Contains(it.Dest))
                                    //    {
                                    //        //到达
                                    //        orderStatus.OrderStatus = "4";
                                    //        orderStatus.DetailInfo = "已到达【" + it.Dest + "】";
                                    //        bus.SaveOrderStatus(orderStatus, log);
                                    //    }
                                    //}
                                    //if (awb[i].TruckFlag.Equals("8") || awb[i].TruckFlag.Equals("5"))
                                    //{
                                    //    //配送
                                    //    orderStatus.OrderStatus = "7";
                                    //    orderStatus.DetailInfo = "正在配送途中...";
                                    //    bus.SaveOrderStatus(orderStatus, log);
                                    //}
                                    //if (awb[i].TruckFlag.Equals("7") || awb[i].TruckFlag.Equals("6"))
                                    //{
                                    //    //签收
                                    //    orderStatus.OrderStatus = "5";
                                    //    orderStatus.DetailInfo = "客户已签收";
                                    //    bus.SaveOrderStatus(orderStatus, log);
                                    //}
                                    //if (awb[i].TruckFlag.Equals("9"))
                                    //{
                                    //    //在途
                                    //    orderStatus.OrderStatus = "3";
                                    //    orderStatus.DetailInfo = "运输在途";
                                    //    bus.SaveOrderStatus(orderStatus, log);
                                    //}


                                    if (awb[i].TruckFlag.Equals("0") && (it.AwbStatus.Equals("1") || it.AwbStatus.Equals("0") || it.AwbStatus.Equals("6")))
                                    {
                                        //出库
                                        orderStatus.OrderStatus = "2";
                                        orderStatus.DetailInfo = "已出库";
                                        bus.SaveOrderStatus(orderStatus, log);
                                    }
                                    if ((awb[i].TruckFlag.Equals("1") || awb[i].TruckFlag.Equals("2")) && (it.AwbStatus.Equals("2") || it.AwbStatus.Equals("6")))
                                    {
                                        //在途
                                        orderStatus.OrderStatus = "3";
                                        //orderStatus.DetailInfo = "运输在途";
                                        orderStatus.DetailInfo = "您的物品已从【" + it.Dep + "】出发，发往【" + it.Dest + "】";
                                        bus.SaveOrderStatus(orderStatus, log);
                                    }
                                    if (awb[i].TruckFlag.Equals("3") && (it.AwbStatus.Equals("2") || it.AwbStatus.Equals("3") || it.AwbStatus.Equals("6")))
                                    {
                                        //if (awb[i].CurrentLocation.Contains(it.Dest))
                                        //{
                                        //    //到达
                                        //    orderStatus.OrderStatus = "4";
                                        //    orderStatus.DetailInfo = "已到达【" + it.Dest + "】";
                                        //    bus.SaveOrderStatus(orderStatus, log);
                                        //}
                                        //orderStatus.OP_DATE = DateTime.Now;
                                        orderStatus.OP_DATE = Convert.ToDateTime(awb[i].ArriveTime);
                                        orderStatus.OrderStatus = "4";
                                        orderStatus.DetailInfo = "您的物品已到达【" + awb[i].CurrentLocation + "】";
                                        bus.SaveOrderStatus(orderStatus, log);
                                    }
                                    if ((awb[i].TruckFlag.Equals("8") || awb[i].TruckFlag.Equals("5")) && (it.AwbStatus.Equals("2") || it.AwbStatus.Equals("3") || it.AwbStatus.Equals("4") || it.AwbStatus.Equals("6")))
                                    {
                                        //配送
                                        orderStatus.OrderStatus = "7";
                                        orderStatus.DetailInfo = "您的物品正在配送中...请注意签收！" + "【" + awb[i].DetailInfo + "】";
                                        //orderStatus.DetailInfo = awb[i].DetailInfo;
                                        bus.SaveOrderStatus(orderStatus, log);
                                    }
                                    if ((awb[i].TruckFlag.Equals("9") || awb[i].TruckFlag.Equals("5")) && (it.AwbStatus.Equals("2") || it.AwbStatus.Equals("3") || it.AwbStatus.Equals("4") || it.AwbStatus.Equals("6")))
                                    {
                                        //中转
                                        orderStatus.OrderStatus = "7";
                                        orderStatus.DetailInfo = "您的物品正在中转中..." + "【" + awb[i].DetailInfo + "】";
                                        //orderStatus.DetailInfo = "您的物品正在中转配送途中...请注意签收！";
                                        //orderStatus.DetailInfo = awb[i].DetailInfo;
                                        bus.SaveOrderStatus(orderStatus, log);
                                    }
                                    if ((awb[i].TruckFlag.Equals("7") || awb[i].TruckFlag.Equals("6")) && (it.AwbStatus.Equals("2") || it.AwbStatus.Equals("1") || it.AwbStatus.Equals("0") || it.AwbStatus.Equals("3") || it.AwbStatus.Equals("4") || it.AwbStatus.Equals("7") || it.AwbStatus.Equals("6")))
                                    {
                                        string signimage = string.Empty;
                                        //签收
                                        string im = string.Empty;
                                        if (awb[i].Files != null)
                                        {
                                            Neway.AwbFilesEntity[] file = awb[i].Files;
                                            if (file.Length > 0)
                                            {
                                                for (int j = 0; j < file.Length; j++)
                                                {
                                                    im += "http://pic.haolaiyun.com:9101/" + file[j].FileName + "|";
                                                    signimage = "http://pic.haolaiyun.com:9101/" + file[j].FileName;
                                                }
                                            }
                                        }

                                        //签收时间
                                        orderStatus.SignTime = Convert.ToDateTime(awb[i].ArriveTime);
                                        //orderStatus.Signer = "拍照签收";
                                        orderStatus.Signer = awb[i].UserName;
                                        orderStatus.SignImage = im;
                                        //签收
                                        orderStatus.OrderStatus = "5";
                                        orderStatus.DetailInfo = awb[i].DetailInfo;
                                        orderStatus.Longitude = awb[i].Longitude;
                                        orderStatus.Latitude = awb[i].Latitude;
                                        bus.SaveOrderStatus(orderStatus, log);
                                        //向迪乐泰企业微信推送签收通知
                                        //2023-03-06 针对电商单推送订单签收通知
                                        if (it.ThrowGood.Equals("20"))
                                        {
                                            //微信企业号推送
                                            QySendInfoEntity send = new QySendInfoEntity();
                                            send.title = "订单签收通知";
                                            send.msgType = msgType.textcard;
                                            //send.toUser = "1000";
                                            send.agentID = "1000003";//消息通知的应用
                                            send.AgentSecret = "VkkRCESh5hxT8FStrYa0jWjIg0ux--M670SoFFyuimM";
                                            send.toTag = "17";//电商单签收提醒通知
                                            send.content = "<div>出库仓库：" + it.OutHouseName + "</div><div>订单号码：" + it.OrderNo + "</div><div>运单号码：" + it.LogisAwbNo + "</div><div>签收人：" + orderStatus.Signer + "</div><div>签收信息：" + orderStatus.DetailInfo + "</div><div>点击通知查看签收照片</div>";
                                            send.url = string.IsNullOrEmpty(signimage) ? "http://dlt.neway5.com" : signimage;

                                            WXQYSendHelper.DLTQYPushInfo(send);
                                            LogHelper.WriteLog("签收推送成功:" + it.OrderNo);
                                        }
                                    }
                                    #endregion
                                }
                            }

                        }
                        catch (ApplicationException ex)
                        {
                            LogHelper.WriteLog(it.LogisAwbNo + " " + it.OrderNo + "运单状态处理失败");
                            continue;
                        }
                    }
                }
            }

        }
        /// <summary>
        /// 处理没有签收照片的订单数据
        /// </summary>
        private void HandleNoSignPiceData()
        {
            int XLCDay = Convert.ToInt32(ConfigurationSettings.AppSettings["XLCDay"]);
            CargoOrderBus bus = new CargoOrderBus();
            CargoOrderStatusEntity ent = new CargoOrderStatusEntity();
            ent.OrderStatus = "5";
            ent.OP_DATE = DateTime.Now.AddDays(-XLCDay);
            List<CargoOrderStatusEntity> orderList = bus.QueryOrderStatusNoPic(ent);
            if (orderList.Count > 0)
            {
                LogEntity log = new LogEntity();
                log.IPAddress = "";
                log.Moudle = "订单管理";
                log.NvgPage = "订单签收照片";
                log.UserID = "XLC";
                log.Status = "0";
                log.Operate = "U";
                Neway.newaySoapClient dd = new Neway.newaySoapClient();
                foreach (var it in orderList)
                {
                    if (string.IsNullOrEmpty(it.LogisAwbNo)) { continue; }
                    if (it.LogisID.Equals(34))
                    {
                        string signimage = string.Empty;
                        //好来运速递
                        string hlyres = wxHttpUtility.GetData("http://apphome.hlyex.com/api.ashx?action=GetSignPicture&token=jgds$jh&awbno=" + it.LogisAwbNo);
                        if (!string.IsNullOrEmpty(hlyres))
                        {
                            CargoOrderStatusEntity orderStatus = new CargoOrderStatusEntity();
                            orderStatus.ID = it.ID;
                            orderStatus.OrderID = it.OrderID;
                            orderStatus.OrderNo = it.OrderNo;
                            signimage = hlyres.ToLower().Contains("jpg") ? hlyres : hlyres + ".jpg";
                            orderStatus.SignImage = hlyres.ToLower().Contains("jpg") ? hlyres : hlyres + ".jpg";
                            bus.UpdateOrderStatusPic(orderStatus, log);
                            if (!string.IsNullOrEmpty(it.OpenOrderNo))
                            {
                                if (bus.IsExistCargoOrderCheckStatus(new CargoOrderStatusEntity { OrderNo = it.OpenOrderNo, OrderStatus = "5" }))
                                {
                                    List<CargoOrderStatusEntity> openOrder = bus.QueryOrderStatusNoPic(new CargoOrderStatusEntity { OP_DATE = DateTime.Now.AddDays(-XLCDay), OrderStatus = "5", OrderNo = it.OpenOrderNo });
                                    if (openOrder.Count > 0)
                                    {
                                        CargoOrderStatusEntity openorderStatus = new CargoOrderStatusEntity();
                                        openorderStatus.ID = openOrder[0].ID;
                                        openorderStatus.OrderID = openOrder[0].OrderID;
                                        openorderStatus.OrderNo = openOrder[0].OrderNo;
                                        signimage = hlyres.ToLower().Contains("jpg") ? hlyres : hlyres + ".jpg";
                                        orderStatus.SignImage = hlyres.ToLower().Contains("jpg") ? hlyres : hlyres + ".jpg";
                                        bus.UpdateOrderStatusPic(openorderStatus, log);
                                    }
                                }
                            }

                            //向迪乐泰企业微信推送签收通知
                            //2023-03-06 针对电商单推送订单签收通知
                            if (it.ThrowGood.Equals("20") && !string.IsNullOrEmpty(signimage))
                            {
                                //微信企业号推送
                                QySendInfoEntity send = new QySendInfoEntity();
                                send.title = "订单签收通知";
                                send.msgType = msgType.textcard;
                                //send.toUser = "1000";
                                send.agentID = "1000003";//消息通知的应用
                                send.AgentSecret = "VkkRCESh5hxT8FStrYa0jWjIg0ux--M670SoFFyuimM";
                                send.toTag = "17";//电商单签收提醒通知
                                send.content = "<div>出库仓库：" + it.OutHouseName + "</div><div>订单号码：" + it.OrderNo + "</div><div>运单号码：" + it.LogisAwbNo + "</div><div>签收人：" + it.Signer + "</div><div>签收信息：" + it.DetailInfo + "</div><div>点击通知查看签收照片</div>";
                                send.url = string.IsNullOrEmpty(signimage) ? "http://dlt.neway5.com" : signimage;

                                WXQYSendHelper.DLTQYPushInfo(send);
                                LogHelper.WriteLog("签收推送成功:" + it.OrderNo);
                            }
                        }
                    }
                    if (it.LogisID.Equals(62))
                    {
                        //新陆程物流
                        string belong = "NW";
                        //if (it.OrderNo.Contains("SZ")) { belong = "FJ"; }
                        Neway.AwbStatus[] awb = dd.QueryAwbStatusList(new Neway.AuthHeader { UserName = "neway5com" }, it.LogisAwbNo.Trim(), belong);//10315345
                        LogHelper.WriteLog(it.LogisAwbNo + "运单状态获取成功");
                        if (awb.Length > 0)
                        {
                            //awb = awb.OrderBy(c => c.OP_DATE).ToArray();//按操作时间的正序循环
                            for (int i = 0; i < awb.Length; i++)
                            {
                                #region MyRegion
                                if (awb[i].Files != null && awb[i].Files.Count() > 0)
                                {
                                    CargoOrderStatusEntity orderStatus = new CargoOrderStatusEntity();
                                    orderStatus.ID = it.ID;
                                    orderStatus.OrderID = it.OrderID;
                                    orderStatus.OrderNo = it.OrderNo;

                                    string im = string.Empty;
                                    string signimage = string.Empty;
                                    Neway.AwbFilesEntity[] file = awb[i].Files;
                                    if (file.Length > 0)
                                    {
                                        for (int j = 0; j < file.Length; j++)
                                        {
                                            im += "http://pic.haolaiyun.com:9101/" + file[j].FileName + "|";
                                            signimage = "http://pic.haolaiyun.com:9101/" + file[j].FileName;
                                        }
                                    }
                                    orderStatus.SignImage = im;
                                    bus.UpdateOrderStatusPic(orderStatus, log);

                                    //向迪乐泰企业微信推送签收通知
                                    //2023-03-06 针对电商单推送订单签收通知
                                    if (it.ThrowGood.Equals("20"))
                                    {
                                        //微信企业号推送
                                        QySendInfoEntity send = new QySendInfoEntity();
                                        send.title = "订单签收通知";
                                        send.msgType = msgType.textcard;
                                        //send.toUser = "1000";
                                        send.agentID = "1000003";//消息通知的应用
                                        send.AgentSecret = "VkkRCESh5hxT8FStrYa0jWjIg0ux--M670SoFFyuimM";
                                        send.toTag = "17";//电商单签收提醒通知
                                        send.content = "<div>出库仓库：" + it.OutHouseName + "</div><div>订单号码：" + it.OrderNo + "</div><div>运单号码：" + it.LogisAwbNo + "</div><div>签收人：" + it.Signer + "</div><div>签收信息：" + it.DetailInfo + "</div><div>点击通知查看签收照片</div>";
                                        send.url = string.IsNullOrEmpty(signimage) ? "http://dlt.neway5.com" : signimage;

                                        WXQYSendHelper.DLTQYPushInfo(send);
                                        LogHelper.WriteLog("签收推送成功:" + it.OrderNo);
                                    }
                                }

                                #endregion
                            }
                        }
                    }
                }
            }

        }
        /// <summary>
        /// 按客户统计 
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        private List<CargoMonthStatisEntity> queryByClient(CargoLeaderCookpitEntity entity)
        {
            List<CargoMonthStatisEntity> monthStatisList = new List<CargoMonthStatisEntity>();
            CargoReportBus report = new CargoReportBus();
            List<CargoLeaderCookpitEntity> saleList = report.QueryByClient(new CargoLeaderCookpitEntity
            {
                StartDate = entity.StartDate,
                EndDate = entity.EndDate,
                CargoPermisID = entity.CargoPermisID
            });
            if (saleList.Count > 0)
            {
                foreach (var it in saleList)
                {
                    CargoMonthStatisEntity sta = new CargoMonthStatisEntity();
                    sta.Title = it.AcceptPeople;
                    sta.HouseID = it.HouseID;
                    sta.SaleNum = it.Piece;
                    sta.SaleIncome = it.TotalCharge;
                    sta.StatisType = "3";
                    sta.Year = DateTime.Now.AddMonths(-1).Year;
                    sta.Month = DateTime.Now.AddMonths(-1).Month;
                    monthStatisList.Add(sta);
                }
            }
            return monthStatisList;
        }

        /// <summary>
        /// 按业务员统计 
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        private List<CargoMonthStatisEntity> queryBySaleMan(CargoLeaderCookpitEntity entity)
        {
            List<CargoMonthStatisEntity> monthStatisList = new List<CargoMonthStatisEntity>();
            CargoReportBus report = new CargoReportBus();
            List<CargoLeaderCookpitEntity> saleList = report.QueryBySaleMan(new CargoLeaderCookpitEntity
            {
                StartDate = entity.StartDate,
                EndDate = entity.EndDate,
                CargoPermisID = entity.CargoPermisID
            });
            if (saleList.Count > 0)
            {
                foreach (var it in saleList)
                {
                    CargoMonthStatisEntity sta = new CargoMonthStatisEntity();
                    sta.Title = it.SaleManName;
                    sta.HouseID = it.HouseID;
                    sta.SaleNum = it.Piece;
                    sta.SaleIncome = it.TotalCharge;
                    sta.StatisType = "2";
                    sta.Year = DateTime.Now.AddMonths(-1).Year;
                    sta.Month = DateTime.Now.AddMonths(-1).Month;
                    monthStatisList.Add(sta);
                }
            }
            return monthStatisList;
        }
        /// <summary>
        /// 按产品类型统计 
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        private List<CargoMonthStatisEntity> queryByProductType(CargoLeaderCookpitEntity entity)
        {
            List<CargoMonthStatisEntity> monthStatisList = new List<CargoMonthStatisEntity>();
            CargoReportBus report = new CargoReportBus();
            List<CargoLeaderCookpitEntity> typeList = report.QueryByProductType(new CargoLeaderCookpitEntity
            {
                StartDate = entity.StartDate,
                EndDate = entity.EndDate,
                CargoPermisID = entity.CargoPermisID
            });

            if (typeList.Count > 0)
            {
                foreach (var it in typeList)
                {
                    if (it.ParentID.Equals(20))//去掉赠品 
                    {
                        continue;
                    }
                    CargoMonthStatisEntity sta = new CargoMonthStatisEntity();
                    sta.Title = it.TypeName;
                    sta.HouseID = it.HouseID;
                    sta.SaleNum = it.Piece;
                    sta.SaleIncome = it.TotalCharge;
                    sta.StatisType = "1";
                    sta.Year = DateTime.Now.AddMonths(-1).Year;
                    sta.Month = DateTime.Now.AddMonths(-1).Month;
                    monthStatisList.Add(sta);
                }

                var total = typeList.Where(c => c.ParentID != 20).GroupBy(c => c.HouseID).Select(g => new
                {
                    ID = g.Key,
                    Piece = g.Sum(c => c.Piece),
                    TotalCharge = g.Sum(c => c.TotalCharge)
                }).ToList();
                foreach (var it in total)
                {
                    CargoMonthStatisEntity sta = new CargoMonthStatisEntity();
                    sta.Title = "汇总";
                    sta.HouseID = it.ID;
                    sta.SaleNum = it.Piece;
                    sta.SaleIncome = it.TotalCharge;
                    sta.StatisType = "0";
                    sta.Year = DateTime.Now.AddMonths(-1).Year;
                    sta.Month = DateTime.Now.AddMonths(-1).Month;
                    monthStatisList.Add(sta);
                }
            }

            return monthStatisList;
        }

        public static string GetMaxOrderNumByCurrentDate(int hID, string hCode, out int OrderNum, int nextNum = 0)
        {
            string result = string.Empty;
            CargoOrderBus bus = new CargoOrderBus();

            string key = hID.ToString() + "_" + DateTime.Now.ToString("yyyyMMdd");
            int oNum = 0;
            if (!RedisHelper.HashExists("HouseOrderNo", key))
            {
                //不存在缓存
                int oMaxNum = bus.GetMaxOrderNumByCurrentDate(new CargoOrderEntity { HouseID = hID, StartDate = DateTime.Now, EndDate = DateTime.Now }) + nextNum;
                RedisHelper.HashSet("HouseOrderNo", key, (oMaxNum + 1).ToString());

            }
            else
            {
                oNum = Convert.ToInt32(RedisHelper.HashGet("HouseOrderNo", key));
                RedisHelper.HashSet("HouseOrderNo", key, (oNum + 1).ToString());
            }

            //int oNum = bus.GetMaxOrderNumByCurrentDate(new CargoOrderEntity { HouseID = hID, StartDate = DateTime.Now, EndDate = DateTime.Now });
            string oStr = string.Empty;
            switch ((oNum + 1).ToString().Length)
            {
                case 1:
                    oStr = "00" + (oNum + 1).ToString();
                    break;
                case 2:
                    oStr = "0" + (oNum + 1).ToString();
                    break;
                default:
                    oStr = (oNum + 1).ToString();
                    break;
            }
            result = hCode.Trim() + DateTime.Now.ToString("yyMMdd") + oStr;
            OrderNum = oNum + 1;
            return result;
        }
        /// <summary>
        /// 生成随机的四位数字 返回字符类型，不够四位前面补0
        /// </summary>
        /// <returns></returns>
        public static string GetRandomFourNumString()
        {
            string result = string.Empty;
            Random rd = new Random((int)DateTime.Now.Ticks);
            int sd = rd.Next(1, 9999);
            switch (sd.ToString().Length)
            {
                case 1:
                    result += "000" + sd.ToString();
                    break;
                case 2:
                    result += "00" + sd.ToString();
                    break;
                case 3:
                    result += "0" + sd.ToString();
                    break;
                default:
                    result = sd.ToString();
                    break;
            }
            return result;
        }

        #region 服务号 模板信息推送
        //Requests为一个通用的get或post请求方法，RequestUrl为请求的地址，RequestMethod请求的get或post
        public static string ServiceRequests(string RequestUrl, string RequestMethod)
        {
            string RequestUrls = RequestUrl;
            HttpWebRequest request = (HttpWebRequest)WebRequest.Create(RequestUrls);
            request.Method = RequestMethod;
            request.ContentType = "textml;charset=UTF-8";
            HttpWebResponse response = (HttpWebResponse)request.GetResponse();
            Stream myResponseStream = response.GetResponseStream();
            StreamReader myStreamReader = new StreamReader(myResponseStream, Encoding.UTF8);
            string jsonData = myStreamReader.ReadToEnd();
            myStreamReader.Close();
            myResponseStream.Close();
            string jsonString = jsonData;
            return jsonString;
        }
        /// <summary>
        /// 服务号 销售情况通知
        /// </summary>
        private void SendSalesMessage()
        {
            CargoWeiXinBus cargoWeiXinBus = new CargoWeiXinBus();

            string strReturn = "";
            try
            {
                //获取 access_token
                string AppID = GetdltAPPID();
                string AppSecret = GetdltAppSecret();
                string AccessTokenUrl = String.Format("https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={0}&secret={1}", AppID, AppSecret);//构建请求的url，获取access_token
                string AccessToken = ServiceRequests(AccessTokenUrl, "get");
                JObject json1 = JObject.Parse(AccessToken);
                var accessToken = json1["access_token"];

                //LogHelper.WriteLog("服务号模板信息推送 access_token:" + accessToken);
                if (accessToken != null)
                {
                    //获取指定天数内销售情况
                    string days = GetdltSerViceSupplierDay(); //天数
                    days = string.IsNullOrEmpty(days) ? "1" : days;
                    var SupplierSalesData = cargoWeiXinBus.QueryWxSupplierSalesData(null, Convert.ToInt32(days));

                    //获取供应商数据 ，获取推送者的 openid
                    var SupplierList = cargoWeiXinBus.QueryWxSupplierOpenID();
                    LogHelper.WriteLog("小程序补货通知1");
                    foreach (var item in SupplierSalesData)
                    {
                        foreach (var item2 in SupplierList.Where(a => item.SuppClientNum.ToString() == a.ClientNum))
                        {
                            string openId = item2.wxOpenID;
                            //string templateId = GetdltSalesModelID(); //设置的模板ID
                            string templateId = "oCGTDH6IfLYlRC-TaEan_LN1E_Ffn9auGmU5LkAGga4"; //设置的模板ID
                                                                                               //string toUrl = GetdltServiceToUrl(); //跳转url
                            string toUrl = "http://dlt.neway5.com/Weixin/wxSupplierDataDisplay.aspx?currdate=" + DateTime.Now.ToString("yyyy-MM-dd"); //跳转url
                            string url = "https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=" + accessToken;
                            //设置推送的模板，包括推送的openid、模板ID-templateId 、推送的信息：dt1.Rows[i]["XXX"]等
                            string temp = "{\"touser\": \"" + openId + "\"," +

                                       "\"template_id\": \"" + templateId + "\", " +

                                       "\"topcolor\": \"#00ffea\", " +

                                        "\"url\": \"" + toUrl + "\", " +

                                       "\"data\": " +

                                       "{\"thing2\": {\"value\": \"" + (item.HouseName.Length >= 15 ? item.HouseName.Substring(0, 13) + "..." : item.HouseName) + "\"}," +

                                       "\"thing3\": {\"value\": \"" + (item.GoodsName.Length >= 15 ? item.GoodsName.Substring(0, 13) + "..." : item.GoodsName) + "\"}," +

                                       "\"character_string4\": { \"value\": \"" + (item.Piece) + "\"}," +

                                       "\"time5\": {\"value\": \"" + Convert.ToDateTime(DateTime.Now) + "\" }}}";
                            //核心：进行推送请求，并返回相应的反馈信息，如：{"errcode":0,"errmsg":"ok","msgid":XXXXX}
                            LogHelper.WriteLog("小程序补货通知2");
                            string results = GetResponseData(temp, url);
                            strReturn = item2.Name + "——" + openId + "——" + "小程序销售数据推送成功";
                            LogHelper.WriteLog(strReturn);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                strReturn = ex.Message;
                //Console.WriteLine(strReturn);
            }

        }

        /// <summary>
        /// 服务号 账单推送
        /// </summary>
        private void SendBillMessage(object source, ElapsedEventArgs e)
        {
            CargoWeiXinBus cargoWeiXinBus = new CargoWeiXinBus();

            string strReturn = "";
            try
            {
                //获取 access_token
                string AppID = GetdltAPPID();
                string AppSecret = GetdltAppSecret();
                string AccessTokenUrl = String.Format("https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={0}&secret={1}", AppID, AppSecret);//构建请求的url，获取access_token
                string AccessToken = ServiceRequests(AccessTokenUrl, "get");
                JObject json1 = JObject.Parse(AccessToken);
                var accessToken = json1["access_token"];

                //LogHelper.WriteLog("服务号模板信息推送 access_token:" + accessToken);
                if (accessToken != null)
                {
                    //获取供应商数据 ，获取推送者的 openid
                    var SupplierList = cargoWeiXinBus.QueryWxSupplierOpenID();
                    for (int j = 0; j < SupplierList.Count; j++)
                    {
                        //获取账单数据
                        CargoOrderEntity entity = new CargoOrderEntity();
                        var SupplierSalesData = cargoWeiXinBus.QueryWxSupplierBillData(SupplierList[j].wxOpenID).FirstOrDefault();

                        if (SupplierSalesData == null) continue;

                        string openId = SupplierList[j].wxOpenID;
                        //string templateId = GetdltBillModelID(); //设置的模板ID
                        string templateId = "rn8QmHgeDN9UCJ74sVOnMfi7QbtxihjHv3lYypCOP3w"; //设置的模板ID
                        //string toUrl = GetdltServiceBillToUrl(); //跳转url
                        string toUrl = "http://dlt.neway5.com/Weixin/wxDetail.aspx"; //跳转url
                        string url = "https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=" + accessToken;
                        //设置推送的模板，包括推送的openid、模板ID-templateId 、推送的信息：dt1.Rows[i]["XXX"]等
                        string temp = "{\"touser\": \"" + openId + "\"," +

                                      "\"template_id\": \"" + templateId + "\", " +

                                      "\"topcolor\": \"#00ffea\", " +

                                       "\"url\": \"" + toUrl + "\", " +

                                      "\"data\": " +

                                      "{\"character_string11\": {\"value\": \"" + (string.IsNullOrEmpty(SupplierSalesData.AccountNO) ? "-" : SupplierSalesData.ClientName) + "\"}," +

                                      "\"amount2\": { \"value\": \"" + (SupplierSalesData.Total) + "\"}," +

                                      "\"time3\": {\"value\": \"" + Convert.ToDateTime(DateTime.Now) + "\" }}}";
                        //核心：进行推送请求，并返回相应的反馈信息，如：{"errcode":0,"errmsg":"ok","msgid":XXXXX}
                        string results = GetResponseData(temp, url);
                        strReturn = SupplierList[j].Name + "——" + openId + "——" + "推送成功";
                        Console.WriteLine(strReturn);
                    }
                }
            }
            catch (Exception ex)
            {
                strReturn = ex.Message;
                //Console.WriteLine(strReturn);
            }

        }

        //获取请求的数据并返回相应的提示信息
        public static string GetResponseData(string JSONData, string Url)
        {
            byte[] bytes = Encoding.UTF8.GetBytes(JSONData);
            HttpWebRequest request = (HttpWebRequest)WebRequest.Create(Url);
            request.Method = "POST";
            request.ContentLength = bytes.Length;
            request.ContentType = "json";
            Stream reqstream = request.GetRequestStream();
            reqstream.Write(bytes, 0, bytes.Length);
            //声明一个HttpWebRequest请求
            request.Timeout = 90000;
            //设置连接超时时间
            request.Headers.Set("Pragma", "no-cache");
            HttpWebResponse response = (HttpWebResponse)request.GetResponse();
            Stream streamReceive = response.GetResponseStream();
            Encoding encoding = Encoding.UTF8;
            StreamReader streamReader = new StreamReader(streamReceive, encoding);
            string strResult = streamReader.ReadToEnd();
            streamReceive.Dispose();
            streamReader.Dispose();
            return strResult;
        }

        #endregion

        #region 每日获取微信订单 生成日统计数据
        public void GenerateOrderDayStatistics()
        {
            CargoOrderBus cargoOrderBus = new CargoOrderBus();
            //生成当日小程序订单数据
            cargoOrderBus.InsertDayWxOrder(RobotID);

        }
        #endregion

        #region  优惠卷自动失效   一天一次

        void AutomaticAvoidance_Elapsed(object sender, System.Timers.ElapsedEventArgs e)
        {
            // 获取当前时间
            DateTime currentTime = DateTime.Now;
            // 判断是否为凌晨2点
            if (currentTime.Hour != 2)
            {
                return;
            }

            LogEntity log = new LogEntity();
            //log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "优惠卷";
            log.NvgPage = "批量修改优惠卷";
            log.UserID = "机器人";
            log.Status = "0";
            log.Operate = "U";

            try
            {
                //查询可失效优惠卷
                CargoWeiXinBus bus = new CargoWeiXinBus();
                WXCouponEntity queryEntity = new WXCouponEntity();

                //UseStatus传空值就是查询我的所有优惠券，传0就是查询我下面可用的优惠券
                queryEntity.UseStatus = "0";
                queryEntity.IsLoseEfficacy = "1";

                List<WXCouponEntity> list = bus.QueryCouponData(queryEntity);
                if (list.Count <= 0)
                {
                    LogHelper.WriteLog("无可失效优惠卷");
                    return;
                }

                list.ForEach(w => w.UseStatus = "2");

                bus.BatchUpdateCoupon(list, log);
                LogHelper.WriteLog("优惠卷失效成功");
            }
            catch (ApplicationException ex)
            {
                LogHelper.WriteLog("优惠卷失效报错:" + ex.Message);
            }
            return;
        }

        #endregion

        #region 每月每日销量 数据静态化
        //昨日销量数据静态化
        void GenerateDailySalesSnapshot(object sender, ElapsedEventArgs e)
        {
            CargoOrderBus orderBus = new CargoOrderBus();
            orderBus.GenerateDailySalesSnapshot();
        }
        //上月月均销量数据静态化
        void GenerateMonthlySalesSnapshot(object sender, ElapsedEventArgs e)
        {
            CargoOrderBus orderBus = new CargoOrderBus();
            orderBus.GenerateMonthlySalesSnapshot();
        }
        #endregion

        #region 狄乐库存定时导出
        public void DiLeInventoryExport()
        {
            return;
            CargoHouseBus houseBus = new CargoHouseBus();
            var dataList = houseBus.GetInventoryList();
            CargoProductBus bus = new CargoProductBus();
            List<CargoProductSourceEntity> list = bus.QueryAllProductSource();
            CargoClientBus clientBus = new CargoClientBus();
            List<CargoUpClientEntity> clientList = clientBus.QueryAllUpClientDep(new CargoUpClientEntity { });
            string tname = string.Empty;
            DataTable table = new DataTable("库存数据");
            table.Columns.Add("序号", typeof(int));
            table.Columns.Add("所在仓库", typeof(string));
            table.Columns.Add("供应商", typeof(string));
            table.Columns.Add("产地", typeof(string));
            table.Columns.Add("产品名称", typeof(string));
            table.Columns.Add("品牌大类", typeof(string));
            table.Columns.Add("品牌", typeof(string));
            table.Columns.Add("产品编码", typeof(string));
            table.Columns.Add("货品代码", typeof(string));
            table.Columns.Add("规格", typeof(string));
            table.Columns.Add("型号", typeof(string));
            table.Columns.Add("花纹", typeof(string));
            table.Columns.Add("载重指数", typeof(string));
            table.Columns.Add("速度级别", typeof(string));
            table.Columns.Add("批次", typeof(string));
            table.Columns.Add("周期年", typeof(int));
            table.Columns.Add("库存数量", typeof(int));
            //table.Columns.Add("在库天数", typeof(int));
            table.Columns.Add("超期费用", typeof(decimal));
            table.Columns.Add("门店价", typeof(decimal));
            table.Columns.Add("小程序价", typeof(decimal));
            table.Columns.Add("次日达价", typeof(decimal));
            table.Columns.Add("批发价", typeof(decimal));
            table.Columns.Add("货位数量", typeof(int));
            table.Columns.Add("来货单数量", typeof(int));
            //table.Columns.Add("所在区域", typeof(string));
            //table.Columns.Add("一级区域", typeof(string));

            table.Columns.Add("业务类型(物权)", typeof(string));
            table.Columns.Add("物权", typeof(string));


            int i = 0;
            foreach (var it in dataList)
            {
                i++;
                DataRow newRows = table.NewRow();
                newRows["序号"] = i;
                newRows["所在仓库"] = it.FirstAreaName;
                newRows["供应商"] = it.Supplier;
                newRows["产地"] = it.Born.Equals("1") ? "进口" : "国产";
                newRows["产品名称"] = it.ProductName;
                newRows["品牌大类"] = it.TypeParentName;
                newRows["品牌"] = it.TypeName;
                newRows["产品编码"] = it.ProductCode;
                newRows["货品代码"] = it.GoodsCode;
                newRows["规格"] = it.Specs.Trim();
                newRows["型号"] = it.Model.Trim();
                newRows["花纹"] = it.Figure;
                newRows["载重指数"] = it.LoadIndex;
                newRows["速度级别"] = it.SpeedLevel;
                newRows["批次"] = it.Batch;
                newRows["周期年"] = it.BatchYear;
                newRows["库存数量"] = it.Piece;
                //newRows["在库天数"] = it.InHouseDay;
                newRows["超期费用"] = it.OverDueFee.ToString("F2");
                newRows["门店价"] = it.TradePrice;
                newRows["小程序价"] = it.SalePrice;
                newRows["次日达价"] = it.NextDayPrice;
                newRows["批发价"] = it.WholesalePrice;
                newRows["货位数量"] = it.ContainerIDCount;
                newRows["来货单数量"] = it.SourceOrderNoCount;
                //newRows["所在区域"] = it.AreaName;
                //newRows["一级区域"] = it.ParentAreaName;

                newRows["业务类型(物权)"] = GetText(it.GoodsClass, "GoodsClass");
                newRows["物权"] = GetText(it.OwnerShip, "OwnerShip");


                table.Rows.Add(newRows);
            }
            var fileName = "狄乐库存数据-" + DateTime.Now.ToString("yyyyMMddHHmm") + ".xlsx"; ;
            var filePath = string.Empty;

            var fileFolder = GetStockFile();
            filePath = Path.Combine(fileFolder, fileName);
            ToExcel.DataTableToExcel(table, filePath);
            //ExportDataTableToExcel(table, fileName,out filePath);
            if (File.Exists(filePath))
            {
                houseBus.saveFileLog(new House.Entity.Cargo.House.CargoStockDownloadEntity { FileName = fileName, FilePath = filePath });
                //删除文件
                if (Directory.Exists(fileFolder))
                {
                    // 获取当前文件夹中的所有文件
                    string[] files = Directory.GetFiles(fileFolder);

                    foreach (string file in files)
                    {
                        DateTime createTime = File.GetCreationTime(file);
                        // 判断是否超过一个月
                        if (createTime < DateTime.Now.AddMonths(-1))
                        {
                            // file 变量是文件的完整路径
                            File.Delete(file);
                        }
                    }
                }
            }
        }
        private string GetStockFile()
        {
            return ConfigurationSettings.AppSettings["StockFile"];
        }
        public void ExportDataTableToExcel(DataTable table, string fileName, out string filePath)
        {
            // 获取项目根目录（或你可换成指定目录）
            string projectDir = GetStockFile();
            string exportDir = Path.Combine(projectDir, "");

            if (!Directory.Exists(exportDir))
                Directory.CreateDirectory(exportDir);

            filePath = Path.Combine(exportDir, fileName);

            using (var workbook = new XLWorkbook())
            {
                var worksheet = workbook.Worksheets.Add(table, table.TableName);
                if (table.Rows.Count < 30000) worksheet.Columns().AdjustToContents(); // 自动列宽
                workbook.SaveAs(filePath);
            }

            //Console.WriteLine($"📁 文件已保存到: {filePath}");
        }
        private string GetText(string value, string id)
        {
            string retStr = "";
            if (id.Contains("GoodsClass"))
            {
                if (value.Trim() == "0") retStr = "自有";
                else if (value.Trim() == "1") retStr = "进驻";
                else if (value.Trim() == "2") retStr = "托管";
            }
            else if (id.Contains("OwnerShip"))
            {
                if (value.Trim() == "48") retStr = "湖南狄乐RE";
                else if (value.Trim() == "1") retStr = "昆明云仓";
                else if (value.Trim() == "2") retStr = "已出库";
                else if (value.Trim() == "3") retStr = "运输在途";
                else if (value.Trim() == "4") retStr = "已到达";
                else if (value.Trim() == "5") retStr = "已签收";
                else if (value.Trim() == "6") retStr = "已拣货";
            }

            return retStr;
        }
        public string GetSoureName(List<CargoProductSourceEntity> ProductSource, int Source)
        {
            string SourceName = "";
            for (var i = 0; i < ProductSource.Count; i++)
            {
                if (ProductSource[i].Source == Source)
                {
                    SourceName = ProductSource[i].SourceName;
                    break;
                }
            }
            return SourceName;
        }

        #endregion

        #region 途虎商品推送 推送在库数量与价格
        void TuhuFullSync_Task(object sender, System.Timers.ElapsedEventArgs e)
        {
            //如果是02:00则同步全部商品数据
            if (DateTime.Now.Hour.Equals(2))
            {
                TuhuSync tuhuSync = new TuhuSync();
                tuhuSync.TuhuFullSync();
            }
        }
        void TuhuIncrementalSync_Task(object sender, System.Timers.ElapsedEventArgs e)
        {
            TuhuSync tuhuSync = new TuhuSync();
            tuhuSync.TuhuIncrementalSync();
        }
        #endregion


        #region 天猫库存同步 or 获取发货单

        /// <summary>
        /// 云仓库存-库存同步（支持账面同步，增量加，增量减） 每批次20条
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        private void TmallInventorySync(object sender, ElapsedEventArgs e)
        {
            // 配置参数
            const string APP_KEY = "2025120243201";
            const string APP_SECRET = "1d6c1fb8c356b5b405c674f4c572426d57362a9b";
            const string API_URL = "https://opensandbox.tmallyc.com/api/inventory/skuInventorySyncFacade/inventoryChange";
            const int BATCH_SIZE = 20;
            const int BATCH_DELAY_MS = 1500;
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "天猫定时推送服务";
            log.UserID = "2029";
            log.Operate = "A";
            //获取当前时间戳，用于标识本次同步
            var epochStart = new DateTime(1970, 1, 1, 0, 0, 0, DateTimeKind.Utc);
            var currTIme = ((long)(DateTime.UtcNow - epochStart).TotalMilliseconds).ToString(CultureInfo.InvariantCulture);

            var apiService = new TianMaoApiService(APP_KEY, APP_SECRET, API_URL);
            var houseBus = new CargoHouseBus();
            LogBus logbus = new LogBus();

            try
            {
                // 获取库存数据
                var stockDataList = houseBus.QueryToTMallStockData(new CargoContainerShowEntity
                {
                    HouseID = 93,
                    TypeID = 34
                });

                if (stockDataList == null || stockDataList.Count == 0)
                {
                    Console.WriteLine("没有需要同步的库存数据");
                    log.Status = "1";
                    log.Memo = $@"{currTIme}:没有需要同步的库存数据:";
                    logbus.InsertLog(log);
                    return;
                }

                var houseGroup = stockDataList.GroupBy(s => s.HouseID).ToList();

                foreach (var itemHouse in houseGroup)
                {
                    var stockData = stockDataList.Where(a => a.HouseID == itemHouse.Key).ToList();
                    // 分批处理
                    int totalBatches = (int)Math.Ceiling((double)stockData.Count / BATCH_SIZE);
                    int successCount = 0;
                    int failCount = 0;
                    var failMessages = new List<string>();

                    for (int i = 0; i < totalBatches; i++)
                    {
                        log.Status = "0";
                        try
                        {
                            // 获取当前批次数据
                            var currentBatch = stockData.Skip(i * BATCH_SIZE).Take(BATCH_SIZE).ToList();

                            // 构建订单对象
                            var mallOrder = new TMallOrderInfo
                            {
                                uniqueKey = $"GZ123_{Guid.NewGuid():N}",
                                thirdWarehouseCode = itemHouse.Key.ToString(),
                                bizType = 1,
                                warehouseCode = "1010112055",
                                supplyId = "353979647",//供应商ID
                                itemList = currentBatch.Select(item => new TMallOrderItem
                                {
                                    //马牌用货品代码
                                    skuCode = item.HouseID == 93 ? item.GoodsCode : item.ProductCode,
                                    skuQuantity = item.Piece,
                                    //skuName = item.Model + item.Figure
                                }).ToList()
                            };

                            // 转换为字典格式
                            var requestData = new Dictionary<string, string>
                            {
                                ["uniqueKey"] = mallOrder.uniqueKey,
                                ["thirdWarehouseCode"] = mallOrder.thirdWarehouseCode,
                                ["bizType"] = mallOrder.bizType.ToString(),
                                ["warehouseCode"] = mallOrder.warehouseCode,
                                ["itemList"] = Newtonsoft.Json.JsonConvert.SerializeObject(mallOrder.itemList),
                                ["supplyId"] = mallOrder.supplyId,
                            };
                            // 发送请求
                            string jsonResponse = apiService.SendRequest(requestData);

                            // 判断结果(根据实际API返回调整)
                            bool isSuccess = !string.IsNullOrEmpty(jsonResponse) && !jsonResponse.Contains("error");

                            if (isSuccess)
                            {
                                successCount++;
                                //log.Memo = $@"{currTIme}:天猫同步详情:" + $"仓库 {itemHouse.Key.ToString()} 批次 {i + 1}/{totalBatches} 成功 ({currentBatch.Count}条)";
                                //logbus.InsertLog(log);
                            }
                            else
                            {
                                failCount++;
                                string errorMsg = $"批次 {i + 1}/{totalBatches} 失败: {jsonResponse}";
                                failMessages.Add(errorMsg);
                                log.Status = "1";
                                log.Memo = $@"{currTIme}:天猫同步失败详情:" + errorMsg;
                                logbus.InsertLog(log);
                            }

                            // 批次间延迟
                            if (i < totalBatches - 1)
                            {
                                System.Threading.Thread.Sleep(BATCH_DELAY_MS);
                            }
                        }
                        catch (Exception ex)
                        {
                            failCount++;
                            string errorMsg = $"批次 {i + 1}/{totalBatches} 异常: {ex.Message}";
                            failMessages.Add(errorMsg);
                            log.Status = "1";
                            log.Memo = $@"{currTIme}:天猫同步失败详情:" + errorMsg;
                            logbus.InsertLog(log);
                        }
                    }
                    log.Status = "0";//重置
                    // 输出结果统计
                    log.Memo = $@"{currTIme}:仓库:[{itemHouse.Key}]天猫同步失败详情:" + $@"
                    ========== 同步结果统计 ==========
                    总数据: {stockData.Count}条
                    总批次: {totalBatches}
                    成功: {successCount} | 失败: {failCount}
                    ";
                    logbus.InsertLog(log);

                    if (failMessages.Count > 0)
                    {
                        failMessages.ForEach(msg => Console.WriteLine($"  - {msg}"));
                        log.Status = "1";
                        log.Memo = $@"{currTIme}:天猫同步失败详情:" + string.Join(",", failMessages);
                        logbus.InsertLog(log);
                    }
                }


            }
            catch (WebException webEx)
            {
                log.Status = "1";
                log.Memo = $@"{currTIme}:天猫HTTP请求异常:" + webEx.Message;
                logbus.InsertLog(log);
                if (webEx.Response is HttpWebResponse errorResponse)
                {
                    using (errorResponse)
                    using (var reader = new StreamReader(errorResponse.GetResponseStream()))
                    {
                        log.Status = "1";
                        log.Memo = $@"{currTIme}:天猫错误响应:" + reader.ReadToEnd();
                        logbus.InsertLog(log);
                    }
                }
            }
            catch (Exception ex)
            {
                log.Status = "1";
                log.Memo = $@"{currTIme}:天猫同步异常:" + ex.ToString();
                logbus.InsertLog(log);

                // logBus.SaveLog(log);
            }
        }
        #endregion
    }

}
