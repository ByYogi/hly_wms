using House.Business;
using House.Business.Cargo;
using House.Business.Log;
using House.Entity;
using House.Entity.Dto.Tuhu;
using Newtonsoft.Json;
using StackExchange.Redis;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.IO;
using System.Linq;
using System.Net;
using System.Text;
using System.Threading;
using System.Threading.Tasks;

namespace HouseServices
{
    internal class TuhuSync
    {
        public string RobotID = Convert.ToString(ConfigurationManager.AppSettings["RobotID"]);
        /// <summary>
        /// 途虎全量推送商品数据
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        //void TuhuPush_Task(object sender, System.Timers.ElapsedEventArgs e)
        public void TuhuFullSync()
        {
            // 记录开始时间
            var startTime = DateTime.Now;
            string stage = "初始化";

            //机器人账号
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "途虎全量推送商品数据（定时任务）";
            log.UserID = RobotID;
            log.Operate = "A";

            //获取途虎Url连接信息
            string tuhuUrl = TuhuConfig.Prod.Url;
            string authCode = TuhuConfig.Prod.AuthCode;

            LogBus logbus = new LogBus();
            CargoInterfaceBus bus = new CargoInterfaceBus();
            // 记录途虎响应信息
            List<string> skuPushResList = new List<string>();
            List<string> pushStockResList = new List<string>();
            List<string> pushPriceResList = new List<string>();
            string skuDelAllRes = null;
            try
            {
                //获取商品信息
                stage = "查询商品数据";
                var brandIDs = TuhuConfig.Brands.Keys.ToArray();
                var houseIDs = TuhuConfig.Houses.Keys.ToArray();
                var prductData = bus.QueryTuhuStockData(brandIDs, houseIDs);
                int originalCount = prductData.Count();

                stage = "查询映射关系";
                var productCodes = prductData.Select(x => x.ProductCode).ToArray();
                var tuhuCodeMaps = bus.QueryTuhuProdCodes(productCodes);
                // ==================== 业务调用 ====================

                // 构建通用头
                var comheaders = TuhuHandle.BuildHeaders();


                //删除指定商品
                //var skuDelRes = PostJson(
                //    TuhuConfig.ProdUrl + TuhuConfig.UrlSkuDeleteAll,
                //    new TuhuPushDto(TuhuConfig.Platform, TuhuConfig.AuthCode)
                //    {
                //        erpSkuCodes = prductData.Select(x => x.ProductCode).Take(50).ToList()
                //    },
                //    comheaders
                //);

                //删除所有商品
                //stage = "删除所有商品";
                //skuDelAllRes = TuhuHandle.PostJson(
                //    tuhuUrl + TuhuConfig.UrlSkuDeleteAll,
                //    new TuhuPushDto(TuhuConfig.Platform, authCode),
                //    comheaders
                //);

                stage = "过滤获取有映射的商品";
                var mappedProducts = prductData
                    .Where(x => tuhuCodeMaps.ContainsKey(x.ProductCode)); // 只处理有映射的商品

                // 开始推送商品数据
                stage = "构建分组数据";
                // 根据 TuhuCode 分组，汇总库存，拼接 ProductCodes
                var groupedData = mappedProducts
                    .GroupBy(x => tuhuCodeMaps[x.ProductCode]) // 按 TuhuCode 分组
                    .Select(g => new
                    {
                        TuhuCode = g.Key,
                        ProductCodes = string.Join(",", g.Select(x => x.ProductCode)),
                        MappedCount = g.Count(),
                        Piece = g.Sum(x => x.Piece),
                        g.First().ProductName,
                        g.First().SalePrice,
                        FirstPorductCode = g.First().ProductCode,
                        FirstProduct = g.First() // 用于获取其他商品信息
                    })
                    .ToList();

                // 记录没有映射的商品
                var unmappedProducts = prductData
                    .Where(x => !tuhuCodeMaps.ContainsKey(x.ProductCode))
                    .Select(x => x.ProductCode)
                    .ToList();
                if (groupedData.Count == 0 && unmappedProducts.Count > 0)
                {
                    log.Memo = $"没有有效的映射可同步商品数据\r\n未映射商品数：{unmappedProducts.Count}\r\n未映射编码：{string.Join(",", unmappedProducts)}\r\n数据：{JSON.Encode(new { groupedData, unmappedProducts })}";
                    logbus.InsertLog(log);
                    return;
                }

                // 每批 50 条
                var batches = groupedData
                    .Select((x, i) => new { x, i })
                    .GroupBy(x => x.i / 50)
                    .Select(g => g.Select(x => x.x).ToList())
                    .ToList();

                int batchIndex = 0;
                int skuFailCount = 0, stockFailCount = 0, priceFailCount = 0;

                stage = "推送商品信息";
                foreach (var batch in batches)
                {
                    batchIndex++;

                    // 1. 推送商品信息（只在第一次同步时推送，后续只推送库存和价格即可）
                    var tuhuPushSkuBody = new TuhuPushDto()
                    {
                        platform = TuhuConfig.Platform,
                        authCode = authCode,
                        skuInfos = batch.Select(x => new Tuhu_Sku
                        {
                            version = 1,
                            erpSkuCode = x.TuhuCode,
                            tuhuSkuCode = x.TuhuCode,
                            ProductCode = x.FirstPorductCode,
                            ProductName = x.ProductName,
                            ProductCodes = x.ProductCodes,
                            GoodsCode = x.FirstProduct.GoodsCode,
                            TypeID = x.FirstProduct.TypeID,
                            TypeName = x.FirstProduct.TypeName,
                            Model = x.FirstProduct.Model,
                            Specs = x.FirstProduct.Specs,
                            Figure = x.FirstProduct.Figure,
                            HubDiameter = x.FirstProduct.HubDiameter,
                            LoadIndex = x.FirstProduct.LoadIndex,
                            SpeedLevel = x.FirstProduct.SpeedLevel,
                            Born = x.FirstProduct.Born
                        }).ToList()
                    };

                    RateLimiter.Wait();
                    var skuRes = TuhuHandle.PostJson(
                        tuhuUrl + TuhuConfig.UrlPushSku,
                        tuhuPushSkuBody,
                        comheaders
                    );
                    skuPushResList.Add(skuRes);
                    if (!IsSuccessResponse(skuRes)) skuFailCount++;

                    stage = "推送库存信息";
                    // 2. 推送库存
                    RateLimiter.Wait();
                    var tuhuPushStockBody = new TuhuPushDto()
                    {
                        platform = TuhuConfig.Platform,
                        authCode = authCode,
                        stockInfos = batch.Select(x => new Tuhu_Stock
                        {
                            version = 1,
                            erpSkuCode = x.TuhuCode,
                            ProductCodes = x.ProductCodes,
                            Piece = x.Piece,
                        }).ToList()
                    };
                    var stockRes = TuhuHandle.PostJson(
                        tuhuUrl + TuhuConfig.UrlPushStock,
                        tuhuPushStockBody,
                        comheaders
                    );
                    pushStockResList.Add(stockRes);
                    if (!IsSuccessResponse(stockRes)) stockFailCount++;

                    stage = "推送价格信息";
                    // 3. 推送价格
                    RateLimiter.Wait();
                    var tuhuPushPriceBody = new TuhuPushDto()
                    {
                        platform = TuhuConfig.Platform,
                        authCode = authCode,
                        priceInfos = batch.Select(x => new Tuhu_Price
                        {
                            version = 1,
                            erpSkuCode = x.TuhuCode,
                            SalePrice = x.SalePrice,
                        }).ToList()
                    };
                    var priceRes = TuhuHandle.PostJson(
                        tuhuUrl + TuhuConfig.UrlPushPrice,
                        tuhuPushPriceBody,
                        comheaders
                    );
                    pushPriceResList.Add(priceRes);
                    if (!IsSuccessResponse(priceRes)) priceFailCount++;
                }

                //记录日志
                var elapsed = (DateTime.Now - startTime).TotalSeconds;
                int mappedCount = groupedData.Count;
                int unmappedCount = unmappedProducts.Count;

                // 构建推送统计信息
                string pushStats = $"SKU推送：{batches.Count - skuFailCount}/{batches.Count}";
                if (skuFailCount > 0) pushStats += $"（失败{skuFailCount}批）";
                pushStats += $"\r\n库存推送：{batches.Count - stockFailCount}/{batches.Count}";
                if (stockFailCount > 0) pushStats += $"（失败{stockFailCount}批）";
                pushStats += $"\r\n价格推送：{batches.Count - priceFailCount}/{batches.Count}";
                if (priceFailCount > 0) pushStats += $"（失败{priceFailCount}批）";

                var mappedMaltProduct = groupedData.Where(x => x.MappedCount > 1).ToArray(); 
                string oneToMultInfo = mappedMaltProduct.Count() > 0 ?
                    $"一对多映射商品数：{mappedMaltProduct.Count()}\r\n\t{string.Join("\r\n\t", mappedMaltProduct.Select(x => x.TuhuCode + "\r\n\t\t" + x.ProductCodes))}" : "";
                string unmappedInfo = unmappedCount > 0 ? $"未映射商品数：{unmappedCount}\r\n\t{string.Join("\r\n\t", unmappedProducts)}" : "";

                log.Memo = $"途虎商品全量同步完成 | 耗时{elapsed:F1}秒\r\n" +
                          $"统计：配置获取原始数据{originalCount}条 → 途虎编码映射后{mappedProducts.Count()}条 => 途虎编码1对多分组后{mappedCount}条\r\n" +
                          (skuDelAllRes != null ? "删除商品响应：" + skuDelAllRes : "") +
                          $"{pushStats}\r\n" +
                          $"{oneToMultInfo}\r\n" +
                          $"{unmappedInfo}\r\n";

                logbus.InsertLog(log);
                LogHelper.WriteLog("途虎商品全量同步成功");
            }
            catch (Exception ex)
            {
                var elapsed = (DateTime.Now - startTime).TotalSeconds;
                log.Status = "1";
                log.Memo = $"途虎商品全量同步失败 | 失败阶段：{stage} | 耗时{elapsed:F1}秒\r\n" +
                          $"SKU响应：{string.Join(",", skuPushResList)}\r\n" +
                          $"库存响应：{string.Join(",", pushStockResList)}\r\n" +
                          $"价格响应：{string.Join(",", pushPriceResList)}\r\n" +
                          $"异常详情：{ex.FormatErr()}";
                logbus.InsertLog(log);
                LogHelper.WriteLog("途虎商品全量同步失败\r\n" + ex.FormatErr());
            }
        }

        /// <summary>
        /// 判断途虎API响应是否成功
        /// </summary>
        private static bool IsSuccessResponse(string response)
        {
            if (string.IsNullOrEmpty(response)) return false;
            try
            {
                // 成功响应包含 "success":true 或 "code":0 等标识
                // 根据实际API响应格式调整
                return response.Contains("\"message\":\"操作成功\"") ||
                       response.Contains("\"code\":10000") ||
                       response.Contains("\"data\":true");
            }
            catch
            {
                return false;
            }
        }

        /// <summary>
        /// 途虎增量推送商品数据
        /// </summary>
        public void TuhuIncrementalSync()
        {
            // 记录开始时间
            var startTime = DateTime.Now;
            string stage = "初始化";

            //机器人账号
            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "途虎增量同步商品库存（定时任务）";
            log.UserID = RobotID;
            log.Operate = "A";

            //获取途虎Url连接信息
            string tuhuUrl = TuhuConfig.Prod.Url;
            string authCode = TuhuConfig.Prod.AuthCode;

            LogBus logbus = new LogBus();
            CargoInterfaceBus bus = new CargoInterfaceBus();
            // 记录途虎响应信息
            List<string> skuPushResList = new List<string>();
            List<string> pushStockResList = new List<string>();
            List<string> pushPriceResList = new List<string>();
            // 记录请求body（增量同步数据少，记录完整请求）
            List<TuhuPushDto> skuRequestBodies = new List<TuhuPushDto>();
            List<TuhuPushDto> stockRequestBodies = new List<TuhuPushDto>();
            List<TuhuPushDto> priceRequestBodies = new List<TuhuPushDto>();
            try
            {
                //获取商品信息
                stage = "读取Redis缓存";
                HashEntry[] HCYCredisValues = RedisHelper.HashGetAll("TuhuStockSyc");
                if(HCYCredisValues == null || HCYCredisValues.Length ==0)
                {
                    return;
                }

                stage = "过滤品牌仓库";
                var dict = HCYCredisValues.ToDictionary(x => x.Name.ToString(), x => x.Value.ToString());
                var confHouseIDs = TuhuConfig.Houses.Keys.ToList();
                var confBrandIDs = TuhuConfig.Brands.Keys.ToList();
                var willAsyncHouseIDs = dict.Keys.Select(x => Convert.ToInt32(x.Split('_')[0])).Distinct().Where(x => confHouseIDs.Contains(x)).ToArray();
                var willAsyncBrandIDs = dict.Keys.Select(x => Convert.ToInt32(x.Split('_')[1])).Distinct().Where(x => confBrandIDs.Contains(x)).ToArray();
                var filterHouseIDs = confHouseIDs.Where(x => willAsyncHouseIDs.Contains(x)).ToArray();
                var filterBrandIDs = confBrandIDs.Where(x => willAsyncBrandIDs.Contains(x)).ToArray();
                var productCodes = dict.Values.ToArray();
                if(filterBrandIDs.Length == 0 || filterHouseIDs.Length == 0)
                {
                    log.Memo = $"没有有效的品牌或仓库。\r\n" + JSON.Encode(dict);
                    logbus.InsertLog(log);
                    RedisHelper.HashDeleteAll("TuhuStockSyc");
                    return;
                }
                int redisCount = dict.Values.Count();

                stage = "查询商品数据";
                var prductData = bus.QueryTuhuStockData(filterBrandIDs, filterHouseIDs, productCodes);
                int originalCount = prductData.Count();

                stage = "查询映射关系";
                var tuhuCodeMaps = bus.QueryTuhuProdCodes(productCodes);

                // ==================== 业务调用 ====================
                // 构建通用头
                var comheaders = TuhuHandle.BuildHeaders();

                stage = "过滤获取有映射的商品";
                var mappedProducts = prductData
                    .Where(x => tuhuCodeMaps.ContainsKey(x.ProductCode)); // 只处理有映射的商品

                stage = "构建分组数据";
                // 根据 TuhuCode 分组，汇总库存，拼接 ProductCodes

                var groupedData = mappedProducts
                    .GroupBy(x => tuhuCodeMaps[x.ProductCode]) // 按 TuhuCode 分组
                    .Select(g => new
                    {
                        TuhuCode = g.Key,
                        ProductCodes = string.Join(",", g.Select(x => x.ProductCode)),
                        MappedCount = g.Count(),
                        Piece = g.Sum(x => x.Piece),
                        g.First().SalePrice,
                        g.First().ProductName,
                        FirstPorductCode = g.First().ProductCode,
                        FirstProduct = g.First() // 用于获取其他商品信息
                    })
                    .ToList();

                // 记录没有映射的商品
                var unmappedProducts = prductData
                    .Where(x => !tuhuCodeMaps.ContainsKey(x.ProductCode))
                    .Select(x => x.ProductCode)
                    .ToList();
                if (groupedData.Count == 0 && unmappedProducts.Count > 0)
                {
                    log.Memo = $"没有有效的映射可同步商品数据\r\n未映射商品数：{unmappedProducts.Count}\r\n未映射编码：{string.Join(",", unmappedProducts)}\r\n数据：{JSON.Encode(new { groupedData, unmappedProducts })}";
                    RedisHelper.HashDeleteAll("TuhuStockSyc");
                    logbus.InsertLog(log);
                    return;
                }

                // 开始推送商品数据
                // 每批 50 条
                var batches = groupedData
                    .Select((x, i) => new { x, i })
                    .GroupBy(x => x.i / 50)
                    .Select(g => g.Select(x => x.x).ToList())
                    .ToList();

                int batchIndex = 0;
                int skuFailCount = 0, stockFailCount = 0, priceFailCount = 0;

                foreach (var batch in batches)
                {
                    batchIndex++;

                    stage = "推送商品信息";
                    // 1. 推送商品信息
                    var tuhuPushSkuBody = new TuhuPushDto()
                    {
                        platform = TuhuConfig.Platform,
                        authCode = authCode,
                        skuInfos = batch.Select(x => new Tuhu_Sku
                        {
                            version = 1,
                            erpSkuCode = x.TuhuCode,
                            tuhuSkuCode = x.TuhuCode,
                            ProductCode = x.FirstPorductCode,
                            ProductName = x.ProductName,
                            ProductCodes = x.ProductCodes,
                            GoodsCode = x.FirstProduct.GoodsCode,
                            TypeID = x.FirstProduct.TypeID,
                            TypeName = x.FirstProduct.TypeName,
                            Model = x.FirstProduct.Model,
                            Specs = x.FirstProduct.Specs,
                            Figure = x.FirstProduct.Figure,
                            HubDiameter = x.FirstProduct.HubDiameter,
                            LoadIndex = x.FirstProduct.LoadIndex,
                            SpeedLevel = x.FirstProduct.SpeedLevel,
                            Born = x.FirstProduct.Born
                        }).ToList()
                    };
                    skuRequestBodies.Add(tuhuPushSkuBody); // 记录请求body

                    RateLimiter.Wait();
                    var skuRes = TuhuHandle.PostJson(
                        tuhuUrl + TuhuConfig.UrlPushSku,
                        tuhuPushSkuBody,
                        comheaders
                    );
                    skuPushResList.Add(skuRes);
                    if (!IsSuccessResponse(skuRes)) skuFailCount++;

                    stage = "推送库存信息";
                    // 2. 推送库存
                    RateLimiter.Wait();
                    var tuhuPushStockBody = new TuhuPushDto()
                    {
                        platform = TuhuConfig.Platform,
                        authCode = authCode,
                        stockInfos = batch.Select(x => new Tuhu_Stock
                        {
                            version = 1,
                            erpSkuCode = x.TuhuCode,
                            ProductCodes = x.ProductCodes,
                            Piece = x.Piece,
                        }).ToList()
                    };
                    stockRequestBodies.Add(tuhuPushStockBody); // 记录请求body
                    var stockRes = TuhuHandle.PostJson(
                        tuhuUrl + TuhuConfig.UrlPushStock,
                        tuhuPushStockBody,
                        comheaders
                    );
                    pushStockResList.Add(stockRes);
                    if (!IsSuccessResponse(stockRes)) stockFailCount++;

                    stage = "推送价格信息";
                    // 3. 推送价格
                    RateLimiter.Wait();
                    var tuhuPushPriceBody = new TuhuPushDto()
                    {
                        platform = TuhuConfig.Platform,
                        authCode = authCode,
                        priceInfos = batch.Select(x => new Tuhu_Price
                        {
                            version = 1,
                            erpSkuCode = x.TuhuCode,
                            SalePrice = x.SalePrice,
                        }).ToList()
                    };
                    priceRequestBodies.Add(tuhuPushPriceBody); // 记录请求body
                    var priceRes = TuhuHandle.PostJson(
                        tuhuUrl + TuhuConfig.UrlPushPrice,
                        tuhuPushPriceBody,
                        comheaders
                    );
                    pushPriceResList.Add(priceRes);
                    if (!IsSuccessResponse(priceRes)) priceFailCount++;
                }
                RedisHelper.HashDeleteAll("TuhuStockSyc");

                //记录日志
                var elapsed = (DateTime.Now - startTime).TotalSeconds;
                int mappedCount = groupedData.Count;
                int unmappedCount = unmappedProducts.Count;

                // 构建推送统计信息
                string pushStats = $"SKU推送：{batches.Count - skuFailCount}/{batches.Count}";
                if (skuFailCount > 0) pushStats += $"（失败{skuFailCount}批）";
                pushStats += $"\r\n库存推送：{batches.Count - stockFailCount}/{batches.Count}";
                if (stockFailCount > 0) pushStats += $"（失败{stockFailCount}批）";
                pushStats += $"\r\n价格推送：{batches.Count - priceFailCount}/{batches.Count}";
                if (priceFailCount > 0) pushStats += $"（失败{priceFailCount}批）";

                var mappedMaltProduct = groupedData.Where(x => x.MappedCount > 1).ToArray();
                string oneToMultInfo = mappedMaltProduct.Count() > 0 ?
                    $"一对多映射商品数：{mappedMaltProduct.Count()}\r\n\t{string.Join("\r\n\t", mappedMaltProduct.Select(x => x.TuhuCode + "\r\n\t\t" + x.ProductCodes))}" : "";
                string unmappedInfo = unmappedCount > 0 ? $"未映射商品数：{unmappedCount}\r\n\t {string.Join("\r\n\t", unmappedProducts)}" : "";

                // 序列化请求body
                string skuRequestJson = JsonConvert.SerializeObject(skuRequestBodies, Formatting.Indented);
                string stockRequestJson = JsonConvert.SerializeObject(stockRequestBodies, Formatting.Indented);
                string priceRequestJson = JsonConvert.SerializeObject(priceRequestBodies, Formatting.Indented);


                log.Memo = $"途虎商品库存增量同步完成 | 耗时{elapsed:F1}秒\r\n" +
                          $"统计：原始Redis{redisCount}条 → 过滤后{originalCount}条 → 映射后{mappedProducts.Count()}条 => 分组后{mappedCount}条\r\n" +
                          $"{pushStats}\r\n" +
                          $"{oneToMultInfo}\r\n" +
                          $"{unmappedInfo}\r\n" +
                          $"=== 商品推送请求Body ===\r\n{skuRequestJson}\r\n" +
                          $"=== 库存推送请求Body ===\r\n{stockRequestJson}\r\n" +
                          $"=== 价格推送请求Body ===\r\n{priceRequestJson}";

                logbus.InsertLog(log);
                LogHelper.WriteLog("途虎商品库存增量同步成功");

            }
            catch (Exception ex)
            {
                var elapsed = (DateTime.Now - startTime).TotalSeconds;
                log.Status = "1";
                log.Memo = $"途虎商品库存增量同步失败 | 失败阶段：{stage} | 耗时{elapsed:F1}秒\r\n" +
                          $"SKU响应：{string.Join(",", skuPushResList)}\r\n" +
                          $"库存响应：{string.Join(",", pushStockResList)}\r\n" +
                          $"价格响应：{string.Join(",", pushPriceResList)}\r\n" +
                          $"异常详情：{ex.FormatErr()}";
                logbus.InsertLog(log);
                LogHelper.WriteLog("途虎商品库存增量同步失败\r\n" + ex.FormatErr());
            }
        }
    }

    internal static class TuhuHandle
    {
        public static string Sha256(string input)
        {
            using (var sha = System.Security.Cryptography.SHA256.Create())
            {
                var bytes = Encoding.UTF8.GetBytes(input);
                var hash = sha.ComputeHash(bytes);
                return BitConverter.ToString(hash).Replace("-", "").ToLower();
            }
        }

        /// <summary>
        /// 获取当前时间戳
        /// </summary>
        /// <returns></returns>
        public static long GetUnixTimestampMilliseconds()
        {
            // 兼容 .NET Framework 4.5.1
            var utc = DateTime.UtcNow;
            var epoch = new DateTime(1970, 1, 1, 0, 0, 0, DateTimeKind.Utc);
            return (long)(utc - epoch).TotalMilliseconds;
        }
        // 公共：构建请求头
        public static Dictionary<string, string> BuildHeaders()
        {
            //string timestampMs = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds().ToString();
            string timestampMs = GetUnixTimestampMilliseconds().ToString(); //获取当前时间戳，兼容 .NET Framework 4.5.1
            string nonceStr = Guid.NewGuid().ToString("N");

            string sign = Sha256(
                $"appId={TuhuConfig.Prod.AppId}&nonceStr={nonceStr}&signType=sha256&timestamp={timestampMs}{TuhuConfig.Prod.AppSecret}"
            );

            return new Dictionary<string, string>
            {
                ["appid"] = TuhuConfig.Prod.AppId,
                ["noncestr"] = nonceStr,
                ["signType"] = "sha256",
                ["sign"] = sign,
                ["authType"] = "openapi",
                ["timestamp"] = timestampMs
            };
        }

        // 公共：发送 POST JSON
        public static string PostJson(string url, object body, Dictionary<string, string> headers)
        {
            //使用匿名方法跳过 SSL/TLS 证书校验
            ServicePointManager.ServerCertificateValidationCallback = delegate { return true; };
            ServicePointManager.SecurityProtocol = (SecurityProtocolType)3072;

            var req = (HttpWebRequest)WebRequest.Create(url);
            req.Method = "POST";
            req.ContentType = "application/json";

            foreach (var h in headers)
                req.Headers[h.Key] = h.Value;

            string bodyJson = JsonConvert.SerializeObject(body);
            var bytes = Encoding.UTF8.GetBytes(bodyJson);
            req.ContentLength = bytes.Length;

            using (var stream = req.GetRequestStream())
                stream.Write(bytes, 0, bytes.Length);

            using (var res = req.GetResponse())
            using (var stream = res.GetResponseStream())
            using (var reader = new StreamReader(stream, Encoding.UTF8))
                return reader.ReadToEnd();
        }

    }
    /// <summary>
    /// 限制每秒最多 50 次请求（QPS = 50）
    /// </summary>
    static class RateLimiter
    {
        private static readonly object _lock = new object();
        private static readonly Queue<long> _timestamps = new Queue<long>();
        private const int MAX_QPS = 50;

        public static void Wait()
        {
            lock (_lock)
            {
                long now = TuhuHandle.GetUnixTimestampMilliseconds();
                long oneSecondAgo = now - 1000;

                // 移除 1 秒前的请求时间戳
                while (_timestamps.Count > 0 && _timestamps.Peek() < oneSecondAgo)
                {
                    _timestamps.Dequeue();
                }

                // 如果当前已经达到了 50 QPS，则等待
                if (_timestamps.Count >= MAX_QPS)
                {
                    long waitMs = _timestamps.Peek() - oneSecondAgo;
                    if (waitMs > 0)
                        Thread.Sleep((int)waitMs);
                }

                // 记录本次请求时间戳
                _timestamps.Enqueue(TuhuHandle.GetUnixTimestampMilliseconds());
            }
        }
    }
    static class TuhuConfig
    {
        // 通用配置
        public static string Platform => Get("Tuhu.com.platform");
        public static Dictionary<int, string> Brands =>
            Get("Tuhu.com.brands")
                .Split(',')
                .Select(x => x.Trim())
                .Select(x => x.Split('-'))
                .Where(parts => parts.Length == 2)
                .ToDictionary(
                    parts => int.Parse(parts[0]),
                    parts => parts[1]
                );
        public static Dictionary<int, string> Houses =>
            Get("Tuhu.com.houses")
                .Split(',')
                .Select(x => x.Trim())
                .Select(x => x.Split('-'))
                .Where(parts => parts.Length == 2)
                .ToDictionary(
                    parts => int.Parse(parts[0]),
                    parts => parts[1]
                );

        // API 资源路径
        public static string UrlPushSku => Get("Tuhu.urlpath.pushSku");
        public static string UrlPushStock => Get("Tuhu.urlpath.pushStock");
        public static string UrlPushPrice => Get("Tuhu.urlpath.pushPrice");
        public static string UrlSkuDelete => Get("Tuhu.urlpath.skuDelete");
        public static string UrlSkuDeleteAll => Get("Tuhu.urlpath.skuDeleteAll");


        public static class Test
        {
            // 测试环境
            public static string Url => Get("Tuhu.test.url");
            public static string AppId => Get("Tuhu.test.appid");
            public static string AppSecret => Get("Tuhu.test.appsecret");
            public static string AuthCode => Get("Tuhu.test.authCode");
        }
        public static class Prod
        {
            // 正式环境
            public static string Url => Get("Tuhu.prod.url");
            public static string AppId => Get("Tuhu.prod.appid");
            public static string AppSecret => Get("Tuhu.prod.appsecret");
            public static string AuthCode => Get("Tuhu.prod.authCode");
        }

        // 内部方法
        private static string Get(string key)
        {
            return ConfigurationManager.AppSettings[key] ?? "";
        }
    }
}
