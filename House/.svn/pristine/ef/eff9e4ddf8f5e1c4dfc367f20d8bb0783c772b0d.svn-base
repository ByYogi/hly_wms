using House.Business.Log;
using House.Entity;
using House.Entity.Cargo;
using House.Entity.Cargo.Order;
using House.Entity.Cargo.Product;
using House.Entity.Dto;
using House.Entity.Dto.Base;
using House.Entity.Dto.Order;
using House.Entity.Dto.Order.CargoRpl;
using House.Entity.House;
using House.Manager;
using House.Manager.Cargo;
using House.Manager.Common;
using Newtonsoft.Json;
using System;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Configuration;
using System.Data;
using System.Data.Common;
using System.Data.SqlTypes;
using System.IO;
using System.Linq;
using System.Security.Policy;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Transactions;
using System.Web.Script.Serialization;

namespace House.Business.Cargo
{
    /// <summary>
    /// 订单操作逻辑类
    /// </summary>
    public class CargoOrderBus
    {
        private CargoOrderManager man = new CargoOrderManager();
        private string _userid = string.Empty;
        private string _username = string.Empty;
        private string _ipaddress = string.Empty;
        public CargoOrderBus() { }
        public CargoOrderBus(string UserID, string UserName, string IPAddress)
        {
            _userid = UserID;
            _username = UserName;
            _ipaddress = IPAddress;
        }
        #region 订单明细操作方法集合
        /// <summary>
        /// 分页查询订单明细
        /// </summary>
        public Hashtable QueryPageOrderDetailsData(int pIndex, int pNum, CargoOrderGoodsEntity entity)
        {
            return man.QueryPageOrderDetailsData(pIndex, pNum, entity);
        }
        #endregion
        #region 订单销售操作方法集合
        /// <summary>
        /// 分页查询订单销售
        /// </summary>
        public Hashtable QueryPageOrderSaleInfo(int pIndex, int pNum, CargoOrderEntity entity)
        {
            return man.QueryPageOrderSaleInfo(pIndex, pNum, entity);
        }
        #endregion
        #region 进仓单管理操作方法集合
        /// <summary>
        /// 分页查询所有进货单
        /// </summary>
        public Hashtable QueryAllPagePurcgaseOrders(int pIndex, int pNum, CargoPurchaseOrderEntity entity)
        {
            return man.QueryAllPagePurcgaseOrders(pIndex, pNum, entity);
        }

        /// <summary>
        /// 查询该进货单下的明细商品
        /// </summary>
        public List<CargoPurchaseOrderGoodsEntity> QueryAllPurcgaseOrderGoods(CargoPurchaseOrderGoodsEntity entity)
        {
            return man.QueryAllPurcgaseOrderGoods(entity);
        }
        public Hashtable QueryAllPurcgaseOrderGoods(int pIndex, int pNum, CargoPurchaseOrderGoodsEntity entity)
        {
            return man.QueryAllPurcgaseOrderGoods(pIndex, pNum, entity);
        }

        /// <summary>
        /// 修改进仓单的收货件数及更新主表收货状态
        /// </summary>
        /// <param name="orderDto"></param>
        /// <param name="log"></param>
        public void UpdatePurchaseOrderGoodsPiece(CargoPurchaseOrderDto orderDto, LogEntity log)
        {
            LogWrite<CargoPurchaseOrderGoodsEntity> lw = new LogWrite<CargoPurchaseOrderGoodsEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    CargoPurchaseOrderEntity retrurnOrder = new CargoPurchaseOrderEntity();
                    List<CargoPurchaseOrderGoodsEntity> returnGoodsList = new List<CargoPurchaseOrderGoodsEntity>();
                    var receivingStatus = orderDto.List.Sum(s => s.ReceivePiece) >= orderDto.List.Sum(s => s.Piece) ? "1" : "2";//收货状态
                    //1.修改进仓单主表【收货状态】
                    man.UpdatePusrhOrderReceivingStatus(orderDto.PurchaseOrder.OrderID, orderDto.ClientNum, orderDto.FacOrderNo, receivingStatus);
                    int returnPiece = 0;
                    double returnTransportFee = 0;
                    foreach (var entity in orderDto.List)
                    {
                        //2.修改进仓单明细【收货件数、退货件数】
                        man.UpdatePurchaseOrderGoodsPiece(entity);
                        log.Memo = "进仓单管理保存收货件数及退货件数，进仓单号：" + orderDto.FacOrderNo + "，订单号：" + entity.OrderID + "，货品代码：" + entity.GoodsCode + "，产品编码：" + entity.ProductCode + "，收货件数：" + entity.ReceivePiece + "，退货件数：" + entity.ReturnPiece + "，客户编码：" + orderDto.ClientNum + "，收货状态：" + receivingStatus;
                        lw.WriteLog(entity, log);
                        if (entity.ReturnPiece > 0)
                        {
                            returnPiece += entity.ReturnPiece;
                            returnTransportFee += entity.ReturnPiece * entity.SalePrice;
                            returnGoodsList.Add(new CargoPurchaseOrderGoodsEntity
                            {
                                TypeID = entity.TypeID,
                                Piece = entity.Piece,
                                ReceivePiece = 0,
                                ReturnPiece = entity.ReturnPiece,
                                ProductCode = entity.ProductCode,
                                Specs = entity.Specs,
                                Figure = entity.Figure,
                                Model = entity.Model,
                                GoodsCode = entity.GoodsCode,
                                LoadIndex = entity.LoadIndex,
                                SpeedLevel = entity.SpeedLevel,
                                Born = entity.Born,
                                Batch = entity.Batch,
                                InHousePrice = entity.InHousePrice,
                                UnitPrice = entity.UnitPrice,
                                CostPrice = entity.CostPrice,
                                TradePrice = entity.TradePrice,
                                SalePrice = entity.SalePrice,
                                OP_ID = orderDto.LoginName,
                            });
                        }
                    }
                    if (returnGoodsList.Count > 0)
                    {
                        //3.若有退货订单则 新增【退货订单】进仓单及明细产品
                        //man.AddReturnPurschaseOrders(orderDto.PurchaseOrder, returnGoodsList, receivingStatus);
                        man.AddReturnPurschaseOrders(new CargoPurchaseOrderEntity { Piece = returnPiece, TransitFee = 0.00, TransportFee = returnTransportFee, HandFee = 0.00, OtherFee = 0.00, TotalCharge = returnTransportFee, ClientNum = orderDto.PurchaseOrder.ClientNum, AcceptUnit = orderDto.PurchaseOrder.AcceptUnit, AcceptAddress = orderDto.PurchaseOrder.AcceptAddress, AcceptPeople = orderDto.PurchaseOrder.AcceptPeople, AcceptTelephone = orderDto.PurchaseOrder.AcceptTelephone, AcceptCellphone = orderDto.PurchaseOrder.AcceptCellphone, CreateAwbID = orderDto.LoginName, CreateAwb = orderDto.UserName, HouseID = orderDto.HouseID, Remark = orderDto.returnRemark, ReceivingStatus = "0", TrafficType = 5, FacOrderNo = orderDto.FacOrderNo }, returnGoodsList);
                    }
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "进仓单管理保存收货件数及退货件数，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 更新仓库退货单主表的收货状态
        /// </summary>
        /// <param name="orderDto"></param>
        /// <param name="log"></param>
        public void UpdatePurchaseOrderGoodsPiece(List<CargoPurchaseOrderEntity> orderList, LogEntity log)
        {
            LogWrite<CargoPurchaseOrderEntity> lw = new LogWrite<CargoPurchaseOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    //1.修改仓库退仓单主表【收货状态】
                    foreach (var entity in orderList)
                    {
                        man.UpdatePusrhOrderReceivingStatus(entity.OrderID, entity.ClientNum, entity.FacOrderNo, entity.ReceivingStatus);
                        log.Memo = "仓库退货单-批量收货，进仓单号：" + entity.FacOrderNo + "，订单号：" + entity.OrderID + "，客户编码：" + entity.ClientNum + "，收货状态：" + entity.ReceivingStatus;
                        lw.WriteLog(entity, log);
                    }
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "仓库退货单-批量收货，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        #endregion
        #region 好来运订单字段拼接
        /// <summary>
        /// 订单新增字段拼接
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public HLYAddPlanOutOrder HLYAddPlanOutOrder(string OrderNo)
        {
            CargoOrderBus order = new CargoOrderBus();
            List<CargoContainerShowEntity> GoodsList = order.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = OrderNo });
            List<HLYAddPlanOutOrderDetails> detailsList = new List<HLYAddPlanOutOrderDetails>();
            foreach (var cargo in GoodsList)
            {
                detailsList.Add(new HLYAddPlanOutOrderDetails
                {
                    Batch = cargo.Batch,
                    Model = cargo.Model,
                    Piece = cargo.Piece,
                    GoodsCode = cargo.GoodsCode,
                    TypeID = cargo.TypeID.ToString(),
                    TypeName = cargo.TypeName,
                    Specs = cargo.Specs,
                    Figure = cargo.Figure,
                    LoadIndex = cargo.LoadIndex,
                    SpeedLevel = cargo.SpeedLevel,
                    BelongDepart = cargo.BelongDepart,
                    ProductName = cargo.ProductName,
                    Brand = cargo.TypeName,
                    Born = cargo.Born,
                    ProductCode = cargo.ProductCode,
                    Unit = "条",
                    BoxType = "s01",
                    QtyInUint = 1,
                    SupplierCode = "DLQF"
                });
            }
            CargoOrderEntity orderInfo = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = OrderNo });
            HLYAddPlanOutOrder planOutOrder = new HLYAddPlanOutOrder();
            //planOutOrder.DepartmentID = ent.CargoDepart;
            planOutOrder.DepartmentID = "B0002";
            planOutOrder.StoreType = 1;
            //planOutOrder.BusinessID = ent.CargoDepart;
            planOutOrder.BusinessID = orderInfo.BusinessID;
            planOutOrder.HouseCode = orderInfo.HouseCode;
            planOutOrder.HouseName = orderInfo.HouseName;
            planOutOrder.CustomerCode = "迪乐泰";
            planOutOrder.GtmcNo = orderInfo.OrderNo;
            planOutOrder.SupplierCode = "DLQF";
            planOutOrder.SupplierName = "迪乐泰";
            planOutOrder.TakeTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            planOutOrder.DepartTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
            planOutOrder.Piece = orderInfo.Piece;
            planOutOrder.InputType = 1;
            planOutOrder.OrderType = 0;
            planOutOrder.Remark = orderInfo.Remark;
            planOutOrder.ToGuestID = orderInfo.ClientNum;
            planOutOrder.ToGuestName = orderInfo.AcceptUnit;
            planOutOrder.Toname = orderInfo.AcceptPeople;
            planOutOrder.Toaddress = orderInfo.AcceptAddress;
            planOutOrder.Totel = orderInfo.AcceptTelephone;
            planOutOrder.ToMobile = orderInfo.AcceptCellphone;
            planOutOrder.Provinces = orderInfo.Province;
            planOutOrder.City = orderInfo.Dest;//出发城市 orderInfo.City;
            planOutOrder.CreateBy = "机器人";
            planOutOrder.TakeNo = "01";
            if (!orderInfo.LogisID.Equals(34))
            {
                planOutOrder.TransportCompany = 1;
            }
            planOutOrder.Fdep = orderInfo.Dep;
            planOutOrder.details = detailsList;
            planOutOrder.Inuser = "";
            planOutOrder.Hangtag = "";
            planOutOrder.FactoryID = "";
            return planOutOrder;
        }

        /// <summary>
        /// 来货单新增字段拼接
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public HLYAddReceipt HLYAddFactoryOrder(CargoFactoryOrderEntity item)
        {
            List<HLYAddReceiptDetails> HLYAddReceiptDetailsList = new List<HLYAddReceiptDetails>();
            HLYAddReceiptDetailsList.Add(new HLYAddReceiptDetails
            {
                Specs = item.Specs,
                Figure = item.Figure,
                Model = item.Model,
                GoodsCode = item.GoodsCode,
                LoadIndex = item.LoadIndex,
                SpeedLevel = item.SpeedLevel,
                Born = item.Born,
                Assort = item.Assort,
                Brand = item.TypeName,
                SupplierCode = "狄乐汽服",
                ProductName = item.TypeName + "轮胎",
                QtyInUint = 1,
                BoxType = "S01",
                Unit = "条",
                QtyDelivery = item.ReplyNumber,
                CargoTypeID = item.TypeID,
                CargoTypeName = item.TypeName,
                SpecsType = item.SpecsType,
            });
            CargoHouseBus house = new CargoHouseBus();
            CargoHouseEntity houseEntity = house.QueryCargoHouse(new CargoHouseEntity { HouseID = item.HouseID });
            HLYAddReceipt addReceipt = new HLYAddReceipt();
            addReceipt.DepartmentID = "B0002";
            addReceipt.BusinessID = "151";
            addReceipt.CustomerCode = "狄乐汽服";
            addReceipt.CargoHouseID = houseEntity.HouseID;
            //addReceipt.FactoryID = "";
            addReceipt.HouseCode = houseEntity.HouseCode;
            addReceipt.HouseName = houseEntity.Name;
            addReceipt.SupplierDeliveryNo = item.FacOrderNo;
            addReceipt.BelongMonth = item.BelongMonth;
            addReceipt.BelongDepart = item.BelongMonth.Equals("0") ? "RE" : "OE";
            addReceipt.Status = 1;
            addReceipt.CreateBy = "机器人";
            addReceipt.ReceiptDatePlan = DateTime.Now.ToString("yyyy-MM-dd");
            addReceipt.SupplierCode = "DLQF";

            //addReceipt.SourceID = item.Source;
            //addReceipt.SourceName= item.SourceName;
            addReceipt.OrderType = item.OrderType;
            addReceipt.IsSupCode = true;

            addReceipt.SupplierContact = "";
            addReceipt.SupplierPhone = "";
            addReceipt.CarNumber = "";
            addReceipt.DriverName = "";
            addReceipt.DriverPhone = "";
            addReceipt.Remark = "";
            addReceipt.BusinessID = item.BusinessID;
            addReceipt.details = HLYAddReceiptDetailsList;
            return addReceipt;
        }
        #endregion
        #region 订单管理操作方法集合
        /// <summary>
        /// 修改好来运新系统计划单号
        /// </summary>
        /// <param name="orderNo"></param>
        /// <param name="PlanOrderNo"></param>
        /// <param name="log"></param>
        public void UpdateHLYPlanOrderNo(string orderNo, string Awbno, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateHLYPlanOrderNo(orderNo, Awbno);
                    man.UpdateCargoOrderPushAwbNo(new CargoOrderPushEntity { OrderNo = orderNo, PushStatus = "1" });
                    log.Memo = "订单号：" + orderNo + "，运单号：" + Awbno;
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改计划单号失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        public List<CargoProductShelvesEntity> queryOrderProductForAPP(string OrderNo)
        {
            return man.queryOrderProductForAPP(OrderNo);
        }
        public List<CargoProductShelvesEntity> queryOrderProductForAPP(string[] OrderNos)
        {
            return man.queryOrderProductForAPP(OrderNos);
        }


        /// <summary>
        /// 查询订单数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryOrderInfo(int pIndex, int pNum, CargoOrderEntity entity)
        {
            return man.QueryOrderInfo(pIndex, pNum, entity);
        }
        /// <summary>
        /// 通过OrderID查询订单数据
        /// </summary>
        /// <param name="orderID"></param>
        /// <returns></returns>
        public CargoOrderEntity QueryOrderInfoByOrderID(Int64 orderID)
        {
            return man.QueryOrderInfoByOrderID(orderID);
        }
        /// <summary>
        /// 通过OrderNo查询订单数据
        /// </summary>
        /// <param name="orderID"></param>
        /// <returns></returns>
        public CargoOrderEntity QueryOrderTempInfoByOrderNo(string orderID)
        {
            return man.QueryOrderTempInfoByOrderNo(orderID);
        }
        /// <summary>
        /// 通过OrderID查询订单数据
        /// </summary>
        /// <param name="orderID"></param>
        /// <returns></returns>
        public CargoOrderEntity QueryReturnOrderInfoByOrder(CargoOrderEntity entity)
        {
            return man.QueryReturnOrderInfoByOrder(entity);
        }
        /// <summary>
        /// 查询订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoOrderEntity QueryOrderInfo(CargoOrderEntity entity)
        {
            return man.QueryOrderInfo(entity);
        }
        /// <summary>
        /// 查询订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoReserveOrderEntity QueryReserveOrderInfo(CargoReserveOrderEntity entity)
        {
            return man.QueryReserveOrderInfo(entity);
        }
        public List<CargoProductInfoEntity> QueryOrderTagInfo(CargoOrderEntity entity)
        {
            return man.QueryOrderTagInfo(entity);
        }

        /// <summary>
        /// 查询客户订单用于账单对账
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderEntity> QueryOrderAccount(CargoOrderEntity entity)
        {
            return man.QueryOrderAccount(entity);
        }
        public List<CargoOrderPickPlanGoodsEntity> QueryOrderPickPlanGoods(CargoOrderPickPlanGoodsEntity entity)
        {
            return man.QueryOrderPickPlanGoods(entity);
        }
        public List<CargoOrderEntity> QueryWxOrderDataInfo(CargoOrderEntity entity)
        {
            return man.QueryWxOrderDataInfo(entity);
        }
        public List<CargoOrderEntity> QueryWxOrderRule(CargoOrderEntity entity)
        {
            return man.QueryWxOrderRule(entity);
        }
        public List<CargoOrderEntity> QueryOrderDataInfo(CargoOrderEntity entity)
        {
            return man.QueryOrderDataInfo(entity);
        }
        public List<CargoOrderEntity> QueryOrderReturnData(CargoOrderEntity entity)
        {
            return man.QueryOrderReturnData(entity);
        }
        public Hashtable QueryOrderPickPlan(CargoOrderPickPlanEntity entity, int pageIndex, int pageSize)
        {
            return man.QueryOrderPickPlan(entity, pageIndex, pageSize);
        }

        public Hashtable QueryBundle(CargoOrderBundleEntity entity, int pageSize, int pageIndex)
        {
            return man.QueryBundle(entity, pageIndex, pageSize);
        }
        public Hashtable QueryBundleGoods(CargoOrderBundleEntity entity)
        {
            return man.QueryBundleGoods(entity);
        }
        public void UpdataBundleGoods(CargoOrderBundleEntity entity)
        {
            man.UpdataBundleGoods(entity);
        }
        public void AddBundleGoods(CargoOrderBundleEntity entity)
        {
            man.AddBundleGoods(entity);
        }
        public void DelBundleGoods(List<CargoOrderBundleEntity> entity)
        {
            man.DelBundleGoods(entity);
        }
        public void DelOrderPickPlan(List<CargoOrderPickPlanEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderPickPlanEntity> lw = new LogWrite<CargoOrderPickPlanEntity>();

            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                foreach (var it in entity)
                {
                    man.DelOrderPickPlan(it);
                    lw.WriteLog(it, log);
                }
                scope.Complete();

            }
        }
        public List<CargoOrderEntity> QueryCargoOrderKuaidi100(CargoOrderEntity entity)
        {
            return man.QueryCargoOrderKuaidi100(entity);
        }
        /// <summary>
        /// 通过订单号查询订单数据
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryOrderByOrderNo(CargoOrderEntity entity)
        {
            return man.QueryOrderByOrderNo(entity);
        }
        public List<CargoContainerShowEntity> QueryAppletOrderByOrderNo(CargoOrderEntity entity)
        {
            return man.QueryAppletOrderByOrderNo(entity);
        }
        public CargoOrderEntity QueryOesPreOrderInfo(CargoOrderEntity entity)
        {
            return man.QueryOesPreOrderInfo(entity);
        }
        public void UpdatePrintNum(CargoOrderEntity entity)
        {
            man.UpdatePrintNum(entity);
        }
        /// <summary>
        /// 保存订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="outHouseList"></param>
        /// <param name="log"></param>
        public void AddOrderInfo(CargoOrderEntity entity, List<CargoContainerShowEntity> outHouseList, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoHouseBus house = new CargoHouseBus();
            CargoClientManager client = new CargoClientManager();
            CargoWeiXinManager wxMan = new CargoWeiXinManager();
            CargoInterfaceManager interfaceManager = new CargoInterfaceManager();
            CargoFinanceManager cargoFinanceManager = new CargoFinanceManager();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.AddOrderInfo(entity);
                    house.saveOutCargoData(outHouseList, log);
                    CargoClientEntity clientEnt = client.QueryCargoClient(entity.ClientNum, 0);
                    if (!clientEnt.ClientID.Equals(0))
                    {
                        if (clientEnt.ClientType.Equals("1") && entity.CheckOutType.Equals("2"))
                        {
                            //月结客户，月结订单，则减客户的月结额度
                            wxMan.UpdateClientLimitMoney(entity.TotalCharge, clientEnt.ClientNum, "1");
                        }
                    }
                    //次日达重复支付
                    if (entity.CheckOutType.Equals("10"))
                    {
                        if (!string.IsNullOrEmpty(entity.WXOrderNo))
                        {
                            //预收款支付 进行扣款 并已支付成功，则修改订单状态为已结算
                            //保存客户预收款的扣款记录
                            client.UpdateClientPreRecord(new CargoClientPreRecordEntity
                            {
                                ClientID = clientEnt.ClientID,
                                ExID = entity.OrderNo,
                                Money = entity.TotalCharge,
                                IsAdd = false,
                                RecordType = "1",
                                OperaType = "0",
                                OP_ID = entity.OP_ID
                            });
                            //保存交易记录
                            long cardID = 0;
                            CargoCashierEntity card = new CargoCashierEntity();
                            card.BasicID = entity.ClientNum;
                            card.RType = "0";
                            card.FromTO = "0";
                            card.AffectAwbNO = entity.OrderNo;
                            card.AffectCash = entity.TotalCharge;
                            card.Memo = entity.Remark;
                            card.OP_ID = entity.OP_ID;
                            card.OP_DATE = entity.OP_DATE;
                            card.UserName = entity.OP_Name;
                            card.TradeType = "1";
                            cardID = cargoFinanceManager.AddCardInfo(card);
                            cargoFinanceManager.AddRecordAwbID(cardID, entity.OrderNo);
                        }
                        //修改订单的结算状态
                        man.UpdateCheckStatusByOrderNo(entity.OrderNo, "1");
                    }
                    //如果有马牌订单号，更新到马牌订单表
                    if (!string.IsNullOrEmpty(entity.OpenOrderNo) && entity.OpenOrderSource == "1")
                    {
                        interfaceManager.UpdateContiOrderCreateData(new saleOpenInfoResp
                        {
                            orderCode = entity.OpenOrderNo,
                            CargoOrderNo = entity.OrderNo,
                            ClientNum = entity.ClientNum,
                            InCreateStatus = "1",
                            CreateAwbID = entity.CreateAwbID,
                            CreateAwb = entity.CreateAwb,
                            CreateDate = entity.CreateDate,
                        });
                    }
                    //如果有开思订单号，更新到开思订单表
                    if (!string.IsNullOrEmpty(entity.OpenOrderNo) && entity.OpenOrderSource == "2")
                    {
                        interfaceManager.UpdateCassMallOrderCreateData(new saleOpenInfoResp
                        {
                            orderCode = entity.OpenOrderNo,
                            CargoOrderNo = entity.OrderNo,
                            ClientNum = entity.ClientNum,
                            InCreateStatus = "1",
                            CreateAwbID = entity.CreateAwbID,
                            CreateAwb = entity.CreateAwb,
                            CreateDate = entity.CreateDate,
                        });
                    }
                    //如果有天猫订单号，更新到天猫订单表
                    if (!string.IsNullOrEmpty(entity.OpenOrderNo) && entity.OpenOrderSource == "5")
                    {
                        interfaceManager.UpdateTMallOrderCreateData(new saleOpenInfoResp
                        {
                            orderCode = entity.OpenOrderNo,
                            CargoOrderNo = entity.OrderNo,
                            ClientNum = entity.ClientNum,
                            InCreateStatus = "1",
                            CreateAwbID = entity.CreateAwbID,
                            CreateAwb = entity.CreateAwb,
                            CreateDate = entity.CreateDate,
                        });
                    }
                    log.Memo = "";
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
                catch (Exception ex)
                {
                    log.Status = "1";
                    log.Memo = $@"[{entity.OrderNo}-{entity.OpenOrderNo}]新增订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 保存订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="outHouseList"></param>
        /// <param name="log"></param>
        public void AddOrderInfoV2(CargoOrderEntity entity, List<CargoContainerShowEntity> outHouseList, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoHouseBus house = new CargoHouseBus();
            CargoClientManager client = new CargoClientManager();
            CargoWeiXinManager wxMan = new CargoWeiXinManager();
            CargoInterfaceManager interfaceManager = new CargoInterfaceManager();
            CargoFinanceManager cargoFinanceManager = new CargoFinanceManager();
            bool isSuccess = false;
            try
            {
                //使用事务
                // 延长超时
                using (TransactionScope scope = new TransactionScope(
                    TransactionScopeOption.Required,
                    new TimeSpan(0, 5, 0)))
                {

                    man.AddOrderInfo(entity);
                    house.saveOutCargoData(outHouseList, log);
                    CargoClientEntity clientEnt = client.QueryCargoClient(entity.ClientNum, 0);
                    if (!clientEnt.ClientID.Equals(0))
                    {
                        if (clientEnt.ClientType.Equals("1") && entity.CheckOutType.Equals("2"))
                        {
                            //月结客户，月结订单，则减客户的月结额度
                            wxMan.UpdateClientLimitMoney(entity.TotalCharge, clientEnt.ClientNum, "1");
                        }
                    }
                    //次日达重复支付
                    if (entity.CheckOutType.Equals("10"))
                    {
                        if (!string.IsNullOrEmpty(entity.WXOrderNo))
                        {
                            //预收款支付 进行扣款 并已支付成功，则修改订单状态为已结算
                            //保存客户预收款的扣款记录
                            client.UpdateClientPreRecord(new CargoClientPreRecordEntity
                            {
                                ClientID = clientEnt.ClientID,
                                ExID = entity.OrderNo,
                                Money = entity.TotalCharge,
                                IsAdd = false,
                                RecordType = "1",
                                OperaType = "0",
                                OP_ID = entity.OP_ID
                            });
                            //保存交易记录
                            long cardID = 0;
                            CargoCashierEntity card = new CargoCashierEntity();
                            card.BasicID = entity.ClientNum;
                            card.RType = "0";
                            card.FromTO = "0";
                            card.AffectAwbNO = entity.OrderNo;
                            card.AffectCash = entity.TotalCharge;
                            card.Memo = entity.Remark;
                            card.OP_ID = entity.OP_ID;
                            card.OP_DATE = entity.OP_DATE;
                            card.UserName = entity.OP_Name;
                            card.TradeType = "1";
                            cardID = cargoFinanceManager.AddCardInfo(card);
                            cargoFinanceManager.AddRecordAwbID(cardID, entity.OrderNo);
                        }
                        //修改订单的结算状态
                        man.UpdateCheckStatusByOrderNo(entity.OrderNo, "1");
                    }
                    
                    scope.Complete();
                    isSuccess = true;
                }
            }
            catch (Exception ex)
            {
                log.Status = "1";
                log.Memo = $@"[{entity.OrderNo}-{entity.OpenOrderNo}]新增订单失败：{ex.Message}";
                SafeWriteLog(lw, log);
                throw;
            }
            finally
            {
                log.Memo = "";
                SafeWriteLog(lw, log);
            }


            // ✅ 事务外处理:
            // 1. 更新第三方平台订单状态 (异步或消息队列)
            if (isSuccess)
                Task.Run(() => UpdateExternalOrderStatus(entity));

        }
        // 安全写日志方法
        private void SafeWriteLog(LogWrite<CargoOrderEntity> lw, params object[] args)
        {
            try
            {
                if (args.Length == 1)
                    lw.WriteLog(args[0] as LogEntity);
                else
                    lw.WriteLog(args[0] as CargoOrderEntity, args[1] as LogEntity);
            }
            catch (Exception ex)
            {
                // 记录到文件或其他地方,不影响主流程
                System.Diagnostics.Trace.WriteLine($"写日志失败: {ex.Message}");
            }
        }
        // 异步更新外部订单
        private void UpdateExternalOrderStatus(CargoOrderEntity entity)
        {
            try
            {
                var interfaceManager = new CargoInterfaceManager();
                var resp = new saleOpenInfoResp
                {
                    orderCode = entity.OpenOrderNo,
                    CargoOrderNo = entity.OrderNo,
                    ClientNum = entity.ClientNum,
                    InCreateStatus = "1",
                    CreateAwbID = entity.CreateAwbID,
                    CreateAwb = entity.CreateAwb,
                    CreateDate = entity.CreateDate,
                };

                switch (entity.OpenOrderSource)
                {
                    case "2": interfaceManager.UpdateCassMallOrderCreateData(resp); break;
                }
            }
            catch (Exception ex)
            {
                // 记录失败,可以用重试机制
                // 或者写入失败队列,定时任务重试
            }
        }

        /// <summary>
        /// 新增订单数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddOrderInfo(CargoOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.AddOrderInfo(entity);
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 新增预订单数据
        /// </summary>
        /// <param name="entity"></param>
        public void AddReserveOrderInfo(CargoReserveOrderEntity entity, LogEntity log)
        {
            CargoClientManager client = new CargoClientManager();
            CargoFinanceManager cargoFinanceManager = new CargoFinanceManager();
            LogWrite<CargoReserveOrderEntity> lw = new LogWrite<CargoReserveOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.AddReserveOrderInfo(entity);
                    CargoClientEntity clientEnt = client.QueryCargoClient(entity.ClientNum, 0);
                    //次日达重复支付
                    if (entity.CheckOutType.Equals("10"))
                    {
                        if (!string.IsNullOrEmpty(entity.WXOrderNo))
                        {
                            //预收款支付 进行扣款 并已支付成功，则修改订单状态为已结算
                            //保存客户预收款的扣款记录
                            client.UpdateClientPreRecord(new CargoClientPreRecordEntity
                            {
                                ClientID = clientEnt.ClientID,
                                ExID = entity.OrderNo,
                                Money = entity.TotalCharge,
                                IsAdd = false,
                                RecordType = "1",
                                OperaType = "0",
                                OP_ID = entity.OP_ID
                            });
                            //保存交易记录
                            long cardID = 0;
                            CargoCashierEntity card = new CargoCashierEntity();
                            card.BasicID = entity.ClientNum;
                            card.RType = "0";
                            card.FromTO = "0";
                            card.AffectAwbNO = entity.OrderNo;
                            card.AffectCash = entity.TotalCharge;
                            card.Memo = entity.Remark;
                            card.OP_ID = entity.OP_ID;
                            card.OP_DATE = entity.OP_DATE;
                            card.UserName = entity.OP_Name;
                            card.TradeType = "1";
                            cardID = cargoFinanceManager.AddCardInfo(card);
                            cargoFinanceManager.AddRecordAwbID(cardID, entity.OrderNo);
                        }
                        //修改订单的结算状态
                        man.UpdateCheckStatusByReserveOrderNo(entity.OrderNo, "1");

                        //回写用户支付记录
                        cargoFinanceManager.AddReservePaymentRecord(new CargoReserveOrderPaymentRecordEntity
                        {
                            OrderNo = entity.OrderNo,
                            WXPayOrderNo = ""
                            ,
                            WxOrderNo = entity.WXOrderNo,
                            PaymentType = Convert.ToInt32(entity.PaymentTypeParams),
                            Trxid = "",
                            OP_ID = entity.OP_ID,
                            PaymentAmount = entity.TotalCharge
                        });
                        // 回写预订单金额
                        cargoFinanceManager.UpdateReserveTotal(new CargoReserveOrderPaymentRecordEntity { OrderNo = entity.OrderNo, WxOrderNo = entity.WXOrderNo });

                    }
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 修改订单
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void UpdateOrderInfo(CargoOrderEntity entity, List<CargoContainerShowEntity> cargoList, LogEntity log)
        {
            CargoHouseManager house = new CargoHouseManager();
            CargoHouseBus cargoBus = new CargoHouseBus();
            CargoInterfaceManager interfaceManager = new CargoInterfaceManager();
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                List<CargoOrderGoodsEntity> newList = entity.goodsList;
                List<CargoOrderGoodsEntity> sameList = new List<CargoOrderGoodsEntity>();
                List<CargoOrderGoodsEntity> twoHaveList = new List<CargoOrderGoodsEntity>();
                List<CargoOrderGoodsEntity> twoHaveNoPieceList = new List<CargoOrderGoodsEntity>();
                List<CargoContainerShowEntity> deleteList = new List<CargoContainerShowEntity>();

                List<CargoContainerShowEntity> cargosameList = new List<CargoContainerShowEntity>();
                List<CargoContainerShowEntity> cargonoPieceList = new List<CargoContainerShowEntity>();

                try
                {
                    //根据订单号查询所有订单产品数据
                    List<CargoContainerShowEntity> oldContainerList = man.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = entity.OrderNo });
                    //新的订单产品数据与旧的进行比较
                    //1.首先找出新订单列表里有的，而旧订单列表里没有的数据 sameList
                    //2.新订单和旧订单里都有的件数也相同的 twoHaveList
                    //3.新订单和旧订单里都有的件数不相同的 twoHaveNoPieceList

                    foreach (var it in newList)
                    {
                        if (oldContainerList.Exists(c => c.ProductID.Equals(it.ProductID) && c.AreaID.Equals(it.AreaID) && c.ContainerCode.Equals(it.ContainerCode) && c.Piece.Equals(it.Piece) && c.ActSalePrice.Equals(it.ActSalePrice)))
                        {
                            //完全相同的数据
                            twoHaveList.Add(it);
                        }
                        else
                        {
                            //新增加进来的
                            CargoContainerShowEntity ccs = cargoList.Find(c => c.ID == it.ID);
                            //if (oldContainerList.Count <= 0)
                            //{
                            //    ccs.OutCargoID = cargoList[0].OutCargoID;
                            //}
                            //else
                            //{
                            //    ccs.OutCargoID = oldContainerList[0].OutCargoID;
                            //}
                            cargosameList.Add(ccs);
                        }
                        #region 注释
                        //if (oldContainerList.Exists(c => (c.ProductID.Equals(it.ProductID) && c.AreaID.Equals(it.AreaID) && c.ContainerCode.Equals(it.ContainerCode) && !c.Piece.Equals(it.Piece))))
                        //{
                        //    twoHaveNoPieceList.Add(it);
                        //    cargonoPieceList.AddRange(cargoList.Where(c => c.ID == it.ID).ToList());

                        //    if (string.IsNullOrEmpty(it.OutCargoID))
                        //    {
                        //        it.OutCargoID = oldContainerList[0].OutCargoID;
                        //        CargoContainerShowEntity ccs = cargoList.Find(c => c.ID == it.ID);

                        //        ccs.OutCargoID = it.OutCargoID;
                        //        cargosameList.Add(ccs);
                        //        sameList.Add(it);
                        //    }
                        //    continue;

                        //}
                        //if (string.IsNullOrEmpty(it.OutCargoID))
                        //{
                        //    it.OutCargoID = oldContainerList[0].OutCargoID;
                        //    CargoContainerShowEntity ccs = cargoList.Find(c => c.ID == it.ID);
                        //    ccs.OutCargoID = it.OutCargoID;
                        //    cargosameList.Add(ccs);
                        //    sameList.Add(it);
                        //} 
                        #endregion
                    }
                    //4.新订单里没有，而旧订单里有的
                    foreach (var it in oldContainerList)
                    {
                        if (newList.Exists(c => c.ProductID.Equals(it.ProductID) && c.AreaID.Equals(it.AreaID) && c.ContainerCode.Equals(it.ContainerCode)))
                        {
                            continue;
                        }
                        if (it.Piece.Equals(0))
                        {
                            continue;
                        }
                        deleteList.Add(it);

                    }
                    //5.首先删除旧订单与产品关联表数据
                    man.DeleteOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = entity.OrderNo });
                    //6.保存新加进来的订单产品数据
                    man.AddOrderGoodsInfo(newList);
                    if (cargosameList.Count > 0)
                    {
                        cargoBus.saveOutCargoData(cargosameList, log);
                    }
                    //7.保存相同不变的订单产品数据
                    //man.AddOrderGoodsInfo(twoHaveList);
                    #region 注释
                    ////8.保存新旧订单里都有，但件数不相同的
                    //foreach (var it in twoHaveNoPieceList)
                    //{
                    //    CargoContainerShowEntity old = oldContainerList.Find(c => (c.ProductID.Equals(it.ProductID) && c.AreaID.Equals(it.AreaID) && c.ContainerCode.Equals(it.ContainerCode)));
                    //    CargoContainerShowEntity ccs = cargonoPieceList.Find(c => c.ID == it.ID);
                    //    CargoContainerGoodsEntity contain = house.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ContainerID = ccs.ContainerID, TypeID = ccs.TypeID, ProductID = it.ProductID });
                    //    if (it.Piece > old.Piece)//说明新订单里是增加了件数
                    //    {
                    //        //修改入库单的在货位件数 增加进去
                    //        house.UpdateCargoContainerGoodsPiece(new CargoContainerGoodsEntity
                    //        {
                    //            ID = contain.ID,
                    //            Piece = old.Piece,
                    //            IsAdd = false
                    //        });
                    //        //修改整个货位的件数
                    //        house.UpdateContainerInPiece(new CargoContainerEntity
                    //        {
                    //            ContainerID = ccs.ContainerID,
                    //            InPiece = old.Piece,
                    //            IsAdd = false
                    //        });
                    //    }
                    //    else
                    //    {
                    //        //修改入库单的在货位件数 增加进去
                    //        house.UpdateCargoContainerGoodsPiece(new CargoContainerGoodsEntity
                    //        {
                    //            ID = contain.ID,
                    //            Piece = old.Piece,
                    //            IsAdd = true
                    //        });
                    //        //修改整个货位的件数
                    //        house.UpdateContainerInPiece(new CargoContainerEntity
                    //        {
                    //            ContainerID = ccs.ContainerID,
                    //            InPiece = old.Piece,
                    //            IsAdd = true
                    //        });
                    //    }
                    //} 
                    #endregion
                    //9.新订单里没有，而旧订单里有的
                    foreach (var it in deleteList)
                    {
                        CargoContainerGoodsEntity contain = house.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ContainerID = it.ContainerID, TypeID = it.TypeID, ProductID = it.ProductID });
                        if (contain != null && !contain.ID.Equals(0))//说明数据库中还存在此货位数据
                        {
                            //修改入库单的在货位件数 增加进去
                            house.UpdateCargoContainerGoodsPiece(new CargoContainerGoodsEntity
                            {
                                ID = contain.ID,
                                Piece = it.Piece,
                                IsAdd = true
                            });
                            //修改整个货位的件数
                            house.UpdateContainerInPiece(new CargoContainerEntity
                            {
                                ContainerID = it.ContainerID,
                                InPiece = it.Piece,
                                IsAdd = true
                            });
                        }
                        else
                        {
                            CargoProductManager product = new CargoProductManager();
                            //说明是全部出库 需要重新入库
                            CargoProductEntity proEnt = product.QueryProductInfoByID(it.ProductID);
                            CargoContainerGoodsEntity inGood = new CargoContainerGoodsEntity
                            {
                                ContainerID = it.ContainerID,
                                ProductID = it.ProductID,
                                Piece = it.Piece,
                                InHouseTime = DateTime.Now,
                                IsPrintInCargo = false,
                                Weight = 0,
                                TypeID = proEnt.TypeID,
                                InHouseType = "3",
                                InCargoID = DateTime.Now.ToString("yyMMdd") + GetRandomFourNumString()//入库单号 
                            };
                            house.AddCargoContainerGoods(inGood);
                            house.AddInContainerGoods(inGood);
                        }
                    }
                    //修改订单数据
                    man.UpdateOrderInfo(entity);
                    //如果有马牌订单号，更新到马牌订单表
                    if (!string.IsNullOrEmpty(entity.OpenOrderNo))
                    {
                        interfaceManager.UpdateContiOrderCreateData(new saleOpenInfoResp
                        {
                            orderCode = entity.OpenOrderNo,
                            CargoOrderNo = entity.OrderNo,
                            ClientNum = entity.ClientNum,
                            InCreateStatus = "1",
                            CreateAwbID = entity.CreateAwbID,
                            CreateAwb = entity.CreateAwb,
                            CreateDate = entity.CreateDate,
                        });
                    }
                    log.Memo = "";
                    lw.WriteLog(entity, log);

                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 修改推送信息
        /// </summary>
        /// <param name="orderNo"></param>
        /// <param name="pushStatus"></param>
        public void UpdateHLYPlan(string orderNo, string pushStatus)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateCargoOrderPushAwbNo(new CargoOrderPushEntity { OrderNo = orderNo, PushStatus = pushStatus });
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    throw;
                }
            }
        }
        public void UpdateOrderBaseInfo(CargoOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateOrderInfo(entity);
                    log.Memo = "";
                    lw.WriteLog(entity, log);

                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 小程序次日达删除订单
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void DeleteWxOrderInfo(CargoOrderEntity entity, LogEntity log)
        {
            CargoHouseManager house = new CargoHouseManager();
            CargoProductManager product = new CargoProductManager();
            CargoWeiXinManager weixin = new CargoWeiXinManager();
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            try
            {
                //使用事务
                using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                {
                    //删除订单数据
                    man.DeleteOrderInfo(entity);
                    List<CargoOrderGoodsEntity> goodsList = man.QueryOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = entity.OrderNo });

                    //删除订单与产品关联数据
                    man.DeleteOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = entity.OrderNo });

                    log.Memo = "订单号：" + entity.OrderNo + "，出发站：" + entity.Dep + "，到达站：" + entity.Dest + "，件数：" + entity.Piece.ToString() + "，费用：" + entity.TotalCharge.ToString() + "，收货人：" + entity.AcceptPeople + "，电话：" + entity.AcceptTelephone + "/" + entity.AcceptCellphone + "，制单人：" + entity.CreateAwb + "，制单时间：" + entity.CreateDate.ToString("yyyy-MM-dd HH:mm:ss") + "，业务员：" + entity.SaleManName + "，物流公司名称：" + entity.LogisticName + "，物流公司单号：" + entity.LogisAwbNo;

                    int UserRulePiece = 0;
                    int goodsPiece = 0;
                    foreach (var good in goodsList)
                    {
                        goodsPiece += good.Piece;
                        if (entity.ThrowGood == "21")
                        {
                            if (good.RuleType.Trim().IndexOf('6') > -1 && string.IsNullOrEmpty(good.SuitClientNum))
                            {
                                UserRulePiece += good.Piece;
                            }
                        }
                        house.DeleteOutCargoData(good.OutCargoID);
                        CargoContainerEntity contain = house.QueryContainerEntityByCode(good.ContainerCode, good.HouseID);
                        house.UpdateContainerInPiece(new CargoContainerEntity { IsAdd = true, ContainerID = contain.ContainerID, InPiece = good.Piece });
                        //根据货位ID和产品ID判断是否存在此货位
                        CargoContainerGoodsEntity cgood = house.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ContainerID = contain.ContainerID, ProductID = good.ProductID });
                        if (cgood != null && !cgood.ID.Equals(0))//说明数据库中还存在此货位数据
                        {
                            house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { IsAdd = true, Piece = good.Piece, ContainerID = contain.ContainerID, ProductID = good.ProductID });
                        }
                        else
                        {
                            //说明是全部出库 需要重新入库
                            CargoProductEntity proEnt = product.QueryProductInfoByID(good.ProductID);
                            CargoContainerGoodsEntity inGood = new CargoContainerGoodsEntity
                            {
                                ContainerID = contain.ContainerID,
                                ProductID = good.ProductID,
                                Piece = good.Piece,
                                InHouseTime = DateTime.Now,
                                IsPrintInCargo = false,
                                Weight = 0,
                                TypeID = proEnt.TypeID,
                                InHouseType = "2",
                                InCargoID = DateTime.Now.ToString("yyMMdd") + GetRandomFourNumString()//入库单号 
                            };
                            house.AddCargoContainerGoods(inGood);
                            house.AddInContainerGoods(inGood);
                        }
                        log.Memo += ",产品ID：" + good.ProductID.ToString() + "，货位代码：" + good.ContainerCode.Trim() + "，件数：" + good.Piece.ToString() + "，销售价：" + good.ActSalePrice.ToString() + "，出库单号：" + good.OutCargoID;

                    }
                    lw.WriteLog(log);
                    scope.Complete();
                }
            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }
        }

        /// <summary>
        /// 删除订单信息
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void DeleteOrderInfo(List<CargoOrderEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoHouseManager house = new CargoHouseManager();
            CargoProductManager product = new CargoProductManager();
            CargoWeiXinManager weixin = new CargoWeiXinManager();
            QiyeManager qiye = new QiyeManager();
            ArrayList HlyPurchaserOrderList = new ArrayList();
            try
            {
                //使用事务
                using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                {
                    foreach (var it in entity)
                    {
                        //1.删除订单数据
                        //2.查询订单与产品关联数据
                        //3.删除订单与产品关联数据
                        //4.删除出库单数据，循环更新在库数据数量
                        //5.根据货位号查询货位ID，然后根据货位ID更新在库产品数量
                        //6.删除产品标签表出库状态
                        //7.退回客户的积分
                        //8.删除改价申请审批记录表
                        //9.撤销批量开单的生成订单状态，删除已开单状态,减少清单列表数据
                        //写入订单删除记录表
                        man.InsertOrderInfoToTemp(it);
                        //删除订单数据
                        man.DeleteOrderInfo(it);
                        List<CargoOrderGoodsEntity> goodsList = man.QueryOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = it.OrderNo });
                        //写入删除订单与产品关联数据
                        man.InsertOrderGoodsInfoToTemp(new CargoOrderGoodsEntity { OrderNo = it.OrderNo });
                        //删除订单与产品关联数据
                        man.DeleteOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = it.OrderNo });
                        //有微信订单，删除
                        if (!string.IsNullOrEmpty(it.WXOrderNo))
                        {
                            WXOrderEntity wxOrder = weixin.QueryWeixinOrderByOrderNo(new WXOrderEntity { OrderNo = it.WXOrderNo });
                            if (wxOrder != null && !wxOrder.ID.Equals(0))
                            {
                                List<CargoProductShelvesEntity> shelves = weixin.QueryWeixinOrderProductInfo(wxOrder.ID);
                                if (wxOrder.PayWay.Equals("2"))
                                {
                                    foreach (var sh in shelves)
                                    {
                                        CargoProductShelvesEntity pshel = weixin.QueryProductShelvesByID(sh.ID);
                                        //积分兑换，要退回客户积分
                                        weixin.AddWeixinPoint(new WXUserPointEntity
                                        {
                                            WXID = wxOrder.WXID,
                                            Point = pshel.Consume,
                                            PointType = "7",
                                            CutPoint = "0",
                                            WXOrderNo = wxOrder.OrderNo
                                        });
                                        //3.加回客户积分
                                        weixin.UpdateWxUserConsume(new WXUserEntity { ConsumerPoint = pshel.Consume, ID = wxOrder.WXID });
                                    }
                                }
                                weixin.DeleteWeixinOrder(new WXOrderEntity { ID = wxOrder.ID, isReserve = false });
                            }
                            weixin.DelCoupon(it.WXOrderNo);
                        }
                        List<CargoProductTagEntity> tagList = product.QueryProductTagList(new CargoProductTagEntity { OrderNo = it.OrderNo });
                        if (tagList.Count > 0)
                        {
                            product.SetTagUnOutCargoByOrderNo(new CargoProductTagEntity { OrderNo = it.OrderNo, OutCargoStatus = "0" });
                        }
                        //删除订单改价申请 
                        QyOrderUpdatePriceEntity upent = new QyOrderUpdatePriceEntity();
                        upent.OrderNo = string.IsNullOrEmpty(it.WXOrderNo) ? it.OrderNo : it.WXOrderNo;
                        QyOrderUpdatePriceEntity delEnt = qiye.QueryOrderUpdatePriceEntity(upent);
                        if (!delEnt.OID.Equals(0)) { man.DelUpdatePriceApply(delEnt); }

                        log.Memo = "订单号：" + it.OrderNo + "，出发站：" + it.Dep + "，到达站：" + it.Dest + "，件数：" + it.Piece.ToString() + "，费用：" + it.TotalCharge.ToString() + "，收货人：" + it.AcceptPeople + "，电话：" + it.AcceptTelephone + "/" + it.AcceptCellphone + "，制单人：" + it.CreateAwb + "，制单时间：" + it.CreateDate.ToString("yyyy-MM-dd HH:mm:ss") + "，业务员：" + it.SaleManName + "，物流公司名称：" + it.LogisticName + "，物流公司单号：" + it.LogisAwbNo;

                        int UserRulePiece = 0;
                        int goodsPiece = 0;
                        foreach (var good in goodsList)
                        {
                            goodsPiece += good.Piece;
                            if (it.ThrowGood == "21")
                            {
                                if (good.RuleType.Trim().IndexOf('6') > -1 && string.IsNullOrEmpty(good.SuitClientNum))
                                {
                                    UserRulePiece += good.Piece;
                                }
                            }
                            house.DeleteOutCargoData(good.OutCargoID);
                            CargoContainerEntity contain = house.QueryContainerEntityByCode(good.ContainerCode, good.HouseID);
                            house.UpdateContainerInPiece(new CargoContainerEntity { IsAdd = true, ContainerID = contain.ContainerID, InPiece = good.Piece });
                            //根据货位ID和产品ID判断是否存在此货位
                            CargoContainerGoodsEntity cgood = house.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ContainerID = contain.ContainerID, ProductID = good.ProductID });
                            if (cgood != null && !cgood.ID.Equals(0))//说明数据库中还存在此货位数据
                            {
                                house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { IsAdd = true, Piece = good.Piece, ContainerID = contain.ContainerID, ProductID = good.ProductID });
                            }
                            else
                            {
                                //说明是全部出库 需要重新入库
                                CargoProductEntity proEnt = product.QueryProductInfoByID(good.ProductID);
                                CargoContainerGoodsEntity inGood = new CargoContainerGoodsEntity
                                {
                                    ContainerID = contain.ContainerID,
                                    ProductID = good.ProductID,
                                    Piece = good.Piece,
                                    InHouseTime = DateTime.Now,
                                    IsPrintInCargo = false,
                                    Weight = 0,
                                    TypeID = proEnt.TypeID,
                                    InHouseType = "2",
                                    InCargoID = DateTime.Now.ToString("yyMMdd") + GetRandomFourNumString()//入库单号 
                                };
                                house.AddCargoContainerGoods(inGood);
                                house.AddInContainerGoods(inGood);
                            }
                            log.Memo += ",产品ID：" + good.ProductID.ToString() + "，货位代码：" + good.ContainerCode.Trim() + "，件数：" + good.Piece.ToString() + "，销售价：" + good.ActSalePrice.ToString() + "，出库单号：" + good.OutCargoID;
                            if (it.TrafficType == "2")
                            {
                                CargoOrderGoodsEntity OesOrderGoods = man.QueryOesPreOrderInfo(new CargoOrderGoodsEntity { OrderNo = good.OrderNo, Specs = good.Specs, Figure = good.Figure, Model = good.Model, GoodsCode = good.GoodsCode, Batch = good.Batch, TypeID = good.TypeID, Born = good.Born, LoadIndex = good.LoadIndex, SpeedLevel = good.SpeedLevel });
                                if (OesOrderGoods.PurchaserID != 11 && OesOrderGoods.PurchaserID != 12)
                                {
                                    product.DelCargoProduct(good.ProductID.ToString());
                                }
                            }
                        }
                        //修改订货单优惠额度
                        if (it.ThrowGood == "21")
                        {
                            if (it.CreateDate.Year == DateTime.Now.Year && it.CreateDate.Month == DateTime.Now.Month)
                            {
                                if (UserRulePiece == 0)
                                {
                                    man.UpdateClientDiscountPiece(new CargoClientEntity { ClientNum = it.PayClientNum, LimitMoney = Math.Round(Convert.ToDecimal(goodsPiece) * 10 / 85 * -1, 3) });
                                }
                                else
                                {
                                    man.UpdateClientDiscountPiece(new CargoClientEntity { ClientNum = it.PayClientNum, LimitMoney = (Math.Round(Convert.ToDecimal(goodsPiece - UserRulePiece) * 10 / 85, 3) - UserRulePiece) * -1 });
                                }
                            }
                            //修改返利额度
                            if (it.InsuranceFee != 0)
                            {
                                CargoClientManager man = new CargoClientManager();
                                man.UpdateCargoClientRebateMoney(new CargoClientEntity { ClientNum = it.PayClientNum, RebateMoney = it.InsuranceFee });
                            }
                        }
                        //修改优惠券为未使用 20241005 修改代码，优惠券一经使用，则不能修改
                        //修改优惠券为未使用 20250510 修改代码，优惠卷已下单，未支付，可以修改
                        if (!string.IsNullOrEmpty(it.CheckStatus) && it.CheckStatus.Equals("0") && !string.IsNullOrEmpty(it.WXOrderNo))
                        {

                            weixin.SetCouponNoUsed(new WXCouponEntity { OrderID = it.OrderID, UseStatus = "0" });
                        }
                        //减少清单列表数据
                        man.UpdateExterOrderAlloGTMC(new CargoExterOrderAlloEntity { AlloPiece = 1, OrderNo = it.OrderNo, OPName = log.UserID, OPLoginName = log.UserID });

                        //撤销批量开单的生成订单状态
                        man.UpdateGtmcOrderStatus(new CargoGtmcProOrderEntity { OrderNo = it.OrderNo });

                        //删除采购单数据
                        if (it.TrafficType == "2")
                        {
                            HlyPurchaserOrderList.Add(it.OrderNo);
                            //删除订单数据
                            man.DeletePreOrderInfo(it);
                            //删除订单与产品关联数据
                            man.DeletePreOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = it.OrderNo });
                        }
                        //如果是马牌同步订单，同时修改马牌订单状态
                        if (!string.IsNullOrEmpty(it.OpenOrderNo) && it.OpenOrderSource.Equals("0"))
                        {
                            house.UpdateContiOrderCreateData(new saleOpenInfoResp { orderCode = it.OpenOrderNo, InCreateStatus = "0", ClientNum = 0, CreateAwb = "", CreateAwbID = "", CreateDate = DateTime.Now, CargoOrderNo = "" });
                        }
                        lw.WriteLog(log);
                    }
                    scope.Complete();
                }
                foreach (string item in HlyPurchaserOrderList)
                {
                    man.DeleteHlyPurchaserOrder(item);
                }
            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "删除订单失败，失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }
        }
        public void DeleteReserveOrderInfo(List<CargoOrderEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoHouseManager house = new CargoHouseManager();
            CargoProductManager product = new CargoProductManager();
            CargoWeiXinManager weixin = new CargoWeiXinManager();
            QiyeManager qiye = new QiyeManager();
            ArrayList HlyPurchaserOrderList = new ArrayList();
            try
            {
                using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                {
                    foreach (var it in entity)
                    {
                        //删除订单数据
                        man.DeleteReserveOrderInfo(it);
                        //删除订单与产品关联数据
                        man.DeleteReserveOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = it.OrderNo });
                        //有微信订单，删除
                        if (!string.IsNullOrEmpty(it.WXOrderNo))
                        {
                            //删除订单与支付信息数据
                            man.DeleteReserveOrderPaymentRecordInfo(new CargoReserveOrderPaymentRecordEntity { OrderNo = it.OrderNo, WxOrderNo = it.WXOrderNo });
                            WXOrderEntity wxOrder = weixin.QueryWeixinOrderByOrderNo(new WXOrderEntity { OrderNo = it.WXOrderNo });
                            if (wxOrder != null && !wxOrder.ID.Equals(0))
                            {
                                //List<CargoProductShelvesEntity> shelves = weixin.QueryWeixinOrderProductInfo(wxOrder.ID);
                                //if (wxOrder.PayWay.Equals("2"))
                                //{
                                //    foreach (var sh in shelves)
                                //    {
                                //        CargoProductShelvesEntity pshel = weixin.QueryProductShelvesByID(sh.ID);
                                //        //积分兑换，要退回客户积分
                                //        weixin.AddWeixinPoint(new WXUserPointEntity
                                //        {
                                //            WXID = wxOrder.WXID,
                                //            Point = pshel.Consume,
                                //            PointType = "7",
                                //            CutPoint = "0",
                                //            WXOrderNo = wxOrder.OrderNo
                                //        });
                                //        //3.加回客户积分
                                //        weixin.UpdateWxUserConsume(new WXUserEntity { ConsumerPoint = pshel.Consume, ID = wxOrder.WXID });
                                //    }
                                //}
                                weixin.DeleteWeixinOrder(new WXOrderEntity { ID = wxOrder.ID, isReserve = true });
                            }
                            //weixin.DelCoupon(it.WXOrderNo);
                        }

                        lw.WriteLog(log);
                    }
                    scope.Complete();
                }
            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "删除订单失败，失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }
        }
        /// <summary>
        /// 生成随机的四位数字 返回字符类型，不够四位前面补0
        /// </summary>
        /// <returns></returns>
        public string GetRandomFourNumString()
        {
            string result = string.Empty;
            Random rd = new Random((int)DateTime.Now.Ticks);
            int sd = rd.Next(1, 9999);
            switch (sd.ToString().Length)
            {
                case 1:
                    result += "000" + sd.ToString();
                    break;
                case 2:
                    result += "00" + sd.ToString();
                    break;
                case 3:
                    result += "0" + sd.ToString();
                    break;
                default:
                    result = sd.ToString();
                    break;
            }
            return result;
        }
        /// <summary>
        /// 查询当前日期当前仓库表中最大顺序号
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public int GetMaxOrderNumByCurrentDate(CargoOrderEntity entity)
        {
            return man.GetMaxOrderNumByCurrentDate(entity);
        }
        /// <summary>
        /// 查询当前日期当前仓库表中最大顺序号
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public int GetMaxReserveOrderNumByCurrentDate(CargoOrderEntity entity)
        {
            return man.GetMaxReserveOrderNumByCurrentDate(entity);
        }
        public int GetMaxPickNumByCurrentDate(CargoOrderEntity entity)
        {
            return man.GetMaxPickNumByCurrentDate(entity);
        }
        /// <summary>
        /// 修改物流快递单号
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateLogisAwbNo(CargoOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateLogisAwbNo(entity);
                    log.Memo = "订单号：" + entity.OrderNo + "，物流单号：" + entity.LogisAwbNo + ",物流公司：" + entity.LogisID.ToString() + ",物流费用:" + entity.DeliveryFee.ToString() + ",到达站:" + entity.Dest + ",业务员:" + entity.SaleManName + ",物流结算:" + entity.DeliverySettlement;
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改快递单号失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 通过订单号修改物流 单号
        /// </summary>
        /// <param name="orderNo"></param>
        /// <param name="logisNo"></param>
        public void UpdateLogisAwbNo(string orderNo, string logisNo, string OrderAging, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateLogisAwbNo(orderNo, logisNo, OrderAging);
                    log.Memo = "订单号：" + orderNo + "，物流单号：" + logisNo + "，物流时效：" + OrderAging;
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改快递单号失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }

        public void UpdateMoveOrderLogis(CargoMoveOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateMoveOrderLogis(entity);
                    log.Memo = "移库单号：" + entity.MoveNo + "，运单号：" + entity.LogisAwbNo;
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改移库信息失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }

        }
        /// <summary>
        /// 修改副单号
        /// </summary>
        /// <param name="orderNo"></param>
        /// <param name="HAwbNo"></param>
        public void UpdateHAwbNo(string orderNo, string HAwbNo, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateHAwbNo(orderNo, HAwbNo);
                    log.Memo = "订单号：" + orderNo + "，副单号：" + HAwbNo;
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改副单号失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 通过订单号修改微信支付生成的单 号
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateOrderWxNoByOrderNo(CargoOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateOrderWxNoByOrderNo(entity);
                    log.Memo = "订单号：" + entity.OrderNo + "，微信支付单号：" + entity.WXOrderNo;
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 查询用户订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderEntity> queryWxUserOrderInfo(CargoOrderEntity entity)
        {
            return man.queryWxUserOrderInfo(entity);
        }
        /// <summary>
        /// 查询订单的跟踪状态信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderStatusEntity> QueryOrderStatus(CargoOrderStatusEntity entity)
        {
            return man.QueryOrderStatus(entity);
        }
        /// <summary>
        /// 保存订单跟踪状态
        /// </summary>
        /// <param name="entity"></param>
        public void SaveOrderStatus(CargoOrderStatusEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderStatusEntity> lw = new LogWrite<CargoOrderStatusEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.SaveOrderStatus(entity);
                    log.Memo = "订单号：" + entity.OrderNo.ToString() + "，订单状态：" + entity.OrderStatus + "，备注：" + entity.DetailInfo + "，操作人：" + entity.OP_ID + "  " + entity.OP_Name + "，签收照片：" + entity.SignImage;
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增状态失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }

        public void SaveOrderDeliveryInfo(CargoOrderStatusEntity entity)
        {
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                man.SaveOrderDeliveryInfo(new CargoOrderEntity
                {
                    OrderID = entity.OrderID,
                    DeliveryDriverName = entity.DeliveryDriverName,
                    DriverIDNum = entity.DriverIDNum,
                    DriverCarNum = entity.DriverCarNum,
                    DriverCellphone = entity.DriverCellphone,
                });
                man.InsertCargoOrderStatus(entity);
                scope.Complete();
            }
        }

        public void UpdateOrderPiece(List<CargoContainerShowEntity> entityList, decimal LimitMoney, LogEntity log)
        {
            LogWrite<CargoContainerShowEntity> lw = new LogWrite<CargoContainerShowEntity>();
            CargoHouseManager house = new CargoHouseManager();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    foreach (var entity in entityList)
                    {
                        List<CargoOrderGoodsEntity> goodsList = man.QueryOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = entity.OrderNo });
                        //1.拉下订单
                        if (entity.Piece < 0)
                        {
                            int piece = entity.Piece;
                            foreach (var goods in goodsList.Where(x => x.Specs == entity.Specs && x.Figure == entity.Figure && x.SpeedLevel == entity.SpeedLevel && x.LoadIndex == entity.LoadIndex && x.ActSalePrice == entity.ActSalePrice && x.GoodsCode == entity.GoodsCode))
                            {
                                if (piece >= 0) { break; }
                                if (goods.Piece + piece <= 0)
                                {
                                    //修改订单与产品关联表
                                    man.UpdateOrderGoodPieceByID(new CargoContainerShowEntity { OrderNo = goods.OrderNo, OutCargoID = goods.OutCargoID, ContainerCode = goods.ContainerCode, ProductID = goods.ProductID, Piece = goods.Piece, IsAdd = false });
                                    //删除出库单表
                                    house.DeleteOutCargoData(goods.OutCargoID, goods.ContainerID, goods.ProductID, goods.Piece);
                                    //根据货位ID和产品ID判断是否存在此货位
                                    CargoContainerGoodsEntity cgood = house.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ContainerID = goods.ContainerID, ProductID = goods.ProductID });
                                    if (cgood != null && !cgood.ID.Equals(0))//说明数据库中还存在此货位数据
                                    {
                                        //修改在库货位件数  增加
                                        house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { ContainerID = goods.ContainerID, Piece = goods.Piece, ProductID = goods.ProductID, IsAdd = true });
                                    }
                                    else
                                    {
                                        //说明是全部出库 需要重新入库
                                        CargoContainerGoodsEntity inGood = new CargoContainerGoodsEntity
                                        {
                                            ContainerID = goods.ContainerID,
                                            ProductID = goods.ProductID,
                                            Piece = goods.Piece,
                                            InHouseTime = DateTime.Now,
                                            IsPrintInCargo = false,
                                            Weight = 0,
                                            TypeID = goods.TypeID,
                                            InHouseType = "3",//拉下订单入库
                                            InCargoID = DateTime.Now.ToString("yyMMdd") + GetRandomFourNumString()//入库单号 
                                        };
                                        house.AddCargoContainerGoods(inGood);
                                        house.AddInContainerGoods(inGood);
                                    }
                                    //修改总货位件数  增加
                                    house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = goods.ContainerID, IsAdd = true, InPiece = goods.Piece });
                                }
                                else
                                {
                                    //修改订单与产品关联表
                                    man.UpdateOrderGoodPieceByID(new CargoContainerShowEntity { OrderNo = goods.OrderNo, OutCargoID = goods.OutCargoID, ContainerCode = goods.ContainerCode, ProductID = goods.ProductID, Piece = piece, IsAdd = true });
                                    //删除出库单表
                                    house.UpdateOutCargoPieceByID(new CargoContainerShowEntity { ContainerID = goods.ContainerID, OutCargoID = goods.OutCargoID, Piece = piece, IsAdd = true, ProductID = goods.ProductID });
                                    //根据货位ID和产品ID判断是否存在此货位
                                    CargoContainerGoodsEntity cgood = house.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ContainerID = goods.ContainerID, ProductID = goods.ProductID });
                                    if (cgood != null && !cgood.ID.Equals(0))//说明数据库中还存在此货位数据
                                    {
                                        //修改在库货位件数  增加
                                        house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { ContainerID = goods.ContainerID, Piece = System.Math.Abs(piece), ProductID = goods.ProductID, IsAdd = true });
                                    }
                                    else
                                    {
                                        //说明是全部出库 需要重新入库
                                        CargoContainerGoodsEntity inGood = new CargoContainerGoodsEntity
                                        {
                                            ContainerID = goods.ContainerID,
                                            ProductID = goods.ProductID,
                                            Piece = System.Math.Abs(piece),
                                            InHouseTime = DateTime.Now,
                                            IsPrintInCargo = false,
                                            Weight = 0,
                                            TypeID = goods.TypeID,
                                            InHouseType = "3",//拉下订单入库
                                            InCargoID = DateTime.Now.ToString("yyMMdd") + GetRandomFourNumString()//入库单号 
                                        };
                                        house.AddCargoContainerGoods(inGood);
                                        house.AddInContainerGoods(inGood);
                                    }
                                    //修改总货位件数  增加
                                    house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = goods.ContainerID, IsAdd = true, InPiece = System.Math.Abs(piece) });
                                }


                                log.Memo = "修改数量：订单号：" + goods.OrderNo.ToString() + "，产品ID：" + goods.ProductID.ToString() + "，产品规格：" + goods.Specs + "，货位号：" + goods.ContainerCode + "，原数量：" + goods.Piece.ToString() + "，拉下数量：" + goods.Piece + "，操作人：" + log.UserID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                                piece = piece + goods.Piece;
                            }
                            //5. 修改订单数量和金额
                            if (!string.IsNullOrEmpty(entity.ThrowGood) && entity.ThrowGood.Equals("24"))
                            {
                                man.DrawUpOrderPieceCharge(new CargoOrderEntity { Piece = entity.Piece, TransportFee = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), TotalCharge = Convert.ToDecimal(entity.Piece * entity.ActSalePrice) + entity.TransitFee, TransitFee = entity.TransitFee, OrderNo = entity.OrderNo });
                            }
                            else
                            {
                                man.DrawUpOrderPieceCharge(new CargoOrderEntity { Piece = entity.Piece, TransportFee = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), TotalCharge = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), OrderNo = entity.OrderNo });
                            }
                        }
                        else if (entity.Piece > 0)
                        {
                            if (goodsList.Where(x => x.ProductID == entity.ProductID).Count() > 0)
                            {
                                //修改订单与产品关联表  增加
                                man.UpdateOrderGoodPieceByID(new CargoContainerShowEntity { OrderNo = entity.OrderNo, OutCargoID = entity.OutCargoID, ContainerCode = entity.ContainerCode, ProductID = entity.ProductID, Piece = entity.Piece, IsAdd = true });
                                //修改出库表数量  增加
                                house.UpdateOutCargoPieceByID(new CargoContainerShowEntity { ContainerID = entity.ContainerID, OutCargoID = entity.OutCargoID, Piece = entity.Piece, IsAdd = true, ProductID = entity.ProductID });
                                //修改在库货位件数  减去
                                house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { ContainerID = entity.ContainerID, Piece = entity.Piece, ProductID = entity.ProductID, IsAdd = false });
                                //修改总货位件数  减去
                                house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = entity.ContainerID, IsAdd = false, InPiece = entity.Piece });
                                //5. 修改订单数量和金额
                                if (!string.IsNullOrEmpty(entity.ThrowGood) && entity.ThrowGood.Equals("24"))
                                {
                                    man.DrawUpOrderPieceCharge(new CargoOrderEntity { Piece = entity.Piece, TransportFee = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), TotalCharge = Convert.ToDecimal(entity.Piece * entity.ActSalePrice) + entity.TransitFee, TransitFee = entity.TransitFee, OrderNo = entity.OrderNo });
                                }
                                else
                                {
                                    man.DrawUpOrderPieceCharge(new CargoOrderEntity { Piece = entity.Piece, TransportFee = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), TotalCharge = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), OrderNo = entity.OrderNo });
                                }
                                log.Memo = "修改数量：订单号：" + entity.OrderNo.ToString() + "，产品ID：" + entity.ProductID.ToString() + "，产品规格：" + entity.Specs + "，货位号：" + entity.ContainerCode + "，原数量：" + entity.OldPiece + "，新数量：" + (entity.OldPiece + entity.Piece).ToString() + "，拉上数量：" + entity.Piece.ToString() + "，操作人：" + log.UserID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                            }
                            else
                            {
                                //1. 新增订单关联表数据
                                List<CargoOrderGoodsEntity> goods = new List<CargoOrderGoodsEntity>();
                                goods.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = entity.OrderNo,
                                    ProductID = entity.ProductID,
                                    HouseID = entity.HouseID,
                                    AreaID = entity.AreaID,
                                    ContainerCode = entity.ContainerCode,
                                    Piece = entity.Piece,
                                    ActSalePrice = entity.ActSalePrice,
                                    RuleType = entity.RuleType,
                                    RuleID = entity.RuleID,
                                    RuleTitle = entity.RuleTitle,
                                    SuitClientNum = entity.SuitClientNum,
                                    OP_ID = log.UserID,
                                    OutCargoID = entity.OutCargoID
                                });
                                man.AddOrderGoodsInfo(goods);
                                //2. 新增出库表数据
                                List<CargoContainerShowEntity> outO = new List<CargoContainerShowEntity>();
                                entity.OutHouseTime = DateTime.Now;
                                outO.Add(entity);

                                house.saveOutCargoData(outO);
                                //3. 修改在库货位件数  减去
                                house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { ContainerID = entity.ContainerID, Piece = entity.Piece, ProductID = entity.ProductID, IsAdd = false });
                                //4. 修改总货位件数  减去
                                house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = entity.ContainerID, IsAdd = false, InPiece = entity.Piece });
                                //5. 修改订单数量和金额
                                man.DrawUpOrderPieceCharge(new CargoOrderEntity { Piece = entity.Piece, TransportFee = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), TotalCharge = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), OrderNo = entity.OrderNo });

                                log.Memo = "修改数量：订单号：" + entity.OrderNo.ToString() + "，产品ID：" + entity.ProductID.ToString() + "，产品规格：" + entity.Specs + "，货位号：" + entity.ContainerCode + "，拉上数量：" + entity.Piece.ToString() + "，操作人：" + log.UserID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                            }
                        }
                    }
                    man.UpdateClientDiscountPiece(new CargoClientEntity { ClientNum = entityList[0].PayClientNum, LimitMoney = LimitMoney });
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改订单数量失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 修改订单产品数量
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void UpdateOrderPiece(CargoContainerShowEntity entity, LogEntity log)
        {
            LogWrite<CargoContainerShowEntity> lw = new LogWrite<CargoContainerShowEntity>();
            CargoHouseManager house = new CargoHouseManager();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    //1.判断出库件数是否为0，如果为0则表示拉下订单
                    if (entity.Piece.Equals(0))
                    {
                        //删除订单与产品关联表
                        man.DeleteOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = entity.OrderNo, ProductID = entity.ProductID, ContainerCode = entity.ContainerCode, OutCargoID = entity.OutCargoID, Piece = entity.OldPiece });
                        //删除出库单表
                        house.DeleteOutCargoData(entity.OutCargoID, entity.ContainerID, entity.ProductID, entity.OldPiece);

                        //根据货位ID和产品ID判断是否存在此货位
                        CargoContainerGoodsEntity cgood = house.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ContainerID = entity.ContainerID, ProductID = entity.ProductID });
                        if (cgood != null && !cgood.ID.Equals(0))//说明数据库中还存在此货位数据
                        {
                            //修改在库货位件数  增加
                            house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { ContainerID = entity.ContainerID, Piece = entity.OldPiece, ProductID = entity.ProductID, IsAdd = true });
                        }
                        else
                        {
                            //说明是全部出库 需要重新入库
                            //CargoProductEntity proEnt = product.QueryProductInfoByID(good.ProductID);
                            CargoContainerGoodsEntity inGood = new CargoContainerGoodsEntity
                            {
                                ContainerID = entity.ContainerID,
                                ProductID = entity.ProductID,
                                Piece = entity.OldPiece,
                                InHouseTime = DateTime.Now,
                                IsPrintInCargo = false,
                                Weight = 0,
                                TypeID = entity.TypeID,
                                InHouseType = "3",//拉下订单入库
                                InCargoID = DateTime.Now.ToString("yyMMdd") + GetRandomFourNumString()//入库单号 
                            };
                            house.AddCargoContainerGoods(inGood);
                            house.AddInContainerGoods(inGood);
                        }
                        //修改总货位件数  增加
                        house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = entity.ContainerID, IsAdd = true, InPiece = entity.OldPiece });
                        log.Memo = "全部下订单：订单号：" + entity.OrderNo.ToString() + "，产品ID：" + entity.ProductID.ToString() + "，产品规格：" + entity.Specs + "，货位号：" + entity.ContainerCode + "，原数量：" + entity.OldPiece.ToString() + "，拉下数量：" + entity.OldPiece.ToString() + "，操作人：" + log.UserID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    }
                    //2.新数量比旧数量多，拉上的
                    if (entity.Piece > entity.OldPiece)
                    {
                        int diffPiece = entity.Piece - entity.OldPiece;
                        //修改订单与产品关联表  增加
                        man.UpdateOrderGoodPieceByID(new CargoContainerShowEntity { OrderNo = entity.OrderNo, OutCargoID = entity.OutCargoID, ContainerCode = entity.ContainerCode, ProductID = entity.ProductID, Piece = diffPiece, IsAdd = true });
                        //修改出库表数量  增加
                        house.UpdateOutCargoPieceByID(new CargoContainerShowEntity { ContainerID = entity.ContainerID, OutCargoID = entity.OutCargoID, Piece = diffPiece, IsAdd = true, ProductID = entity.ProductID });
                        //修改在库货位件数  减去
                        house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { ContainerID = entity.ContainerID, Piece = diffPiece, ProductID = entity.ProductID, IsAdd = false });
                        //修改总货位件数  减去
                        house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = entity.ContainerID, IsAdd = false, InPiece = diffPiece });
                        log.Memo = "拉上订单：订单号：" + entity.OrderNo.ToString() + "，产品ID：" + entity.ProductID.ToString() + "，产品规格：" + entity.Specs + "，货位号：" + entity.ContainerCode + "，原数量：" + entity.OldPiece + "，新数量：" + entity.Piece + "，拉上数量：" + diffPiece.ToString() + "，操作人：" + log.UserID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    }

                    //3.新数量比旧数量少，拉下的
                    if (entity.Piece < entity.OldPiece && !entity.Piece.Equals(0))
                    {
                        int diffPiece = entity.OldPiece - entity.Piece;
                        //修改订单与产品关联表  减去
                        man.UpdateOrderGoodPieceByID(new CargoContainerShowEntity { OrderNo = entity.OrderNo, OutCargoID = entity.OutCargoID, ContainerCode = entity.ContainerCode, ProductID = entity.ProductID, Piece = diffPiece, IsAdd = false });
                        //修改出库表数量  减去
                        house.UpdateOutCargoPieceByID(new CargoContainerShowEntity { ContainerID = entity.ContainerID, OutCargoID = entity.OutCargoID, Piece = diffPiece, IsAdd = false, ProductID = entity.ProductID });

                        //根据货位ID和产品ID判断是否存在此货位
                        CargoContainerGoodsEntity cgood = house.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ContainerID = entity.ContainerID, ProductID = entity.ProductID });
                        if (cgood != null && !cgood.ID.Equals(0))//说明数据库中还存在此货位数据
                        {
                            //修改在库货位件数  增加
                            house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { ContainerID = entity.ContainerID, Piece = diffPiece, ProductID = entity.ProductID, IsAdd = true });
                        }
                        else
                        {
                            //说明是全部出库 需要重新入库
                            //CargoProductEntity proEnt = product.QueryProductInfoByID(good.ProductID);
                            CargoContainerGoodsEntity inGood = new CargoContainerGoodsEntity
                            {
                                ContainerID = entity.ContainerID,
                                ProductID = entity.ProductID,
                                Piece = diffPiece,
                                InHouseTime = DateTime.Now,
                                IsPrintInCargo = false,
                                Weight = 0,
                                TypeID = entity.TypeID,
                                InHouseType = "3",//拉下订单入库
                                InCargoID = DateTime.Now.ToString("yyMMdd") + GetRandomFourNumString()//入库单号 
                            };
                            house.AddCargoContainerGoods(inGood);
                            house.AddInContainerGoods(inGood);
                        }
                        //修改总货位件数  增加
                        house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = entity.ContainerID, IsAdd = true, InPiece = diffPiece });
                        log.Memo = "拉下订单：订单号：" + entity.OrderNo.ToString() + "，产品ID：" + entity.ProductID.ToString() + "，产品规格：" + entity.Specs + "，货位号：" + entity.ContainerCode + "，原数量：" + entity.OldPiece + "，新数量：" + entity.Piece + "，拉下数量：" + diffPiece.ToString() + "，操作人：" + log.UserID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    }
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改订单数量失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        public void DrawUpOrder(List<CargoContainerShowEntity> entityList, LogEntity log, decimal LimitMoney = 0)
        {
            LogWrite<CargoContainerShowEntity> lw = new LogWrite<CargoContainerShowEntity>();
            CargoHouseManager house = new CargoHouseManager();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    foreach (var entity in entityList)
                    {
                        CargoOrderEntity order = man.QueryOrderInfo(new CargoOrderEntity { OrderNo = entity.OrderNo });
                        //1. 新增订单关联表数据
                        List<CargoOrderGoodsEntity> goods = new List<CargoOrderGoodsEntity>();
                        goods.Add(new CargoOrderGoodsEntity
                        {
                            OrderNo = entity.OrderNo,
                            ProductID = entity.ProductID,
                            HouseID = entity.HouseID,
                            AreaID = entity.AreaID,
                            ContainerCode = entity.ContainerCode,
                            Piece = entity.Piece,
                            ActSalePrice = entity.ActSalePrice,
                            RuleType = entity.RuleType,
                            RuleID = entity.RuleID,
                            RuleTitle = entity.RuleTitle,
                            SuitClientNum = entity.SuitClientNum,
                            OP_ID = log.UserID,
                            OutCargoID = entity.OutCargoID
                        });
                        man.AddOrderGoodsInfo(goods);
                        //2. 新增出库表数据
                        List<CargoContainerShowEntity> outO = new List<CargoContainerShowEntity>();
                        entity.OutHouseTime = DateTime.Now;
                        outO.Add(entity);
                        house.saveOutCargoData(outO);
                        //3. 修改在库货位件数  减去
                        house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { ContainerID = entity.ContainerID, Piece = entity.Piece, ProductID = entity.ProductID, IsAdd = false });
                        //4. 修改总货位件数  减去
                        house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = entity.ContainerID, IsAdd = false, InPiece = entity.Piece });
                        //5. 修改订单数量和金额
                        man.DrawUpOrderPieceCharge(new CargoOrderEntity { Piece = entity.Piece, TransportFee = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), TotalCharge = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), OrderNo = entity.OrderNo });

                        log.Memo = "拉上订单：订单号：" + entity.OrderNo.ToString() + "，产品ID：" + entity.ProductID.ToString() + "，产品规格：" + entity.Specs + "，货位号：" + entity.ContainerCode + "，原数量：" + order.Piece.ToString() + "，新数量：" + (order.Piece + entity.Piece).ToString() + "，拉上数量：" + entity.Piece.ToString() + "，操作人：" + log.UserID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    }
                    if (!LimitMoney.Equals(0))
                    {
                        man.UpdateClientDiscountPiece(new CargoClientEntity { ClientNum = entityList[0].PayClientNum, LimitMoney = LimitMoney });
                    }
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "拉上订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                }
            }
        }
        /// <summary>
        /// 拉上订单
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void DrawUpOrder(CargoContainerShowEntity entity, LogEntity log, decimal LimitMoney = 0)
        {
            LogWrite<CargoContainerShowEntity> lw = new LogWrite<CargoContainerShowEntity>();
            CargoHouseManager house = new CargoHouseManager();
            CargoOrderEntity order = man.QueryOrderInfo(new CargoOrderEntity { OrderNo = entity.OrderNo });
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    //1. 新增订单关联表数据
                    List<CargoOrderGoodsEntity> goods = new List<CargoOrderGoodsEntity>();
                    goods.Add(new CargoOrderGoodsEntity
                    {
                        OrderNo = entity.OrderNo,
                        ProductID = entity.ProductID,
                        HouseID = entity.HouseID,
                        AreaID = entity.AreaID,
                        ContainerCode = entity.ContainerCode,
                        Piece = entity.Piece,
                        ActSalePrice = entity.ActSalePrice,
                        RuleType = entity.RuleType,
                        RuleID = entity.RuleID,
                        RuleTitle = entity.RuleTitle,
                        SuitClientNum = entity.SuitClientNum,
                        OP_ID = log.UserID,
                        OutCargoID = entity.OutCargoID
                    });
                    man.AddOrderGoodsInfo(goods);
                    //2. 新增出库表数据
                    List<CargoContainerShowEntity> outO = new List<CargoContainerShowEntity>();
                    entity.OutHouseTime = DateTime.Now;
                    outO.Add(entity);
                    house.saveOutCargoData(outO);
                    //3. 修改在库货位件数  减去
                    house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { ContainerID = entity.ContainerID, Piece = entity.Piece, ProductID = entity.ProductID, IsAdd = false });
                    //4. 修改总货位件数  减去
                    house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = entity.ContainerID, IsAdd = false, InPiece = entity.Piece });
                    //5. 修改订单数量和金额
                    man.DrawUpOrderPieceCharge(new CargoOrderEntity { Piece = entity.Piece, TransportFee = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), TotalCharge = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), OrderNo = entity.OrderNo });

                    log.Memo = "拉上订单：订单号：" + entity.OrderNo.ToString() + "，产品ID：" + entity.ProductID.ToString() + "，产品规格：" + entity.Specs + "，货位号：" + entity.ContainerCode + "，原数量：" + order.Piece.ToString() + "，新数量：" + (order.Piece + entity.Piece).ToString() + "，拉上数量：" + entity.Piece.ToString() + "，操作人：" + log.UserID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    if (!LimitMoney.Equals(0))
                    {
                        man.UpdateClientDiscountPiece(new CargoClientEntity { ClientNum = order.PayClientNum, LimitMoney = LimitMoney });
                    }
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "拉上订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                }
            }
        }
        /// <summary>
        /// 修改订单中产品价格
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateOrderSalePrice(CargoContainerShowEntity entity, LogEntity log)
        {
            LogWrite<CargoContainerShowEntity> lw = new LogWrite<CargoContainerShowEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateOrderSalePrice(entity);
                    if (entity.ThrowGood.Equals("24"))
                    {
                        man.DrawUpOrderPieceCharge(new CargoOrderEntity { TransportFee = Convert.ToDecimal(entity.Piece * (entity.ActSalePrice - entity.SalePrice)), TotalCharge = Convert.ToDecimal(entity.Piece * (entity.ActSalePrice - entity.SalePrice)), OrderNo = entity.OrderNo });
                    }
                    log.Memo = "修改订单价格：订单号：" + entity.OrderNo.ToString() + "，产品ID：" + entity.ProductID.ToString() + "，产品规格：" + entity.Specs + "，货位号：" + entity.ContainerCode + "，原价格：" + entity.SalePrice.ToString() + "，新价格：" + entity.ActSalePrice.ToString() + "，操作人：" + log.UserID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改订单价格失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 根据订单号查询订单与产品关联表数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderGoodsEntity> QueryOrderGoodsInfo(CargoOrderGoodsEntity entity)
        {
            return man.QueryOrderGoodsInfo(entity);
        }
        /// <summary>
        /// 判断 是否为退货单
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsModelOrderInfo(string orderNo)
        {
            return man.IsModelOrderInfo(orderNo);
        }
        /// <summary>
        /// 查询订单数据用以批量打印
        /// </summary>
        /// <param name="orderno"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryOrderDataForMassPrint(string orderno)
        {
            return man.QueryOrderDataForMassPrint(orderno);
        }
        /// <summary>
        /// 查询近10天内的梅州 仓库 的未签收的订单
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderEntity> QueryCargoOrderTen(CargoOrderEntity entity)
        {
            return man.QueryCargoOrderTen(entity);
        }
        /// <summary>
        /// 查询 没有签收 图片的数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderStatusEntity> QueryOrderStatusNoPic(CargoOrderStatusEntity entity)
        {
            return man.QueryOrderStatusNoPic(entity);
        }
        public bool IsExistCargoOrderCheckStatus(CargoOrderStatusEntity entity)
        {
            return man.IsExistCargoOrderCheckStatus(entity);
        }

        /// <summary>
        /// 修改订单跟踪状态的签收照片
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateOrderStatusPic(CargoOrderStatusEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderStatusEntity> lw = new LogWrite<CargoOrderStatusEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateOrderStatusPic(entity);
                    log.Memo = "订单号：" + entity.OrderNo.ToString() + "，ID：" + entity.ID.ToString() + "，签收照片：" + entity.SignImage;
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 通过微信订单号查询订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoOrderEntity QueryCargoInfoByWxOrderNo(CargoOrderEntity entity)
        {
            return man.QueryCargoInfoByWxOrderNo(entity);
        }
        /// <summary>
        /// 判断 是否存在产品订单，如果存在则不允许删除
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsExistOrderInfo(CargoOrderGoodsEntity entity)
        {
            return man.IsExistOrderInfo(entity);
        }
        /// <summary>
        /// 批量查询订单数据 导出
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryOrderDataForMassExport(CargoOrderEntity entity)
        {
            return man.QueryOrderDataForMassExport(entity);
        }
        public List<CargoOrderGoodsEntity> QueryOrderPicekPieceExport(CargoOrderEntity entity)
        {
            return man.QueryOrderPicekPieceExport(entity);
        }
        /// <summary>
        /// 修改
        /// </summary>
        /// <param name="orderNo"></param>
        public void DelHlyOutOrderData(string orderNo)
        {
            man.DelHlyOutOrderData(orderNo);
        }
        /// <summary>
        /// 新增订单推送数据记录表
        /// </summary>
        /// <param name="entity"></param>
        public void InsertCargoOrderPush(CargoOrderPushEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderPushEntity> lw = new LogWrite<CargoOrderPushEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.InsertCargoOrderPush(entity);
                    log.Memo = "新增订单推送：订单号：" + entity.OrderNo.ToString() + ",出发站:" + entity.Dep + ",到达站：" + entity.Dest + ",总件数：" + entity.Piece + ",客户姓名：" + entity.AcceptPeople + ",所在仓库：" + entity.HouseName + "，推送类型：" + entity.PushType + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增订单推送，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 插入数据
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoOrderPush(CargoOrderPushEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderPushEntity> lw = new LogWrite<CargoOrderPushEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateCargoOrderPush(entity);
                    log.Memo = "新增订单推送：订单号：" + entity.OrderNo.ToString() + ",出发站:" + entity.Dep + ",到达站：" + entity.Dest + ",总件数：" + entity.Piece + ",客户姓名：" + entity.AcceptPeople + ",所在仓库：" + entity.HouseName + "，推送类型：" + entity.PushType + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增订单推送，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 修改订单号
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoOrderPushAwbNo(CargoOrderPushEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderPushEntity> lw = new LogWrite<CargoOrderPushEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateCargoOrderPushAwbNo(entity);
                    log.Memo = "修改运单号：订单号：" + entity.OrderNo.ToString() + ",运单号:" + entity.AwbNo + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改运单号，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 查询所有未推送数据 
        /// </summary>
        /// <returns></returns>
        public List<CargoOrderPushEntity> QueryCargoOrderPushInfoList(CargoOrderPushEntity entity)
        {
            return man.QueryCargoOrderPushInfoList(entity);
        }
        /// <summary>
        /// 查询订单出库标签码列表
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryTagByOrderNo(CargoOrderEntity entity)
        {
            return man.QueryTagByOrderNo(entity);
        }
        public List<CargoContainerShowEntity> QueryTyreCodeByOrderNo(List<string> OrderNo)
        {
            return man.QueryTyreCodeByOrderNo(OrderNo);
        }
        /// <summary>
        /// 撤回出库标签
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void RebackOutTag(List<CargoContainerShowEntity> entity, LogEntity log)
        {
            LogWrite<CargoContainerShowEntity> lw = new LogWrite<CargoContainerShowEntity>();
            CargoProductManager proMan = new CargoProductManager();
            CargoHouseManager houseMan = new CargoHouseManager();
            List<CargoProductTagEntity> tagList = new List<CargoProductTagEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    log.Memo = "撤回出库标签：订单号：" + entity[0].OrderNo + "，所在仓库：" + entity[0].HouseID.ToString() + ",出库单号:" + entity[0].OutCargoID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    foreach (var it in entity)
                    {
                        tagList.Add(new CargoProductTagEntity { OutCargoStatus = "0", TagCode = it.TagCode });
                        //1.修改订单明细数量，减少一条
                        man.UpdateOrderGoodPieceByID(new CargoContainerShowEntity { OrderNo = it.OrderNo, OutCargoID = it.OutCargoID, ContainerCode = it.ContainerCode, ProductID = it.ProductID, Piece = it.Piece, IsAdd = false });
                        //2.修改订单数量和修改订单金额，减少一条和一条对应的金额
                        man.UpdateOrderPieceCharge(new CargoOrderEntity { OrderNo = it.OrderNo, Piece = it.Piece, TransportFee = it.ActSalePrice, TotalCharge = it.ActSalePrice });
                        //3.修改标签状态，
                        //4.返回产品库存，增加一条
                        houseMan.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { IsAdd = true, Piece = it.Piece, ProductID = it.ProductID, ContainerID = it.ContainerID });
                        //5.出库记录修改和撤回
                        houseMan.UpdateOutCargoPieceByID(new CargoContainerShowEntity { IsAdd = false, Piece = it.Piece, ProductID = it.ProductID, ContainerID = it.ContainerID, OutCargoID = it.OutCargoID });
                        log.Memo += "，产品ID：" + it.ProductID.ToString() + "，标签码：" + it.TagCode + "，货位ID：" + it.ContainerID.ToString() + "，货位号：" + it.ContainerCode + "，销售价格：" + it.ActSalePrice.ToString();
                    }
                    //批量修改标签状态，设置为未出库状态
                    proMan.SetTagUnOutCargo(tagList);

                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "撤回出库标签，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 修改订单改价申请状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoOrderModifyPriceStatus(CargoOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateCargoOrderModifyPriceStatus(entity);
                    log.Memo = "订单改价申请通过：订单号：" + entity.OrderNo.ToString() + ",操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "订单改价申请通过，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 查询订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderEntity> QueryOrder(CargoOrderEntity entity)
        {
            return man.QueryOrder(entity);
        }
        /// <summary>
        /// 查询订单标签扫描出库数
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryUnScanProductTag(CargoOrderEntity entity)
        {
            return man.QueryUnScanProductTag(entity);
        }

        public CargoOrderEntity QueryUnpaidOrder(string clientNum)
        {
            return man.QueryUnpaidOrder(clientNum);
        }
        /// <summary>
        /// APP查询我的订单
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<WXOrderEntity> QueryMyOrderInfoForAPP(WXOrderEntity entity)
        {
            return man.QueryMyOrderInfoForAPP(entity);
        }

        /// <summary>
        /// 修改订单延迟发货状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateCargoOrderPostponeShipStatus(CargoOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateCargoOrderPostponeShipStatus(entity);
                    log.Memo = "订单延迟发货推送：订单号：" + entity.OrderNo.ToString() + ",操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "订单延迟发货推送，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 未签收订单
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderEntity> QueryNotSignedOrderData(CargoOrderEntity entity)
        {
            return man.QueryNotSignedOrderData(entity);
        }

        /// <summary>
        /// 查询已出库的小程序订单推送至小程序
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<WXOrderEntity> QueryMiniOrderSendWx(WXOrderEntity entity)
        {
            return man.QueryMiniOrderSendWx(entity);
        }
        /// <summary>
        /// 更新推送状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateOrderStatusWxPushStatus(CargoOrderStatusEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateOrderStatusWxPushStatus(entity);
                    log.Memo = "小程序发送状态推送：状态：" + entity.WxSendStatusPush + ",订单号：" + entity.OrderNo + ",微信订单号：" + entity.WXOrderNo;
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }

        #endregion
        #region 退货管理操作方法集合
        /// <summary>
        /// 查询订单数据用以退货管理
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderReturnOrderEntity> QueryOrderInfoForReturn(CargoOrderReturnOrderEntity entity)
        {
            return man.QueryOrderInfoForReturn(entity);
        }
        /// <summary>
        /// 保存退货单
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void AddReturnOrderInfo(CargoOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoHouseManager house = new CargoHouseManager();
            try
            {
                log.Memo = "退货单号：" + entity.OrderNo + "，出发站：" + entity.Dep + "，到达站：" + entity.Dest + "，退货件数：" + entity.Piece.ToString() + "，退货费用：" + entity.TotalCharge.ToString() + "，退货客户：" + entity.AcceptPeople + "，电话：" + entity.AcceptTelephone + "/" + entity.AcceptCellphone + "，制单人：" + entity.CreateAwb + "，制单时间：" + entity.CreateDate.ToString("yyyy-MM-dd HH:mm:ss") + "，业务员：" + entity.SaleManName;
                if (entity.HouseID.Equals(64))
                {
                    man.AddReturnOrderInfo(entity); CargoFactoryOrderManager facMan = new CargoFactoryOrderManager();
                    List<CargoFactoryOrderEntity> factoryList = new List<CargoFactoryOrderEntity>();
                    foreach (var good in entity.goodsList)
                    {
                        string batch = good.Batch;
                        int bYear = 0, bWeek = 0;
                        if (batch.Length == 4)
                        {
                            bWeek = Convert.ToInt32(batch.Substring(0, 2));
                            bYear = Convert.ToInt32(batch.Substring(2, 2));
                        }
                        else if (batch.Length == 3)
                        {
                            bWeek = Convert.ToInt32(batch.Substring(0, 1));
                            bYear = Convert.ToInt32(batch.Substring(1, 2));
                        }
                        factoryList.Add(new CargoFactoryOrderEntity
                        {
                            FacOrderNo = DateTime.Now.ToString("yyyyMMddHHmmss"),
                            OrderType = 2,
                            HouseID = entity.HouseID,
                            TypeID = good.TypeID,
                            TypeName = good.TypeName,
                            Model = good.Model,
                            Specs = good.Specs,
                            LoadIndex = good.LoadIndex,
                            SpeedLevel = good.SpeedLevel,
                            Figure = good.Figure,
                            GoodsCode = good.GoodsCode,
                            Batch = batch,
                            OrderNum = good.Piece,
                            ReplyNumber = good.Piece,
                            InCargoStatus = 0,
                            InPiece = 0,
                            UnitPrice = Convert.ToDouble(good.UnitPrice),
                            SalePrice = Convert.ToDouble(good.SalePrice),
                            CostPrice = Convert.ToDouble(good.CostPrice),
                            TradePrice = Convert.ToDouble(good.TradePrice),
                            SaleMoney = Convert.ToDouble(good.SalePrice) * good.Piece,
                            WhetherTax = 0,
                            ReceiveName = entity.UserInfor.UserName,
                            ReceiveCity = entity.UserInfor.DepCity,
                            ReceiveMobile = "",
                            BelongMonth = DateTime.Now.ToString("yyyyMM"),
                            Born = good.Born,
                            Assort = "OER",
                            Source = 24,
                            SourceName = "退货入库",
                            ProductName = "广通慧采轮胎业务部",
                            BatchWeek = bWeek,
                            BatchYear = bYear,
                            SourceHouse = "",
                            BelongDepart = "",
                            OP_Name = entity.UserInfor.UserName.Trim(),
                            Company = "0",
                            SpecsType = "",
                            Supplier = good.Supplier,
                            ProductCode = good.ProductCode,
                            SuppClientNum = Convert.ToString(good.SuppClientNum),
                        });
                    }
                    facMan.SaveData(factoryList);
                    lw.WriteLog(log);
                }
                else
                {
                    //使用事务
                    using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                    {
                        man.AddReturnOrderInfo(entity);
                        #region 梅州仓库直接加库存
                        //if (entity.HouseID.Equals(12))
                        //{
                        //    foreach (var good in entity.goodsList)
                        //    {
                        //        //根据货位号ID修改货位在库数量
                        //        house.UpdateContainerInPiece(new CargoContainerEntity { IsAdd = true, ContainerID = good.ContainerID, InPiece = good.Piece });
                        //        //根据货位ID和产品ID判断是否存在此货位
                        //        CargoContainerGoodsEntity cgood = house.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ContainerID = good.ContainerID, ProductID = good.ProductID });
                        //        //说明是全部出库 需要重新入库
                        //        CargoContainerGoodsEntity inGood = new CargoContainerGoodsEntity
                        //        {
                        //            ContainerID = good.ContainerID,
                        //            ProductID = good.ProductID,
                        //            Piece = good.Piece,
                        //            InHouseTime = DateTime.Now,
                        //            IsPrintInCargo = false,
                        //            Weight = 0,
                        //            TypeID = good.TypeID,
                        //            InHouseType = "1",
                        //            InCargoID = DateTime.Now.ToString("yyMMdd") + GetRandomFourNumString()//入库单号 
                        //        };
                        //        if (cgood != null && !cgood.ID.Equals(0))//说明数据库中还存在此货位数据
                        //        {
                        //            house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { IsAdd = true, Piece = good.Piece, ContainerID = good.ContainerID, ProductID = good.ProductID });
                        //        }
                        //        else
                        //        {
                        //            house.AddCargoContainerGoods(inGood);
                        //        }
                        //        house.AddInContainerGoods(inGood);
                        //        log.Memo += "||货位号：" + good.ContainerCode + "，货位ID：" + good.ContainerID.ToString() + "，产品ID：" + good.ProductID.ToString() + "，退货入库件数：" + good.Piece.ToString();
                        //    }
                        //}
                        #endregion
                        lw.WriteLog(log);
                        scope.Complete();
                    }
                }
            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "新增退货单失败，失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }
        }
        /// <summary>
        /// 删除退货单
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void DelReturnOrder(List<CargoOrderEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoHouseManager house = new CargoHouseManager();
            CargoProductManager product = new CargoProductManager();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    foreach (var it in entity)
                    {
                        //1.删除订单数据
                        //2.查询订单与产品关联数据
                        //3.删除订单与产品关联数据
                        //4.删除入库单数据，循环更新在库数据数量
                        //5.根据货位号查询货位ID，然后根据货位ID更新在库产品数量
                        man.DeleteOrderInfo(it);
                        List<CargoOrderGoodsEntity> goodsList = man.QueryOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = it.OrderNo });
                        man.DeleteOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = it.OrderNo });
                        if (it.HouseID.Equals(12))
                        {
                            foreach (var good in goodsList)
                            {
                                CargoContainerEntity contain = house.QueryContainerEntityByCode(good.ContainerCode, good.HouseID);
                                //删除退货产生的入库单
                                house.DeleteInCargoData(good.OutCargoID, contain.ContainerID, good.ProductID, "1");
                                //减少该货位的在库数量
                                house.UpdateContainerInPiece(new CargoContainerEntity { IsAdd = false, ContainerID = contain.ContainerID, InPiece = good.Piece });

                                house.UpdateCargoContainerGoodsPieceByID(new CargoContainerGoodsEntity { IsAdd = false, Piece = good.Piece, ContainerID = contain.ContainerID, ProductID = good.ProductID });
                            }
                        }
                        log.Memo = "删除退货单：订单号：" + it.OrderNo + "，出发站：" + it.Dep + "，到达站：" + it.Dest + "，件数：" + it.Piece.ToString() + "，费用：" + it.TotalCharge.ToString() + "，收货人：" + it.AcceptPeople + "，电话：" + it.AcceptTelephone + "/" + it.AcceptCellphone + "，制单人：" + it.CreateAwb + "，制单时间：" + it.CreateDate.ToString("yyyy-MM-dd HH:mm:ss") + "，业务员：" + it.SaleManName;
                        lw.WriteLog(log);
                    }
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "删除退货单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 保存退货单的物流数据
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void UpdateReturnLogisAwbNo(CargoOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateReturnLogisAwbNo(entity);
                    log.Memo = "新增退货物流信息： 订单号：" + entity.OrderNo.ToString() + "，物流单号：" + entity.LogisAwbNo;
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增退货物流信息，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 查询退货订单详情
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderEntity> QuerReturnOrderInfo(CargoOrderEntity entity)
        {
            return man.QuerReturnOrderInfo(entity);
        }
        #endregion
        #region 微信商城操作方法集合
        /// <summary>
        /// 查询微信商城订单数据
        /// </summary>
        public List<WXOrderManagerEntity> QueryWeixinOrderInfo(WXOrderManagerEntity entity)
        {
            return man.QueryWeixinOrderInfo(entity);
        }
        /// <summary>
        /// 仓库 确认订单
        /// </summary>
        public void makeSureWxOrder(CargoOrderEntity entity, List<CargoContainerShowEntity> outHouseList, LogEntity log)
        {
            LogWrite<WXOrderManagerEntity> lw = new LogWrite<WXOrderManagerEntity>();
            CargoHouseBus house = new CargoHouseBus();
            CargoWeiXinManager weixin = new CargoWeiXinManager();
            CargoPriceManager price = new CargoPriceManager();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    long DID = man.AddOrderInfoFromWeiXin(entity);
                    house.saveOutCargoData(outHouseList, log);
                    weixin.setWeixinOrderOk(new WXOrderEntity { OrderStatus = "1", OutHouseName = entity.OutHouseName, OrderNo = entity.WXOrderNo });
                    List<CargoRuleBankEntity> rule = price.QueryRuleBank(new CargoRuleBankEntity { HouseID = entity.HouseID, RuleType = "5", DelFlag = "0" });
                    if (entity.IsAppFirstOrder.Equals("1") && rule.Count > 0)
                    {
                        WXOrderEntity wxo = weixin.QueryWeixinOrderByOrderNo(new WXOrderEntity { OrderNo = entity.WXOrderNo });
                        //APP商城首单
                        weixin.AddCoupon(new WXCouponEntity { WXID = wxo.WXID, Money = 30, UseStatus = "0", GainDate = DateTime.Now, StartDate = DateTime.Now, EndDate = DateTime.Now.AddMonths(3) });
                        weixin.AddCoupon(new WXCouponEntity { WXID = wxo.WXID, Money = 20, UseStatus = "0", GainDate = DateTime.Now, StartDate = DateTime.Now, EndDate = DateTime.Now.AddMonths(3) });
                        weixin.AddCoupon(new WXCouponEntity { WXID = wxo.WXID, Money = 20, UseStatus = "0", GainDate = DateTime.Now, StartDate = DateTime.Now, EndDate = DateTime.Now.AddMonths(3) });
                        weixin.AddCoupon(new WXCouponEntity { WXID = wxo.WXID, Money = 10, UseStatus = "0", GainDate = DateTime.Now, StartDate = DateTime.Now, EndDate = DateTime.Now.AddMonths(3) });
                        weixin.AddCoupon(new WXCouponEntity { WXID = wxo.WXID, Money = 10, UseStatus = "0", GainDate = DateTime.Now, StartDate = DateTime.Now, EndDate = DateTime.Now.AddMonths(3) });
                        weixin.AddCoupon(new WXCouponEntity { WXID = wxo.WXID, Money = 5, UseStatus = "0", GainDate = DateTime.Now, StartDate = DateTime.Now, EndDate = DateTime.Now.AddMonths(3) });
                        weixin.AddCoupon(new WXCouponEntity { WXID = wxo.WXID, Money = 5, UseStatus = "0", GainDate = DateTime.Now, StartDate = DateTime.Now, EndDate = DateTime.Now.AddMonths(3) });
                    }
                    if (!entity.CouponID.Equals(0))
                    {
                        //关联优惠券
                        weixin.SetCouponUsed(new WXCouponEntity { ID = entity.CouponID, OrderID = DID, UseStatus = "1", UseDate = DateTime.Now, OrderType = "2" });
                    }
                    if ((entity.PayWay.Equals("0") || entity.PayWay.Equals("2")) && entity.PayStatus.Equals("1"))
                    {
                        //CargoFinanceBus fina = new CargoFinanceBus();
                        CargoFinanceManager fina = new CargoFinanceManager();
                        string awbidlist = string.Empty;
                        List<string> entOrderNo = new List<string>();
                        //如果客户是微信付款，并已支付成功，则修改订单状态为已结算
                        CargoCashierEntity ent = new CargoCashierEntity();
                        ent.WxID = 184;//梅州仓库广州迪乐泰微信商城微信支付收款账号ID
                        ent.AffectWX = entity.TotalCharge;

                        ent.OP_ID = log.UserID;
                        ent.UserName = log.UserID;
                        ent.RType = "0";//收支类型，0收入1支出
                        ent.FromTO = "0";//按订单号收款
                        ent.TradeType = "3";//微信商城付款
                        ent.CheckStatus = "1";
                        entOrderNo.Add(entity.OrderNo);
                        ent.OrderNo = entOrderNo;
                        ent.AffectAwbNO = entity.OrderNo;
                        fina.SaveCash(ent);
                    }
                    log.Memo = "订单号：" + entity.OrderNo.ToString() + "，微信商城订单号：" + entity.WXOrderNo + "，订单件数：" + entity.Piece.ToString() + "，订单金额：" + entity.TotalCharge.ToString() + "，收货人：" + entity.AcceptPeople + "，收货地址：" + entity.AcceptAddress + "，操作人：" + entity.OP_ID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "仓库确认订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }

        }
        /// <summary>
        /// 通过微信商城订单号查询 该订单的微信用户OpendID
        /// </summary>
        /// <param name="orderno"></param>
        /// <returns></returns>
        public string QueryWeixinOpenIDByOrderNo(string orderno)
        {
            return man.QueryWeixinOpenIDByOrderNo(orderno);
        }
        /// <summary>
        /// 查询仓库库存用于确认微信商城订单
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<WXOrderManagerEntity> QueryContainerGoodsMakeSureWeixinOrder(WXOrderManagerEntity entity)
        {
            return man.QueryContainerGoodsMakeSureWeixinOrder(entity);
        }
        /// <summary>
        /// 查询微信订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<WXOrderEntity> QueryWeixinOrder(WXOrderEntity entity)
        {
            return man.QueryWeixinOrder(entity);
        }
        /// <summary>
        /// 查询单个微信订单
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public WXOrderEntity QueryWxOrderData(WXOrderEntity entity)
        {
            return man.QueryWxOrderData(entity);
        }
        /// <summary>
        /// 按照ProductCode联表查询的方法
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public List<WXOrderManagerEntity> QueryWeixinOrderInfoNew(WXOrderManagerEntity entity)
        {
            return man.QueryWeixinOrderInfoNew(entity);
        }
        #endregion
        #region 好来运数据操作方法集合
        /// <summary>
        /// 保存订单数据 到好来运系统
        /// </summary>
        /// <param name="entity"></param>
        public void SaveHlyOrderData(List<CargoContainerShowEntity> entity, CargoOrderEntity order)
        {
            order.Dep = order.Dest;
            if (!string.IsNullOrEmpty(order.Dest))
            {
                string dep = man.QueryHlyArriveToDest(order.Dest);
                if (!string.IsNullOrEmpty(dep))
                {
                    order.Dep = dep;
                }
            }
            man.SaveHlyOrderData(entity, order);
        }
        /// <summary>
        /// 查询好来运订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoOrderEntity QueryHlyOrderData(string orderNo)
        {
            return man.QueryHlyOrderData(orderNo);
        }
        /// <summary>
        /// 删除 好来运订单
        /// </summary>
        /// <param name="orderNo"></param>
        public void DelHlyOrderData(List<CargoOrderEntity> entity)
        {
            foreach (var it in entity)
            {
                man.DelHlyOrderData(it.OrderNo);
            }
        }
        /// <summary>
        /// 根据运单号查询好来运物流 跟踪状态
        /// </summary>
        /// <param name="awbno"></param>
        /// <returns></returns>
        public List<CargoOrderStatusEntity> QueryHlyOrderStatus(string awbno)
        {
            return man.QueryHlyOrderStatus(awbno);
        }
        /// <summary>
        /// 保存好来运外采订单数据
        /// </summary>
        /// <param name="entity"></param>
        public void SaveHlyOutOrderData(CargoOrderEntity entity)
        {
            man.SaveHlyOutOrderData(entity);
        }
        /// <summary>
        /// 查询外采表好来运运单号
        /// </summary>
        /// <param name="orderNo"></param>
        /// <returns></returns>
        public CargoOrderEntity QueryHlyOutOrderData(string orderNo)
        {
            return man.QueryHlyOutOrderData(orderNo);
        }

        /// <summary>
        /// 查询外采订单好来运运单号
        /// </summary>
        /// <param name="orderNo"></param>
        /// <returns></returns>
        public CargoOrderEntity QueryHlyOutOrderAwbno(string orderNo)
        {
            return man.QueryHlyOutOrderAwbno(orderNo);
        }
        #endregion
        #region 改价申请审批操作方法集合
        /// <summary>
        /// 查询改价申请审批数据表
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryUpdatePriceInfo(int pIndex, int pNum, QyOrderUpdatePriceEntity entity)
        {
            return man.QueryUpdatePriceInfo(pIndex, pNum, entity);
        }
        public List<QyOrderUpdatePriceEntity> QueryUpdatePriceStatisSaleMan(QyOrderUpdatePriceEntity entity)
        {
            return man.QueryUpdatePriceStatisSaleMan(entity);
        }
        /// <summary>
        /// 
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<QyOrderUpdatePriceEntity> QueryUpdatePriceStatis(QyOrderUpdatePriceEntity entity)
        {
            return man.QueryUpdatePriceStatis(entity);
        }
        /// <summary>
        /// 查询订单是否经过审批
        /// </summary>
        /// <param name="OrderNo"></param>
        /// <returns></returns>
        public bool QueryOrderApprovalOrNot(string OrderNo)
        {
            return man.QueryOrderApprovalOrNot(OrderNo);
        }
        /// <summary>
        /// 根据用户登录名获取上级负责人登录名
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<SystemUserEntity> QueryUserBossLoginName(SystemUserEntity entity)
        {
            return man.QueryUserBossLoginName(entity);
        }
        /// <summary>
        /// 根据员工账号查询分公司领导或部门领导信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public SystemUserEntity QueryBossLeaderByLoginName(SystemUserEntity entity)
        {
            return man.QueryBossLeaderByLoginName(entity);
        }
        /// <summary>
        /// 查询我的审批 已审批过的
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryMyCheckUpdatePriceInfo(int pIndex, int pNum, QyOrderUpdatePriceEntity entity)
        {
            return man.QueryMyCheckUpdatePriceInfo(pIndex, pNum, entity);
        }
        public Hashtable QueryUpExpenseCheckInfo(int pIndex, int pNum, CargoExpenseEntity entity)
        {
            return man.QueryUpExpenseCheckInfo(pIndex, pNum, entity);
        }
        public Hashtable QueryExpenseCheckInfo(int pIndex, int pNum, CargoExpenseEntity entity)
        {
            return man.QueryExpenseCheckInfo(pIndex, pNum, entity);
        }
        #endregion
        #region 移库订单操作方法集合
        /// <summary>
        /// 移库新增
        /// </summary>
        /// <param name="entity"></param>
        public void AddMoveOrderData(CargoMoveOrderEntity entity, LogEntity log)
        {
            CargoHouseManager house = new CargoHouseManager();
            CargoFactoryOrderManager facMan = new CargoFactoryOrderManager();
            LogWrite<CargoMoveOrderEntity> lw = new LogWrite<CargoMoveOrderEntity>();
            //使用事务
            try
            {
                CargoMoveOrderEntity moveOrderData = null;
                using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                {
                    //1.保存移库单 
                    moveOrderData = man.AddMoveOrderData(entity);
                    //2.减库存
                    foreach (var it in entity.MoveGoodsList)
                    {
                        house.UpdateCargoContainerGoodsPiece(new CargoContainerGoodsEntity { ID = it.ContainerGoodsID, Piece = it.Piece, IsAdd = false });
                    }
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
                if (moveOrderData != null)
                {
                    CargoHouseManager houseMan = new CargoHouseManager();
                    var containerIDs = entity.MoveGoodsList.Select(c => c.ContainerID).ToArray();
                    var containerData = houseMan.QueryAreaByContainer(containerIDs);
                    List<UpdateOOSGoodsParam> oosGdsParams = entity.MoveGoodsList.Select(i => new UpdateOOSGoodsParam()
                    {
                        ProductCode = i.ProductCode,
                        HouseID = containerData.FirstOrDefault(c => c.ContainerID == i.ContainerID)?.HouseID ?? 0,
                    }).Where(c => c.HouseID != 0).ToList();
                    if (oosGdsParams.Count > 0)
                    {
                        UpdateOOSParam oosParams = new UpdateOOSParam()
                        {
                            UserID = _userid,
                            UserName = _username,
                            ReasonTag = "TO",
                            SrcType = 3,
                            SrcID = (int)moveOrderData.ID,
                            SrcCode = moveOrderData.MoveNo,
                            Rows = oosGdsParams
                        };
                        CargoOrderBus ordrBus = new CargoOrderBus();
                        ordrBus.TryUpdateOutOfStock(oosParams);
                    }
                }
            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "新增移库单失败，失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }


        }
        public void UpdateMoveOrderData(CargoMoveOrderEntity entity, LogEntity log)
        {
            CargoHouseManager house = new CargoHouseManager();
            LogWrite<CargoMoveOrderEntity> lw = new LogWrite<CargoMoveOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateMoveOrderData(new CargoMoveOrderEntity { ID = entity.ID, MoveNo = entity.MoveNo, MoveNum = entity.MoveNum, MoveStatus = entity.MoveStatus });
                    foreach (var it in entity.MoveGoodsList)
                    {
                        house.UpdateCargoContainerGoodsPiece(new CargoContainerGoodsEntity { ID = it.ContainerGoodsID, Piece = entity.MoveNum, IsAdd = false });
                        if (it.NewPiece.Equals(0))
                        {
                            man.DeleteMoveOrderGoodsData(new CargoMoveOrderGoodsEntity { MoveNo = entity.MoveNo, ProductID = it.ProductID, ContainerID = it.ContainerID, ContainerGoodsID = it.ContainerGoodsID });
                            log.Memo = "拉下移库单，移库单号：" + entity.MoveNo + ",产品ID：" + it.ProductID + ",货位ID：" + it.ContainerID + ",库存ID：" + it.ContainerGoodsID + ",原数量：" + it.OldPiece;
                        }
                        else
                        {
                            man.UpdateMoveOrderGoodsData(new CargoMoveOrderGoodsEntity { MoveNo = entity.MoveNo, ProductID = it.ProductID, ContainerID = it.ContainerID, ContainerGoodsID = it.ContainerGoodsID, Piece = it.NewPiece });
                            if (it.NewPiece > 0)
                            {
                                log.Memo = "增加移库数量，移库单号：" + entity.MoveNo + ",产品ID：" + it.ProductID + ",货位ID：" + it.ContainerID + ",库存ID：" + it.ContainerGoodsID + ",原数量：" + it.OldPiece + ",新数量：" + (it.OldPiece + it.NewPiece);
                            }
                            else
                            {
                                log.Memo = "减少移库数量，移库单号：" + entity.MoveNo + ",产品ID：" + it.ProductID + ",货位ID：" + it.ContainerID + ",库存ID：" + it.ContainerGoodsID + ",原数量：" + it.OldPiece + ",新数量：" + (it.OldPiece + it.NewPiece);
                            }
                        }
                        lw.WriteLog(log);
                    }
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "编辑移库单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 查询移库订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoMoveOrderEntity> QueryMoveOrderList(CargoMoveOrderEntity entity)
        {
            return man.QueryMoveOrderList(entity);
        }
        public List<CargoMoveOrderGoodsEntity> QueryMoveOrderGoodsList(CargoMoveOrderGoodsEntity entity)
        {
            return man.QueryMoveOrderGoodsList(entity);
        }
        public int QueryMoveOrderScanPiece(CargoMoveOrderGoodsEntity entity)
        {
            return man.QueryMoveOrderScanPiece(entity);
        }
        public int QueryMoveOrderMoveNum(CargoMoveOrderEntity entity)
        {
            return man.QueryMoveOrderMoveNum(entity);
        }
        /// <summary>
        /// 查询移库单 
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryMoveOrder(int pIndex, int pNum, CargoMoveOrderEntity entity)
        {
            return man.QueryMoveOrder(pIndex, pNum, entity);
        }
        /// <summary>
        /// 查询移库单导出
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoMoveOrderEntity> QueryMoveOrderForExport(CargoMoveOrderEntity entity)
        {
            return man.QueryMoveOrderForExport(entity);
        }
        /// <summary>
        /// 根据移库单号查询移库单明细
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public List<CargoContainerShowEntity> QueryMoveOrderByMoveOrderNo(CargoMoveOrderGoodsEntity entity)
        {
            return man.QueryMoveOrderByMoveOrderNo(entity);
        }
        /// <summary>
        /// 删除移库
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void DelMoveOrder(List<CargoMoveOrderEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoHouseManager house = new CargoHouseManager();
            CargoProductManager product = new CargoProductManager();
            CargoWeiXinManager weixin = new CargoWeiXinManager();
            QiyeManager qiye = new QiyeManager();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    foreach (var it in entity)
                    {
                        //1.删除订单数据
                        //2.查询订单与产品关联数据
                        //3.删除订单与产品关联数据
                        //4.删除出库单数据，循环更新在库数据数量
                        //5.根据货位号查询货位ID，然后根据货位ID更新在库产品数量
                        //6.删除产品标签表出库状态
                        //7.退回客户的积分
                        //8.删除改价申请审批记录表
                        List<CargoMoveOrderGoodsEntity> goodsList = man.QueryMoveOrderGoodsList(new CargoMoveOrderGoodsEntity { MoveNo = it.MoveNo });
                        man.DeleteMoveOrderInfo(it);
                        man.DeleteMoveOrderGoodsInfo(new CargoMoveOrderGoodsEntity { MoveNo = it.MoveNo });

                        List<CargoProductTagEntity> tagList = product.QueryProductTagList(new CargoProductTagEntity { MoveOrderNo = it.MoveNo });
                        if (tagList.Count > 0)
                        {
                            product.UpdateTagMoveOrder(new CargoProductTagEntity { MoveOrderNo = it.MoveNo });
                        }
                        log.Memo = "移库单号：" + it.MoveNo + ",原仓库:" + it.OldHouseName + ",目标仓库：" + it.NewHouseName;

                        foreach (var good in goodsList)
                        {
                            house.UpdateCargoContainerGoodsPiece(new CargoContainerGoodsEntity { IsAdd = true, Piece = good.Piece, ID = good.ContainerGoodsID });
                        }
                        lw.WriteLog(log);
                    }
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "删除订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }

        }

        /// <summary>
        /// 根据移库单号查询移库信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoMoveOrderEntity QueryMoveOrderByMoveNo(CargoMoveOrderEntity entity)
        {
            return man.QueryMoveOrderByMoveNo(entity);
        }

        /// <summary>
        /// 查询移库扫描状态和入库状态
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoMoveOrderEntity QueryMoveOrderEntity(CargoMoveOrderEntity entity)
        {
            return man.QueryMoveOrderEntity(entity);
        }
        /// <summary>
        /// 修改移库单移库状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateMoveOrderStatus(CargoMoveOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoMoveOrderEntity> lw = new LogWrite<CargoMoveOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateMoveOrderStatus(entity);
                    log.Memo = "修改移库状态，移库单号：" + entity.MoveNo + ",新状态：" + entity.MoveStatus;
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        #endregion
        #region 删除订单管理操作方法集合
        /// <summary>
        /// 查询删除订单记录表
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryOrderTempInfo(int pIndex, int pNum, CargoOrderEntity entity)
        {
            return man.QueryOrderTempInfo(pIndex, pNum, entity);
        }
        /// <summary>
        /// 通过订单号查询订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryOrderTempByOrderNo(CargoOrderEntity entity)
        {
            return man.QueryOrderTempByOrderNo(entity);
        }
        #endregion
        #region 预订单方法

        /// <summary>
        /// 查询当前日期当前仓库表中最大顺序号
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public int GetMaxPreOrderNumByCurrentDate(CargoOrderEntity entity)
        {
            return man.GetMaxPreOrderNumByCurrentDate(entity);
        }
        /// <summary>
        /// 新增预订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// 
        public void AddPreOrderInfo(CargoOrderEntity entity, List<CargoContainerShowEntity> outHouseList, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoHouseBus houseBus = new CargoHouseBus();
            if (entity.IsMakeSure == 1)
            {
                //使用事务
                using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                {
                    try
                    {
                        long orderID = man.AddOrderInfo(entity);
                        houseBus.saveOutCargoData(outHouseList, log);

                        log.Memo = "";
                        lw.WriteLog(entity, log);
                        scope.Complete();

                    }
                    catch (ApplicationException ex)
                    {
                        log.Status = "1";
                        log.Memo = "新增订单失败，失败信息：" + ex.Message;
                        lw.WriteLog(log);
                        throw;
                    }
                }
            }
            else
            {
                CargoProductManager product = new CargoProductManager();
                CargoHouseManager house = new CargoHouseManager();
                try
                {
                    //使用事务
                    using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                    {
                        man.AddPreOrderInfo(entity);

                        foreach (var item in entity.productsList)
                        {
                            if (item.PurchaserID != 11 && item.PurchaserID != 12)
                            {
                                long ProductID = product.AddCargoProduct(item);
                                CargoContainerGoodsEntity containerGoodsEntity = new CargoContainerGoodsEntity();
                                containerGoodsEntity.ContainerID = item.ContainerID;
                                containerGoodsEntity.TypeID = item.TypeID;
                                containerGoodsEntity.ProductID = ProductID;
                                containerGoodsEntity.Piece = 0;
                                containerGoodsEntity.Weight = 0;
                                containerGoodsEntity.IsPrintInCargo = false;
                                containerGoodsEntity.InHouseType = "0";
                                containerGoodsEntity.InCargoID = item.InCargoID;
                                house.AddContainerGoods(containerGoodsEntity);
                                //保存入库单表
                                containerGoodsEntity.Piece = item.Numbers;
                                house.AddInContainerGoods(containerGoodsEntity);
                                //修改货位上的产品件数
                                //house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = item.ContainerID, InPiece = item.Numbers, IsAdd = true });
                                //修改产品的入库状态 
                                product.UpdateCargoProductStatus(new CargoProductEntity { ProductID = ProductID, InCargoStatus = "1" });

                                man.OesPreOrderGoodsConfirm(new CargoOrderGoodsEntity { OrderNo = entity.OrderNo, ProductID = ProductID, HouseID = entity.HouseID, AreaID = item.AreaID, ContainerCode = item.ContainerCode, Piece = item.Numbers, GoodsCode = item.GoodsCode, ActSalePrice = item.SalePrice, OutCargoID = entity.OutCargoID });
                            }
                        }
                        man.OesPreOrderConfirm(entity);
                        log.Memo = "采购订单号：" + entity.OrderNo + "，出发站：" + entity.Dep + "，到达站：" + entity.Dest + "，件数：" + entity.Piece.ToString() + "，费用：" + entity.TotalCharge.ToString() + "，收货人：" + entity.AcceptPeople + "，电话：" + entity.AcceptTelephone + "/" + entity.AcceptCellphone + "，制单人：" + entity.CreateAwb + "，制单时间：" + entity.CreateDate.ToString("yyyy-MM-dd HH:mm:ss") + "，业务员：" + entity.SaleManName + "，物流公司名称：" + entity.LogisticName + "，供应商：" + entity.PurchaserName;
                        lw.WriteLog(log);
                        scope.Complete();
                    }
                    CargoClientManager client = new CargoClientManager();
                    List<CargoPurchaserEntity> purchaser = client.AutoCompletePurchaser(new CargoPurchaserEntity { PurchaserID = Convert.ToInt64(entity.PurchaserID) });
                    if (purchaser.Count > 0)
                    {
                        //man.SaveHlyOesOrderData(new CargoPurchaserEntity { OrderNo = entity.OrderNo, Piece = entity.Piece.ToString(), CheckOutName = purchaser[0].PurchaserType == 0 ? "现结" : "月结", PurchaserName = purchaser[0].PurchaserName, Address = purchaser[0].Address, Boss = purchaser[0].Boss, Telephone = purchaser[0].Telephone, PurchaserStatus = "0", Remark = entity.Remark });
                        man.SaveHlyOesOrderData(new CargoPurchaserEntity { OrderNo = entity.OrderNo, Piece = entity.Piece.ToString(), CheckOutName = purchaser[0].PurchaserType == 0 ? "现结" : "月结", PurchaserName = entity.PurchaserName, Address = entity.PurchaserAddress, Boss = entity.PurchaserBoss, Telephone = entity.PurchaserCellphone, PurchaserStatus = "0", Remark = entity.Remark });

                        foreach (var item in entity.productsList)
                        {
                            item.OrderNo = entity.OrderNo;
                            if (item.Born == "0")
                            {
                                item.Born = "国产";
                            }
                            else
                            {
                                item.Born = "进口";
                            }
                            man.SaveHlyOesOrderGoodsData(item);
                        }
                    }
                    //2023-03-04注释修改，推送提货通知时再保存到好来运系统
                    //List<CargoContainerShowEntity> orderContainerList = QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = entity.OrderNo });
                    //CargoOrderEntity order = QueryOrderInfo(entity);
                    //SaveHlyOrderData(orderContainerList, order);
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 修改预订单产品数量
        /// </summary>
        /// <param name="OrderNo"></param>
        /// <param name="GoodsCode"></param>
        /// <param name="OldPiece"></param>
        /// <param name="NewPiece"></param>
        /// <param name="log"></param>
        public void UpdatePreOrderPiece(string OrderNo, string GoodsCode, int OldPiece, int NewPiece, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    int piece = NewPiece - OldPiece;
                    if (piece < 0)
                    {
                        man.UpdatePreOrderPiece(OrderNo, GoodsCode, piece);
                        man.UpdatePreOrderGoodsPiece(OrderNo, GoodsCode, piece);
                        log.Memo = "减少预订单产品数量，预订单号：" + OrderNo + "，富添盛编码：" + GoodsCode + "，旧数量：" + OldPiece + "，新数量：" + NewPiece;
                    }
                    else if (piece == 0)
                    {
                        man.UDeletePreOrderGoodsPiece(OrderNo, GoodsCode);
                        log.Memo = "拉下预订单产品，预订单号：" + OrderNo + "，富添盛编码：" + GoodsCode + "，旧数量：" + OldPiece + "，新数量：" + NewPiece;
                    }
                    else
                    {
                        man.UpdatePreOrderPiece(OrderNo, GoodsCode, piece);
                        man.UpdatePreOrderGoodsPiece(OrderNo, GoodsCode, piece);
                        log.Memo = "增加预订单产品数量，预订单号：" + OrderNo + "，富添盛编码：" + GoodsCode + "，旧数量：" + OldPiece + "，新数量：" + NewPiece;
                    }
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "删除预订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 修改预订单中产品价格
        /// </summary>
        /// <param name="entity"></param>
        public void UpdatePreOrderSalePrice(CargoContainerShowEntity entity, LogEntity log)
        {
            LogWrite<CargoContainerShowEntity> lw = new LogWrite<CargoContainerShowEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdatePreOrderSalePrice(entity);
                    log.Memo = "修改预订单价格：预订单号：" + entity.OrderNo.ToString() + "，富添盛编码：" + entity.GoodsCode.ToString() + "，产品规格：" + entity.Specs + "，货位号：" + entity.ContainerCode + "，原价格：" + entity.SalePrice.ToString() + "，新价格：" + entity.ActSalePrice.ToString() + "，操作人：" + log.UserID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改预订单价格失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 查询预订单数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryPreOrderInfo(int pIndex, int pNum, CargoOrderEntity entity)
        {
            return man.QueryPreOrderInfo(pIndex, pNum, entity);
        }
        /// <summary>
        /// 通过订单号查询预订单数据
        /// </summary>
        /// <param name="pIndex">当前页数</param>
        /// <param name="pNum">每页多少条数据</param>
        /// <param name="strWhere">查询条件</param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryPreOrderByOrderNo(CargoOrderEntity entity)
        {
            return man.QueryPreOrderByOrderNo(entity);
        }


        /// <summary>
        /// 删除预订单信息
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void DeletePreOrderInfo(List<CargoOrderEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoHouseManager house = new CargoHouseManager();
            CargoProductManager product = new CargoProductManager();
            CargoWeiXinManager weixin = new CargoWeiXinManager();
            QiyeManager qiye = new QiyeManager();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    foreach (var it in entity)
                    {
                        //删除订单数据
                        man.DeletePreOrderInfo(it);
                        //删除订单与产品关联数据
                        man.DeletePreOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = it.OrderNo });

                        log.Memo = "预订单号：" + it.OrderNo + "，出发站：" + it.Dep + "，到达站：" + it.Dest + "，件数：" + it.Piece.ToString() + "，费用：" + it.TotalCharge.ToString() + "，收货人：" + it.AcceptPeople + "，电话：" + it.AcceptTelephone + "/" + it.AcceptCellphone + "，制单人：" + it.CreateAwb + "，制单时间：" + it.CreateDate.ToString("yyyy-MM-dd HH:mm:ss") + "，业务员：" + it.SaleManName + "，物流公司名称：" + it.LogisticName + "，物流公司单号：" + it.LogisAwbNo;
                        lw.WriteLog(log);

                    }
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "删除预订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }

        /// <summary>
        /// 根据订单号查询订单与产品关联表数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderGoodsEntity> QueryPreOrderGoodsInfo(string OrderNo)
        {
            return man.QueryPreOrderGoodsInfo(OrderNo);
        }
        /// <summary>
        /// 根据条件查询所有产品
        /// </summary>
        /// <param name="OrderNo"></param>
        /// <returns></returns>
        public List<CargoProductEntity> QueryPreOrderProductInfo(CargoProductEntity entity)
        {
            return man.QueryPreOrderProductInfo(entity);
        }
        /// <summary>
        /// 根据预订单号查询产品库存数量
        /// </summary>
        /// <param name="OrderNo"></param>
        /// <returns></returns>
        public int QueryPreOrderProductNum(CargoOrderGoodsEntity entity)
        {
            return man.QueryPreOrderProductNum(entity);
        }
        /// <summary>
        /// 确认预订单信息
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void PreOrderConfirm(List<CargoOrderEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoHouseManager house = new CargoHouseManager();
            CargoProductManager product = new CargoProductManager();
            CargoWeiXinManager weixin = new CargoWeiXinManager();
            QiyeManager qiye = new QiyeManager();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    foreach (var it in entity)
                    {
                        //获取订单产品数量
                        List<CargoOrderGoodsEntity> goodsList = QueryPreOrderGoodsInfo(it.OrderNo);
                        if (goodsList == null) { return; }
                        foreach (var good in goodsList)
                        {
                            int num = good.Piece;
                            //获取此富添盛编码所有产品
                            List<CargoProductEntity> productList = QueryPreOrderProductInfo(new CargoProductEntity { GoodsCode = good.GoodsCode });

                            foreach (var pro in productList)
                            {
                                if (pro.Numbers >= num)
                                {
                                    product.UpdateCargoProductPiece(new CargoProductEntity { Numbers = num, ProductID = pro.ProductID });
                                    man.PreOrderGoodsConfirm(new CargoOrderGoodsEntity { OrderNo = good.OrderNo, ProductID = pro.ProductID, HouseID = pro.HouseID, AreaID = pro.AreaID, ContainerCode = pro.ContainerCode, Piece = num, GoodsCode = good.GoodsCode });

                                    //修改入库单的在货位件数
                                    house.UpdateCargoContainerGoodsPiece(new CargoContainerGoodsEntity { ID = pro.ContainerGoodsID, Piece = num, IsAdd = false });

                                    house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = pro.ContainerID, InPiece = num, IsAdd = false });

                                    //log.Memo += " 所在仓库：" + it.HouseName + " 所在区域：" + it.AreaName + " 产品类型：" + it.TypeName + " 产品名称：" + it.ProductName + " 型号：" + it.Model + " 规格：" + it.Specs + " 花纹：" + it.Figure + " 货位ID：" + it.ContainerID.ToString() + " 产品类型ID：" + it.TypeID.ToString() + " 产品ID：" + it.ProductID.ToString() + " 出库件数：" + it.Piece.ToString() + "，业务员销售价：" + it.ActSalePrice.ToString();
                                    break;
                                }
                                else
                                {
                                    product.UpdateCargoProductPiece(new CargoProductEntity { Numbers = pro.Numbers, ProductID = pro.ProductID });

                                    man.PreOrderGoodsConfirm(new CargoOrderGoodsEntity { OrderNo = good.OrderNo, ProductID = pro.ProductID, HouseID = pro.HouseID, AreaID = pro.AreaID, ContainerCode = pro.ContainerCode, Piece = pro.Numbers, GoodsCode = good.GoodsCode });

                                    //修改入库单的在货位件数
                                    house.UpdateCargoContainerGoodsPiece(new CargoContainerGoodsEntity { ID = pro.ContainerGoodsID, Piece = pro.Numbers, IsAdd = false });

                                    house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = pro.ContainerID, InPiece = pro.Numbers, IsAdd = false });


                                    num -= pro.Numbers;
                                }
                            }
                        }

                        man.PreOrderConfirm(it);

                        log.Memo = "预订单号：" + it.OrderNo + "，出发站：" + it.Dep + "，到达站：" + it.Dest + "，件数：" + it.Piece.ToString() + "，费用：" + it.TotalCharge.ToString() + "，收货人：" + it.AcceptPeople + "，电话：" + it.AcceptTelephone + "/" + it.AcceptCellphone + "，制单人：" + it.CreateAwb + "，制单时间：" + it.CreateDate.ToString("yyyy-MM-dd HH:mm:ss") + "，业务员：" + it.SaleManName + "，物流公司名称：" + it.LogisticName + "，物流公司单号：" + it.LogisAwbNo;
                        lw.WriteLog(log);

                    }
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "确认预订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 修改预订单
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void UpdatePreOrderInfo(CargoOrderEntity entity, List<CargoContainerShowEntity> cargoList, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                List<CargoOrderGoodsEntity> newList = entity.goodsList;
                try
                {
                    //5.首先删除旧订单与产品关联表数据
                    man.DeletePreOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = entity.OrderNo });
                    //6.保存新加进来的订单产品数据
                    man.AddPreOrderGoodsInfo(newList);

                    //修改订单数据
                    man.UpdatePreOrderInfo(entity);
                    log.Memo = "";
                    lw.WriteLog(entity, log);

                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 拉上预订单
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void DrawUpPreOrder(CargoContainerShowEntity entity, LogEntity log)
        {
            LogWrite<CargoContainerShowEntity> lw = new LogWrite<CargoContainerShowEntity>();
            CargoHouseManager house = new CargoHouseManager();
            CargoOrderEntity order = man.QueryOrderInfo(new CargoOrderEntity { OrderNo = entity.OrderNo });
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    //1. 新增订单关联表数据
                    List<CargoOrderGoodsEntity> goods = new List<CargoOrderGoodsEntity>();
                    goods.Add(new CargoOrderGoodsEntity
                    {
                        OrderNo = entity.OrderNo,
                        ProductID = entity.ProductID,
                        HouseID = entity.HouseID,
                        AreaID = entity.AreaID,
                        ContainerCode = entity.ContainerCode,
                        Piece = entity.Piece,
                        ActSalePrice = entity.ActSalePrice,
                        OP_ID = log.UserID,
                        OutCargoID = entity.OutCargoID,
                        Specs = entity.Specs,
                        Figure = entity.Figure,
                        Model = entity.Model,
                        GoodsCode = entity.GoodsCode,
                        Batch = entity.Batch,
                        Born = entity.Born,
                        LoadIndex = entity.LoadIndex.ToString(),
                        TypeID = entity.TypeID,
                        SpeedLevel = entity.SpeedLevel
                    });
                    man.AddPreOrderGoodsInfo(goods);

                    //5. 修改订单数量和金额
                    man.DrawUpPreOrderPieceCharge(new CargoOrderEntity { Piece = entity.Piece, TransportFee = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), TotalCharge = Convert.ToDecimal(entity.Piece * entity.ActSalePrice), OrderNo = entity.OrderNo });

                    log.Memo = "拉上预订单：订单号：" + entity.OrderNo.ToString() + "，产品ID：" + entity.ProductID.ToString() + "，富添盛编码：" + entity.GoodsCode + "，货位号：" + entity.ContainerCode + "，原数量：" + order.Piece.ToString() + "，新数量：" + (order.Piece + entity.Piece).ToString() + "，拉上数量：" + entity.Piece.ToString() + "，操作人：" + log.UserID + "，操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");

                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "拉上订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                }
            }
        }
        #endregion
        #region 来货订单条码
        /// <summary>
        /// 查询来货订单条码
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryBarcodeData(int pIndex, int pNum, CargoFactoryOrderBarcodeEntity entity)
        {
            return man.QueryBarcodeData(pIndex, pNum, entity);
        }
        /// <summary>
        /// 查询是否存在指定船运单号数据
        /// </summary>
        /// <param name="VehicleNo"></param>
        /// <returns></returns>
        public int IsExistBarcodeData(string VehicleNo)
        {
            return man.IsExistBarcodeData(VehicleNo);
        }
        /// <summary>
        /// 新增来货订单条码数据
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void InsertBarcodeData(List<CargoFactoryOrderBarcodeEntity> entity, LogEntity log)
        {
            LogWrite<CargoFactoryOrderBarcodeEntity> lw = new LogWrite<CargoFactoryOrderBarcodeEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    foreach (var item in entity)
                    {
                        man.InsertBarcodeData(item);
                        log.Memo = "新增来货订单条码数据";
                        lw.WriteLog(item, log);
                    }

                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增来货订单条码数据失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 通过条件查询船运数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoFactoryOrderBarcodeEntity> QueryBarcodeInfo(CargoFactoryOrderBarcodeEntity entity)
        {
            return man.QueryBarcodeInfo(entity);
        }

        #endregion
        #region 处理好来运系统订单签收
        /// <summary>
        /// 处理好来运系统的运单签收状态，同步修改智能系统订单物流状态
        /// </summary>
        /// <param name="entity"></param>
        public void SetOrderSignByHLY(CargoOrderEntity entity)
        {
            man.SetOrderSignByHLY(entity);
        }
        public void SetOrderStatusByHLY(CargoOrderEntity entity)
        {
            man.SetOrderStatusByHLY(entity);
        }
        #endregion
        #region 大屏可视化方法集合
        /// <summary>
        /// 新增订单数据
        /// </summary>
        /// <param name="OrderNo"></param>
        public void AddOwlOrderData(string OrderNo)
        {
            man.AddOwlOrderData(OrderNo);
        }
        /// <summary>
        /// 删除大屏可视化订单数据
        /// </summary>
        /// <param name="OrderNo"></param>
        public void DeleteOwlOrderData(string OrderNo)
        {
            man.DeleteOwlOrderData(OrderNo);
        }
        #endregion
        #region 采购订单方法集合
        /// <summary>
        /// 查询采购订单数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryOesPreOrderInfo(int pIndex, int pNum, CargoOrderEntity entity)
        {
            return man.QueryOesPreOrderInfo(pIndex, pNum, entity);
        }
        /// <summary>
        /// 查询采购订单产品详细信息
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryOesPreOrderByOrderNo(CargoOrderEntity entity)
        {
            return man.QueryOesPreOrderByOrderNo(entity);
        }
        /// <summary>
        /// 采购订单报价
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="cargoList"></param>
        /// <param name="log"></param>
        public void UpdatePurchaserOrderInfo(CargoOrderEntity entity, List<CargoContainerShowEntity> cargoList, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                List<CargoOrderGoodsEntity> newList = entity.goodsList;
                try
                {
                    man.UpdatePurchaserOrderGoodsInfo(newList);

                    man.UpdatePurchaserOrderInfo(entity);
                    log.Memo = "";
                    lw.WriteLog(entity, log);

                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 确认采购订单价格
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void OesPreOrderNewConfirm(List<CargoOrderEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            List<CargoOrderGoodsEntity> goods = new List<CargoOrderGoodsEntity>();
            try
            {
                //使用事务
                using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                {
                    foreach (var order in entity)
                    {
                        foreach (var item in order.productsList)
                        {
                            goods.Add(new CargoOrderGoodsEntity { Batch = item.Batch, ActSalePrice = item.UnitPrice, PurchaserID = item.PurchaserID, PurchaserName = item.PurchaserName, OP_ID = item.OPID, HouseID = item.HouseID, OrderNo = item.OrderNo, Specs = item.Specs, Figure = item.Figure, Model = item.Model, GoodsCode = item.GoodsCode, TypeID = item.TypeID, Born = item.Born, LoadIndex = item.LoadIndex, SpeedLevel = item.SpeedLevel, ConfirmSalePrice = item.SalePrice });
                        }
                        man.UpdatePurchaserOrderGoodsSalePrice(goods);
                        man.OesPreOrderNewConfirm(order);
                        log.Memo = "采购订单号：" + order.OrderNo + "，出发站：" + order.Dep + "，到达站：" + order.Dest + "，件数：" + order.Piece.ToString() + "，费用：" + order.TotalCharge.ToString() + "，收货人：" + order.AcceptPeople + "，电话：" + order.AcceptTelephone + "/" + order.AcceptCellphone + "，确认价格";
                        lw.WriteLog(log);
                    }
                    scope.Complete();
                }
            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "确认采购订单失败，失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }
        }
        /// <summary>
        /// 确认采购订单
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void OesPreOrderConfirm(List<CargoOrderEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            List<CargoOrderGoodsEntity> goods = new List<CargoOrderGoodsEntity>();
            CargoHouseManager house = new CargoHouseManager();
            CargoProductManager product = new CargoProductManager();
            CargoClientManager client = new CargoClientManager();
            try
            {
                //使用事务
                using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                {
                    int index = 0;
                    foreach (var order in entity)
                    {
                        string NewOrderNo = string.Empty;
                        int oNum = GetMaxOrderNumByCurrentDate(new CargoOrderEntity { HouseID = order.HouseID, StartDate = DateTime.Now, EndDate = DateTime.Now });
                        string oStr = string.Empty;
                        switch ((oNum + 1).ToString().Length)
                        {
                            case 1:
                                oStr = "00" + (oNum + 1).ToString();
                                break;
                            case 2:
                                oStr = "0" + (oNum + 1).ToString();
                                break;
                            default:
                                oStr = (oNum + 1).ToString();
                                break;
                        }
                        NewOrderNo = order.HouseCode + DateTime.Now.ToString("yyMMdd") + oStr;
                        order.OrderNum = oNum + 1;
                        //产品电脑入库
                        decimal TransportFee = 0;
                        foreach (var item in order.productsList)
                        {
                            TransportFee += item.SalePrice * item.Numbers;
                            if (item.PurchaserID == 11 || item.PurchaserID == 12)
                            {
                                #region 
                                //CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                                //{
                                //    BelongDepart = "1",
                                //    HouseID = item.HouseID,
                                //    GoodsCode = item.GoodsCode,
                                //    TypeID = item.TypeID,
                                //    Model = item.Model,
                                //    Specs = item.Specs,
                                //    Batch = item.Batch,
                                //    BatckWeek = item.Batch.Length >= 4 ? Convert.ToInt32(item.Batch.Substring(0, 2)) : 0,
                                //    ParentID = item.ParentID,
                                //    Figure = item.Figure
                                //};
                                //CargoInterfaceBus interBus = new CargoInterfaceBus();
                                //List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
                                //List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
                                //List<CargoInterfaceEntity> stockList = interBus.queryCargoStock(queryEntity);

                                ////减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                                //foreach (var it in stockList)
                                //{
                                //    if (it.StockNum <= 0) { continue; }
                                //    CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                                //    cargo.OrderNo = NewOrderNo;//订单号
                                //    cargo.OutCargoID = order.OutCargoID;
                                //    cargo.ContainerID = it.ContainerID;
                                //    cargo.TypeID = it.TypeID;
                                //    cargo.ProductID = it.ProductID;

                                //    cargo.ID = it.ContainerGoodsID;//库存表ID

                                //    //cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                                //    cargo.HouseName = order.HouseName;
                                //    //cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                                //    cargo.ProductName = it.ProductName;
                                //    cargo.Model = it.Model;
                                //    cargo.Specs = it.Specs;
                                //    cargo.Figure = it.Figure;
                                //    #region 减库存逻辑
                                //    if (item.Numbers < it.StockNum)
                                //    {
                                //        //部分出
                                //        entDest.Add(new CargoOrderGoodsEntity
                                //        {
                                //            OrderNo = NewOrderNo,
                                //            ProductID = it.ProductID,
                                //            HouseID = order.HouseID,
                                //            AreaID = it.AreaID,
                                //            Piece = item.Numbers,
                                //            ActSalePrice = 0,
                                //            ContainerCode = it.ContainerCode,
                                //            OutCargoID = order.OutCargoID,
                                //            OP_ID = log.UserID
                                //        });
                                //        cargo.Piece = item.Numbers;
                                //        cargo.InPiece = it.StockNum;

                                //        outHouseList.Add(cargo);
                                //        break;
                                //    }
                                //    if (item.Numbers.Equals(it.StockNum))
                                //    {
                                //        //要出库件数和第一条库存件数刚刚好，则就全部出
                                //        entDest.Add(new CargoOrderGoodsEntity
                                //        {
                                //            OrderNo = NewOrderNo,
                                //            ProductID = it.ProductID,
                                //            HouseID = order.HouseID,
                                //            AreaID = it.AreaID,
                                //            Piece = item.Numbers,
                                //            ActSalePrice = 0,
                                //            ContainerCode = it.ContainerCode,
                                //            OutCargoID = order.OutCargoID,
                                //            OP_ID = log.UserID
                                //        });
                                //        cargo.Piece = item.Numbers;
                                //        cargo.InPiece = it.StockNum;

                                //        outHouseList.Add(cargo);
                                //        break;
                                //    }
                                //    if (item.Numbers > it.StockNum)
                                //    {
                                //        //全部出
                                //        entDest.Add(new CargoOrderGoodsEntity
                                //        {
                                //            OrderNo = NewOrderNo,
                                //            ProductID = it.ProductID,
                                //            HouseID = order.HouseID,
                                //            AreaID = it.AreaID,
                                //            Piece = it.StockNum,
                                //            ActSalePrice = 0,
                                //            ContainerCode = it.ContainerCode,
                                //            OutCargoID = order.OutCargoID,
                                //            OP_ID = log.UserID
                                //        });
                                //        cargo.Piece = it.StockNum;
                                //        cargo.InPiece = it.StockNum;

                                //        outHouseList.Add(cargo);
                                //        item.Numbers = item.Numbers - it.StockNum;
                                //        continue;
                                //    }
                                //    #endregion
                                //}
                                #endregion
                            }
                            else
                            {
                                long ProductID = product.AddCargoProduct(item);

                                CargoContainerGoodsEntity containerGoodsEntity = new CargoContainerGoodsEntity();
                                containerGoodsEntity.ContainerID = item.ContainerID;
                                containerGoodsEntity.TypeID = item.TypeID;
                                containerGoodsEntity.ProductID = ProductID;
                                containerGoodsEntity.Piece = item.Numbers;
                                containerGoodsEntity.Weight = 0;
                                containerGoodsEntity.IsPrintInCargo = false;
                                containerGoodsEntity.InHouseType = "0";
                                containerGoodsEntity.InCargoID = item.InCargoID;
                                house.AddContainerGoods(containerGoodsEntity);
                                //保存入库单表
                                house.AddInContainerGoods(containerGoodsEntity);
                                //修改货位上的产品件数
                                house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = item.ContainerID, InPiece = item.Numbers, IsAdd = true });
                                //修改产品的入库状态 
                                product.UpdateCargoProductStatus(new CargoProductEntity { ProductID = ProductID, InCargoStatus = "1" });
                            }
                            goods.Add(new CargoOrderGoodsEntity { Batch = item.Batch, ActSalePrice = item.UnitPrice, PurchaserID = item.PurchaserID, PurchaserName = item.PurchaserName, OP_ID = item.OPID, HouseID = item.HouseID, OrderNo = item.OrderNo, Specs = item.Specs, Figure = item.Figure, Model = item.Model, GoodsCode = item.GoodsCode, TypeID = item.TypeID, Born = item.Born, LoadIndex = item.LoadIndex, SpeedLevel = item.SpeedLevel, ConfirmSalePrice = item.SalePrice });
                        }
                        man.UpdatePurchaserOrderGoodsSalePrice(goods);
                        man.UpdatePurchaserOrderNo(NewOrderNo, order.OrderNo, TransportFee, order.PurchaserID);
                        entity[index].OrderNo = NewOrderNo;
                        order.OrderNo = NewOrderNo;
                        //获取订单产品数量
                        List<CargoOrderGoodsEntity> goodsList = QueryPreOrderGoodsInfo(order.OrderNo);
                        if (goodsList == null) { return; }
                        foreach (var good in goodsList)
                        {
                            int num = good.Piece;
                            //根据条件查询所有产品
                            List<CargoProductEntity> productList = QueryPreOrderProductInfo(new CargoProductEntity { Specs = good.Specs, Figure = good.Figure, Model = good.Model, GoodsCode = good.GoodsCode, Batch = good.Batch, Born = good.Born, TypeID = good.TypeID, SpeedLevel = good.SpeedLevel, LoadIndex = good.LoadIndex });

                            foreach (var pro in productList)
                            {
                                if (pro.Numbers >= num)
                                {
                                    man.OesPreOrderGoodsConfirm(new CargoOrderGoodsEntity { OrderNo = good.OrderNo, ProductID = pro.ProductID, HouseID = pro.HouseID, AreaID = pro.AreaID, ContainerCode = pro.ContainerCode, Piece = num, GoodsCode = good.GoodsCode, ActSalePrice = pro.SalePrice });

                                    //修改入库单的在货位件数
                                    house.UpdateCargoContainerGoodsPiece(new CargoContainerGoodsEntity { ID = pro.ContainerGoodsID, Piece = num, IsAdd = false });

                                    house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = pro.ContainerID, InPiece = num, IsAdd = false });

                                    break;
                                }
                                else
                                {
                                    man.OesPreOrderGoodsConfirm(new CargoOrderGoodsEntity { OrderNo = good.OrderNo, ProductID = pro.ProductID, HouseID = pro.HouseID, AreaID = pro.AreaID, ContainerCode = pro.ContainerCode, Piece = pro.Numbers, GoodsCode = good.GoodsCode, ActSalePrice = pro.SalePrice });

                                    //修改入库单的在货位件数
                                    house.UpdateCargoContainerGoodsPiece(new CargoContainerGoodsEntity { ID = pro.ContainerGoodsID, Piece = pro.Numbers, IsAdd = false });

                                    house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = pro.ContainerID, InPiece = pro.Numbers, IsAdd = false });

                                    num -= pro.Numbers;
                                }
                            }
                        }

                        man.OesPreOrderConfirm(order);

                        log.Memo = "采购订单号：" + order.OrderNo + "，出发站：" + order.Dep + "，到达站：" + order.Dest + "，件数：" + order.Piece.ToString() + "，费用：" + order.TotalCharge.ToString() + "，收货人：" + order.AcceptPeople + "，电话：" + order.AcceptTelephone + "/" + order.AcceptCellphone + "，制单人：" + order.CreateAwb + "，制单时间：" + order.CreateDate.ToString("yyyy-MM-dd HH:mm:ss") + "，业务员：" + order.SaleManName + "，物流公司名称：" + order.LogisticName + "，物流公司单号：" + order.LogisAwbNo;
                        lw.WriteLog(log);
                        index++;
                    }
                    scope.Complete();
                }
                foreach (var it in entity)
                {
                    int oldPurchaserID = 0;
                    List<CargoProductEntity> PurchaserList = it.productsList;
                    foreach (var Purchaser in PurchaserList)
                    {
                        if (oldPurchaserID == 0)
                        {
                            oldPurchaserID = Purchaser.PurchaserID;
                        }
                        else if (oldPurchaserID == Purchaser.PurchaserID)
                        {
                            break;
                        }
                        List<CargoPurchaserEntity> purchaser = client.AutoCompletePurchaser(new CargoPurchaserEntity { PurchaserID = Convert.ToInt64(Purchaser.PurchaserID) });
                        if (purchaser.Count > 0)
                        {
                            man.SaveHlyOesOrderData(new CargoPurchaserEntity { OrderNo = it.OrderNo, Piece = it.Piece.ToString(), CheckOutName = purchaser[0].PurchaserType == 0 ? "现结" : "月结", PurchaserName = purchaser[0].PurchaserName, Address = purchaser[0].Address, Boss = purchaser[0].Boss, Telephone = purchaser[0].Telephone, PurchaserStatus = "0", Remark = it.Remark });

                            foreach (var item in it.productsList)
                            {
                                item.OrderNo = it.OrderNo;
                                if (item.Born == "0")
                                {
                                    item.Born = "国产";
                                }
                                else
                                {
                                    item.Born = "进口";
                                }
                                man.SaveHlyOesOrderGoodsData(item);

                            }
                        }
                    }

                    List<CargoContainerShowEntity> orderContainerList = QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = it.OrderNo });
                    CargoOrderEntity order = QueryOrderInfo(it);
                    SaveHlyOrderData(orderContainerList, order);
                }
            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "确认采购订单失败，失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }
        }
        public void CancelPurchaserOrder(List<CargoOrderEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    foreach (var item in entity)
                    {
                        man.CancelPurchaserOrder(item);
                        log.Memo = "取消采购订单";
                        lw.WriteLog(item, log);
                    }

                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "采购订单取消失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        #endregion
        #region 补货单方法集合
        public void TryUpdateOutOfStock(UpdateOOSParam entity)
        {
            LogEntity log = new LogEntity();
            log.Moudle = "补库清单";
            log.Status = "0";
            log.NvgPage = "更新补库清单";
            log.UserID = entity.UserID ?? _userid;
            log.Operate = "U";
            log.IPAddress = _ipaddress;
            LogBus lw = new LogBus();
            try
            {
                //添加默认更改说明
                if (string.IsNullOrWhiteSpace(entity.Reason))
                {
                    string reasonTag = entity.ReasonTag;
                    switch (reasonTag)
                    {
                        case "SO":
                            entity.Reason = "销售单触发更新";
                            break;
                        case "RO":
                            entity.Reason = "补库订单触发更新";
                            break;
                        case "RF":
                            entity.Reason = "手动更新";
                            break;
                    }
                }

                var addedList = man.UpdtOutOfStock(entity);
                var dataParamsJson = JsonConvert.SerializeObject(entity);
                if (addedList.Any())
                {
                    var addedListJson = JsonConvert.SerializeObject(addedList);
                    log.Memo = $"已更新补库清单；创建数据参数：{dataParamsJson}；生成返回数据：{addedListJson}";
                }
                else
                {
                    log.Memo = $"未更新补库清单；创建数据参数：{dataParamsJson}";
                }
                lw.InsertLog(log);
            }
            catch (Exception ex)
            {
                log.Status = "1";
                log.Memo = ex.FormatErr();
                lw.InsertLog(log);
            }
        }
        public CargoRplOrderListDto QueryRplOrder(CargoRplOrderParams queryParams)
        {
            CargoRplOrderListDto rtData = new CargoRplOrderListDto();
            rtData = man.QueryRplOrder(queryParams);
            return rtData;
        }
        public CargoRplOrderGoodsListDto QueryRplOrderGoods(CargoRplOrderGoodsListDto entity)
        {
            var rtData = man.QueryRplOrderGoods(entity);
            return rtData;
        }
        public List<CargoRplOrderExcelModel> GetRplOrderExcel(CargoRplOrderParams queryParams)
        {
            var rtData = man.GetRplOrderExcel(queryParams);
            return rtData;
        }
        public DataRespsBase<CargoRplOrderDtlDto> AddRplOrder(CargoRplOrderDtlDto entity)
        {
            LogEntity log = new LogEntity();
            log.Moudle = "补货单";
            log.Status = "0";
            log.NvgPage = "新增补货单";
            log.Operate = "A";
            log.IPAddress = _ipaddress;
            log.UserID = _userid;
            DataRespsBase<CargoRplOrderDtlDto> rtData = new DataRespsBase<CargoRplOrderDtlDto>();
            LogBus lw = new LogBus();
            try
            {
                entity.UserID = _userid;
                entity.UserName = _username;
                entity.Piece = entity.Rows.Sum(c => c.ConfirmPiece.HasValue ? c.ConfirmPiece.Value : 0);

                rtData.Data = man.AddRplOrder(entity);
                var dataParamsJson = JsonConvert.SerializeObject(entity);
                if (rtData?.Data != null)
                {
                    var rtDataJson = JsonConvert.SerializeObject(rtData);
                    rtData.Message = "创建补货单成功";
                    log.Memo = $"创建补货单成功；数据参数：{dataParamsJson}；返回数据：{rtDataJson}";

                    //更新缺货数据

                    UpdateOOSParam oosParams = new UpdateOOSParam()
                    {
                        UserID = _userid,
                        UserName = _username,
                        SrcType = 3,
                        ReasonTag = "RO",
                        SrcID = rtData.Data.RplID,
                        SrcCode = rtData.Data.RplNo,
                        Rows = rtData.Data.Rows.Select(r => new UpdateOOSGoodsParam
                        {
                            ProductCode = r.ProductCode,
                            HouseID = rtData.Data.FromHouse.Value
                        }).ToList()
                    };

                    TryUpdateOutOfStock(oosParams);
                }
                else
                {
                    rtData.Message = "创建补货单失败";
                    log.Memo = $"创建补货单失败；数据参数：{dataParamsJson}";
                }
                lw.InsertLog(log);
            }

            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = ex.FormatErr();
                rtData.Success = false;
                rtData.Message = ex.Message;
                lw.InsertLog(log);
                return rtData;
            }
            catch (Exception ex)
            {
                log.Status = "1";
                log.Memo = ex.FormatErr();
                rtData.Success = false;
                rtData.Message = "后端内部异常：" + ex.Message;
                lw.InsertLog(log);
                return rtData;
            }
            return rtData;
        }
        public bool CancelRplOrder(int[] RplIDs)
        {
            if (RplIDs == null || !RplIDs.Any())
            {
                return true;
            }
            LogEntity log = new LogEntity();
            log.Moudle = "补货单";
            log.Status = "0";
            log.NvgPage = "作废补货单";
            log.UserID = _userid;
            log.IPAddress = _ipaddress;
            log.Operate = "U";
            LogBus lw = new LogBus();
            try
            {
                man.CancelRplOrder(RplIDs, _userid, _username);
                return true;
            }
            catch (Exception ex)
            {
                log.Status = "1";
                log.Memo = ex.FormatErr();
                lw.InsertLog(log);
                return false;
            }
        }


        public CargoOutOfStockListDto QueryOutOfStocks(CargoOutOfStockParams queryParams)
        {
            var rtData = man.QueryOutOfStocks(queryParams);
            return rtData;
        }

        public DataRespsBase<UpdateOOSParam> UpdtOOSByHouse(int? HouseID)
        {
            LogEntity log = new LogEntity();
            log.Moudle = "补货单";
            log.Status = "0";
            log.NvgPage = "更新缺货数据";
            log.Operate = "U";
            log.IPAddress = _ipaddress;
            log.UserID = _userid;
            DataRespsBase<UpdateOOSParam> rtData = new DataRespsBase<UpdateOOSParam>();
            LogBus lw = new LogBus();
            try
            {
                rtData.Data = man.UpdtOOSByHouse(HouseID, _userid, _username);
                var dataParamsJson = JsonConvert.SerializeObject(new { HouseID });
                if (rtData?.Data != null)
                {
                    var rtDataJson = JsonConvert.SerializeObject(rtData);
                    rtData.Message = "更新缺货数据成功";
                    log.Memo = $"更新缺货数据成功；数据参数：{dataParamsJson}；返回数据：{rtDataJson}";
                }
                else
                {
                    rtData.Message = "更新缺货数据失败";
                    log.Memo = $"更新缺货数据失败；数据参数：{dataParamsJson}";
                }
                lw.InsertLog(log);
            }
            catch (Exception ex)
            {
                log.Status = "1";
                log.Memo = ex.FormatErr();
                rtData.Success = false;
                rtData.Message = "更新缺货数据失败，失败信息：" + ex.Message;
                lw.InsertLog(log);
                return rtData;
            }
            return rtData;
        }
        #endregion
        #region 来货单
        public void AddPurchaseOrderInfo(CargoOrderEntity entity, List<CargoProductEntity> productList, List<CargoFactoryOrderEntity> factoryList, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoFactoryOrderManager facMan = new CargoFactoryOrderManager();
            CargoProductManager product = new CargoProductManager();
            CargoHouseManager house = new CargoHouseManager();
            try
            {
                if (entity.TrafficType != "3")
                {
                    man.AddPurchaseOrderInfo(entity, productList);
                    facMan.SaveData(factoryList);
                    log.Memo = "保存来货单";
                    lw.WriteLog(entity, log);
                }
                else
                {
                    //使用事务
                    using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                    {
                        man.AddPurchaseOrderInfo(entity, productList);
                        facMan.SaveData(factoryList);
                        foreach (var item in factoryList)
                        {
                            long ProductID = product.AddCargoProduct(new CargoProductEntity
                            {
                                ProductName = item.ProductName,
                                TypeID = item.TypeID,
                                Model = item.Model,
                                GoodsCode = item.GoodsCode,
                                Specs = item.Specs,
                                Figure = item.Figure,
                                LoadIndex = item.LoadIndex,
                                SpeedLevel = item.SpeedLevel,
                                UnitPrice = Convert.ToDecimal(item.UnitPrice),
                                Numbers = item.OrderNum,
                                HubDiameter = item.HubDiameter,
                                FinalCostPrice = Convert.ToDecimal(item.UnitPrice),
                                CostPrice = Convert.ToDecimal(item.CostPrice),
                                TaxCostPrice = Convert.ToDecimal(item.CostPrice),
                                NoTaxCostPrice = Convert.ToDecimal(item.CostPrice),
                                TradePrice = Convert.ToDecimal(item.TradePrice),
                                SalePrice = Convert.ToDecimal(item.SalePrice),
                                Batch = item.Batch,
                                BatchWeek = item.BatchWeek,
                                BatchYear = item.BatchYear,
                                HouseID = item.HouseID,
                                Source = item.Source.ToString(),
                                SourceOrderNo = item.FacOrderNo,
                                BelongMonth = item.BelongMonth,
                                Born = item.Born,
                                Assort = item.Assort,
                                BelongDepart = item.BelongDepart,
                                Company = item.Company,
                                SpecsType = item.SpecsType,
                                OperaType = "0",
                                Package = item.ProductUnit,
                                PackageNum = item.BundleNum,
                                ProductCode = item.ProductCode,
                                Size = "",
                                Meridian = "",
                                Supplier = item.Supplier
                            });

                            CargoContainerGoodsEntity containerGoodsEntity = new CargoContainerGoodsEntity();
                            containerGoodsEntity.ContainerID = item.ContainerID;
                            containerGoodsEntity.TypeID = item.TypeID;
                            containerGoodsEntity.ProductID = ProductID;
                            containerGoodsEntity.Piece = item.OrderNum;
                            containerGoodsEntity.Weight = 0;
                            containerGoodsEntity.IsPrintInCargo = false;
                            containerGoodsEntity.InHouseType = "0";
                            containerGoodsEntity.InCargoID = item.InCargoID;
                            house.AddContainerGoods(containerGoodsEntity);
                            //保存入库单表
                            house.AddInContainerGoods(containerGoodsEntity);
                            //修改货位上的产品件数
                            house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = item.ContainerID, InPiece = item.OrderNum, IsAdd = true });
                            //修改产品的入库状态 
                            product.UpdateCargoProductStatus(new CargoProductEntity { ProductID = ProductID, InCargoStatus = "1" });
                            log.Memo = "来货单产品入库，产品编码：" + item.ProductCode + "，数量：" + item.OrderNum + "，销售价：" + item.SalePrice + "，供应商名称：" + item.Supplier + "，供应商编码：" + item.SuppClientNum + "，产品ID：" + ProductID + "，产品类型ID：" + item.TypeID + "，仓库：" + item.HouseID + "，批次：" + item.Batch;
                            lw.WriteLog(log);
                        }
                        log.Memo = "保存来货单";
                        lw.WriteLog(entity, log);
                        scope.Complete();
                    }
                }
            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "新增订单失败，失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }
        }

        public void UpdateArrivalOrderData(CargoOrderEntity entity, List<CargoProductEntity> productList, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                man.UpdatePurchaseOrderInfo(entity);
                foreach (var it in productList)
                {
                    if (it.InPiece.Equals(0))
                    {
                        man.DeletePurchaseOrderGood(it);
                    }
                    else
                    {
                        man.UpdatePurchaseOrderGoods(it);
                    }
                }

                log.Memo = "修改来货单,供应商：" + entity.AcceptUnit + ",总数量:" + entity.Piece.ToString();
                lw.WriteLog(log);
                scope.Complete();
            }
        }

        public void UpdatePurchaseOrderFee(CargoOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    CargoOrderEntity order = man.QueryOesOrderInfoByOrderID(entity.OrderID);
                    Decimal price = Math.Round((entity.HandFee + entity.TransitFee) / order.Piece, 2, MidpointRounding.AwayFromZero);
                    man.UpdatePurchaseOrderFee(new CargoOrderEntity { TransitFee = entity.TransitFee, HandFee = entity.HandFee, OP_ID = entity.OP_ID, HouseID = order.HouseID, OrderID = entity.OrderID });
                    if (order.TrafficType == "0")
                    {
                        man.UpdatePurchaseOrderFactoryOrderCostPrice(new CargoFactoryOrderEntity { CostPrice = Convert.ToDouble(price), OP_Name = entity.OP_Name, HouseID = order.HouseID, FacOrderNo = order.FacOrderNo });
                    }
                    else if (order.TrafficType == "3")
                    {
                        man.UpdatePurchaseOrderProductCostPrice(new CargoProductEntity { CostPrice = price, OPID = entity.OP_ID, HouseID = order.HouseID, SourceOrderNo = order.FacOrderNo });
                    }
                    log.Memo = "修改进货单价格，配送费：" + entity.TransitFee + "，卸货费：" + entity.HandFee + "，来货单数量：" + order.Piece + "，平均分摊成本：" + price + "，修改人ID：" + entity.OP_ID + "，修改人姓名：" + entity.OP_Name;
                    lw.WriteLog(entity, log);

                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 查询进货单数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryPurchaseOrderInfo(int pIndex, int pNum, CargoOrderEntity entity)
        {
            return man.QueryPurchaseOrderInfo(pIndex, pNum, entity);
        }
        public List<CargoProductEntity> QueryPurchaseOrderByOrderID(CargoOrderEntity entity)
        {
            return man.QueryPurchaseOrderByOrderID(entity);
        }
        /// <summary>
        /// 导出进仓单及明细
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable ExportPurchaseOrders(int pIndex, int pNum, CargoOrderEntity entity)
        {
            return man.ExportPurchaseOrderDto(pIndex, pNum, entity);
        }
        public void DelPurchaseOrder(List<CargoOrderEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();

            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                foreach (var it in entity)
                {
                    man.DelPurchaseOrder(it);
                    log.Memo = "删除进仓单：订单ID：" + it.OrderID + "，所属仓库：" + it.HouseID + "，件数：" + it.Piece.ToString() + "，费用：" + it.TotalCharge.ToString() + "，进货单号：" + it.FacOrderNo;
                    lw.WriteLog(log);
                }
                scope.Complete();
            }
        }
        public List<CargoOrderReturnOrderEntity> QueryOesOrderInfoForReturn(CargoOrderReturnOrderEntity entity)
        {
            return man.QueryOesOrderInfoForReturn(entity);
        }

        public CargoOrderEntity QueryOesOrderInfoByOrderID(Int64 orderID)
        {
            return man.QueryOesOrderInfoByOrderID(orderID);
        }
        public void AddReturnOesOrderInfo(CargoOrderEntity entity, List<CargoProductEntity> productList, List<CargoProductEntity> goodsList, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoHouseManager house = new CargoHouseManager();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    log.Memo = "进货单退货：退货件数：" + entity.Piece.ToString() + "，退货费用：" + entity.TotalCharge.ToString() + "，退货客户：" + entity.AcceptPeople + "，电话：" + entity.AcceptTelephone + "/" + entity.AcceptCellphone + "，制单人：" + entity.CreateAwb + "，制单时间：" + entity.CreateDate.ToString("yyyy-MM-dd HH:mm:ss");
                    if (entity.TrafficType == "3")
                    {
                        foreach (var goods in goodsList)
                        {
                            log.Memo += "，产品ID：" + goods.ProductID + "，规格：" + goods.Specs + "，花纹：" + goods.Figure + "，型号：" + goods.Model + "，货品代码：" + goods.GoodsCode + "，载重：" + goods.LoadIndex + "，速度：" + goods.SpeedLevel + "，批次：" + goods.Batch + "，产地：" + goods.Born + "，类型：" + goods.TypeID + "，数量：" + goods.InPiece;
                            //修改入库单的在货位件数
                            house.UpdateCargoContainerGoodsPiece(new CargoContainerGoodsEntity { ID = goods.ContainerGoodsID, Piece = goods.InPiece, IsAdd = false });
                            house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = goods.ContainerID, InPiece = goods.InPiece, IsAdd = false });
                        }
                    }
                    entity.TrafficType = "2";
                    man.AddPurchaseOrderInfo(entity, productList);

                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增退货单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }

        }
        public CargoContainerGoodsEntity SelectOesrderProductPiece(CargoProductEntity entity)
        {
            return man.SelectOesrderProductPiece(entity);
        }
        /// <summary>
        /// 删除订单信息
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void DelArrivalOrderData(List<CargoOrderEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            try
            {
                //使用事务
                using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                {
                    foreach (var it in entity)
                    {
                        //1.删除订单数据
                        //2.查询订单与产品关联数据
                        //3.删除订单与产品关联数据
                        //删除订单数据
                        man.DeletePurchaseOrderInfo(it);
                        //删除订单与产品关联数据
                        man.DeletePurchaseOrderGoodsInfo(new List<CargoFactoryOrderEntity> { new CargoFactoryOrderEntity { OrderID = it.OrderID, FacOrderNo = it.FacOrderNo } });
                        log.Memo = "来货单号：" + it.OrderID.ToString() + "，数量：" + it.Piece.ToString() + "，收货人：" + it.AcceptPeople + "，电话：" + it.AcceptTelephone + "/" + it.AcceptCellphone + "，来货单号:" + it.FacOrderNo;
                        lw.WriteLog(log);
                    }
                    scope.Complete();
                }
            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }
        }
        #endregion
        #region 缺货列表
        /// <summary>
        /// 查询缺货列表数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryShortageListInfo(int pIndex, int pNum, ShortageListEntity entity)
        {
            return man.QueryShortageListInfo(pIndex, pNum, entity);
        }
        /// <summary>
        /// 通过客户编码查询缺货列表数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<ShortageListEntity> QueryShortageListByClientNum(ShortageListEntity entity)
        {
            return man.QueryShortageListByClientNum(entity);
        }
        /// <summary>
        /// 新增缺货数据
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="log"></param>
        public void InsertShortageList(ShortageListEntity entity, LogEntity log)
        {
            LogWrite<ShortageListEntity> lw = new LogWrite<ShortageListEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.InsertShortageList(entity);
                    log.Memo = "添加缺货列表：客户编码：" + entity.ClientNum.ToString() + "，所属仓库：" + entity.HouseID.ToString() + "，产品类型：" + entity.TypeID.ToString() + "，产品名称：" + entity.TypeName.ToString() + "，规格：" + entity.Specs.ToString() + "，花纹：" + entity.Figure.ToString() + "，型号：" + entity.Model.ToString() + "，货品代码：" + entity.GoodsCode.ToString() + "，载重指数：" + entity.LoadIndex.ToString() + "，速度级别：" + entity.SpeedLevel.ToString() + "，产地：" + entity.Born.ToString() + "，数量：" + entity.Piece.ToString() + ",操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "添加缺货列表，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        public void DeleteShortageList(ShortageListEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.DeleteShortageList(entity);
                    log.Memo = "删除缺货列表：客户编码：" + entity.ClientNum.ToString() + "，产品类型：" + entity.TypeID.ToString() + "，产品名称：" + entity.TypeName.ToString() + "，规格：" + entity.Specs.ToString() + "，花纹：" + entity.Figure.ToString() + "，型号：" + entity.Model.ToString() + "，货品代码：" + entity.GoodsCode.ToString() + "，载重指数：" + entity.LoadIndex.ToString() + "，速度级别：" + entity.SpeedLevel.ToString() + "，产地：" + entity.Born.ToString() + "，数量：" + entity.Piece.ToString() + ",操作时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "删除缺货列表，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 查詢當天到货入库数据与缺货清单匹配
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<ShortageListEntity> QueryCurrDayArrivalData(ShortageListEntity entity)
        {
            return man.QueryCurrDayArrivalData(entity);
        }
        #endregion
        #region 工厂进货 
        public void AddFactoryPurchaseOrderInfo(CargoFactoryPurchaseOrderEntity entity, List<CargoFactoryPurchaseOrderGoodsEntity> productList, LogEntity log)
        {
            LogWrite<CargoOrderPushEntity> lw = new LogWrite<CargoOrderPushEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.AddFactoryPurchaseOrderInfo(entity, productList);
                    log.Memo = "新增工厂进货数据，进货单号：" + entity.OrderNo + "，总数量：" + entity.Piece + "，总金额：" + entity.TotalCharge + "，详细产品：";
                    foreach (CargoFactoryPurchaseOrderGoodsEntity item in productList)
                    {
                        log.Memo += "品牌：" + item.TypeName + "，规格：" + item.Specs + "，花纹：" + item.Figure + "，货品代码：" + item.GoodsCode + "，载速：" + item.LoadIndex + item.SpeedLevel + "，数量：" + item.Piece + "，进货价：" + item.UnitPrice;
                    }
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增工厂进货数据，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        public Hashtable QueryFactoryPurchaseOrderListInfo(int pIndex, int pNum, CargoFactoryPurchaseOrderEntity entity)
        {
            return man.QueryFactoryPurchaseOrderListInfo(pIndex, pNum, entity);
        }
        public CargoFactoryPurchaseOrderEntity QueryFactoryPurchaseOrderInfo(CargoFactoryPurchaseOrderEntity entity)
        {
            return man.QueryFactoryPurchaseOrderInfo(entity);
        }
        public List<CargoFactoryPurchaseOrderGoodsEntity> QueryFactoryPurchaseOrderGoods(CargoFactoryPurchaseOrderEntity entity)
        {
            return man.QueryFactoryPurchaseOrderGoods(entity);
        }
        public void DeleteFactoryPurchaseOrderInfo(List<CargoFactoryPurchaseOrderEntity> List, LogEntity log)
        {
            LogWrite<CargoFactoryPurchaseOrderEntity> lw = new LogWrite<CargoFactoryPurchaseOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    foreach (CargoFactoryPurchaseOrderEntity entity in List)
                    {
                        man.DeleteFactoryPurchaseOrderInfo(entity);
                        log.Memo = "删除工厂订货数据：订单编号：" + entity.OrderNo.ToString() + "，数量：" + entity.Piece.ToString() + "，金额：" + entity.TotalCharge.ToString();
                        lw.WriteLog(log);
                    }
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "删除工厂订货数据，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        public void AddFactoryPurchaseOrderGoods(CargoFactoryPurchaseOrderGoodsEntity entity, LogEntity log)
        {
            LogWrite<CargoFactoryPurchaseOrderGoodsEntity> lw = new LogWrite<CargoFactoryPurchaseOrderGoodsEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.AddFactoryPurchaseOrderGoods(entity);
                    man.UpdateFactoryPurchaseOrder(new CargoFactoryPurchaseOrderEntity { OrderID = entity.OrderID, OrderNo = entity.OrderNo, Piece = entity.Piece, TotalCharge = entity.Piece * entity.UnitPrice });
                    log.Memo = "新增工厂订货产品数据，订单号：" + entity.OrderNo + "，品牌：" + entity.TypeName + "，规格：" + entity.Specs + "，花纹：" + entity.Figure + "，货品代码：" + entity.GoodsCode + "，载速：" + entity.LoadIndex + entity.SpeedLevel + "，数量：" + entity.Piece;
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增工厂订货产品数据，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        public void UpdateFactoryPurchaseOrderGoodsPiece(CargoFactoryPurchaseOrderGoodsEntity entity, LogEntity log)
        {
            LogWrite<CargoFactoryPurchaseOrderGoodsEntity> lw = new LogWrite<CargoFactoryPurchaseOrderGoodsEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateFactoryPurchaseOrderGoodsPiece(entity);
                    man.UpdateFactoryPurchaseOrder(new CargoFactoryPurchaseOrderEntity { OrderID = entity.OrderID, OrderNo = entity.OrderNo, Piece = entity.Piece - entity.OldPiece, TotalCharge = (entity.Piece - entity.OldPiece) * entity.UnitPrice });
                    log.Memo = "修改工厂订货产品数量，订单号：" + entity.OrderNo + "，品牌：" + entity.TypeName + "，规格：" + entity.Specs + "，花纹：" + entity.Figure + "，货品代码：" + entity.GoodsCode + "，载速：" + entity.LoadIndex + entity.SpeedLevel + "，数量：" + entity.Piece;
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改工厂订货产品数量，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        public void DeleteFactoryPurchaseOrderGoods(CargoFactoryPurchaseOrderGoodsEntity entity, LogEntity log)
        {
            LogWrite<CargoFactoryPurchaseOrderEntity> lw = new LogWrite<CargoFactoryPurchaseOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.DeleteFactoryPurchaseOrderGoods(entity);
                    man.UpdateFactoryPurchaseOrder(new CargoFactoryPurchaseOrderEntity { OrderID = entity.OrderID, OrderNo = entity.OrderNo, Piece = entity.Piece - entity.OldPiece, TotalCharge = (entity.Piece - entity.OldPiece) * entity.UnitPrice });
                    log.Memo = "删除工厂订货产品数据：订单编号：" + entity.OrderID.ToString() + "，品牌：" + entity.TypeName.ToString() + "，规格：" + entity.Specs.ToString() + "，花纹：" + entity.Figure.ToString() + "，货品代码：" + entity.GoodsCode.ToString() + "，载速：" + entity.LoadIndex.ToString() + entity.SpeedLevel.ToString() + "，数量：" + entity.Piece.ToString();
                    lw.WriteLog(log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "删除工厂订货产品数据，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        public void UpdateFactoryPurchaseOrder(CargoFactoryPurchaseOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoFactoryPurchaseOrderEntity> lw = new LogWrite<CargoFactoryPurchaseOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.UpdateFactoryPurchaseOrder(entity);
                    log.Memo = "修改工厂订货单信息，订单号：" + entity.OrderNo + "，备注：" + entity.Remark;
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "修改工厂订货单信息，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        public void SubmitFactoryPurchaseOrderReview(CargoFactoryPurchaseOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoFactoryPurchaseOrderEntity> lw = new LogWrite<CargoFactoryPurchaseOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.SubmitFactoryPurchaseOrderReview(entity);
                    log.Memo = "提交工厂订货单审批，订单号：" + entity.OrderNo + "，备注：" + entity.Remark;
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "提交工厂订货单审批，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        public void CheckFactoryPurchaseOrder(CargoFactoryPurchaseOrderEntity entity, LogEntity log)
        {
            LogWrite<CargoFactoryPurchaseOrderEntity> lw = new LogWrite<CargoFactoryPurchaseOrderEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.CheckFactoryPurchaseOrder(entity);
                    log.Memo = "审批工厂订货单，订单号：" + entity.OrderNo + "，审批状态：" + entity.ApplyStatus + "，审批意见：" + entity.CheckResult;
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "审批工厂订货单，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        #endregion
        #region 

        public void ConfirmReceipt(List<CargoOrderEntity> orderList, List<CargoFactoryOrderEntity> factoryList, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoProductManager product = new CargoProductManager();
            CargoHouseManager house = new CargoHouseManager();
            try
            {
                //使用事务
                using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                {
                    foreach (var item in orderList)
                    {
                        man.UpdateAwbStatusByOrderNo(0, item.OrderNo, "8", "", "", "0");
                    }
                    foreach (var item in factoryList)
                    {
                        long ProductID = product.AddCargoProduct(new CargoProductEntity
                        {
                            ProductName = item.ProductName,
                            TypeID = item.TypeID,
                            Model = item.Model,
                            GoodsCode = item.GoodsCode,
                            Specs = item.Specs,
                            Figure = item.Figure,
                            LoadIndex = item.LoadIndex,
                            SpeedLevel = item.SpeedLevel,
                            UnitPrice = Convert.ToDecimal(item.UnitPrice),
                            Numbers = item.OrderNum,
                            FinalCostPrice = Convert.ToDecimal(item.UnitPrice),
                            CostPrice = Convert.ToDecimal(item.CostPrice),
                            TaxCostPrice = Convert.ToDecimal(item.CostPrice),
                            NoTaxCostPrice = Convert.ToDecimal(item.CostPrice),
                            TradePrice = Convert.ToDecimal(item.TradePrice),
                            SalePrice = Convert.ToDecimal(item.SalePrice),
                            Batch = item.Batch,
                            BatchWeek = item.BatchWeek,
                            BatchYear = item.BatchYear,
                            HouseID = item.HouseID,
                            Source = item.Source.ToString(),
                            SourceOrderNo = item.FacOrderNo,
                            BelongMonth = item.BelongMonth,
                            Born = item.Born,
                            Assort = item.Assort,
                            BelongDepart = item.BelongDepart,
                            Company = item.Company,
                            SpecsType = item.SpecsType,
                            OperaType = "0",
                            Package = "条",
                            Size = "",
                            Meridian = "",
                            Supplier = item.Supplier
                        });

                        CargoContainerGoodsEntity containerGoodsEntity = new CargoContainerGoodsEntity();
                        containerGoodsEntity.ContainerID = item.ContainerID;
                        containerGoodsEntity.TypeID = item.TypeID;
                        containerGoodsEntity.ProductID = ProductID;
                        containerGoodsEntity.Piece = item.OrderNum;
                        containerGoodsEntity.Weight = 0;
                        containerGoodsEntity.IsPrintInCargo = false;
                        containerGoodsEntity.InHouseType = "0";
                        containerGoodsEntity.InCargoID = item.InCargoID;
                        house.AddContainerGoods(containerGoodsEntity);
                        //保存入库单表
                        house.AddInContainerGoods(containerGoodsEntity);
                        //修改货位上的产品件数
                        house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = item.ContainerID, InPiece = item.OrderNum, IsAdd = true });
                        //修改产品的入库状态 
                        product.UpdateCargoProductStatus(new CargoProductEntity { ProductID = ProductID, InCargoStatus = "1" });

                        log.Memo = "仓库到货订单确认，订单号：" + item.FacOrderNo + "，规格：" + item.Specs + "，花纹：" + item.Figure + "，货品代码：" + item.GoodsCode + "，数量：" + item.OrderNum + "，价格：" + item.UnitPrice;
                        lw.WriteLog(log);
                    }
                    scope.Complete();
                }
            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "新增订单失败，失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }
        }

        /// <summary>
        /// 移库单一键入库
        /// </summary>
        /// <param name="orderList"></param>
        /// <param name="factoryList"></param>
        /// <param name="log"></param>
        public void MoveOrderHandInCargo(List<CargoMoveOrderEntity> orderList, List<CargoFactoryOrderEntity> factoryList, LogEntity log)
        {
            LogWrite<CargoMoveOrderEntity> lw = new LogWrite<CargoMoveOrderEntity>();
            CargoProductManager product = new CargoProductManager();
            CargoHouseManager house = new CargoHouseManager();
            try
            {
                //使用事务
                using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                {
                    //1.修改移库单的状态 为已完成
                    foreach (var item in orderList)
                    {
                        man.UpdateMoveOrderStatus(new CargoMoveOrderEntity { MoveNo = item.MoveNo, MoveStatus = item.MoveStatus });
                    }
                    foreach (var item in factoryList)
                    {
                        long ProductID = product.AddCargoProduct(new CargoProductEntity
                        {
                            ProductName = item.ProductName,
                            TypeID = item.TypeID,
                            Model = item.Model,
                            GoodsCode = item.GoodsCode,
                            Specs = item.Specs,
                            Figure = item.Figure,
                            LoadIndex = item.LoadIndex,
                            SpeedLevel = item.SpeedLevel,
                            UnitPrice = Convert.ToDecimal(item.UnitPrice),
                            Numbers = item.OrderNum,
                            FinalCostPrice = Convert.ToDecimal(item.UnitPrice),
                            CostPrice = Convert.ToDecimal(item.CostPrice),
                            //TaxCostPrice = Convert.ToDecimal(item.CostPrice),
                            //NoTaxCostPrice = Convert.ToDecimal(item.CostPrice),
                            TradePrice = Convert.ToDecimal(item.TradePrice),
                            SalePrice = Convert.ToDecimal(item.SalePrice),
                            Batch = item.Batch,
                            BatchWeek = item.BatchWeek,
                            BatchYear = item.BatchYear,
                            HouseID = item.HouseID,
                            Source = item.Source.ToString(),
                            SourceOrderNo = item.FacOrderNo,
                            BelongMonth = item.BelongMonth,
                            Born = item.Born,
                            Assort = item.Assort,
                            BelongDepart = item.BelongDepart,
                            Company = item.Company,
                            SpecsType = item.SpecsType,
                            OperaType = "0",
                            Package = "条",
                            Size = "",
                            Meridian = "",
                            Supplier = item.Supplier
                        });

                        CargoContainerGoodsEntity containerGoodsEntity = new CargoContainerGoodsEntity();
                        containerGoodsEntity.ContainerID = item.ContainerID;
                        containerGoodsEntity.TypeID = item.TypeID;
                        containerGoodsEntity.ProductID = ProductID;
                        containerGoodsEntity.Piece = item.OrderNum;
                        containerGoodsEntity.Weight = 0;
                        containerGoodsEntity.IsPrintInCargo = false;
                        containerGoodsEntity.InHouseType = "0";
                        containerGoodsEntity.InCargoID = item.InCargoID;
                        house.AddContainerGoods(containerGoodsEntity);
                        //保存入库单表
                        house.AddInContainerGoods(containerGoodsEntity);
                        //修改货位上的产品件数
                        house.UpdateContainerInPiece(new CargoContainerEntity { ContainerID = item.ContainerID, InPiece = item.OrderNum, IsAdd = true });
                        //修改产品的入库状态 
                        product.UpdateCargoProductStatus(new CargoProductEntity { ProductID = ProductID, InCargoStatus = "1" });

                        log.Memo = "一键入库，移库单号：" + item.FacOrderNo + "，规格：" + item.Specs + "，花纹：" + item.Figure + "，货品代码：" + item.GoodsCode + "，数量：" + item.OrderNum + "，价格：" + item.UnitPrice;
                        lw.WriteLog(log);
                    }
                    scope.Complete();
                }
            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }
        }
        #endregion
        #region 

        public void AddOrderPickPlan(CargoOrderPickPlanEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderPickPlanEntity> lw = new LogWrite<CargoOrderPickPlanEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.AddOrderPickPlan(entity);
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增拣货计划失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        #endregion


        #region 拣货计划方法集合

        /// <summary>
        /// 查询拣货计划数据列表
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderPickPlanEntity> QueryOrderPickPlanList(CargoOrderPickPlanEntity entity)
        {
            return man.QueryOrderPickPlanList(entity);
        }
        public CargoOrderPickPlanEntity QueryOrderPickPlanInfo(string PickPlanNo)
        {
            return man.QueryOrderPickPlanInfo(PickPlanNo);
        }
        public List<CargoOrderPickPlanGoodsEntity> GetOrderPickPlanGoodsList(string PickPlanNo)
        {
            return man.GetOrderPickPlanGoodsList(PickPlanNo);
        }
        public List<CargoOrderPickPlanGoodsEntity> GetOrderPickPlanGoodsInfoList(CargoOrderPickPlanGoodsEntity entity)
        {
            return man.GetOrderPickPlanGoodsInfoList(entity);
        }
        public bool GetOrderPickPlanGoodsScanNum(CargoOrderPickPlanGoodsEntity entity)
        {
            return man.GetOrderPickPlanGoodsScanNum(entity);
        }
        public void UpdateOrderPickPlanGoodsScanStatus(List<CargoOrderPickPlanGoodsEntity> list, LogEntity log)
        {
            CargoInterfaceManager manInterface = new CargoInterfaceManager();
            LogWrite<CargoOrderPickPlanGoodsEntity> lw = new LogWrite<CargoOrderPickPlanGoodsEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    foreach (var entity in list)
                    {
                        man.UpdateOrderPickPlanGoodsScanStatus(entity);
                        man.SaveOrderStatus(new CargoOrderStatusEntity
                        {
                            OrderID = entity.OrderID,
                            OrderNo = entity.OrderNo,
                            OrderStatus = entity.OrderStatus,
                            WXOrderNo = "",
                            OP_ID = entity.OP_ID,
                            OP_Name = entity.OP_ID,
                            OP_DATE = DateTime.Now,
                            DetailInfo = ""
                        });
                        if (!string.IsNullOrEmpty(entity.ProductID))
                        {
                            manInterface.SetProductTag(new CargoProductTagEntity { OrderNo = entity.OrderNo, ProductID = Convert.ToInt64(entity.ProductID), TagCode = entity.TagCode, OutCargoStatus = "1", OutCargoOperID = entity.OP_ID });
                        }
                        log.Memo = "拣货计划扫描，拣货计划单：" + entity.PickPlanNo + "，货位代码：" + entity.ContainerCode + "，零件代码：" + entity.GoodsCode + "，扫描状态：" + entity.ScanStatus;
                        lw.WriteLog(entity, log);
                    }
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "拣货计划扫描，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        #endregion
        #region 捆包管理方法集合
        /// <summary>
        /// 获取当天捆包单的最大序号
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public int GetMaxBundleOrderNumByCurrentDate(CargoOrderBundleEntity entity)
        {
            return man.GetMaxBundleOrderNumByCurrentDate(entity);
        }
        /// <summary>
        /// 新增捆包单
        /// </summary>
        /// <param name="entity"></param>
        /// <exception cref="ApplicationException"></exception>
        public void AddBundleOrder(CargoOrderBundleEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderBundleEntity> lw = new LogWrite<CargoOrderBundleEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    man.AddBundleOrder(entity);
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 查询捆包单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoOrderBundleEntity QueryBundleOrderEntity(CargoOrderBundleEntity entity)
        {
            return man.QueryBundleOrderEntity(entity);
        }
        /// <summary>
        /// 保存捆包和扫描零件关联数据
        /// </summary>
        /// <param name="entity"></param>
        public void ScanProductTagBundle(CargoOrderBundleEntity entity, LogEntity log)
        {
            LogWrite<CargoOrderBundleEntity> lw = new LogWrite<CargoOrderBundleEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    if (man.IsExistBundleOrderGoods(entity))
                    {
                        //存在则更新数量
                        man.UpdateBundleOrderGoodsPiece(entity);
                    }
                    else
                    {
                        man.AddBundleGoods(entity);
                    }
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        /// <summary>
        /// 修改捆包单状态和数量
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateBundleOrderStatus(CargoOrderBundleEntity entity)
        {
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                man.UpdateBundleOrderStatus(entity);
                scope.Complete();
            }
        }

        #endregion
        #region 供应商进仓单
        public void AddPurchaseOrder(CargoOrderEntity entity, List<CargoProductEntity> productList, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            try
            { //使用事务
                using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
                {
                    man.AddPurchaseOrderInfo(entity, productList);
                    log.Memo = "保存进仓单";
                    lw.WriteLog(entity, log);
                    scope.Complete();
                }
            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }
        }
        #endregion

        #region 外部订单分配清单操作方法
        /// <summary>
        /// 查询外部订单分配清单数据方法
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public Hashtable QueryExterOrderAlloList(int pIndex, int pNum, CargoExterOrderAlloEntity entity)
        {
            return man.QueryExterOrderAlloList(pIndex, pNum, entity);
        }

        /// <summary>
        /// 新增外部订单分配清单
        /// </summary>
        /// <param name="entity"></param>
        /// <exception cref="ApplicationException"></exception>
        public void AddExterOrderAllo(CargoExterOrderAlloEntity entity, LogEntity log)
        {
            LogWrite<CargoExterOrderAlloEntity> lw = new LogWrite<CargoExterOrderAlloEntity>();
            //使用事务
            try
            {
                man.AddExterOrderAllo(entity);
                lw.WriteLog(entity, log);

            }
            catch (ApplicationException ex)
            {
                log.Status = "1";
                log.Memo = "失败信息：" + ex.Message;
                lw.WriteLog(log);
                throw;
            }

        }

        /// <summary>
        /// 修改外部订单分配清单
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateExterOrderAllo(CargoExterOrderAlloEntity entity)
        {
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                man.UpdateExterOrderAllo(entity);
                scope.Complete();
            }
        }

        #endregion
        #region 次日达数据操作方法集合

        public Hashtable QueryNextDayOrderInfo(int pIndex, int pNum, WXOrderEntity entity)
        {
            return man.QueryNextDayOrderInfo(pIndex, pNum, entity);
        }

        public List<CargoProductShelvesEntity> QueryNextDayOrderGoodsList(WXOrderEntity entity)
        {
            return man.QueryNextDayOrderGoodsList(entity);
        }

        #endregion

        #region 每日获取微信订单 生成日统计数据
        public void InsertDayWxOrder(string opid = null, DateTime? dt = null, DateTime? et = null)
        {
            //当月，按天统计
            string StartMonth = DateTime.Now.AddMonths(-1).ToString("yyyy-MM-01");
            string EndMonth = Convert.ToDateTime(StartMonth).AddMonths(2).AddDays(-1).ToString("yyyy-MM-dd");
            if (dt != null && et != null)
            {
                StartMonth = Convert.ToDateTime(dt).ToString("yyyy-MM-dd");
                EndMonth = Convert.ToDateTime(et).AddDays(1).AddMilliseconds(-1).ToString("yyyy-MM-dd HH:mm:ss");
            }
            man.InsertDayWxOrder(StartMonth, EndMonth, opid);
        }
        #endregion

        #region 获取品牌

        public List<CargoProductTypeEntity> QueryTypeData()
        {
            return man.QueryTypeData();
        }

        #endregion

        #region 获取SysUser
        public List<SystemUserEntity> GetSysUsers()
        {
            return man.GetSysUsers();
        }
        #endregion


        #region 每月和每日销量 生成静态化销量数据
        public void GenerateDailySalesSnapshot()
        {
            LogEntity log = new LogEntity();
            log.Moudle = "任务调度";
            log.Status = "0";
            log.NvgPage = "尝试生成本周静态化日销量数据";
            log.Operate = "A";
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            try
            {
                int effectedRow = man.GenerateDailySalesSnapshot();
                log.Memo = "受影响行数：" + effectedRow;
                lw.WriteLog(log);
            }
            catch (Exception ex)
            {
                log.Status = "1";
                log.Memo = ex.Message + " " + ex.StackTrace;
                lw.WriteLog(log);
                return;
            }
        }
        public void GenerateMonthlySalesSnapshot()
        {
            LogEntity log = new LogEntity();
            log.Moudle = "任务调度";
            log.Status = "0";
            log.NvgPage = "尝试生成上个月静态化平均销量数据";
            log.Operate = "A";
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            try
            {
                int effectedRow = man.GenerateMonthlySalesSnapshot();
                log.Memo = "受影响行数：" + effectedRow;
                lw.WriteLog(log);
            }
            catch (Exception ex)
            {
                log.Status = "1";
                log.Memo = ex.Message + " " + ex.StackTrace;
                lw.WriteLog(log);
                return;
            }
        }
        #endregion

        public List<HouseEntity> QueryCassMallHouse()
        {
            return man.QueryCassMallHouse();
        }




        public List<AvgMonthSalesData> GetAvgMonthSales(List<AvgMonthSalesData_qryParam> queryParams)
        {
            return man.GetAvgMonthSales(queryParams);
        }

        #region 预订单
        public Hashtable QueryReserveOrder(int pIndex, int pNum, ReserveCargoOrderEntity entity)
        {
            return man.QueryReserveOrder(pIndex, pNum, entity);
        }
        public List<CargoReserveOrderEntity> QueryReserveOrderInfoV2(CargoReserveOrderEntity entity)
        {
            return man.QueryReserveOrderInfoV2(entity);
        }
        public List<CargoReserveOrderEntity> QueryReserveOrderInfoV3(CargoReserveOrderEntity entity)
        {
            return man.QueryReserveOrderInfoV3(entity);
        }
        public List<CargoReserveOrderGoodsEntity> QueryReserveOrderGoods(CargoReserveOrderGoodsEntity entity)
        {
            return man.QueryReserveOrderGoods(entity);
        }
        public List<CargoReserveOrderPaymentRecordEntity> QueryReserveOrderPaymentRecord(CargoReserveOrderPaymentRecordEntity entity)
        {
            return man.QueryReserveOrderPaymentRecord(entity);
        }
        public List<CargoInterfaceEntity> QueryStockDetail(CargoInterfaceEntity entity)
        {
            return man.QueryStockDetail(entity);
        }
        public List<CargoInterfaceEntity> QueryStockHouse(CargoInterfaceEntity entity)
        {
            return man.QueryStockHouse(entity);
        }
        public List<CargoReserveProcurementOrderEntity> QueryReserveOrderAndProcureMent(CargoReserveProcurementOrderEntity entity)
        {
            return man.QueryReserveOrderAndProcureMent(entity);
        }
        public List<CargoReserveOrderEntity> QueryReserveOrderAndOrder(CargoReserveOrderEntity entity)
        {
            return man.QueryReserveOrderAndOrder(entity);
        }
        public List<CargoReserveOrderGoodsEntity> BatchQueryReserveOrderGoods(CargoReserveOrderEntity entity)
        {
            return man.BatchQueryReserveOrderGoods(entity);
        }

        /// <summary>
        /// 保存订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <param name="outHouseList"></param>
        /// <param name="log"></param>
        public void Reserve_AddOrderInfo(List<ReserveParam> param, LogEntity log)
        {
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            CargoHouseBus house = new CargoHouseBus();
            CargoClientManager client = new CargoClientManager();
            CargoWeiXinManager wxMan = new CargoWeiXinManager();
            CargoInterfaceManager interfaceManager = new CargoInterfaceManager();
            CargoFinanceManager cargoFinanceManager = new CargoFinanceManager();

            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    foreach (var item in param)
                    {
                        var entity = item.order;
                        var outHouseList = item.outHouseList;
                        //AddOrderInfo(item.order, item.outHouseList, log);
                        man.AddOrderInfo(entity);
                        house.saveOutCargoData(outHouseList, log);
                        //CargoClientEntity clientEnt = client.QueryCargoClient(entity.ClientNum, 0);
                        //if (!clientEnt.ClientID.Equals(0))
                        //{
                        //    if (clientEnt.ClientType.Equals("1") && entity.CheckOutType.Equals("2"))
                        //    {
                        //        //月结客户，月结订单，则减客户的月结额度
                        //        wxMan.UpdateClientLimitMoney(entity.TotalCharge, clientEnt.ClientNum, "1");
                        //    }
                        //}
                        //次日达重复支付
                        //if (entity.CheckOutType.Equals("10"))
                        //{
                        //    if (!string.IsNullOrEmpty(entity.WXOrderNo))
                        //    {
                        //        //预收款支付 进行扣款 并已支付成功，则修改订单状态为已结算
                        //        //保存客户预收款的扣款记录
                        //        client.UpdateClientPreRecord(new CargoClientPreRecordEntity
                        //        {
                        //            ClientID = clientEnt.ClientID,
                        //            ExID = entity.OrderNo,
                        //            Money = entity.TotalCharge,
                        //            IsAdd = false,
                        //            RecordType = "1",
                        //            OperaType = "0",
                        //            OP_ID = entity.OP_ID
                        //        });
                        //        //保存交易记录
                        //        long cardID = 0;
                        //        CargoCashierEntity card = new CargoCashierEntity();
                        //        card.BasicID = entity.ClientNum;
                        //        card.RType = "0";
                        //        card.FromTO = "0";
                        //        card.AffectAwbNO = entity.OrderNo;
                        //        card.AffectCash = entity.TotalCharge;
                        //        card.Memo = entity.Remark;
                        //        card.OP_ID = entity.OP_ID;
                        //        card.OP_DATE = entity.OP_DATE;
                        //        card.UserName = entity.OP_Name;
                        //        card.TradeType = "1";
                        //        cardID = cargoFinanceManager.AddCardInfo(card);
                        //        cargoFinanceManager.AddRecordAwbID(cardID, entity.OrderNo);
                        //    }
                        //    //修改订单的结算状态
                        //    man.UpdateCheckStatusByOrderNo(entity.OrderNo, "1");
                        //}

                        lw.WriteLog(entity, log);
                    }

                    scope.Complete();
                }
                catch (Exception ex)
                {
                    log.Status = "1";
                    log.Memo = "新增订单失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }


        }
        /// <summary>
        /// 是否支付尾款
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool OrderIsFinalPayment(CargoReserveOrderEntity entity)
        {
            var data = man.OrderIsFinalPayment(entity);
            return data != null;
        }
        /// <summary>
        /// 是否出库
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public bool IsOrderCreate(CargoReserveOrderEntity entity)
        {
            var data = man.IsOrderCreate(entity);
            return data != null;
        }
        public List<CargoReserveOrderEntity> QueryNoRerverOrder(CargoReserveOrderEntity entity)
        {
            var data = man.QueryNoRerverOrder(entity);
            return data;
        }
        public void DelReserveOrder(List<CargoReserveOrderEntity> entity)
        {
            //先备份现有记录
            man.BackupReserveOrder(entity);
            //删除订单
            man.DelReserveOrder(entity);
        }
        #endregion

        #region 开思

        public List<CargoProductMappingEntity> QueryPartNumberMap(CargoProductEntity entity)
        {
            return man.QueryPartNumberMap(entity);
        }

        public List<CassMallPushParam> QueryNoDeliveryPushData()
        {
            return man.QueryNoDeliveryPushData();
        }

        public void UpdateCassDeliveryPushStatus(string orderId, string status)
        {
            man.UpdateCassDeliveryPushStatus(orderId, status);
        }

        #endregion

        #region 天猫
        public List<OutboundDto> QueryNoDeliveryPushData_Tmall(OutboundDto dto=null)
        {
            return man.QueryNoDeliveryPushData_Tmall(dto);
        }
        /// <summary>
        /// 手动发货不关联系统订单
        /// </summary>
        /// <param name="dto"></param>
        /// <returns></returns>
        public List<OutboundDto> QueryNoDeliveryPushData_TmallV2(OutboundDto dto=null)
        {
            return man.QueryNoDeliveryPushData_TmallV2(dto);
        }

        public void UpdateTMallDeliveryPushStatus(string orderId, string status)
        {
            man.UpdateTMallDeliveryPushStatus(orderId, status);
        }

        #endregion

        #region 创建拣货单
        public Hashtable QueryOrderPickPlanList(CargoCreateOrderPickPlanEntity entity, int pageIndex, int pageSize)
        {
            return man.QueryOrderPickPlanListV2(entity, pageIndex, pageSize);
        }
        public void AddOrderPickPlanBatch(List<CargoOrderPickPlanEntity> entity, LogEntity log)
        {
            LogWrite<CargoOrderPickPlanEntity> lw = new LogWrite<CargoOrderPickPlanEntity>();
            //使用事务
            using (TransactionScope scope = new TransactionScope(TransactionScopeOption.Required))
            {
                try
                {
                    foreach (var item in entity)
                    {
                        man.AddOrderPickPlan(item);
                        //回写字段
                        foreach (var item2 in item.PickPlanGoodsList)
                        {
                            man.UpdateOrderPickPlanGoods(item2);
                        }
                        lw.WriteLog(item, log);
                    }
                    scope.Complete();
                }
                catch (ApplicationException ex)
                {
                    log.Status = "1";
                    log.Memo = "新增拣货计划失败，失败信息：" + ex.Message;
                    lw.WriteLog(log);
                    throw;
                }
            }
        }
        #endregion

    }
}
