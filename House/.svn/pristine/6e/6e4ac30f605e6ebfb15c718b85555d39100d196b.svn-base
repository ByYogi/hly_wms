using Cargo.Interface.Utils;
using Cargo.QY;
using Cargo.systempage;
using DocumentFormat.OpenXml.Spreadsheet;
using House.Business;
using House.Business.Cargo;
using House.Entity;
using House.Entity.Cargo;
using House.Entity.Cargo.Order;
using House.Entity.Dto;
using House.Manager;
using iText.Layout.Element;
using Newtonsoft.Json;
using NPOI.HSSF.Record.Formula.Functions;
using Senparc.Weixin.HttpUtility;
using Senparc.Weixin.MP.AdvancedAPIs.UserTag;
using System;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.IO;
using System.Linq;
using System.Net;
using System.Security.Cryptography;
using System.Security.Policy;
using System.ServiceModel;
using System.ServiceModel.Channels;
using System.Text;
using System.Text.RegularExpressions;
using System.Web;
using System.Windows.Interop;

namespace Cargo.Interface
{
    /// <summary>
    /// TMallApi 的摘要说明
    /// </summary>
    public class TMallApi : IHttpHandler
    {
        public void ProcessRequest(HttpContext context)
        {
            CargoInterfaceBus nwBus = new CargoInterfaceBus();
            LogBus logbus = new LogBus();

            LogEntity log = new LogEntity();
            log.IPAddress = "";
            log.Moudle = "服务管理";
            log.Status = "0";
            log.NvgPage = "天猫接收发货通知单";
            log.UserID = "2029";
            log.Operate = "A";

            // 读取请求体
            using (var reader = new StreamReader(context.Request.InputStream, Encoding.UTF8))
            {
                var dataStr = reader.ReadToEnd();
                log.Memo = $@"天猫 获取到加密数据：" + dataStr;
                logbus.InsertLog(log);
                #region test
                //加密 and 解密 test
                //CargoTMallEntity cargoData223 = ParseToCargoTMallEntityV2(dataStr);
                ////operateNoticeSpiPo cargoData22 = ParseToStockCargoTMallEntityV2(dataStr);
                //var requestBody2 = OpenApiEncryptedService.PostAsyncV2(cargoData223);
                //var requestBody = EncryptUtils.Decrypt(requestBody2);
                //解密test
                //dataStr = $@"LPaJIOLj0P98B6Y1oy96X0kaJsxU4KawwfG7M8hMZQbIVwy2ZeadbW1OXf/g0dFnvm92YnV6RIZ501zG3BwurqjSStmohN1q5a0bisFzVsR2N0nQUZUwh4JthKdagKrUrtK9ZgkH83iNdZ6bQXC78T+UHAW4sqjGPgQhDwClWCStZR2w29X4RsK8i5Z3bwCAyvQtMitzJWQ2Qbe95z26A5do435JKwxD8LVzBytm9ufBUUedpKrjHHOm5rBh7qp7dAdLggrTe0PeX9mEMcNljH3JqZMpYnt7C6Xtl0DmroMLz56sQSdN5GY1lyVywOpDVE9+KrrnCQX4kvhyWLOCEv9czPwPx1cwdFzbgJMaqJA2a0qqyQVMdHWRaz0ZcP0NQXb7f5OktRRFUZIzogZhFUPzVBgzxT7DEJOes4XUlShccNPSsNh2OEWgoTCo+2JOaq8CL9HDOO9CVM0Oy4RuKhpiDKke/lFi5Lg4YL+5u+HIRX2RSQ/Gm3bse9Xa8ZQbjioZF+oWsweNsAf1MYmhVxgjHZj3EMUd0QIcbIJKAy+d57XWbkZpEenyxP56Ne0ss9AdpQb+3IwWmOQcfG2yzQyT/3F7aCPCAPdCeUbOfHg8Gqa0eGJQtfXXUKd48t8JITncjyeMmaES8GL/pr0wEfQU+1wLNXm2O1mRhxUjzm9K1ckd4XB2+tvQWGa0s/0nHpQDePiqayOwts/9BSc9DBbik6tiMUK0fVwXU5gIJHGw6/+UBmVigpgrJmFycZRO/D10hHc+r9XObr8tvxKBtxu9e+qPQawf2AR9LY7THq4fHe6Z9GDJyQc3veOIgym27wwqIGLr/eFEEDrvQ6znAzHOZ/0z0vDdUAq7UQGT5KapXSwQYXso42GpeDz3w4BjG3IdpHEkJvRPjdvzeZ3YRDlAST+Son7Xb6vxnfja41U8Z9Rwg61o9L7JmY52+bKw2mxS4HQnTYWBYZ2BkyyBN9belnhhRqeJ4WYxZuZMkB81QsqMKjZJ60tJmVfvCQDnDVU1yVS79BdC1ZzCWcurVFB9M+0Ol8TXuo4PHgDpzJc2yYi3CCR3lMiG3LJnuTLaZR1A3aP/dcboWBFt307sVCOyS6DeWXw2Kvi3YkoGQ3oG6ZVM3WP5HaWB7mX2aVKgDBdjJfgEERlsRBCUtLwS4NF2kwM5FyOtFGQSAl0c8kXgGxfm8R5krGAVEQgQdXg+MxIETPlZHPS/XcWv/+YAHeyZxAh3ZyvwqMLL+D7OdwqPoaaQKh5zbR3PHsY88NsgdbTseXhVE4dCcNJXta9pb2ff80KsJBpxcem+tVV5DubWMBkY+LWqpsbp8H+Og0IweqTmwysiKLQuVn/Prr4O9nCb4Tc5kdrqulJb1ozVlxATkfwpKn269lKAKpNwQpoeH2WQmzXxfgp1sxMK3Eu6nvi4JR9GZhp1jwbrV8ELVB2qn5J+14lnk5NJnq+DDUNDO/b0YZ5FNQ+7O9SUf/PUWCkt3T7gZeMJyhckR8SEUf7LGYTHtUO5dD7jdK15mzPNcyeWovV1iUxXuuBZaRBpBnSWmdz8XMTnJdTmBTcyBnAD9Q7upA7RvQyi9ItYaSByh+GC5/EF3u1y2aq6scrf19S0hY5AkI1WD2eJnYBuW6c563+ACOYnAITjjkJcE038u0JwDmahR0+q2Jyb5vd8fTZC0obBlG1IFnX0okJhsTr7gU7qmkRr+KdqYNy74rbgnbNkIYOL2OUWUexjR6l7X5Zhknrb5+AeN/nMqVVlSIoW74RgXHSoZzqhV4ToaJOzbW+tm2aPzsmmJ0rkYgGBcg==";
                //dataStr = $@"LPaJIOLj0P98B6Y1oy96X0kaJsxU4KawwfG7M8hMZQbIVwy2ZeadbW1OXf/g0dFnb7WYpLZmZF03fWxZgqhnAdoxwXXi+Pz7XebAS1dgWVBLTIjqs3Sxv/9nmSq9cY78FkU/NCkWHZRid2uHtSI3QQBuiJg/aYj4TuvmSizqzR2Cp0+I/OIZ4uywW4X4LlmLEluJMN9/vWgxHXBJyLCxB/d8417p2+q6uTg6HKzFLp+XOj8buMx1wBMqD9+UyzS1sRNdusnaRkDHBCV4Un2fl1AyAlBYdjb4vgGSZJHUFYWO5DmeoVcU/oGLOFqoTOmzo6sCRssEZSxj0MKECPZz89p7RaZf0Fo62ZNRk0k0hD0werrZUL5c8HRGYoSYuUOhrl6TjiwK5EYry3lwI8KoJSvLNNjtl4rjm/z4EYSo785c9rG3fp1hVaaiM/QUI930lvgM9wx5E/hqhZaHq8T+t90bgACEUyxrARkproIz+A313XbveMLYpL0+cwezbcW0aDzE+jJnV+gwxafo7WcSU6ovJN5WgalNe6XWcmO27TwKCk97bGezzo2TIrlEZIIKOGfqRlb1iuQndbotUy2chE2M/YJ8P8hWkOIFbNfcblNRMMpeNGpZDNbVjKcuOBvWxpTydboakvkSGaaelxoM2a4RF1wXdw+uT71hqy+k1IccvmxQLV3P2Pzu66RoDzz5n/WXTIQhjUZ8oxi33crMLeBdW0iNn18b+YJMwv/rCPfa8lSkuSVZrnWQgaD6obOw90saI7w8B3/gvj7h8xz8/ZKK91iN2X1XeGhAoS5Qf++1eNdpW6NpVSmWzAhpV2Fde0qNjNAILic1S5IMxlUkpBjKBoetY6XWYFsNBZqalENPf75i0Nu79DgD6x92TlUdNsZwF6bzrvdCsfMtC3RY+L4ALVeapN8xSKKnfRLnD5GpFgvh4DvAgQ9jLn/rl3hrWBZkoNidgXbkPMK2dVNq1yCrYqTmhu94KvX/CepAcjvQmJWA3wwZVMsh2QlqNDLt2F8sUVtJisamF7vQwnU1W/2akpU/UeHRyKkZPjmBk/psHg6ViV3J6A0MXnQoF383KAlSQTJEw3112yDBLSawbA4Xei9c1Aujsijisw/wbcv0v3TorVEvjB9Pv/sYr9IxGn8zQmr9/dGk/vIdGB4CSz5bp/hbDkFqArslr+FNNIX5i3Y/ZPu6TYP2U8eNgFLFRr4gyW9wo/EKgIvQdIiNu5tQRHGw+lHAIlz/dawPxGxxhGE9CsosMzF2OvgJ80vB4pPor4kA8Xq3u1GlXbxQzdXocLSMOx1ycFzSK+Qh/9T5i2cnVtkZO78s4HubIT59JVPVr+kxu0zy0MA29HlnqGkNljEQWwbBlsoI5pa5GGUFItSSeoL/mdYFXKOGxUcFkmqgH0zGhYVcV48fmr2KJ6qfkn7XiWeTk0mer4MNQ0M79vRhnkU1D7s71JR/89RYKS3dPuBl4wnKFyRHxIRR/iyQpVT3CA1FNU8uOU+XQzZzJ5ai9XWJTFe64FlpEGkGHTSj8SP8//n0XMuTBSf3EAP1Du6kDtG9DKL0i1hpIHKH4YLn8QXe7XLZqrqxyt/X1LSFjkCQjVYPZ4mdgG5bp//Hq6a3EnDmg0tBbtcZmQe7QnAOZqFHT6rYnJvm93x9aI85fhE0bvJTaxsB5jsO5Jhvs47vC3IPpj57RGj/dZids2Qhg4vY5RZR7GNHqXtfx8hymYX03G8nGDC8iRrTksyQrSp1cSJnAguagV+HOnLNO/Yc5rQKZXFLjmM4nwf0";
                #endregion
                var requestBody = EncryptUtils.Decrypt(dataStr);
                log.Memo = $@"天猫 接收数据成功，加密：{dataStr}数据 解密：" + requestBody;
                logbus.InsertLog(log);
                // 解析 JSON 数据
                var logData = new CargoCassMallEntity { SourceType = 0, SourceAction = "API", orderId = null, ResJson = requestBody };
                // 使用 HttpUtility.ParseQueryString 解析
                // 它会返回一个 NameValueCollection
                // 2. 调用解析函数
                CargoTMallEntity cargoData = null;
                operateNoticeSpiPo cargoDataCancelled = null;
                if (requestBody.Contains("originBillNo"))
                {
                    log.Memo = "天猫 发货通知单下发 requestBody:" + requestBody;
                    logbus.InsertLog(log);
                    cargoData = ParseToCargoTMallEntity(requestBody);
                }
                else if (requestBody.Contains("operateType"))
                {
                    log.NvgPage = "天猫取消发货通知单";
                    log.Memo = "天猫 发货通知单取消 requestBody:" + requestBody;
                    logbus.InsertLog(log);
                    cargoDataCancelled = ParseToCargoTMallCancelledEntity(requestBody);
                }

                if (cargoData != null && !string.IsNullOrEmpty(cargoData.originBillNo))
                {
                    logData.orderId = cargoData.outboundNoticeNo.ToString();
                    nwBus.AddTMallDataLog(logData);
                    //保存数据
                    nwBus.SaveTMallOutHouseData(cargoData);
                    log.Memo = "天猫 接收数据并保存完成";
                    logbus.InsertLog(log);

                }
                else if (cargoDataCancelled != null && cargoDataCancelled.operateType == 1)
                {
                    logData = new CargoCassMallEntity { SourceType = 0, SourceAction = "Cancelled", orderId = null, ResJson = requestBody };
                    logData.orderId = cargoDataCancelled.noticeNo;
                    nwBus.AddTMallDataLog(logData);

                    var isSuccess = nwBus.DelTmallOrder(cargoDataCancelled, log);
                    //if (!isSuccess)
                    //{
                    //    //context.Response.StatusCode = -1;
                    //    //context.Response.Write("{\"code\":-1,\"msg\":\"未查询到相关订单或订单已出库\",\"info\":{\"data\":\"1\"}}");
                    //    // 返回 200 状态码
                    //    context.Response.StatusCode = 200;
                    //    context.Response.Write("{\"code\":0,\"msg\":\"成功\",\"info\":{\"data\":\"1\"}}");
                    //    return;
                    //}
                    log.Status = isSuccess > 0 ? "1" : "0";
                    log.Memo = log.Status == "1" ? "未查询到相关订单或订单已出库" : "发货通知单取消";
                    logbus.InsertLog(log);

                    var isSuccessStr = isSuccess < 1 ? 0 : 1;
                    var result = isSuccess == 1 ? "成功" : ((isSuccess == 0) ? "订单已出库" : "未查询到相关订单");

                    var response = new ApiResponse
                    {
                        code = isSuccessStr,
                        msg = result,
                        info = null
                    };
                    if (isSuccessStr==1)
                    {
                        response.info = new ApiResponseInfo { data = "1" };
                    }

                    // 返回 200 状态码
                    context.Response.StatusCode = 200;
                    context.Response.Write(JsonConvert.SerializeObject(response));
                    return;
                }

                // 返回 200 状态码
                context.Response.StatusCode = 200;
                context.Response.Write("{\"code\":0,\"msg\":\"成功\",\"info\":{\"data\":\"1\"}}");
            }

        }

        /// <summary>
        /// 将查询字符串解析为 CargoTMallEntity 对象
        /// </summary>
        /// <param name="queryString">查询字符串</param>
        /// <returns>解析后的 CargoTMallEntity 对象</returns>
        public static CargoTMallEntity ParseToCargoTMallEntity(string rawJson)
        {
            // 步骤1：反序列化JSON数组为Key-Value列表
            var dataItem = JsonConvert.DeserializeObject<CargoTMallEntity>(rawJson);
            // DateTime转换添加非空处理
            dataItem.requireArriveTime_Actual = ConvertMillisecondTimeStampToDateTime(Convert.ToString(dataItem.requireArriveTime));
            dataItem.noticeCreateTime_Actual = ConvertMillisecondTimeStampToDateTime(Convert.ToString(dataItem.noticeCreateTime));
            dataItem.originBillTime_Actual = ConvertMillisecondTimeStampToDateTime(Convert.ToString(dataItem.originBillTime));
            dataItem.requireOutWarehouseTime_Actual = ConvertMillisecondTimeStampToDateTime(Convert.ToString(dataItem.requireOutWarehouseTime));
            dataItem.payTime_Actual = ConvertMillisecondTimeStampToDateTime(Convert.ToString(dataItem.payTime));

            // 3.3 解析noticeDetailList（JSON数组）
            if (!string.IsNullOrEmpty(dataItem.noticeDetailList))
            {
                dataItem.noticeDetailLists = JsonConvert.DeserializeObject<List<OutboundNoticeDetailSpiPo>>(dataItem.noticeDetailList);
            }

            return dataItem;

        }
        /// <summary>
        /// 将查询字符串解析为 CargoTMallEntity 对象
        /// </summary>
        /// <param name="queryString">查询字符串</param>
        /// <returns>解析后的 CargoTMallEntity 对象</returns>
        public static operateNoticeSpiPo ParseToCargoTMallCancelledEntity(string rawJson)
        {
            // 步骤1：反序列化JSON数组为Key-Value列表
            var dataItem = JsonConvert.DeserializeObject<operateNoticeSpiPo>(rawJson);

            return dataItem;

        }

        /// <summary>
        /// 将查询字符串解析为 CargoTMallEntity 对象
        /// </summary>
        /// <param name="queryString">查询字符串</param>
        /// <returns>解析后的 CargoTMallEntity 对象</returns>
        public static CargoTMallEntity ParseToCargoTMallEntityV2(string queryString)
        {
            var callbackData = HttpUtility.ParseQueryString(queryString);
            var data = new CargoTMallEntity();

            // --- 解析简单属性 ---
            // 使用 TryParse 模式安全地转换，避免异常
            data.id = long.TryParse(callbackData["id"], out long idVal) ? idVal : 0;
            data.userId = long.TryParse(callbackData["userId"], out long userIdVal) ? userIdVal : 0;
            data.consigneeCityId = long.TryParse(callbackData["consigneeCityId"], out long cityIdVal) ? cityIdVal : 0;
            data.consigneeCountyId = long.TryParse(callbackData["consigneeCountyId"], out long countyIdVal) ? countyIdVal : 0;
            data.consigneeProvinceId = long.TryParse(callbackData["consigneeProvinceId"], out long provinceIdVal) ? provinceIdVal : 0;

            data.originBillFirstChannel = int.TryParse(callbackData["originBillFirstChannel"], out int firstChannelVal) ? firstChannelVal : 0;
            data.originBillSecondChannel = int.TryParse(callbackData["originBillSecondChannel"], out int secondChannelVal) ? secondChannelVal : 0;
            data.originBillThirdChannel = int.TryParse(callbackData["originBillThirdChannel"], out int thirdChannelVal) ? thirdChannelVal : 0;
            data.originBillType = int.TryParse(callbackData["originBillType"], out int billTypeVal) ? billTypeVal : 0;
            data.urgentLevel = int.TryParse(callbackData["urgentLevel"], out int urgentLevelVal) ? urgentLevelVal : 0;
            data.isExpressSheetEncrypted = int.TryParse(callbackData["isExpressSheetEncrypted"], out int isEncryptedVal) ? isEncryptedVal : 0;
            data.isAllowLack = int.TryParse(callbackData["isAllowLack"], out int isAllowLackVal) ? isAllowLackVal : 0;
            data.isEncrypted = int.TryParse(callbackData["isEncrypted"], out int isMainEncryptedVal) ? isMainEncryptedVal : 0;

            data.requireArriveTime_Actual = ConvertMillisecondTimeStampToDateTime(callbackData["requireArriveTime"]);
            data.noticeCreateTime_Actual = ConvertMillisecondTimeStampToDateTime(callbackData["noticeCreateTime"]);
            data.originBillTime_Actual = ConvertMillisecondTimeStampToDateTime(callbackData["originBillTime"]);
            data.requireOutWarehouseTime_Actual = ConvertMillisecondTimeStampToDateTime(callbackData["requireOutWarehouseTime"]);
            data.payTime_Actual = ConvertMillisecondTimeStampToDateTime(callbackData["payTime"]);

            // 字符串类型直接赋值，?.?.? 操作符可以安全地处理 null 值
            data.sendType = callbackData["sendType"] ?? "";
            data.consigneePhone = callbackData["consigneePhone"] ?? "";
            data.extend = callbackData["extend"] ?? "";
            data.customerContact = callbackData["customerContact"] ?? "";
            data.outboundNoticeNo = callbackData["outboundNoticeNo"] ?? "";
            data.originBillNo = callbackData["originBillNo"] ?? "";
            data.consigneeProvinceName = callbackData["consigneeProvinceName"] ?? "";
            data.consigneeCityName = callbackData["consigneeCityName"] ?? "";
            data.consigneeCountyName = callbackData["consigneeCountyName"] ?? "";
            data.warehouseCode = callbackData["warehouseCode"] ?? "";
            data.saleType = callbackData["saleType"] ?? "";
            data.warehouseName = callbackData["warehouseName"] ?? "";
            data.thirdWarehouseCode = callbackData["thirdWarehouseCode"] ?? "";
            data.buyerRemark = callbackData["buyerRemark"] ?? "";
            data.sellerRemark = callbackData["sellerRemark"] ?? "";
            data.deliverRemark = callbackData["deliverRemark"] ?? "";
            data.aliOaid = callbackData["aliOaid"] ?? "";
            data.consigneeContacts = callbackData["consigneeContacts"] ?? "";
            data.customerName = callbackData["customerName"] ?? "";
            data.consigneeDetail = callbackData["consigneeDetail"] ?? "";
            data.app_key = callbackData["app_key"] ?? "";
            data.sign = callbackData["sign"] ?? "";
            data.timestamp = callbackData["timestamp"] ?? "";
            data.is_test = callbackData["is_test"] ?? "";
            data.callback = callbackData["callback"] ?? "";

            // --- 解复杂的列表属性 noticeDetailList ---
            //data.noticeDetailList = ParseNoticeDetailList(callbackData);
            data.noticeDetailLists = JsonConvert.DeserializeObject<List<OutboundNoticeDetailSpiPo>>(callbackData["noticeDetailList"]);

            return data;
        }

        /// <summary>
        /// 将查询字符串解析为 CargoTMallEntity 对象
        /// </summary>
        /// <param name="queryString">查询字符串</param>
        /// <returns>解析后的 CargoTMallEntity 对象</returns>
        public static operateNoticeSpiPo ParseToStockCargoTMallEntityV2(string queryString)
        {
            var callbackData = HttpUtility.ParseQueryString(queryString);
            var data = new operateNoticeSpiPo();

            // --- 解析简单属性 ---
            // 使用 TryParse 模式安全地转换，避免异常
            data.supplierCode = callbackData["supplierCode"].ToString();
            data.warehouseCode = callbackData["warehouseCode"].ToString();
            data.thirdWarehouseCode = callbackData["thirdWarehouseCode"].ToString();
            data.operateType = Convert.ToInt32(callbackData["operateType"]);
            data.noticeNo = callbackData["noticeNo"].ToString();
            return data;
        }

        /// <summary>
        /// 从 NameValueCollection 中解析出 noticeDetailList
        /// </summary>
        private static List<OutboundNoticeDetailSpiPo> ParseNoticeDetailList(NameValueCollection collection)
        {
            var detailList = new List<OutboundNoticeDetailSpiPo>();

            // 找出所有与 noticeDetailList 相关的键
            var listKeys = collection.AllKeys.Where(key => key != null && key.StartsWith("noticeDetailList")).ToList();

            if (!listKeys.Any())
            {
                return detailList; // 如果没有相关键，返回空列表
            }

            // 使用正则表达式找出所有用到的索引，并确定最大索引，以确定列表大小
            var indices = listKeys.Select(key =>
            {
                var match = Regex.Match(key, @"noticeDetailList\[(\d+)\]");
                return match.Success ? int.Parse(match.Groups[1].Value) : -1;
            }).Where(index => index != -1).Distinct().ToList();

            if (!indices.Any())
            {
                return detailList;
            }

            // 按索引循环，创建并填充每个对象
            foreach (var i in indices)
            {
                var detail = new OutboundNoticeDetailSpiPo();
                string prefix = $"noticeDetailList[{i}].";

                detail.skuId = long.TryParse(collection[$"{prefix}skuId"], out long skuId) ? skuId : 0;
                detail.needOutboundNum = int.TryParse(collection[$"{prefix}needOutboundNum"], out int num) ? num : 0;
                detail.goodsQuality = int.TryParse(collection[$"{prefix}goodsQuality"], out int quality) ? quality : 0;
                detail.guaranteePeriod = long.TryParse(collection[$"{prefix}guaranteePeriod"], out long period) ? period : 0;
                detail.skuName = collection[$"{prefix}skuName"];
                detail.skuOrderCode = collection[$"{prefix}skuOrderCode"];

                detailList.Add(detail);
            }

            return detailList;
        }
        /// <summary>
        /// 添加播报
        /// </summary>
        //public void Broadcast(CargoTMallEntity dto)
        //{
        //    CargoHouseBus house = new CargoHouseBus();
        //    var cassHouses = house.GetCassHouses();
        //    var cassProducts = house.GetCassProDucts();
        //    foreach (var item in dto.noticeDetailList)
        //    {
        //        //获取对应仓库
        //        var cHouses = dto.thirdWarehouseCode;
        //        var cassHouse = cassHouses.FirstOrDefault(a => cHouses.Contains(a.CassHouseCode));
        //        var cassProduct = cassProducts.FirstOrDefault(a => item.PartsNum == a.CassCode);
        //        CargoHouseEntity houseEnt = house.QueryCargoHouseByID(cassHouse.HouseID);

        //        string proStr = cassProduct?.TypeName + " " + cassProduct?.Specs + " " + cassProduct?.Figure + " " + cassProduct?.LoadIndex + cassProduct?.SpeedLevel;

        //        //添加播报
        //        CargoNewOrderNoticeEntity cargoNewOrder = new CargoNewOrderNoticeEntity();
        //        cargoNewOrder.HouseName = "开思订单-" + houseEnt.Name;
        //        cargoNewOrder.OrderNo = dto.OrderHeader.OrderId;
        //        cargoNewOrder.OrderNum = item.Quantity.ToString();
        //        cargoNewOrder.ClientInfo = dto.OrderHeader.Buyer.CompanyDisplayName + " " + dto.OrderPostalAddress.ContactNumber + " " + (dto.OrderPostalAddress.ProvinceGeoName + " " + dto.OrderPostalAddress.CityGeoName + " " + dto.OrderPostalAddress.Address);// "泰乐 华笙 广东省广州市白云区东平加油站左侧";
        //        cargoNewOrder.ProductInfo = proStr;// "马牌 215/55R16 CC6 98V";
        //        cargoNewOrder.DeliveryName = "急送";// "自提";
        //        cargoNewOrder.ReceivePeople = "";
        //        string hcno = JSON.Encode(cargoNewOrder);
        //        //Common.WriteTextLog(hcno);
        //        List<CargoVoiceBroadEntity> voiceBroadList = house.GetVoiceBroadList(new CargoVoiceBroadEntity { HouseID = houseEnt.HouseID });
        //        foreach (var voice in voiceBroadList)
        //        {
        //            RedisHelper.SetString("NewOrderNotice_" + voice.LoginName, hcno);
        //            //mc.Add("NewOrderNotice_" + voice.LoginName, hcno);
        //        }
        //    }

        //}
        /// <summary>
        /// 将毫秒级Unix时间戳字符串转换为DateTime（失败返回默认值）
        /// </summary>
        /// <param name="timeStampStr">13位毫秒级时间戳字符串（如"1764830781000"）</param>
        /// <returns>转换后的DateTime（UTC），失败返回default(DateTime)</returns>
        private static DateTime ConvertMillisecondTimeStampToDateTime(string timeStampStr)
        {
            // 1. 处理空值/空白字符串
            if (string.IsNullOrWhiteSpace(timeStampStr))
                return default(DateTime);

            // 2. 尝试转换为长整型（毫秒级时间戳）
            if (!long.TryParse(timeStampStr, out long timeStampMs))
                return default(DateTime);

            try
            {
                // 3. Unix时间戳起始时间（UTC）
                DateTime unixEpoch = new DateTime(1970, 1, 1, 0, 0, 0, DateTimeKind.Utc);
                // 4. 累加毫秒数得到目标时间
                DateTime targetTime = unixEpoch.AddMilliseconds(timeStampMs);

                // 【可选】如果需要转换为本地时间，取消下面注释
                // targetTime = targetTime.ToLocalTime();

                return targetTime;
            }
            catch
            {
                // 处理数值异常（如时间戳过大/过小）
                return default(DateTime);
            }
        }

        public bool IsReusable
        {
            get
            {
                return false;
            }
        }
    }
    // 兼容所有.NET版本的字典扩展方法
    public static class DictionaryExtensions
    {
        /// <summary>
        /// 获取字典值，不存在则返回默认值
        /// </summary>
        /// <typeparam name="TKey">键类型</typeparam>
        /// <typeparam name="TValue">值类型</typeparam>
        /// <param name="dictionary">字典</param>
        /// <param name="key">键</param>
        /// <param name="defaultValue">默认值（可选）</param>
        /// <returns>对应值或默认值</returns>
        public static TValue GetValueOrDefault<TKey, TValue>(this Dictionary<TKey, TValue> dictionary, TKey key, TValue defaultValue = default(TValue))
        {
            // 判空+检查是否包含键
            if (dictionary == null || !dictionary.ContainsKey(key))
            {
                return defaultValue;
            }
            return dictionary[key];
        }
    }

    public class ApiResponse
    {
        public int code { get; set; }
        public string msg { get; set; }
        public ApiResponseInfo info { get; set; }
    }

    public class ApiResponseInfo
    {
        public string data { get; set; }
    }

}