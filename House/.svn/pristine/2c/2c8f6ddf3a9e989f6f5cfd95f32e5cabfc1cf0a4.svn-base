
using DocumentFormat.OpenXml.Drawing;
using DocumentFormat.OpenXml.Wordprocessing;
using House.Business;
using House.Business.Cargo;
using House.Business.Log;
using House.Entity;
using House.Entity.Cargo;
using House.Entity.Cargo.House;
using House.Entity.Cargo.Product;
using House.Entity.Dto.House;
using House.Entity.Dto.Order;
using Newtonsoft.Json;
using NPOI.HSSF.Record.Formula.Functions;
using Org.BouncyCastle.Asn1.Ocsp;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.Script.Serialization;
using System.Web.UI.WebControls;
using ThoughtWorks.QRCode.Codec;

namespace Cargo.House
{
    public partial class houseApi : BasePage
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            string methodName = string.Empty;
            try
            {
                methodName = Request["method"];
                if (String.IsNullOrEmpty(methodName)) return;
                Type type = this.GetType();
                MethodInfo method = type.GetMethod(methodName);
                method.Invoke(this, null);
            }
            catch (Exception ex)
            {
                LogBus bus = new LogBus();
                LogEntity log = new LogEntity();
                log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                log.Operate = "";
                log.Moudle = "houseApi";
                log.Status = "1";
                log.NvgPage = methodName;
                log.UserID = UserInfor.LoginName;
                log.Memo = ex.FormatErr();
                bus.InsertLog(log);
            }
            finally
            {
                HttpContext.Current.ApplicationInstance.CompleteRequest(); //完成请求
            }
        }
        #region 仓库管理操作方法集合
        /// <summary>
        /// 保存仓库数据
        /// </summary>
        public void SaveCargoHouse()
        {
            CargoHouseEntity ent = new CargoHouseEntity();
            CargoHouseBus bus = new CargoHouseBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "仓库管理";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;
            String id = Request["HouseID"] != null ? Request["HouseID"].ToString() : "";
            try
            {
                ent.Name = Convert.ToString(Request["Name"]);
                ent.HouseCode = Convert.ToString(Request["HouseCode"]).ToUpper();
                ent.Person = Convert.ToString(Request["Person"]);
                ent.Cellphone = Convert.ToString(Request["Cellphone"]);
                ent.PickTitle = Convert.ToString(Request["PickTitle"]);
                ent.SendTitle = Convert.ToString(Request["SendTitle"]);
                ent.Remark = Convert.ToString(Request["Remark"]);
                ent.DelFlag = Convert.ToString(Request["DelFlag"]);
                ent.BelongHouse = Convert.ToString(Request["BelongHouse"]);
                ent.DeliveryArea = Convert.ToString(Request["DeliveryArea"]);
                ent.CargoDepart = Convert.ToString(Request["CargoDepart"]);
                ent.OESCargoDepart = Convert.ToString(Request["OESCargoDepart"]);
                ent.Address = Convert.ToString(Request["Address"]);
                ent.DepCity = Convert.ToString(Request["DepCity"]);
                ent.OperaBrand = Convert.ToString(Request["OperaBrand"]);
                ent.LogisFee = string.IsNullOrEmpty(Convert.ToString(Request["LogisFee"])) ? 0 : Convert.ToDecimal(Request["LogisFee"]);
                ent.TwoLogisFee = string.IsNullOrEmpty(Convert.ToString(Request["TwoLogisFee"])) ? 0 : Convert.ToDecimal(Request["TwoLogisFee"]);
                ent.ThreeLogisFee = string.IsNullOrEmpty(Convert.ToString(Request["ThreeLogisFee"])) ? 0 : Convert.ToDecimal(Request["ThreeLogisFee"]);
                ent.NextDayLogisFee = string.IsNullOrEmpty(Convert.ToString(Request["NextDayLogisFee"])) ? 0 : Convert.ToDecimal(Request["NextDayLogisFee"]);
                ent.StartBusHours = Convert.ToString(Request["StartBusHours"]);
                ent.EndBusHours = Convert.ToString(Request["EndBusHours"]);
                ent.HCYCOrderPushTagID = string.IsNullOrEmpty(Convert.ToString(Request["HCYCOrderPushTagID"])) ? 0 : Convert.ToInt32(Request["HCYCOrderPushTagID"]);
                ent.OverDayNum = string.IsNullOrEmpty(Convert.ToString(Request["OverDayNum"])) ? 0 : Convert.ToInt32(Request["OverDayNum"]);
                ent.OverDueUnitPrice = string.IsNullOrEmpty(Convert.ToString(Request["OverDueUnitPrice"])) ? 0 : Convert.ToDecimal(Request["OverDueUnitPrice"]);
                ent.IsCanRush = string.IsNullOrEmpty(Convert.ToString(Request["IsCanRush"])) ? "1" : Convert.ToString(Request["IsCanRush"]);
                ent.IsCanPickUp = string.IsNullOrEmpty(Convert.ToString(Request["IsCanPickUp"])) ? "1" : Convert.ToString(Request["IsCanPickUp"]);
                ent.IsCanNextDay = string.IsNullOrEmpty(Convert.ToString(Request["IsCanNextDay"])) ? "1" : Convert.ToString(Request["IsCanNextDay"]);
                ent.StockShareHouseID = string.IsNullOrEmpty(Convert.ToString(Request["StockShareHouseID"])) ? 0 : Convert.ToInt32(Request["StockShareHouseID"]);
                ent.ParentID = int.TryParse(Request["ParentID"]?.ToString(), out int parentid) ? parentid : 0;
                if (id == "")
                {
                    if (bus.IsExistCargoHouse(ent))
                    {
                        msg.Result = false;
                        msg.Message = "已经存在相同的仓库名称";
                    }
                    else if (bus.IsExistCargoHouse(ent.HouseCode))
                    {
                        msg.Result = false;
                        msg.Message = "已经存在相同的仓库代码";
                    }
                    else
                    {
                        log.Operate = "A";
                        bus.AddCargoHouse(ent, log);
                        msg.Result = true;
                        msg.Message = "成功";
                    }
                }
                else
                {
                    ent.HouseID = Convert.ToInt32(id);
                    if (bus.IsExistCargoHouse(ent))
                    {
                        msg.Result = false;
                        msg.Message = "已经存在相同的仓库名称";
                    }
                    else if (bus.IsExistCargoHouse(ent.HouseCode, Convert.ToInt32(id)))
                    {
                        msg.Result = false;
                        msg.Message = "已经存在相同的仓库代码";
                    }
                    else
                    {
                        log.Operate = "U";
                        ent.HouseID = Convert.ToInt32(id);
                        bus.UpdateCargoHouse(ent, log);
                        msg.Result = true;
                        msg.Message = "成功";
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 查询仓库数据
        /// </summary>
        public void QueryCargoHouse()
        {
            CargoHouseEntity queryEntity = new CargoHouseEntity();
            queryEntity.Name = Convert.ToString(Request["Name"]);
            queryEntity.HouseCode = Convert.ToString(Request["HouseCode"]);
            queryEntity.Person = Convert.ToString(Request["Person"]);
            queryEntity.Cellphone = Convert.ToString(Request["Cellphone"]);
            if (Request["dFlag"] != "-1")
            {
                queryEntity.DelFlag = Convert.ToString(Request["dFlag"]);
            }
            if (Request["BelongHouse"] != "-1")
            {
                queryEntity.BelongHouse = Convert.ToString(Request["BelongHouse"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.QueryCargoHouse(pageIndex, pageSize, queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 删除仓库数据
        /// </summary>
        public void DelCargoHouse()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoHouseEntity> list = new List<CargoHouseEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "仓库管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoHouseEntity
                    {
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        Name = Convert.ToString(row["Name"]),
                        Person = Convert.ToString(row["Person"]),
                        Cellphone = Convert.ToString(row["Cellphone"]),
                        Remark = Convert.ToString(row["Remark"]),
                        DelFlag = Convert.ToString(row["DelFlag"])
                    });
                }
                bus.DelCargoHouse(list, log);
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 查询所有正常状态的仓库
        /// </summary>
        public void QueryALLHouse()
        {
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoHouseEntity> list = bus.QueryALLHouse();
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void QueryDLTHouse()
        {
            string BelongHouse = Convert.ToString(Request["BelongHouse"]);
            //if (string.IsNullOrEmpty(BelongHouse))
            //{
            //    BelongHouse = "0";
            //}
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoHouseEntity> list = bus.QueryALLHouse(new CargoHouseEntity { BelongHouse = BelongHouse });
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 用户所拥有权限的仓库集合
        /// </summary>
        public void CargoPermisionHouse()
        {
            List<string> HouseIds = new List<string>();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["HouseIds"])))
            {
                string houseStr = Convert.ToString(Request["HouseIds"]);
                HouseIds = houseStr.Split(',').Where(a => !string.IsNullOrEmpty(a) && a != "0").Distinct().ToList();
            }

            List<CargoHouseEntity> list = new List<CargoHouseEntity>();
            foreach (var item in UserInfor.CargoList)
            {
                list.Add(new CargoHouseEntity { HouseID = item.ID, Name = item.Name });
            }
            if (HouseIds.Count > 0)
                list = list.Where(a => HouseIds.Any(aa => aa == a.HouseID.ToString())).ToList();
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 根据HouseID查询仓库信息
        /// </summary>
        public void QueryCargoHouseID()
        {
            CargoHouseEntity queryEntity = new CargoHouseEntity();
            queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);

            CargoHouseBus bus = new CargoHouseBus();
            CargoHouseEntity list = bus.QueryCargoHouse(queryEntity);

            //JSON
            String json = JSON.Encode(list);
            // Response.Clear();
            Response.Write(json);
        }

        public void CloudHouseTypeID()
        {
            CargoHouseEntity queryEntity = new CargoHouseEntity();
            queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);

            CargoHouseBus bus = new CargoHouseBus();
            CargoHouseEntity list = bus.QueryCargoHouse(queryEntity);
            var obj = new
            {
                value = 0,
                text = "非云仓"
            };

            if (list.BelongHouse == "6")
            {
                obj = new
                {
                    value = 1,
                    text = "云仓"
                };
            }
            String json = JSON.Encode(new[] { obj });
            Response.Clear();
            Response.Write(json);

        }

        /// <summary>
        /// 查询城市 
        /// </summary>
        public void QueryCityData()
        {
            CargoHouseBus bus = new CargoHouseBus();
            int PID = string.IsNullOrEmpty(Request["PID"]) ? 0 : Convert.ToInt32(Request["PID"]);
            List<CargoCityEntity> list = bus.QueryCityData(new CargoCityEntity { ParentID = PID });
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 用户订阅仓库集合
        /// </summary>
        public void CargoVoiceBroadHouse()
        {
            //List<CargoHouseEntity> list = new List<CargoHouseEntity>();
            //string house = "";
            //foreach (var item in UserInfor.CargoList)
            //{
            //    house += item.ID + ",";
            //}
            //string housePermision = house.Remove(house.Length - 1);

            //查询
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoVoiceBroadEntity> list = bus.GetVoiceBroadList(new CargoVoiceBroadEntity { LoginName = UserInfor.LoginName });
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 修改用户订阅仓库
        /// </summary>
        public void UpdateVoiceBroadHouse()
        {
            ErrMessage msg = new ErrMessage();

            string text = Request["HouseID"].ToString();

            string[] HouseID = text.Split(',');
            if (HouseID.Length == 0)
            {
                msg.Message = "无订阅仓库，不可更改";
                msg.Result = false;
                string res1 = JSON.Encode(msg);
                Response.Write(res1);
            }
            //查询
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoVoiceBroadEntity> list = bus.GetVoiceBroadList(new CargoVoiceBroadEntity { LoginName = UserInfor.LoginName });

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.NvgPage = "订阅仓库管理";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;
            try
            {
                //删除所有
                if (list.Count > 0)
                {
                    log.Memo = "删除订阅仓库：" + string.Join(", ", list.Select(w => w.HouseID).ToArray());
                    bus.DelCargoVoiceBroad(list, log);
                }
                //新增信息
                //AddCargoVoiceBroad
                list = new List<CargoVoiceBroadEntity>();
                foreach (string time in HouseID)
                {
                    CargoVoiceBroadEntity entity = new CargoVoiceBroadEntity();
                    entity.UserName = UserInfor.UserName;
                    entity.LoginName = UserInfor.LoginName;
                    entity.HouseID = Convert.ToInt32(time);
                    entity.OP_DATE = DateTime.Now;
                    list.Add(entity);
                }
                if (list.Count > 0)
                {
                    //string a = list.Select(w => w.HouseID).ToArray();
                    log.Memo = "新增订阅仓库：" + string.Join(", ", list.Select(w => w.HouseID).ToArray());
                    bus.AddCargoVoiceBroad(list, log);
                }

                msg.Message = "更改成功";
                msg.Result = true;
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }
        /// <summary>
        /// 设置仓库自动开单权限
        /// </summary>
        public void saveHouseOrderPermiss()
        {
            CargoHouseEntity entity = new CargoHouseEntity();
            CargoHouseBus bus = new CargoHouseBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "仓库管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            try
            {
                entity.IsCassAutoOrder = Convert.ToString(Request["IsCassAutoOrder"]);
                entity.IsContiAutoOrder = Convert.ToString(Request["IsContiAutoOrder"]);
                entity.IsTuhuAutoOrder = Convert.ToString(Request["IsTuhuAutoOrder"]);
                entity.IsSanAutoOrder = Convert.ToString(Request["IsSanAutoOrder"]);
                entity.IsTMaoAutoOrder = Convert.ToString(Request["IsTMaoAutoOrder"]);

                entity.HouseID = Convert.ToInt32(Request["HouseID"]);
                bus.saveHouseOrderPermiss(entity, log);
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }

        #endregion
        #region 区域管理操作方法集合
        /// <summary>
        /// 查询区域数据
        /// </summary>
        public void QueryCargoArea()
        {
            CargoAreaEntity queryEntity = new CargoAreaEntity();
            queryEntity.Name = Convert.ToString(Request["Name"]);
            queryEntity.Code = Convert.ToString(Request["Code"]);
            if (!string.IsNullOrEmpty(Request["PID"]))
            {
                queryEntity.ParentID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))
            {
                queryEntity.ParentID = Convert.ToInt32(Request["SID"]);
            }

            if (!string.IsNullOrEmpty(Request["HID"]))
            {
                //queryEntity.HouseID = Convert.ToInt32(Request["HID"]);
                queryEntity.CargoPermisID = Convert.ToString(Request["HID"]);
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            }
            if (UserInfor.IsAdmin.Equals("0"))
            {
                queryEntity.DelFlag = "0";
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.QueryCargoArea(pageIndex, pageSize, queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 新增区域数据
        /// </summary>
        /// <param name="entity"></param>
        public void SaveCargoArea()
        {
            CargoAreaEntity ent = new CargoAreaEntity();
            CargoHouseBus bus = new CargoHouseBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "区域管理";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;
            String id = Request["AreaID"] != null ? Request["AreaID"].ToString() : "";
            try
            {
                ent.Name = Convert.ToString(Request["Name"]);
                ent.Code = Convert.ToString(Request["Code"]);
                ent.ParentID = string.IsNullOrEmpty(Convert.ToString(Request["FirstAreaID"])) ? string.IsNullOrEmpty(Convert.ToString(Request["ParentID"])) ? 0 : Convert.ToInt32(Request["ParentID"]) : Convert.ToInt32(Request["FirstAreaID"]);
                ent.LogisID = string.IsNullOrEmpty(Convert.ToString(Request["LogisID"])) ? 0 : Convert.ToInt32(Request["LogisID"]);
                ent.LogisticName = Convert.ToString(Request["LogisticName"]);
                ent.HouseID = Convert.ToInt32(Request["HouseID"]);
                ent.Remark = Convert.ToString(Request["Remark"]);
                ent.DeliveryArea = Convert.ToString(Request["DeliveryArea"]);
                ent.Address = Convert.ToString(Request["Address"]);
                ent.OrderCode = Convert.ToString(Request["OrderCode"]);
                ent.OrderDep = Convert.ToString(Request["OrderDep"]);
                ent.VirtualInventory = Convert.ToString(Request["VirtualInventory"]);
                ent.IsShowStock = Convert.ToString(Request["IsShowStock"]);
                ent.Longitude = "";
                ent.Latitude = "";
                if (!string.IsNullOrEmpty(ent.Address))
                {
                    string[] coordinate = geocodeAddress("", "", ent.Address);
                    if (!string.IsNullOrEmpty(coordinate[0]) && !string.IsNullOrEmpty(coordinate[1]))
                    {
                        ent.Longitude = coordinate[0];
                        ent.Latitude = coordinate[1];
                    }
                    else
                    {
                        msg.Result = false;
                        msg.Message = "地址不详无法获取到地理坐标";
                    }
                }
                //ent.Longitude = Convert.ToString(Request["Longitude"]);
                //ent.Latitude = Convert.ToString(Request["Latitude"]);
                if (id == "")
                {
                    if (bus.IsExistCargoAreaCode(ent))
                    {
                        msg.Result = false;
                        msg.Message = "已经存在相同的区域代码";
                    }
                    else if (ent.ParentID != 0)
                    {
                        //CargoAreaEntity are = bus.QueryAreaByAreaID(new CargoAreaEntity { AreaID = ent.ParentID });
                        //if (are != null && !are.ParentID.Equals(0))
                        //{
                        //    msg.Result = false;
                        //    msg.Message = "上级区域不能再有上级区域";
                        //}
                    }
                    if (!string.IsNullOrEmpty(ent.OrderCode))
                    {
                        if (bus.IsExistCargoOrderCode(ent))
                        {
                            msg.Result = false;
                            msg.Message = "已经存在相同的订单代码";
                        }
                    }

                    if (msg.Result)
                    {
                        log.Operate = "A";
                        bus.AddCargoArea(ent, log);
                        msg.Result = true;
                        msg.Message = "成功";
                    }
                }
                else
                {
                    ent.AreaID = Convert.ToInt32(id);
                    CargoAreaEntity area = bus.QueryAreaByAreaID(new CargoAreaEntity { AreaID = ent.AreaID });
                    if (!area.Code.Equals(ent.Code))
                    {
                        if (bus.IsExistCargoAreaCode(ent))
                        {
                            msg.Result = false;
                            msg.Message = "已经存在相同的区域代码";
                        }
                    }
                    if (!area.OrderCode.Equals(ent.OrderCode))
                    {
                        if (!string.IsNullOrEmpty(ent.OrderCode))
                        {
                            if (bus.IsExistCargoOrderCode(ent))
                            {
                                msg.Result = false;
                                msg.Message = "已经存在相同的订单代码";
                            }
                        }
                    }
                    if (msg.Result)
                    {
                        log.Operate = "U";
                        bus.UpdateCargoArea(ent, log);
                        msg.Result = true;
                        msg.Message = "成功";
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }

        /// <summary>
        /// 查询所有父ID为0的区域
        /// </summary>
        /// <returns></returns>
        public void QueryALLArea()
        {
            //查询条件
            int hid = Convert.ToInt32(Request["hid"]);
            int pid = Convert.ToInt32(Request["pid"]);
            CargoAreaEntity entity = new CargoAreaEntity();
            entity.HouseID = hid;
            entity.ParentID = pid;
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoAreaEntity> list = bus.QueryALLArea(entity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 查询所有父ID为0的区域
        /// </summary>
        /// <returns></returns>
        public void QueryALLAreaV2()
        {
            //查询条件
            var hid = Convert.ToString(Request["hid"]);
            var pid = Convert.ToString(Request["pid"]);
            CargoAreaEntity entity = new CargoAreaEntity();
            entity.ParamHouseID = hid;
            entity.ParamParentID = pid;
            entity.ParentID = -1;
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoAreaEntity> list = bus.QueryALLArea(entity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询所有父ID为0的区域递归
        /// </summary>
        /// <returns></returns>
        public void QueryALLAreaRecur()
        {
            //查询条件
            int hid = Convert.ToInt32(Request["hid"]);
            int pid = Convert.ToInt32(Request["pid"]);
            CargoAreaEntity entity = new CargoAreaEntity();
            entity.HouseID = hid;
            entity.ParentID = pid;
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoAreaEntity> list = bus.QueryALLAreaRecur(entity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 通过区域ID查询区域数据
        /// </summary>
        /// <returns></returns>
        public void QueryAreaByAreaID()
        {
            //查询条件
            int AreaID = Convert.ToInt32(Request["AreaID"]);
            CargoHouseBus bus = new CargoHouseBus();
            CargoAreaEntity list = bus.QueryAreaByAreaID(new CargoAreaEntity { AreaID = AreaID });
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 删除区域
        /// </summary>
        public void DelCargoArea()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoAreaEntity> list = new List<CargoAreaEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "区域管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    List<CargoAreaEntity> delAra = bus.QueryALLArea(new CargoAreaEntity { ParentID = Convert.ToInt32(row["AreaID"]), HouseID = Convert.ToInt32(row["HouseID"]) });
                    if (delAra.Count > 0)
                    {
                        msg.Message = Convert.ToString(row["Name"]) + " 该区域下有其它区域";
                        msg.Result = false;
                        break;
                    }
                    if (bus.IsExistCargoContainerArea(new CargoAreaEntity { Code = Convert.ToString(row["Code"]), HouseID = Convert.ToInt32(row["HouseID"]) }))
                    {
                        msg.Message = Convert.ToString(row["Name"]) + " 该区域下有货位存在";
                        msg.Result = false;
                        break;
                    }
                    list.Add(new CargoAreaEntity
                    {
                        AreaID = Convert.ToInt32(row["AreaID"]),
                        Name = Convert.ToString(row["Name"]),
                        Code = Convert.ToString(row["Code"]),
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        Remark = Convert.ToString(row["Remark"])
                    });
                }
                if (msg.Result)
                {
                    bus.DelCargoArea(list, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }

            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        public void UpdateCargoAreaType()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoAreaEntity> list = new List<CargoAreaEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "区域管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    string DelFlag = "0";
                    if (string.IsNullOrEmpty(Convert.ToString(row["DelFlag"])))
                    {
                        DelFlag = "1";
                    }
                    else if (Convert.ToString(row["DelFlag"]).Equals("0"))
                    {
                        DelFlag = "1";
                    }
                    else
                    {
                        DelFlag = "0";
                    }
                    list.Add(new CargoAreaEntity
                    {
                        AreaID = Convert.ToInt32(row["AreaID"]),
                        Name = Convert.ToString(row["Name"]),
                        Code = Convert.ToString(row["Code"]),
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        Remark = Convert.ToString(row["Remark"]),
                        DelFlag = DelFlag
                    });
                }
                bus.UpdateCargoAreaType(list, log);
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
        #region 货位管理操作方法集合
        /// <summary>
        /// 货位查询
        /// </summary>
        public void QueryCargoContainer()
        {
            CargoContainerEntity queryEntity = new CargoContainerEntity();
            queryEntity.ContainerCode = Convert.ToString(Request["ContainerCode"]);
            queryEntity.ContainerType = Convert.ToString(Request["ContainerType"]);
            //if (!string.IsNullOrEmpty(Request["HID"]))
            //{
            //    queryEntity.HouseID = Convert.ToInt32(Request["HID"]);
            //}
            if (!string.IsNullOrEmpty(Request["HID"]))
            {
                //queryEntity.HouseID = Convert.ToInt32(Request["HID"]);
                queryEntity.CargoPermisID = Convert.ToString(Request["HID"]);
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            }
            if (!string.IsNullOrEmpty(Request["FirstID"]))//一级仓库
            {
                queryEntity.FirstAreaID = Convert.ToInt32(Request["FirstID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))//父区域
            {
                queryEntity.ParentID = Convert.ToInt32(Request["SID"]);
            }
            if (!string.IsNullOrEmpty(Request["PID"]))
            {
                queryEntity.AreaID = Convert.ToInt32(Request["PID"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]).Equals(0) ? 1 : Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]).Equals(0) ? 1000 : Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.QueryCargoContainer(pageIndex, pageSize, queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        /// <summary>
        /// 根据区域ID查询该区域下的货位
        /// </summary>
        public void QueryContainerByAreaID()
        {
            CargoContainerEntity queryEntity = new CargoContainerEntity();
            queryEntity.ContainerCode = Convert.ToString(Request["ContainerCode"]);
            queryEntity.ContainerType = Convert.ToString(Request["ContainerType"]);
            if (!string.IsNullOrEmpty(Request["HID"]))
            {
                //queryEntity.HouseID = Convert.ToInt32(Request["HID"]);
                queryEntity.CargoPermisID = Convert.ToString(Request["HID"]);
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            }
            if (!string.IsNullOrEmpty(Request["FirstID"]))//一级仓库
            {
                queryEntity.FirstAreaID = Convert.ToInt32(Request["FirstID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))//父区域
            {
                queryEntity.ParentID = Convert.ToInt32(Request["SID"]);
            }
            if (!string.IsNullOrEmpty(Request["PID"]))
            {
                queryEntity.AreaID = Convert.ToInt32(Request["PID"]);
            }
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoContainerEntity> list = bus.QueryContainerByAreaID(queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        /// <summary>
        /// 根据货位类型返回该货位类型的最大货位号
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public void ReturnContainerNum()
        {
            //查询条件
            string ty = Convert.ToString(Request["ContainerType"]);
            string area = Convert.ToString(Request["area"]);
            CargoContainerEntity entity = new CargoContainerEntity();
            entity.ContainerType = ty;
            entity.HouseID = UserInfor.HouseID;
            if (!string.IsNullOrEmpty(area))
            {
                entity.AreaID = Convert.ToInt32(area);
            }
            CargoHouseBus bus = new CargoHouseBus();
            string ContainerType = bus.ReturnContainerNum(entity);
            //JSON
            String json = JSON.Encode(ContainerType);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 保存货位数据
        /// </summary>
        public void SaveCargoContainer()
        {
            CargoContainerEntity ent = new CargoContainerEntity();
            CargoHouseBus bus = new CargoHouseBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "货位管理";
            log.Operate = "A";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;
            String id = Request["ContainerID"] != null ? Request["ContainerID"].ToString() : "";
            try
            {
                ent.ContainerCode = Convert.ToString(Request["ContainerCode"]);
                ent.ContainerType = Convert.ToString(Request["ContainerType"]);
                ent.ContainerNum = Convert.ToInt32(Request["ContainerNum"]);//货位号
                ent.AreaID = Convert.ToInt32(Request["AreaID"]);
                ent.MaxPiece = Convert.ToInt32(Request["MaxPiece"]);
                ent.MaxWeight = Convert.ToDecimal(Request["MaxWeight"]);
                ent.MaxVolume = Convert.ToDecimal(Request["MaxVolume"]);
                if (!string.IsNullOrEmpty(Request["WarnPiece"]))
                {
                    ent.WarnPiece = Convert.ToInt32(Request["WarnPiece"]);
                }
                else
                {
                    ent.WarnPiece = 0;
                }
                ent.Remark = Convert.ToString(Request["Remark"]);
                ent.HouseID = Convert.ToInt32(Request["HouseID"]);//所在仓库
                List<CargoContainerStarEntity> goods = new List<CargoContainerStarEntity>();
                if (!string.IsNullOrEmpty(Convert.ToString(Request["TypeID"])))
                {
                    string[] typeArr = Convert.ToString(Request["TypeID"]).Split(',');
                    for (int i = 0; i < typeArr.Length; i++)
                    {
                        if (i == 5) { break; }
                        CargoContainerStarEntity ge = new CargoContainerStarEntity();
                        ge.TypeID = Convert.ToInt32(typeArr[i]);
                        ge.Star = 5 - i;
                        goods.Add(ge);
                    }
                }
                ent.ContainerGoodsList = goods;
                if (id == "")
                {
                    if (bus.IsExistCargoContainerCode(ent))
                    {
                        msg.Result = false;
                        msg.Message = "已经存在相同的货位代码";
                    }
                    if (msg.Result)
                    {
                        log.Operate = "A";
                        bus.AddCargoContainer(ent, log);
                        msg.Result = true;
                        msg.Message = "成功";
                    }
                }
                else
                {
                    log.Operate = "U";
                    ent.ContainerID = Convert.ToInt32(id);
                    bus.UpdateCargoContainer(ent, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 删除货位
        /// </summary>
        public void DelCargoContainer()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoContainerEntity> list = new List<CargoContainerEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "货位管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    if (bus.IsExistOrderContainerCode(new CargoContainerEntity { ContainerCode = Convert.ToString(row["ContainerCode"]), HouseID = Convert.ToInt32(row["HouseID"]) }))
                    {
                        msg.Message = Convert.ToString(row["ContainerCode"]) + " 该货位下有订单，不允许删除";
                        msg.Result = false;
                        break;
                    }
                    if (bus.IsExistContainerGood(new CargoContainerEntity { ContainerID = Convert.ToInt32(row["ContainerID"]) }))
                    {
                        msg.Message = Convert.ToString(row["ContainerCode"]) + " 该货位下有库存数据，不允许删除";
                        msg.Result = false;
                        break;
                    }
                    list.Add(new CargoContainerEntity
                    {
                        ContainerID = Convert.ToInt32(row["ContainerID"]),
                        ContainerCode = Convert.ToString(row["ContainerCode"]),
                        ContainerType = Convert.ToString(row["ContainerType"]),
                        AreaID = Convert.ToInt32(row["AreaID"]),
                        MaxPiece = Convert.ToInt32(row["MaxPiece"]),
                        MaxVolume = Convert.ToDecimal(row["MaxVolume"]),
                        MaxWeight = Convert.ToDecimal(row["MaxWeight"]),
                        WarnPiece = Convert.ToInt32(row["WarnPiece"]),
                        Remark = Convert.ToString(row["Remark"])
                    });
                }
                if (msg.Result)
                {
                    bus.DelCargoContainer(list, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }

            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 通过产品类型查询货位，按星级排序
        /// </summary>
        public void QueryContainerByType()
        {
            CargoContainerEntity queryEntity = new CargoContainerEntity();
            queryEntity.ContainerCode = Convert.ToString(Request["ContainerCode"]);
            queryEntity.ContainerType = Convert.ToString(Request["ContainerType"]);
            if (!string.IsNullOrEmpty(Request["HID"]))
            {
                queryEntity.HouseID = Convert.ToInt32(Request["HID"]);
            }
            else
            {
                queryEntity.HouseID = UserInfor.HouseID;
            }
            if (!string.IsNullOrEmpty(Request["PID"]))
            {
                queryEntity.AreaID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["TypeID"]))
            {
                queryEntity.TypeID = Convert.ToInt32(Request["TypeID"]);
            }
            if (!string.IsNullOrEmpty(Request["CStar"]))
            {
                queryEntity.Star = Convert.ToInt32(Request["CStar"]);
            }
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoContainerEntity> list = bus.QueryContainerByType(queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 通过产品信息查询该产品所在的货位
        /// </summary>
        public void QueryInContainerByProduct()
        {
            CargoProductEntity queryEntity = new CargoProductEntity();

            queryEntity.HouseID = UserInfor.HouseID;

            if (!string.IsNullOrEmpty(Request["TypeID"]))
            {
                queryEntity.TypeID = Convert.ToInt32(Request["TypeID"]);
            }
            if (!string.IsNullOrEmpty(Request["Specs"]))
            {
                queryEntity.Specs = Convert.ToString(Request["Specs"]);
            }
            if (!string.IsNullOrEmpty(Request["Figure"]))
            {
                queryEntity.Figure = Convert.ToString(Request["Figure"]);
            }
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoContainerEntity> list = bus.QueryInContainerByProduct(queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 保存入库
        /// </summary>
        public void SaveProductInCargo()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有入库数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoContainerGoodsEntity> entDest = new List<CargoContainerGoodsEntity>();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "产品管理";
            log.NvgPage = "产品入库";
            log.Operate = "U";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;

            try
            {
                CargoProductBus product = new CargoProductBus();
                int TypeID = Convert.ToInt32(Request["TypeID"]);
                int productID = Convert.ToInt32(Request["ProductID"]);
                string Source = Convert.ToString(Request["Source"]);
                if (!product.IsExistCargoProduct(new CargoProductEntity { ProductID = productID }))
                {
                    msg.Message = "产品不存在，请刷新后操作";
                    msg.Result = false;
                }
                if (msg.Result)
                {
                    foreach (Hashtable row in GridRows)
                    {
                        if (!string.IsNullOrEmpty(Convert.ToString(row["OnPiece"])) && Convert.ToInt32(row["OnPiece"]) != 0)
                        {
                            entDest.Add(new CargoContainerGoodsEntity
                            {
                                TypeID = TypeID,
                                ContainerID = Convert.ToInt32(row["ContainerID"]),
                                ProductID = productID,
                                Model = Convert.ToString(Request["Model"]),
                                Specs = Convert.ToString(Request["Specs"]),
                                Figure = Convert.ToString(Request["Figure"]),
                                LoadIndex = Convert.ToString(Request["LoadIndex"]),
                                SpeedLevel = Convert.ToString(Request["SpeedLevel"]),
                                Batch = Convert.ToString(Request["Batch"]),
                                InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString(),//入库单号
                                InHouseType = Source.Equals("18") ? "4" : "0",
                                Piece = Convert.ToInt32(row["OnPiece"])
                            });
                        }
                    }
                    if (entDest.Count <= 0)
                    {
                        msg.Message = "没有入库数据";
                        msg.Result = false;
                    }
                    if (msg.Result)
                    {
                        //仓库同步缓存
                        CargoProductEntity syncProduct = bus.SyncTypeProduct(productID.ToString());
                        if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "Cass"))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                        }
                        if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "DILE"))
                        {
                            RedisHelper.HashSet("HCYCHouseStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                        }
                        if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "Tuhu"))
                        {
                            RedisHelper.HashSet("TuhuStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                        }

                        bus.SaveProductInCargo(entDest, log);
                        msg.Message = "成功";
                        msg.Result = true;
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 根据货位代码查询货位数据
        /// </summary>
        public void QueryContainerEntityByCode()
        {
            string ContainerCode = Convert.ToString(Request["ContainerCode"]);
            CargoHouseBus bus = new CargoHouseBus();
            CargoContainerEntity list = bus.QueryContainerEntityByCode(ContainerCode, UserInfor.HouseID);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 打印入库单
        /// <summary>
        /// 查找未打印入库单的数据
        /// </summary>
        public void QueryNoPrintInCargoAwbData()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            //打印状态 0 False 未打印 1 True 已打印
            if (Convert.ToString(Request["IsPrintInCargo"]) != "-1")
            {
                queryEntity.PrintInCargo = Convert.ToString(Request["IsPrintInCargo"]);
            }
            //queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            if (!string.IsNullOrEmpty(Request["HouseID"]))
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            if (!string.IsNullOrEmpty(Request["InHID"]))
            {
                queryEntity.FirstAreaID = Convert.ToInt32(Request["InHID"]);
            }
            //入库类型
            if (Convert.ToString(Request["InHouseType"]) != "-1")
            {
                queryEntity.InHouseType = Convert.ToString(Request["InHouseType"]);
            }
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoContainerShowEntity> list = bus.QueryNoPrintInCargoAwbData(queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }



        #endregion
        #region 入库管理
        /// <summary>
        /// 查询在库的产品数据
        /// </summary>
        public void QueryInHouseData()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            queryEntity.ContainerCode = Convert.ToString(Request["ContainerCode"]);
            queryEntity.ContainerType = Convert.ToString(Request["ContainerType"]);
            //queryEntity.Specs = Convert.ToString(Request["Specs"]);
            string spe = Convert.ToString(Request["Specs"]).ToUpper();
            if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
            {
                queryEntity.Specs = spe;
            }
            else
            {
                if (spe.Length <= 3)
                {
                    queryEntity.Specs = spe;
                }
                if (spe.Length > 3 && spe.Length <= 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                }
                if (spe.Length > 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                }
            }
            //if (!string.IsNullOrEmpty(Request["HID"]))
            //{
            //    queryEntity.HouseID = Convert.ToInt32(Request["HID"]);
            //}
            if (!string.IsNullOrEmpty(Request["HID"]))
            {
                //queryEntity.HouseID = Convert.ToInt32(Request["HID"]);
                queryEntity.CargoPermisID = Convert.ToString(Request["HID"]);
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            }
            if (!string.IsNullOrEmpty(Request["PID"]))
            {
                queryEntity.FirstAreaID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["HSID"]))
            {
                queryEntity.ParentAreaID = Convert.ToInt32(Request["HSID"]);
            }
            if (Request["BatchYear"] != "-1")
            {
                queryEntity.BatchYear = Convert.ToInt32(Request["BatchYear"]);
            }
            if (Request["IsLockStock"] != "-1")
            {
                queryEntity.IsLockStock = Convert.ToString(Request["IsLockStock"]);
            }
            queryEntity.ProductName = Convert.ToString(Request["ProductName"]);
            queryEntity.Batch = Convert.ToString(Request["Batch"]);//批次
            queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            queryEntity.Model = Convert.ToString(Request["Model"]);
            if (!string.IsNullOrEmpty(Request["APID"]))//一级分类
            {
                queryEntity.TypeParentID = Convert.ToInt32(Request["APID"]);
            }
            if (!string.IsNullOrEmpty(Request["ASID"]))//二级分类
            {
                queryEntity.TypeID = Convert.ToInt32(Request["ASID"]);
            }
            queryEntity.Figure = Convert.ToString(Request["Figure"]);//花纹
            if (!string.IsNullOrEmpty(Request["ProductID"]))//产品ID
            {
                queryEntity.ProductID = Convert.ToInt64(Request["ProductID"]);
            }
            if (Request["IsQueryLockStock"] == "0")
            {
                queryEntity.IsLockStock = "0";
            }
            else
            {
                if (Request["IsLockStock"] != "-1")
                {
                    queryEntity.IsLockStock = Convert.ToString(Request["IsLockStock"]);
                }
            }

            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.QueryInHouseData(pageIndex, pageSize, queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询目标货位
        /// </summary>
        public void queryTargetPosition()
        {
            CargoContainerEntity queryEntity = new CargoContainerEntity();
            queryEntity.ContainerCode = Convert.ToString(Request["ContainerCode"]);
            queryEntity.ContainerType = Convert.ToString(Request["ContainerType"]);
            if (!string.IsNullOrEmpty(Request["HID"]))
            {
                queryEntity.HouseID = Convert.ToInt32(Request["HID"]);
            }
            if (!string.IsNullOrEmpty(Request["FirstAreaID"]))
            {
                queryEntity.FirstAreaID = Convert.ToInt32(Request["FirstAreaID"]);
            }
            if (!string.IsNullOrEmpty(Request["PID"]))
            {
                queryEntity.ParentID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["AID"]))
            {
                queryEntity.AreaID = Convert.ToInt32(Request["AID"]);
            }
            if (!string.IsNullOrEmpty(Request["TypeID"]))
            {
                queryEntity.TypeID = Convert.ToInt32(Request["TypeID"]);
            }
            if (!string.IsNullOrEmpty(Request["CStar"]))
            {
                queryEntity.Star = Convert.ToInt32(Request["CStar"]);
            }
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoContainerEntity> list = bus.QueryContainerByType(queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 保存移库数据
        /// </summary>
        public void SaveMoveContainer()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "库存管理";
            log.Operate = "U";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;

            if (string.IsNullOrEmpty(Convert.ToString(Request["MovePiece"])))
            {
                msg.Message = "移库数量有误";
                msg.Result = false;
            }

            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有目标货位";
                msg.Result = false;
            }
            int mP = Convert.ToInt32(Request["MovePiece"]);//移库件数
            CargoContainerShowEntity newContainer = new CargoContainerShowEntity();//目标货位实体
            CargoContainerShowEntity oldContainer = new CargoContainerShowEntity();//原货位实体
            oldContainer.ID = Convert.ToInt32(Request["ID"]);//货位关联表ID
            oldContainer.TypeID = Convert.ToInt32(Request["TypeID"]);//产品类型
            oldContainer.ProductID = Convert.ToInt64(Request["ProductID"]);//产品ID
            oldContainer.ContainerID = Convert.ToInt32(Request["BContainerID"]);//原货位ID
            oldContainer.ContainerCode = Convert.ToString(Request["BContainerCode"]);//原货位代码
            //oldContainer.Piece = Convert.ToInt32(Request["Piece"]);//移库件数
            oldContainer.Piece = mP;//移库件数
            CargoContainerGoodsEntity oldGoods = bus.QueryCargoContainerGoods(new CargoContainerGoodsEntity { ID = oldContainer.ID });
            if (oldGoods.Piece.Equals(0))
            {
                msg.Message = "原货位库存为0";
                msg.Result = false;
            }
            if (oldGoods.Piece < mP)
            {
                msg.Message = "原货位库存不足";
                msg.Result = false;
            }
            if (msg.Result)
            {
                try
                {
                    foreach (Hashtable row in GridRows)
                    {
                        newContainer.ContainerID = Convert.ToInt32(row["ContainerID"]);//新货位ID
                        newContainer.ContainerCode = Convert.ToString(row["ContainerCode"]);//新货位代码
                        newContainer.HouseID = Convert.ToInt32(row["HouseID"]);//目标仓库ID
                        newContainer.AreaID = Convert.ToInt32(row["AreaID"]);//目标仓库区域ID
                        newContainer.InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//入库单号
                    }
                    CargoContainerEntity contain = bus.QueryContainerEntity(new CargoContainerEntity { ContainerID = newContainer.ContainerID, ContainerCode = newContainer.ContainerCode });
                    if (contain != null && contain.allowPiece < oldContainer.Piece)
                    {
                        msg.Message = "目标货位允许件数小于移库件数";
                        msg.Result = false;
                    }
                    if (oldContainer.ContainerID.Equals(newContainer.ContainerID))
                    {
                        msg.Message = "相同货位不能移库";
                        msg.Result = false;
                    }
                    if (msg.Result)
                    {

                        //仓库同步缓存(缓存的旧的仓库信息)
                        CargoProductEntity syncProduct = bus.SyncTypeProduct(oldContainer.ProductID.ToString());
                        if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "Cass"))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                        }
                        if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "DILE"))
                        {
                            RedisHelper.HashSet("HCYCHouseStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                        }
                        if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "Tuhu"))
                        {
                            RedisHelper.HashSet("TuhuStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                        }

                        bus.SaveMoveContainer(oldContainer, newContainer, log);
                        msg.Message = "成功";
                        msg.Result = true;
                    }
                }
                catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 以拖拽的方式进行移库操作保存移库数据
        /// </summary>
        public void SaveMoveContainerDrop()
        {
            ErrMessage msg = new ErrMessage();
            msg.Message = "";
            msg.Result = true;
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "移库管理";
            log.Operate = "U";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;

            string OldID = Request["OldID"];
            string newContainerCode = Request["newContainerCode"];
            if (string.IsNullOrEmpty(newContainerCode))
            {
                msg.Message = "目标货位不能为空";
                msg.Result = false;
            }
            if (msg.Result)
            {
                try
                {
                    CargoContainerShowEntity newContainer = new CargoContainerShowEntity();//目标货位实体
                    CargoContainerShowEntity oldContainer = new CargoContainerShowEntity();//原货位实体
                    oldContainer.ID = Convert.ToInt32(OldID);//货位关联表ID
                    oldContainer.TypeID = Convert.ToInt32(Request["TypeID"]);//产品类型
                    oldContainer.ProductID = Convert.ToInt64(Request["ProductID"]);//产品ID
                    oldContainer.ContainerID = Convert.ToInt32(Request["ContainerID"]);//原货位ID
                    CargoContainerEntity cce = bus.QueryContainerEntity(new CargoContainerEntity { ContainerID = oldContainer.ContainerID });
                    oldContainer.ContainerCode = cce.ContainerCode;
                    oldContainer.Piece = Convert.ToInt32(Request["Piece"]);//移库件数
                    CargoContainerEntity con = bus.QueryContainerEntityByCode(newContainerCode, UserInfor.HouseID);
                    if (con != null)
                    {
                        newContainer.ContainerID = con.ContainerID;//新货位ID
                        newContainer.ContainerCode = con.ContainerCode;//新货位代码
                        newContainer.HouseID = Convert.ToInt32(Request["HouseID"]);//目标仓库ID
                        newContainer.AreaID = con.AreaID;//目标仓库区域ID
                        newContainer.InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//入库单号
                    }
                    CargoContainerEntity contain = bus.QueryContainerEntity(new CargoContainerEntity { ContainerID = newContainer.ContainerID, ContainerCode = newContainer.ContainerCode });
                    if (contain != null && contain.allowPiece < oldContainer.Piece)
                    {
                        msg.Message = "目标货位允许件数小于移库件数";
                        msg.Result = false;
                    }
                    if (oldContainer.ContainerID.Equals(newContainer.ContainerID))
                    {
                        msg.Message = "相同货位不能移库";
                        msg.Result = false;
                    }
                    if (msg.Result)
                    {
                        //仓库同步缓存(缓存的旧的仓库信息)
                        CargoProductEntity syncProduct = bus.SyncTypeProduct(oldContainer.ProductID.ToString());
                        if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "Cass"))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                        }
                        if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "DILE"))
                        {
                            RedisHelper.HashSet("HCYCHouseStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                        }
                        if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "Tuhu"))
                        {
                            RedisHelper.HashSet("TuhuStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                        }
                        bus.SaveMoveContainer(oldContainer, newContainer, log);
                        msg.Message = "成功";
                        msg.Result = true;
                    }
                }
                catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 修改在库数量
        /// </summary>
        public void saveInHouseNum()
        {
            String json = Request["submitData"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoContainerGoodsEntity> list = new List<CargoContainerGoodsEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "库存管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "U";
            try
            {
                foreach (Hashtable row in rows)
                {
                    bool isAdd = true;
                    int newPiece = Convert.ToInt32(Request["Numbers"]);
                    int oldPiece = Convert.ToInt32(row["Piece"]);
                    int pi = 0;
                    if (newPiece >= oldPiece)//新的库存数大于旧的库存数，要加上
                    {
                        isAdd = true;
                        pi = newPiece - oldPiece;
                    }
                    else
                    {
                        isAdd = false;
                        pi = oldPiece - newPiece;
                    }
                    list.Add(new CargoContainerGoodsEntity
                    {
                        ID = Convert.ToInt64(row["ID"]),
                        ContainerID = Convert.ToInt32(row["ContainerID"]),
                        ProductID = Convert.ToInt32(row["ProductID"]),
                        TypeID = Convert.ToInt32(row["TypeID"]),
                        NewPiece = newPiece,
                        OldPiece = oldPiece,
                        IsAdd = isAdd,
                        Piece = pi//新在库数量
                    });
                }
                bus.saveInHouseNum(list, log);
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 查询产品所在的货位数据统计
        /// </summary>
        public void queryStatisInHouseNum()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            string spe = Convert.ToString(Request["Specs"]).ToUpper();
            if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
            {
                queryEntity.Specs = spe;
            }
            else
            {
                if (spe.Length <= 3)
                {
                    queryEntity.Specs = spe;
                }
                if (spe.Length > 3 && spe.Length <= 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                }
                if (spe.Length > 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                }
            }
            //if (!string.IsNullOrEmpty(Request["HID"]))
            //{
            //    queryEntity.HouseID = Convert.ToInt32(Request["HID"]);
            //}
            if (!string.IsNullOrEmpty(Request["SID"]))
            {
                //queryEntity.HouseID = Convert.ToInt32(Request["HID"]);
                queryEntity.CargoPermisID = Convert.ToString(Request["SID"]);
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            }
            if (!string.IsNullOrEmpty(Request["SHID"]))
            {
                queryEntity.FirstAreaID = Convert.ToInt32(Request["SHID"]);
            }
            queryEntity.Batch = Convert.ToString(Request["Batch"]);//批次
            queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            queryEntity.Model = Convert.ToString(Request["Model"]);
            queryEntity.Figure = Convert.ToString(Request["Figure"]);//花纹
            //if (Request["ContainerNum"] != "-1")
            //{
            //    queryEntity.ContainerNum = Convert.ToInt32(Request["ContainerNum"]);//货位数
            //}
            if (!string.IsNullOrEmpty(Request["SPID"]))//一级分类
            {
                queryEntity.TypeParentID = Convert.ToInt32(Request["SPID"]);
            }
            if (!string.IsNullOrEmpty(Request["SSID"]))//二级分类
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SSID"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.queryStatisInHouseNum(pageIndex, pageSize, queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 导出
        /// </summary>
        public void queryStatisInHouseNumForExport()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            //查询条件
            string key = Request["key"];
            if (string.IsNullOrEmpty(key))
            {
                Response.Clear();
                Response.Write(JSON.Encode(queryEntity));
                return;
            }
            string[] arr = key.Split(',');
            for (int i = 0; i < arr.Length; i++)
            {
                switch (i)
                {
                    case 0:
                        string spe = Convert.ToString(arr[i]).ToUpper();
                        if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
                        {
                            queryEntity.Specs = spe;
                        }
                        else
                        {
                            if (spe.Length <= 3)
                            {
                                queryEntity.Specs = spe;
                            }
                            if (spe.Length > 3 && spe.Length <= 5)
                            {
                                queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                            }
                            if (spe.Length > 5)
                            {
                                queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                            }
                        }
                        break;
                    case 1:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.Model = arr[i].Trim(); }
                        break;
                    case 2:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.GoodsCode = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 3:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.Figure = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 4:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.Batch = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 5://一级分类
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.TypeParentID = Convert.ToInt32(arr[i]); }
                        break;
                    case 6://二级分类
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.TypeID = Convert.ToInt32(arr[i]); }
                        break;
                    case 7:
                        if (!string.IsNullOrEmpty(arr[i]))
                        {
                            queryEntity.FirstAreaID = Convert.ToInt32(arr[i]);
                        }
                        break;
                    case 8:
                        if (!string.IsNullOrEmpty(arr[i]))//所属仓库
                        {
                            queryEntity.CargoPermisID = Convert.ToString(arr[i]);//所属仓库ID
                        }
                        else
                        {
                            queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                        }
                        break;
                    default:
                        break;
                }
            }
            //分页
            int pageIndex = 1;
            int pageSize = 1000;
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.queryStatisInHouseNum(pageIndex, pageSize, queryEntity);

            string err = "OK";
            List<CargoContainerShowEntity> awbList = list["rows"] as List<CargoContainerShowEntity>;
            if (awbList.Count > 0) { StatisData = awbList; } else { err = "没有数据可以进行导出，请重新查询！"; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 库存数据导出实体
        /// </summary>
        public List<CargoContainerShowEntity> StatisData
        {
            get
            {
                if (Session["StatisData"] == null)
                {
                    Session["StatisData"] = new List<CargoContainerShowEntity>();
                }
                return (List<CargoContainerShowEntity>)(Session["StatisData"]);
            }
            set
            {
                Session["StatisData"] = value;
            }
        }
        #endregion
        #region 出库管理
        public void QueryALLHouseStockData()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            CargoHouseBus bus = new CargoHouseBus();
            string spe = Convert.ToString(Request["Specs"]).ToUpper();
            if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
            {
                queryEntity.Specs = spe;
            }
            else
            {
                if (spe.Length <= 3)
                {
                    queryEntity.Specs = spe;
                }
                if (spe.Length > 3 && spe.Length <= 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                }
                if (spe.Length > 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                }
            }
            queryEntity.ProductName = Convert.ToString(Request["ProductName"]);
            queryEntity.Model = Convert.ToString(Request["Model"]);
            queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            queryEntity.ContainerCode = Convert.ToString(Request["ContainerCode"]);
            if (!string.IsNullOrEmpty(Request["PID"]))//一级分类
            {
                queryEntity.TypeParentID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))//二级分类
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SID"]);
            }
            else if (UserInfor.RoleID == 42)
            {
                queryEntity.TypeIDs = "34,345";
            }
            if (Request["BatchYear"] != "-1")
            {
                queryEntity.BatchYear = Convert.ToInt32(Request["BatchYear"]);
            }
            if (Request["Born"] != "-1")
            {
                queryEntity.Born = Convert.ToString(Request["Born"]);
            }
            if (Request["BelongDepart"] != "-1")
            {
                queryEntity.BelongDepart = Convert.ToString(Request["BelongDepart"]);
            }
            if (Request["IsQueryLockStock"] == "0")
            {
                queryEntity.IsLockStock = "0";
            }
            else
            {
                if (Request["IsLockStock"] != "-1")
                {
                    queryEntity.IsLockStock = Convert.ToString(Request["IsLockStock"]);
                }
            }

            queryEntity.TreadWidth = string.IsNullOrEmpty(Request["TreadWidth"]) ? 0 : Convert.ToInt32(Request["TreadWidth"]);
            queryEntity.FlatRatio = string.IsNullOrEmpty(Request["FlatRatio"]) ? 0 : Convert.ToInt32(Request["FlatRatio"]);
            queryEntity.Batch = Convert.ToString(Request["Batch"]);//批次
            queryEntity.ProductCode = Convert.ToString(Request["ProductCode"]);//产品编码
            queryEntity.Figure = Convert.ToString(Request["Figure"]);//花纹
            queryEntity.HubDiameter = string.IsNullOrEmpty(Request["HubDiameter"]) ? 0 : Convert.ToInt32(Request["HubDiameter"]);
            queryEntity.LoadIndex = Convert.ToString(Request["LoadIndex"]);
            if (!string.IsNullOrEmpty(Request["SalePrice"]))//销售价格
            {
                queryEntity.SalePrice = Convert.ToDecimal(Request["SalePrice"]);
            }
            if (Request["SpecsType"] != "-1")
            {
                queryEntity.SpecsType = Convert.ToString(Request["SpecsType"]);
            }
            if (!string.IsNullOrEmpty(Request["BatchWeek"]))//查询预警库存
            {
                queryEntity.BatchWeek = Convert.ToInt32(Request["BatchWeek"]);
            }
            if (Request["PriceType"] != "-1")
            {
                queryEntity.PriceType = Convert.ToInt32(Request["PriceType"]);
            }

            if (Request["BelongDepart"] != "-1") { queryEntity.BelongDepart = Convert.ToString(Request["BelongDepart"]); }
            //queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限
            if (!string.IsNullOrEmpty(Request["SuppClientNum"]))
            {
                queryEntity.SuppClientNum = Convert.ToInt32(Request["SuppClientNum"]);
                if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
                {
                    queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
                {
                    queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
                }
                else
                {
                    queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                }
            }
            //一级仓库
            if (!string.IsNullOrEmpty(Request["HAID"]))
            {
                queryEntity.FirstAreaID = Convert.ToInt32(Request["HAID"]);
            }
            else
            {
                if (!string.IsNullOrEmpty(Request["IsShowStock"]))
                {
                    queryEntity.IsShowStock = Convert.ToString(Request["IsShowStock"]);
                }
            }
            //一级区域
            if (!string.IsNullOrEmpty(Request["HSID"]))
            {
                queryEntity.ParentAreaID = Convert.ToInt32(Request["HSID"]);
            }
            if (!string.IsNullOrEmpty(Request["ProductID"]))//产品ID
            {
                queryEntity.ProductID = Convert.ToInt64(Request["ProductID"]);
            }
            if (!string.IsNullOrEmpty(Request["ClientNum"]))
            {
                queryEntity.PayClientNum = Convert.ToInt32(Request["ClientNum"]);
            }
            //所属公司
            if (Request["Company"] != "-1") { queryEntity.Company = Convert.ToString(Request["Company"]); }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            List<CargoContainerShowEntity> list = bus.QueryALLHouseStockData(pageIndex, pageSize, queryEntity);

            List<CargoContainerShowEntity> footlist = new List<CargoContainerShowEntity>();

            footlist.Add(new CargoContainerShowEntity
            {
                HouseName = "汇总：",
                Piece = list.Count > 0 ? list[0].TotalPiece : 0,
                OverDueFee = list.Count > 0 ? list[0].TotalOnlyOverDayFee : 0,
                InCargoStatus = ""
            });
            Hashtable resHT = new Hashtable();
            resHT["rows"] = list;
            resHT["total"] = list.Count > 0 ? list[0].TotalRowNum : 0;
            resHT["footer"] = footlist;
            //if (list.Count > 0) { StockData = list; StockDataType = Convert.ToString(Request["HouseID"]); }
            //JSON
            String json = JSON.Encode(resHT);
            Response.Clear();
            Response.Write(json);
        }
        public void QueryALLHouseStockDataExport()
        {
            string err = "OK";
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            CargoHouseBus bus = new CargoHouseBus();
            string spe = Convert.ToString(Request["Specs"]).ToUpper();
            if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
            {
                queryEntity.Specs = spe;
            }
            else
            {
                if (spe.Length <= 3)
                {
                    queryEntity.Specs = spe;
                }
                if (spe.Length > 3 && spe.Length <= 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                }
                if (spe.Length > 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                }
            }
            queryEntity.ProductName = Convert.ToString(Request["ProductName"]);
            queryEntity.Model = Convert.ToString(Request["Model"]);
            queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            queryEntity.ContainerCode = Convert.ToString(Request["ContainerCode"]);
            if (!string.IsNullOrEmpty(Request["PID"]))//一级分类
            {
                queryEntity.TypeParentID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))//二级分类
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SID"]);
            }
            else if (UserInfor.RoleID == 42)
            {
                queryEntity.TypeIDs = "34,345";
            }
            if (Request["BatchYear"] != "-1")
            {
                queryEntity.BatchYear = Convert.ToInt32(Request["BatchYear"]);
            }
            if (Request["Born"] != "-1")
            {
                queryEntity.Born = Convert.ToString(Request["Born"]);
            }
            if (Request["BelongDepart"] != "-1")
            {
                queryEntity.BelongDepart = Convert.ToString(Request["BelongDepart"]);
            }
            if (Request["IsQueryLockStock"] == "0")
            {
                queryEntity.IsLockStock = "0";
            }
            else
            {
                if (Request["IsLockStock"] != "-1")
                {
                    queryEntity.IsLockStock = Convert.ToString(Request["IsLockStock"]);
                }
            }

            queryEntity.TreadWidth = string.IsNullOrEmpty(Request["TreadWidth"]) ? 0 : Convert.ToInt32(Request["TreadWidth"]);
            queryEntity.FlatRatio = string.IsNullOrEmpty(Request["FlatRatio"]) ? 0 : Convert.ToInt32(Request["FlatRatio"]);
            queryEntity.Batch = Convert.ToString(Request["Batch"]);//批次
            queryEntity.ProductCode = Convert.ToString(Request["ProductCode"]);//产品编码
            queryEntity.Figure = Convert.ToString(Request["Figure"]);//花纹
            queryEntity.HubDiameter = string.IsNullOrEmpty(Request["HubDiameter"]) ? 0 : Convert.ToInt32(Request["HubDiameter"]);
            queryEntity.LoadIndex = Convert.ToString(Request["LoadIndex"]);
            if (!string.IsNullOrEmpty(Request["SalePrice"]))//销售价格
            {
                queryEntity.SalePrice = Convert.ToDecimal(Request["SalePrice"]);
            }
            if (Request["SpecsType"] != "-1")
            {
                queryEntity.SpecsType = Convert.ToString(Request["SpecsType"]);
            }
            if (!string.IsNullOrEmpty(Request["BatchWeek"]))//查询预警库存
            {
                queryEntity.BatchWeek = Convert.ToInt32(Request["BatchWeek"]);
            }
            if (Request["PriceType"] != "-1")
            {
                queryEntity.PriceType = Convert.ToInt32(Request["PriceType"]);
            }

            if (Request["BelongDepart"] != "-1") { queryEntity.BelongDepart = Convert.ToString(Request["BelongDepart"]); }
            //queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限
            if (!string.IsNullOrEmpty(Request["SuppClientNum"]))
            {
                queryEntity.SuppClientNum = Convert.ToInt32(Request["SuppClientNum"]);
                if (!string.IsNullOrEmpty(Convert.ToString(Request["HouseID"]).Replace("undefined", "")))//一级分类
                {
                    queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(Convert.ToString(Request["HouseID"]).Replace("undefined", "")))//一级分类
                {
                    queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
                }
                else
                {
                    queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                }
            }
            //一级仓库
            if (!string.IsNullOrEmpty(Request["HAID"]))
            {
                queryEntity.FirstAreaID = Convert.ToInt32(Request["HAID"]);
            }
            else
            {
                if (!string.IsNullOrEmpty(Request["IsShowStock"]))
                {
                    queryEntity.IsShowStock = Convert.ToString(Request["IsShowStock"]);
                }
            }
            //一级区域
            if (!string.IsNullOrEmpty(Request["HSID"]))
            {
                queryEntity.ParentAreaID = Convert.ToInt32(Request["HSID"]);
            }
            if (!string.IsNullOrEmpty(Request["ProductID"]))//产品ID
            {
                queryEntity.ProductID = Convert.ToInt64(Request["ProductID"]);
            }
            if (!string.IsNullOrEmpty(Request["ClientNum"]))
            {
                queryEntity.PayClientNum = Convert.ToInt32(Request["ClientNum"]);
            }
            //所属公司
            if (Request["Company"] != "-1") { queryEntity.Company = Convert.ToString(Request["Company"]); }

            List<CargoContainerShowEntity> list = bus.QueryALLHouseStockData(1, 100000, queryEntity);

            if (list != null) { StockData = list; }

            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
            Response.Flush();
        }
        /// <summary>
        /// 查询所有在库的产品数据
        /// </summary>
        public void QueryALLHouseData()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            CargoHouseBus bus = new CargoHouseBus();
            //queryEntity.Specs = Convert.ToString(Request["Specs"]);
            string spe = Convert.ToString(Request["Specs"]).ToUpper();
            if (UserInfor.HouseID.Equals(62))
            {
                //太石仓库特殊处理
                queryEntity.Specs = spe;
                queryEntity.HouseID = UserInfor.HouseID;
            }
            else
            {
                if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
                {
                    queryEntity.Specs = spe;
                }
                else
                {
                    if (spe.Length <= 3)
                    {
                        queryEntity.Specs = spe;
                    }
                    if (spe.Length > 3 && spe.Length <= 5)
                    {
                        queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                    }
                    if (spe.Length > 5)
                    {
                        queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                    }
                }
            }
            queryEntity.ProductName = Convert.ToString(Request["ProductName"]);
            queryEntity.Model = Convert.ToString(Request["Model"]);
            queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            queryEntity.ContainerCode = Convert.ToString(Request["ContainerCode"]);
            if (!string.IsNullOrEmpty(Request["PID"]))//一级分类
            {
                queryEntity.TypeParentID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))//二级分类
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SID"]);
            }
            else if (UserInfor.RoleID == 42)
            {
                queryEntity.TypeIDs = "34,345";
            }
            if (Request["BatchYear"] != "-1")
            {
                queryEntity.BatchYear = Convert.ToInt32(Request["BatchYear"]);
            }
            if (Request["Born"] != "-1")
            {
                queryEntity.Born = Convert.ToString(Request["Born"]);
            }
            if (Request["BelongDepart"] != "-1")
            {
                queryEntity.BelongDepart = Convert.ToString(Request["BelongDepart"]);
            }
            if (Request["IsQueryLockStock"] == "0")
            {
                queryEntity.IsLockStock = "0";
            }
            else
            {
                if (Request["IsLockStock"] != "-1")
                {
                    queryEntity.IsLockStock = Convert.ToString(Request["IsLockStock"]);
                }
            }

            queryEntity.TreadWidth = string.IsNullOrEmpty(Request["TreadWidth"]) ? 0 : Convert.ToInt32(Request["TreadWidth"]);
            queryEntity.FlatRatio = string.IsNullOrEmpty(Request["FlatRatio"]) ? 0 : Convert.ToInt32(Request["FlatRatio"]);
            queryEntity.Batch = Convert.ToString(Request["Batch"]);//批次
            queryEntity.ProductCode = Convert.ToString(Request["ProductCode"]);//产品编码
            queryEntity.Figure = Convert.ToString(Request["Figure"]);//花纹
            queryEntity.HubDiameter = string.IsNullOrEmpty(Request["HubDiameter"]) ? 0 : Convert.ToInt32(Request["HubDiameter"]);
            queryEntity.LoadIndex = Convert.ToString(Request["LoadIndex"]);
            if (!string.IsNullOrEmpty(Request["SalePrice"]))//销售价格
            {
                queryEntity.SalePrice = Convert.ToDecimal(Request["SalePrice"]);
            }
            if (Request["SpecsType"] != "-1")
            {
                queryEntity.SpecsType = Convert.ToString(Request["SpecsType"]);
            }
            if (!string.IsNullOrEmpty(Request["BatchWeek"]))//查询预警库存
            {
                queryEntity.BatchWeek = Convert.ToInt32(Request["BatchWeek"]);
            }
            if (Request["PriceType"] != "-1")
            {
                queryEntity.PriceType = Convert.ToInt32(Request["PriceType"]);
            }

            if (Request["BelongDepart"] != "-1") { queryEntity.BelongDepart = Convert.ToString(Request["BelongDepart"]); }
            //queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限
            if (!string.IsNullOrEmpty(Request["SuppClientNum"]))
            {
                queryEntity.SuppClientNum = Convert.ToInt32(Request["SuppClientNum"]);
                if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
                {
                    queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
                {
                    queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
                }
                else
                {
                    queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                }
            }
            //一级仓库
            if (!string.IsNullOrEmpty(Request["HAID"]))
            {
                if (Request["HAID"].Contains(","))
                    queryEntity.ParamFirstAreaID = Convert.ToString(Request["HAID"]);
                else
                    queryEntity.FirstAreaID = Convert.ToInt32(Request["HAID"]);
            }
            else
            {
                if (!string.IsNullOrEmpty(Request["IsShowStock"]))
                {
                    queryEntity.IsShowStock = Convert.ToString(Request["IsShowStock"]);
                }
            }
            //一级区域
            if (!string.IsNullOrEmpty(Request["HSID"]))
            {
                if (Request["HSID"].Contains(","))
                    queryEntity.ParamParentAreaID = Convert.ToString(Request["HSID"]);
                else
                    queryEntity.ParentAreaID = Convert.ToInt32(Request["HSID"]);
            }
            if (!string.IsNullOrEmpty(Request["ProductID"]))//产品ID
            {
                queryEntity.ProductID = Convert.ToInt64(Request["ProductID"]);
            }
            if (!string.IsNullOrEmpty(Request["ClientNum"]))
            {
                queryEntity.PayClientNum = Convert.ToInt32(Request["ClientNum"]);
            }

            if (Request["TyreModel"] != "-1") { queryEntity.TyreModel = Convert.ToString(Request["TyreModel"]); }

            //所属公司
            if (Request["Company"] != "-1") { queryEntity.Company = Convert.ToString(Request["Company"]); }
            //int ADID = Convert.ToInt32(Request["ADID"]);
            //CargoClientBus clibus = new CargoClientBus();
            //CargoClientAcceptAddressEntity clientity = clibus.QueryAcceptAddressInfo(new CargoClientAcceptAddressEntity() { ADID = ADID });
            //string Longitude = "", Latitude = "";
            //if (string.IsNullOrEmpty(clientity.Latitude) || string.IsNullOrEmpty(clientity.Longitude))
            //{
            //    if (!string.IsNullOrEmpty(clientity.AcceptAddress))
            //    {
            //        string[] coordinate = geocodeAddress(clientity.AcceptProvince, clientity.AcceptCity, clientity.AcceptAddress);
            //        if (!string.IsNullOrEmpty(coordinate[0]) && !string.IsNullOrEmpty(coordinate[1]))
            //        {
            //            Longitude = coordinate[0];
            //            Latitude = coordinate[1];
            //            CargoClientBus clientBus = new CargoClientBus();
            //            LogEntity log = new LogEntity();
            //            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            //            log.Moudle = "客户管理";
            //            log.NvgPage = "客户管理";
            //            log.Status = "0";
            //            log.UserID = UserInfor.LoginName;
            //            log.Operate = "U";
            //            clientBus.UpdateCargoClientClientity(new CargoClientAcceptAddressEntity { ADID = ADID, Longitude = Longitude, Latitude = Latitude }, log);
            //        }
            //    }
            //}
            //else
            //{
            //    Longitude = clientity.Longitude;
            //    Latitude = clientity.Latitude;
            //}
            //Dictionary<int, List<object>> AreaCoordinateDic = new Dictionary<int, List<object>>();
            //if (!string.IsNullOrEmpty(Request["HouseID"]))
            //{
            //    List<CargoAreaEntity> area = bus.QueryALLArea(new CargoAreaEntity { HouseID = Convert.ToInt32(queryEntity.CargoPermisID), ParentID = 0 });
            //    foreach (var item in area)
            //    {
            //        if (!string.IsNullOrEmpty(item.Longitude) && !string.IsNullOrEmpty(item.Latitude))
            //        {
            //            List<object> coordinate = new List<object>();
            //            coordinate.Add(item.Latitude);
            //            coordinate.Add(item.Longitude);
            //            AreaCoordinateDic.Add(item.AreaID, coordinate);
            //        }
            //    }
            //}
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            List<CargoContainerShowEntity> list = bus.QueryALLHouseData(queryEntity);

            //if (AreaCoordinateDic.Count > 0)
            //{
            //    Dictionary<string, List<object>> parametersDic = parameters(Latitude, Longitude, AreaCoordinateDic);
            //    if (parametersDic.Count > 0)
            //    {
            //        List<ParametersDic> parametersList = new List<ParametersDic>();
            //        foreach (var item in parametersDic)
            //        {
            //            parametersList.Add(new ParametersDic
            //            {
            //                FirstAreaID = Convert.ToInt32(item.Key),
            //                Distance = item.Value[0].ToString(),
            //                Duration = item.Value[1].ToString()
            //            });
            //        }
            //        parametersList = parametersList.OrderBy(e => e.Distance).ToList();

            //        int[] orderArr = new int[] { };
            //        Dictionary<int, List<object>> orderDic = new Dictionary<int, List<object>>();
            //        foreach (var item in parametersList)
            //        {
            //            List<object> coordinate = new List<object>();
            //            coordinate.Add(item.Distance);
            //            coordinate.Add(item.Duration);
            //            orderDic.Add(item.FirstAreaID, coordinate);
            //            orderArr = orderArr.Concat(new int[] { item.FirstAreaID }).ToArray();
            //        }
            //        List<CargoContainerShowEntity> newList = new List<CargoContainerShowEntity>();
            //        foreach (var item in list)
            //        {
            //            if (orderArr.Contains(item.FirstAreaID))
            //            {
            //                if (orderDic.ContainsKey(item.FirstAreaID))
            //                {
            //                    List<object> coordinate;
            //                    orderDic.TryGetValue(item.FirstAreaID, out coordinate);
            //                    item.Distance = coordinate[0].ToString();
            //                    item.Duration = coordinate[1].ToString();
            //                }
            //            }
            //            newList.Add(item);
            //        }
            //        list = newList.OrderBy(e =>
            //        {
            //            var index = 0;
            //            index = Array.IndexOf(orderArr, e.FirstAreaID);
            //            if (index != -1) { return index; }
            //            else
            //            {
            //                return int.MaxValue;
            //            }
            //        }).ToList();
            //    }
            //}

            List<CargoContainerShowEntity> footlist = new List<CargoContainerShowEntity>();
            footlist.Add(new CargoContainerShowEntity
            {
                HouseName = "汇总：",
                Piece = list.Sum(c => c.Piece),
                OverDueFee = list.Sum(c => c.OverDueFee),
                InCargoStatus = ""
            });
            Hashtable resHT = new Hashtable();
            resHT["rows"] = list;
            resHT["total"] = list.Count();
            resHT["footer"] = footlist;
            if (list.Count > 0) { StockData = list; StockDataType = Convert.ToString(Request["HouseID"]); }
            //JSON
            String json = JSON.Encode(resHT);
            Response.Clear();
            Response.Write(json);
        }
        public Dictionary<string, List<object>> parameters(string EndLat, string EndLng, Dictionary<int, List<object>> Dic)
        {
            string from = "";
            Dictionary<string, List<object>> returnDic = new Dictionary<string, List<object>>();
            List<object> area = new List<object>();
            foreach (var item in Dic)
            {
                area.Add(item.Key);
                foreach (var coordinate in item.Value)
                {
                    from += coordinate + ",";
                }
                from = from.Substring(0, from.Length - 1);
                from += ";";
            }
            from = from.Substring(0, from.Length - 1);
            string url = "https://apis.map.qq.com/ws/distance/v1/matrix/?mode=driving&from=" + from + "&to=" + EndLat + "," + EndLng + "&key=" + "CMZBZ-64RLS-7FROW-6SNUF-C3P5Z-DGB2J";
            string returnJson = wxHttpUtility.SendGetHttpRequest(url, "application/json");
            JavaScriptSerializer js = new JavaScriptSerializer();
            ParametersReturnJson list = js.Deserialize<ParametersReturnJson>(returnJson);
            if (list.status == "0")
            {
                var elements = list.result.rows;
                if (elements.Count > 0)
                {
                    int count = area.Count();
                    int i = 0;
                    foreach (var item in elements)
                    {
                        if (i < count)
                        {
                            List<object> coordinate = new List<object>();
                            coordinate.Add(item.elements[0].distance);
                            coordinate.Add(item.elements[0].duration);
                            returnDic.Add(area[i].ToString(), coordinate);
                            i++;
                        }
                    }
                }
            }
            return returnDic;
        }
        /// <summary>
        /// 根据地址查询经纬度
        /// </summary>
        /// <param name="Address"></param>
        /// <returns></returns>
        public string[] geocodeAddress(string Province, string Dest, string Address)
        {
            string[] coordinate = new string[2];
            try
            {
                string url = "https://apis.map.qq.com/ws/geocoder/v1/?address=" + Province + Dest + Address + "&key=CMZBZ-64RLS-7FROW-6SNUF-C3P5Z-DGB2J";
                string returnJson = wxHttpUtility.SendGetHttpRequest(url, "application/json");
                if (returnJson.IndexOf("查询无结果") < 0)
                {
                    returnJson = Regex.Replace(returnJson, @"\s", "");
                    returnJson = Regex.Replace(returnJson, "[ \\[ \\] \\^ \\-_*×――(^)（^）$%~!@#$…&%￥—+=<>《》!！??？{}:：•`·、。，；,;\"‘’“”-]", "");
                    string strtempa = "location";
                    returnJson = returnJson.Substring(returnJson.IndexOf(strtempa) + strtempa.Length, returnJson.Length - returnJson.IndexOf(strtempa) - strtempa.Length);
                    strtempa = "lng";
                    string strtempb = "lat";
                    string lng = returnJson.Substring(returnJson.IndexOf(strtempa) + strtempa.Length, returnJson.IndexOf(strtempb) - (returnJson.IndexOf(strtempa) + strtempa.Length));
                    strtempa = "lat"; strtempb = "adinfo";
                    string lat = returnJson.Substring(returnJson.IndexOf(strtempa) + strtempa.Length, returnJson.IndexOf(strtempb) - (returnJson.IndexOf(strtempa) + strtempa.Length));
                    coordinate[0] = lng;
                    coordinate[1] = lat;
                }
            }
            catch (Exception)
            {

            }
            return coordinate;
        }
        /// <summary>
        /// 库存数据导出实体
        /// </summary>
        public List<CargoContainerShowEntity> StockData
        {
            get
            {
                if (Session["StockData"] == null)
                {
                    Session["StockData"] = new List<CargoContainerShowEntity>();
                }
                return (List<CargoContainerShowEntity>)(Session["StockData"]);
            }
            set
            {
                Session["StockData"] = value;
            }
        }
        /// <summary>
        /// 库存数据导出类型实体
        /// </summary>
        public string StockDataType
        {
            get
            {
                if (Session["StockDataType"] == null)
                {
                    Session["StockDataType"] = "";
                }
                return (string)(Session["StockDataType"]);
            }
            set
            {
                Session["StockDataType"] = value;
            }
        }
        /// <summary>
        /// 保存出库单数据
        /// </summary>
        public void saveOutCargoData()
        {
            string json = Request["data"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            List<CargoContainerShowEntity> entDest = new List<CargoContainerShowEntity>();
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "出库管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "A";
            log.Status = "0";
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            string htnum = string.Empty;
            try
            {
                if (msg.Result)
                {
                    string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                    foreach (Hashtable rows in GridRows)
                    {
                        CargoContainerShowEntity ent = new CargoContainerShowEntity();

                        ent.OutCargoID = outID;
                        ent.ContainerID = Convert.ToInt32(rows["ContainerID"]);
                        ent.TypeID = Convert.ToInt32(rows["TypeID"]);
                        ent.ProductID = Convert.ToInt64(rows["ProductID"]);
                        ent.Piece = Convert.ToInt32(rows["InPiece"]) - Convert.ToInt32(rows["Piece"]);//出库件数
                        ent.InPiece = Convert.ToInt32(rows["InPiece"]);
                        ent.ID = Convert.ToInt64(rows["ID"]);

                        ent.TypeName = Convert.ToString(rows["TypeName"]).Trim();
                        ent.HouseName = Convert.ToString(rows["HouseName"]).Trim();
                        ent.AreaName = Convert.ToString(rows["AreaName"]).Trim();
                        ent.ProductName = Convert.ToString(rows["ProductName"]).Trim();
                        ent.Model = Convert.ToString(rows["Model"]).Trim();
                        ent.Specs = Convert.ToString(rows["Specs"]).Trim();
                        ent.Figure = Convert.ToString(rows["Figure"]).Trim();
                        entDest.Add(ent);

                        //仓库同步缓存
                        CargoProductEntity syncProduct = bus.SyncTypeProduct(ent.ProductID.ToString());
                        if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "Cass"))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                        }
                        if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "DILE"))
                        {
                            RedisHelper.HashSet("HCYCHouseStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                        }
                        if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "Tuhu"))
                        {
                            RedisHelper.HashSet("TuhuStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                        }
                    }


                    bus.saveOutCargoData(entDest, log);
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 打印出库单
        /// </summary>
        public void QueryNoPrintOutCargoAwbData()
        {
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoContainerShowEntity> list = bus.QueryNoPrintOutCargoAwbData(new CargoContainerShowEntity { IsPrintOutCargo = false });

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询出库单数据
        /// </summary>
        public void QueryOutHouseData()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            queryEntity.OutCargoID = Convert.ToString(Request["OutCargoID"]);
            queryEntity.Piece = string.IsNullOrEmpty(Convert.ToString(Request["Piece"])) ? 0 : Convert.ToInt32(Request["Piece"]);
            if (Request["IsPrintOutCargo"] != "-1")
            {
                queryEntity.IsPrint = Convert.ToString(Request["IsPrintOutCargo"]);//是否打印出库单 0否，1打印
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.QueryOutHouseData(pageIndex, pageSize, queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 快照管理
        /// <summary>
        /// 查询快照数据
        /// </summary>
        public void QueryStockSnapData()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            //queryEntity.Specs = Convert.ToString(Request["Specs"]);
            string spe = Convert.ToString(Request["Specs"]).ToUpper();
            if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
            {
                queryEntity.Specs = spe;
            }
            else
            {
                if (spe.Length <= 3)
                {
                    queryEntity.Specs = spe;
                }
                if (spe.Length > 3 && spe.Length <= 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                }
                if (spe.Length > 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                }
            }
            //queryEntity.ProductName = Convert.ToString(Request["ProductName"]);
            queryEntity.Model = Convert.ToString(Request["Model"]);
            queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            if (!string.IsNullOrEmpty(Request["PID"]))//一级分类
            {
                queryEntity.TypeParentID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))//二级分类
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SID"]);
            }
            queryEntity.Batch = Convert.ToString(Request["Batch"]);//批次
            queryEntity.Figure = Convert.ToString(Request["Figure"]);//花纹
            //if (!string.IsNullOrEmpty(Request["HouseID"]))
            //{
            //    queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);//所属仓库ID
            //}
            //一级仓库
            if (!string.IsNullOrEmpty(Request["HAID"]))
            {
                queryEntity.FirstAreaID = Convert.ToInt32(Request["HAID"]);
            }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AStartDate"]))) { queryEntity.SnapStartDate = Convert.ToDateTime(Request["AStartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AEndDate"]))) { queryEntity.SnapEndDate = Convert.ToDateTime(Request["AEndDate"]); }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoReportBus bus = new CargoReportBus();
            Hashtable list = bus.QueryStockSnapData(pageIndex, pageSize, queryEntity);

            //if (list.Count > 0) { StockData = list; }
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 导出
        /// </summary>
        public void QueryStockSnapDataForExport()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            //查询条件
            string key = Request["key"];
            if (string.IsNullOrEmpty(key)) { Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return; }
            string[] arr = key.Split(',');
            for (int i = 0; i < arr.Length; i++)
            {
                switch (i)
                {
                    case 0:
                        if (!string.IsNullOrEmpty(arr[i]))
                        {
                            string spe = Convert.ToString(arr[i]).ToUpper();
                            if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
                            {
                                queryEntity.Specs = spe;
                            }
                            else
                            {
                                if (spe.Length <= 3)
                                {
                                    queryEntity.Specs = spe;
                                }
                                if (spe.Length > 3 && spe.Length <= 5)
                                {
                                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                                }
                                if (spe.Length > 5)
                                {
                                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                                }
                            }
                        }
                        break;
                    case 1:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.Model = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 2:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.Figure = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 3:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.TypeParentID = Convert.ToInt32(arr[i].Trim()); }
                        break;
                    case 4:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.TypeID = Convert.ToInt32(arr[i].Trim()); }
                        break;
                    case 5:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.GoodsCode = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 6:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.Batch = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 7:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.StartDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 8:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.EndDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 9:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.SnapStartDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 10:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.SnapEndDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 11:
                        if (!string.IsNullOrEmpty(arr[i]))
                        {
                            //queryEntity.HouseID = Convert.ToInt32(arr[i].Trim());
                            queryEntity.CargoPermisID = Convert.ToString(arr[i].Trim());//所属仓库ID
                        }
                        else
                        {
                            queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                        }
                        break;
                    case 12:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.FirstAreaID = Convert.ToInt32(arr[i].Trim()); }
                        break;
                    default:
                        break;
                }
            }

            CargoReportBus bus = new CargoReportBus();
            List<CargoContainerShowEntity> list = bus.QueryStockSnapDataForExport(queryEntity);
            string err = "OK";
            if (list.Count > 0) { StockData = list; StockDataType = Convert.ToString(queryEntity.HouseID); }
            else { err = "没有数据可以进行导出，请重新查询！"; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 生成二维码图片
        /// <summary>
        /// 生成二维码图片
        /// </summary>
        public void MakeQRCode()
        {
            string result = Convert.ToString(Request["Code"]);

            //创建二维码生成类  
            QRCodeEncoder qrCodeEncoder = new QRCodeEncoder();
            try
            {
                qrCodeEncoder.QRCodeScale = 4;
            }
            catch { }
            String data = result;
            System.IO.MemoryStream ms = new System.IO.MemoryStream();
            qrCodeEncoder.QRCodeBackgroundColor = System.Drawing.Color.White; //背景颜色
            // qrCodeEncoder.QRCodeEncodeMode = QRCodeEncoder.ENCODE_MODE.ALPHA_NUMERIC;
            qrCodeEncoder.QRCodeForegroundColor = System.Drawing.Color.Black;//图像颜色
            //设置编码版本  
            qrCodeEncoder.QRCodeVersion = 0;

            System.Drawing.Image myimg = qrCodeEncoder.Encode(data, System.Text.Encoding.UTF8); //kedee 增加utf-8编码，可支持中文汉字  
            myimg.Save(ms, System.Drawing.Imaging.ImageFormat.Gif);
            Response.ClearContent();
            Response.ContentType = "image/Gif";
            Response.BinaryWrite(ms.ToArray());
            Response.Flush();
        }
        #endregion
        #region 安全库存操作方法集合
        public void SycSaleQty()
        {
            CargoHouseBus bus = new CargoHouseBus();
            ErrMessage msg = new ErrMessage();
            msg.Message = "同步最新销量数据成功";
            msg.Result = true;
            try
            {
                bus.SycSaleQty();
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.Flush();
        }
        public void QuerySafeStockDataBatch()
        {
            CargoSafeStockEntity queryEntity = new CargoSafeStockEntity();
            if (!string.IsNullOrEmpty(Request["HouseID"]))
            {
                queryEntity.HouseID = Convert.ToString(Request["HouseID"]);
            }
            else
            {
                queryEntity.HouseID = UserInfor.CargoPermisID;
            }
            if (!string.IsNullOrEmpty(Request["AreaID"]))
            {
                queryEntity.ParamAreaID = Convert.ToString(Request["AreaID"]);
            }
            if (!string.IsNullOrEmpty(Request["PID"]))//一级分类
            {
                queryEntity.ParentID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))//二级分类
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SID"]);
            }
            queryEntity.Specs = Convert.ToString(Request["Specs"]);
            queryEntity.Figure = Convert.ToString(Request["Figure"]);
            queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            queryEntity.ProductCode = Convert.ToString(Request["ProductCode"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            //分页
            //int pageIndex = Convert.ToInt32(Request["page"]);
            //int pageSize = Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoSafeStockEntity> list = bus.QuerySafeStockData(queryEntity);

            List<CargoSafeStockEntity> footlist = new List<CargoSafeStockEntity>();
            footlist.Add(new CargoSafeStockEntity
            {
                HouseName = "汇总：",
                ProductCode = list.Count().ToString() + "条数据",
                MinStock = list.Sum(c => c.MinStock),
                MaxStock = list.Sum(c => c.MaxStock),
                LessNum = list.Sum(c => c.LessNum),
                StockNum = list.Sum(c => c.StockNum),
                CurNum = list.Sum(c => c.CurNum),
                MoveNum = list.Sum(c => c.MoveNum),
                PurchaseMoveNum = list.Sum(c => c.PurchaseMoveNum),
                TransferMoveNum = list.Sum(c => c.TransferMoveNum),
                TotalNum = list.GroupBy(x => new { x.ProductCode, x.TypeID, x.GoodsCode }).Select(x => x.FirstOrDefault()).Sum(c => c.TotalNum),
                WXSaleNum = list.Sum(c => c.WXSaleNum),
                SaleNum = list.Sum(c => c.SaleNum),
                TotalSaleNum = list.GroupBy(x => new { x.ProductCode, x.TypeID, x.GoodsCode }).Select(x => x.FirstOrDefault()).Sum(c => c.TotalSaleNum),
                AvgSaleNum = list.Sum(c => c.AvgSaleNum),
                IsolatedStock = list.Sum(c => c.IsolatedStock),
                ControlStock = list.Sum(c => c.ControlStock),
                MaxStockDay = list.Sum(c => c.MaxStockDay),
                MinStockDay = list.Sum(c => c.MinStockDay),
                DOI = list.Sum(c => c.DOI),
                ExcessNum = list.Sum(c => c.ExcessNum),
                OEStock = list.Sum(c => c.OEStock),
                HCYCStock = list.Sum(c => c.HCYCStock),
                REStock = list.Sum(c => c.REStock)
            });
            Hashtable resHT = new Hashtable();
            resHT["rows"] = list;
            resHT["total"] = list.Count();
            resHT["footer"] = footlist;
            //JSON
            string json = JSON.Encode(resHT);
            Response.Clear();
            Response.Write(json);
            Response.Flush();
        }
        /// <summary>
        /// 安全库存导出
        /// </summary>
        public void QuerySafeStockDataForExport()
        {
            CargoSafeStockEntity queryEntity = new CargoSafeStockEntity();
            if (!string.IsNullOrEmpty(Request["HouseID"]))
            {
                queryEntity.HouseID = Convert.ToString(Request["HouseID"]);
            }
            else
            {
                //queryEntity.HouseID = UserInfor.CargoPermisID;
            }
            if (!string.IsNullOrEmpty(Request["AreaID"]))
            {
                queryEntity.ParamAreaID = Convert.ToString(Request["AreaID"]);
            }
            if (!string.IsNullOrEmpty(Request["PID"]))//一级分类
            {
                queryEntity.ParentID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))//二级分类
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SID"]);
            }
            queryEntity.Specs = Convert.ToString(Request["Specs"]);
            queryEntity.Figure = Convert.ToString(Request["Figure"]);
            queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            queryEntity.ProductCode = Convert.ToString(Request["ProductCode"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoSafeStockEntity> productEntities = bus.QuerySafeStockData(queryEntity);
            string err = "OK";
            if (productEntities.Count > 0) { CargoSafeStockData = productEntities; } else { err = "没有数据可以进行导出，请重新查询！"; }
            //JSON
            String result = JSON.Encode(err);
            Response.Clear();
            Response.Write(result);

        }

        /// <summary>
        /// 导出安全库存数据Excel到本地
        /// </summary>
        public void ExportSafeStockToLocExcel()
        {
            CargoSafeStockEntity queryEntity = new CargoSafeStockEntity();
            var today = DateTime.Today;
            // 上个月的最后一天
            var lastMonthEnd = new DateTime(today.Year, today.Month, 1).AddDays(-1);
            // 上个月往前推 3 个月的第一天
            var startDate = new DateTime(lastMonthEnd.Year, lastMonthEnd.Month, 1).AddMonths(-2);

            queryEntity.StartDate = startDate;
            queryEntity.EndDate = lastMonthEnd;

            // 查询安全库存数据
            CargoHouseBus houseBus = new CargoHouseBus();
            List<CargoSafeStockEntity> dataList = houseBus.QuerySafeStockData(queryEntity);

            if (dataList == null || dataList.Count == 0)
            {
                Response.Clear();
                Response.Write(JSON.Encode("没有数据可以进行导出，请重新查询！"));
                return;
            }

            // 创建DataTable（同SafeStock.aspx.cs的列结构）
            DataTable table = new DataTable("安全库存数据");
            table.Columns.Add("序号", typeof(int));
            table.Columns.Add("区域大仓", typeof(string));
            table.Columns.Add("所属仓库", typeof(string));
            table.Columns.Add("品牌", typeof(string));
            table.Columns.Add("产品编码", typeof(string));
            table.Columns.Add("规格", typeof(string));
            table.Columns.Add("花纹", typeof(string));
            table.Columns.Add("货品代码", typeof(string));
            table.Columns.Add("载重指数", typeof(string));
            table.Columns.Add("速度级别", typeof(string));
            table.Columns.Add("月均销量", typeof(int));
            table.Columns.Add("最小库存", typeof(int));
            table.Columns.Add("最大库存", typeof(int));
            table.Columns.Add("安全库存", typeof(int));
            table.Columns.Add("在库库存", typeof(int));
            table.Columns.Add("采购在途", typeof(int));
            table.Columns.Add("移库在途", typeof(int));
            table.Columns.Add("合计在途", typeof(int));
            table.Columns.Add("可调拨数", typeof(int));
            table.Columns.Add("库存度天数", typeof(int));
            table.Columns.Add("补货数量", typeof(int));
            table.Columns.Add("全国在库库存", typeof(int));
            table.Columns.Add("云仓销售数量", typeof(int));
            table.Columns.Add("本仓全渠道销量", typeof(int));
            table.Columns.Add("全国销售数量", typeof(int));
            table.Columns.Add("最小库存度天数", typeof(int));
            table.Columns.Add("最大库存度天数", typeof(int));
            table.Columns.Add("OE安全库存数", typeof(int));
            table.Columns.Add("YC安全库存数", typeof(int));
            table.Columns.Add("RE安全库存数", typeof(int));
            table.Columns.Add("品控库存数", typeof(int));
            table.Columns.Add("隔离库存数", typeof(int));

            // 填充数据
            int i = 0;
            foreach (var item in dataList)
            {
                i++;
                DataRow row = table.NewRow();
                row["序号"] = i;
                row["区域大仓"] = item.HouseName;
                row["所属仓库"] = item.AreaName;
                row["品牌"] = item.TypeName;
                row["产品编码"] = item.ProductCode;
                row["规格"] = item.Specs?.Trim();
                row["花纹"] = item.Figure?.Trim();
                row["货品代码"] = item.GoodsCode?.Trim();
                row["载重指数"] = item.LoadIndex;
                row["速度级别"] = item.SpeedLevel;
                row["最小库存"] = item.MinStock ?? (object)DBNull.Value;
                row["最大库存"] = item.MaxStock ?? (object)DBNull.Value;
                row["补货数量"] = item.LessNum;
                row["安全库存"] = item.StockNum;
                row["在库库存"] = item.CurNum;
                row["采购在途"] = item.PurchaseMoveNum ?? (object)DBNull.Value;
                row["移库在途"] = item.TransferMoveNum ?? (object)DBNull.Value;
                row["合计在途"] = item.MoveNum ?? (object)DBNull.Value;
                row["可调拨数"] = item.ExcessNum ?? (object)DBNull.Value;
                row["全国在库库存"] = item.TotalNum ?? (object)DBNull.Value;
                row["云仓销售数量"] = item.WXSaleNum ?? (object)DBNull.Value;
                row["本仓全渠道销量"] = item.SaleNum;
                row["全国销售数量"] = item.TotalSaleNum ?? (object)DBNull.Value;
                row["月均销量"] = item.AvgSaleNum ?? (object)DBNull.Value;
                row["库存度天数"] = item.DOI ?? (object)DBNull.Value;
                row["最小库存度天数"] = item.MinStockDay ?? (object)DBNull.Value;
                row["最大库存度天数"] = item.MaxStockDay ?? (object)DBNull.Value;
                row["品控库存数"] = item.ControlStock ?? (object)DBNull.Value;
                row["隔离库存数"] = item.IsolatedStock ?? (object)DBNull.Value;
                row["OE安全库存数"] = item.OEStock ?? (object)DBNull.Value;
                row["YC安全库存数"] = item.HCYCStock ?? (object)DBNull.Value;
                row["RE安全库存数"] = item.REStock ?? (object)DBNull.Value;

                table.Rows.Add(row);
            }

            // Excel文件保存逻辑（同SyncStockData）
            var fileName = "安全库存数据-" + DateTime.Now.ToString("yyyyMMddHHmm") + ".xlsx";
            var filePath = string.Empty;
            var fileFolder = GetStockFile();
            if (Debugger.IsAttached)
            {
                fileFolder = "D:\\Work\\WareHouse2\\Files\\新建文件夹";
            }
            filePath = System.IO.Path.Combine(fileFolder, fileName);
            ToExcel.DataTableToExcel(table, filePath);

            if (File.Exists(filePath))
            {
                // 记录文件日志到数据库
                houseBus.saveFileLog(new CargoStockDownloadEntity { FileName = fileName, FilePath = filePath });

                // 清理超过一个月的旧文件
                if (Directory.Exists(fileFolder))
                {
                    string[] files = Directory.GetFiles(fileFolder);
                    foreach (string file in files)
                    {
                        DateTime createTime = File.GetCreationTime(file);
                        if (createTime < DateTime.Now.AddMonths(-1))
                        {
                            File.Delete(file);
                        }
                    }
                }

            }
        }
        public void SaveSafeStockData()
        {
            CargoSafeStockEntity ent = new CargoSafeStockEntity();
            CargoHouseBus bus = new CargoHouseBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "安全库存";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;
            String SID = Request["SID"] != null ? Request["SID"].ToString() : "";
            try
            {
                ent.HouseID = Convert.ToString(Request["HouseID"]);
                ent.AreaID = Convert.ToInt32(Request["AreaID"]);
                ent.TypeID = Convert.ToInt32(Request["TypeID"]);
                ent.Specs = Convert.ToString(Request["Specs"]);
                ent.Figure = Convert.ToString(Request["Figure"]);
                ent.GoodsCode = Convert.ToString(Request["GoodsCode"]);
                ent.LoadIndex = Convert.ToString(Request["LoadIndex"]);
                ent.SpeedLevel = Convert.ToString(Request["SpeedLevel"]);
                ent.OPID = UserInfor.LoginName;
                ent.OP_DATE = DateTime.Now;
                ent.ProductCode = Convert.ToString(Request["ProductCode"]);

                ent.StockNum = int.TryParse(Request["StockNum"], out int stocknum_t) ? stocknum_t : 0;
                ent.MinStock = int.TryParse(Request["MinStock"], out int minstock_t) ? minstock_t : default(int?);
                ent.MaxStock = int.TryParse(Request["MaxStock"], out int maxstock_t) ? maxstock_t : default(int?);
                ent.MinStockDay = int.TryParse(Request["MinStockDay"], out int minstockDay_t) ? minstockDay_t : default(int?);
                ent.MaxStockDay = int.TryParse(Request["MaxStockDay"], out int maxstockDay_t) ? maxstockDay_t : default(int?);
                ent.HCYCStock = int.TryParse(Request["HCYCStock"], out int hcycstock_t) ? hcycstock_t : default(int?);
                ent.OEStock = int.TryParse(Request["OEStock"], out int oestock_t) ? oestock_t : default(int?);
                ent.REStock = int.TryParse(Request["REStock"], out int restock_t) ? restock_t : default(int?);
                //ent.PendingStock = int.TryParse(Request["PendingStock"], out int pendingstock_t) ? pendingstock_t : default(int?);
                ent.AvgSaleNum = int.TryParse(Request["AvgSaleNum"], out int avgsalenum_t) ? avgsalenum_t : default(int?);
                ent.IsolatedStock = int.TryParse(Request["IsolatedStock"], out int isolatedstock_t) ? isolatedstock_t : default(int?);
                ent.ControlStock = int.TryParse(Request["ControlStock"], out int controlstock_t) ? controlstock_t : default(int?);

                if (SID == "")
                {
                    if (bus.IsExistSafeStockData(ent))
                    {
                        msg.Result = false;
                        msg.Message = "已经存在相同的安全库存数据";
                    }
                    else
                    {

                        log.Operate = "A";
                        bus.InsertSafeStockData(ent, log);
                        msg.Result = true;
                        msg.Message = "成功";
                    }
                }
                else
                {
                    ent.SID = Convert.ToInt64(SID);
                    log.Operate = "U";
                    bus.UpdateSafeStockData(ent, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        public void DeleteSafeStockData()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoSafeStockEntity> list = new List<CargoSafeStockEntity>();
            CargoHouseBus bus = new CargoHouseBus();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage();
            msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "安全库存";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoSafeStockEntity
                    {
                        SID = Convert.ToInt64(row["SID"]),
                        HouseID = Convert.ToString(row["HouseID"]),
                        AreaID = Convert.ToInt32(row["AreaID"]),
                        Specs = Convert.ToString(row["Specs"]),
                        Figure = Convert.ToString(row["Figure"]),
                        GoodsCode = Convert.ToString(row["GoodsCode"]),
                        LoadIndex = Convert.ToString(row["LoadIndex"]),
                        SpeedLevel = Convert.ToString(row["SpeedLevel"]),
                        StockNum = Convert.ToInt32(row["StockNum"]),
                        OPID = UserInfor.LoginName
                    });
                }
                bus.DeleteSafeStockData(list, log);
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        /// <summary>
        /// 告警库存查询
        /// </summary>
        public void QueryWarnStockData()
        {
            CargoSafeStockEntity queryEntity = new CargoSafeStockEntity();
            if (!string.IsNullOrEmpty(Request["HouseID"]))
            {
                queryEntity.HouseID = Convert.ToString(Request["HouseID"]);
            }
            if (!string.IsNullOrEmpty(Request["AreaID"]))
            {
                queryEntity.AreaID = Convert.ToInt32(Request["AreaID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SID"]);
            }
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoSafeStockEntity> list = bus.QueryWarnStockData(queryEntity);

            List<CargoSafeStockEntity> footlist = new List<CargoSafeStockEntity>();
            footlist.Add(new CargoSafeStockEntity
            {
                HouseName = "汇总：",
                CurNum = list.Sum(c => c.CurNum),
                LessNum = list.Sum(c => c.LessNum)
            });
            Hashtable resHT = new Hashtable();
            resHT["rows"] = list;
            resHT["total"] = list.Count();
            resHT["footer"] = footlist;
            if (list.Count > 0) { CargoSafeStockData = list; }
            //JSON
            String json = JSON.Encode(resHT);
            Response.Clear();
            Response.Write(json);

        }

        /// <summary>
        /// 告警库存查询 多仓库查询
        /// </summary>
        public void QueryWarnStockDataBatch()
        {
            CargoSafeStockEntity queryEntity = new CargoSafeStockEntity();
            if (!string.IsNullOrEmpty(Request["HouseID"]))
            {
                queryEntity.HouseID = Convert.ToString(Request["HouseID"]);
            }
            if (!string.IsNullOrEmpty(Request["AreaID"]))
            {
                queryEntity.ParamAreaID = Convert.ToString(Request["AreaID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SID"]);
            }
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoSafeStockEntity> list = bus.QueryWarnStockData(queryEntity);

            List<CargoSafeStockEntity> footlist = new List<CargoSafeStockEntity>();
            footlist.Add(new CargoSafeStockEntity
            {
                HouseName = "汇总：",
                StockNum = list.Sum(c => c.StockNum),
                CurNum = list.Sum(c => c.CurNum),
                LessNum = list.Sum(c => c.LessNum),
                MoveNum = list.Sum(c => c.MoveNum)
            });
            Hashtable resHT = new Hashtable();
            resHT["rows"] = list;
            resHT["total"] = list.Count();
            resHT["footer"] = footlist;
            if (list.Count > 0) { CargoSafeStockData = list; }
            //JSON
            String json = JSON.Encode(resHT);
            Response.Clear();
            Response.Write(json);

        }
        public List<CargoSafeStockEntity> CargoSafeStockData
        {
            get
            {
                if (Session["CargoSafeStockData"] == null)
                {
                    Session["CargoSafeStockData"] = new List<CargoSafeStockEntity>();
                }
                return (List<CargoSafeStockEntity>)(Session["CargoSafeStockData"]);
            }
            set
            {
                Session["CargoSafeStockData"] = value;
            }
        }
        public List<CargoProductEntity> CargoStockBookData
        {
            get
            {
                if (Session["CargoStockBookData"] == null)
                {
                    Session["CargoStockBookData"] = new List<CargoProductEntity>();
                }
                return (List<CargoProductEntity>)(Session["CargoStockBookData"]);
            }
            set
            {
                Session["CargoStockBookData"] = value;
            }
        }
        public void QueryStockBookData()
        {
            CargoProductEntity queryEntity = new CargoProductEntity();
            if (!string.IsNullOrEmpty(Request["HouseID"]))
            {
                queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);
            }
            if (!string.IsNullOrEmpty(Request["PID"]))
            {
                queryEntity.FirstAreaID = Convert.ToInt32(Request["PID"]);
            }
            queryEntity.Specs = Convert.ToString(Request["Specs"]);
            queryEntity.Figure = Convert.ToString(Request["Figure"]);
            if (!string.IsNullOrEmpty(Request["SID"]))//二级分类
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SID"]);
            }
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoProductEntity> list = bus.QueryStockBookData(queryEntity);

            List<CargoProductEntity> footlist = new List<CargoProductEntity> { new CargoProductEntity { FirstAreaName = "汇总：", InPiece = list.Sum(c => c.InPiece), TypeName = "", Specs = "", Figure = "", LoadIndex = "", SpeedLevel = "", PurchaserName = "" } };
            Hashtable resHT = new Hashtable();
            resHT["rows"] = list;
            resHT["total"] = list.Count();
            resHT["footer"] = footlist;

            if (list.Count > 0) { CargoStockBookData = list; }
            //JSON
            String json = JSON.Encode(resHT);
            Response.Clear();
            Response.Write(json);
        }
        public void QueryStockDataByProductCode()
        {
            CargoSafeStockEntity queryEntity = new CargoSafeStockEntity();
            queryEntity.HouseIDInt = Convert.ToInt32(Request["HouseID"]);
            queryEntity.ProductCode = Convert.ToString(Request["ProductCode"]);

            CargoHouseBus bus = new CargoHouseBus();
            CargoSafeStockEntity result = new CargoSafeStockEntity();
            result = bus.QueryStockDataByProductCode(queryEntity);

            //JSON
            String json = JSON.Encode(result);
            Response.Clear();
            Response.Write(json);
        }



        #endregion
        #region 基础规格管理

        public void QueryALLProductPageData()
        {
            CargoProductEntity queryEntity = new CargoProductEntity();
            string spe = Convert.ToString(Request["Specs"]).ToUpper();
            if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
            {
                queryEntity.Specs = spe;
            }
            else
            {
                if (spe.Length <= 3)
                {
                    queryEntity.Specs = spe;
                }
                if (spe.Length > 3 && spe.Length <= 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                }
                if (spe.Length > 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                }
            }
            queryEntity.Figure = Convert.ToString(Request["Figure"]);
            queryEntity.Model = Convert.ToString(Request["Model"]);
            queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            queryEntity.ProductCode = Convert.ToString(Request["ProductCode"]);
            if (!string.IsNullOrEmpty(Request["PID"]))//一级分类
            {
                queryEntity.ParentID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))//二级分类
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SID"]);
            }
            if (!string.IsNullOrEmpty(Request["UpClientID"]))//所属公司
            {
                queryEntity.UpClientID = Convert.ToInt32(Request["UpClientID"]);
            }
            if (Request["Born"] != "-1")
            {
                queryEntity.Born = Convert.ToString(Request["Born"]);
            }
            if (Request["DelFlag"] != "-1")
            {
                queryEntity.DelFlag = Convert.ToString(Request["DelFlag"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.QueryALLProductData(pageIndex, pageSize, queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void QueryALLProductData()
        {
            CargoProductEntity queryEntity = new CargoProductEntity();
            CargoHouseBus bus = new CargoHouseBus();
            string spe = Convert.ToString(Request["Specs"]).ToUpper();
            if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
            {
                queryEntity.Specs = spe;
            }
            else
            {
                if (spe.Length <= 3)
                {
                    queryEntity.Specs = spe;
                }
                if (spe.Length > 3 && spe.Length <= 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                }
                if (spe.Length > 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                }
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Figure"])))
            {
                queryEntity.Figure = Convert.ToString(Request["Figure"]).Trim();
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Model"])))
            {
                queryEntity.Model = Convert.ToString(Request["Model"]).Trim();
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["GoodsCode"])))
            {
                queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]).Trim();
            }
            if (!string.IsNullOrEmpty(Request["SID"]))//二级分类
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SID"]);
            }
            if (Request["Born"] != "-1")
            {
                queryEntity.Born = Convert.ToString(Request["Born"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            List<CargoProductEntity> list = bus.QueryALLProductData(queryEntity);
            int[] typeStr = { 36, 18, 9, 32, 31 };
            ArrayList TypeIDList = new ArrayList(typeStr);
            foreach (var item in list)
            {
                if (!TypeIDList.Contains(item.TypeID))
                {
                    TypeIDList.Add(item.TypeID);
                }
            }
            var typeList = TypeIDList.ToArray(typeof(int)) as int[];

            list = list.OrderBy(t => Array.IndexOf(typeList, t.TypeID)).ToList();

            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void SaveProductSpecData()
        {
            CargoProductEntity ent = new CargoProductEntity();
            CargoHouseBus bus = new CargoHouseBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "产品管理";
            log.NvgPage = "基础规格管理";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;
            String id = Request["SID"] != null ? Request["SID"].ToString() : "";
            try
            {
                ent.TypeID = Convert.ToInt32(Request["TypeID"]);
                ent.TypeName = Convert.ToString(Request["TypeName"]);
                ent.Specs = Convert.ToString(Request["Specs"]).Trim();
                ent.HubDiameter = string.IsNullOrEmpty(Convert.ToString(Request["HubDiameter"])) ? 0 : Convert.ToInt32(Request["HubDiameter"]);
                ent.ProductName = Convert.ToString(Request["ProductName"]).Trim();
                ent.BrandCode = Convert.ToString(Request["BrandCode"]).Trim();
                ent.CarModel = Convert.ToString(Request["CarModel"]).Trim();
                ent.Manufacturer = Convert.ToString(Request["Manufacturer"]);
                ent.Seller = Convert.ToString(Request["Seller"]);
                ent.SellerAddress = Convert.ToString(Request["SellerAddress"]);
                ent.Servicer = Convert.ToString(Request["Servicer"]);
                ent.UpClientID = string.IsNullOrEmpty(Request["UpClientID"]) ? 1 : Convert.ToInt32(Request["UpClientID"]);
                ent.UpClientShortName = string.IsNullOrEmpty(Request["UpClientID"]) ? "狄乐汽服" : Convert.ToString(Request["UpClientShortName"]);
                ent.TyreType = Convert.ToString(Request["TyreType"]);
                ent.Figure = ent.ParentID.Equals(1) ? Convert.ToString(Request["Figure"]).Trim() : Convert.ToString(Request["Figure"]).Trim();
                ent.Model = Convert.ToString(Request["Model"]).Trim();
                ent.GoodsCode = Convert.ToString(Request["GoodsCode"]).Trim();
                ent.LoadIndex = string.IsNullOrEmpty(Convert.ToString(Request["LoadIndex"])) ? "0" : Convert.ToString(Request["LoadIndex"]);
                ent.SpeedLevel = string.IsNullOrEmpty(Convert.ToString(Request["SpeedLevel"])) ? "A1" : Convert.ToString(Request["SpeedLevel"]);
                ent.Born = Convert.ToString(Request["Born"]);
                ent.CommType = Convert.ToString(Request["CommType"]);
                ent.ProductCode = Convert.ToString(Request["ProductCode"]);
                ent.ProductUnit = Convert.ToString(Request["ProductUnit"]);
                ent.BundleNum = string.IsNullOrEmpty(Request["BundleNum"]) ? 1 : Convert.ToInt32(Request["BundleNum"]);
                ent.TreadWidth = string.IsNullOrEmpty(Convert.ToString(Request["TreadWidth"])) ? 0 : Convert.ToInt32(Convert.ToString(Request["TreadWidth"]));
                ent.FlatRatio = string.IsNullOrEmpty(Convert.ToString(Request["FlatRatio"])) ? 0 : Convert.ToInt32(Convert.ToString(Request["FlatRatio"]));
                ent.HubDiameter = string.IsNullOrEmpty(Convert.ToString(Request["HubDiameter"])) ? 0 : Convert.ToInt32(Convert.ToString(Request["HubDiameter"]));
                ent.THeight = string.IsNullOrEmpty(Convert.ToString(Request["THeight"])) ? 0 : Convert.ToInt32(Convert.ToString(Request["THeight"]));
                //ent.Assort = Convert.ToString(Request["Assort"]);
                if (ent.ProductCode.Substring(0, 2).ToUpper().Equals("LT"))
                {
                    List<CargoProductEntity> list = bus.QueryALLProductData(new CargoProductEntity { Specs = ent.Specs, Figure = ent.Figure, C_GoodsCode = ent.GoodsCode });
                    foreach (CargoProductEntity item in list)
                    {
                        if (item.SID.ToString() != id)
                        {
                            msg.Result = false;
                            msg.Message = "已经存在相同的规格数据";
                            Response.Write(JSON.Encode(msg));
                            return;
                        }
                    }
                    if (string.IsNullOrEmpty(ent.ProductName))
                    {
                        ent.ProductName = ent.TypeName + " " + ent.Specs + " " + ent.Figure + " " + ent.LoadIndex + ent.SpeedLevel;
                    }
                }
                for (int i = 0; i < Request.Files.Count; i++)
                {
                    if (Request.Files[i].ContentLength <= 0) { continue; }
                    string imgPath = string.Empty;
                    string imgName = string.Empty;
                    if (Request.Files[i].ContentLength > 0)
                    {
                        if (Request.Files.AllKeys[i].Equals("Thumbnail"))
                        {
                            Common.SavePic(Request.Files[i], "../upload/ProductSpecFile/" + Convert.ToInt32(Request["TypeID"]), ref imgName, ref imgPath);
                            if (!string.IsNullOrEmpty(imgPath))
                            {
                                ent.Thumbnail = imgPath;
                            }
                        }
                        else if (Request.Files.AllKeys[i].Equals("DetailDrawing"))
                        {
                            Common.SavePic(Request.Files[i], "../upload/ProductSpecFile/" + Convert.ToInt32(Request["TypeID"]), ref imgName, ref imgPath);
                            if (!string.IsNullOrEmpty(imgPath))
                            {
                                ent.DetailDrawing = imgPath;
                            }
                        }
                    }
                }

                if (id == "")
                {

                    if (!ent.UpClientID.Equals(8))
                    {
                        if (ent.ProductCode.Substring(0, 2).ToUpper().Equals("LT"))
                        {
                            ent.ProductCode = ent.ProductCode + bus.ReturnMaxBasicSpecsNum(ent);
                        }
                        else
                        {
                            ent.ProductCode = ent.ProductCode + bus.GetMaxProductCodeNum(ent);
                        }
                    }
                    log.Operate = "A";
                    bus.AddCargoProductSpec(ent, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
                else
                {
                    log.Operate = "U";
                    ent.SID = Convert.ToInt32(id);
                    bus.UpdateCargoProductSpec(ent, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }
        public void DelCargoProduct()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoProductEntity> list = new List<CargoProductEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "产品管理";
            log.Status = "0";
            log.NvgPage = "基础规格管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                CargoHouseBus hou = new CargoHouseBus();
                CargoOrderBus order = new CargoOrderBus();
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoProductEntity
                    {
                        SID = Convert.ToInt32(row["SID"]),
                        TypeID = Convert.ToInt32(row["TypeID"]),
                        Specs = Convert.ToString(row["Specs"]),
                        Figure = Convert.ToString(row["Figure"]),
                        Model = Convert.ToString(row["Model"]),
                        GoodsCode = Convert.ToString(row["GoodsCode"]),
                        SpeedLevel = Convert.ToString(row["SpeedLevel"]),
                        LoadIndex = Convert.ToString(row["LoadIndex"]),
                        Born = Convert.ToString(row["Born"]),
                        DelFlag = Convert.ToString(row["DelFlag"]),
                    });
                }
                if (msg.Result)
                {
                    bus.DelCargoProductSpec(list, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 查询供应商
        /// </summary>
        public void QueryHouseSupplier()
        {
            CargoSupplierProductPrice queryEntity = new CargoSupplierProductPrice();
            queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);
            queryEntity.TypeID = Convert.ToInt32(Request["TypeID"]);
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoSupplierProductPrice> list = bus.QueryHouseSupplier(queryEntity);
            string res = JSON.Encode(list);
            Response.Write(res);
        }

        #endregion
        #region 盘点管理
        /// <summary>
        /// 生成盘点记录
        /// </summary>
        public void SaveStockTake()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "盘点管理";
            log.Operate = "A";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;
            string genType = Convert.ToString(Request["GenType"]);
            int? SplitThreshold = int.TryParse(Request["SplitThreshold"], out int splitThresholdO) ? splitThresholdO : default(int?);
            CargoHouseBus bus = new CargoHouseBus();
            CargoStockTakeEntity entity = new CargoStockTakeEntity();
            entity.HouseID = Convert.ToInt32(Request["HouseID"]);
            entity.SplitThreshold = splitThresholdO;
            if (!string.IsNullOrEmpty(Request["HeadHouseID"]))
            {
                entity.HeadHouseID = Convert.ToInt32(Request["HeadHouseID"]);
                CargoAreaEntity area = bus.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(Request["HeadHouseID"]) });
                entity.HeadHouseName = area.Name;
            }
            if (!string.IsNullOrEmpty(Request["AreaID"]))
            {
                entity.AreaID = Convert.ToInt32(Request["AreaID"]);
                CargoAreaEntity area = bus.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(Request["AreaID"]) });
                entity.AreaName = area.Name;
            }
            if (!string.IsNullOrEmpty(Request["SecondAreaID"]))
            {
                entity.SecondAreaID = Convert.ToInt32(Request["SecondAreaID"]);
                CargoAreaEntity area = bus.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(Request["SecondAreaID"]) });
                entity.SecondAreaName = area.Name;
            }
            if (!string.IsNullOrEmpty(Request["TypeID"]))
            {
                entity.TypeID = Convert.ToInt32(Request["TypeID"]);
                entity.TypeName = bus.QueryProductTypeName(new CargoProductTypeEntity { TypeID = Convert.ToInt32(Request["TypeID"]) });
            }
            try
            {
                entity.CreateID = UserInfor.LoginName;
                entity.CreateName = UserInfor.UserName;
                entity.CreateDate = DateTime.Now;
                bus.SaveStockTake(entity, log, genType);
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Result = false;
                msg.Message = ex.Message;
            }

            //JSON
            String json = JSON.Encode(msg);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 添加盘点附件
        /// </summary>
        public void SaveStockTakePics()
        {
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "库存盘点";
            log.NvgPage = "附件上传";
            log.UserID = UserInfor.LoginName.Trim();
            log.Status = "0";
            log.Operate = "A";
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;



            List<CargoStockTakeFileEntity> result = new List<CargoStockTakeFileEntity>();
            string stockIDstr = Request["StockID"];
            int stockID = Convert.ToInt32(stockIDstr);
            for (int i = 0; i < Request.Files.Count; i++)
            {
                HttpPostedFile imgFile = Request.Files[i];
                string imgName = imgFile.FileName;
                string imgPath = "../upload/StockTake/";
                if (string.IsNullOrEmpty(imgFile.FileName)) { continue; }
                Common.SaveUserPic(Request.Files[i], ref imgName, ref imgPath);
                CargoStockTakeFileEntity f = new CargoStockTakeFileEntity();
                f.StockID = stockID;
                f.Raw_FileName = imgFile.FileName;
                f.FileName = imgName;
                f.FilePath = HttpContext.Current.Server.MapPath(imgPath);
                f.FileSize = imgFile.ContentLength;
                f.FileType = imgFile.ContentType;
                f.UploadUserID = UserInfor.UserID.ToString();
                f.UploadUserName = UserInfor.UserName;
                result.Add(f);
            }
            try
            {
                if (result.Count > 0)
                {
                    CargoHouseBus bus = new CargoHouseBus();
                    bus.SaveStockTakeFile(result, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.Flush();
        }


        /// <summary>
        /// 删除盘点附件
        /// </summary>
        public void DelStockTakePics()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            List<CargoStockTakeFileEntity> result = new List<CargoStockTakeFileEntity>();
            string IDsStr = Request["IDs"];
            var IDs = Array.Empty<int>();
            try
            {
                IDs = JsonConvert.DeserializeObject<int[]>(IDsStr);
                if (IDs.Length > 0)
                {
                    CargoHouseBus bus = new CargoHouseBus();
                    bus.DelStockTakePics(IDs);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.Flush();
        }


        // <summary>
        /// 获取盘点附件列表
        /// </summary>
        public void QueryStockTakePics()
        {
            var result = new List<CargoStockTakeFileEntity>();

            CargoHouseBus bus = new CargoHouseBus();
            int StockID = Convert.ToInt32(Request["StockID"]);
            result = bus.QueryStockTakePics(StockID);

            //将绝对路径转换为相对路径传给前端，方便前端找到文件下载
            string appRootAbsolute = HttpContext.Current.Server.MapPath("~/");
            foreach (var item in result)
            {
                item.FileUrl = item.FilePath.Replace(appRootAbsolute, "../").Replace(@"\", "/");
            }

            //返回处理结果
            string res = JSON.Encode(result);
            Response.Write(res);
            Response.Flush();
        }


        /// <summary>
        /// 查询盘点数据表
        /// </summary>
        public void QueryStockTakeData()
        {
            CargoStockTakeEntity queryEntity = new CargoStockTakeEntity();
            queryEntity.CreateName = Convert.ToString(Request["CreateName"]);
            queryEntity.TakeStatus = Convert.ToString(Request["TakeStatus"]);
            if (!string.IsNullOrEmpty(Request["PID"]))
            {
                queryEntity.HeadHouseID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["HID"]))
            {
                queryEntity.HouseID = Convert.ToInt32(Request["HID"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.QueryStockTakeData(pageIndex, pageSize, queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 删除盘点单
        /// </summary>
        public void DelStockTake()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoStockTakeEntity> list = new List<CargoStockTakeEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "盘点管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    CargoStockTakeEntity delAra = bus.QueryStockTake(new CargoStockTakeEntity { StockID = Convert.ToInt32(row["StockID"]) });
                    if (delAra?.TakeStatus != null && !delAra.TakeStatus.Equals("0"))
                    {
                        msg.Message = "盘点单号：" + Convert.ToString(row["StockID"]) + " 非开单状态，不允许删除";
                        msg.Result = false;
                        break;
                    }
                    list.Add(new CargoStockTakeEntity
                    {
                        StockID = Convert.ToInt32(row["StockID"]),
                        HeadHouseName = Convert.ToString(row["HeadHouseName"]),
                        AreaName = Convert.ToString(row["AreaName"]),
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        CreateName = Convert.ToString(row["CreateName"])
                    });
                }
                if (msg.Result)
                {
                    bus.DelStockTake(list, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }

            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        /// <summary>
        /// 查询盘点单的货位数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public void QueryCargoStockTakeContainerList()
        {
            CargoStockTakeContainerEntity queryEntity = new CargoStockTakeContainerEntity();
            //查询条件
            string key = Request["StockID"];
            if (string.IsNullOrEmpty(key)) { Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return; }

            queryEntity.StockID = Convert.ToInt32(key);

            CargoHouseBus bus = new CargoHouseBus();
            List<CargoStockTakeContainerEntity> list = bus.QueryCargoStockTakeContainerList(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void QueryCargoStockTagList()
        {
            CargoStockTakeTagEntity queryEntity = new CargoStockTakeTagEntity();
            queryEntity.StockID = Convert.ToInt32(Request["StockID"]);
            queryEntity.ContainerCode = Convert.ToString(Request["ContainerCode"]);
            //if (!string.IsNullOrEmpty(Request["StockStatus"].ToString()))
            //{
            //    queryEntity.StockStatus = Convert.ToString(Request["StockStatus"]);
            //}
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoStockTakeTagEntity> list = bus.QueryCargoStockTagList(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        public void QueryStockTakeDataByStockIDs()
        {
            string stockIDsStr = Request["StockIDs"];
            if (string.IsNullOrEmpty(stockIDsStr)) return;
            ArrayList stockIDs = (ArrayList)JSON.Decode(stockIDsStr);

            CargoHouseBus bus = new CargoHouseBus();
            CargoStockTakeTagEntity queryEntity = new CargoStockTakeTagEntity();

            foreach (var stockID in stockIDs)
            {
                queryEntity.QueryStockID += Convert.ToString(stockID) + ",";
            }
            queryEntity.QueryStockID = queryEntity.QueryStockID.TrimEnd(',');
            List<CargoStockTakeTagEntity> list = bus.QueryCargoStockTagList(queryEntity);

            //JSON
            String result = JSON.Encode(list);
            Response.Clear();
            Response.Write(result);
        }

        /// <summary>
        /// 查询货位可移动列表
        /// </summary>
        public void QueryCargoStockContainerIDTagList()
        {
            CargoStockTakeTagEntity queryEntity = new CargoStockTakeTagEntity();
            String jsonQ = Request["StockIDs"];
            if (String.IsNullOrEmpty(jsonQ)) return;
            ArrayList rows = (ArrayList)JSON.Decode(jsonQ);

            foreach (Hashtable row in rows)
            {
                queryEntity.QueryStockID += Convert.ToString(row["StockID"]) + ",";
            }
            queryEntity.QueryStockID = queryEntity.QueryStockID.TrimEnd(',');
            //queryEntity.StockID = Convert.ToInt32(Request["StockID"]);

            //queryEntity.ContainerCode = Convert.ToString(Request["ContainerCode"]);
            if (!string.IsNullOrEmpty(Request["StockStatus"].ToString()))
            {
                queryEntity.StockStatus = Convert.ToString(Request["StockStatus"]);
            }
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoStockTakeTagEntity> list = bus.QueryCargoStockContainerIDTagList(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询货位可移动列表
        /// </summary>
        public void UpdateContainerID()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            List<CargoStockTakeTagEntity> list = new List<CargoStockTakeTagEntity>();
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "盘点管理";
            log.Status = "0";
            log.NvgPage = "盘点管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "U";
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoStockTakeTagEntity
                    {
                        StockID = Convert.ToInt32(row["StockID"]),
                        TagCode = Convert.ToString(row["TagCode"]),
                        //ContainerID = Convert.ToInt32(row["ContainerID"]),
                        //ContainerCode = Convert.ToString(row["ContainerCode"]),
                        ScanContainerID = Convert.ToInt32(row["ScanContainerID"]),
                        ScanContainerCode = Convert.ToString(row["ScanContainerCode"]),
                        OldContainerID = Convert.ToInt32(row["OldContainerID"]),
                        OldContainerCode = Convert.ToString(row["OldContainerCode"]),

                    });
                }
                foreach (CargoStockTakeTagEntity data in list)
                {
                    string ContainerCode = data.ScanContainerCode;
                    string TagCode = data.TagCode;
                    if (string.IsNullOrEmpty(ContainerCode))
                    {
                        msg.Result = false;
                        msg.Message += TagCode + "目标货位不能为空<br />";
                        continue;
                    }
                    if (string.IsNullOrEmpty(TagCode))
                    {
                        msg.Result = false;
                        msg.Message += TagCode + "产品标签不能为空<br />";
                        continue;
                    }


                    List<CargoProductTagEntity> taglist = new List<CargoProductTagEntity>();
                    //CargoHouseBus house = new CargoHouseBus();
                    CargoInterfaceBus inter = new CargoInterfaceBus();
                    CargoContainerEntity tagartCon = bus.QueryContainerEntityByID(data.ScanContainerID);
                    CargoContainerShowEntity newContainer = new CargoContainerShowEntity();//目标货位实体
                    newContainer.ContainerID = tagartCon.ContainerID;//新货位ID
                    newContainer.ContainerCode = tagartCon.ContainerCode;//新货位代码
                    newContainer.HouseID = tagartCon.HouseID;//目标仓库ID
                    newContainer.AreaID = tagartCon.AreaID;//目标仓库区域ID
                    newContainer.InCargoID = DateTime.Now.ToString("MMdd") + Common.GetRandomSixNum().ToString();//入库单号

                    //旧的货位数据
                    List<CargoContainerShowEntity> oldGoods = inter.QueryOldContainerList(data.TagCode);
                    if (oldGoods.Count > 0)
                    {
                        CargoContainerShowEntity it = oldGoods[0];
                        it.Piece = 1;
                        if (it.InPiece < 1)
                        {
                            msg.Result = false;
                            msg.Message += TagCode + "在库数量少于移库数量<br />";
                            continue;
                        }
                        if (!string.IsNullOrEmpty(it.MoveOrderNo) && it.MoveStatus.Equals("0"))
                        {
                            msg.Result = false;
                            msg.Message += TagCode + "该标签是移库标签请用移库入库扫描<br />";
                            continue;
                        }
                        if (it.ContainerID.Equals(newContainer.ContainerID))
                        {
                            msg.Result = false;
                            msg.Message += TagCode + "移库信息相同货位不能移库位<br />";
                            continue;
                        }
                        newContainer.TagCode = data.TagCode;

                        ////仓库同步缓存(缓存的旧的仓库信息)
                        //CargoProductEntity syncProduct = house.SyncTypeProduct(it.ProductID.ToString());
                        ////34 马牌  1 同步马牌  2 同步全部品牌
                        //if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                        //{
                        //    RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                        //}
                        //修改货位信息
                        bus.SaveMoveContainer(it, newContainer, log);
                        //修改盘点状态
                        CargoStockTakeTagEntity tagEntity = new CargoStockTakeTagEntity();
                        tagEntity.TagCode = TagCode;
                        tagEntity.ContainerID = newContainer.ContainerID;
                        tagEntity.ContainerCode = ContainerCode;
                        tagEntity.StockID = Convert.ToInt32(data.StockID);
                        tagEntity.ProductID = 0;
                        tagEntity.ContainerID = data.ContainerID;//获取到的ContainerID
                        tagEntity.ScanLoginName = UserInfor.LoginName;
                        tagEntity.ScanUserName = UserInfor.UserName;
                        tagEntity.ScanDate = DateTime.Now;
                        tagEntity.StockStatus = "1"; // 标签扫描状态  已扫描
                        tagEntity.ScanStatus = "1";//盘点状态  正常
                        tagEntity.ScanContainerID = newContainer.ContainerID;
                        bus.AddStockTakeTag(tagEntity, log);
                    }
                }
                msg.Result = true;
                msg.Message += "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);




            //    CargoAPIMessage result = new CargoAPIMessage();
            //    string ContainerCode = context.Request["ContainerCode"];//目标货位
            //    int HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID
            //    string TagCode = context.Request["TagCode"];//产品唯一编码标签码
            //    Common.WriteTextLog("货位移动：" + TagCode);
            //    string[] tArr = TagCode.Split('=');
            //    if (tArr.Length > 1)
            //    {
            //        TagCode = tArr[1];
            //    }
            //    else
            //    {
            //        string[] gtc = TagCode.Split('|');
            //        if (gtc.Length > 1)
            //        {
            //            TagCode = gtc[5];
            //            //TagCode = tc.Substring(8, tc.Length - 8);
            //        }
            //    }
            //    string UserID = context.Request["UserID"];//操作人账号
            //    result.Result = true;
            //    result.Message = "移库成功";
            //    LogEntity log = new LogEntity();
            //    log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            //    log.Moudle = "仓库管理";
            //    log.NvgPage = "扫描移库";
            //    log.UserID = UserID;//限定某一账号
            //    log.Operate = "U";
            //    log.Status = "0";
            //    #region 验证

            //    if (HouseID.Equals(0))
            //    {
            //        result.Result = false;
            //        result.Message = "仓库ID不能为空";
            //        goto ERR;
            //    }
            //    if (string.IsNullOrEmpty(ContainerCode))
            //    {
            //        result.Result = false;
            //        result.Message = "目标货位不能为空";
            //        goto ERR;
            //    }
            //    if (string.IsNullOrEmpty(TagCode))
            //    {
            //        result.Result = false;
            //        result.Message = "产品编码列表不能为空";
            //        goto ERR;
            //    }
            //    #endregion
            //    List<CargoProductTagEntity> taglist = new List<CargoProductTagEntity>();
            //    CargoHouseBus house = new CargoHouseBus();
            //    CargoInterfaceBus inter = new CargoInterfaceBus();
            //    CargoContainerEntity tagartCon = house.QueryContainerEntityByCode(ContainerCode, HouseID);
            //    CargoContainerShowEntity newContainer = new CargoContainerShowEntity();//目标货位实体
            //    newContainer.ContainerID = tagartCon.ContainerID;//新货位ID
            //    newContainer.ContainerCode = tagartCon.ContainerCode;//新货位代码
            //    newContainer.HouseID = tagartCon.HouseID;//目标仓库ID
            //    newContainer.AreaID = tagartCon.AreaID;//目标仓库区域ID
            //    newContainer.InCargoID = DateTime.Now.ToString("MMdd") + Common.GetRandomSixNum().ToString();//入库单号

            //    //string tagList = string.Empty;
            //    string[] tag = TagCode.Split('/');
            //    for (int i = 0; i < tag.Length; i++)
            //    {
            //        if (!string.IsNullOrEmpty(tag[i].Trim()) && !taglist.Exists(c => c.TagCode.Equals(tag[i].Trim())))
            //        {
            //            //tagList += tag[i] + "','";
            //            taglist.Add(new CargoProductTagEntity
            //            {
            //                TagCode = tag[i],
            //                ContainerID = tagartCon.ContainerID
            //            });
            //        }
            //    }
            //    //if (!string.IsNullOrEmpty(tagList))
            //    //{
            //    //    tagList = tagList.Substring(0, tagList.Length - 3);
            //    //}
            //    foreach (var tg in taglist)
            //    {
            //        List<CargoContainerShowEntity> oldGoods = inter.QueryOldContainerList(tg.TagCode);
            //        if (oldGoods.Count > 0)
            //        {
            //            CargoContainerShowEntity it = oldGoods[0];
            //            it.Piece = 1;
            //            if (it.InPiece < 1)
            //            {
            //                result.Result = false;
            //                result.Message = "在库数量少于移库数量";
            //                goto ERR;
            //            }
            //            if (!it.HouseID.Equals(HouseID))
            //            {
            //                result.Result = false;
            //                result.Message = "非本仓库产品";
            //                goto ERR;
            //            }
            //            if (!string.IsNullOrEmpty(it.MoveOrderNo) && it.MoveStatus.Equals("0"))
            //            {
            //                result.Result = false;
            //                result.Message = "该标签是移库标签请用移库入库扫描";
            //                goto ERR;
            //            }
            //            if (it.ContainerID.Equals(newContainer.ContainerID))
            //            {
            //                //result.Result = false;
            //                //result.Message = "仓库ID相同货位不能移库";
            //                //goto ERR;
            //                continue;
            //            }
            //            newContainer.TagCode = tg.TagCode;

            //            //仓库同步缓存(缓存的旧的仓库信息)
            //            //CargoProductEntity syncProduct = house.SyncTypeProduct(it.ProductID.ToString());
            //            //34 马牌  1 同步马牌  2 同步全部品牌
            //            //if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
            //            //{
            //            //    RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
            //            //}
            //            house.SaveMoveContainer(it, newContainer, log);
            //        }
            //    }

            //ERR:
            //    //JSON
            //    String json = JSON.Encode(result);
            //    Response.Write(result);
        }



        /// <summary>
        /// 查询盘点结果数据导出
        /// </summary>
        public void QueryStockTakeDataForExport()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);

            CargoHouseBus bus = new CargoHouseBus();
            CargoStockTakeTagEntity queryEntity = new CargoStockTakeTagEntity();

            foreach (Hashtable row in rows)
            {
                queryEntity.QueryStockID += Convert.ToString(row["StockID"]) + ",";
            }
            queryEntity.QueryStockID = queryEntity.QueryStockID.TrimEnd(',');
            List<CargoStockTakeTagEntity> list = bus.QueryCargoStockTagList(queryEntity);

            string err = "OK";
            if (list.Count > 0) { CargoStockTakeList = list; } else { err = "没有数据可以进行导出，请重新查询！"; }
            //JSON
            String result = JSON.Encode(err);
            Response.Clear();
            Response.Write(result);
        }
        /// <summary>
        /// 库存数据导出实体
        /// </summary>
        public List<CargoStockTakeTagEntity> CargoStockTakeList
        {
            get
            {
                if (Session["CargoStockTakeList"] == null)
                {
                    Session["CargoStockTakeList"] = new List<CargoStockTakeTagEntity>();
                }
                return (List<CargoStockTakeTagEntity>)(Session["CargoStockTakeList"]);
            }
            set
            {
                Session["CargoStockTakeList"] = value;
            }
        }

        public void RvwStockTakeContainerPiece()
        {
            CargoHouseBus bus = new CargoHouseBus();
            int stockid = 0;
            string userid = UserInfor.LoginName;
            string username = UserInfor.UserName;
            int[] containerIds = Array.Empty<int>();

            string IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            if (!string.IsNullOrEmpty(Request["StockID"]))
            {
                stockid = Convert.ToInt32(Request["stockID"]);
            }
            if (!string.IsNullOrEmpty(Request["containerIds"]))
            {
                containerIds = JsonConvert.DeserializeObject<int[]>(Request["containerIds"]);
            }

            bus.RvwStockTakeContainerPiece(stockid, containerIds, userid, username);

        }
        #endregion
        #region 线路管理操作方法集合
        /// <summary>
        /// 查询所有线路
        /// </summary>
        public void QueryCargoLogisLine()
        {
            CargoLogisLineEntity queryEntity = new CargoLogisLineEntity();

            queryEntity.HouseID = UserInfor.HouseID;
            if (!string.IsNullOrEmpty(Request["HouseID"]))
            {
                queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);//所属仓库ID
            }
            //if (!string.IsNullOrEmpty(Request["AreaID"]))
            //{
            //    queryEntity.AreaID = Convert.ToInt32(Request["AreaID"]);//所属仓库ID
            //}
            if (!string.IsNullOrEmpty(Request["LogisID"]))
            {
                queryEntity.LogisID = Convert.ToInt32(Request["LogisID"]);
            }

            queryEntity.LineName = Convert.ToString(Request["LineName"]);
            if (Request["DelFlag"] != "-1")
            {
                queryEntity.DelFlag = Convert.ToString(Request["DelFlag"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.QueryCargoLogisLine(pageIndex, pageSize, queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        /// <summary>
        /// 查询线路客户数据
        /// </summary>
        public void QueryLogisLineClientListData()
        {
            string LineID = Request["LineID"];
            if (string.IsNullOrEmpty(LineID)) { return; }
            CargoLogisLineClientEntity queryEntity = new CargoLogisLineClientEntity();
            queryEntity.LineID = Convert.ToInt32(LineID);
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoLogisLineClientEntity> list = bus.QueryLogisLineClientListData(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 删除线路
        /// </summary>
        public void DelCargoLogisLine()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoLogisLineEntity> list = new List<CargoLogisLineEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "线路管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoLogisLineEntity
                    {
                        LineID = Convert.ToInt32(row["LineID"]),
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        LineName = Convert.ToString(row["LineName"]),
                        HouseName = Convert.ToString(row["HouseName"]),
                        LogisticName = Convert.ToString(row["LogisticName"]),
                        Memo = Convert.ToString(row["Memo"]),
                        DelFlag = Convert.ToString(row["DelFlag"])
                    });
                }
                bus.DelCargoLogisLine(list, log);
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 保存和修改线路数据
        /// </summary>
        public void SaveCargoLogisLine()
        {
            CargoLogisLineEntity ent = new CargoLogisLineEntity();
            CargoHouseBus bus = new CargoHouseBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "线路管理";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;
            String id = Request["LineID"] != null ? Request["LineID"].ToString() : "";
            try
            {
                ent.LineName = Convert.ToString(Request["LineName"]);
                ent.HouseID = Convert.ToInt32(Request["HouseID"]);
                //ent.AreaID = Convert.ToInt32(Request["AreaID"]);
                ent.LogisticName = Convert.ToString(Request["LogisticName"]);
                ent.LogisID = Convert.ToInt32(Request["LogisID"]);
                ent.Memo = Convert.ToString(Request["Memo"]);
                ent.DelFlag = Convert.ToString(Request["DelFlag"]);
                if (id == "")
                {
                    if (bus.IsExistCargoLogisLine(ent))
                    {
                        msg.Result = false;
                        msg.Message = "已经存在相同的线路名称";
                    }
                    else
                    {
                        log.Operate = "A";
                        bus.AddCargoLogisLine(ent, log);
                        msg.Result = true;
                        msg.Message = "成功";
                    }
                }
                else
                {
                    ent.LineID = Convert.ToInt32(id);

                    log.Operate = "U";
                    bus.UpdateCargoLogisLine(ent, log);
                    msg.Result = true;
                    msg.Message = "成功";

                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 绑定客户线路数据
        /// </summary>
        public void bindLogisLineClient()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoLogisLineClientEntity> result = new List<CargoLogisLineClientEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "绑定线路";
            log.UserID = UserInfor.LoginName;
            log.Operate = "U";
            CargoHouseBus bus = new CargoHouseBus();
            foreach (Hashtable row in rows)
            {
                //判断客户是否已经绑定线路，如果有则跳出提醒

                CargoLogisLineClientEntity entity = new CargoLogisLineClientEntity();
                entity.ClientID = Convert.ToInt32(row["ClientID"]);
                entity.LineID = Convert.ToInt32(Request["LineID"]);
                entity.OP_ID = UserInfor.LoginName;
                if (bus.IsExistCargoLogisLineClient(entity))
                {
                    msg.Result = false;
                    msg.Message = "店代码：" + Convert.ToString(row["ShopCode"]) + " 已绑定线路";
                    break;
                }

                result.Add(entity);
            }
            try
            {
                if (msg.Result)
                {
                    bus.AddCargoLogisLineClient(result, log);
                    msg.Result = true;
                }
            }
            catch (ApplicationException ex)
            {
                msg.Result = false;
            }

            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        /// <summary>
        /// 解绑线路客户
        /// </summary>
        public void DelCargoLogisLineClient()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoLogisLineClientEntity> result = new List<CargoLogisLineClientEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "解绑线路";
            log.UserID = UserInfor.LoginName;
            log.Operate = "U";
            CargoHouseBus bus = new CargoHouseBus();
            foreach (Hashtable row in rows)
            {
                CargoLogisLineClientEntity entity = new CargoLogisLineClientEntity();
                entity.ClientID = Convert.ToInt32(row["ClientID"]);
                entity.LineID = Convert.ToInt32(row["LineID"]);
                entity.ClientShortName = Convert.ToString(row["ClientShortName"]);
                entity.Boss = Convert.ToString(row["Boss"]);
                entity.OP_ID = UserInfor.LoginName;
                result.Add(entity);
            }
            try
            {
                bus.DelCargoLogisLineClient(result, log);
                msg.Result = true;
            }
            catch (ApplicationException ex)
            {
                msg.Result = false;
            }

            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        /// <summary>
        /// 查询物流线路数据
        /// </summary>
        public void QueryCargoLogisLineList()
        {
            //查询条件
            int hid = Convert.ToInt32(Request["hid"]);
            CargoLogisLineEntity entity = new CargoLogisLineEntity();
            entity.HouseID = hid;
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoLogisLineEntity> list = bus.QueryCargoLogisLineList(entity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        #endregion

        #region 线网关系操作方法
        public void SaveLineNetMapp()
        {
            CargoLineNetMappingEntity ent = new CargoLineNetMappingEntity();
            CargoHouseBus bus = new CargoHouseBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "线网关系";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;
            String id = Request["MID"] != null ? Request["MID"].ToString() : "";
            try
            {
                ent.AreaID = Convert.ToInt32(Request["AreaID"]);
                ent.HouseID = Convert.ToInt32(Request["HouseID"]);
                ent.Province = Convert.ToString(Request["Province"]);
                ent.City = Convert.ToString(Request["City"]);
                ent.OrderLevel = Convert.ToInt32(Request["OrderLevel"]);
                ent.ClientNum = Convert.ToInt32(Request["ClientNum"]);
                ent.ClientName = Convert.ToString(Request["ClientName"]);
                ent.ShopCode = Convert.ToString(Request["ShopCode"]);
                ent.OPID = UserInfor.LoginName;
                ent.OPDATE = DateTime.Now;
                if (id == "")
                {
                    if (bus.IsExistLineNetMapp(ent))
                    {
                        msg.Result = false;
                        msg.Message = "已经存在相同的线网关系";
                    }
                    else
                    {
                        log.Operate = "A";
                        bus.AddLineNetMapp(ent, log);
                        msg.Result = true;
                        msg.Message = "成功";
                    }
                }
                else
                {
                    ent.MID = Convert.ToInt64(id);

                    log.Operate = "U";
                    bus.UpdateLineNetMapp(ent, log);
                    msg.Result = true;
                    msg.Message = "成功";

                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        public void DelLineNetMapp()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoLineNetMappingEntity> list = new List<CargoLineNetMappingEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            CargoHouseBus bus = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "线网关系";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoLineNetMappingEntity
                    {
                        MID = Convert.ToInt32(row["MID"]),
                        AreaID = Convert.ToInt32(row["AreaID"]),
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        AreaName = Convert.ToString(row["AreaName"]),
                        HouseName = Convert.ToString(row["HouseName"]),
                        Province = Convert.ToString(row["Province"]),
                        City = Convert.ToString(row["City"]),
                        OrderLevel = Convert.ToInt32(row["OrderLevel"]),
                        OPID = UserInfor.LoginName,
                        OPDATE = DateTime.Now
                    });
                }
                bus.DelLineNetMapp(list, log);
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 查询线网关系数据
        /// </summary>
        public void QueryLineNetMapp()
        {
            CargoLineNetMappingEntity queryEntity = new CargoLineNetMappingEntity();
            queryEntity.ShopCode = Convert.ToString(Request["ShopCode"]);
            //queryEntity.City = Convert.ToString(Request["City"]);
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);//所属仓库ID
            }
            if (!string.IsNullOrEmpty(Request["AHID"]))//所在仓库
            {
                queryEntity.AreaID = Convert.ToInt32(Request["AHID"]);
            }
            if (!string.IsNullOrEmpty(Request["ClientNum"]))//所在仓库
            {
                queryEntity.ClientNum = Convert.ToInt32(Request["ClientNum"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.QueryLineNetMapp(pageIndex, pageSize, queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        #endregion

        #region 上传轮播图图片

        public void QueryHouseFile()
        {
            CargoBannerEntity queryEntity = new CargoBannerEntity();
            queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);
            CargoHouseBrandPriceBus bus = new CargoHouseBrandPriceBus();
            List<CargoBannerEntity> list = bus.QueryHouseFile(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
#if DEBUG
        private bool IsDeBug = true;
#else
             private bool IsDeBug =false;
#endif
        /// <summary>
        /// 保存轮播图照片
        /// </summary>
        public void SaveHousePic()
        {
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "仓库管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Status = "0";
            log.Operate = "A";
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            List<CargoBannerEntity> result = new List<CargoBannerEntity>();
            for (int i = 0; i < Request.Files.Count; i++)
            {
                string FileType = string.Empty;
                if (Request.Files.AllKeys[i].Equals("InsurePic")) { FileType = "0"; }
                string imgName = string.Empty;
                string imgPath = string.Empty;
                HttpPostedFile imgFile = Request.Files[i];
                if (string.IsNullOrEmpty(imgFile.FileName)) { continue; }
                Common.SaveUserPic(Request.Files[i], ref imgName, ref imgPath);
                CargoBannerEntity f = new CargoBannerEntity();
                if (IsDeBug)
                    f.PicName = imgPath;
                else
                    f.PicName = "https://dlt.neway5.com/upload/ClientFile/" + imgName;
                f.DelFlag = "0";
                f.Title = "";
                f.HouseID = string.IsNullOrEmpty(Convert.ToString(Request["HouseID"])) ? UserInfor.HouseID : Convert.ToInt32(Request["HouseID"]);
                result.Add(f);
            }
            try
            {
                if (result.Count > 0)
                {
                    CargoHouseBrandPriceBus bus = new CargoHouseBrandPriceBus();
                    bus.AddCargoHouseBrandFile(result, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        public void DelHousePic()
        {
            CargoBannerEntity queryEntity = new CargoBannerEntity();
            var list = JsonConvert.DeserializeObject<List<CargoBannerEntity>>(Request["DelData"]);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "仓库管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                CargoHouseBrandPriceBus bus = new CargoHouseBrandPriceBus();
                bus.DelHousePic(list, log);

                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion

        #region 仓库目标

        public void QueryHouseAimList()
        {
            CargoHouseAimEntity queryEntity = new CargoHouseAimEntity();
            queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoHouseAimEntity> list = bus.QueryHouseAimList(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        public void SaveCargoHouseAim()
        {
            CargoHouseAimEntity ent = new CargoHouseAimEntity();
            CargoHouseBus bus = new CargoHouseBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "仓库管理";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;
            string res = string.Empty;
            try
            {
                ent.HouseID = Convert.ToInt32(Request["HouseID"]);
                ent.AimYear = Convert.ToInt32(Request["AimYear"]);
                ent.AimMonth = Convert.ToInt32(Request["AimMonth"]);
                ent.AimQuantity = Convert.ToInt32(Request["AimQuantity"]);
                ent.AimMoney = Convert.ToDecimal(Request["AimMoney"]);
                ent.OPID = UserInfor.LoginName;
                ent.OP_DATE = DateTime.Now;

                if (ent.HouseID.Equals(0))
                {
                    msg.Result = false;
                    msg.Message = "未获取到仓库ID";

                    res = JSON.Encode(msg);
                    Response.Write(res);
                    return;
                }


                if (bus.IsExistCargoHouseAim(ent))
                {
                    msg.Result = false;
                    msg.Message = "已经存在相同的品牌共享仓库配置";
                }
                else
                {
                    log.Operate = "A";
                    bus.AddCargoHouseAim(ent, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }

            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            res = JSON.Encode(msg);
            Response.Write(res);
        }

        public void DelHouseAim()
        {
            CargoHouseAimEntity queryEntity = new CargoHouseAimEntity();
            var list = JsonConvert.DeserializeObject<List<CargoHouseAimEntity>>(Request["DelData"]);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "仓库管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                CargoHouseBus bus = new CargoHouseBus();
                bus.DelHouseAim(list, log);

                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion


        #region 品牌仓库共享

        public void QueryHouseShareList()
        {
            CargoHouseBrandShareEntity queryEntity = new CargoHouseBrandShareEntity();
            queryEntity.ShareHouseID = Convert.ToInt32(Request["ShareHouseID"]);
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoHouseBrandShareEntity> list = bus.QueryHouseShareList(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        public void SaveCargoHouseShare()
        {
            CargoHouseBrandShareEntity ent = new CargoHouseBrandShareEntity();
            CargoHouseBus bus = new CargoHouseBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "仓库管理";
            log.Status = "0";
            log.UserID = UserInfor.LoginName;
            string res = string.Empty;
            try
            {
                ent.ID = Convert.ToInt32(Request["ID"]);
                ent.MainHouseID = Convert.ToInt32(Request["MainHouseID"]);
                ent.ShareHouseID = Convert.ToInt32((Request["ShareHouseID"]));
                ent.BrandID = Convert.ToInt32(Request["BrandID"]);
                ent.UpPriceType = Convert.ToInt32(Request["UpPriceType"]);
                ent.FixMoney = string.IsNullOrEmpty(Convert.ToString(Request["FixMoney"])) ? 0 : Convert.ToDecimal(Request["FixMoney"]);
                ent.RatePrice = string.IsNullOrEmpty(Convert.ToString(Request["RatePrice"])) ? 0 : Convert.ToDecimal(Request["RatePrice"]);
                ent.OPID = UserInfor.LoginName;
                ent.OP_DATE = DateTime.Now;
                ent.DelFlag = 0;

                if (ent.MainHouseID.Equals(ent.ShareHouseID))
                {
                    msg.Result = false;
                    msg.Message = "主仓和前置仓不能一致";
                }

                if (bus.IsExistCargoHouseShare(ent))
                {
                    msg.Result = false;
                    msg.Message = "已经存在相同的仓库目标配置";
                }

                if (msg.Result)
                {
                    if (ent.ID == 0)
                    {
                        log.Operate = "A";
                        bus.AddCargoHouseShare(ent, log);
                        msg.Result = true;
                        msg.Message = "成功";
                    }
                    else
                    {
                        log.Operate = "A";
                        bus.UpdateCargoHouseShare(ent, log);
                        msg.Result = true;
                        msg.Message = "成功";
                    }

                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }

            //返回处理结果
            res = JSON.Encode(msg);
            Response.Write(res);
        }



        public void DelHouseShare()
        {
            CargoHouseBrandShareEntity queryEntity = new CargoHouseBrandShareEntity();
            var list = JsonConvert.DeserializeObject<List<CargoHouseBrandShareEntity>>(Request["DelData"]);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "仓库管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                CargoHouseBus bus = new CargoHouseBus();
                CargoInterfaceBus busInterface = new CargoInterfaceBus();
                //清空前置仓库存
                foreach (var item in list)
                {
                    List<CargoHouseBrandShareEntity> list2 = bus.QueryHouseShareList(new CargoHouseBrandShareEntity { ShareHouseID = item.ShareHouseID, BrandID = item.BrandID, MainHouseID = item.MainHouseID });
                    var dataList = list2.GroupBy(a => new { a.ShareHouseID, a.MainHouseID, a.BrandID })
                        .Select(a => new CargoHouseBrandShareEntity { ShareHouseID = a.Key.ShareHouseID, MainHouseID = a.Key.MainHouseID, BrandID = a.Key.BrandID }).ToList();
                    foreach (var shid in dataList)
                    {
                        busInterface.SetNextDayStockZero(new CargoHouseBrandShareEntity { MainHouseID = shid.MainHouseID, BrandID = shid.BrandID });
                    }
                }
                //删除数据
                bus.DelHouseShare(list, log);

                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        public void ShareHouseSynchronization()
        {
            CargoHouseBrandShareEntity queryEntity = new CargoHouseBrandShareEntity();
            var list = JsonConvert.DeserializeObject<List<CargoHouseBrandShareEntity>>(Request["DelData"]);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "仓库管理";
            log.UserID = UserInfor.LoginName;
            log.Operate = "D";
            try
            {
                CargoHouseBus bus = new CargoHouseBus();
                bus.ShareHouseSynchronization(list, log);

                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion

        #region 库存导入Excel文件
        public List<CargoSafeStockEntity> DecodeHouseExcel(HttpFileCollection files)
        {
            List<CargoSafeStockEntity> listData = new List<CargoSafeStockEntity>();
            if (files == null || files.Count == 0) return listData;
            string attachmentId = Guid.NewGuid().ToString();
            DataTable data = ToExcel.ImportExcelData(files);

            CargoImportEntity import = new CargoImportEntity();
            import.Result = true;
            import.Data = "";
            import.Message = "";
            import.Type = 0;
            import.ExistCount = 0;
            string msg = "";

            CargoFactoryOrderBus FacBus = new CargoFactoryOrderBus();

            //验证上传excel文件列数是否有效
            if (data.Columns.Count < 9)
            {
                throw new ApplicationException("请检查导入文件是否为有9列字段");
            }
            //清空table中的空行
            removeEmpty(data);
            if (data.Rows.Count <= 0)
            {
                throw new ApplicationException("导入数据为空");
            }

            //获取所有可用品牌用于表格显示品牌
            CargoProductBasicPriceBus spescBus = new CargoProductBasicPriceBus();
            CargoProductBus prdctBus = new CargoProductBus();
            CargoOrderBus orderBuz = new CargoOrderBus();

            Dictionary<string, int> dicHouse = new Dictionary<string, int>();
            CargoHouseBus houseBus = new CargoHouseBus();
            var houseData = houseBus.QueryALLHouse();
            //foreach (var item in UserInfor.CargoList) 
            foreach (var house in houseData)
            {
                if (!dicHouse.ContainsKey(house.Name))
                {
                    dicHouse.Add(house.Name, house.HouseID);
                }
            }

            var AreaList = houseBus.GetHouseAreaList();

            //获取产品规格
            //DataTable ProductBasicDt = new DataTable();
            //ProductBasicDt = spescBus.QueryProductSpecDate(new CargoProductEntity { });
            string[] productCodes = data.AsEnumerable()
    .Select(row => row[1]?.ToString().Trim())
    .ToArray();
            var productDataList = prdctBus.QueryProductByCodes(productCodes);

            // 将AreaList转换为字典，按HouseID索引，避免重复查询
            var dicArea = AreaList
                .GroupBy(a => a.HouseID)
                .ToDictionary(g => g.Key, g => g.First());

            // 将productDataList转换为字典，按ProductCode索引
            var dicProduct = productDataList
                .Where(p => !string.IsNullOrEmpty(p.ProductCode))
                .GroupBy(p => p.ProductCode.Trim())
                .ToDictionary(g => g.Key, g => g.First(), StringComparer.OrdinalIgnoreCase);

            // 使用HashSet检查重复
            var existingKeys = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

            DataTable newData = new DataTable();
            newData.Columns.Add("HouseID", typeof(int));
            newData.Columns.Add("HouseName", typeof(string));
            newData.Columns.Add("AreaID", typeof(int));
            newData.Columns.Add("AreaName", typeof(string));
            newData.Columns.Add("TypeID", typeof(int));
            newData.Columns.Add("TypeName", typeof(string));
            newData.Columns.Add("GoodsCode", typeof(string));
            newData.Columns.Add("Specs", typeof(string));
            newData.Columns.Add("Figure", typeof(string));
            newData.Columns.Add("LoadIndex", typeof(string));
            newData.Columns.Add("SpeedLevel", typeof(string));

            newData.Columns.Add("AvgSaleNum", typeof(int));
            newData.Columns.Add("StockNum", typeof(int));
            newData.Columns.Add("MinStock", typeof(int));
            newData.Columns.Add("MaxStock", typeof(int));
            newData.Columns.Add("MinStockDay", typeof(int));
            newData.Columns.Add("MaxStockDay", typeof(int));
            newData.Columns.Add("OEStock", typeof(int));
            newData.Columns.Add("HCYCStock", typeof(int));
            newData.Columns.Add("REStock", typeof(int));
            newData.Columns.Add("IsolatedStock", typeof(int));
            newData.Columns.Add("ControlStock", typeof(int));

            newData.Columns.Add("ProductCode", typeof(string));
            newData.Columns.Add("ProductName", typeof(string));
            newData.Columns.Add("Model", typeof(string));

            int abnormalCount = 0;
            for (int i = 0; i < data.Rows.Count; i++)
            {
                var curRow = data.Rows[i];
                //验证Excel表格指定列是否缺少数据
                bool isContinue = false;
                for (int j = 0; j < data.Columns.Count; j++)
                {
                    if (string.IsNullOrEmpty((curRow[j]).ToString()))
                    {
                        isContinue = true;
                        break;
                    }
                }
                if (isContinue)
                {
                    abnormalCount++;
                    msg += "第" + (i + 2) + "行数据有空值\r\n";
                    continue;
                }
                string houseName = Convert.ToString(curRow[0]).Trim();
                string ProductCode = curRow[1].ToString().Trim();

                //筛除重复配置数据 - ✅ 使用HashSet，O(1)复杂度
                string uniqueKey = $"{houseName}|{ProductCode}";
                if (existingKeys.Contains(uniqueKey))
                {
                    continue;
                }
                existingKeys.Add(uniqueKey);

                //验证导入仓库是否在数据库中有效，无效则跳过
                int HouseID = 0;
                if (!string.IsNullOrEmpty(houseName))
                {
                    if (!dicHouse.ContainsKey(houseName))
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行所属仓库不存在\r\n";
                        continue;
                    }
                    else
                    {
                        dicHouse.TryGetValue(Convert.ToString(curRow[0]).Trim(), out HouseID);
                    }
                }

                // 定义验证规则
                var validations = new[]
                {
                    new { columnIndex = 2, fieldName = "最小库存天数" },
                    new { columnIndex = 3, fieldName = "最大库存天数" },
                    new { columnIndex = 4, fieldName = "OE安全库存数" },
                    new { columnIndex = 5, fieldName = "YC安全库存数" },
                    new { columnIndex = 6, fieldName = "RE安全库存数" },
                    new { columnIndex = 7, fieldName = "隔离库存数" },
                    new { columnIndex = 8, fieldName = "品控库存数" }
                };

                // 批量验证数值格式
                foreach (var validation in validations)
                {
                    string value = curRow[validation.columnIndex].ToString().Trim();

                    if (!string.IsNullOrEmpty(value))
                    {
                        if (!IsNumber(value))
                        {
                            abnormalCount++;
                            msg += $"第{i + 1}行{validation.fieldName}非数值格式。请检查数据格式：\"{value}\"\r\n";
                            break; // 或者 continue 到下一行
                        }
                        curRow[validation.columnIndex] = value;
                    }
                    else
                    {
                        curRow[validation.columnIndex] = 0;
                    }
                }
                int MinStockDay = int.Parse(curRow[2]?.ToString());
                int MaxStockDay = int.Parse(curRow[3]?.ToString());
                int OEStock = int.Parse(curRow[4]?.ToString());
                int HCYCStock = int.Parse(curRow[5]?.ToString());
                int REStock = int.Parse(curRow[6]?.ToString());
                int IsolatedStock = int.Parse(curRow[7]?.ToString());
                int ControlStock = int.Parse(curRow[8]?.ToString());

                string HouseName = Convert.ToString(curRow[0]).Trim();
                string ProductName = string.Empty;
                string Model = string.Empty;
                string Specs = string.Empty;
                string Figure = string.Empty;
                string LoadIndex = string.Empty;
                string SpeedLevel = string.Empty;
                string GoodsCode = string.Empty;
                string TypeID = string.Empty;
                string TypeName = string.Empty;

                // ✅ 使用字典查找Area，O(1)复杂度
                if (!dicArea.TryGetValue(HouseID, out var Area))
                {
                    abnormalCount++;
                    msg += "第" + (i + 2) + "行仓库对应的区域不存在\r\n";
                    continue;
                }
                var AreaID = Area.AreaID;
                var AreaName = Area.Name;

                //DataRow[] rows = ProductBasicDt.Select("ProductCode='" + ProductCode + "'");

                // ✅ 使用字典查找Product，O(1)复杂度
                if (!dicProduct.TryGetValue(ProductCode, out var productMatched))
                {
                    abnormalCount++;
                    msg += "第" + (i + 2) + $"行数据产品编码({ProductCode})不存在\r\n";
                    continue;
                }

                ProductName = productMatched.ProductName.Trim();
                TypeID = productMatched.TypeID.ToString();
                TypeName = productMatched.TypeName;
                GoodsCode = productMatched.GoodsCode;
                Specs = productMatched.Specs;
                Figure = productMatched.Figure;
                LoadIndex = productMatched.LoadIndex;
                SpeedLevel = productMatched.SpeedLevel;
                Model = productMatched.Model;

                DataRow drNew = newData.NewRow();

                object[] objs = {
                            HouseID,
                            HouseName,
                            AreaID,
                            AreaName,
                            TypeID,
                            TypeName,
                            GoodsCode,
                            Specs,
                            Figure,
                            LoadIndex,
                            SpeedLevel,
                            0,
                            0,
                            0,
                            0,
                            MinStockDay,
                            MaxStockDay,
                            OEStock,
                            HCYCStock,
                            REStock,
                            IsolatedStock,
                            ControlStock,
                            ProductCode,
                            ProductName,
                            Model,
                    };
                drNew.ItemArray = objs;
                newData.Rows.Add(drNew);

            }

            //获取月均销量；计算最大最小安全库存数
            List<AvgMonthSalesData_qryParam> avgMonthSalesData_QryParams = new List<AvgMonthSalesData_qryParam>();

            for (int i = 0; i < newData.Rows.Count; i++)
            {
                var curRow = newData.Rows[i];
                int HouseID = curRow.Field<int?>("HouseID") ?? 0;
                string ProductCode = curRow.Field<string>("ProductCode");
                avgMonthSalesData_QryParams.Add(new AvgMonthSalesData_qryParam()
                {
                    ProductCode = ProductCode,
                    HouseID = HouseID
                });
            }

            if (abnormalCount > 0)
            {
                //throw new ApplicationException(msg);
            }

            var avgMthSals = orderBuz.GetAvgMonthSales(avgMonthSalesData_QryParams);

            //赋值表格
            if (newData.Rows.Count > 0)
            {
                for (int i = 0; i < newData.Rows.Count; i++)
                {
                    var curRow = newData.Rows[i];
                    CargoSafeStockEntity ent = new CargoSafeStockEntity();
                    int AreaID = curRow.Field<int?>("AreaID") ?? 0;
                    int HouseID = curRow.Field<int?>("HouseID") ?? 0;
                    string ProductCode = (curRow.Field<string>("ProductCode") ?? string.Empty).Trim();
                    int MinStockDay = curRow.Field<int?>("MinStockDay") ?? 0;
                    int MaxStockDay = curRow.Field<int?>("MaxStockDay") ?? 0;
                    int? OEStock = curRow.Field<int?>("OEStock");
                    int? HCYCStock = curRow.Field<int?>("HCYCStock");
                    int? REStock = curRow.Field<int?>("REStock");

                    var avgMthSalData = avgMthSals.FirstOrDefault(c => c.ProductCode == ProductCode && c.HouseID == HouseID);
                    int avgMthSal = avgMthSalData?.AvgMonthSale ?? 0;
                    double avgDaySal = avgMthSal / 30d;
                    int minStock = Convert.ToInt32(Math.Ceiling(avgDaySal * MinStockDay));
                    int maxStock = Convert.ToInt32(Math.Ceiling(avgDaySal * MaxStockDay));
                    int stockNum = OEStock.GetValueOrDefault() + HCYCStock.GetValueOrDefault() + REStock.GetValueOrDefault();

                    ent.ExcelNo = i + 1;

                    ent.HouseID = curRow.Field<int?>("HouseID")?.ToString() ?? string.Empty;
                    ent.HouseName = (curRow.Field<string>("HouseName") ?? string.Empty).Trim();

                    ent.AreaID = AreaID;
                    ent.AreaName = curRow.Field<string>("AreaName") ?? string.Empty;

                    ent.TypeID = curRow.Field<int?>("TypeID") ?? 0;
                    ent.TypeName = (curRow.Field<string>("TypeName") ?? string.Empty).Trim();

                    ent.GoodsCode = (curRow.Field<string>("GoodsCode") ?? string.Empty).Trim();
                    ent.Specs = (curRow.Field<string>("Specs") ?? string.Empty).Trim();
                    ent.Figure = (curRow.Field<string>("Figure") ?? string.Empty).Trim();
                    ent.LoadIndex = (curRow.Field<string>("LoadIndex") ?? string.Empty).Trim();
                    ent.SpeedLevel = (curRow.Field<string>("SpeedLevel") ?? string.Empty).Trim();

                    ent.AvgSaleNum = avgMthSal;
                    ent.StockNum = stockNum;
                    ent.MinStock = minStock;
                    ent.MaxStock = maxStock;

                    ent.MinStockDay = MinStockDay;
                    ent.MaxStockDay = MaxStockDay;
                    ent.OEStock = OEStock;
                    ent.HCYCStock = HCYCStock;
                    ent.REStock = REStock;
                    ent.IsolatedStock = curRow.Field<int?>("IsolatedStock") ?? 0;
                    ent.ControlStock = curRow.Field<int?>("ControlStock") ?? 0;

                    ent.ProductCode = ProductCode;
                    ent.ProductName = (curRow.Field<string>("ProductName") ?? string.Empty).Trim();
                    ent.Model = (curRow.Field<string>("Model") ?? string.Empty).Trim();

                    listData.Add(ent);
                }
            }
            return listData;
        }

        /// <summary>
        /// 库存导入Excel文件
        /// </summary>
        public void saveFile()
        {
            HttpFileCollection files = Request.Files;
            CargoImportEntity import = new CargoImportEntity();
            import.Result = true;
            import.Data = "";
            import.Message = "";
            import.Type = 0;
            import.ExistCount = 0;
            if (files == null || files.Count == 0) return;
            try
            {
                var entityFiles = DecodeHouseExcel(files);
                string json = JSON.Encode(entityFiles);

                import.Result = true;
                import.Data = json;
                json = JSON.Encode(import);
                Response.Clear();
                Response.Write(json);
                Response.Flush();
            }
            catch (Exception ex)
            {
                import.Result = false;
                import.Type = 1;
                import.Message = ex.Message;
                string abnormalJson = JSON.Encode(import);
                Response.Clear();
                Response.Write(abnormalJson);
                Response.Flush();
                throw;
            }
        }


        public void saveFileAndData()
        {
            HttpFileCollection files = Request.Files;
            CargoImportEntity import = new CargoImportEntity();
            import.Result = true;
            import.Data = "";
            import.Message = "";
            import.Type = 0;
            import.ExistCount = 0;
            if (files == null || files.Count == 0) return;


            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "安全库存导入";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            try
            {
                var entityFiles = DecodeHouseExcel(files);

                List<ModifySafeStockDto> modifySS = new List<ModifySafeStockDto>();
                modifySS = entityFiles.Select(e => new ModifySafeStockDto
                {
                    HouseID = int.TryParse(e.HouseID, out int cHosueID) ? cHosueID : 0,
                    AreaID = e.AreaID,
                    TypeID = e.TypeID,
                    Specs = e.Specs,
                    Figure = e.Figure,
                    GoodsCode = e.GoodsCode,
                    LoadIndex = e.LoadIndex,
                    SpeedLevel = e.SpeedLevel,
                    StockNum = e.StockNum,
                    OPID = UserInfor.LoginName,
                    OP_DATE = e.OP_DATE,
                    MaxStock = e.MaxStock,
                    MinStock = e.MinStock,
                    ProductCode = e.ProductCode,
                    MinStockDay = e.MinStockDay,
                    MaxStockDay = e.MaxStockDay,
                    HCYCStock = e.HCYCStock,
                    OEStock = e.OEStock,
                    REStock = e.REStock,
                    IsolatedStock = e.IsolatedStock,
                    ControlStock = e.ControlStock,
                    AvgSaleNum = e.AvgSaleNum
                }).ToList();

                CargoHouseBus bus = new CargoHouseBus();
                bus.SaveImportSafeStock(modifySS, log);

                string json = JSON.Encode(entityFiles);

                import.Result = true;
                import.Data = json;
                json = JSON.Encode(import);
                Response.Clear();
                Response.Write(json);
                Response.Flush();
            }
            catch (Exception ex)
            {
                import.Result = false;
                import.Type = 1;
                import.Message = ex.Message;
                string abnormalJson = JSON.Encode(import);
                Response.Clear();
                Response.Write(abnormalJson);
                Response.Flush();
                throw;
            }
        }

        /// <summary>
        /// 保存导入的数据
        /// </summary>
        public void SaveImportData()
        {
            string json = Request["data"];
            if (string.IsNullOrEmpty(json)) return;

            CargoHouseBus bus = new CargoHouseBus();

            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.Status = "0";
            log.NvgPage = "安全库存导入";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            try
            {
                List<CargoSafeStockEntity> entityFiles = new List<CargoSafeStockEntity>();
                foreach (Hashtable row in rows)
                {
                    CargoSafeStockEntity ent = new CargoSafeStockEntity();
                    ent.HouseID = Convert.ToString(row["HouseID"]);
                    ent.HouseName = Convert.ToString(row["HouseName"]).Trim();
                    ent.AreaID = Convert.ToInt32(row["AreaID"]);
                    ent.TypeID = Convert.ToInt32(row["TypeID"]);
                    ent.GoodsCode = Convert.ToString(row["GoodsCode"]).Trim();
                    ent.TypeName = Convert.ToString(row["TypeName"]).Trim();
                    ent.AvgSaleNum = Convert.ToInt32(row["AvgSaleNum"]);
                    ent.StockNum = Convert.ToInt32(row["StockNum"]);
                    ent.MinStock = Convert.ToInt32(row["MinStock"]);
                    ent.MaxStock = Convert.ToInt32(row["MaxStock"]);
                    ent.MinStockDay = Convert.ToInt32(row["MinStockDay"]);
                    ent.MaxStockDay = Convert.ToInt32(row["MaxStockDay"]);
                    ent.OEStock = Convert.ToInt32(row["OEStock"]);
                    ent.HCYCStock = Convert.ToInt32(row["HCYCStock"]);
                    ent.REStock = Convert.ToInt32(row["REStock"]);
                    ent.IsolatedStock = Convert.ToInt32(row["IsolatedStock"]);
                    ent.ControlStock = Convert.ToInt32(row["ControlStock"]);
                    ent.Model = Convert.ToString(row["Model"]).Trim();
                    ent.Specs = Convert.ToString(row["Specs"]).Trim();
                    ent.LoadIndex = Convert.ToString(row["LoadIndex"]).Trim();
                    ent.SpeedLevel = Convert.ToString(row["SpeedLevel"]).Trim();
                    ent.Figure = Convert.ToString(row["Figure"]).Trim();
                    ent.ProductCode = Convert.ToString(row["ProductCode"]).Trim();
                    ent.OPID = UserInfor.LoginName;
                    ent.OP_DATE = DateTime.Now;
                    entityFiles.Add(ent);
                }
                if (entityFiles.Count == 0)
                {
                    msg.Message = "无可保存库存数据";
                    msg.Result = false;
                    goto ERROR;
                }
                List<ModifySafeStockDto> modifySS = new List<ModifySafeStockDto>();
                modifySS = entityFiles.Select(e => new ModifySafeStockDto
                {
                    HouseID = int.TryParse(e.HouseID, out int cHosueID) ? cHosueID : 0,
                    AreaID = e.AreaID,
                    TypeID = e.TypeID,
                    Specs = e.Specs,
                    Figure = e.Figure,
                    GoodsCode = e.GoodsCode,
                    LoadIndex = e.LoadIndex,
                    SpeedLevel = e.SpeedLevel,
                    StockNum = e.StockNum,
                    OPID = e.OPID,
                    OP_DATE = e.OP_DATE,
                    MaxStock = e.MaxStock,
                    MinStock = e.MinStock,
                    ProductCode = e.ProductCode,
                    MinStockDay = e.MinStockDay,
                    MaxStockDay = e.MaxStockDay,
                    HCYCStock = e.HCYCStock,
                    OEStock = e.OEStock,
                    REStock = e.REStock,
                    IsolatedStock = e.IsolatedStock,
                    ControlStock = e.ControlStock,
                    AvgSaleNum = e.AvgSaleNum
                }).ToList();

                bus.SaveImportSafeStock(modifySS, log);

                if (msg.Result)
                {
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
        ERROR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 删除导入的table中的空行
        /// </summary>
        /// <param name="dt"></param>
        protected void removeEmpty(DataTable dt)
        {
            List<DataRow> removelist = new List<DataRow>();
            for (int i = 0; i < dt.Rows.Count; i++)
            {
                bool rowdataisnull = true;
                for (int j = 0; j < dt.Columns.Count; j++)
                {
                    if (!string.IsNullOrEmpty(dt.Rows[i][j].ToString().Trim()))
                    {

                        rowdataisnull = false;
                    }
                }
                if (rowdataisnull)
                {
                    removelist.Add(dt.Rows[i]);
                }

            }
            for (int i = 0; i < removelist.Count; i++)
            {
                dt.Rows.Remove(removelist[i]);
            }
        }
        /// <summary>
        /// 判断字符串是否为数字
        /// </summary>
        /// <param name="message"></param>
        /// <returns></returns>
        public static bool IsNumber(string value)
        {
            return Regex.IsMatch(value, @"^\d+$");
        }
        /// <summary>
        /// 判断字符串是否为整数或小数
        /// </summary>
        /// <param name="value">验证字符串</param>
        /// <returns></returns>
        public static bool isNumeric(String value)
        {
            return Regex.IsMatch(value, "^(\\-|\\+)?\\d+(\\.\\d+)?$");
        }
        #endregion

        #region 库存下载

        public void QueryStockFile()
        {
            CargoStockDownloadEntity queryEntity = new CargoStockDownloadEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["FileName"]))) { queryEntity.FileName = Convert.ToString(Request["FileName"]); }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            var list = bus.QueryStockFile(pageIndex, pageSize, queryEntity);

            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }


        public void DownloadFile()
        {
            CargoHouseBus bus = new CargoHouseBus();
            var ID = Convert.ToString(Request["ID"]);
            var data = bus.GetFileData(ID);

            var fullPath = data.FilePath;
            var fileName = data.FileName;

            CargoImportEntity import = new CargoImportEntity();
            import.Result = true;
            import.Data = "";
            import.Message = "";
            import.Type = 0;
            import.ExistCount = 0;

            String json = string.Empty;

            // 确保文件存在
            if (!System.IO.File.Exists(fullPath))
            {
                // 如果文件不存在，返回 404 Not Found 错误
                import.Result = false;
                import.Type = 1;
                import.Message = "文件不存在";
                String abnormalJson = JSON.Encode(import);
                Response.Clear();
                Response.Write(abnormalJson);
                Response.Flush();
                return;
            }

            try
            {
                // 清除响应内容
                Response.Clear();
                Response.ClearContent();
                Response.ClearHeaders();

                // 设置响应头
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
                Response.AddHeader("Content-Disposition", $"attachment;filename={HttpUtility.UrlEncode(fileName)}");
                Response.AddHeader("Content-Length", new FileInfo(fullPath).Length.ToString());

                // 把文件内容写入输出流
                Response.WriteFile(fullPath);

                // 结束响应
                Response.Flush();

            }
            catch (IOException ex)
            {
                // 处理文件锁定或其他 I/O 错误
                import.Result = false;
                import.Type = 1;
                import.Message = $@"服务器读取文件时发生 I/O 错误: {ex.Message}";
                String abnormalJson = JSON.Encode(import);
                Response.Clear();
                Response.Write(abnormalJson);
                Response.Flush();
                throw;
            }

        }

        public void SyncStockData()
        {
            CargoHouseBus houseBus = new CargoHouseBus();
            SyncStockDataSave();
        }
        public void SyncStockDataSave()
        {
            CargoHouseBus houseBus = new CargoHouseBus();
            CargoProductBus bus = new CargoProductBus();
            List<CargoProductSourceEntity> list = bus.QueryAllProductSource();
            CargoClientBus clientBus = new CargoClientBus();
            List<CargoUpClientEntity> clientList = clientBus.QueryAllUpClientDep(new CargoUpClientEntity { });
            for (int type = 1; type < 5; type++)
            {
                var dataList = houseBus.GetInventoryList(type);
                string tname = string.Empty;
                DataTable table = new DataTable("库存数据");
                table.Columns.Add("序号", typeof(int));
                table.Columns.Add("店代码", typeof(string));
                table.Columns.Add("店名称", typeof(string));
                table.Columns.Add("品牌", typeof(string));
                table.Columns.Add("规格", typeof(string));
                table.Columns.Add("库存数量", typeof(int));
                table.Columns.Add("批发价", typeof(decimal));
                if (type == 2)
                {
                    table.Columns.Add("批次", typeof(string));

                }
                else if (type == 3)
                {
                    table.Columns.Add("业务类型(物权)", typeof(string));
                    table.Columns.Add("最小批次", typeof(string));
                    table.Columns.Add("最大批次", typeof(string));
                }
                else if (type == 4)
                {
                    table.Columns.Add("批次", typeof(string));
                    table.Columns.Add("业务类型(物权)", typeof(string));
                }
                table.Columns.Add("供应商", typeof(string));
                table.Columns.Add("产地", typeof(string));
                table.Columns.Add("品牌大类", typeof(string));
                table.Columns.Add("产品编码", typeof(string));
                table.Columns.Add("货品代码", typeof(string));
                table.Columns.Add("型号", typeof(string));
                table.Columns.Add("花纹", typeof(string));
                table.Columns.Add("载重指数", typeof(string));
                table.Columns.Add("速度级别", typeof(string));
                table.Columns.Add("门店价", typeof(decimal));
                table.Columns.Add("小程序价", typeof(decimal));
                table.Columns.Add("次日达价", typeof(decimal));
                table.Columns.Add("标识", typeof(string));
                table.Columns.Add("最近入库时间", typeof(string));
                table.Columns.Add("最近出库时间", typeof(string));


                int i = 0;
                foreach (var it in dataList)
                {
                    i++;
                    DataRow newRows = table.NewRow();
                    newRows["序号"] = i;
                    newRows["店代码"] = it.StatisHouseCode;
                    newRows["店名称"] = it.StatisHouseName;
                    newRows["供应商"] = it.Supplier;
                    newRows["品牌大类"] = it.TypeParentName;
                    newRows["品牌"] = it.TypeName;
                    newRows["产品编码"] = it.ProductCode;
                    newRows["货品代码"] = it.GoodsCode;
                    newRows["规格"] = it.Specs.Trim();
                    newRows["型号"] = it.Model.Trim();
                    newRows["花纹"] = it.Figure;
                    newRows["载重指数"] = it.LoadIndex;
                    newRows["速度级别"] = it.SpeedLevel;
                    newRows["库存数量"] = it.Piece;
                    newRows["最近入库时间"] = it.InHouseTime;
                    if (it.OutHouseTime == Convert.ToDateTime(DateTime.MinValue))
                        newRows["最近出库时间"] = "";
                    else
                        newRows["最近出库时间"] = it.OutHouseTime;
                    newRows["产地"] = it.Born == "0" ? "国产" : "进口";
                    //newRows["在库天数"] = it.InHouseDay;
                    if (type == 2)
                    {
                        newRows["批次"] = it.Batch;
                    }
                    else if (type == 3)
                    {
                        newRows["业务类型(物权)"] = GetText(it.GoodsClass, "GoodsClass");
                        newRows["最小批次"] = it.minBatch;
                        newRows["最大批次"] = it.maxBatch;
                    }
                    else if (type == 4)
                    {
                        newRows["批次"] = it.Batch;
                        newRows["业务类型(物权)"] = GetText(it.GoodsClass, "GoodsClass");

                    }

                    newRows["门店价"] = it.TradePrice;
                    newRows["小程序价"] = it.SalePrice;
                    newRows["次日达价"] = it.NextDayPrice;
                    newRows["批发价"] = it.WholesalePrice;


                    newRows["标识"] = it.combinedName;

                    table.Rows.Add(newRows);
                }
                var fileName = string.Empty;
                if (type == 1)
                {
                    fileName = "狄乐库存数据(采购-进货)-" + DateTime.Now.ToString("yyyyMMddHHmm") + ".xlsx";
                }
                else if (type == 2)
                {
                    fileName = "狄乐库存数据(财务-批次)-" + DateTime.Now.ToString("yyyyMMddHHmm") + ".xlsx";
                }
                else if (type == 3)
                {
                    fileName = "狄乐库存数据(财务-物权)-" + DateTime.Now.ToString("yyyyMMddHHmm") + ".xlsx";
                }
                else if (type == 4)
                {
                    fileName = "狄乐库存数据(财务库存分析)-" + DateTime.Now.ToString("yyyyMMddHHmm") + ".xlsx";
                }
                var filePath = string.Empty;
                //ExportDataTableToExcel(table, fileName, out filePath);
                var fileFolder = GetStockFile();
                if (Debugger.IsAttached)
                {
                    fileFolder = "D:\\Work\\WareHouse2\\Files\\新建文件夹";
                }
                filePath = System.IO.Path.Combine(fileFolder, fileName);
                ToExcel.DataTableToExcel(table, filePath);
                if (File.Exists(filePath))
                {
                    houseBus.saveFileLog(new CargoStockDownloadEntity { FileName = fileName, FilePath = filePath });

                    if (File.Exists(filePath))
                    {
                        //删除文件
                        if (Directory.Exists(fileFolder))
                        {
                            // 获取当前文件夹中的所有文件
                            string[] files = Directory.GetFiles(fileFolder);

                            foreach (string file in files)
                            {
                                DateTime createTime = File.GetCreationTime(file);
                                // 判断是否超过一个月
                                if (createTime < DateTime.Now.AddMonths(-1))
                                {
                                    // file 变量是文件的完整路径
                                    File.Delete(file);
                                }
                            }
                        }
                    }
                }

              
            }
            //导出安全库存数据到本地
            ExportSafeStockToLocExcel();
        }
        private string GetStockFile()
        {
            return ConfigurationSettings.AppSettings["StockFile"];
        }
        public void ExportDataTableToExcel(DataTable table, string fileName, out string filePath)
        {
            // 获取项目根目录（或你可换成指定目录）
            string projectDir = GetStockFile();
            //string projectDir = "D:\\Work\\WareHouse2\\Files\\新建文件夹\\";
            string exportDir = System.IO.Path.Combine(projectDir, "");

            if (!Directory.Exists(exportDir))
                Directory.CreateDirectory(exportDir);

            filePath = System.IO.Path.Combine(exportDir, fileName);

            //using (var workbook = new XLWorkbook())
            //{
            //    var worksheet = workbook.Worksheets.Add(table, table.TableName);
            //    if (table.Rows.Count < 30000) worksheet.Columns().AdjustToContents(); // 自动列宽
            //    workbook.SaveAs(filePath);
            //}

            //Console.WriteLine($"📁 文件已保存到: {filePath}");
        }
        private string GetText(string value, string id)
        {
            string retStr = "";
            if (id.Contains("GoodsClass"))
            {
                if (value.Trim() == "0") retStr = "自有";
                else if (value.Trim() == "1") retStr = "进驻";
                else if (value.Trim() == "2") retStr = "托管";
            }
            else if (id.Contains("OwnerShip"))
            {
                if (value.Trim() == "48") retStr = "湖南狄乐RE";
                else if (value.Trim() == "1") retStr = "昆明云仓";
                else if (value.Trim() == "2") retStr = "已出库";
                else if (value.Trim() == "3") retStr = "运输在途";
                else if (value.Trim() == "4") retStr = "已到达";
                else if (value.Trim() == "5") retStr = "已签收";
                else if (value.Trim() == "6") retStr = "已拣货";
            }

            return retStr;
        }
        public string GetSoureName(List<CargoProductSourceEntity> ProductSource, int Source)
        {
            string SourceName = "";
            for (var i = 0; i < ProductSource.Count; i++)
            {
                if (ProductSource[i].Source == Source)
                {
                    SourceName = ProductSource[i].SourceName;
                    break;
                }
            }
            return SourceName;
        }

        public void QueryHouseStock()
        {
            //List<CargoInterfaceEntity>
            CargoInterfaceEntity queryEntity = new CargoInterfaceEntity();
            queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);
            queryEntity.TypeID = Convert.ToInt32(Request["TypeID"]);
            queryEntity.Specs = Convert.ToString(Request["Specs"]);
            queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            queryEntity.ProductCode = Convert.ToString(Request["ProductCode"]);
            queryEntity.Figure = Convert.ToString(Request["Figure"]);
            queryEntity.SuppClientNum = Convert.ToString(Request["SuppClientNum"]);
            CargoHouseBus bus = new CargoHouseBus();
            var List = bus.QueryHouseStock(queryEntity);

            String json = JSON.Encode(List);
            Response.Clear();
            Response.Write(json);
        }

        #endregion
    }
}