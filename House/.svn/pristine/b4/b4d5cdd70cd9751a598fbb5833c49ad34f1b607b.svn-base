using System;
using House.Business;
using House.Business.Cargo;
using House.Entity;
using House.Entity.Cargo;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Senparc.Weixin.QY.CommonAPIs;
using Senparc.Weixin.QY.Entities;
using Senparc.Weixin.QY.AdvancedAPIs;
using Senparc.Weixin.QY.AdvancedAPIs.MailList;
using Senparc.Weixin.Entities;
using System.Text;
using Senparc.Weixin.QY.Containers;
using Senparc.Weixin.QY.Helpers;
using House.Entity.House;
using System.Security.Cryptography;
using System.Collections.Specialized;
using Memcached.ClientLibrary;
using System.Configuration;
using NPOI.HSSF.Record.Formula.Functions;
using iText.Layout.Element;
using System.Runtime.Remoting.Contexts;
using Senparc.Weixin.MP.TenPayLibV3;
using Senparc.Weixin.MP.AdvancedAPIs.MerChant;
using House.Entity.Cargo.Product;
using NPOI.POIFS.Properties;

namespace Cargo.QY
{
    public partial class qyServices : QYBasePage
    {
        public static MemcachedClient memClient = new MemcachedClient();
        protected void Page_Load(object sender, EventArgs e)
        {
            #region 缓存
            string[] serverlist = ConfigurationSettings.AppSettings["memcachedServer"].Split('/');
            SockIOPool pool = SockIOPool.GetInstance(ConfigurationSettings.AppSettings["PoolName"]);
            pool.SetServers(serverlist);
            pool.InitConnections = Convert.ToInt32(ConfigurationSettings.AppSettings["InitConnections"]);//连接池初始容量
            pool.MinConnections = Convert.ToInt32(ConfigurationSettings.AppSettings["MinConnections"]);//最小容量
            pool.MaxConnections = Convert.ToInt32(ConfigurationSettings.AppSettings["MaxConnections"]);//最大容量
            pool.SocketConnectTimeout = Convert.ToInt32(ConfigurationSettings.AppSettings["SocketConnectTimeout"]);//数据读取超时时间
            pool.SocketTimeout = Convert.ToInt32(ConfigurationSettings.AppSettings["SocketTimeout"]);//Socket连接超时时间
            pool.MaintenanceSleep = Convert.ToInt64(ConfigurationSettings.AppSettings["MaintenanceSleep"]);//线程池维护线程之间的休眠时间
            pool.Failover = Convert.ToBoolean(ConfigurationSettings.AppSettings["Failover"]);//使用缓存服务器自动切换功能，当一台服务器死了可以自动切换到另外一台查找缓存

            pool.Nagle = Convert.ToBoolean(ConfigurationSettings.AppSettings["Nagle"]);//禁用Nagle算法
            pool.Initialize();
            memClient.PoolName = ConfigurationSettings.AppSettings["PoolName"];
            memClient.EnableCompression = true;
            memClient.CompressionThreshold = 10240;
            #endregion
            string methodName = string.Empty;
            try
            {
                methodName = Request["method"];
                if (String.IsNullOrEmpty(methodName)) return;
                Type type = this.GetType();
                MethodInfo method = type.GetMethod(methodName);
                method.Invoke(this, null);
            }
            catch (Exception ex)
            {
                LogBus bus = new LogBus();
                LogEntity log = new LogEntity();
                log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                log.Operate = "";
                log.Moudle = "";
                log.Status = "1";
                log.NvgPage = "";
                log.UserID = QyUserInfo.UserID;
                log.Memo = methodName + " " + ex.Message + " " + ex.StackTrace;
                bus.InsertLog(log);
            }
        }
        /// <summary>
        /// 查询轮胎库存
        /// </summary>
        public void QueryTypeStock()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            string res = Convert.ToString(Request["Specs"]);
            res = res.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "");
            if (!res.Contains("/") && !res.ToUpper().Contains("R"))
            {
                if (res.Length <= 3)
                {
                    queryEntity.Specs = res;
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    queryEntity.Specs = res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3);
                }
                if (res.Length > 5)
                {
                    queryEntity.Specs = res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5);
                }
            }
            if (res.ToUpper().Contains("F"))
            {
                queryEntity.Specs = res;
                if (!res.ToUpper().Contains("/"))
                {
                    queryEntity.Specs = res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3);
                }
            }
            if (res.ToUpper().Contains("R") && res.ToUpper().Contains("C"))
            {
                queryEntity.Specs = res;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["TypeID"])))
            {
                queryEntity.TypeID = Convert.ToInt32(Request["TypeID"]);
            }
            queryEntity.Figure = Convert.ToString(Request["Figure"]);
            queryEntity.Model = Convert.ToString(Request["Model"]);
            queryEntity.Batch = Convert.ToString(Request["Batch"]);
            if (QyUserInfo.IsQueryLockStock != "1")
            {
                queryEntity.IsLockStock = "0";
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["BatchYear"])))
            {
                queryEntity.BatchYear = Convert.ToInt32(Request["BatchYear"]);
            }
            if (QyUserInfo.IsHeadHouse.Equals(1))
            {
                queryEntity.FirstAreaID = QyUserInfo.HeadHouseID;
            }
            else
            {
                if (!string.IsNullOrEmpty(Convert.ToString(Request["HouseID"])))
                {
                    queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);
                }
                else
                {
                    queryEntity.CargoPermisID = QyUserInfo.CargoPermisID;
                }
            }
            if (!string.IsNullOrEmpty(Request["IsShowStock"]))
            {
                queryEntity.IsShowStock = Convert.ToString(Request["IsShowStock"]);
            }
            //queryEntity.Specs = Convert.ToString(Request["key"]);
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.QueryInHouseData(0, 0, queryEntity);
            List<CargoContainerShowEntity> goods = list["rows"] as List<CargoContainerShowEntity>;
            List<CargoContainerShowEntity> re = new List<CargoContainerShowEntity>();
            foreach (var it in goods)
            {
                if (!it.HouseID.Equals(9) || it.ProductName.Contains("迪乐泰") || it.ProductName.Contains("维京") || it.ProductName.Contains("马牌"))
                {
                    re.Add(it);
                }
            }
            re = re.OrderBy(c => c.TypeID).OrderByDescending(c => c.HouseID).ToList();
            //JSON
            String json = JSON.Encode(re);
            //Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 领导查询产品库存和价格销售价和成本价
        /// </summary>
        public void QueryLeaderStock()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            string res = Convert.ToString(Request["Specs"]);
            res = res.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "");
            if (!res.Contains("/") && !res.ToUpper().Contains("R"))
            {
                if (res.Length <= 3)
                {
                    queryEntity.Specs = res;
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    queryEntity.Specs = res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3);
                }
                if (res.Length > 5)
                {
                    queryEntity.Specs = res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5);
                }
            }
            if (res.ToUpper().Contains("F"))
            {
                queryEntity.Specs = res;
                if (!res.ToUpper().Contains("/"))
                {
                    queryEntity.Specs = res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3);
                }
            }
            if (res.ToUpper().Contains("R") && res.ToUpper().Contains("C"))
            {
                queryEntity.Specs = res;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["TypeID"])))
            {
                queryEntity.TypeID = Convert.ToInt32(Request["TypeID"]);
            }
            queryEntity.Figure = Convert.ToString(Request["Figure"]);
            queryEntity.Model = Convert.ToString(Request["Model"]);
            queryEntity.Batch = Convert.ToString(Request["Batch"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["BatchYear"])))
            {
                queryEntity.BatchYear = Convert.ToInt32(Request["BatchYear"]);
            }
            if (QyUserInfo.IsHeadHouse.Equals(1))
            {
                queryEntity.FirstAreaID = QyUserInfo.HeadHouseID;
            }
            else
            {
                queryEntity.CargoPermisID = QyUserInfo.CargoPermisID;
            }
            //queryEntity.Specs = Convert.ToString(Request["key"]);
            CargoHouseBus bus = new CargoHouseBus();
            Hashtable list = bus.QueryInHouseData(0, 0, queryEntity);
            List<CargoContainerShowEntity> goods = list["rows"] as List<CargoContainerShowEntity>;
            List<CargoContainerShowEntity> re = new List<CargoContainerShowEntity>();
            foreach (var it in goods)
            {
                CargoContainerShowEntity ccse = new CargoContainerShowEntity();
                ccse.TypeName = it.TypeName;
                ccse.Figure = it.Figure;
                ccse.Specs = it.Specs;
                ccse.LoadIndex = it.LoadIndex;
                ccse.SpeedLevel = it.SpeedLevel;
                ccse.Batch = it.Batch;
                ccse.SalePrice = it.SalePrice;
                ccse.CostPrice = it.CostPrice;
                ccse.Piece = it.Piece;
                ccse.HouseName = it.HouseName;
                if (it.HouseID.Equals(45) || it.HouseID.Equals(44))
                {
                    ccse.HouseName = it.FirstAreaName;

                }
                if (!it.HouseID.Equals(9) || it.ProductName.Contains("迪乐泰"))
                {
                    re.Add(ccse);
                }
            }
            var rer = (from t in re
                       group t by new { t.HouseName, t.TypeName, t.Figure, t.Specs, t.LoadIndex, t.SpeedLevel, t.Batch, t.SalePrice, t.CostPrice }
                      into grp
                       select new
                       {
                           grp.Key.HouseName,
                           grp.Key.TypeName,
                           grp.Key.Specs,
                           grp.Key.Figure,
                           grp.Key.LoadIndex,
                           grp.Key.SpeedLevel,
                           grp.Key.Batch,
                           grp.Key.SalePrice,
                           grp.Key.CostPrice,
                           Quantity = grp.Sum(t => t.Piece)
                       }).ToList();
            rer = rer.OrderBy(c => c.HouseName).OrderByDescending(c => c.TypeName).ToList();
            //JSON
            String json = JSON.Encode(rer);
            //Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 根据ID查询在库产品信息
        /// </summary>
        public void QueryInHouseProductByID()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            foreach (Hashtable row in rows)
            {
                if (Convert.ToInt32(row["PC"]) <= 0) { continue; }
                CargoContainerGoodsEntity ent = new CargoContainerGoodsEntity();
                ent.ID = Convert.ToInt64(row["ID"]);
                List<CargoContainerShowEntity> cargo = bus.QueryInHouseProductByID(ent);
                if (cargo.Count <= 0) { continue; }
                cargo[0].Piece = Convert.ToInt32(row["PC"]);
                if (!Convert.ToDecimal(row["PRICE"]).Equals(0))
                {
                    if (Convert.ToDecimal(row["PRICE"]) > cargo[0].SalePrice)
                    {
                        cargo[0].SalePrice = Convert.ToDecimal(row["PRICE"]);
                    }
                }
                result.AddRange(cargo);
            }
            //返回处理结果
            string res = JSON.Encode(result);
            Response.Write(res);
        }
        /// <summary>
        /// 通过录单人ID业务员ID查询该微信用户的订单数据
        /// </summary>
        public void queryWxUserOrderInfo()
        {
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();

            CargoOrderEntity ent = new CargoOrderEntity();
            ent.SaleManID = QyUserInfo.UserID;

            ent.StartDate = DateTime.Now.AddDays(-DateTime.Now.Day).AddDays(1);
            ent.EndDate = DateTime.Now;
            result = bus.queryWxUserOrderInfo(ent);
            //返回处理结果
            string res = JSON.Encode(result);
            Response.Write(res);
        }
        /// <summary>
        /// 客户地址查询
        /// </summary>
        public void QueryClientAddress()
        {
            CargoClientEntity queryEntity = new CargoClientEntity();
            string spe = Convert.ToString(Request["key"]);
            string[] res = spe.Split(' ');
            if (res.Length == 1)
            {
                if (Common.IsInt(res[0]))//表示电话号码 
                {
                    queryEntity.Cellphone = Convert.ToString(res[0]);
                }
                else
                {
                    queryEntity.Boss = Convert.ToString(res[0]);
                }
            }
            if (res.Length == 2)
            {
                if (Common.IsInt(res[0]))//表示电话号码 
                {
                    queryEntity.Cellphone = Convert.ToString(res[0]);
                    queryEntity.Boss = Convert.ToString(res[1]);
                }
                else
                {
                    queryEntity.Boss = Convert.ToString(res[0]);
                    queryEntity.Cellphone = Convert.ToString(res[1]);
                }
            }
            queryEntity.DelFlag = "0";
            queryEntity.HouseID = QyUserInfo.HouseID;
            //queryEntity.Specs = Convert.ToString(Request["key"]);
            CargoClientBus bus = new CargoClientBus();
            List<CargoClientEntity> list = bus.QueryClientAddress(queryEntity);
            StringBuilder sb = new StringBuilder();
            sb.Append(" <ul class='mui-table-view mui-table-view-chevron' style='margin: 0px 0px 3px 0px;'>");
            if (list.Count > 0)
            {
                foreach (var it in list)
                {
                    string add = it.ClientID.ToString() + "/" + it.Address + "/" + it.Boss + "/" + it.Cellphone + "/" + it.City;
                    sb.Append("<li class='mui-table-view-cell' style='padding: 4px 5px;' onclick='inputAddSession(\"" + add + "\")'>");
                    sb.Append("<div class='mui-pull-left' style='min-height: 60px; color: #008B00; margin-left: 3px'><span class='mui-icon mui-icon-location' style='font-size: 32px;'></span></div>");
                    //地址
                    sb.Append("<div style='font-size: 15px; color: #27408B;'>" + it.Address + "</div>");
                    sb.Append("<div style='font-size: 15px; color: #27408B; margin-right: 15px;' class='mui-pull-right'>" + it.City + "</div>");
                    sb.Append("<div style='font-size: 15px; color: #27408B;'>" + it.Boss + "</div>");
                    sb.Append("<div style='font-size: 15px; color: #27408B;'>" + it.Cellphone + "</div>");
                    sb.Append("</li>");
                }
            }

            sb.Append("</ul>");
            //JSON
            String json = JSON.Encode(sb.ToString());
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 保存订单
        /// </summary>
        public void WxQySaveOrder()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            String order = Request["Orderdata"];
            String client = Request["Clientdata"];
            string dest = Request["dest"];
            string LogisID = Request["logicID"];
            if (String.IsNullOrEmpty(order)) return;
            if (String.IsNullOrEmpty(client)) return;
            ArrayList rows = (ArrayList)JSON.Decode(order);
            ArrayList clientArray = (ArrayList)JSON.Decode(client);

            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            CargoOrderBus bus = new CargoOrderBus();
            CargoClientBus cargoBus = new CargoClientBus();
            CargoHouseBus house = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "企业号下单";
            log.UserID = QyUserInfo.UserID;
            log.Operate = "A";
            log.Status = "0";
            try
            {
                int houseID = 0;
                string houseCode = string.Empty;
                string houseName = string.Empty;
                foreach (Hashtable row in rows)
                {
                    List<CargoContainerShowEntity> hou = house.QueryInHouseProductByID(new CargoContainerGoodsEntity { ID = Convert.ToInt64(row["ID"]) });
                    if (hou.Count > 0)
                    {
                        houseID = hou[0].HouseID;
                        houseCode = hou[0].HouseCode;
                        houseName = hou[0].HouseName;
                    }
                    break;
                }

                #region 赋值
                int OrderNum = 0;
                ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(houseID, houseCode, out OrderNum);//生成最新顺序订单号
                ent.OrderNum = OrderNum;//最新订单顺序号
                //ent.HAwbNo = Convert.ToString(Request["HAwbNo"]);
                ent.Weight = 0;
                ent.Volume = 0;
                ent.InsuranceFee = 0;
                ent.TransitFee = 0;
                ent.DeliveryFee = 0;
                ent.OtherFee = 0;
                ent.Rebate = 0;
                ent.HouseID = houseID;
                ent.HouseName = houseName;
                ent.CheckOutType = "0";//Convert.ToString(Request["CheckOutType"]);
                //ent.ReturnAwb = string.IsNullOrEmpty(Convert.ToString(Request["ReturnAwb"])) ? 0 : Convert.ToInt32(Request["ReturnAwb"]);
                ent.TrafficType = "0";// Convert.ToString(Request["TrafficType"]);
                ent.DeliveryType = "0";//Convert.ToString(Request["DeliveryType"]);
                if (QyUserInfo.HouseName.Contains("湖南"))
                {
                    ent.Dep = "长沙";
                }
                else if (QyUserInfo.HouseName.Contains("湖北"))
                {
                    ent.Dep = "武汉";
                }
                else if (QyUserInfo.HouseName.Contains("西安"))
                {
                    ent.Dep = "西安";
                }
                else if (QyUserInfo.HouseName.Contains("广州"))
                {
                    ent.Dep = "广州";
                }
                else if (QyUserInfo.HouseName.Contains("天津"))
                {
                    ent.Dep = "天津";
                }
                else if (QyUserInfo.HouseName.Contains("上海"))
                {
                    ent.Dep = "上海";
                }
                else if (QyUserInfo.HouseName.Contains("四川"))
                {
                    ent.Dep = "成都";
                }
                ent.Dest = dest;
                if (!string.IsNullOrEmpty(LogisID))
                {
                    ent.LogisID = Convert.ToInt32(LogisID);
                }
                //获取客户信息
                foreach (Hashtable row in clientArray)
                {
                    CargoClientEntity cce = cargoBus.QueryCargoClient(Convert.ToInt64(row["ClientID"]));
                    ent.AcceptUnit = cce.ClientShortName;
                    ent.AcceptAddress = cce.Address;
                    ent.AcceptPeople = cce.Boss;
                    ent.AcceptTelephone = cce.Telephone;
                    ent.AcceptCellphone = cce.Cellphone;
                    ent.ClientNum = cce.ClientNum;
                    //ent.Dest = Convert.ToString(row["City"]);
                }


                ent.CreateAwb = QyUserInfo.WxName;
                ent.CreateAwbID = QyUserInfo.UserID;
                ent.CreateDate = DateTime.Now;
                ent.OP_ID = QyUserInfo.UserID;
                ent.SaleManID = QyUserInfo.UserID;
                ent.SaleManName = QyUserInfo.WxName;
                //ent.Remark = Convert.ToString(Request["Remark"]);
                //if (!string.IsNullOrEmpty(Convert.ToString(Request["LogisID"])))
                //{
                //    ent.LogisID = Convert.ToInt32(Request["LogisID"]);

                //}
                //ent.ClientNum = Common.GetRandomSixNum();//生成随机的六位数字做为客户编码

                #endregion
                string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                int pieceT = 0; decimal moneyT = 0.00M;
                //CargoInterfaceBus interBus = new CargoInterfaceBus();
                foreach (Hashtable row in rows)
                {
                    if (Convert.ToInt32(row["PC"]) <= 0) { continue; }
                    List<CargoContainerShowEntity> contain = house.QueryInHouseProductByID(new CargoContainerGoodsEntity { ID = Convert.ToInt64(row["ID"]) });
                    int piece = Convert.ToInt32(row["PC"]);
                    pieceT += Convert.ToInt32(row["PC"]);
                    //moneyT += Convert.ToInt32(row["PC"]) * contain[0].SalePrice;
                    if (Convert.ToDecimal(row["PRICE"]).Equals(0))
                    {
                        moneyT += Convert.ToInt32(row["PC"]) * contain[0].SalePrice;
                    }
                    else
                    {
                        if (contain[0].SalePrice > Convert.ToDecimal(row["PRICE"]))
                        {
                            moneyT += Convert.ToInt32(row["PC"]) * contain[0].SalePrice;
                        }
                        else
                        {
                            moneyT += Convert.ToInt32(row["PC"]) * Convert.ToDecimal(row["PRICE"]);
                        }
                    }
                    entDest.Add(new CargoOrderGoodsEntity
                    {
                        OrderNo = ent.OrderNo,
                        ProductID = contain[0].ProductID,
                        HouseID = contain[0].HouseID,
                        AreaID = contain[0].AreaID,
                        Piece = Convert.ToInt32(row["PC"]),
                        ActSalePrice = contain[0].SalePrice > Convert.ToDecimal(row["PRICE"]) ? contain[0].SalePrice : Convert.ToDecimal(row["PRICE"]),
                        ContainerCode = contain[0].ContainerCode,
                        OutCargoID = outID,
                        OP_ID = QyUserInfo.UserID
                    });

                    #region 先进先出规则
                    //CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                    //{
                    //    HouseID = ent.HouseID,
                    //    //GoodsCode = itt.GoodsCode,
                    //    TypeID = contain[0].TypeID,
                    //    Model = contain[0].Model,
                    //    Specs = contain[0].Specs,
                    //    Figure = contain[0].Figure
                    //};
                    //List<CargoInterfaceEntity> stockList = interBus.queryCargoStock(queryEntity);
                    //if (stockList.Count <= 0)
                    //{
                    //    msg.Result = false;
                    //    msg.Message = "产品名称：" + queryEntity.ProductName + "，货品代码：" + queryEntity.GoodsCode + "库存为空";
                    //    goto ErrEND;
                    //}
                    //if (stockList.Sum(c => c.StockNum) < piece)
                    //{
                    //    msg.Result = false;
                    //    msg.Message = "产品名称：" + queryEntity.ProductName + "，货品代码：" + queryEntity.GoodsCode + "库存不足，库存只剩：" + stockList.Sum(c => c.StockNum).ToString();
                    //    goto ErrEND;
                    //}
                    ////减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                    //foreach (var it in stockList)
                    //{
                    //    CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                    //    cargo.OrderNo = ent.OrderNo;//订单号
                    //    cargo.OutCargoID = outID;
                    //    cargo.ContainerID = it.ContainerID;
                    //    cargo.TypeID = it.TypeID;
                    //    cargo.ProductID = it.ProductID;

                    //    cargo.ID = it.ContainerGoodsID;//库存表ID

                    //    //cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                    //    cargo.HouseName = houseName;
                    //    //cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                    //    cargo.ProductName = it.ProductName;
                    //    cargo.Model = it.Model;
                    //    cargo.Specs = it.Specs;
                    //    cargo.Figure = it.Figure;
                    //    #region 减库存逻辑
                    //    if (piece < it.StockNum)
                    //    {
                    //        //部分出
                    //        entDest.Add(new CargoOrderGoodsEntity
                    //        {
                    //            OrderNo = ent.OrderNo,
                    //            ProductID = it.ProductID,
                    //            HouseID = ent.HouseID,
                    //            AreaID = it.AreaID,
                    //            Piece = piece,
                    //            ActSalePrice = contain[0].SalePrice > Convert.ToDecimal(row["PRICE"]) ? contain[0].SalePrice : Convert.ToDecimal(row["PRICE"]),//contain[0].SalePrice,
                    //            ContainerCode = it.ContainerCode,
                    //            OutCargoID = outID,
                    //            OP_ID = QyUserInfo.UserID
                    //        });
                    //        cargo.Piece = piece;
                    //        cargo.InPiece = it.StockNum;

                    //        outHouseList.Add(cargo);
                    //        break;
                    //    }
                    //    if (piece.Equals(it.StockNum))
                    //    {
                    //        //要出库件数和第一条库存件数刚刚好，则就全部出
                    //        entDest.Add(new CargoOrderGoodsEntity
                    //        {
                    //            OrderNo = ent.OrderNo,
                    //            ProductID = it.ProductID,
                    //            HouseID = ent.HouseID,
                    //            AreaID = it.AreaID,
                    //            Piece = piece,
                    //            ActSalePrice = contain[0].SalePrice > Convert.ToDecimal(row["PRICE"]) ? contain[0].SalePrice : Convert.ToDecimal(row["PRICE"]),//contain[0].SalePrice,
                    //            ContainerCode = it.ContainerCode,
                    //            OutCargoID = outID,
                    //            OP_ID = QyUserInfo.UserID
                    //        });
                    //        cargo.Piece = piece;
                    //        cargo.InPiece = it.StockNum;

                    //        outHouseList.Add(cargo);
                    //        break;
                    //    }
                    //    if (piece > it.StockNum)
                    //    {
                    //        //全部出
                    //        entDest.Add(new CargoOrderGoodsEntity
                    //        {
                    //            OrderNo = ent.OrderNo,
                    //            ProductID = it.ProductID,
                    //            HouseID = ent.HouseID,
                    //            AreaID = it.AreaID,
                    //            Piece = it.StockNum,
                    //            ActSalePrice = contain[0].SalePrice > Convert.ToDecimal(row["PRICE"]) ? contain[0].SalePrice : Convert.ToDecimal(row["PRICE"]),//contain[0].SalePrice,
                    //            ContainerCode = it.ContainerCode,
                    //            OutCargoID = outID,
                    //            OP_ID = QyUserInfo.UserID
                    //        });
                    //        cargo.Piece = it.StockNum;
                    //        cargo.InPiece = it.StockNum;

                    //        outHouseList.Add(cargo);
                    //        piece = piece - it.StockNum;
                    //        continue;
                    //    }
                    //    #endregion
                    //} 
                    #endregion

                    CargoContainerShowEntity outcargo = new CargoContainerShowEntity();

                    outcargo.OutCargoID = outID;
                    outcargo.ContainerID = contain[0].ContainerID;
                    outcargo.TypeID = contain[0].TypeID;
                    outcargo.ProductID = contain[0].ProductID;
                    outcargo.Piece = Convert.ToInt32(row["PC"]);//出库件数
                    //outcargo.InPiece = Convert.ToInt32(row["InPiece"]);
                    outcargo.ID = contain[0].ID;

                    //outcargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                    outcargo.HouseName = contain[0].HouseName.Trim();
                    outcargo.AreaName = contain[0].AreaName.Trim();
                    outcargo.ProductName = contain[0].ProductName.Trim();
                    outcargo.Model = contain[0].Model.Trim();
                    outcargo.Specs = contain[0].Specs.Trim();
                    outcargo.Figure = contain[0].Figure.Trim();
                    outHouseList.Add(outcargo);

                    //仓库同步缓存
                    CargoProductEntity syncProduct = house.SyncTypeProduct(outcargo.ProductID.ToString());
                    //34 马牌  1 同步马牌  2 同步全部品牌
                    if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                    {
                        RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                    }


                }
                ent.Piece = pieceT;
                ent.TransportFee = moneyT;
                ent.TotalCharge = moneyT;
                ent.OrderType = "1";
                ent.goodsList = entDest;

                bus.AddOrderInfo(ent, log);
                house.saveOutCargoData(outHouseList, log);
                msg.Message = "成功";
                CargoOrderBus cargo = new CargoOrderBus();
                if (ent.HouseID.Equals(9) || ent.HouseID.Equals(15) || ent.HouseID.Equals(49) || ent.HouseID.Equals(50) || ent.HouseID.Equals(51) || ent.HouseID.Equals(52) || ent.HouseID.Equals(53) || ent.HouseID.Equals(54))
                {
                    //内部订单
                    cargo.SaveHlyOrderData(outHouseList, ent);
                }
                else
                {
                    cargo.InsertCargoOrderPush(new CargoOrderPushEntity
                    {
                        OrderNo = ent.OrderNo,
                        Dep = ent.Dep,
                        Dest = ent.Dest,
                        Piece = ent.Piece,
                        ClientNum = ent.ClientNum.ToString(),
                        AcceptAddress = ent.AcceptAddress,
                        AcceptCellphone = ent.AcceptCellphone,
                        AcceptTelephone = ent.AcceptTelephone,
                        AcceptPeople = ent.AcceptPeople,
                        AcceptUnit = ent.AcceptUnit,
                        HouseID = ent.HouseID.ToString(),
                        HouseName = ent.HouseName,
                        OP_ID = QyUserInfo.UserID,
                        PushType = "0",
                        PushStatus = "0",
                        LogisID = ent.LogisID
                    }, log);
                }
                QiyeBus qy = new QiyeBus();
                List<QyTagEntity> tag = qy.QueryTagList(new QyTagEntity { TagType = "0", HouseID = entDest[0].HouseID });//查询所有用于推送下单信息的标签ID
                string strTag = string.Empty;
                if (tag != null && tag.Count > 0)
                {
                    foreach (var it in tag)
                    {
                        strTag += it.Id.ToString() + "|";
                    }
                    strTag = strTag.Substring(0, strTag.Length - 1);
                }
                string currDate = DateTime.Now.Year.ToString() + "年" + DateTime.Now.Month.ToString() + "月" + DateTime.Now.Day.ToString() + "日";
                QySendInfoEntity send = new QySendInfoEntity();
                send.title = "下单通知";
                send.msgType = msgType.textcard;
                send.toTag = strTag;
                send.content = "<div>" + currDate + "</div><div></div><div>客户：" + ent.AcceptPeople + " 购买" + ent.Piece.ToString() + "条轮胎，金额：" + ent.TotalCharge.ToString() + "元</div><div>电话：" + ent.AcceptCellphone + "</div><div>地址：" + ent.AcceptAddress + "</div><div>业务员：" + ent.SaleManName + "</div><div></div><div class=\"highlight\">请尽快拣货出库发货！</div>";
                send.url = "dlt.neway5.com";
                WxQYSendHelper.PushInfo("0", "0", send);
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message; msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }
        /// <summary>
        /// 查询当天的订单
        /// </summary>
        public void QueryCurDayOrder()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["status"])))
            {
                queryEntity.AwbStatus = Convert.ToString(Request["status"]);
            }
            queryEntity.CargoPermisID = QyUserInfo.CargoPermisID;//用户所属仓库权限ID
            ErrMessage msg = new ErrMessage();
            msg.Message = "";
            msg.Result = true;
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryOrderInfo(pageIndex, pageSize, queryEntity);
            List<CargoOrderEntity> result = list["rows"] as List<CargoOrderEntity>;
            String json = JSON.Encode(result);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 修改订单的状态
        /// </summary>
        public void UpdateOrderStatus()
        {
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "企业号订单跟踪";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";

            CargoOrderStatusEntity queryEntity = new CargoOrderStatusEntity();
            queryEntity.OrderID = Convert.ToInt64(Request["OrderID"]);

            CargoOrderBus bus = new CargoOrderBus();
            CargoOrderEntity order = bus.QueryOrderInfoByOrderID(queryEntity.OrderID);

            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            if (string.IsNullOrEmpty(order.OrderNo))
            {
                msg.Message = "订单号为空，系统错误！";
                msg.Result = false;
            }
            if (order.AwbStatus.Equals("5"))//已签收不允许再修改状态
            {
                msg.Message = "订单已签收！";
                msg.Result = false;
            }
            try
            {
                if (msg.Result)
                {
                    queryEntity.OrderNo = order.OrderNo;
                    queryEntity.DetailInfo = "";
                    queryEntity.OrderStatus = Convert.ToString(Request["status"]);
                    queryEntity.OP_ID = QyUserInfo.UserID;
                    queryEntity.OP_Name = QyUserInfo.WxName;
                    queryEntity.OP_DATE = DateTime.Now;
                    bus.SaveOrderStatus(queryEntity, log);
                    if (queryEntity.OrderStatus.Equals("3"))
                    {
                        //微信企业号推送订单为物流运输中
                        string currDate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                        QySendInfoEntity send = new QySendInfoEntity();
                        send.title = "物流运输中";
                        send.msgType = msgType.textcard;
                        send.toUser = order.SaleManID;
                        send.content = "<div>" + currDate + "</div><div></div><div>订单号：" + order.OrderNo + "</div><div>到达站：" + order.Dest + "</div><div>开单件数：" + order.Piece.ToString() + " 件 --- 金额：" + order.TotalCharge.ToString() + "元</div><div>收货人：" + order.AcceptPeople + "</div><div>手机号码：" + order.AcceptCellphone + "</div><div>收货地址：" + order.AcceptAddress + "</div>";
                        send.url = "dlt.neway5.com";
                        WxQYSendHelper.PushInfo("0", "0", send);
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }
        /// <summary>
        /// 查询所有的城市数据
        /// </summary>
        public void QueryAllCity()
        {
            CargoStaticBus bus = new CargoStaticBus();
            List<CargoCityManagerEntity> list = bus.QueryAllCity(new CargoCityManagerEntity { });
            string json = "[";
            foreach (var it in list)
            {
                json += "{\"value\":\"" + it.CityName.Trim() + "\",\"text\":\"" + it.CityName.Trim() + "\"},";

            }
            json = json.Substring(0, json.Length - 1);
            json += "]";
            String jsons = JSON.Encode(json);
            Response.Clear();
            Response.Write(jsons);
        }
        /// <summary>
        /// 查询所有的物流公司数据
        /// </summary> 
        public void QueryAllLogistic()
        {
            CargoLogisticEntity entity = new CargoLogisticEntity();
            CargoStaticBus bus = new CargoStaticBus();
            List<CargoLogisticEntity> list = bus.QueryAllLogistic(entity);
            string json = "[";
            foreach (var it in list)
            {
                json += "{\"value\":\"" + it.ID.ToString() + "\",\"text\":\"" + it.LogisticName.Trim() + "\"},";

            }
            json = json.Substring(0, json.Length - 1);
            json += "]";
            String jsons = JSON.Encode(json);
            Response.Clear();
            Response.Write(jsons);
        }
        /// <summary>
        /// 添加客户信息
        /// </summary>
        public void qyAddClient()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "客户管理";
            log.NvgPage = "企业号客户管理";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            CargoClientEntity ent = new CargoClientEntity();
            foreach (Hashtable row in rows)
            {
                ent.ClientName = ent.ClientShortName = Convert.ToString(row["ClientName"]);
                ent.Boss = Convert.ToString(row["Boss"]);
                ent.Cellphone = Convert.ToString(row["Cellphone"]);
                ent.Telephone = Convert.ToString(row["Telephone"]);
                ent.Address = Convert.ToString(row["Address"]);
                ent.UserID = QyUserInfo.UserID;
                ent.HouseID = QyUserInfo.HouseID;
            }
            String id = Request["ClientID"] != null ? Request["ClientID"].ToString() : "";
            CargoClientBus bus = new CargoClientBus();
            if (msg.Result)
            {
                try
                {
                    if (id == "0")
                    {
                        if (bus.IsExistCargoClient(new CargoClientEntity { Boss = ent.Boss, Cellphone = ent.Cellphone, HouseID = ent.HouseID }))
                        {
                            msg.Result = false;
                            msg.Message = "已经存在相同的手机号码";
                        }
                        if (bus.IsExistCargoClient(new CargoClientEntity { Boss = ent.Boss, HouseID = ent.HouseID }))
                        {
                            msg.Result = false;
                            msg.Message = "已经存在相同的客户姓名";
                        }
                        log.Operate = "A";
                        ent.ClientType = "0";
                        ent.ClientNum = Common.GetClientNum();//生成随机的六位数字做为客户编码
                        bus.AddCargoClient(ent, log);
                        msg.Result = true;
                        msg.Message = "成功";
                    }
                    else
                    {
                        ent.ClientID = Convert.ToInt64(id);
                        CargoClientEntity clientEntity = bus.QueryCargoClient(ent.ClientID);
                        clientEntity.ClientName = clientEntity.ClientShortName = ent.ClientName;
                        clientEntity.Boss = ent.Boss;
                        clientEntity.Cellphone = ent.Cellphone;
                        clientEntity.Telephone = ent.Telephone;
                        clientEntity.Address = ent.Address;
                        clientEntity.UserID = ent.UserID;
                        clientEntity.HouseID = ent.HouseID;
                        log.Operate = "U";
                        bus.UpdateCargoClient(clientEntity, log);
                        msg.Result = true;
                        msg.Message = "成功";

                    }
                }
                catch (ApplicationException ex)
                {
                    msg.Message = ex.Message;
                    msg.Result = false;
                }
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 修改订单状态
        /// </summary>
        public void SetOrderStatus()
        {
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "企业号订单跟踪";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";

            CargoOrderStatusEntity queryEntity = new CargoOrderStatusEntity();
            queryEntity.OrderID = Convert.ToInt64(Request["data"]);
            //queryEntity.OrderStatus = Convert.ToString(Request["AwbStatus"]);

            CargoOrderBus bus = new CargoOrderBus();
            CargoOrderEntity order = bus.QueryOrderInfoByOrderID(queryEntity.OrderID);

            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            if (string.IsNullOrEmpty(order.OrderNo))
            {
                msg.Message = "订单号为空，系统错误！";
                msg.Result = false;
                goto ERRORRR;
            }
            if (Convert.ToString(Request["AwbStatus"]).Equals("8") && order.AwbStatus.Equals("0"))
            {
                msg.Message = "订单还未出库！";
                msg.Result = false;
                goto ERRORRR;
            }
            if (Convert.ToString(Request["AwbStatus"]).Equals("3") && order.AwbStatus.Equals("0"))
            {
                msg.Message = "订单还未出库！";
                msg.Result = false;
                goto ERRORRR;
            }
            if (order.AwbStatus.Equals("5"))//已签收不允许再修改状态
            {
                msg.Message = "订单已签收！";
                msg.Result = false;
                goto ERRORRR;
            }
            if (msg.Result)
            {
                queryEntity.OrderNo = order.OrderNo;
                queryEntity.WXOrderNo = order.WXOrderNo;
                queryEntity.DetailInfo = "";
                queryEntity.OrderStatus = Convert.ToString(Request["AwbStatus"]);
                queryEntity.Signer = QyUserInfo.WxName;
                queryEntity.OP_ID = QyUserInfo.UserID;
                queryEntity.OP_Name = QyUserInfo.WxName;
                queryEntity.OP_DATE = DateTime.Now;
                bus.SaveOrderStatus(queryEntity, log);
            }
        ERRORRR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 查询该 业务员下面的客户的所有订单状态 
        /// </summary>
        public void QueryMyClientOrder()
        {
            string peo = Convert.ToString(Request["key"]);
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();

            CargoOrderEntity ent = new CargoOrderEntity();
            ent.SaleManID = QyUserInfo.UserID;
            ent.AcceptPeople = peo;
            ent.StartDate = DateTime.Now.AddDays(-DateTime.Now.Day);
            ent.EndDate = DateTime.Now;
            if (string.IsNullOrEmpty(peo))
            {
                ent.StartDate = DateTime.Now.AddDays(-7);
                ent.EndDate = DateTime.Now;
            }
            result = bus.queryWxUserOrderInfo(ent);
            //返回处理结果
            string res = JSON.Encode(result);
            Response.Write(res);
        }
        /// <summary>
        /// 注册微信 
        /// </summary>
        public void configJssdk()
        {
            string secret = "g7apCaeXq8TsVsQ5rD05_9MMIju2DaI6dcSR5_jTctc";
            string titck = JsApiTicketContainer.TryGetTicket(Common.GetQYCorpID(), secret);
            string Url = Request["Url"].ToString();
            string appId = Common.GetQYCorpID();//System.Configuration.ConfigurationManager.AppSettings["CorpID"];
            string appSecret = secret;// System.Configuration.ConfigurationManager.AppSettings["EncodingAESKey"];
            bool debug = true;
            JSSDK sdk = new JSSDK(appId, appSecret, debug);
            SignPackage config = sdk.GetSignPackage(Url, JsApiEnum.scanQRCode);
            Dictionary<string, object> result = new Dictionary<string, object>();
            //appId = config.appId;
            result.Add("appId", config.appId);
            result.Add("timestamp", config.timestamp);
            result.Add("nonceStr", config.nonceStr);
            result.Add("signature", JSSDKHelper.GetSignature(titck, config.nonceStr, config.timestamp, Url));

            Response.ContentType = "text/plain";
            string resultString = Newtonsoft.Json.JsonConvert.SerializeObject(result);
            Common.WriteTextLog(resultString);
            Response.Write(resultString);
        }
        /// <summary>
        /// 保存上传的提货照片
        /// </summary>
        public void AddOrderDelivery()
        {
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "企业微信";
            log.NvgPage = "提货照片";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            if (string.IsNullOrEmpty(Convert.ToString(Request["OrderNo"])))
            {
                msg.Message = "订单号为空，系统错误！";
                msg.Result = false;
                goto ERRORERR;
            }
            string SignImagStr = string.Empty;

            CargoOrderStatusEntity entity = new CargoOrderStatusEntity();
            entity.OrderNo = Convert.ToString(Request["OrderNo"]);
            entity.OrderID = Convert.ToInt64(Request["OrderID"]);
            entity.OrderStatus = "10";//上传提货照片
            entity.OP_ID = QyUserInfo.UserID;
            entity.OP_Name = QyUserInfo.UserName;
            entity.OP_DATE = DateTime.Now;

            entity.DeliveryDriverName = Convert.ToString(Request["DeliveryDriverName"]);
            entity.DriverCellphone = Convert.ToString(Request["DriverCellphone"]);
            entity.DriverCarNum = Convert.ToString(Request["DriverCarNum"]);
            entity.DriverIDNum = Convert.ToString(Request["DriverIDNum"]);
            CargoOrderBus bus = new CargoOrderBus();

            string MediaID = Convert.ToString(Request["MediaID"]);
            if (!string.IsNullOrEmpty(MediaID))
            {
                string[] mID = MediaID.Split(',');
                foreach (var it in mID)
                {
                    if (!string.IsNullOrEmpty(it))
                    {
                        //从微信服务器下载照片并保存，同时把图片上传至远程服务器(好来运签收图片服务器)
                        string imgName = string.Empty;
                        string imgPath = "../upload/SignImage/";
                        string AgentSecret = "g7apCaeXq8TsVsQ5rD05_9MMIju2DaI6dcSR5_jTctc";//仓库管理的Secret
                        WxQYSendHelper.SaveWxPictureOilCard(it, ref imgName, ref imgPath, AgentSecret);
                        SignImagStr += "http://dlt.neway5.com/upload/SignImage/" + imgName + "|";
                    }
                }
            }
            entity.SignImage = SignImagStr;
            bus.SaveOrderDeliveryInfo(entity);

        ERRORERR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }
        /// <summary>
        /// 保存上传的签收照片
        /// </summary>
        public void AddOrderSign()
        {
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "企业微信";
            log.NvgPage = "企业微信签收";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            if (string.IsNullOrEmpty(Convert.ToString(Request["OrderNo"])))
            {
                msg.Message = "订单号为空，系统错误！";
                msg.Result = false;
                goto ERRORERR;
            }
            string SignImagStr = string.Empty;
            CargoOrderStatusEntity entity = new CargoOrderStatusEntity();
            entity.OrderNo = Convert.ToString(Request["OrderNo"]);
            entity.OrderID = Convert.ToInt64(Request["OrderID"]);
            entity.OrderStatus = "5";
            entity.OP_ID = QyUserInfo.UserID;
            entity.OP_Name = QyUserInfo.UserName;
            entity.OP_DATE = DateTime.Now;
            entity.AbSignStatus = "0";

            //entity.Latitude = Convert.ToString(Request["Lat"]);
            //entity.Longitude = Convert.ToString(Request["Lon"]);
            CargoOrderBus bus = new CargoOrderBus();
            CargoOrderEntity order = bus.QueryOrderInfoByOrderID(entity.OrderID);
            if (order.AwbStatus.Equals("5"))//已签收不允许再修改状态
            {
                msg.Message = "订单已签收！";
                msg.Result = false;
                goto ERRORERR;
            }
            //财务签收人员，从缓存中取
            string FinaSignPerson = Convert.ToString(RedisHelper.GetString("FinaSignPerson"));
            if (FinaSignPerson.Contains(QyUserInfo.UserID))
            {
                entity.AbSignStatus = "1";
            }
            else
            {
                if (!order.OutCargoTime.ToString("yyyy-MM-dd").Equals("0001-01-01"))
                {
                    //说明已经出库了，有出库时间
                    TimeSpan ts = DateTime.Now - order.OutCargoTime;
                    if (ts.Days > 5)
                    {
                        msg.Message = "离出库日期已超过5天，请联系财务人员签收！";
                        msg.Result = false;
                        goto ERRORERR;
                    }
                }
            }
            entity.Signer = QyUserInfo.UserName;
            entity.SignTime = DateTime.Now;
            string MediaID = Convert.ToString(Request["MediaID"]);
            if (!string.IsNullOrEmpty(MediaID))
            {
                string[] mID = MediaID.Split(',');
                foreach (var it in mID)
                {
                    if (!string.IsNullOrEmpty(it))
                    {
                        //从微信服务器下载照片并保存，同时把图片上传至远程服务器(好来运签收图片服务器)
                        string imgName = string.Empty;
                        string imgPath = "../upload/SignImage/";
                        string AgentSecret = "g7apCaeXq8TsVsQ5rD05_9MMIju2DaI6dcSR5_jTctc";//仓库管理的Secret
                        WxQYSendHelper.SaveWxPictureOilCard(it, ref imgName, ref imgPath, AgentSecret);
                        SignImagStr += "http://dlt.neway5.com/upload/SignImage/" + imgName + "|";
                    }
                }
            }
            entity.SignImage = SignImagStr;
            if (msg.Result)
            {
                bus.SaveOrderStatus(entity, log);
            }
            try
            {
                if (!string.IsNullOrEmpty(order.OpenOrderNo) && !order.OrignHouseID.Equals(0))
                {
                    CargoOrderStatusEntity openentity = new CargoOrderStatusEntity();
                    openentity.OrderNo = order.OpenOrderNo;
                    openentity.OrderStatus = "5";
                    openentity.OP_ID = QyUserInfo.UserID;
                    openentity.OP_Name = QyUserInfo.UserName;
                    openentity.OP_DATE = DateTime.Now;
                    openentity.AbSignStatus = "0";
                    openentity.Signer = QyUserInfo.UserName;
                    openentity.SignTime = DateTime.Now;
                    openentity.SignImage = SignImagStr;
                    bus.SaveOrderStatus(openentity, log);

                }
            }
            catch (ApplicationException ex)
            {

            }
        ERRORERR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }
        /// <summary>
        /// 查询微信 商城 未确认的订单
        /// </summary>
        public void QueryWeixinOrderInfo()
        {
            string peo = Convert.ToString(Request["key"]);//客户姓名
            WXOrderEntity queryEntity = new WXOrderEntity();
            queryEntity.PayStatus = "0";//未付款
            queryEntity.OrderStatus = "0";//未确认
            queryEntity.HouseID = QyUserInfo.HouseID;

            //ent.SaleManID = QyUserInfo.UserID;
            queryEntity.SaleManID = QyUserInfo.UserID;
            queryEntity.Name = peo;
            queryEntity.StartDate = DateTime.Now.AddDays(-DateTime.Now.Day);
            queryEntity.EndDate = DateTime.Now;
            if (string.IsNullOrEmpty(peo))
            {
                queryEntity.StartDate = DateTime.Now.AddDays(-7);
                queryEntity.EndDate = DateTime.Now;
            }
            CargoOrderBus bus = new CargoOrderBus();
            List<WXOrderEntity> list = bus.QueryWeixinOrder(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 提交修改单价申请
        /// </summary>
        public void SaveModify()
        {
            String json = Request["data"];
            string Reason = Convert.ToString(Request["Reason"]);
            string OrderNo = Convert.ToString(Request["OrderNo"]);
            string Name = Convert.ToString(Request["Name"]);//收货人姓名 
            string Cellphone = Convert.ToString(Request["Cellphone"]);
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            QyOrderUpdatePriceEntity result = new QyOrderUpdatePriceEntity();
            List<QyOrderUpdateGoodsEntity> goods = new List<QyOrderUpdateGoodsEntity>();
            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            result.HouseID = QyUserInfo.HouseID;
            result.ApplyID = QyUserInfo.UserID;
            result.ApplyName = QyUserInfo.UserName;
            result.SaleManID = QyUserInfo.UserID;
            result.SaleManName = QyUserInfo.UserName;
            result.ApplyDate = DateTime.Now;
            result.OrderNo = OrderNo;
            result.ApplyStatus = "0";
            result.OrderType = "0";
            result.Reason = Reason;
            foreach (Hashtable row in rows)
            {
                //如果价格小于0直接过，异常数据
                if (Convert.ToDecimal(row["PRICE"]) <= 0) { continue; }
                QyOrderUpdateGoodsEntity res = new QyOrderUpdateGoodsEntity();
                res.OrderID = Convert.ToInt64(row["OID"]);//商城订单ID
                res.ShelvesID = Convert.ToInt64(row["SID"]);//商城上架表ID
                res.ModifyPrice = Convert.ToDecimal(row["PRICE"]);//修改后价格
                res.OrderNum = Convert.ToInt32(row["Num"]);//订单数量
                res.OrderPrice = Convert.ToDecimal(row["OldPrice"]);//原价格
                goods.Add(res);
            }
            result.UpdatePriceGoodsList = goods;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "我的客户订单";
            log.NvgPage = "修改价格申请";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "A";
            try
            {
                CargoFinanceBus f = new CargoFinanceBus();
                QiyeBus q = new QiyeBus();
                List<QyUserEntity> qyUser = new List<QyUserEntity>();
                QySendInfoEntity send = new QySendInfoEntity();
                CargoOrderBus o = new CargoOrderBus();
                //CargoApproveSetEntity AppSet = f.QueryApproveSetByID(33);
                CargoApproveSetEntity AppSet = new CargoApproveSetEntity();
                List<CargoApproveSetEntity> aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = "3", DelFlag = "0", HouseID = QyUserInfo.HouseID });
                if (aset.Count > 0) { AppSet = aset[0]; }
                result.CheckID = AppSet.OneCheckID;
                result.CheckName = AppSet.OneCheckName;
                if (AppSet.OneCheckID.Equals("3"))
                {
                    //先判断审批流程第一步是不是分公司领导
                    List<SystemUserEntity> Bosslist = o.QueryUserBossLoginName(new SystemUserEntity { LoginName = QyUserInfo.UserID });
                    if (Bosslist.Count > 0)
                    {
                        if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                        {
                            qyUser.Add(new QyUserEntity { UserID = Bosslist[0].LoginName });
                        }
                        else
                        {
                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID });
                            result.CheckID = AppSet.TwoCheckID;
                            result.CheckName = AppSet.TwoCheckName;
                        }
                    }
                }
                else
                {
                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.OneCheckID });
                }

                long OID = q.AddOrderUpdatePrice(result, log);
                //推送通知给审批人  单价修改审批的标签
                //List<QyTagEntity> tag = bus.QueryTagList(new QyTagEntity { TagType = "2", HouseID = QyUserInfo.HouseID });//查询所有用于推送下单信息的标签ID
                //string strTag = string.Empty;
                //if (tag != null && tag.Count > 0)
                //{
                //    foreach (var it in tag)
                //    {
                //        strTag += it.Id.ToString() + "|";
                //    }
                //    strTag = strTag.Substring(0, strTag.Length - 1);
                //}

                send.title = "订单改价申请";
                send.msgType = msgType.textcard;
                //send.toTag = strTag;
                send.content = "<div></div><div>订单号：" + OrderNo + "</div><div>收货人：" + Name + "  " + Cellphone + "</div><div>申请人：" + result.ApplyName + "</div><div>申请时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>申请原因：" + result.Reason + "</div><div>订单类型：商城订单</div><div></div><div class=\"highlight\">请点击本通知进行审批！</div>";
                send.url = "http://dlt.neway5.com/QY/qyApproveCheck.aspx?OrderNo=" + OrderNo + "&OID=" + OID + "&OrderType=0";
                foreach (var it in qyUser)
                {
                    send.toUser = it.UserID;
                    WxQYSendHelper.PushInfo("0", "2", send);
                }
            }
            catch (ApplicationException ex)
            {
                msg.Result = true;
            }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 通过审批
        /// </summary>
        public void checkOk()
        {
            string Reason = Convert.ToString(Request["Reason"]);
            string OrderNo = Convert.ToString(Request["OrderNo"]);//订单号，商城订单号和电脑端订单号
            long OID = Convert.ToInt64(Request["OID"]);//修改表主键ID
            string Name = Convert.ToString(Request["Name"]);//收货人姓名 
            string Cellphone = Convert.ToString(Request["Cellphone"]);
            string OrderType = Convert.ToString(Request["OrderType"]);//订单类型0：商城订单1：电脑订单
            QyOrderUpdatePriceEntity result = new QyOrderUpdatePriceEntity();
            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            result.HouseID = QyUserInfo.HouseID;
            result.CheckID = QyUserInfo.UserID;
            result.CheckName = QyUserInfo.UserName;
            result.CheckTime = DateTime.Now;
            result.OrderNo = OrderNo;
            result.CheckResult = Reason;
            result.OID = OID;
            List<CargoExpenseApproveRoutEntity> approveRouteList = new List<CargoExpenseApproveRoutEntity>();
            CargoExpenseApproveRoutEntity approveRoute = new CargoExpenseApproveRoutEntity();
            approveRoute.ExID = OID;
            approveRoute.UserID = QyUserInfo.UserID;
            approveRoute.UserName = QyUserInfo.UserName;
            approveRoute.ApproveType = "1";
            approveRoute.Result = Reason;
            approveRoute.Opera = "0";
            approveRouteList.Add(approveRoute);
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "报销审批";
            log.NvgPage = "修改价格审批";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";
            QiyeBus q = new QiyeBus();
            QyOrderUpdatePriceEntity qup = q.QueryOrderUpdatePriceEntity(result);
            if (qup.ApplyStatus.Equals("3"))
            {
                msg.Result = false;
                msg.Message = "该订单已审批结束，请勿重复审批";
            }
            if (!QyUserInfo.CheckRole.Contains(qup.CheckID))
            {
                msg.Result = false;
                msg.Message = "流程未到您审批";
            }
            bool IsEnd = false;
            if (msg.Result)
            {
                string copy = string.Empty;
                //1.查询审批设置表获得审批流程
                CargoFinanceBus f = new CargoFinanceBus();
                List<QyUserEntity> qyUser = new List<QyUserEntity>();
                QySendInfoEntity send = new QySendInfoEntity();
                CargoOrderBus o = new CargoOrderBus();
                CargoApproveSetEntity AppSet = new CargoApproveSetEntity();
                string ApproveType = "3";
                switch (qup.OrderCheckType)
                {
                    case "2": ApproveType = "9"; break;
                    case "3": ApproveType = "10"; break;
                    case "4": ApproveType = "11"; break;
                    case "5": ApproveType = "12"; break;
                    case "6": ApproveType = "13"; break;
                    case "18": ApproveType = "18"; break;
                    case "19": ApproveType = "19"; break;
                    default: ApproveType = "3"; break;
                }
                List<CargoApproveSetEntity> aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = ApproveType, DelFlag = "0", HouseID = qup.HouseID });
                if (aset.Count > 0) { AppSet = aset[0]; }
                else
                {
                    aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = "3", DelFlag = "0", HouseID = qup.HouseID });
                    if (aset.Count > 0) { AppSet = aset[0]; }
                }
                AppSet.EnSafe();
                //2.审批流程的每一级和当前人的审批角色相匹配
                if (AppSet.OneCheckID.Equals(qup.CheckID))
                {
                    #region 第一级
                    send.title = AppSet.OneCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.CheckID = AppSet.TwoCheckID;
                    result.CheckName = AppSet.TwoCheckName;
                    if (string.IsNullOrEmpty(AppSet.TwoCheckID))
                    {
                        send.title = "订单改价申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.ApplyStatus = "3";
                        result.CheckID = "";// AppSet.OneCheckID;
                        result.CheckName = "";// AppSet.OneCheckName;
                        approveRoute.Opera = "2";
                        //approveRoute.Opera = "0";
                        //approveRouteList.Add(approveRoute);
                    }
                    else
                    {
                        //判断下一级是不是分公司领导，如果是则查询申请人的上级领导
                        if (AppSet.TwoCheckID.Equals("3"))
                        {
                            List<SystemUserEntity> Bosslist = o.QueryUserBossLoginName(new SystemUserEntity { LoginName = qup.ApplyID });
                            if (Bosslist.Count > 0)
                            {
                                if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                {
                                    qyUser.Add(new QyUserEntity { UserID = Bosslist[0].LoginName, WxName = Bosslist[0].UserName });
                                }
                                else
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.ThreeCheckID, CheckHouseID = qup.HouseID.ToString() });
                                }
                            }
                        }
                        else
                        {
                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID, CheckHouseID = qup.HouseID.ToString() });
                        }
                        if (!string.IsNullOrEmpty(AppSet.AutoPassID))
                        {
                            bool IsAuto = false;
                            //20221218 增加处理自动审批功能
                            if (AppSet.AutoPassID.Contains(AppSet.TwoCheckID))
                            {
                                IsAuto = true;
                                //说明第二级自动过
                                result.CheckID = AppSet.ThreeCheckID;
                                result.CheckName = AppSet.ThreeCheckName;
                                CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                                approveTwoRoute.ExID = OID;
                                approveTwoRoute.UserID = qyUser[0].UserID;
                                approveTwoRoute.UserName = qyUser[0].WxName;
                                approveTwoRoute.ApproveType = "1";
                                approveTwoRoute.Result = "自动跳过审批";
                                approveTwoRoute.Opera = "0";
                                approveRouteList.Add(approveTwoRoute);
                                //下一级为空表示审批结束
                                if (string.IsNullOrEmpty(AppSet.ThreeCheckID))
                                {
                                    IsAuto = false;
                                    send.title = "订单改价申请审批结束";
                                    //表示是最后一级
                                    IsEnd = true;
                                    result.ApplyStatus = "3";
                                    result.CheckID = "";// AppSet.OneCheckID;
                                    result.CheckName = "";// AppSet.OneCheckName;
                                    approveRoute.Opera = "2";
                                    //approveRoute.Opera = "0";
                                    approveRouteList.Add(approveRoute);
                                }
                                else
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.ThreeCheckID, CheckHouseID = qup.HouseID.ToString() });
                                }
                            }
                            if (AppSet.AutoPassID.Contains(AppSet.ThreeCheckID) && !string.IsNullOrEmpty(AppSet.ThreeCheckID) && IsAuto)
                            {
                                //说明第三级自动过
                                result.CheckID = AppSet.FourCheckID;
                                result.CheckName = AppSet.FourCheckName;
                                CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                                approveTwoRoute.ExID = OID;
                                approveTwoRoute.UserID = qyUser[0].UserID;
                                approveTwoRoute.UserName = qyUser[0].WxName;
                                approveTwoRoute.ApproveType = "1";
                                approveTwoRoute.Result = "自动跳过审批";
                                approveTwoRoute.Opera = "0";
                                approveRouteList.Add(approveTwoRoute);
                                //下一级为空表示审批结束
                                if (string.IsNullOrEmpty(AppSet.FourCheckID))
                                {
                                    IsAuto = false;
                                    send.title = "订单改价申请审批结束";
                                    //表示是最后一级
                                    IsEnd = true;
                                    result.ApplyStatus = "3";
                                    result.CheckID = "";// AppSet.OneCheckID;
                                    result.CheckName = "";// AppSet.OneCheckName;
                                    approveRoute.Opera = "2";
                                    //approveRoute.Opera = "0";
                                    approveRouteList.Add(approveRoute);
                                }
                                else
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FourCheckID, CheckHouseID = qup.HouseID.ToString() });
                                }
                            }
                            if (AppSet.AutoPassID.Contains(AppSet.FourCheckID) && !string.IsNullOrEmpty(AppSet.FourCheckID) && IsAuto)
                            {
                                //说明第三级自动过
                                result.CheckID = AppSet.FiveCheckID;
                                result.CheckName = AppSet.FiveCheckName;
                                CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                                approveTwoRoute.ExID = OID;
                                approveTwoRoute.UserID = qyUser[0].UserID;
                                approveTwoRoute.UserName = qyUser[0].WxName;
                                approveTwoRoute.ApproveType = "1";
                                approveTwoRoute.Result = "自动跳过审批";
                                approveTwoRoute.Opera = "0";
                                approveRouteList.Add(approveTwoRoute);
                                //下一级为空表示审批结束
                                if (string.IsNullOrEmpty(AppSet.FiveCheckID))
                                {
                                    IsAuto = false;
                                    send.title = "订单改价申请审批结束";
                                    //表示是最后一级
                                    IsEnd = true;
                                    result.ApplyStatus = "3";
                                    result.CheckID = "";// AppSet.OneCheckID;
                                    result.CheckName = "";// AppSet.OneCheckName;
                                    approveRoute.Opera = "2";
                                    //approveRoute.Opera = "0";
                                    approveRouteList.Add(approveRoute);
                                }
                                else
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FiveCheckID, CheckHouseID = qup.HouseID.ToString() });
                                }
                            }
                            if (AppSet.AutoPassID.Contains(AppSet.FiveCheckID) && !string.IsNullOrEmpty(AppSet.FiveCheckID) && IsAuto)
                            {
                                //说明第三级自动过
                                result.CheckID = AppSet.SixCheckID;
                                result.CheckName = AppSet.SixCheckName;
                                CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                                approveTwoRoute.ExID = OID;
                                approveTwoRoute.UserID = qyUser[0].UserID;
                                approveTwoRoute.UserName = qyUser[0].WxName;
                                approveTwoRoute.ApproveType = "1";
                                approveTwoRoute.Result = "自动跳过审批";
                                approveTwoRoute.Opera = "0";
                                approveRouteList.Add(approveTwoRoute);
                                //下一级为空表示审批结束
                                if (string.IsNullOrEmpty(AppSet.SixCheckID))
                                {
                                    IsAuto = false;
                                    send.title = "订单改价申请审批结束";
                                    //表示是最后一级
                                    IsEnd = true;
                                    result.ApplyStatus = "3";
                                    result.CheckID = "";// AppSet.OneCheckID;
                                    result.CheckName = "";// AppSet.OneCheckName;
                                    approveRoute.Opera = "2";
                                    //approveRoute.Opera = "0";
                                    approveRouteList.Add(approveRoute);
                                }
                                else
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SixCheckID, CheckHouseID = qup.HouseID.ToString() });
                                }
                            }
                        }
                    }
                    #endregion
                }
                else if (AppSet.TwoCheckID.Equals(qup.CheckID))
                {
                    #region 第二级
                    send.title = AppSet.TwoCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.CheckID = AppSet.ThreeCheckID;
                    result.CheckName = AppSet.ThreeCheckName;
                    if (string.IsNullOrEmpty(AppSet.ThreeCheckID))
                    {
                        send.title = "订单改价申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.ApplyStatus = "3";
                        result.CheckID = "";//AppSet.TwoCheckID;
                        result.CheckName = "";// AppSet.TwoCheckName;
                        approveRoute.Opera = "2";
                        //approveRouteList.Add(approveRoute);
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.ThreeCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    if (!string.IsNullOrEmpty(AppSet.AutoPassID))
                    {
                        bool IsAuto = false;
                        if (!string.IsNullOrEmpty(AppSet.ThreeCheckID) && AppSet.AutoPassID.Contains(AppSet.ThreeCheckID))
                        {
                            IsAuto = true;
                            //说明第三级自动过
                            result.CheckID = AppSet.FourCheckID;
                            result.CheckName = AppSet.FourCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.FourCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FourCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                        if (!string.IsNullOrEmpty(AppSet.FourCheckID) && AppSet.AutoPassID.Contains(AppSet.FourCheckID) && IsAuto)
                        {
                            //说明第三级自动过
                            result.CheckID = AppSet.FiveCheckID;
                            result.CheckName = AppSet.FiveCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.FiveCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FiveCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                        if (!string.IsNullOrEmpty(AppSet.FiveCheckID) && AppSet.AutoPassID.Contains(AppSet.FiveCheckID) && IsAuto)
                        {
                            //说明第三级自动过
                            result.CheckID = AppSet.SixCheckID;
                            result.CheckName = AppSet.SixCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.SixCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SixCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                    }
                    #endregion
                }
                else if (AppSet.ThreeCheckID.Equals(qup.CheckID))
                {
                    #region 第三级
                    send.title = AppSet.ThreeCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.CheckID = AppSet.FourCheckID;
                    result.CheckName = AppSet.FourCheckName;
                    if (string.IsNullOrEmpty(AppSet.FourCheckID))
                    {
                        send.title = "订单改价申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.ApplyStatus = "3";
                        result.CheckID = "";//AppSet.ThreeCheckID;
                        result.CheckName = "";// AppSet.ThreeCheckName;
                        approveRoute.Opera = "2";
                        //approveRouteList.Add(approveRoute);
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FourCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    if (!string.IsNullOrEmpty(AppSet.AutoPassID))
                    {
                        bool IsAuto = false;
                        if (!string.IsNullOrEmpty(AppSet.FourCheckID) && AppSet.AutoPassID.Contains(AppSet.FourCheckID))
                        {
                            IsAuto = true;
                            //说明第三级自动过
                            result.CheckID = AppSet.FiveCheckID;
                            result.CheckName = AppSet.FiveCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.FiveCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FiveCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                        if (!string.IsNullOrEmpty(AppSet.FiveCheckID) && AppSet.AutoPassID.Contains(AppSet.FiveCheckID) && IsAuto)
                        {
                            //说明第三级自动过
                            result.CheckID = AppSet.SixCheckID;
                            result.CheckName = AppSet.SixCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.SixCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SixCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                        if (!string.IsNullOrEmpty(AppSet.SixCheckID) && AppSet.AutoPassID.Contains(AppSet.SixCheckID) && IsAuto)
                        {
                            //说明第三级自动过
                            result.CheckID = AppSet.SevenCheckID;
                            result.CheckName = AppSet.SevenCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.SevenCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SevenCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                    }
                    #endregion
                }
                else if (AppSet.FourCheckID.Equals(qup.CheckID))
                {
                    #region 第四级
                    send.title = AppSet.FourCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.CheckID = AppSet.FiveCheckID;
                    result.CheckName = AppSet.FiveCheckName;
                    if (string.IsNullOrEmpty(AppSet.FiveCheckID))
                    {
                        send.title = "订单改价申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.ApplyStatus = "3";
                        result.CheckID = "";//AppSet.FourCheckID;
                        result.CheckName = "";//AppSet.FourCheckName;
                        approveRoute.Opera = "2";
                        //approveRouteList.Add(approveRoute);
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FiveCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    if (!string.IsNullOrEmpty(AppSet.AutoPassID))
                    {
                        bool IsAuto = false;
                        if (!string.IsNullOrEmpty(AppSet.FiveCheckID) && AppSet.AutoPassID.Contains(AppSet.FiveCheckID))
                        {
                            IsAuto = true;
                            //说明第三级自动过
                            result.CheckID = AppSet.SixCheckID;
                            result.CheckName = AppSet.SixCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.SixCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;

                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SixCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                        if (!string.IsNullOrEmpty(AppSet.SixCheckID) && AppSet.AutoPassID.Contains(AppSet.SixCheckID) && IsAuto)
                        {
                            //说明第三级自动过
                            result.CheckID = AppSet.SevenCheckID;
                            result.CheckName = AppSet.SevenCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.SevenCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SevenCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                    }
                    #endregion
                }
                else if (AppSet.FiveCheckID.Equals(qup.CheckID))
                {
                    #region 第五级
                    send.title = AppSet.FiveCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.CheckID = AppSet.SixCheckID;
                    result.CheckName = AppSet.SixCheckName;
                    if (string.IsNullOrEmpty(AppSet.SixCheckID))
                    {
                        send.title = "订单改价申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.ApplyStatus = "3";
                        result.CheckID = "";// AppSet.FiveCheckID;
                        result.CheckName = "";//AppSet.FiveCheckName;
                        approveRoute.Opera = "2";
                        //approveRouteList.Add(approveRoute);
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SixCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    if (!string.IsNullOrEmpty(AppSet.AutoPassID))
                    {
                        if (!string.IsNullOrEmpty(AppSet.SixCheckID) && AppSet.AutoPassID.Contains(AppSet.SixCheckID))
                        {
                            //说明第三级自动过
                            result.CheckID = AppSet.SevenCheckID;
                            result.CheckName = AppSet.SevenCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.SevenCheckID))
                            {
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                approveRoute.Opera = "2";
                                //approveRoute.Opera = "0";
                                approveRouteList.Add(approveRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SevenCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                    }
                    #endregion
                }
                else if (AppSet.SixCheckID.Equals(qup.CheckID))
                {
                    #region 第六级
                    send.title = AppSet.SixCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.CheckID = AppSet.SevenCheckID;
                    result.CheckName = AppSet.SevenCheckName;
                    if (string.IsNullOrEmpty(AppSet.SevenCheckID))
                    {
                        send.title = "订单改价申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.ApplyStatus = "3";
                        result.CheckID = "";// AppSet.FiveCheckID;
                        result.CheckName = "";//AppSet.FiveCheckName;
                        approveRoute.Opera = "2";
                        //approveRouteList.Add(approveRoute);
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SevenCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    #endregion
                }

                q.CheckUpdatePrice(result, log);
                foreach (var aroute in approveRouteList)
                {
                    f.AddExpenseApproveRout(aroute);

                }
                //f.AddExpenseApproveRout(approveRoute);
                //添加申请单与审批人关系数据
                Common.WriteTextLog("添加申请单与审批人关系数据" + OID.ToString() + QyUserInfo.UserID + QyUserInfo.UserName);
                if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = OID, CheckUserID = QyUserInfo.UserID, CheckType = "0", ApproveType = "1" }))
                {
                    Common.WriteTextLog("判断正确" + OID.ToString() + QyUserInfo.UserID + QyUserInfo.UserName);
                    f.AddApproveCheck(new CargoApproveCheckEntity
                    {
                        ApproveID = OID,
                        CheckUserID = QyUserInfo.UserID,
                        CheckName = QyUserInfo.UserName,
                        CheckType = "0",
                        ReadStatus = "1",
                        ApproveType = "1"
                    }, log);
                    Common.WriteTextLog("操作完成" + OID.ToString() + QyUserInfo.UserID + QyUserInfo.UserName);

                }
                //如果 是最后审批人，就结束
                if (IsEnd)
                {
                    #region 修改数据
                    if (OrderType.Equals("0"))
                    {
                        //修改商城订单价格
                        q.UpdateWxMallOrderPrice(result, log);
                    }
                    else
                    {
                        //修改电脑订单价格
                        CargoOrderBus obus = new CargoOrderBus();
                        CargoOrderEntity orderEnt = obus.QueryOrderInfo(new CargoOrderEntity { OrderNo = OrderNo });
                        obus.UpdateCargoOrderModifyPriceStatus(new CargoOrderEntity { OrderNo = OrderNo, ModifyPriceStatus = "0" }, log);
                        CargoHouseBus house = new CargoHouseBus();
                        CargoHouseEntity houseEnt = house.QueryCargoHouseByID(orderEnt.HouseID);
                        if (orderEnt.HouseID.Equals(9) && orderEnt.ThrowGood.Equals("15"))
                        {
                            //速配单
                            obus.InsertCargoOrderPush(new CargoOrderPushEntity
                            {
                                OrderNo = orderEnt.OrderNo,
                                Dep = orderEnt.Dep,
                                Dest = orderEnt.Dest,
                                Piece = orderEnt.Piece,
                                TransportFee = orderEnt.TransportFee,
                                ClientNum = orderEnt.ClientNum.ToString(),
                                AcceptAddress = orderEnt.AcceptAddress,
                                AcceptCellphone = orderEnt.AcceptCellphone,
                                AcceptTelephone = orderEnt.AcceptTelephone,
                                AcceptPeople = orderEnt.AcceptPeople,
                                AcceptUnit = orderEnt.AcceptUnit,
                                HouseID = orderEnt.HouseID.ToString(),
                                HouseName = "新陆城配",
                                OP_ID = qup.ApplyName,
                                PushType = "0",
                                PushStatus = "0",
                                LogisID = orderEnt.LogisID
                            }, log);
                        }
                        if (orderEnt.HouseID.Equals(9) || orderEnt.HouseID.Equals(15) || orderEnt.HouseID.Equals(49) || orderEnt.HouseID.Equals(50) || orderEnt.HouseID.Equals(51) || orderEnt.HouseID.Equals(52) || orderEnt.HouseID.Equals(53) || orderEnt.HouseID.Equals(54) || orderEnt.HouseID.Equals(13) || orderEnt.HouseID.Equals(14) || orderEnt.HouseID.Equals(15) || orderEnt.HouseID.Equals(23) || orderEnt.HouseID.Equals(30) || orderEnt.HouseID.Equals(93))
                        {
                            //判断必须选择好来运速递
                            if (orderEnt.LogisID.Equals(34))
                            {
                                //广州仓库
                                if (orderEnt.HouseID.Equals(9))
                                {
                                    //等通知发货的订单不推送
                                    if (orderEnt.PostponeShip != "1")
                                    {
                                        List<CargoContainerShowEntity> outHouseList = obus.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = orderEnt.OrderNo });
                                        //内部订单
                                        obus.SaveHlyOrderData(outHouseList, orderEnt);
                                    }
                                }
                                else
                                {
                                    List<CargoContainerShowEntity> outHouseList = obus.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = orderEnt.OrderNo });
                                    //内部订单
                                    obus.SaveHlyOrderData(outHouseList, orderEnt);
                                }
                            }
                        }
                        else
                        {
                            obus.InsertCargoOrderPush(new CargoOrderPushEntity
                            {
                                OrderNo = orderEnt.OrderNo,
                                Dep = orderEnt.Dep,
                                Dest = orderEnt.Dest,
                                Piece = orderEnt.Piece,
                                TransportFee = orderEnt.TransportFee,
                                ClientNum = orderEnt.ClientNum.ToString(),
                                AcceptAddress = orderEnt.AcceptAddress,
                                AcceptCellphone = orderEnt.AcceptCellphone,
                                AcceptTelephone = orderEnt.AcceptTelephone,
                                AcceptPeople = orderEnt.AcceptPeople,
                                AcceptUnit = orderEnt.AcceptUnit,
                                HouseID = orderEnt.HouseID.ToString(),
                                HouseName = houseEnt.Name,
                                OP_ID = qup.ApplyName,
                                PushType = "0",
                                PushStatus = "0",
                                LogisID = orderEnt.LogisID
                            }, log);
                        }
                    }
                    #endregion

                    List<QyUserEntity> cQyU = new List<QyUserEntity>();
                    if (!string.IsNullOrEmpty(AppSet.CopyCheck))
                    {
                        cQyU = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.CopyCheck });
                    }
                    foreach (var c in cQyU)
                    {
                        //添加申请单与审批人关系数据
                        if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = OID, CheckUserID = c.UserID, ApproveType = "1" }))
                        {
                            f.AddApproveCheck(new CargoApproveCheckEntity
                            {
                                ApproveID = OID,
                                CheckUserID = c.UserID,
                                CheckName = c.WxName,
                                CheckType = "1",
                                ReadStatus = "1",
                                ApproveType = "1"
                            }, log);
                        }
                        if (!copy.Contains(c.UserID))
                        {
                            copy += c.UserID + ",";
                        }
                    }
                    if (!string.IsNullOrEmpty(AppSet.CopyUserID) && !string.IsNullOrEmpty(AppSet.CopyCheckName))
                    {
                        string[] uS = AppSet.CopyUserID.Split(',');
                        string[] uName = AppSet.CopyUserName.Split(',');
                        if (uS.Length > 0)
                        {
                            for (int i = 0; i < uS.Length; i++)
                            {
                                if (!string.IsNullOrEmpty(uS[i]))
                                {
                                    //添加申请单与审批人关系数据
                                    if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = OID, CheckUserID = uS[i], ApproveType = "1" }))
                                    {
                                        f.AddApproveCheck(new CargoApproveCheckEntity
                                        {
                                            ApproveID = OID,
                                            CheckUserID = uS[i],
                                            CheckName = uName[i],
                                            CheckType = "1",
                                            ReadStatus = "1",
                                            ApproveType = "1"
                                        }, log);
                                    }
                                    if (!copy.Contains(uS[i]))
                                    {
                                        copy += uS[i] + ",";
                                    }
                                }
                            }
                        }
                    }
                    try
                    {
                        if (OrderType.Equals("0"))
                        {
                            CargoOrderBus obus = new CargoOrderBus();
                            string wxopenID = obus.QueryWeixinOpenIDByOrderNo(OrderNo);
                            //推送客户改价成功通知
                            WxCustomSend wxsend = new WxCustomSend();
                            string token = Common.GetWeixinToken(Common.GetdltAPPID(), Common.GetdltAppSecret());
                            wxsend.SendWeiXinInfo(token, wxopenID, new QySendInfoEntity { content = "您的订单：" + OrderNo + "改价申请已通过，请到我的订单进行支付，谢谢！", msgType = msgType.text });
                        }
                    }
                    catch (ApplicationException exx)
                    {
                        msg.Result = true;
                        Common.WriteTextLog(OrderNo + "推送客户通知失败");
                    }
                }
                if (qyUser.Count > 0 || IsEnd)
                {
                    #region 推送通知
                    try
                    {
                        //推送给提交人
                        send.msgType = msgType.textcard;
                        send.toUser = qup.ApplyID;
                        //send.toUser = ou.ApplyID;
                        //send.toTag = strTag;
                        send.content = "<div></div><div>订单号：" + OrderNo + "</div><div>收货人：" + Name + "  " + Cellphone + "</div><div>审批人：" + QyUserInfo.UserName + "</div><div>审批时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>审批意见：" + result.CheckResult + "</div><div></div>";
                        send.url = "http://dlt.neway5.com/QY/qyApproveCheck.aspx?OrderNo=" + OrderNo + "&OID=" + OID + "&OrderType=" + OrderType;
                        WxQYSendHelper.PushInfo("0", "3", send);
                    }
                    catch (Exception)
                    {
                        msg.Result = true;
                    }
                    //推送给下一审批人
                    foreach (var it in qyUser)
                    {
                        try
                        {
                            send.toUser = it.UserID;
                            WxQYSendHelper.PushInfo("0", "2", send);
                        }
                        catch (Exception ex)
                        {
                            continue;
                        }
                    }
                    if (!string.IsNullOrEmpty(copy))
                    {
                        copy = copy.Substring(0, copy.Length - 1);
                        try
                        {
                            send.toUser = copy;
                            WxQYSendHelper.PushInfo("0", "2", send);
                        }
                        catch (Exception ex)
                        {
                            msg.Result = true;
                        }
                    }
                    #endregion
                }
                //创建群聊窗口和推送信息
                if (!qup.HouseID.Equals(64))
                {
                    try
                    {
                        string oU = "http://dlt.neway5.com/QY/qyApproveCheck.aspx?OrderNo=" + OrderNo + "&OID=" + OID + "&OrderType=" + OrderType;
                        QyGroupChatEntity chat = q.QueryGroupChatEntity(new QyGroupChatEntity { HouseID = qup.HouseID, ChatType = "0" });
                        if (chat.ID.Equals(0))
                        {
                            //string[] ul = { "0007", "2081", "1079" };
                            List<string> lis = new List<string>();
                            lis.Add("0007");
                            lis.Add("2081");
                            lis.Add("1079");
                            //lis.Add("1000");
                            //lis.Add("2076");
                            //lis.Add(qup.ApplyID);
                            string hN = string.Empty;
                            switch (qup.HouseID)
                            {
                                case 1: hN = "湖南迪乐泰改价审批群"; lis.Add("1006"); break;
                                case 3: hN = "湖北迪乐泰改价审批群"; lis.Add("1061"); break;
                                //case 9: hN = "广州迪乐泰改价审批群"; lis.Add("2096"); break;
                                case 11: hN = "西安迪乐泰改价审批群"; lis.Add("1061"); break;
                                //case 34: hN = "海南迪乐泰改价审批群"; lis.Add("2096"); break;
                                //case 12: hN = "梅州迪乐泰改价审批群"; lis.Add("2096"); break;
                                //case 44: hN = "揭阳迪乐泰改价审批群"; lis.Add("2096"); break;
                                //case 45: hN = "广东仓库改价审批群"; lis.Add("2096"); break;
                                case 46: hN = "四川迪乐泰改价审批群"; break;
                                case 48: hN = "重庆迪乐泰改价审批群"; lis.Add("1061"); break;
                                default:
                                    break;
                            }
                            string ChatID = DateTime.Now.ToString("yyMMddHHmmss");

                            //表示没有群聊，要新增
                            q.AddGroupChat(new QyGroupChatEntity { ChatName = hN, HouseID = qup.HouseID, ChatType = "0", Owner = "0007", ChatID = ChatID }, log);
                            WxQYSendHelper.CreateChat(ChatID, hN, "0007", lis.ToArray(), "1000003");

                            //向群聊里推送审批通知
                            QySendInfoEntity qysend = new QySendInfoEntity();
                            qysend.agentID = "1000003";
                            qysend.msgType = msgType.markdown;
                            qysend.ChatID = ChatID;
                            qysend.content = "订单号**" + qup.OrderNo + "**改价审批已通过\n>**审批意见** \n>\n><font color=\"info\">" + Reason + "</font>\n>\n>审批人：" + qup.CheckName + "\n>\n>查看审批流程请点击：[审批流程](" + oU + ")";
                            WxQYSendHelper.SendChatInfo(qysend);
                        }
                        else
                        {
                            //向群聊里推送审批通知
                            QySendInfoEntity qysend = new QySendInfoEntity();
                            qysend.agentID = "1000003";
                            qysend.msgType = msgType.markdown;
                            qysend.ChatID = chat.ChatID;
                            qysend.content = "订单号**" + qup.OrderNo + "**改价审批已通过\n>**审批意见** \n>\n><font color=\"info\">" + Reason + "</font>\n>\n>审批人：" + qup.CheckName + "\n>\n>查看审批流程请点击：[审批流程](" + oU + ")";
                            WxQYSendHelper.SendChatInfo(qysend);
                        }
                    }
                    catch (ApplicationException ex)
                    {
                        msg.Result = true;
                    }
                }
            }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 拒绝审批
        /// </summary>
        public void checkNo()
        {
            string Reason = Convert.ToString(Request["Reason"]);
            string OrderNo = Convert.ToString(Request["OrderNo"]);
            long OID = Convert.ToInt64(Request["OID"]);
            string Name = Convert.ToString(Request["Name"]);//收货人姓名 
            string Cellphone = Convert.ToString(Request["Cellphone"]);
            string OrderType = Convert.ToString(Request["OrderType"]);//订单类型0：商城订单1：电脑订单
            QyOrderUpdatePriceEntity result = new QyOrderUpdatePriceEntity();
            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            result.HouseID = QyUserInfo.HouseID;
            result.CheckID = "";// QyUserInfo.UserID;
            result.CheckName = "";// QyUserInfo.UserName;
            result.CheckTime = DateTime.Now;
            result.OrderNo = OrderNo;
            result.ApplyStatus = "2";
            result.CheckResult = Reason;
            result.OID = OID;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "报销审批";
            log.NvgPage = "修改价格审批";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";
            QiyeBus bus = new QiyeBus();
            QyOrderUpdatePriceEntity qup = bus.QueryOrderUpdatePriceEntity(result);
            if (qup.ApplyStatus.Equals("3"))
            {
                msg.Result = false;
                msg.Message = "该订单已审批结束，请勿重复审批";
            }
            if (!QyUserInfo.CheckRole.Contains(qup.CheckID))
            {
                msg.Result = false;
                msg.Message = "流程未到您审批";
            }
            if (msg.Result)
            {
                CargoExpenseApproveRoutEntity approveRoute = new CargoExpenseApproveRoutEntity();
                approveRoute.ExID = OID;
                approveRoute.UserID = QyUserInfo.UserID;
                approveRoute.UserName = QyUserInfo.UserName;
                approveRoute.ApproveType = "1";
                approveRoute.Result = Reason;
                approveRoute.Opera = "1";//拒审

                CargoFinanceBus f = new CargoFinanceBus();
                bus.CheckUpdatePrice(result, log);
                f.AddExpenseApproveRout(approveRoute);
                //添加申请单与审批人关系数据
                if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = OID, CheckUserID = QyUserInfo.UserID, CheckType = "0", ApproveType = "1" }))
                {
                    f.AddApproveCheck(new CargoApproveCheckEntity
                    {
                        ApproveID = OID,
                        CheckUserID = QyUserInfo.UserID,
                        CheckName = QyUserInfo.UserName,
                        CheckType = "0",
                        ReadStatus = "1",
                        ApproveType = "1"
                    }, log);
                }
                if (OrderType.Equals("1"))
                {
                    //电脑订单，删除订单
                    CargoOrderBus obus = new CargoOrderBus();
                    CargoOrderEntity orderEnt = obus.QueryOrderInfoByOrderID(qup.OrderID);
                    orderEnt.DeleteID = QyUserInfo.UserID;
                    orderEnt.DeleteName = QyUserInfo.UserName;
                    List<CargoOrderEntity> ol = new List<CargoOrderEntity>();
                    ol.Add(orderEnt);

                    //仓库同步缓存
                    CargoHouseBus house = new CargoHouseBus();
                    List<CargoProductEntity> syncProduct = house.SyncTypeOrderNo(OrderNo);
                    foreach (CargoProductEntity product in syncProduct)
                    {

                        if (product.SyncType == "2" || (product.SyncType == "1" && product.TypeID == 34))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + product.HouseID + "_" + product.TypeID + "_" + product.ProductCode + "", product.GoodsCode);
                        }
                    }

                    obus.DeleteOrderInfo(ol, log);
                }
                try
                {
                    QySendInfoEntity send = new QySendInfoEntity();
                    send.title = "订单改价申请拒审";
                    send.msgType = msgType.textcard;
                    send.toUser = qup.ApplyID;
                    //send.toTag = strTag;
                    send.content = "<div></div><div>订单号：" + OrderNo + "</div><div>收货人：" + Name + "  " + Cellphone + "</div><div>审批人：" + result.CheckName + "</div><div>审批时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>审批意见：" + result.CheckResult + "</div><div>审批结果：未通过</div>";
                    send.url = "http://dlt.neway5.com/QY/qyApproveCheck.aspx?OrderNo=" + OrderNo + "&OID=" + OID + "&OrderType=" + OrderType;
                    WxQYSendHelper.PushInfo("0", "3", send);
                    //send.toUser = "0007";
                    //WxQYSendHelper.PushInfo("0", "2", send);
                }
                catch (ApplicationException ex)
                {
                    msg.Result = true;
                }
                //创建群聊窗口和推送信息
                if (!qup.HouseID.Equals(64))
                {
                    try
                    {
                        string oU = "http://dlt.neway5.com/QY/qyApproveCheck.aspx?OrderNo=" + OrderNo + "&OID=" + OID + "&OrderType=" + OrderType;
                        QyGroupChatEntity chat = bus.QueryGroupChatEntity(new QyGroupChatEntity { HouseID = qup.HouseID, ChatType = "0" });
                        if (!chat.ID.Equals(0))
                        {
                            //向群聊里推送审批通知
                            QySendInfoEntity qysend = new QySendInfoEntity();
                            qysend.agentID = "1000003";
                            qysend.msgType = msgType.markdown;
                            qysend.ChatID = chat.ChatID;
                            qysend.content = "订单号**" + OrderNo + "**改价审批拒绝\n>**拒审意见** \n>\n><font color=\"info\">" + Reason + "</font>\n>\n>审批人：" + qup.CheckName + "\n>\n>查看审批流程请点击：[审批流程](" + oU + ")";
                            WxQYSendHelper.SendChatInfo(qysend);
                        }
                    }
                    catch (ApplicationException ex)
                    {
                        msg.Result = true;
                    }
                }
            }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 查询我的未审批订单
        /// </summary>
        public void QueryUnCheckOrderModify()
        {
            QyOrderUpdatePriceEntity queryEntity = new QyOrderUpdatePriceEntity();
            //queryEntity.HouseID = QyUserInfo.HouseID;
            //queryEntity.CargoPermisID = QyUserInfo.CargoPermisID;
            //switch (QyUserInfo.UserID)
            //{
            //    //case "1061": queryEntity.CargoPermisID = "3,11,48,46,53"; break;
            //    //case "0007": queryEntity.CargoPermisID = "46"; break;
            //    //case "0006": queryEntity.CargoPermisID = "9,44,45,12,34,82,83,84,85,86"; break;
            //    //case "1029": queryEntity.CargoPermisID = "34,9,44,45"; break;
            //    case "2096": queryEntity.CargoPermisID = "34,9,44,45,12"; break;
            //    case "1006": queryEntity.CargoPermisID = "1"; break;
            //    case "2422": queryEntity.CargoPermisID = "64"; break;
            //    default:
            //        break;
            //}
            queryEntity.CheckHouseID = QyUserInfo.CheckHouseID;
            queryEntity.ApplyStatus = "0,1";
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            Hashtable list = new Hashtable();
            if (!string.IsNullOrEmpty(QyUserInfo.CheckRole))
            {
                queryEntity.CheckID = QyUserInfo.CheckRole;
                CargoOrderBus bus = new CargoOrderBus();
                list = bus.QueryUpdatePriceInfo(pageIndex, pageSize, queryEntity);
            }
            else
            {
                list = new Hashtable();
            }

            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 我审批的
        /// </summary>
        public void QueryCheckOrderModify()
        {
            QyOrderUpdatePriceEntity queryEntity = new QyOrderUpdatePriceEntity();
            //queryEntity.CargoPermisID = QyUserInfo.HouseID.ToString();
            //queryEntity.CheckID = QyUserInfo.UserID; 
            //switch (QyUserInfo.UserID)
            //{
            //    case "1061": queryEntity.CargoPermisID = "3,11"; break;
            //    case "0007": queryEntity.CargoPermisID = "46"; break;
            //    case "0006": queryEntity.CargoPermisID = "9,44"; break;
            //    //case "1029": queryEntity.CargoPermisID = "34,9,44,45"; break;
            //    case "2096": queryEntity.CargoPermisID = "34,9,44,45,12"; break;
            //    default:
            //        break;
            //}
            queryEntity.CheckID = QyUserInfo.UserID;
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryMyCheckUpdatePriceInfo(pageIndex, pageSize, queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void QueryUpExpenseCheckInfo()
        {
            CargoExpenseEntity queryEntity = new CargoExpenseEntity();
            switch (QyUserInfo.UserID)
            {
                case "1061": queryEntity.CargoPermisID = "3,11,48,46,53"; break;
                //case "0007": queryEntity.CargoPermisID = "46"; break;
                case "0006": queryEntity.CargoPermisID = "9,44,45,12,34"; break;
                //case "1029": queryEntity.CargoPermisID = "34,9,44,45"; break;
                case "2096": queryEntity.CargoPermisID = "34,9,44,45,12"; break;
                case "1006": queryEntity.CargoPermisID = "1"; break;
                default:
                    break;
            }
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            Hashtable list = new Hashtable();
            if (!string.IsNullOrEmpty(QyUserInfo.CheckRole))
            {
                queryEntity.NextCheckID = QyUserInfo.CheckRole;
                CargoOrderBus bus = new CargoOrderBus();
                list = bus.QueryUpExpenseCheckInfo(pageIndex, pageSize, queryEntity);
            }
            else
            {
                list = new Hashtable();
            }

            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 我审批的
        /// </summary>
        public void QueryExpenseCheckInfo()
        {
            CargoExpenseEntity queryEntity = new CargoExpenseEntity();
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryExpenseCheckInfo(pageIndex, pageSize, queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 我申请的未审批的
        /// </summary>
        public void QueryUnCheckMyOrderModify()
        {
            QyOrderUpdatePriceEntity queryEntity = new QyOrderUpdatePriceEntity();
            //queryEntity.HouseID = QyUserInfo.HouseID;
            queryEntity.ApplyID = QyUserInfo.UserID;
            //queryEntity.CheckID = QyUserInfo.UserID;
            queryEntity.ApplyStatus = "0";
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryUpdatePriceInfo(pageIndex, pageSize, queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 我申请的已审批的
        /// </summary>
        public void QueryCheckMyOrderModify()
        {
            QyOrderUpdatePriceEntity queryEntity = new QyOrderUpdatePriceEntity();
            //queryEntity.HouseID = QyUserInfo.HouseID;
            queryEntity.ApplyID = QyUserInfo.UserID;
            queryEntity.ApplyStatus = "-1";
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryUpdatePriceInfo(pageIndex, pageSize, queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        /// <summary>
        /// 申请审批
        /// </summary>
        public void ApplicationCheckOk()
        {
            long ID = Convert.ToInt64(Request["ID"]);
            int ty = Convert.ToInt32(Request["ty"]);
            String DenyReason = Request["Reason"];
            List<CargoApproveEntity> list = new List<CargoApproveEntity>();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "申请审批";
            log.NvgPage = "申请审批";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";
            CargoFinanceBus f = new CargoFinanceBus();
            CargoStaticBus bus = new CargoStaticBus();
            QiyeBus q = new QiyeBus();
            CargoOrderBus o = new CargoOrderBus();
            CargoWeiXinBus weiXinBus = new CargoWeiXinBus();
            QyUserEntity qyU = q.QueryUser(new QyUserEntity { UserID = QyUserInfo.UserID });
            CargoApproveEntity ApproveEntity = bus.QueryApproveEntity(new CargoApproveEntity { ID = ID });
            CargoApproveEntity result = new CargoApproveEntity();
            result.ID = ID;
            result.DenyReason = DenyReason;//审批意见
            result.CurrID = QyUserInfo.UserID;//当前审批人
            result.CurrName = QyUserInfo.UserName;//当前审批人姓名
            result.CheckTime = DateTime.Now;
            result.ApplyID = ApproveEntity.ApplyID;
            result.ApplyName = ApproveEntity.ApplyName;
            result.Title = ApproveEntity.Title;
            result.Memo = ApproveEntity.Memo;
            result.ApplyType = ApproveEntity.ApplyType;
            string copy = string.Empty;
            bool IsEnd = false;
            List<QyUserEntity> qyUser = new List<QyUserEntity>();
            QySendInfoEntity send = new QySendInfoEntity();
            send.url = "http://dlt.neway5.com/QY/qyApplicationCheck.aspx?ApproveID=" + ApproveEntity.ID.ToString() + "&ty=0";
            send.msgType = msgType.textcard;
            send.agentID = "1000010";//申请审批应用
            CargoApproveSetEntity appSet = f.QueryApproveSetByID(ApproveEntity.AppSetID);
            try
            {
                if (ApproveEntity.ApplyStatus.Equals("3"))
                {
                    msg.Result = false;
                    msg.Message = "审批结束的不允许审批";
                    goto ERR;
                }
                if (ty.Equals(1))
                {
                    #region 拒审
                    log.Memo = "拒审成功 ";

                    //查询审批流程数据
                    if (!qyU.CheckRole.Contains(ApproveEntity.NextCheckID))
                    {
                        msg.Result = false;
                        msg.Message = "申请单号:" + ApproveEntity.ID.ToString() + "未到您审批";
                        goto ERR;
                    }
                    result.ApplyStatus = "2";
                    result.NextCheckID = "";
                    result.NextCheckName = "";
                    list.Add(result);
                    bus.setApplicationCheck(list, ty, log);
                    qyUser.Add(new QyUserEntity { UserID = ApproveEntity.ApplyID, WxName = ApproveEntity.ApplyName });
                    send.title = "申请单：" + ApproveEntity.ID.ToString() + "审批拒审";
                    if (ApproveEntity.ApplyType.Equals("4"))
                    {
                        send.content = "<div></div><div>申请类型：加班申请</div><div>申请内容：" + ApproveEntity.Memo + "</div><div>加班时间：" + ApproveEntity.OStartTime.ToString("yyyy-MM-dd HH:mm") + "--" + ApproveEntity.OEndTime.ToString("yyyy-MM-dd HH:mm") + "</div><div>加班时长：" + ApproveEntity.OTime.ToString("F1") + "小时</div><div>审批人：" + QyUserInfo.UserName + "</div><div>拒审意见：" + result.DenyReason + "</div><div></div><div class=\"highlight\">请点击本通知进行审批！</div>";
                    }
                    else if (ApproveEntity.ApplyType.Equals("2"))
                    {
                        //轮胎外调申请审批
                        List<CargoApproveRelateEntity> aRelate = bus.QueryApproveThrowRelateList(new CargoApproveRelateEntity { ApproveID = ApproveEntity.ID, ApplyType = "2" });
                        int totalNum = 0; decimal totalCharge = 0.00M;
                        foreach (var it in aRelate)
                        {
                            totalNum += it.ThrowNum;
                            totalCharge += it.ThrowNum * it.ThrowCharge;
                        }
                        send.content = "<div></div><div>申请标题：" + ApproveEntity.Title + "</div><div>外调仓库：" + ApproveEntity.ThrowHouseName + " " + ApproveEntity.ClientName + "</div><div>外调数量：" + totalNum.ToString() + "条</div><div>外调金额：" + totalCharge.ToString("F2") + "元</div><div>审批人：" + QyUserInfo.UserName + "</div><div>拒审意见：" + result.DenyReason + "</div><div></div><div class=\"highlight\">请重新提交审批！</div>";
                    }
                    else if (ApproveEntity.ApplyType.Equals("8"))
                    {
                        send.content = "<div></div><div>申请类型：客户资料审批</div><div>申请标题：" + ApproveEntity.Title + "</div><div>申请内容：" + ApproveEntity.Memo + "</div><div>审批人：" + QyUserInfo.UserName + "</div><div>拒审意见：" + result.DenyReason + "</div><div></div><div class=\"highlight\">请重新提交审批！</div>";
                    }
                    else if (ApproveEntity.ApplyType.Equals("15"))
                    {
                        send.content = "<div></div><div>申请类型：优惠券审批</div><div>申请标题：" + ApproveEntity.Title + "</div><div>申请内容：" + ApproveEntity.Memo + "</div><div>审批人：" + QyUserInfo.UserName + "</div><div>拒审意见：" + result.DenyReason + "</div><div></div><div class=\"highlight\">请重新提交审批！</div>";
                    }
                    foreach (var it in qyUser)
                    {
                        send.toUser = it.UserID;
                        WxQYSendHelper.QiyePushInfo(send);
                        Common.WriteTextLog("推送成功：" + it.WxName + ApproveEntity.ID.ToString());
                    }

                    #endregion
                }
                else
                {
                    log.Memo = "审批成功 ";
                    //查询审批流程数据
                    if (!qyU.CheckRole.Contains(ApproveEntity.NextCheckID))
                    {
                        msg.Result = false;
                        msg.Message = "申请单号:" + ApproveEntity.ID.ToString() + "未到您审批";
                        goto ERR;
                    }

                    string NextCheckID = ApproveEntity.NextCheckID;//下一审批人
                    if (appSet.OneCheckID.Equals(NextCheckID))
                    {
                        #region 第一级
                        send.title = appSet.OneCheckName + "审批通过";
                        result.ApplyStatus = "1";
                        result.NextCheckID = appSet.TwoCheckID;
                        result.NextCheckName = appSet.TwoCheckName;
                        if (string.IsNullOrEmpty(appSet.TwoCheckID))
                        {
                            send.title = "申请单：" + ApproveEntity.ID.ToString() + "审批结束";
                            //表示是最后一级
                            IsEnd = true;
                            result.ApplyStatus = "3";
                            result.NextCheckID = "";// AppSet.OneCheckID;
                            result.NextCheckName = "";// AppSet.OneCheckName;
                        }
                        else
                        {
                            //判断下一级是不是分公司领导或部门主管，如果是则查询申请人的上级领导
                            if (appSet.TwoCheckID.Equals("3") || appSet.TwoCheckID.Equals("8"))
                            {
                                string ln = string.Empty;
                                if (appSet.TwoCheckID.Equals("8"))
                                {
                                    //部门主管
                                    ln = ApproveEntity.ApplyID;
                                }
                                if (appSet.TwoCheckID.Equals("3"))
                                {
                                    //分公司领导 找审批人的领导
                                    ln = QyUserInfo.UserID;
                                }
                                List<SystemUserEntity> Bosslist = o.QueryUserBossLoginName(new SystemUserEntity { LoginName = ln });
                                if (Bosslist.Count > 0)
                                {
                                    if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                    {
                                        qyUser.Add(new QyUserEntity { UserID = Bosslist[0].LoginName, WxName = Bosslist[0].UserName });
                                    }
                                    else
                                    {
                                        if (!string.IsNullOrEmpty(appSet.ThreeCheckID))
                                        {
                                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.ThreeCheckID, CheckHouseID = ApproveEntity.HouseID.ToString() });
                                        }
                                        else
                                        {
                                            //结束 
                                            send.title = "申请单：" + ApproveEntity.ID.ToString() + "审批结束";
                                            //表示是最后一级
                                            IsEnd = true;
                                            result.ApplyStatus = "3";
                                            result.NextCheckID = "";// AppSet.OneCheckID;
                                            result.NextCheckName = "";// AppSet.OneCheckName;
                                        }
                                    }
                                }
                            }
                            else if (appSet.TwoCheckID.Equals("7"))
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.TwoCheckID, HouseID = ApproveEntity.HouseID, CheckHouseID = ApproveEntity.HouseID.ToString() });
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(appSet.TwoCheckID))
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.TwoCheckID, CheckHouseID = ApproveEntity.HouseID.ToString() });
                                }
                            }
                        }
                        #endregion
                    }
                    else if (appSet.TwoCheckID.Equals(NextCheckID))
                    {
                        #region 第二级
                        send.title = appSet.TwoCheckName + "审批通过";
                        result.ApplyStatus = "1";
                        result.NextCheckID = appSet.ThreeCheckID;
                        result.NextCheckName = appSet.ThreeCheckName;
                        if (string.IsNullOrEmpty(appSet.ThreeCheckID))
                        {
                            send.title = "申请单：" + ApproveEntity.ID.ToString() + "审批结束";
                            //表示是最后一级
                            IsEnd = true;
                            result.ApplyStatus = "3";
                            result.NextCheckID = "";// AppSet.OneCheckID;
                            result.NextCheckName = "";// AppSet.OneCheckName;
                        }
                        else
                        {
                            //判断下一级是不是分公司领导或部门主管，如果是则查询申请人的上级领导
                            if (appSet.ThreeCheckID.Equals("3") || appSet.ThreeCheckID.Equals("8"))
                            {
                                string ln = string.Empty;
                                if (appSet.ThreeCheckID.Equals("8"))
                                {
                                    //部门主管
                                    ln = ApproveEntity.ApplyID;
                                }
                                if (appSet.ThreeCheckID.Equals("3"))
                                {
                                    //分公司领导 找审批人的领导
                                    ln = QyUserInfo.UserID;
                                }
                                List<SystemUserEntity> Bosslist = o.QueryUserBossLoginName(new SystemUserEntity { LoginName = ln });
                                if (Bosslist.Count > 0)
                                {
                                    if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                    {
                                        qyUser.Add(new QyUserEntity { UserID = Bosslist[0].LoginName, WxName = Bosslist[0].UserName });
                                    }
                                    else
                                    {
                                        if (!string.IsNullOrEmpty(appSet.FourCheckID))
                                        {
                                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.FourCheckID, CheckHouseID = ApproveEntity.HouseID.ToString() });
                                        }
                                        else
                                        {
                                            //结束 
                                            send.title = "申请单：" + ApproveEntity.ID.ToString() + "审批结束";
                                            //表示是最后一级
                                            IsEnd = true;
                                            result.ApplyStatus = "3";
                                            result.NextCheckID = "";// AppSet.OneCheckID;
                                            result.NextCheckName = "";// AppSet.OneCheckName;
                                        }
                                    }
                                }
                            }
                            else if (appSet.ThreeCheckID.Equals("7"))
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.ThreeCheckID, HouseID = ApproveEntity.HouseID, CheckHouseID = ApproveEntity.HouseID.ToString() });
                            }
                            else
                            {
                                if (!string.IsNullOrEmpty(appSet.ThreeCheckID))
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.ThreeCheckID, CheckHouseID = ApproveEntity.HouseID.ToString() });
                                }
                            }
                            //qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.ThreeCheckID, CheckHouseID = ApproveEntity.HouseID.ToString() });
                        }
                        #endregion
                    }
                    else if (appSet.ThreeCheckID.Equals(NextCheckID))
                    {
                        #region 第三级
                        send.title = appSet.ThreeCheckName + "审批通过";
                        result.ApplyStatus = "1";
                        result.NextCheckID = appSet.FourCheckID;
                        result.NextCheckName = appSet.FourCheckName;
                        if (string.IsNullOrEmpty(appSet.FourCheckID))
                        {
                            send.title = "申请单：" + ApproveEntity.ID.ToString() + "审批结束";
                            //表示是最后一级
                            IsEnd = true;
                            result.ApplyStatus = "3";
                            result.NextCheckID = "";// AppSet.OneCheckID;
                            result.NextCheckName = "";// AppSet.OneCheckName;
                        }
                        else
                        {
                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.FourCheckID, CheckHouseID = ApproveEntity.HouseID.ToString() });
                        }
                        #endregion
                    }
                    else if (appSet.FourCheckID.Equals(NextCheckID))
                    {
                        #region 第四级
                        send.title = appSet.FourCheckName + "审批通过";
                        result.ApplyStatus = "1";
                        result.NextCheckID = appSet.FiveCheckID;
                        result.NextCheckName = appSet.FiveCheckName;
                        if (string.IsNullOrEmpty(appSet.FiveCheckID))
                        {
                            send.title = "申请单：" + ApproveEntity.ID.ToString() + "审批结束";
                            //表示是最后一级
                            IsEnd = true;
                            result.ApplyStatus = "3";
                            result.NextCheckID = "";// AppSet.OneCheckID;
                            result.NextCheckName = "";// AppSet.OneCheckName;
                        }
                        else
                        {
                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.FiveCheckID, CheckHouseID = ApproveEntity.HouseID.ToString() });
                        }
                        #endregion
                    }
                    else if (appSet.FiveCheckID.Equals(NextCheckID))
                    {
                        #region 第五级
                        send.title = appSet.FiveCheckName + "审批通过";
                        result.ApplyStatus = "1";
                        result.NextCheckID = appSet.SixCheckID;
                        result.NextCheckName = appSet.SixCheckName;
                        if (string.IsNullOrEmpty(appSet.SixCheckID))
                        {
                            send.title = "申请单：" + ApproveEntity.ID.ToString() + "审批结束";
                            //表示是最后一级
                            IsEnd = true;
                            result.ApplyStatus = "3";
                            result.NextCheckID = "";// AppSet.OneCheckID;
                            result.NextCheckName = "";// AppSet.OneCheckName;
                        }
                        else
                        {
                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.SixCheckID, CheckHouseID = ApproveEntity.HouseID.ToString() });
                        }
                        #endregion
                    }
                    else if (appSet.SixCheckID.Equals(NextCheckID))
                    {
                        #region 第六级
                        send.title = appSet.SixCheckName + "审批通过";
                        result.ApplyStatus = "1";
                        result.NextCheckID = appSet.SevenCheckID;
                        result.NextCheckName = appSet.SevenCheckName;
                        if (string.IsNullOrEmpty(appSet.SevenCheckID))
                        {
                            send.title = "申请单：" + ApproveEntity.ID.ToString() + "审批结束";
                            //表示是最后一级
                            IsEnd = true;
                            result.ApplyStatus = "3";
                            result.NextCheckID = "";// AppSet.OneCheckID;
                            result.NextCheckName = "";// AppSet.OneCheckName;
                        }
                        else
                        {
                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.SevenCheckID, CheckHouseID = ApproveEntity.HouseID.ToString() });
                        }
                        #endregion
                    }
                    else if (appSet.SevenCheckID.Equals(NextCheckID))
                    {
                        #region 第七级
                        send.title = appSet.SevenCheckName + "审批通过";
                        result.ApplyStatus = "1";
                        result.NextCheckID = appSet.EightCheckID;
                        result.NextCheckName = appSet.EightCheckName;
                        if (string.IsNullOrEmpty(appSet.EightCheckID))
                        {
                            send.title = "申请单：" + ApproveEntity.ID.ToString() + "审批结束";
                            //表示是最后一级
                            IsEnd = true;
                            result.ApplyStatus = "3";
                            result.NextCheckID = "";// AppSet.OneCheckID;
                            result.NextCheckName = "";// AppSet.OneCheckName;
                        }
                        else
                        {
                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.EightCheckID, CheckHouseID = ApproveEntity.HouseID.ToString() });
                        }
                        #endregion
                    }
                    list.Add(result);
                    bus.setApplicationCheck(list, ty, log);
                    qyUser.Add(new QyUserEntity { UserID = ApproveEntity.ApplyID, WxName = ApproveEntity.ApplyName });
                    if (IsEnd)
                    {
                        #region 抄送审批角色和审批人
                        List<QyUserEntity> cQyU = new List<QyUserEntity>();
                        if (!string.IsNullOrEmpty(appSet.CopyCheck))
                        {
                            cQyU = q.QueryUserList(new QyUserEntity { CheckRole = appSet.CopyCheck });
                        }
                        foreach (var c in cQyU)
                        {
                            //添加申请单与审批人关系数据
                            if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = ApproveEntity.ID, CheckUserID = c.UserID, ApproveType = ApproveEntity.ApplyType }))
                            {
                                f.AddApproveCheck(new CargoApproveCheckEntity
                                {
                                    ApproveID = ApproveEntity.ID,
                                    CheckUserID = c.UserID,
                                    CheckName = c.WxName,
                                    CheckType = "1",
                                    ReadStatus = "1",
                                    ApproveType = ApproveEntity.ApplyType
                                }, log);
                            }
                            if (!copy.Contains(c.UserID))
                            {
                                copy += c.UserID + ",";
                            }
                        }
                        if (!string.IsNullOrEmpty(appSet.CopyUserID) && !string.IsNullOrEmpty(appSet.CopyCheckName))
                        {
                            string[] uS = appSet.CopyUserID.Split(',');
                            string[] uName = appSet.CopyUserName.Split(',');
                            if (uS.Length > 0)
                            {
                                for (int i = 0; i < uS.Length; i++)
                                {
                                    if (!string.IsNullOrEmpty(uS[i]))
                                    {
                                        //添加申请单与审批人关系数据
                                        if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = ApproveEntity.ID, CheckUserID = uS[i], ApproveType = ApproveEntity.ApplyType }))
                                        {
                                            f.AddApproveCheck(new CargoApproveCheckEntity
                                            {
                                                ApproveID = ApproveEntity.ID,
                                                CheckUserID = uS[i],
                                                CheckName = uName[i],
                                                CheckType = "1",
                                                ReadStatus = "1",
                                                ApproveType = ApproveEntity.ApplyType
                                            }, log);
                                        }
                                        if (!copy.Contains(uS[i]))
                                        {
                                            copy += uS[i] + ",";
                                        }
                                    }
                                }
                            }
                        }
                        #endregion
                        if (ApproveEntity.ApplyType.Equals("8"))
                        {
                            //客户资料审批结束，修改客户的状态 为可用 并修改透支额度为申请 额度
                            //轮胎外调申请审批
                            List<CargoApproveRelateEntity> aRelate = bus.QueryApproveThrowRelateList(new CargoApproveRelateEntity { ApproveID = ApproveEntity.ID, ApplyType = "8" });
                            if (aRelate.Count > 0)
                            {
                                CargoClientBus cBus = new CargoClientBus();
                                cBus.UpdateCargoClientBookCheck(new CargoClientEntity { ClientID = aRelate[0].RelateID, BookCheck = "1", LimitMoney = ApproveEntity.LimitMoney }, log);
                            }
                        }
                        else if (ApproveEntity.ApplyType.Equals("15"))
                        {
                            //优惠券申请审批结束，增加客户的优惠券数据
                            weiXinBus.AddCoupon(new List<WXCouponEntity> { new WXCouponEntity { ClientID = ApproveEntity.ClientID, Money = ApproveEntity.LimitMoney, UseStatus = "0", GainDate = DateTime.Now, StartDate = DateTime.Now, EndDate = DateTime.Now.AddDays(10) } }, log);
                        }
                    }
                    if (ApproveEntity.ApplyType.Equals("4"))
                    {
                        //加班申请审批
                        //send.title = "加班申请";
                        send.content = "<div></div><div>申请人：" + ApproveEntity.ApplyName + "</div><div>申请内容：" + ApproveEntity.Memo + "</div><div>加班时间：" + ApproveEntity.OStartTime.ToString("yyyy-MM-dd HH:mm") + "--" + ApproveEntity.OEndTime.ToString("yyyy-MM-dd HH:mm") + "</div><div>加班时长：" + ApproveEntity.OTime.ToString("F1") + "小时</div><div></div><div class=\"highlight\">请点击本通知进行审批！</div>";
                    }
                    else if (ApproveEntity.ApplyType.Equals("2"))
                    {
                        //轮胎外调申请审批
                        List<CargoApproveRelateEntity> aRelate = bus.QueryApproveThrowRelateList(new CargoApproveRelateEntity { ApproveID = ApproveEntity.ID, ApplyType = "2" });
                        int totalNum = 0; decimal totalCharge = 0.00M;
                        foreach (var it in aRelate)
                        {
                            totalNum += it.ThrowNum;
                            totalCharge += it.ThrowNum * it.ThrowCharge;
                        }

                        send.content = "<div></div><div>申请类型：轮胎外调</div><div>申请标题：" + ApproveEntity.Title + "</div><div>外调仓库：" + ApproveEntity.ThrowHouseName + " " + ApproveEntity.ClientName + "</div><div>外调数量：" + totalNum.ToString() + "条</div><div>外调金额：" + totalCharge.ToString("F2") + "元</div><div>审批人：" + QyUserInfo.UserName + "</div><div>审批意见：" + result.DenyReason + "</div><div></div><div class=\"highlight\">请点击本通知进行审批！</div>";
                    }
                    else if (ApproveEntity.ApplyType.Equals("8"))
                    {
                        send.content = "<div></div><div>申请类型：客户资料审批</div><div>申请标题：" + ApproveEntity.Title + "</div><div>申请内容：" + ApproveEntity.Memo + "</div><div>审批人：" + QyUserInfo.UserName + "</div><div>审批意见：" + result.DenyReason + "</div><div></div><div class=\"highlight\">请点击本通知进行审批！</div>";
                    }
                    else if (ApproveEntity.ApplyType.Equals("15"))
                    {
                        send.content = "<div></div><div>申请类型：优惠券审批</div><div>申请标题：" + ApproveEntity.Title + "</div><div>申请内容：" + ApproveEntity.Memo + "</div><div>审批人：" + QyUserInfo.UserName + "</div><div>审批意见：" + result.DenyReason + "</div><div></div><div class=\"highlight\">请点击本通知进行审批！</div>";
                    }
                    foreach (var it in qyUser)
                    {
                        try
                        {
                            send.toUser = it.UserID;
                            if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = ApproveEntity.ID, ApproveType = ApproveEntity.ApplyType, CheckUserID = it.UserID, CheckType = "0" }))
                            {
                                f.AddApproveCheck(new CargoApproveCheckEntity { ApproveID = ApproveEntity.ID, CheckUserID = it.UserID, CheckName = it.WxName, ReadStatus = "1", CheckType = "0", ApproveType = ApproveEntity.ApplyType }, log);
                            }
                            WxQYSendHelper.QiyePushInfo(send);
                            Common.WriteTextLog("推送成功：" + it.WxName + ApproveEntity.ID.ToString());
                        }
                        catch (ApplicationException ex)
                        {
                            continue;
                        }
                    }
                    if (!string.IsNullOrEmpty(copy))
                    {
                        copy = copy.Substring(0, copy.Length - 1);
                        try
                        {
                            send.toUser = copy;
                            WxQYSendHelper.QiyePushInfo(send);
                        }
                        catch (Exception ex)
                        {
                            msg.Result = true;
                        }
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
        ERR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 查询移库单数据
        /// </summary>
        public void QueryMoveOrderData()
        {
            CargoOrderBus bus = new CargoOrderBus();
            string MoveNo = Convert.ToString(Request["MoveNo"]);
            string MoveStatus = Convert.ToString(Request["MoveStatus"]);
            CargoMoveOrderEntity entity = new CargoMoveOrderEntity();
            entity.OldHouseID = QyUserInfo.HouseID.ToString();
            entity.MoveStatus = MoveStatus;
            entity.MoveNo = MoveNo;
            if (QyUserInfo.IsHeadHouse == 1)
            {
                entity.NewHouseName = QyUserInfo.HeadHouseName;
            }
            List<CargoMoveOrderEntity> result = bus.QueryMoveOrderList(entity);
            String json = JSON.Encode(result);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 扫描标签标记移库
        /// </summary>
        public void ScanMoveOrderOutOK()
        {
            CargoProductBus bus = new CargoProductBus();
            CargoOrderBus order = new CargoOrderBus();
            ErrMessage result = new ErrMessage(); result.Message = "保存成功"; result.Result = true;
            string OrderNo = Convert.ToString(Request["MoveNo"]);//移库订单号
            string TagCode = Convert.ToString(Request["TagCode"]);//产品唯一编码标签码
            string[] tArr = TagCode.Split('=');
            if (tArr.Length > 1)
            {
                TagCode = tArr[1];
            }
            else
            {
                string[] gtc = TagCode.Split('|');
                if (gtc.Length > 1)
                {
                    string tc = gtc[5];
                    TagCode = tc;
                }
            }
            string UserID = QyUserInfo.UserID;
            if (string.IsNullOrEmpty(OrderNo))
            {
                result.Result = false;
                result.Message = "移库单号不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                result.Result = false;
                result.Message = "标签编码不能为空";
                goto ERR;
            }
            CargoProductTagEntity tag = bus.QueryTagByTagCode(new CargoProductTagEntity { TagCode = TagCode });
            if (string.IsNullOrEmpty(tag.TagCode))
            {
                result.Result = false;
                result.Message = "标签编码不存在";
                goto ERR;
            }
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "移库管理";
            log.NvgPage = "扫描移库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "U";
            log.Status = "0";
            #region 验证
            if (bus.IsExistCargoProductTag(new CargoProductTagEntity { TagCode = TagCode, OutCargoStatus = "1" }))
            {
                result.Result = false;
                result.Message = "标签编码：" + TagCode + "已经出库，不能移库";
                goto ERR;
            }
            //这里可以拿 到ContainerID ContainerCode
            CargoProductEntity proTag = bus.QueryProductInfoByTagCode(new CargoProductTagEntity { TagCode = TagCode });
            if (proTag.ProductID.Equals(0))
            {
                result.Result = false;
                result.Message = "标签编码不存在";
                goto ERR;
            }
            if (proTag.MoveStatus.Equals("0"))
            {
                result.Result = false;
                result.Message = "标签编码:" + TagCode + "重复扫描";
                goto ERR;
            }
            List<CargoMoveOrderGoodsEntity> orderTag = order.QueryMoveOrderGoodsList(new CargoMoveOrderGoodsEntity { MoveNo = OrderNo, ProductID = tag.ProductID, ContainerID = proTag.ContainerID });
            if (orderTag.Count <= 0)
            {
                result.Result = false;
                result.Message = "移库单不存在该产品ID";
                goto ERR;
            }
            bool existContainerCode = false;
            foreach (var o in orderTag)
            {
                if (o.ContainerID.Equals(proTag.ContainerID))
                {
                    existContainerCode = true;
                    break;
                }
            }
            if (!existContainerCode)
            {
                result.Result = false;
                result.Message = "该标签编码不在移库列表";
                goto ERR;
            }
            CargoInterfaceBus inter = new CargoInterfaceBus();
            if (!inter.IsSetOutMoveCargoOK(new CargoProductTagEntity { MoveOrderNo = OrderNo, ProductID = tag.ProductID, ContainerID = proTag.ContainerID }))
            {
                result.Result = false;
                result.Message = "该移库单上的该产品已扫描完成";
                goto ERR;
            }
            #endregion

            inter.SetProductTagMove(new CargoProductTagEntity { MoveOrderNo = OrderNo, ProductID = tag.ProductID, TagCode = TagCode, MoveStatus = "0", OutCargoStatus = "1", OutCargoTime = DateTime.Now, OutCargoOperID = UserID }, log);
            //判断移库扫描的状态
            CargoMoveOrderEntity mOrder = order.QueryMoveOrderEntity(new CargoMoveOrderEntity { MoveNo = OrderNo, MoveStatus = "0" });
            if (mOrder.ScanNum.Equals(1))
            {
                //修改移库状态为移库中
                order.UpdateMoveOrderStatus(new CargoMoveOrderEntity { MoveNo = OrderNo, MoveStatus = "3" }, log);
            }
            if (mOrder.MoveNum.Equals(mOrder.ScanNum))
            {
                //修改移库状态为全扫描
                order.UpdateMoveOrderStatus(new CargoMoveOrderEntity { MoveNo = OrderNo, MoveStatus = "1" }, log);
            }
            //查询移库单明细和已扫描数量
            List<CargoMoveOrderGoodsEntity> goods = inter.QueryMoveOrderGoodsList(new CargoMoveOrderEntity { MoveNo = OrderNo });
            string g = JSON.Encode(goods);
            result.Message = g;
        ERR:
            //JSON
            String json = JSON.Encode(result);
            Response.Write(json);

        }
        /// <summary>
        /// 扫描标签移库入库
        /// </summary>
        public void ScanMoveOrderInCargo()
        {
            string ContainerCode = Convert.ToString(Request["ContainerCode"]);
            string TagCode = Convert.ToString(Request["TagCode"]);
            string[] tArr = TagCode.Split('=');
            if (tArr.Length > 1)
            {
                TagCode = tArr[1];
            }
            else
            {
                string[] gtc = TagCode.Split('|');
                if (gtc.Length > 1)
                {
                    string tc = gtc[5];
                    TagCode = tc;
                }
            }
            string UserID = QyUserInfo.UserID;

            CargoProductBus bus = new CargoProductBus();
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoHouseBus house = new CargoHouseBus();
            CargoOrderBus order = new CargoOrderBus();
            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "移库管理";
            log.NvgPage = "扫描入库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "A";
            log.Status = "0";
            #region 通用数据检验

            if (string.IsNullOrEmpty(ContainerCode))
            {
                msg.Result = false;
                msg.Message = "货位代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                msg.Result = false;
                msg.Message = "产品编码不能为空";
                goto ERR;
            }
            CargoContainerEntity contain = house.QueryContainerEntityByCode(ContainerCode, QyUserInfo.HouseID);
            if (contain == null || contain.ContainerID.Equals(0))
            {
                msg.Result = false;
                msg.Message = "货位代码不存在";
                goto ERR;
            }
            CargoProductTagEntity tag = bus.QueryTagByTagCode(new CargoProductTagEntity { TagCode = TagCode });
            if (string.IsNullOrEmpty(tag.TagCode))
            {
                msg.Result = false;
                msg.Message = "标签编码不存在";
                goto ERR;
            }
            if (string.IsNullOrEmpty(tag.MoveOrderNo))
            {
                msg.Result = false;
                msg.Message = "非移库产品标签";
                goto ERR;
            }
            if (tag.OutCargoStatus.Equals("1") && !string.IsNullOrEmpty(tag.OrderNo))
            {
                msg.Result = false;
                msg.Message = "已出库标签,不能移库,订单号:" + tag.OrderNo;
                goto ERR;
            }
            if (string.IsNullOrEmpty(tag.MoveStatus))
            {
                msg.Result = false;
                msg.Message = "非移库标签，请核对:" + tag.TagCode;
                goto ERR;
            }
            if (tag.MoveStatus.Equals("1"))
            {
                msg.Result = false;
                msg.Message = "标签已入库，请勿重复入库";
                goto ERR;
            }
            if (contain.ContainerID.Equals(tag.ContainerID))
            {
                msg.Result = false;
                msg.Message = "重复扫描";
                goto ERR;
            }
            CargoMoveOrderEntity mOrderh = order.QueryMoveOrderByMoveNo(new CargoMoveOrderEntity { MoveNo = tag.MoveOrderNo });
            if (mOrderh.NewHouseID != QyUserInfo.HouseID)
            {
                msg.Result = false;
                msg.Message = "仓库代码与移库单号不一致";
                goto ERR;
            }
            #endregion
            //查询原仓库的产品信息
            CargoProductEntity entity = bus.QueryProductInfoByID(tag.ProductID);
            entity.OPID = UserID;
            entity.HouseID = QyUserInfo.HouseID;//目标仓库ID
            entity.ContainerCode = contain.ContainerCode;//目标货位
            entity.ContainerID = contain.ContainerID;
            entity.InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();
            entity.InCargoStatus = "1";
            entity.OperaType = "1";
            entity.Numbers = 1;//数量
            entity.SourceOrderNo = tag.MoveOrderNo;//移库单号
            entity.TagCode = TagCode;//标签
            entity.ParentID = tag.ContainerID;//旧货位ID
            if (contain.HouseID == 9)
            {
                string CargoDepart = (house.QueryCargoHouse(new CargoHouseEntity { HouseID = contain.HouseID })).CargoDepart;
                entity.ProductName = string.IsNullOrEmpty(CargoDepart) ? "好来运迪乐泰广州仓业务部" : CargoDepart;
            }

            //仓库同步缓存
            CargoProductEntity syncProduct = house.SyncTypeProduct(tag.ProductID.ToString());
            //34 马牌  1 同步马牌  2 同步全部品牌
            if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
            {
                RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
            }
            //主仓缓存更改
            if (house.IsAddCaching(syncProduct.HouseID, syncProduct.TypeID))
            {
                RedisHelper.HashSet("HCYCHouseStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
            }
            inter.ScanMoveOrderInCargo(entity, log);

            //判断移库扫描的状态
            CargoMoveOrderEntity mOrder = order.QueryMoveOrderEntity(new CargoMoveOrderEntity { MoveNo = tag.MoveOrderNo, MoveStatus = "1" });
            if (mOrder.ScanNum.Equals(1))
            {
                //修改移库状态为移库中
                order.UpdateMoveOrderStatus(new CargoMoveOrderEntity { MoveNo = tag.MoveOrderNo, MoveStatus = "4" }, log);
            }
            if (mOrder.MoveNum.Equals(mOrder.ScanNum))
            {
                //修改移库状态为全扫描
                order.UpdateMoveOrderStatus(new CargoMoveOrderEntity { MoveNo = tag.MoveOrderNo, MoveStatus = "2" }, log);
            }
            msg.Message = TagCode + " " + entity.Batch;
        ERR:
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 查询要出库的订单数据
        /// </summary>
        public void QueryOrderData()
        {
            CargoOrderBus bus = new CargoOrderBus();
            CargoOrderEntity entity = new CargoOrderEntity();
            entity.OrderNo = Convert.ToString(Request["OrderNo"]);
            entity.OrderModel = Convert.ToString(Request["OrderModel"]);
            entity.AwbStatus = "0";
            if (!string.IsNullOrEmpty(Convert.ToString(Request["HouseID"])))
            {
                entity.HouseID = Convert.ToInt32(Request["HouseID"]);

            }
            else
            {
                entity.HouseID = QyUserInfo.HouseID;
            }
            if (QyUserInfo.HouseID.Equals(9))
            {
                entity.BelongHouse = "0";
                entity.TrafficType = "0";
            }
            entity.StartDate = DateTime.Now.AddDays(-Convert.ToInt32(Request["StartDate"]));
            entity.EndDate = DateTime.Now.AddDays(1);
            if (QyUserInfo.IsHeadHouse == 1)
            {
                entity.OutHouseName = QyUserInfo.HeadHouseName;
            }
            List<CargoOrderEntity> result = bus.QueryOrder(entity);
            //20241011增加的逻辑 如果是商城小程序订单，没有支付完成，且不是货到付款，则不显示 20250804 增加次日达的也不显示
            result = result.SkipWhile(c => !string.IsNullOrEmpty(c.WXOrderNo) && !c.CheckStatus.Equals("1") && !c.CheckOutType.Equals("3") && !c.ThrowGood.Equals("23")).ToList();
            String json = JSON.Encode(result);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 扫描标签出库
        /// </summary>
        public void ScanOrderOutOK()
        {
            CargoProductBus bus = new CargoProductBus();
            CargoOrderBus order = new CargoOrderBus();
            ErrMessage result = new ErrMessage(); result.Message = "保存成功"; result.Result = true;
            string OrderNo = Convert.ToString(Request["OrderNo"]);//出库订单号
            string TagCode = Convert.ToString(Request["TagCode"]);//产品唯一编码标签码
            string[] tArr = TagCode.Split('=');
            if (tArr.Length > 1)
            {
                TagCode = tArr[1];
            }
            else
            {
                string[] gtc = TagCode.Split('|');
                if (gtc.Length > 1)
                {
                    string tc = gtc[5];
                    TagCode = tc;
                }
            }
            string UserID = QyUserInfo.UserID;
            if (string.IsNullOrEmpty(OrderNo))
            {
                result.Result = false;
                result.Message = "出库订单号不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                result.Result = false;
                result.Message = "标签编码不能为空";
                goto ERR;
            }
            CargoProductTagEntity tag = bus.QueryTagByTagCode(new CargoProductTagEntity { TagCode = TagCode });
            if (string.IsNullOrEmpty(tag.TagCode))
            {
                result.Result = false;
                result.Message = "标签编码不存在";
                goto ERR;
            }
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "扫描出库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "U";
            log.Status = "0";
            #region 验证
            if (bus.IsExistCargoProductTag(new CargoProductTagEntity { TagCode = TagCode, OutCargoStatus = "1" }))
            {
                result.Result = false;
                result.Message = "标签编码：" + TagCode + "已经出库";
                goto ERR;
            }
            CargoProductEntity proTag = bus.QueryProductInfoByTagCode(new CargoProductTagEntity { TagCode = TagCode });
            if (proTag.ProductID.Equals(0))
            {
                result.Result = false;
                result.Message = "标签编码不存在";
                goto ERR;
            }
            if (proTag.MoveStatus == "0")
            {
                result.Result = false;
                result.Message = "该标签正在移库无法出库";
                goto ERR;
            }
            if (order.IsModelOrderInfo(OrderNo))
            {
                result.Result = false;
                result.Message = "该订单为退货单，无需出库";
                goto ERR;
            }
            List<CargoOrderGoodsEntity> orderTag = order.QueryOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = OrderNo, ProductID = tag.ProductID, ContainerCode = proTag.ContainerCode });
            if (orderTag.Count <= 0)
            {
                result.Result = false;
                result.Message = "该订单不存在该产品ID";
                goto ERR;
            }
            bool existContainerCode = false;
            foreach (var o in orderTag)
            {
                if (o.ContainerCode.Equals(proTag.ContainerCode))
                {
                    existContainerCode = true;
                    break;
                }
            }
            if (!existContainerCode)
            {
                result.Result = false;
                result.Message = "该标签编码不在出库列表";
                goto ERR;
            }
            CargoInterfaceBus inter = new CargoInterfaceBus();
            if (!inter.IsSetOutCargoOK(new CargoProductTagEntity
            {
                OrderNo = OrderNo,
                ProductID = tag.ProductID,
                ContainerID = proTag.ContainerID,
                ContainerCode = proTag.ContainerCode,
                BundleNum = proTag.PackageNum.Equals(0) ? 1 : proTag.PackageNum
            }))
            {
                //该订单和该产品ID已经出库完成，查找相同运单 号的其它订单上要出库的产品
                List<CargoProductTagEntity> orderList = inter.QueryScanOutCargoOrderList(new CargoProductTagEntity { OrderNo = OrderNo, ProductID = tag.ProductID });
                if (orderList.Count <= 0)
                {
                    result.Result = false;
                    result.Message = "该订单已出库完成";
                    goto ERR;
                }
                bool AOut = false;
                foreach (var it in orderList)
                {
                    if (it.OrderNo.Equals(OrderNo)) { continue; }
                    if (inter.IsSetOutCargoOK(new CargoProductTagEntity
                    {
                        OrderNo = OrderNo,
                        ProductID = tag.ProductID,
                        ContainerID = proTag.ContainerID,
                        ContainerCode = proTag.ContainerCode,
                        BundleNum = proTag.PackageNum.Equals(0) ? 1 : proTag.PackageNum
                    }))
                    {
                        AOut = true;
                        OrderNo = it.OrderNo;
                        break;
                    }
                }
                if (!AOut)
                {
                    result.Result = false;
                    result.Message = "该运单下所有订单该产品已出库完成";
                    goto ERR;
                }
            }
            #endregion

            inter.SetProductTag(new CargoProductTagEntity { OrderNo = OrderNo, OutCargoStatus = "1", OutCargoOperID = UserID, ProductID = tag.ProductID, TagCode = TagCode }, log);
            //查询移库单明细和已扫描数量
            List<CargoContainerShowEntity> goods = order.QueryUnScanProductTag(new CargoOrderEntity { OrderNo = OrderNo });
            string g = JSON.Encode(goods);
            result.Message = g;

            try
            {
                log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                log.Moudle = "订单管理";
                log.NvgPage = "订单状态跟踪";
                log.UserID = QyUserInfo.UserID;
                log.Status = "0";
                log.Operate = "U";
                //如果存在产品编码，根据产品编码查询捆包数量
                CargoProductSpecEntity specEntity = new CargoProductSpecEntity();
                if (!string.IsNullOrEmpty(proTag.ProductCode))
                {
                    specEntity = bus.GetProductSpecByProductCode(proTag.ProductCode);
                }
                //查询订单信息，修改订单状态和商城订单状态 ，推送订单状态通知
                CargoOrderEntity orderEn = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = OrderNo });
                if (orderEn.Piece.Equals(1) || orderEn.Piece.Equals(specEntity.BundleNum))
                {
                    #region 出库完成
                    //出库完成
                    order.SaveOrderStatus(new CargoOrderStatusEntity
                    {
                        OrderID = orderEn.OrderID,
                        OrderNo = orderEn.OrderNo,
                        OrderStatus = "2",
                        WXOrderNo = orderEn.WXOrderNo,
                        OP_ID = QyUserInfo.UserID,
                        OP_Name = QyUserInfo.UserName,
                        OP_DATE = DateTime.Now,
                        DetailInfo = ""
                    }, log);

                    //如果前置仓不为0且订单号不为空，则同步更新前置仓关联订单的出库状态
                    if (!orderEn.OrignHouseID.Equals(0) && !string.IsNullOrEmpty(orderEn.OpenOrderNo))
                    {
                        order.SaveOrderStatus(new CargoOrderStatusEntity
                        {
                            OrderNo = orderEn.OpenOrderNo,
                            OrderStatus = "2",
                            WXOrderNo = orderEn.WXOrderNo,
                            OP_ID = "2029",
                            OP_Name = UserID,
                            OP_DATE = DateTime.Now,
                            DetailInfo = "共享仓同步出库"
                        }, log);
                    }

                    #region 推送客户通知
                    //if (!string.IsNullOrEmpty(orderEn.WXOrderNo))
                    //{
                    //    string title = string.Empty;
                    //    switch (orderEn.HouseID)
                    //    {
                    //        case 1: title = "尊敬的湖南迪乐泰客户，您的订单已出库！"; break;
                    //        case 3: title = "尊敬的湖北迪乐泰客户，您的订单已出库！"; break;
                    //        case 11: title = "尊敬的西北迪乐泰客户，您的订单已出库！"; break;
                    //        case 12: title = "尊敬的梅州迪乐泰客户，您的订单已出库！"; break;
                    //        case 9: title = "尊敬的客户，您的订单已出库！"; break;
                    //        case 34: title = "尊敬的海南迪乐泰客户，您的订单已出库！"; break;
                    //        case 46: title = "尊敬的四川迪乐泰客户，您的订单已出库！"; break;
                    //        default: break;
                    //    }
                    //    if (string.IsNullOrEmpty(title)) { goto ERR; }
                    //    List<WXOrderManagerEntity> wxOrderList = order.QueryWeixinOrderInfo(new WXOrderManagerEntity { OrderNo = orderEn.WXOrderNo });
                    //    if (wxOrderList.Count > 0)
                    //    {
                    //        CargoHouseBus house = new CargoHouseBus();
                    //        CargoHouseEntity hEnt = house.QueryCargoHouseByID(orderEn.HouseID);
                    //        CargoStaticBus sb = new CargoStaticBus();
                    //        CargoPushDataEntity push = new CargoPushDataEntity();
                    //        push.PushTitle = title;
                    //        push.OrderInfo = wxOrderList[0].Title;
                    //        push.TotalCharge = wxOrderList[0].TotalCharge;
                    //        push.WXOrderNo = orderEn.WXOrderNo;
                    //        push.wxOpenID = wxOrderList[0].wxOpenID;
                    //        push.TemplateID = "heDfICkOgVf3gfod4kM6CL4MiK4YikrFGm6k9QgUZ8A";
                    //        push.HouseID = orderEn.HouseID;
                    //        push.HouseName = hEnt.Name;
                    //        push.PushType = "0";
                    //        push.PushStatus = "0";
                    //        sb.AddPushData(push, log);
                    //    }
                    //}
                    #endregion
                    #endregion
                }
                else
                {
                    if (!memClient.KeyExists(OrderNo))
                    {
                        //已经出库的数量
                        //int outN = inter.GetOutCargoNum(new CargoProductTagEntity { OrderNo = OrderNo });
                        int outN = 0;
                        if (!string.IsNullOrEmpty(proTag.ProductCode) && specEntity.BundleNum > 1)
                        {
                            outN = inter.GetOutCargoNumByBundle(new CargoProductTagEntity { OrderNo = OrderNo });
                        }
                        else
                        {
                            outN = inter.GetOutCargoNum(new CargoProductTagEntity { OrderNo = OrderNo });
                        }
                        if (outN < orderEn.Piece)
                        {
                            if (orderEn.AwbStatus.Equals("0") || orderEn.AwbStatus.Equals("6"))
                            {
                                //未出库完成 加入缓存，订单状态为正在出库中
                                order.SaveOrderStatus(new CargoOrderStatusEntity
                                {
                                    OrderID = orderEn.OrderID,
                                    OrderNo = orderEn.OrderNo,
                                    OrderStatus = "1",
                                    WXOrderNo = orderEn.WXOrderNo,
                                    OP_ID = UserID,
                                    OP_Name = QyUserInfo.UserName,
                                    OP_DATE = DateTime.Now,
                                    DetailInfo = ""
                                }, log);
                            }
                            memClient.Add(OrderNo, outN, 3600 * 48);
                        }
                        else
                        {
                            #region 出库完成
                            //出库完成
                            order.SaveOrderStatus(new CargoOrderStatusEntity
                            {
                                OrderID = orderEn.OrderID,
                                OrderNo = orderEn.OrderNo,
                                OrderStatus = "2",
                                WXOrderNo = orderEn.WXOrderNo,
                                OP_ID = UserID,
                                OP_Name = QyUserInfo.UserName,
                                OP_DATE = DateTime.Now,
                                DetailInfo = ""
                            }, log);

                            //如果前置仓不为0且订单号不为空，则同步更新前置仓关联订单的出库状态
                            if (!orderEn.OrignHouseID.Equals(0) && !string.IsNullOrEmpty(orderEn.OpenOrderNo))
                            {
                                order.SaveOrderStatus(new CargoOrderStatusEntity
                                {
                                    OrderNo = orderEn.OpenOrderNo,
                                    OrderStatus = "2",
                                    WXOrderNo = orderEn.WXOrderNo,
                                    OP_ID = "2029",
                                    OP_Name = UserID,
                                    OP_DATE = DateTime.Now,
                                    DetailInfo = "共享仓同步出库"
                                }, log);
                            }
                            #region 推送客户通知
                            //if (!string.IsNullOrEmpty(orderEn.WXOrderNo))
                            //{
                            //    string title = string.Empty;
                            //    switch (orderEn.HouseID)
                            //    {
                            //        case 1: title = "尊敬的湖南迪乐泰客户，您的订单已出库！"; break;
                            //        case 3: title = "尊敬的湖北迪乐泰客户，您的订单已出库！"; break;
                            //        case 11: title = "尊敬的西北迪乐泰客户，您的订单已出库！"; break;
                            //        case 12: title = "尊敬的梅州迪乐泰客户，您的订单已出库！"; break;
                            //        case 9: title = "尊敬的客户，您的订单已出库！"; break;
                            //        case 34: title = "尊敬的海南迪乐泰客户，您的订单已出库！"; break;
                            //        case 46: title = "尊敬的四川迪乐泰客户，您的订单已出库！"; break;
                            //        default: break;
                            //    }
                            //    if (string.IsNullOrEmpty(title))
                            //    {
                            //        goto ERR;
                            //    }
                            //    List<WXOrderManagerEntity> wxOrderList = order.QueryWeixinOrderInfo(new WXOrderManagerEntity { OrderNo = orderEn.WXOrderNo });
                            //    if (wxOrderList.Count > 0)
                            //    {
                            //        CargoHouseBus house = new CargoHouseBus();
                            //        CargoHouseEntity hEnt = house.QueryCargoHouseByID(orderEn.HouseID);
                            //        CargoStaticBus sb = new CargoStaticBus();
                            //        CargoPushDataEntity push = new CargoPushDataEntity();
                            //        push.PushTitle = title;
                            //        push.OrderInfo = wxOrderList[0].Title;
                            //        push.TotalCharge = wxOrderList[0].TotalCharge;
                            //        push.WXOrderNo = orderEn.WXOrderNo;
                            //        push.wxOpenID = wxOrderList[0].wxOpenID;
                            //        push.TemplateID = "heDfICkOgVf3gfod4kM6CL4MiK4YikrFGm6k9QgUZ8A";
                            //        push.HouseID = orderEn.HouseID;
                            //        push.HouseName = hEnt.Name;
                            //        push.PushType = "0";
                            //        push.PushStatus = "0";
                            //        sb.AddPushData(push, log);
                            //    }
                            //}
                            #endregion
                            #endregion
                            memClient.Delete(OrderNo);
                        }
                    }
                    else
                    {
                        //如果已经存在缓存，表示不是第一次扫描，要判断扫描出库数量与订单数量是否一致，一致则推送出库通知给客户
                        int OutNum = (int)memClient.Get(OrderNo);
                        if (specEntity.BundleNum > 1)
                        {
                            OutNum += specEntity.BundleNum;
                        }
                        else
                        {
                            OutNum++;
                        }
                        //OutNum++;
                        memClient.Delete(OrderNo);
                        if (OutNum.Equals(orderEn.Piece))
                        {
                            #region 出库完成
                            order.SaveOrderStatus(new CargoOrderStatusEntity
                            {
                                OrderID = orderEn.OrderID,
                                OrderNo = orderEn.OrderNo,
                                OrderStatus = "2",
                                WXOrderNo = orderEn.WXOrderNo,
                                OP_ID = UserID,
                                OP_Name = QyUserInfo.UserName,
                                OP_DATE = DateTime.Now,
                                DetailInfo = ""
                            }, log);

                            //如果前置仓不为0且订单号不为空，则同步更新前置仓关联订单的出库状态
                            if (!orderEn.OrignHouseID.Equals(0) && !string.IsNullOrEmpty(orderEn.OpenOrderNo))
                            {
                                order.SaveOrderStatus(new CargoOrderStatusEntity
                                {
                                    OrderNo = orderEn.OpenOrderNo,
                                    OrderStatus = "2",
                                    WXOrderNo = orderEn.WXOrderNo,
                                    OP_ID = "2029",
                                    OP_Name = UserID,
                                    OP_DATE = DateTime.Now,
                                    DetailInfo = "共享仓同步出库"
                                }, log);
                            }
                            #region 推送客户通知
                            //if (!string.IsNullOrEmpty(orderEn.WXOrderNo))
                            //{
                            //    string title = string.Empty;
                            //    switch (orderEn.HouseID)
                            //    {
                            //        case 1: title = "尊敬的湖南迪乐泰客户，您的订单已出库！"; break;
                            //        case 3: title = "尊敬的湖北迪乐泰客户，您的订单已出库！"; break;
                            //        case 11: title = "尊敬的西北迪乐泰客户，您的订单已出库！"; break;
                            //        case 12: title = "尊敬的梅州迪乐泰客户，您的订单已出库！"; break;
                            //        case 9: title = "尊敬的客户，您的订单已出库！"; break;
                            //        case 34: title = "尊敬的海南迪乐泰客户，您的订单已出库！"; break;
                            //        case 46: title = "尊敬的四川迪乐泰客户，您的订单已出库！"; break;
                            //        default: break;
                            //    }
                            //    if (string.IsNullOrEmpty(title))
                            //    {
                            //        goto ERR;
                            //    }
                            //    List<WXOrderManagerEntity> wxOrderList = order.QueryWeixinOrderInfo(new WXOrderManagerEntity { OrderNo = orderEn.WXOrderNo });
                            //    if (wxOrderList.Count > 0)
                            //    {
                            //        CargoHouseBus house = new CargoHouseBus();
                            //        CargoHouseEntity hEnt = house.QueryCargoHouseByID(orderEn.HouseID);
                            //        CargoStaticBus sb = new CargoStaticBus();
                            //        CargoPushDataEntity push = new CargoPushDataEntity();
                            //        push.PushTitle = title;
                            //        push.OrderInfo = wxOrderList[0].Title;
                            //        push.TotalCharge = wxOrderList[0].TotalCharge;
                            //        push.WXOrderNo = orderEn.WXOrderNo;
                            //        push.wxOpenID = wxOrderList[0].wxOpenID;
                            //        push.TemplateID = "heDfICkOgVf3gfod4kM6CL4MiK4YikrFGm6k9QgUZ8A";
                            //        push.HouseID = orderEn.HouseID;
                            //        push.HouseName = hEnt.Name;
                            //        push.PushType = "0";
                            //        push.PushStatus = "0";
                            //        sb.AddPushData(push, log);
                            //    }
                            //}
                            #endregion
                            #endregion
                        }
                        else
                        {
                            memClient.Add(OrderNo, OutNum, 3600 * 48);
                        }
                    }
                }
            }
            catch (Exception)
            {
                goto ERR;
            }
        ERR:
            //JSON
            String json = JSON.Encode(result);
            Response.Write(json);
        }
        /// <summary>
        /// 马牌 二维码扫描入库
        /// </summary>
        public void ScanQRCodeInCargo()
        {
            string ContainerCode = Convert.ToString(Request["ContainerCode"]);//货位代码
            //string ContainerCode = "B01-05-01SHL";
            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;

            string QRcode = Convert.ToString(Request["TagCode"]);
            //string QRcode = "QRE0223001045";
            string[] tArr = QRcode.Split('=');
            if (tArr.Length > 1)
            {
                QRcode = tArr[1];
            }
            string QrText = Convert.ToString(Request["QrText"]);
            //string QRcode = "QRB0002138001";
            string UserID = QyUserInfo.UserID;
            string ProductName = "马牌轮胎";//产品名称
            string GoodsCode = string.Empty; ;//货品代码
            int HouseID = QyUserInfo.HouseID;//仓库代码ID
            int TypeID = 34;//产品类型ID
            string Specs = string.Empty; ;//规格
            string Figure = string.Empty;//花纹

            string Model = string.Empty; ;//型号
            string Batch = string.Empty; ;//周期
            string TagCode = string.IsNullOrEmpty(QrText) ? QRcode : QrText;//产品唯一编码标签码
            //if (!TagCode.ToUpper().Contains("QR"))
            //{
            //    msg.Result = false;
            //    msg.Message = "请先扫描二维码";
            //    goto ERR;

            //}
            string LoadIndex = string.Empty; ;//载重指数
            string SpeedLevel = string.Empty; ;//速度级别
            string Born = "0";//生产地 0：国产1：进口
            string Assort = "";//OER  REP 胎
            string TyreCode = string.Empty; ;//轮胎编码
            string InCargoNum = "1";//入库数量
            string Source = "14";//产品来源
            string SourceOrderNo = string.Empty; ;//工厂订单号
            string BelongMonth = DateTime.Now.ToString("yyyyMM");//订单归属月
            string OrderType = "0";//订单类型ID
            string HLYReturnID = string.Empty;//好来运ID
            CargoProductBus bus = new CargoProductBus();
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoHouseBus house = new CargoHouseBus();
            CargoOrderBus order = new CargoOrderBus();
            #region 验证
            CargoContainerEntity contain = house.QueryContainerEntityByCode(ContainerCode, HouseID);
            if (contain == null || contain.ContainerID.Equals(0))
            {
                msg.Result = false;
                msg.Message = "货位代码不存在";
                goto ERR;
            }
            if (bus.IsExistCargoProductTag(new CargoProductTagEntity { TagCode = TagCode }))
            {
                msg.Result = false;
                msg.Message = "已经存在相同的产品编码：" + TagCode;
                goto ERR;
            }
            #endregion
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "产品管理";
            log.NvgPage = "扫描入库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "A";
            log.Status = "0";
            //调用马牌接口查询轮胎数据
            TimeSpan ts = DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0);
            string tms = Convert.ToInt64(ts.TotalSeconds).ToString();
            string sign = string.Empty;
            //二维码转条码 通过扫描轮胎上二维码查询该条轮胎具体信息

            string ss = "QRcode=" + QRcode + "&appKey=" + Common.GetContiappKey() + "&noise=" + Common.GetContinoise() + "&timestamp=" + tms + "&appSecret=" + Common.GetContiappSecret();
            if (!QRcode.ToUpper().Contains("R"))
            {
                ss = "appKey=" + Common.GetContiappKey() + "&barcodes=%5B" + QRcode + "%5D" + "&noise=" + Common.GetContinoise() + "&timestamp=" + tms + "&appSecret=" + Common.GetContiappSecret();
            }
            string reValue = string.Empty;
            //MD5加密
            using (MD5 md5Hash = MD5.Create())
            {
                sign = Common.GetMd5Hash(md5Hash, ss);
            }
            NameValueCollection nvc = new NameValueCollection();
            nvc.Add("appKey", Common.GetContiappKey());
            nvc.Add("noise", Common.GetContinoise());
            nvc.Add("timestamp", tms);
            nvc.Add("sign", sign);
            if (!QRcode.ToUpper().Contains("R"))
            {
                nvc.Add("barcodes", "%5B" + QRcode + "%5D");
                reValue = wxHttpUtility.PostForm("https://contiid.continental-tires.cn/api/2.0/TTP/getBarcodeInfo", nvc, null);
                ArrayList GridRows = (ArrayList)JSON.Decode("[" + reValue + "]");
                foreach (Hashtable item in GridRows)
                {
                    //数据返回正确
                    if (Convert.ToString(item["code"]).Equals("1000"))
                    {
                        ArrayList datalit = (ArrayList)JSON.Decode("[" + JSON.Encode(item["data"]) + "]");
                        foreach (Hashtable ri in datalit)
                        {
                            ArrayList datalitt = (ArrayList)JSON.Decode("[" + JSON.Encode(ri["" + QRcode + ""]) + "]");
                            foreach (Hashtable rit in datalitt)
                            {
                                string[] description = Convert.ToString(rit["Description"]).Split(' ');
                                for (int i = 2; i < description.Length; i++)
                                {
                                    Figure += description[i];//花纹
                                }
                                Specs = description[0];
                                string loadSpeed = description[1].Replace("(", "").Replace(")", "");
                                LoadIndex = loadSpeed.Substring(0, loadSpeed.Length - 1);
                                SpeedLevel = loadSpeed.Substring(loadSpeed.Length - 1);
                                TyreCode = Convert.ToString(rit["barcode"]);
                                GoodsCode = Convert.ToString(rit["material"]);
                                if (GoodsCode.Length > 6)
                                {
                                    GoodsCode = GoodsCode + "0000";
                                }
                                else if (GoodsCode.Length == 5)
                                {
                                    GoodsCode = "0" + GoodsCode + "0000";
                                }
                                Batch = Convert.ToString(rit["DOT"]);
                                string singleBrand = Convert.ToString(rit["brand"]);
                                if (singleBrand.ToUpper().Contains("VIKING"))
                                {
                                    TypeID = 345;
                                    ProductName = "维京轮胎";
                                }
                            }
                        }
                    }
                    else
                    {
                        msg.Result = false;
                        msg.Message = Convert.ToString(item["code"].ToString() + " " + item["data"].ToString());
                        goto ERR;
                    }
                }
            }
            else
            {
                nvc.Add("QRcode", QRcode);
                //二维码转条码 接口
                reValue = wxHttpUtility.PostForm("https://contiid.continental-tires.cn/api/2.0/TTP/QRgetBarcode", nvc, null);
                ArrayList GridRows = (ArrayList)JSON.Decode("[" + reValue + "]");
                foreach (Hashtable item in GridRows)
                {
                    //数据返回正确
                    if (Convert.ToString(item["code"]).Equals("1000"))
                    {
                        ArrayList datalit = (ArrayList)JSON.Decode("[" + JSON.Encode(item["data"]) + "]");
                        foreach (Hashtable ri in datalit)
                        {
                            string[] description = Convert.ToString(ri["Description"]).Split(' ');
                            for (int i = 2; i < description.Length; i++)
                            {
                                Figure += description[i];//花纹
                            }
                            Specs = description[0];
                            string loadSpeed = description[1].Replace("(", "").Replace(")", "");
                            LoadIndex = loadSpeed.Substring(0, loadSpeed.Length - 1);
                            SpeedLevel = loadSpeed.Substring(loadSpeed.Length - 1);
                            TyreCode = Convert.ToString(ri["barcode"]);
                            GoodsCode = Convert.ToString(ri["material"]);
                            if (GoodsCode.Length > 6)
                            {
                                GoodsCode = GoodsCode + "0000";
                            }
                            else if (GoodsCode.Length == 5)
                            {
                                GoodsCode = "0" + GoodsCode + "0000";
                            }
                            Batch = Convert.ToString(ri["DOT"]);
                            string singleBrand = Convert.ToString(ri["singleBrand"]);
                            if (singleBrand.ToUpper().Contains("VIKING"))
                            {
                                TypeID = 345;
                                ProductName = "维京轮胎";
                            }
                        }
                    }
                    else
                    {
                        msg.Result = false;
                        msg.Message = Convert.ToString(item["code"].ToString() + " " + item["data"].ToString());
                        goto ERR;
                    }
                }
            }


            //查询原仓库的产品信息
            Model = Specs;


            List<CargoFactoryOrderBarcodeEntity> barlist = order.QueryBarcodeInfo(new CargoFactoryOrderBarcodeEntity { Barcode = TyreCode });
            if (barlist.Count <= 0)
            {
                msg.Result = false;
                msg.Message = "请重新获取该船运号标签";
                goto ERR;
            }
            SourceOrderNo = barlist[0].VehicleNo;

            #region 通用数据检验

            if (string.IsNullOrEmpty(GoodsCode))
            {
                msg.Result = false;
                msg.Message = "货品代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(ContainerCode))
            {
                msg.Result = false;
                msg.Message = "货位代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                msg.Result = false;
                msg.Message = "产品编码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(Batch))
            {
                msg.Result = false;
                msg.Message = "周期批次不能为空";
                goto ERR;
            }
            #endregion
            List<CargoProductTypeEntity> ptype = bus.QueryProductType(new CargoProductTypeEntity { TypeID = TypeID, ParentID = -1 });
            int parentID = 0;
            if (ptype.Count > 0)
            {
                parentID = ptype[0].ParentID;
            }
            int bYear = 0, bWeek = 0, flatRadio = 0, HubDiameter = 0, TreadWidth = 0;
            switch (parentID)
            {
                case 1:
                    #region 轮胎
                    if (string.IsNullOrEmpty(Specs))
                    {
                        msg.Result = false;
                        msg.Message = "规格不能为空";
                        goto ERR;
                    }
                    if (string.IsNullOrEmpty(Figure))
                    {
                        msg.Result = false;
                        msg.Message = "花纹不能为空";
                        goto ERR;
                    }
                    if (!Common.IsInt(LoadIndex))
                    {
                        msg.Result = false;
                        msg.Message = "载重指数数据有误";
                        goto ERR;
                    }
                    if (string.IsNullOrEmpty(SpeedLevel))
                    {
                        msg.Result = false;
                        msg.Message = "速度级别不能为空";
                        goto ERR;
                    }
                    if (Batch.Length != 4)
                    {
                        msg.Result = false;
                        msg.Message = "周期批次输入有误";
                        goto ERR;
                    }
                    if (!Common.IsInt(Batch))
                    {
                        msg.Result = false;
                        msg.Message = "周期批次输入有误";
                        goto ERR;
                    }
                    if (Batch.Length == 4)
                    {
                        bWeek = Convert.ToInt32(Batch.Substring(0, 2));
                        bYear = Convert.ToInt32(Batch.Substring(2, 2));
                    }
                    else if (Batch.Length == 3)
                    {
                        bWeek = Convert.ToInt32(Batch.Substring(0, 1));
                        bYear = Convert.ToInt32(Batch.Substring(1, 2));
                    }
                    string[] sp = Specs.Split('/');
                    if (sp.Length > 1)
                    {
                        if (Common.IsInt(sp[0]))
                        {
                            TreadWidth = Convert.ToInt32(sp[0]);
                        }
                        string gg = Convert.ToString(sp[1]);
                        if (Common.IsInt(gg.Substring(0, 2)))
                        {
                            flatRadio = Convert.ToInt32(gg.Substring(0, 2));
                        }
                        if (Common.IsInt(gg.Substring(3, 2)))
                        {
                            HubDiameter = Convert.ToInt32(gg.Substring(3, 2));
                        }
                        //HubDiameter = Convert.ToInt32(gg.Substring(gg.Length - 2, 2));
                    }
                    #endregion
                    InCargoNum = "1";
                    //Figure = Figure.Replace(" ", "");
                    break;
                default:
                    break;
            }
            CargoFactoryOrderBus ProductUnitPrice = new CargoFactoryOrderBus();
            CargoFactoryOrderEntity cargoFactoryOrder = ProductUnitPrice.QueryFactoryOrderData(new CargoFactoryOrderEntity { FacOrderNo = SourceOrderNo, HouseID = HouseID, TypeID = TypeID, Specs = Specs, Figure = Figure, GoodsCode = GoodsCode, LoadIndex = LoadIndex, SpeedLevel = SpeedLevel });
            if (cargoFactoryOrder == null)
            {
                msg.Result = false;
                msg.Message = "请检查来货导入数据：" + SourceOrderNo + ",规格:" + Specs;
                goto ERR;
            }
            if (!string.IsNullOrEmpty(cargoFactoryOrder.FacOrderNo))
            {
                if (cargoFactoryOrder.InCargoStatus.Equals("1"))
                {
                    msg.Result = false;
                    msg.Message = "来货单号：" + SourceOrderNo + ",规格:" + Specs + "已入库完成";
                    goto ERR;
                }
                //if (cargoFactoryOrder.ReplyNumber == cargoFactoryOrder.InPiece)
                //{
                //    msg.Result = false;
                //    msg.Message = "来货单号：" + SourceOrderNo + ",规格:" + Specs + "已入库完成";
                //    goto ERR;
                //}
            }
            cargoFactoryOrder.EnSafe();
            Decimal unitPrice = 0.00M, finalCostPrice = 0.00M, costPrice = 0.00M, taxCostPrice = 0.00M, noTaxCostPrice = 0.00M, tradePrice = 0.00M, salePrice = 0.00M, InHousePrice = 0.00M, NextDayPrice = 0.00M;
            string BelongDepart = "";
            string BelongDepartName = string.Empty;
            string SpecsType = string.Empty;
            string Supplier = string.Empty;
            int SuppClientNum = 0;
            string SupplierAddress = string.Empty;
            string ProductCode = string.Empty;
            SpecsType = cargoFactoryOrder.SpecsType;
            Supplier = cargoFactoryOrder.Supplier;
            SuppClientNum = string.IsNullOrEmpty(cargoFactoryOrder.SuppClientNum) ? 0 : Convert.ToInt32(cargoFactoryOrder.SuppClientNum);
            ProductCode = cargoFactoryOrder.ProductCode;
            SupplierAddress = cargoFactoryOrder.SupplierAddress;
            #region 获取基础价格数据
            //根据产品类型ID、规格、花纹、速度指数、载重指数、订单月

            //获取单价
            CargoFactoryOrderEntity factoryOrderentity = new CargoFactoryOrderEntity();
            CargoProductBasicPriceEntity basicPriceEntity = new CargoProductBasicPriceEntity();
            factoryOrderentity.FacOrderNo = SourceOrderNo;
            factoryOrderentity.HouseID = HouseID;
            factoryOrderentity.TypeID = TypeID;
            factoryOrderentity.GoodsCode = GoodsCode;
            CargoFactoryOrderEntity productUnitPrice = ProductUnitPrice.QueryProductUnitPrice(factoryOrderentity);
            if (productUnitPrice != null && productUnitPrice.ID != 0)
            {
                BelongDepart = productUnitPrice.BelongDepart;
                BelongDepartName = productUnitPrice.BelongDepartName;

                unitPrice = Convert.ToDecimal(productUnitPrice.UnitPrice);
                salePrice = Convert.ToDecimal(productUnitPrice.SalePrice);
                tradePrice = Convert.ToDecimal(productUnitPrice.TradePrice);

                costPrice = Convert.ToDecimal(productUnitPrice.CostPrice);
                taxCostPrice = Convert.ToDecimal(productUnitPrice.TaxCostPrice);
                noTaxCostPrice = Convert.ToDecimal(productUnitPrice.NoTaxCostPrice);
                SpecsType = productUnitPrice.SpecsType;
                Supplier = productUnitPrice.Supplier;
                SuppClientNum = string.IsNullOrEmpty(productUnitPrice.SuppClientNum) ? 0 : Convert.ToInt32(productUnitPrice.SuppClientNum);
                ProductCode = productUnitPrice.ProductCode;
                SupplierAddress = productUnitPrice.SupplierAddress;
            }
            //20250705 所有仓库都要匹配单价  门店价  销售价
            string proYear, proMonth;
            if (BelongMonth.Length.Equals(6))
            {
                proYear = BelongMonth.Substring(0, 4);
                proMonth = BelongMonth.Substring(4, 2);
                if (proMonth.Substring(0, 1) == "0")
                {
                    proMonth = DateTime.Now.ToString("MM").Substring(1, 1);
                }
            }
            else
            {
                proYear = DateTime.Now.ToString("yyyy");
                proMonth = DateTime.Now.ToString("MM");
                if (proMonth.Substring(0, 1) == "0")
                {
                    proMonth = DateTime.Now.ToString("MM").Substring(1, 1);
                }
            }
            CargoProductBasicPriceEntity basicPrice = house.QueryProductBasicPrice(new CargoProductBasicPriceEntity
            {
                HouseID = HouseID,
                TypeID = TypeID,
                GoodsCode = GoodsCode,
                ProductCode = ProductCode,
                Born = -1,
                ProYear = proYear,
                ProMonth = proMonth,
            });
            if (basicPrice != null && basicPrice.PID != 0)
            {
                //销售价
                if (basicPrice.SalePrice > 0) salePrice = Convert.ToDecimal(basicPrice.SalePrice);
                //门店价
                if (basicPrice.TradePrice > 0) tradePrice = Convert.ToDecimal(basicPrice.TradePrice);
                //进仓价
                if (basicPrice.InHousePrice > 0) InHousePrice = Convert.ToDecimal(basicPrice.InHousePrice);
                //单价
                //if (basicPrice.UnitPrice > 0) unitPrice = Convert.ToDecimal(basicPrice.UnitPrice);
                //次日达价格
                if (basicPrice.NextDayPrice > 0) NextDayPrice = Convert.ToDecimal(basicPrice.NextDayPrice);
                ////最终成本价
                //finalCostPrice = Convert.ToDecimal(basicPrice.FinalCostPrice);
                //if (basicPrice.CostPrice > 0)
                //{
                //    //成本价
                //    costPrice = Convert.ToDecimal(basicPrice.CostPrice);
                //    //含税成本价
                //    taxCostPrice = Convert.ToDecimal(basicPrice.TaxCostPrice);
                //    //不含税成本价
                //    noTaxCostPrice = Convert.ToDecimal(basicPrice.NoTaxCostPrice);
                //}
                //if (!basicPrice.TradePrice.Equals(0))
                //{
                //    tradePrice = Convert.ToDecimal(basicPrice.TradePrice);
                //    salePrice = Convert.ToDecimal(basicPrice.TradePrice);
                //}
            }
            //if (BelongDepartName.ToUpper().IndexOf("RE") > -1)//RE渠道销售部门的去获取价格数据
            //{
            //    //获取基础价格成本价
            //    //外采订单类型和订单类型为空时不匹配基础价格
            //    if (!string.IsNullOrEmpty(OrderType) && OrderType != "3")
            //    {
            //        if (BelongMonth.Length.Equals(6))
            //        {
            //            string proYear, proMonth;
            //            proYear = BelongMonth.Substring(0, 4);
            //            proMonth = BelongMonth.Substring(4, 2);
            //            CargoProductBasicPriceEntity basicPrice = new CargoProductBasicPriceEntity();
            //            if (TypeID == 34)
            //            {
            //                basicPriceEntity.HouseID = HouseID;
            //                basicPriceEntity.TypeID = TypeID;
            //                basicPriceEntity.GoodsCode = GoodsCode;
            //                basicPriceEntity.ProYear = proYear;
            //                basicPriceEntity.ProMonth = proMonth;
            //            }
            //            else
            //            {
            //                basicPriceEntity.HouseID = HouseID;
            //                basicPriceEntity.TypeID = TypeID;
            //                basicPriceEntity.Born = string.IsNullOrEmpty(Born) ? -1 : Convert.ToInt32(Born);
            //                basicPriceEntity.Assort = Assort;
            //                basicPriceEntity.GoodsCode = GoodsCode;
            //                basicPriceEntity.Specs = Specs;
            //                basicPriceEntity.Figure = Figure;
            //                basicPriceEntity.LoadIndex = LoadIndex;
            //                basicPriceEntity.SpeedLevel = SpeedLevel;
            //                basicPriceEntity.ProYear = proYear;
            //                basicPriceEntity.ProMonth = proMonth;
            //            }
            //            basicPrice = house.QueryProductBasicPrice(basicPriceEntity);
            //            if (basicPrice != null && basicPrice.PID != 0)
            //            {
            //                finalCostPrice = Convert.ToDecimal(basicPrice.FinalCostPrice);
            //                if (costPrice.Equals(0))
            //                {
            //                    costPrice = Convert.ToDecimal(basicPrice.CostPrice);
            //                    taxCostPrice = Convert.ToDecimal(basicPrice.TaxCostPrice);
            //                    noTaxCostPrice = Convert.ToDecimal(basicPrice.NoTaxCostPrice);
            //                }
            //                if (!basicPrice.TradePrice.Equals(0))
            //                {
            //                    tradePrice = Convert.ToDecimal(basicPrice.TradePrice);
            //                    salePrice = Convert.ToDecimal(basicPrice.TradePrice);
            //                }
            //            }
            //        }
            //    }
            //}
            #endregion
            //仓库同步缓存
            CargoProductEntity syncProduct = house.SyncTypeProduct(parentID.ToString());
            //34 马牌  1 同步马牌  2 同步全部品牌
            if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
            {
                RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
            }
            //主仓缓存更改
            if (house.IsAddCaching(syncProduct.HouseID, syncProduct.TypeID))
            {
                RedisHelper.HashSet("HCYCHouseStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
            }
            inter.scanTagInCargo(new CargoProductEntity { ProductName = ProductName, GoodsCode = GoodsCode, HouseID = HouseID, TypeID = TypeID, Specs = Specs, Figure = Figure, Model = Model, Batch = Batch, ContainerCode = ContainerCode, TagCode = TagCode, BatchYear = bYear, BatchWeek = bWeek, InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString(), OPID = UserID, LoadIndex = LoadIndex, SpeedLevel = SpeedLevel, Meridian = "R", TreadWidth = TreadWidth, FlatRatio = flatRadio, HubDiameter = HubDiameter, InCargoStatus = "1", InHouseTime = DateTime.Now, OperaType = "1", Born = Born, Assort = Assort, TyreCode = TyreCode, Numbers = Convert.ToInt32(InCargoNum), ParentID = parentID, Source = Source, SourceOrderNo = SourceOrderNo, BelongMonth = BelongMonth, UnitPrice = unitPrice, FinalCostPrice = finalCostPrice, CostPrice = costPrice, TaxCostPrice = taxCostPrice, NoTaxCostPrice = noTaxCostPrice, TradePrice = tradePrice, SalePrice = salePrice, HLYReturnID = HLYReturnID, BelongDepart = BelongDepart, SpecsType = SpecsType, Company = "0", Supplier = Supplier, SuppClientNum = SuppClientNum, ProductCode = ProductCode, SupplierAddress = SupplierAddress, InHousePrice = InHousePrice, NextDayPrice = NextDayPrice,GoodsClass="0" }, log);
            msg.Message = Batch;
        ERR:
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 获取所有产品来源
        /// </summary>
        public void QueryAllProductSource()
        {
            CargoProductBus bus = new CargoProductBus();

            List<CargoProductSourceEntity> list = new List<CargoProductSourceEntity>();

            list = bus.QueryAllProductSource();

            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 移库扫描
        /// </summary>
        public void ScanMoveContainer()
        {
            string ContainerCode = Convert.ToString(Request["ContainerCode"]);
            string TagCode = Convert.ToString(Request["TagCode"]);
            string[] tArr = TagCode.Split('=');
            if (tArr.Length > 1)
            {
                TagCode = tArr[1];
            }
            else
            {
                string[] gtc = TagCode.Split('|');
                if (gtc.Length > 1)
                {
                    string tc = gtc[5];
                    TagCode = tc;
                }
            }
            string UserID = QyUserInfo.UserID;

            CargoProductBus bus = new CargoProductBus();
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoHouseBus house = new CargoHouseBus();
            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "移库管理";
            log.NvgPage = "扫描移库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "A";
            log.Status = "0";
            #region 通用数据检验

            if (string.IsNullOrEmpty(ContainerCode))
            {
                msg.Result = false;
                msg.Message = "货位代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                msg.Result = false;
                msg.Message = "产品编码不能为空";
                goto ERR;
            }
            CargoContainerEntity contain = house.QueryContainerEntityByCode(ContainerCode, QyUserInfo.HouseID);
            if (contain == null || contain.ContainerID.Equals(0))
            {
                msg.Result = false;
                msg.Message = "货位代码不存在";
                goto ERR;
            }
            CargoProductTagEntity tag = bus.QueryTagByTagCode(new CargoProductTagEntity { TagCode = TagCode });
            if (string.IsNullOrEmpty(tag.TagCode))
            {
                msg.Result = false;
                msg.Message = "标签编码不存在";
                goto ERR;
            }
            if (contain.ContainerID.Equals(tag.ContainerID))
            {
                msg.Result = false;
                msg.Message = "重复扫描";
                goto ERR;
            }
            #endregion

            List<CargoProductTagEntity> taglist = new List<CargoProductTagEntity>();

            CargoContainerShowEntity newContainer = new CargoContainerShowEntity();//目标货位实体
            newContainer.ContainerID = contain.ContainerID;//新货位ID
            newContainer.ContainerCode = contain.ContainerCode;//新货位代码
            newContainer.HouseID = contain.HouseID;//目标仓库ID
            newContainer.AreaID = contain.AreaID;//目标仓库区域ID
            newContainer.InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//入库单号
            newContainer.TagCode = TagCode;

            List<CargoContainerShowEntity> oldGoods = inter.QueryOldContainerList(TagCode);
            if (oldGoods.Count > 0)
            {
                CargoContainerShowEntity it = oldGoods[0];
                it.Piece = 1;
                if (it.InPiece < 1)
                {
                    msg.Result = false;
                    msg.Message = "在库数量少于移库数量";
                    goto ERR;
                }
                if (!it.HouseID.Equals(QyUserInfo.HouseID))
                {
                    msg.Result = false;
                    msg.Message = "非本仓库产品";
                    goto ERR;
                }
                if (it.ContainerID.Equals(newContainer.ContainerID))
                {
                    msg.Result = false;
                    msg.Message = "仓库ID相同货位不能移库";
                    //goto ERR;
                    goto ERR;
                }
                //仓库同步缓存(缓存的旧的仓库信息)
                CargoProductEntity syncProduct = house.SyncTypeProduct(it.ProductID.ToString());
                //34 马牌  1 同步马牌  2 同步全部品牌
                if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                {
                    RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                }
                house.SaveMoveContainer(it, newContainer, log);
                List<CargoProductTagEntity> tli = new List<CargoProductTagEntity>();
                tli.Add(new CargoProductTagEntity { TagCode = TagCode, ContainerID = contain.ContainerID });
                inter.UpdateProductTagContainID(tli, log);
            }
        ERR:
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 通过审批
        /// </summary>
        public void expenseCheckOk()
        {
            string Reason = Convert.ToString(Request["Reason"]);
            long ExID = Convert.ToInt64(Request["ExID"]);//修改表主键ID
            CargoExpenseEntity result = new CargoExpenseEntity();
            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            result.UserID = QyUserInfo.UserID;
            result.UserName = QyUserInfo.UserName;
            result.CheckTime = DateTime.Now;
            result.DenyReason = Reason;
            result.ExID = ExID;
            result.Status = "5";
            CargoExpenseApproveRoutEntity approveRoute = new CargoExpenseApproveRoutEntity();
            approveRoute.ExID = ExID;
            approveRoute.UserID = QyUserInfo.UserID;
            approveRoute.UserName = QyUserInfo.UserName;
            approveRoute.ApproveType = "1";
            approveRoute.Result = Reason;
            approveRoute.Opera = "0";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "报销审批";
            log.NvgPage = "报销申请审批";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";
            QiyeBus q = new QiyeBus();
            CargoExpenseEntity qup = q.QueryExpenseCheckEntity(result);
            if (qup.Status.Equals("3"))
            {
                msg.Result = false;
                msg.Message = "该报销单已审批结束，请勿重复审批";
            }
            if (!QyUserInfo.CheckRole.Contains(qup.NextCheckID))
            {
                msg.Result = false;
                msg.Message = "流程未到您审批";
            }
            bool IsEnd = false;
            if (msg.Result)
            {
                string copy = string.Empty;
                //1.查询审批设置表获得审批流程
                CargoFinanceBus f = new CargoFinanceBus();
                List<QyUserEntity> qyUser = new List<QyUserEntity>();
                QySendInfoEntity send = new QySendInfoEntity();
                CargoOrderBus o = new CargoOrderBus();
                CargoApproveSetEntity AppSet = new CargoApproveSetEntity();
                string ApproveType = "3";
                List<CargoApproveSetEntity> aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = ApproveType, DelFlag = "0", HouseID = qup.HouseID });
                if (aset.Count > 0) { AppSet = aset[0]; }
                else
                {
                    aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = "3", DelFlag = "0", HouseID = qup.HouseID });
                    if (aset.Count > 0) { AppSet = aset[0]; }
                }
                AppSet.EnSafe();
                //2.审批流程的每一级和当前人的审批角色相匹配
                if (AppSet.OneCheckID.Equals(qup.NextCheckID))
                {
                    #region 第一级
                    send.title = AppSet.OneCheckName + "审批通过";
                    result.Status = "1";
                    result.NextCheckID = AppSet.TwoCheckID;
                    result.NextCheckName = AppSet.TwoCheckName;
                    if (string.IsNullOrEmpty(AppSet.TwoCheckID))
                    {
                        send.title = "报销申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.Status = "3";
                        result.NextCheckID = "";// AppSet.OneCheckID;
                        result.NextCheckName = "";// AppSet.OneCheckName;
                        approveRoute.Opera = "2";
                    }
                    else
                    {
                        //判断下一级是不是分公司领导，如果是则查询申请人的上级领导
                        if (AppSet.TwoCheckID.Equals("3"))
                        {
                            List<SystemUserEntity> Bosslist = o.QueryUserBossLoginName(new SystemUserEntity { LoginName = qup.OperaID });
                            if (Bosslist.Count > 0)
                            {
                                if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                {
                                    qyUser.Add(new QyUserEntity { UserID = Bosslist[0].LoginName, WxName = Bosslist[0].UserName });
                                }
                                else
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.ThreeCheckID, CheckHouseID = qup.HouseID.ToString() });
                                }
                            }
                        }
                        else
                        {
                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID, CheckHouseID = qup.HouseID.ToString() });
                        }
                    }
                    #endregion
                }
                else if (AppSet.TwoCheckID.Equals(qup.NextCheckID))
                {
                    #region 第二级
                    send.title = AppSet.TwoCheckName + "审批通过";
                    result.Status = "1";
                    result.NextCheckID = AppSet.ThreeCheckID;
                    result.NextCheckName = AppSet.ThreeCheckName;
                    if (string.IsNullOrEmpty(AppSet.ThreeCheckID))
                    {
                        send.title = "报销申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.Status = "3";
                        result.NextCheckID = "";//AppSet.TwoCheckID;
                        result.NextCheckName = "";// AppSet.TwoCheckName;
                        approveRoute.Opera = "2";
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.ThreeCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    #endregion
                }
                else if (AppSet.ThreeCheckID.Equals(qup.NextCheckID))
                {
                    #region 第三级
                    send.title = AppSet.ThreeCheckName + "审批通过";
                    result.Status = "1";
                    result.NextCheckID = AppSet.FourCheckID;
                    result.NextCheckName = AppSet.FourCheckName;
                    if (string.IsNullOrEmpty(AppSet.FourCheckID))
                    {
                        send.title = "报销申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.Status = "3";
                        result.NextCheckID = "";//AppSet.ThreeCheckID;
                        result.NextCheckName = "";// AppSet.ThreeCheckName;
                        approveRoute.Opera = "2";
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FourCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    #endregion
                }
                else if (AppSet.FourCheckID.Equals(qup.NextCheckID))
                {
                    #region 第四级
                    send.title = AppSet.FourCheckName + "审批通过";
                    result.Status = "1";
                    result.NextCheckID = AppSet.FiveCheckID;
                    result.NextCheckName = AppSet.FiveCheckName;
                    if (string.IsNullOrEmpty(AppSet.FiveCheckID))
                    {
                        send.title = "报销申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.Status = "3";
                        result.NextCheckID = "";//AppSet.FourCheckID;
                        result.NextCheckName = "";//AppSet.FourCheckName;
                        approveRoute.Opera = "2";
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FiveCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    #endregion
                }
                else if (AppSet.FiveCheckID.Equals(qup.NextCheckID))
                {
                    #region 第五级
                    send.title = AppSet.FiveCheckName + "审批通过";
                    result.Status = "1";
                    result.NextCheckID = AppSet.SixCheckID;
                    result.NextCheckName = AppSet.SixCheckName;
                    if (string.IsNullOrEmpty(AppSet.SixCheckID))
                    {
                        send.title = "报销申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.Status = "3";
                        result.NextCheckID = "";// AppSet.FiveCheckID;
                        result.NextCheckName = "";//AppSet.FiveCheckName;
                        approveRoute.Opera = "2";
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SixCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    #endregion
                }
                else if (AppSet.SixCheckID.Equals(qup.NextCheckID))
                {
                    #region 第六级
                    send.title = AppSet.SixCheckName + "审批通过";
                    result.Status = "1";
                    result.NextCheckID = AppSet.SevenCheckID;
                    result.NextCheckName = AppSet.SevenCheckName;
                    if (string.IsNullOrEmpty(AppSet.SevenCheckID))
                    {
                        send.title = "报销申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.Status = "3";
                        result.NextCheckID = "";// AppSet.FiveCheckID;
                        result.NextCheckName = "";//AppSet.FiveCheckName;
                        approveRoute.Opera = "2";
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SevenCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    #endregion
                }

                q.CheckExpense(result, log);
                f.AddExpenseApproveRout(approveRoute);
                //添加申请单与审批人关系数据
                if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = ExID, CheckUserID = QyUserInfo.UserID, CheckType = "0", ApproveType = "1" }))
                {
                    f.AddApproveCheck(new CargoApproveCheckEntity
                    {
                        ApproveID = ExID,
                        CheckUserID = QyUserInfo.UserID,
                        CheckName = QyUserInfo.UserName,
                        CheckType = "0",
                        ReadStatus = "1",
                        ApproveType = "1"
                    }, log);
                }
                //如果 是最后审批人，就结束
                if (IsEnd)
                {
                    List<QyUserEntity> cQyU = new List<QyUserEntity>();
                    if (!string.IsNullOrEmpty(AppSet.CopyCheck))
                    {
                        cQyU = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.CopyCheck });
                    }
                    foreach (var c in cQyU)
                    {
                        //添加申请单与审批人关系数据
                        if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = ExID, CheckUserID = c.UserID, ApproveType = "1" }))
                        {
                            f.AddApproveCheck(new CargoApproveCheckEntity
                            {
                                ApproveID = ExID,
                                CheckUserID = c.UserID,
                                CheckName = c.WxName,
                                CheckType = "1",
                                ReadStatus = "1",
                                ApproveType = "1"
                            }, log);
                        }
                        if (!copy.Contains(c.UserID))
                        {
                            copy += c.UserID + ",";
                        }
                    }
                    if (!string.IsNullOrEmpty(AppSet.CopyUserID) && !string.IsNullOrEmpty(AppSet.CopyCheckName))
                    {
                        string[] uS = AppSet.CopyUserID.Split(',');
                        string[] uName = AppSet.CopyUserName.Split(',');
                        if (uS.Length > 0)
                        {
                            for (int i = 0; i < uS.Length; i++)
                            {
                                if (!string.IsNullOrEmpty(uS[i]))
                                {
                                    //添加申请单与审批人关系数据
                                    if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = ExID, CheckUserID = uS[i], ApproveType = "1" }))
                                    {
                                        f.AddApproveCheck(new CargoApproveCheckEntity
                                        {
                                            ApproveID = ExID,
                                            CheckUserID = uS[i],
                                            CheckName = uName[i],
                                            CheckType = "1",
                                            ReadStatus = "1",
                                            ApproveType = "1"
                                        }, log);
                                    }
                                    if (!copy.Contains(uS[i]))
                                    {
                                        copy += uS[i] + ",";
                                    }
                                }
                            }
                        }
                    }
                    //try
                    //{
                    //        string openID = q.QueryWeixinOpenIDByUserID(qup.OperaID);
                    //        //推送客户改价成功通知
                    //        WxCustomSend wxsend = new WxCustomSend();
                    //        string token = Common.GetWeixinToken(Common.GetdltAPPID(), Common.GetdltAppSecret());
                    //        wxsend.SendWeiXinInfo(token, openID, new QySendInfoEntity { content = "您的报销单：" + ExID + "申请已通过！", msgType = msgType.text });

                    //}
                    //catch (ApplicationException exx)
                    //{
                    //    msg.Result = true;
                    //    Common.WriteTextLog(ExID + "推送通知失败");
                    //}
                }
                if (qyUser.Count > 0 || IsEnd)
                {
                    #region 推送通知
                    try
                    {
                        //推送给提交人
                        send.msgType = msgType.textcard;
                        send.toUser = qup.OperaID;
                        //send.toUser = ou.ApplyID;
                        //send.toTag = strTag;
                        send.content = "<div></div><div>报销单号：" + ExID + "</div><div>受款人：" + qup.ReceiveName + "</div><div>审批人：" + QyUserInfo.UserName + "</div><div>审批时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>审批意见：" + result.DenyReason + "</div><div></div>";
                        send.url = "http://dlt.neway5.com/QY/qyExpenseApprove.aspx?ExID=" + ExID;
#if DEBUG
#else
                        WxQYSendHelper.PushInfo("0", "3", send);
#endif
                    }
                    catch (Exception)
                    {
                        msg.Result = true;
                    }
                    //推送给下一审批人
                    foreach (var it in qyUser)
                    {
                        try
                        {
                            send.toUser = it.UserID;
#if DEBUG
#else
                            WxQYSendHelper.PushInfo("0", "2", send);
#endif
                        }
                        catch (Exception ex)
                        {
                            continue;
                        }
                    }
                    if (!string.IsNullOrEmpty(copy))
                    {
                        copy = copy.Substring(0, copy.Length - 1);
                        try
                        {
                            send.toUser = copy;
#if DEBUG
#else
                            WxQYSendHelper.PushInfo("0", "2", send);
#endif
                        }
                        catch (Exception ex)
                        {
                            msg.Result = true;
                        }
                    }
                    #endregion
                }
            }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 拒绝审批
        /// </summary>
        public void expenseCheckNo()
        {
            string Reason = Convert.ToString(Request["Reason"]);
            long ExID = Convert.ToInt64(Request["ExID"]);//修改表主键ID
            CargoExpenseEntity result = new CargoExpenseEntity();
            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            result.UserID = QyUserInfo.UserID;
            result.UserName = QyUserInfo.UserName;
            result.CheckTime = DateTime.Now;
            result.DenyReason = Reason;
            result.ExID = ExID;
            result.Status = "2";
            CargoExpenseApproveRoutEntity approveRoute = new CargoExpenseApproveRoutEntity();
            approveRoute.ExID = ExID;
            approveRoute.UserID = QyUserInfo.UserID;
            approveRoute.UserName = QyUserInfo.UserName;
            approveRoute.ApproveType = "1";
            approveRoute.Result = Reason;
            approveRoute.Opera = "1";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "报销审批";
            log.NvgPage = "报销申请审批";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";
            QiyeBus q = new QiyeBus();
            CargoExpenseEntity qup = q.QueryExpenseCheckEntity(result);
            if (qup.Status.Equals("3"))
            {
                msg.Result = false;
                msg.Message = "该订单已审批结束，请勿重复审批";
            }
            if (!QyUserInfo.CheckRole.Contains(qup.NextCheckID))
            {
                msg.Result = false;
                msg.Message = "流程未到您审批";
            }
            if (msg.Result)
            {
                CargoFinanceBus f = new CargoFinanceBus();
                q.CheckExpense(result, log);
                f.AddExpenseApproveRout(approveRoute);
                //添加申请单与审批人关系数据
                if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = ExID, CheckUserID = QyUserInfo.UserID, CheckType = "0", ApproveType = "1" }))
                {
                    f.AddApproveCheck(new CargoApproveCheckEntity
                    {
                        ApproveID = ExID,
                        CheckUserID = QyUserInfo.UserID,
                        CheckName = QyUserInfo.UserName,
                        CheckType = "0",
                        ReadStatus = "1",
                        ApproveType = "1"
                    }, log);
                }
                try
                {
                    QySendInfoEntity send = new QySendInfoEntity();
                    send.title = "报销申请拒审";
                    //推送给提交人
                    send.msgType = msgType.textcard;
                    send.toUser = qup.OperaID;
                    //send.toUser = ou.ApplyID;
                    //send.toTag = strTag;
                    send.content = "<div></div><div>报销单号：" + ExID + "</div><div>受款人：" + qup.ReceiveName + "</div><div>审批人：" + QyUserInfo.UserName + "</div><div>审批时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>审批意见：" + result.DenyReason + "</div><div>审批结果：未通过</div>";
                    send.url = "http://dlt.neway5.com/QY/qyExpenseApprove.aspx?ExID=" + ExID;
#if DEBUG
#else
                    WxQYSendHelper.PushInfo("0", "3", send);
#endif
                }
                catch (ApplicationException ex)
                {
                    msg.Result = true;
                }
            }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 查询未签收的订单用以签收操作
        /// </summary>
        public void QueryUnSignOrderList()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            queryEntity.OrderNo = Convert.ToString(Request["key"]);
            //queryEntity.HouseIDStr = QyUserInfo.CargoPermisID;
            CargoOrderBus bus = new CargoOrderBus();
            CargoOrderEntity entity = bus.QueryOrderInfo(queryEntity);
            //JSON
            String json = JSON.Encode(entity);
            //Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 扫描标签查询轮胎信息
        /// </summary>
        public void ScanTagCode()
        {
            string TagCode = Convert.ToString(Request["TagCode"]);
            string[] tArr = TagCode.Split('=');
            if (tArr.Length > 1)
            {
                TagCode = tArr[1];
            }
            else
            {
                string[] gtc = TagCode.Split('|');
                if (gtc.Length > 1)
                {
                    string tc = gtc[5];
                    TagCode = tc;
                }
            }
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoProductEntity productEntity = inter.QueryProductInfoByTagCode(new CargoProductEntity { TagCode = TagCode });

            if (!string.IsNullOrEmpty(productEntity.OrderNo))
            {
                CargoOrderBus bus = new CargoOrderBus();
                string shopCode = "【" + productEntity.SourceCode + "】";
                List<CargoOrderStatusEntity> result = bus.QueryOrderStatus(new CargoOrderStatusEntity { OrderID = productEntity.FacID });
                string html = string.Empty;
                if (result.Count > 0)
                {
                    html += "<ul>";
                    int sum = 0;
                    foreach (var item in result)
                    {
                        string orderStatus = string.Empty;
                        switch (item.OrderStatus)
                        {
                            case "0":
                                orderStatus = "您的订单系统已处理";
                                break;
                            case "1":
                                orderStatus = "您的订单开始拣货";
                                shopCode = "【" + productEntity.SourceName + "】";
                                break;
                            case "2":
                                orderStatus = "您的订单已出库，将分配物流运输";
                                shopCode = "【" + productEntity.SourceName + "】";
                                break;
                            case "3":
                                orderStatus = $"您的订单已交付物流，即将发往【{productEntity.Company}】";
                                shopCode = "";
                                break;
                            case "4":
                                orderStatus = $"您的订单已到达【{productEntity.BelongDepart}】";
                                shopCode = "";
                                break;
                            case "5":
                                orderStatus = "您的订单已被签收";
                                break;
                            case "6":
                                orderStatus = "您的订单已拣货完成";
                                shopCode = "【" + productEntity.SourceName + "】";
                                break;
                            case "7":
                                orderStatus = "您的订单正在配送途中，请您耐心等待";
                                shopCode = "";
                                break;
                            case "8":
                                orderStatus = "您的订单已进入仓库准备出库";
                                break;
                            case "9":
                                orderStatus = "已提货";
                                break;
                            default:
                                orderStatus = "";
                                break;
                        }
                        if (sum.Equals(0))
                        {
                            html += $"<li class=\"first\"><p>{item.OP_DATE}</p><p>{shopCode}{orderStatus}</p><span class=\"before\"></span><span class=\"after\"></span><i class=\"mh-icon mh-icon-new\"></i></li>";
                        }
                        else
                        {
                            html += $"<li class=\"\"><p>{item.OP_DATE}</p><p>{shopCode}{orderStatus}</p><span class=\"before\"></span><span class=\"after\"></span></li>";
                        }
                        sum++;
                    }
                    productEntity.Memo = html;
                }
            }

            //返回处理结果
            string ress = JSON.Encode(productEntity);
            Response.Write(ress);

        }
        #region 工厂进货单审批

        /// <summary>
        /// 通过审批
        /// </summary>
        public void FactoryPurchaseOrderCheckOk()
        {
            string Reason = Convert.ToString(Request["Reason"]);
            long ExID = Convert.ToInt64(Request["OID"]);//修改表主键ID
            CargoFactoryPurchaseOrderEntity result = new CargoFactoryPurchaseOrderEntity();
            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            result.CheckResult = Reason;
            result.CheckStatus = "2";
            result.ApplyStatus = "2";
            CargoExpenseApproveRoutEntity approveRoute = new CargoExpenseApproveRoutEntity();
            approveRoute.ExID = ExID;
            approveRoute.UserID = QyUserInfo.UserID;
            approveRoute.UserName = QyUserInfo.UserName;
            approveRoute.ApproveType = "5";
            approveRoute.Result = Reason;
            approveRoute.Opera = "0";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "工厂来货审批";
            log.NvgPage = "锦湖工厂来货申请审批";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";
            CargoOrderBus bus = new CargoOrderBus();
            CargoFactoryPurchaseOrderEntity qup = bus.QueryFactoryPurchaseOrderInfo(new CargoFactoryPurchaseOrderEntity { OrderNo = Convert.ToString(Request["OrderNo"]) });
            result.OrderID = qup.OrderID;
            result.OrderNo = qup.OrderNo;
            if (qup.ApplyStatus.Equals("3"))
            {
                msg.Result = false;
                msg.Message = "该申请单已审批结束，请勿重复审批";
                goto ERROR;
            }
            if (!QyUserInfo.CheckRole.Contains(qup.NextCheckID))
            {
                msg.Result = false;
                msg.Message = "流程未到您审批";
                goto ERROR;
            }
            bool IsEnd = false;
            if (msg.Result)
            {
                string copy = string.Empty;
                //1.查询审批设置表获得审批流程
                CargoFinanceBus f = new CargoFinanceBus();
                QiyeBus q = new QiyeBus();
                List<QyUserEntity> qyUser = new List<QyUserEntity>();
                QySendInfoEntity send = new QySendInfoEntity();
                CargoOrderBus o = new CargoOrderBus();
                CargoApproveSetEntity AppSet = new CargoApproveSetEntity();
                string ApproveType = "14";
                List<CargoApproveSetEntity> aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = ApproveType, DelFlag = "0", HouseID = qup.HouseID });
                if (aset.Count > 0) { AppSet = aset[0]; }
                else
                {
                    msg.Message = "未配置审批流程，无法审批";
                    msg.Result = false;
                    goto ERROR;
                }
                AppSet.EnSafe();
                //2.审批流程的每一级和当前人的审批角色相匹配
                if (AppSet.OneCheckID.Equals(qup.NextCheckID))
                {
                    #region 第一级
                    send.title = AppSet.OneCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.NextCheckID = AppSet.TwoCheckID;
                    result.NextCheckName = AppSet.TwoCheckName;
                    if (string.IsNullOrEmpty(AppSet.TwoCheckID))
                    {
                        send.title = "工厂进货申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.CheckStatus = "1";
                        result.ApplyStatus = "3";
                        result.NextCheckID = "";// AppSet.OneCheckID;
                        result.NextCheckName = "";// AppSet.OneCheckName;
                        approveRoute.Opera = "2";
                    }
                    else
                    {
                        //判断下一级是不是分公司领导，如果是则查询申请人的上级领导
                        if (AppSet.TwoCheckID.Equals("3"))
                        {
                            List<SystemUserEntity> Bosslist = o.QueryUserBossLoginName(new SystemUserEntity { LoginName = qup.ApplyID });
                            if (Bosslist.Count > 0)
                            {
                                if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                {
                                    qyUser.Add(new QyUserEntity { UserID = Bosslist[0].LoginName, WxName = Bosslist[0].UserName });
                                }
                                else
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.ThreeCheckID, CheckHouseID = qup.HouseID.ToString() });
                                }
                            }
                        }
                        else
                        {
                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID, CheckHouseID = qup.HouseID.ToString() });
                        }
                    }
                    #endregion
                }
                else if (AppSet.TwoCheckID.Equals(qup.NextCheckID))
                {
                    #region 第二级
                    send.title = AppSet.TwoCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.NextCheckID = AppSet.ThreeCheckID;
                    result.NextCheckName = AppSet.ThreeCheckName;
                    if (string.IsNullOrEmpty(AppSet.ThreeCheckID))
                    {
                        send.title = "工厂进货申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.CheckStatus = "1";
                        result.ApplyStatus = "3";
                        result.NextCheckID = "";//AppSet.TwoCheckID;
                        result.NextCheckName = "";// AppSet.TwoCheckName;
                        approveRoute.Opera = "2";
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.ThreeCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    #endregion
                }
                else if (AppSet.ThreeCheckID.Equals(qup.NextCheckID))
                {
                    #region 第三级
                    send.title = AppSet.ThreeCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.NextCheckID = AppSet.FourCheckID;
                    result.NextCheckName = AppSet.FourCheckName;
                    if (string.IsNullOrEmpty(AppSet.FourCheckID))
                    {
                        send.title = "工厂进货申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.CheckStatus = "1";
                        result.ApplyStatus = "3";
                        result.NextCheckID = "";//AppSet.ThreeCheckID;
                        result.NextCheckName = "";// AppSet.ThreeCheckName;
                        approveRoute.Opera = "2";
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FourCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    #endregion
                }
                else if (AppSet.FourCheckID.Equals(qup.NextCheckID))
                {
                    #region 第四级
                    send.title = AppSet.FourCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.NextCheckID = AppSet.FiveCheckID;
                    result.NextCheckName = AppSet.FiveCheckName;
                    if (string.IsNullOrEmpty(AppSet.FiveCheckID))
                    {
                        send.title = "工厂进货申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.CheckStatus = "1";
                        result.ApplyStatus = "3";
                        result.NextCheckID = "";//AppSet.FourCheckID;
                        result.NextCheckName = "";//AppSet.FourCheckName;
                        approveRoute.Opera = "2";
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FiveCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    #endregion
                }
                else if (AppSet.FiveCheckID.Equals(qup.NextCheckID))
                {
                    #region 第五级
                    send.title = AppSet.FiveCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.NextCheckID = AppSet.SixCheckID;
                    result.NextCheckName = AppSet.SixCheckName;
                    if (string.IsNullOrEmpty(AppSet.SixCheckID))
                    {
                        send.title = "工厂进货申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.CheckStatus = "1";
                        result.ApplyStatus = "3";
                        result.NextCheckID = "";// AppSet.FiveCheckID;
                        result.NextCheckName = "";//AppSet.FiveCheckName;
                        approveRoute.Opera = "2";
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SixCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    #endregion
                }
                else if (AppSet.SixCheckID.Equals(qup.NextCheckID))
                {
                    #region 第六级
                    send.title = AppSet.SixCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.NextCheckID = AppSet.SevenCheckID;
                    result.NextCheckName = AppSet.SevenCheckName;
                    if (string.IsNullOrEmpty(AppSet.SevenCheckID))
                    {
                        send.title = "工厂进货申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.CheckStatus = "1";
                        result.ApplyStatus = "3";
                        result.NextCheckID = "";// AppSet.FiveCheckID;
                        result.NextCheckName = "";//AppSet.FiveCheckName;
                        approveRoute.Opera = "2";
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SevenCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    #endregion
                }

                bus.CheckFactoryPurchaseOrder(result, log);
                f.AddExpenseApproveRout(approveRoute);
                //添加申请单与审批人关系数据
                if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = ExID, CheckUserID = QyUserInfo.UserID, CheckType = "0", ApproveType = "5" }))
                {
                    f.AddApproveCheck(new CargoApproveCheckEntity
                    {
                        ApproveID = ExID,
                        CheckUserID = QyUserInfo.UserID,
                        CheckName = QyUserInfo.UserName,
                        CheckType = "0",
                        ReadStatus = "1",
                        ApproveType = "5"
                    }, log);
                }
                //如果 是最后审批人，就结束
                if (IsEnd)
                {
                    List<CargoFactoryPurchaseOrderGoodsEntity> FactoryPurchaseOrderGoodsList = bus.QueryFactoryPurchaseOrderGoods(new CargoFactoryPurchaseOrderEntity { OrderID = qup.OrderID });
                    List<CargoFactoryOrderEntity> FactoryOrderList = new List<CargoFactoryOrderEntity>();
                    CargoProductBus productBus = new CargoProductBus();
                    List<CargoProductSourceEntity> allProductSourcelist = productBus.QueryAllProductSource();
                    CargoHouseBus house = new CargoHouseBus();
                    CargoHouseEntity houseEntity = house.QueryCargoHouse(new CargoHouseEntity { HouseID = qup.HouseID });
                    foreach (CargoFactoryPurchaseOrderGoodsEntity item in FactoryPurchaseOrderGoodsList)
                    {
                        CargoProductSourceEntity ProductSourceEntity = new CargoProductSourceEntity();
                        var ProductSourcelist = allProductSourcelist.Where(x => x.AssociationType == item.TypeID.ToString()).ToList();
                        if (ProductSourcelist.Count > 0)
                        {
                            ProductSourceEntity = ProductSourcelist[0];
                        }
                        else
                        {
                            ProductSourceEntity = new CargoProductSourceEntity { Source = 9, SourceName = "市场采购" };
                        }
                        FactoryOrderList.Add(new CargoFactoryOrderEntity
                        {
                            HouseID = qup.HouseID,
                            FacOrderNo = qup.OrderNo,
                            Source = ProductSourceEntity.Source,
                            SourceName = ProductSourceEntity.SourceName,
                            ProductName = houseEntity.CargoDepart,
                            TypeID = item.TypeID,
                            TypeName = item.TypeName,
                            OrderType = 0,
                            Model = item.Model,
                            BelongMonth = DateTime.Now.ToString("yyyyMM"),
                            Born = item.Born,
                            Assort = "",
                            Specs = item.Specs,
                            LoadIndex = item.LoadIndex,
                            SpeedLevel = item.SpeedLevel,
                            Figure = item.Figure,
                            GoodsCode = item.GoodsCode,
                            Batch = DateTime.Now.ToString("yyyyMM").Substring(2, 2),
                            OrderNum = item.Piece,
                            ReplyNumber = item.Piece,
                            InPiece = 0,
                            InCargoStatus = 0,
                            SalePrice = item.UnitPrice,
                            UnitPrice = item.UnitPrice,
                            TradePrice = item.UnitPrice,
                            WhetherTax = 1,
                            SaleMoney = item.UnitPrice * item.Piece,//销售价*回告数量
                            ReceiveName = houseEntity.Person,
                            ReceiveCity = houseEntity.DepCity,
                            ReceiveMobile = houseEntity.Cellphone,
                            OP_Name = qup.ApplyName,
                            SourceHouse = "",
                            CargoDepart = houseEntity.CargoDepart,
                            BelongDepart = "",
                            Company = "0",
                            SpecsType = "",
                            Supplier = ""
                        });
                    }
                    FactoryOrderList = FactoryOrderList.OrderBy(e => e.Specs).ToList();
                    CargoFactoryOrderBus FactoryOrderBus = new CargoFactoryOrderBus();
                    log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                    log.Moudle = "订单管理";
                    log.Status = "0";
                    log.NvgPage = "工厂进货单导入";
                    log.UserID = qup.ApplyID;
                    log.Operate = "A";
                    FactoryOrderBus.SaveFactoryOrderData(FactoryOrderList, log);
                    List<QyUserEntity> cQyU = new List<QyUserEntity>();
                    if (!string.IsNullOrEmpty(AppSet.CopyCheck))
                    {
                        cQyU = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.CopyCheck });
                    }
                    foreach (var c in cQyU)
                    {
                        //添加申请单与审批人关系数据
                        if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = ExID, CheckUserID = c.UserID, ApproveType = "5" }))
                        {
                            f.AddApproveCheck(new CargoApproveCheckEntity
                            {
                                ApproveID = ExID,
                                CheckUserID = c.UserID,
                                CheckName = c.WxName,
                                CheckType = "1",
                                ReadStatus = "1",
                                ApproveType = "5"
                            }, log);
                        }
                        if (!copy.Contains(c.UserID))
                        {
                            copy += c.UserID + ",";
                        }
                    }
                    if (!string.IsNullOrEmpty(AppSet.CopyUserID) && !string.IsNullOrEmpty(AppSet.CopyCheckName))
                    {
                        string[] uS = AppSet.CopyUserID.Split(',');
                        string[] uName = AppSet.CopyUserName.Split(',');
                        if (uS.Length > 0)
                        {
                            for (int i = 0; i < uS.Length; i++)
                            {
                                if (!string.IsNullOrEmpty(uS[i]))
                                {
                                    //添加申请单与审批人关系数据
                                    if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = ExID, CheckUserID = uS[i], ApproveType = "5" }))
                                    {
                                        f.AddApproveCheck(new CargoApproveCheckEntity
                                        {
                                            ApproveID = ExID,
                                            CheckUserID = uS[i],
                                            CheckName = uName[i],
                                            CheckType = "1",
                                            ReadStatus = "1",
                                            ApproveType = "5"
                                        }, log);
                                    }
                                    if (!copy.Contains(uS[i]))
                                    {
                                        copy += uS[i] + ",";
                                    }
                                }
                            }
                        }
                    }
                }
                if (qyUser.Count > 0 || IsEnd)
                {
                    #region 推送通知
                    try
                    {
                        //推送给提交人
                        send.msgType = msgType.textcard;
                        send.toUser = qup.ApplyID;
                        //send.toUser = ou.ApplyID;
                        //send.toTag = strTag;
                        send.content = "<div></div><div>进货单号：" + ExID + "</div><div>审批人：" + QyUserInfo.UserName + "</div><div>审批时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>审批意见：" + result.CheckResult + "</div><div></div>";
                        send.url = "http://dlt.neway5.com/QY/qyExpenseApprove.aspx?ExID=" + ExID;
                        WxQYSendHelper.PushInfo("0", "3", send);
#if DEBUG
#else
                        WxQYSendHelper.PushInfo("0", "3", send);
#endif
                    }
                    catch (Exception)
                    {
                        msg.Result = true;
                    }
                    //推送给下一审批人
                    foreach (var it in qyUser)
                    {
                        try
                        {
                            send.toUser = it.UserID;
#if DEBUG
#else
                            WxQYSendHelper.PushInfo("0", "2", send);
#endif
                        }
                        catch (Exception ex)
                        {
                            continue;
                        }
                    }
                    if (!string.IsNullOrEmpty(copy))
                    {
                        copy = copy.Substring(0, copy.Length - 1);
                        try
                        {
                            send.toUser = copy;
#if DEBUG
#else
                            WxQYSendHelper.PushInfo("0", "2", send);
#endif
                        }
                        catch (Exception ex)
                        {
                            msg.Result = true;
                        }
                    }
                    #endregion
                }
            }
        ERROR:
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 拒绝审批
        /// </summary>
        public void FactoryPurchaseOrderCheckNo()
        {
            string Reason = Convert.ToString(Request["Reason"]);
            long ExID = Convert.ToInt64(Request["OID"]);//修改表主键ID
            CargoFactoryPurchaseOrderEntity result = new CargoFactoryPurchaseOrderEntity();
            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            result.CheckResult = Reason;
            result.CheckStatus = "1";
            result.ApplyStatus = "2";
            result.NextCheckID = "";
            result.NextCheckName = "";
            CargoExpenseApproveRoutEntity approveRoute = new CargoExpenseApproveRoutEntity();
            approveRoute.ExID = ExID;
            approveRoute.UserID = QyUserInfo.UserID;
            approveRoute.UserName = QyUserInfo.UserName;
            approveRoute.ApproveType = "5";
            approveRoute.Result = Reason;
            approveRoute.Opera = "1";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "工厂来货审批";
            log.NvgPage = "锦湖工厂来货申请审批";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";
            CargoOrderBus bus = new CargoOrderBus();
            CargoFactoryPurchaseOrderEntity qup = bus.QueryFactoryPurchaseOrderInfo(new CargoFactoryPurchaseOrderEntity { OrderNo = Convert.ToString(Request["OrderNo"]) });
            result.OrderID = qup.OrderID;
            result.OrderNo = qup.OrderNo;
            if (qup.ApplyStatus.Equals("3"))
            {
                msg.Result = false;
                msg.Message = "该申请单已审批结束，请勿重复审批";
                goto ERROR;
            }
            if (!QyUserInfo.CheckRole.Contains(qup.NextCheckID))
            {
                msg.Result = false;
                msg.Message = "流程未到您审批";
                goto ERROR;
            }
            if (msg.Result)
            {
                CargoFinanceBus f = new CargoFinanceBus();
                bus.CheckFactoryPurchaseOrder(result, log);
                f.AddExpenseApproveRout(approveRoute);
                //添加申请单与审批人关系数据
                if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = ExID, CheckUserID = QyUserInfo.UserID, CheckType = "0", ApproveType = "5" }))
                {
                    f.AddApproveCheck(new CargoApproveCheckEntity
                    {
                        ApproveID = ExID,
                        CheckUserID = QyUserInfo.UserID,
                        CheckName = QyUserInfo.UserName,
                        CheckType = "0",
                        ReadStatus = "1",
                        ApproveType = "5"
                    }, log);
                }
                try
                {
                    QySendInfoEntity send = new QySendInfoEntity();
                    send.title = "报销申请拒审";
                    //推送给提交人
                    send.msgType = msgType.textcard;
                    send.toUser = qup.ApplyID;
                    //send.toUser = ou.ApplyID;
                    //send.toTag = strTag;
                    send.content = "<div></div><div>进货单号：" + ExID + "</div><div>审批人：" + QyUserInfo.UserName + "</div><div>审批时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>审批意见：" + result.CheckResult + "</div><div>审批结果：未通过</div>";
                    send.url = "http://dlt.neway5.com/QY/qyExpenseApprove.aspx?ExID=" + ExID;
#if DEBUG
#else
                    WxQYSendHelper.PushInfo("0", "3", send);
#endif
                }
                catch (ApplicationException ex)
                {
                    msg.Result = true;
                }
            }
        ERROR:
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        #endregion
        #region 销量统计
        public void SaleStatistics()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            #region 规格
            string res = Convert.ToString(Request["Specs"]);
            res = res.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "");
            if (!res.Contains("/") && !res.ToUpper().Contains("R"))
            {
                if (res.Length <= 3)
                {
                    queryEntity.Specs = res;
                }
                if (res.Length > 3 && res.Length <= 5)
                {
                    queryEntity.Specs = res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3);
                }
                if (res.Length > 5)
                {
                    queryEntity.Specs = res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5);
                }
            }
            if (res.ToUpper().Contains("F"))
            {
                queryEntity.Specs = res;
                if (!res.ToUpper().Contains("/"))
                {
                    queryEntity.Specs = res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3);
                }
            }
            if (res.ToUpper().Contains("R") && res.ToUpper().Contains("C"))
            {
                queryEntity.Specs = res;
            }
            #endregion
            if (!string.IsNullOrEmpty(Convert.ToString(Request["TypeID"])))
            {
                queryEntity.TypeID = Convert.ToInt32(Request["TypeID"]);
            }
            queryEntity.Figure = Convert.ToString(Request["Figure"]);
            queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            if (QyUserInfo.IsHeadHouse.Equals(1))
            {
                queryEntity.FirstAreaID = QyUserInfo.HeadHouseID;
            }
            else
            {
                queryEntity.CargoPermisID = QyUserInfo.CargoPermisID;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["SortType"])))
            {
                queryEntity.SortType = Convert.ToString(Request["SortType"]);
            }
            //queryEntity.Specs = Convert.ToString(Request["key"]);
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoContainerShowEntity> list = bus.SaleStatistics(queryEntity);
            String json = JSON.Encode(list);
            //Response.Clear();
            Response.Write(json);
        }
        #endregion

        #region 仓库盘点
        /// <summary>
        /// 查询盘点单
        /// </summary>
        public void QueryStockTakeList()
        {
            CargoHouseBus bus = new CargoHouseBus();

            CargoStockTakeEntity entity = new CargoStockTakeEntity();
            entity.TakeStatus = Convert.ToString(Request["TakeStatus"]);//盘点状态 0：未盘点1：盘点中2：盘点完成
            entity.HouseID = QyUserInfo.HouseID;
            entity.StartDate = DateTime.Now.AddDays(-Convert.ToInt32(Request["StartDate"]));
            entity.EndDate = DateTime.Now.AddDays(1);
            //if (!string.IsNullOrEmpty(Convert.ToString(Request["StockID"])))
            //{
            //    entity.StockID = Convert.ToInt32(Request["StockID"]);
            //}
            List<CargoStockTakeEntity> order = bus.QueryCargoStockTakeList(entity);

            String json = JSON.Encode(order);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 根据盘点单和货位查询该货位的标签明细列表
        /// </summary>
        public void QueryCargoStockTagList()
        {
            CargoHouseBus bus = new CargoHouseBus();
            CargoStockTakeTagEntity entity = new CargoStockTakeTagEntity();
            entity.ContainerCode = Convert.ToString(Request["ContainerCode"]);//货位代码
            //entity.HouseID = wxUser.HouseID;
            entity.StockID = Convert.ToInt32(Request["StockID"]);
            List<CargoStockTakeTagEntity> order = bus.QueryCargoStockTagList(entity);

            //JSON
            String json = JSON.Encode(order);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 提交盘点扫描
        /// </summary>
        public void SaveStockTakeTagScan()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "保存成功"; msg.Result = true;

            string StockID = Request["StockID"];//盘点单ID
            string ContainerCode = Request["ContainerCode"];//货位代码
            string TagCode = Request["TagCode"];//扫描的标签号码
            CargoHouseBus bus = new CargoHouseBus();
            CargoProductBus proBus = new CargoProductBus();

            //Common.WriteTextLog(StockID);
            //Common.WriteTextLog(ContainerCode);
            Common.WriteTextLog(TagCode);

            //string TagCode = context.Request["TagCode"];//产品唯一编码标签码42652HK190HN|1|1|HK|2523|750007608|20B3392EB2724DA5AE706BE1529A69F7|01
            string[] tArr = TagCode.Split('=');
            if (tArr.Length > 1)
            {
                TagCode = tArr[1];
            }
            else
            {
                string[] gtc = TagCode.Split('|');
                if (gtc.Length > 1)
                {
                    TagCode = gtc[5];
                    // TagCode = tc.Substring(8, tc.Length - 8);
                }
            }

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "企微盘点管理";
            log.NvgPage = "提交标签扫描";
            log.UserID = QyUserInfo.UserID;//限定某一账号
            log.Operate = "U";
            log.Status = "0";

            if (string.IsNullOrEmpty(StockID))
            {
                msg.Result = false;
                msg.Message = "盘点单号不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(ContainerCode))
            {
                msg.Result = false;
                msg.Message = "货位代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                msg.Result = false;
                msg.Message = "标签号码不能为空";
                goto ERR;
            }
            CargoContainerEntity containerEntity = bus.QueryContainerEntity(new CargoContainerEntity { ContainerCode = ContainerCode });
            if (containerEntity == null || containerEntity.ContainerID.Equals(0))
            {
                msg.Result = false;
                msg.Message = "货位代码不存在";
                goto ERR;
            }
            CargoStockTakeTagEntity tagEntity = new CargoStockTakeTagEntity();
            tagEntity.TagCode = TagCode;
            tagEntity.ContainerCode = ContainerCode;
            tagEntity.StockID = Convert.ToInt32(StockID);
            tagEntity.ProductID = 0;
            tagEntity.ScanStatus = "1";
            tagEntity.ContainerID = containerEntity.ContainerID;
            tagEntity.ScanLoginName = QyUserInfo.UserID;
            tagEntity.ScanUserName = QyUserInfo.UserName;
            tagEntity.ScanDate = DateTime.Now;
            tagEntity.StockStatus = "1";
            CargoProductTagEntity tag = proBus.QueryTagByTagCode(new CargoProductTagEntity { TagCode = TagCode });
            if (tag == null || string.IsNullOrEmpty(tag.TagCode))
            {
                tagEntity.StockStatus = "3";
                bus.AddStockTakeTag(tagEntity, log);
                //扫描到的标签不存在系统中，说明没有入库
                msg.Result = false;
                msg.Message = "标签：" + TagCode + "不存在";
                goto ERR;
            }
            if (!tag.ContainerID.Equals(containerEntity.ContainerID))
            {
                tagEntity.StockStatus = "4";
                tagEntity.Remark = "标签：" + TagCode + "不在此货位，在：" + tag.ContainerCode;
                bus.AddStockTakeTag(tagEntity, log);
                //扫描到的标签不在盘点的货位
                msg.Result = false;
                msg.Message = "标签：" + TagCode + "不在此货位，在：" + tag.ContainerCode;
                goto ERR;
            }
            CargoStockTakeTagEntity takeTag = bus.QueryStockTakeTagEntity(new CargoStockTakeTagEntity { TagCode = TagCode, StockID = tagEntity.StockID });
            if (takeTag.ScanStatus.Equals("1"))
            {
                msg.Result = false;
                msg.Message = "标签：" + TagCode + "已盘点扫描";
                goto ERR;
            }
            if (tag.OutCargoStatus.Equals("1"))
            {
                tagEntity.StockStatus = "2";
                bus.AddStockTakeTag(tagEntity, log);
                msg.Result = false;
                msg.Message = "标签：" + TagCode + "已出库";
                goto ERR;
            }
            if (takeTag == null || string.IsNullOrEmpty(takeTag.TagCode))
            {
                tagEntity.StockStatus = "5";
                tagEntity.Remark = "标签：" + TagCode + "不在此盘点单";
                bus.AddStockTakeTag(tagEntity, log);
                //非盘点单上的标签
                msg.Result = false;
                msg.Message = "标签：" + TagCode + "不在此盘点单";
                goto ERR;
            }

            try
            {
                bus.AddStockTakeTag(tagEntity, log);
                msg.Result = true;

                List<CargoStockTakeTagEntity> goods = bus.QueryCargoStockTagList(new CargoStockTakeTagEntity { ContainerCode = ContainerCode, StockID = Convert.ToInt32(StockID) });
                string g = JSON.Encode(goods);
                msg.Message = g;
            }
            catch (ApplicationException ex)
            {
                msg.Result = false;
                msg.Message = "扫描失败" + ex.Message;
            }
        ERR:
            //JSON
            String json = JSON.Encode(msg);
            Response.Write(json);
        }
        /// <summary>
        /// 提交盘点单扫描
        /// </summary>
        public void TakeScanSubmit()
        {
            string StockID = Request["StockID"];//盘点单ID
            string ContainerCode = Request["ContainerCode"];//货位代码
            CargoAPIMessage msg = new CargoAPIMessage();
            msg.Result = true;
            if (string.IsNullOrEmpty(StockID))
            {
                msg.Result = false;
                msg.Message = "盘点单号不能为空";
                goto ERR;
            }
            if (StockID.Equals("0"))
            {
                msg.Result = false;
                msg.Message = "盘点单号有误";
                goto ERR;
            }

            if (string.IsNullOrEmpty(ContainerCode))
            {
                msg.Result = false;
                msg.Message = "货位代码不能为空";
                goto ERR;
            }
            string StockStatus = "1";// Request["StockStatus"];//盘点完成提交状态
            string UserID = QyUserInfo.UserID;//操作人账号
            CargoHouseBus bus = new CargoHouseBus();

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "企微盘点管理";
            log.NvgPage = "提交货位盘点";
            log.UserID = UserID;//限定某一账号
            log.Operate = "U";
            log.Status = "0";


            try
            {
                bus.UpdateStockTakeStatus(new CargoStockTakeContainerEntity { StockID = Convert.ToInt32(StockID), ContainerCode = ContainerCode, StockStatus = StockStatus }, log);
                msg.Result = true;
                msg.Message = "提交成功";
            }
            catch (ApplicationException ex)
            {
                msg.Result = false;
                msg.Message = "提交失败" + ex.Message;
            }
        ERR:
            //JSON
            String json = JSON.Encode(msg);
            Response.Write(json);
        }
        #endregion

        #region 采购单审批 
        /// <summary>
        /// 通过审批
        /// </summary>
        public void PurchaseCheckOk()
        {
            string Reason = Convert.ToString(Request["Reason"]);
            string OrderNo = Convert.ToString(Request["OrderNo"]);//订单号，商城订单号和电脑端订单号
            long OID = Convert.ToInt64(Request["OID"]);//修改表主键ID
            string Name = Convert.ToString(Request["Name"]);//收货人姓名 
            string Cellphone = Convert.ToString(Request["Cellphone"]);
            string OrderType = Convert.ToString(Request["OrderType"]);//订单类型0：商城订单1：电脑订单
            QyOrderUpdatePriceEntity result = new QyOrderUpdatePriceEntity();
            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            result.HouseID = QyUserInfo.HouseID;
            result.CheckID = QyUserInfo.UserID;
            result.CheckName = QyUserInfo.UserName;
            result.CheckTime = DateTime.Now;
            result.OrderNo = OrderNo;
            result.CheckResult = Reason;
            result.OID = OID;
            List<CargoExpenseApproveRoutEntity> approveRouteList = new List<CargoExpenseApproveRoutEntity>();
            CargoExpenseApproveRoutEntity approveRoute = new CargoExpenseApproveRoutEntity();
            approveRoute.ExID = OID;
            approveRoute.UserID = QyUserInfo.UserID;
            approveRoute.UserName = QyUserInfo.UserName;
            approveRoute.ApproveType = "1";
            approveRoute.Result = Reason;
            approveRoute.Opera = "0";
            approveRouteList.Add(approveRoute);
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "报销审批";
            log.NvgPage = "修改价格审批";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";
            QiyeBus q = new QiyeBus();
            QyOrderUpdatePriceEntity qup = q.QueryOrderUpdatePriceEntity(result);
            if (qup.ApplyStatus.Equals("3"))
            {
                msg.Result = false;
                msg.Message = "该订单已审批结束，请勿重复审批";
            }
            if (!QyUserInfo.CheckRole.Contains(qup.CheckID))
            {
                msg.Result = false;
                msg.Message = "流程未到您审批";
            }
            bool IsEnd = false;
            if (msg.Result)
            {
                string copy = string.Empty;
                //1.查询审批设置表获得审批流程
                CargoFinanceBus f = new CargoFinanceBus();
                List<QyUserEntity> qyUser = new List<QyUserEntity>();
                QySendInfoEntity send = new QySendInfoEntity();
                CargoOrderBus o = new CargoOrderBus();
                CargoApproveSetEntity AppSet = new CargoApproveSetEntity();
                string ApproveType = "3";
                switch (qup.OrderCheckType)
                {
                    case "2": ApproveType = "9"; break;
                    case "3": ApproveType = "10"; break;
                    case "4": ApproveType = "11"; break;
                    case "5": ApproveType = "12"; break;
                    case "6": ApproveType = "13"; break;
                    case "18": ApproveType = "18"; break;
                    case "19": ApproveType = "19"; break;
                    default: ApproveType = "3"; break;
                }
                List<CargoApproveSetEntity> aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = ApproveType, DelFlag = "0", HouseID = qup.HouseID });
                if (aset.Count > 0) { AppSet = aset[0]; }
                else
                {
                    aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = "3", DelFlag = "0", HouseID = qup.HouseID });
                    if (aset.Count > 0) { AppSet = aset[0]; }
                }
                AppSet.EnSafe();
                //2.审批流程的每一级和当前人的审批角色相匹配
                if (AppSet.OneCheckID.Equals(qup.CheckID))
                {
                    #region 第一级
                    send.title = AppSet.OneCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.CheckID = AppSet.TwoCheckID;
                    result.CheckName = AppSet.TwoCheckName;
                    if (string.IsNullOrEmpty(AppSet.TwoCheckID))
                    {
                        send.title = "订单改价申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.ApplyStatus = "3";
                        result.CheckID = "";// AppSet.OneCheckID;
                        result.CheckName = "";// AppSet.OneCheckName;
                        approveRoute.Opera = "2";
                        //approveRoute.Opera = "0";
                        //approveRouteList.Add(approveRoute);
                    }
                    else
                    {
                        //判断下一级是不是分公司领导，如果是则查询申请人的上级领导
                        if (AppSet.TwoCheckID.Equals("3"))
                        {
                            List<SystemUserEntity> Bosslist = o.QueryUserBossLoginName(new SystemUserEntity { LoginName = qup.ApplyID });
                            if (Bosslist.Count > 0)
                            {
                                if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                {
                                    qyUser.Add(new QyUserEntity { UserID = Bosslist[0].LoginName, WxName = Bosslist[0].UserName });
                                }
                                else
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.ThreeCheckID, CheckHouseID = qup.HouseID.ToString() });
                                }
                            }
                        }
                        else
                        {
                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID, CheckHouseID = qup.HouseID.ToString() });
                        }
                        if (!string.IsNullOrEmpty(AppSet.AutoPassID))
                        {
                            bool IsAuto = false;
                            //20221218 增加处理自动审批功能
                            if (AppSet.AutoPassID.Contains(AppSet.TwoCheckID))
                            {
                                IsAuto = true;
                                //说明第二级自动过
                                result.CheckID = AppSet.ThreeCheckID;
                                result.CheckName = AppSet.ThreeCheckName;
                                CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                                approveTwoRoute.ExID = OID;
                                approveTwoRoute.UserID = qyUser[0].UserID;
                                approveTwoRoute.UserName = qyUser[0].WxName;
                                approveTwoRoute.ApproveType = "1";
                                approveTwoRoute.Result = "自动跳过审批";
                                approveTwoRoute.Opera = "0";
                                approveRouteList.Add(approveTwoRoute);
                                //下一级为空表示审批结束
                                if (string.IsNullOrEmpty(AppSet.ThreeCheckID))
                                {
                                    IsAuto = false;
                                    send.title = "订单改价申请审批结束";
                                    //表示是最后一级
                                    IsEnd = true;
                                    result.ApplyStatus = "3";
                                    result.CheckID = "";// AppSet.OneCheckID;
                                    result.CheckName = "";// AppSet.OneCheckName;
                                    approveRoute.Opera = "2";
                                    //approveRoute.Opera = "0";
                                    approveRouteList.Add(approveRoute);
                                }
                                else
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.ThreeCheckID, CheckHouseID = qup.HouseID.ToString() });
                                }
                            }
                            if (AppSet.AutoPassID.Contains(AppSet.ThreeCheckID) && !string.IsNullOrEmpty(AppSet.ThreeCheckID) && IsAuto)
                            {
                                //说明第三级自动过
                                result.CheckID = AppSet.FourCheckID;
                                result.CheckName = AppSet.FourCheckName;
                                CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                                approveTwoRoute.ExID = OID;
                                approveTwoRoute.UserID = qyUser[0].UserID;
                                approveTwoRoute.UserName = qyUser[0].WxName;
                                approveTwoRoute.ApproveType = "1";
                                approveTwoRoute.Result = "自动跳过审批";
                                approveTwoRoute.Opera = "0";
                                approveRouteList.Add(approveTwoRoute);
                                //下一级为空表示审批结束
                                if (string.IsNullOrEmpty(AppSet.FourCheckID))
                                {
                                    IsAuto = false;
                                    send.title = "订单改价申请审批结束";
                                    //表示是最后一级
                                    IsEnd = true;
                                    result.ApplyStatus = "3";
                                    result.CheckID = "";// AppSet.OneCheckID;
                                    result.CheckName = "";// AppSet.OneCheckName;
                                    approveRoute.Opera = "2";
                                    //approveRoute.Opera = "0";
                                    approveRouteList.Add(approveRoute);
                                }
                                else
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FourCheckID, CheckHouseID = qup.HouseID.ToString() });
                                }
                            }
                            if (AppSet.AutoPassID.Contains(AppSet.FourCheckID) && !string.IsNullOrEmpty(AppSet.FourCheckID) && IsAuto)
                            {
                                //说明第三级自动过
                                result.CheckID = AppSet.FiveCheckID;
                                result.CheckName = AppSet.FiveCheckName;
                                CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                                approveTwoRoute.ExID = OID;
                                approveTwoRoute.UserID = qyUser[0].UserID;
                                approveTwoRoute.UserName = qyUser[0].WxName;
                                approveTwoRoute.ApproveType = "1";
                                approveTwoRoute.Result = "自动跳过审批";
                                approveTwoRoute.Opera = "0";
                                approveRouteList.Add(approveTwoRoute);
                                //下一级为空表示审批结束
                                if (string.IsNullOrEmpty(AppSet.FiveCheckID))
                                {
                                    IsAuto = false;
                                    send.title = "订单改价申请审批结束";
                                    //表示是最后一级
                                    IsEnd = true;
                                    result.ApplyStatus = "3";
                                    result.CheckID = "";// AppSet.OneCheckID;
                                    result.CheckName = "";// AppSet.OneCheckName;
                                    approveRoute.Opera = "2";
                                    //approveRoute.Opera = "0";
                                    approveRouteList.Add(approveRoute);
                                }
                                else
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FiveCheckID, CheckHouseID = qup.HouseID.ToString() });
                                }
                            }
                            if (AppSet.AutoPassID.Contains(AppSet.FiveCheckID) && !string.IsNullOrEmpty(AppSet.FiveCheckID) && IsAuto)
                            {
                                //说明第三级自动过
                                result.CheckID = AppSet.SixCheckID;
                                result.CheckName = AppSet.SixCheckName;
                                CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                                approveTwoRoute.ExID = OID;
                                approveTwoRoute.UserID = qyUser[0].UserID;
                                approveTwoRoute.UserName = qyUser[0].WxName;
                                approveTwoRoute.ApproveType = "1";
                                approveTwoRoute.Result = "自动跳过审批";
                                approveTwoRoute.Opera = "0";
                                approveRouteList.Add(approveTwoRoute);
                                //下一级为空表示审批结束
                                if (string.IsNullOrEmpty(AppSet.SixCheckID))
                                {
                                    IsAuto = false;
                                    send.title = "订单改价申请审批结束";
                                    //表示是最后一级
                                    IsEnd = true;
                                    result.ApplyStatus = "3";
                                    result.CheckID = "";// AppSet.OneCheckID;
                                    result.CheckName = "";// AppSet.OneCheckName;
                                    approveRoute.Opera = "2";
                                    //approveRoute.Opera = "0";
                                    approveRouteList.Add(approveRoute);
                                }
                                else
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SixCheckID, CheckHouseID = qup.HouseID.ToString() });
                                }
                            }
                        }
                    }
                    #endregion
                }
                else if (AppSet.TwoCheckID.Equals(qup.CheckID))
                {
                    #region 第二级
                    send.title = AppSet.TwoCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.CheckID = AppSet.ThreeCheckID;
                    result.CheckName = AppSet.ThreeCheckName;
                    if (string.IsNullOrEmpty(AppSet.ThreeCheckID))
                    {
                        send.title = "订单改价申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.ApplyStatus = "3";
                        result.CheckID = "";//AppSet.TwoCheckID;
                        result.CheckName = "";// AppSet.TwoCheckName;
                        approveRoute.Opera = "2";
                        //approveRouteList.Add(approveRoute);
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.ThreeCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    if (!string.IsNullOrEmpty(AppSet.AutoPassID))
                    {
                        bool IsAuto = false;
                        if (!string.IsNullOrEmpty(AppSet.ThreeCheckID) && AppSet.AutoPassID.Contains(AppSet.ThreeCheckID))
                        {
                            IsAuto = true;
                            //说明第三级自动过
                            result.CheckID = AppSet.FourCheckID;
                            result.CheckName = AppSet.FourCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.FourCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FourCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                        if (!string.IsNullOrEmpty(AppSet.FourCheckID) && AppSet.AutoPassID.Contains(AppSet.FourCheckID) && IsAuto)
                        {
                            //说明第三级自动过
                            result.CheckID = AppSet.FiveCheckID;
                            result.CheckName = AppSet.FiveCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.FiveCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FiveCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                        if (!string.IsNullOrEmpty(AppSet.FiveCheckID) && AppSet.AutoPassID.Contains(AppSet.FiveCheckID) && IsAuto)
                        {
                            //说明第三级自动过
                            result.CheckID = AppSet.SixCheckID;
                            result.CheckName = AppSet.SixCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.SixCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SixCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                    }
                    #endregion
                }
                else if (AppSet.ThreeCheckID.Equals(qup.CheckID))
                {
                    #region 第三级
                    send.title = AppSet.ThreeCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.CheckID = AppSet.FourCheckID;
                    result.CheckName = AppSet.FourCheckName;
                    if (string.IsNullOrEmpty(AppSet.FourCheckID))
                    {
                        send.title = "订单改价申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.ApplyStatus = "3";
                        result.CheckID = "";//AppSet.ThreeCheckID;
                        result.CheckName = "";// AppSet.ThreeCheckName;
                        approveRoute.Opera = "2";
                        //approveRouteList.Add(approveRoute);
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FourCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    if (!string.IsNullOrEmpty(AppSet.AutoPassID))
                    {
                        bool IsAuto = false;
                        if (!string.IsNullOrEmpty(AppSet.FourCheckID) && AppSet.AutoPassID.Contains(AppSet.FourCheckID))
                        {
                            IsAuto = true;
                            //说明第三级自动过
                            result.CheckID = AppSet.FiveCheckID;
                            result.CheckName = AppSet.FiveCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.FiveCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FiveCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                        if (!string.IsNullOrEmpty(AppSet.FiveCheckID) && AppSet.AutoPassID.Contains(AppSet.FiveCheckID) && IsAuto)
                        {
                            //说明第三级自动过
                            result.CheckID = AppSet.SixCheckID;
                            result.CheckName = AppSet.SixCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.SixCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SixCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                        if (!string.IsNullOrEmpty(AppSet.SixCheckID) && AppSet.AutoPassID.Contains(AppSet.SixCheckID) && IsAuto)
                        {
                            //说明第三级自动过
                            result.CheckID = AppSet.SevenCheckID;
                            result.CheckName = AppSet.SevenCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.SevenCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SevenCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                    }
                    #endregion
                }
                else if (AppSet.FourCheckID.Equals(qup.CheckID))
                {
                    #region 第四级
                    send.title = AppSet.FourCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.CheckID = AppSet.FiveCheckID;
                    result.CheckName = AppSet.FiveCheckName;
                    if (string.IsNullOrEmpty(AppSet.FiveCheckID))
                    {
                        send.title = "订单改价申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.ApplyStatus = "3";
                        result.CheckID = "";//AppSet.FourCheckID;
                        result.CheckName = "";//AppSet.FourCheckName;
                        approveRoute.Opera = "2";
                        //approveRouteList.Add(approveRoute);
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.FiveCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    if (!string.IsNullOrEmpty(AppSet.AutoPassID))
                    {
                        bool IsAuto = false;
                        if (!string.IsNullOrEmpty(AppSet.FiveCheckID) && AppSet.AutoPassID.Contains(AppSet.FiveCheckID))
                        {
                            IsAuto = true;
                            //说明第三级自动过
                            result.CheckID = AppSet.SixCheckID;
                            result.CheckName = AppSet.SixCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.SixCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;

                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SixCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                        if (!string.IsNullOrEmpty(AppSet.SixCheckID) && AppSet.AutoPassID.Contains(AppSet.SixCheckID) && IsAuto)
                        {
                            //说明第三级自动过
                            result.CheckID = AppSet.SevenCheckID;
                            result.CheckName = AppSet.SevenCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.SevenCheckID))
                            {
                                IsAuto = false;
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                CargoExpenseApproveRoutEntity endRoute = new CargoExpenseApproveRoutEntity();
                                endRoute.ExID = OID;
                                endRoute.UserID = QyUserInfo.UserID;
                                endRoute.UserName = QyUserInfo.UserName;
                                endRoute.ApproveType = "1";
                                endRoute.Result = Reason;
                                endRoute.Opera = "2";
                                approveRouteList.Add(endRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SevenCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                    }
                    #endregion
                }
                else if (AppSet.FiveCheckID.Equals(qup.CheckID))
                {
                    #region 第五级
                    send.title = AppSet.FiveCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.CheckID = AppSet.SixCheckID;
                    result.CheckName = AppSet.SixCheckName;
                    if (string.IsNullOrEmpty(AppSet.SixCheckID))
                    {
                        send.title = "订单改价申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.ApplyStatus = "3";
                        result.CheckID = "";// AppSet.FiveCheckID;
                        result.CheckName = "";//AppSet.FiveCheckName;
                        approveRoute.Opera = "2";
                        //approveRouteList.Add(approveRoute);
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SixCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    if (!string.IsNullOrEmpty(AppSet.AutoPassID))
                    {
                        if (!string.IsNullOrEmpty(AppSet.SixCheckID) && AppSet.AutoPassID.Contains(AppSet.SixCheckID))
                        {
                            //说明第三级自动过
                            result.CheckID = AppSet.SevenCheckID;
                            result.CheckName = AppSet.SevenCheckName;
                            CargoExpenseApproveRoutEntity approveTwoRoute = new CargoExpenseApproveRoutEntity();
                            approveTwoRoute.ExID = OID;
                            approveTwoRoute.UserID = qyUser[0].UserID;
                            approveTwoRoute.UserName = qyUser[0].WxName;
                            approveTwoRoute.ApproveType = "1";
                            approveTwoRoute.Result = "自动跳过审批";
                            approveTwoRoute.Opera = "0";
                            approveRouteList.Add(approveTwoRoute);
                            //下一级为空表示审批结束
                            if (string.IsNullOrEmpty(AppSet.SevenCheckID))
                            {
                                send.title = "订单改价申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.ApplyStatus = "3";
                                result.CheckID = "";// AppSet.OneCheckID;
                                result.CheckName = "";// AppSet.OneCheckName;
                                approveRoute.Opera = "2";
                                //approveRoute.Opera = "0";
                                approveRouteList.Add(approveRoute);
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SevenCheckID, CheckHouseID = qup.HouseID.ToString() });
                            }
                        }
                    }
                    #endregion
                }
                else if (AppSet.SixCheckID.Equals(qup.CheckID))
                {
                    #region 第六级
                    send.title = AppSet.SixCheckName + "审批通过";
                    result.ApplyStatus = "1";
                    result.CheckID = AppSet.SevenCheckID;
                    result.CheckName = AppSet.SevenCheckName;
                    if (string.IsNullOrEmpty(AppSet.SevenCheckID))
                    {
                        send.title = "订单改价申请审批结束";
                        //表示是最后一级
                        IsEnd = true;
                        result.ApplyStatus = "3";
                        result.CheckID = "";// AppSet.FiveCheckID;
                        result.CheckName = "";//AppSet.FiveCheckName;
                        approveRoute.Opera = "2";
                        //approveRouteList.Add(approveRoute);
                    }
                    else
                    {
                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.SevenCheckID, CheckHouseID = qup.HouseID.ToString() });
                    }
                    #endregion
                }

                q.CheckUpdatePrice(result, log);
                foreach (var aroute in approveRouteList)
                {
                    f.AddExpenseApproveRout(aroute);

                }
                //f.AddExpenseApproveRout(approveRoute);
                //添加申请单与审批人关系数据
                Common.WriteTextLog("添加申请单与审批人关系数据" + OID.ToString() + QyUserInfo.UserID + QyUserInfo.UserName);
                if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = OID, CheckUserID = QyUserInfo.UserID, CheckType = "0", ApproveType = "1" }))
                {
                    Common.WriteTextLog("判断正确" + OID.ToString() + QyUserInfo.UserID + QyUserInfo.UserName);
                    f.AddApproveCheck(new CargoApproveCheckEntity
                    {
                        ApproveID = OID,
                        CheckUserID = QyUserInfo.UserID,
                        CheckName = QyUserInfo.UserName,
                        CheckType = "0",
                        ReadStatus = "1",
                        ApproveType = "1"
                    }, log);
                    Common.WriteTextLog("操作完成" + OID.ToString() + QyUserInfo.UserID + QyUserInfo.UserName);

                }
                //如果 是最后审批人，就结束
                if (IsEnd)
                {
                    #region 修改数据
                    if (OrderType.Equals("0"))
                    {
                        //修改商城订单价格
                        q.UpdateWxMallOrderPrice(result, log);
                    }
                    else
                    {
                        //修改电脑订单价格
                        CargoOrderBus obus = new CargoOrderBus();
                        CargoOrderEntity orderEnt = obus.QueryOrderInfo(new CargoOrderEntity { OrderNo = OrderNo });
                        obus.UpdateCargoOrderModifyPriceStatus(new CargoOrderEntity { OrderNo = OrderNo, ModifyPriceStatus = "0" }, log);
                        CargoHouseBus house = new CargoHouseBus();
                        CargoHouseEntity houseEnt = house.QueryCargoHouseByID(orderEnt.HouseID);
                        if (orderEnt.HouseID.Equals(9) && orderEnt.ThrowGood.Equals("15"))
                        {
                            //速配单
                            obus.InsertCargoOrderPush(new CargoOrderPushEntity
                            {
                                OrderNo = orderEnt.OrderNo,
                                Dep = orderEnt.Dep,
                                Dest = orderEnt.Dest,
                                Piece = orderEnt.Piece,
                                TransportFee = orderEnt.TransportFee,
                                ClientNum = orderEnt.ClientNum.ToString(),
                                AcceptAddress = orderEnt.AcceptAddress,
                                AcceptCellphone = orderEnt.AcceptCellphone,
                                AcceptTelephone = orderEnt.AcceptTelephone,
                                AcceptPeople = orderEnt.AcceptPeople,
                                AcceptUnit = orderEnt.AcceptUnit,
                                HouseID = orderEnt.HouseID.ToString(),
                                HouseName = "新陆城配",
                                OP_ID = qup.ApplyName,
                                PushType = "0",
                                PushStatus = "0",
                                LogisID = orderEnt.LogisID
                            }, log);
                        }
                        if (orderEnt.HouseID.Equals(9) || orderEnt.HouseID.Equals(15) || orderEnt.HouseID.Equals(49) || orderEnt.HouseID.Equals(50) || orderEnt.HouseID.Equals(51) || orderEnt.HouseID.Equals(52) || orderEnt.HouseID.Equals(53) || orderEnt.HouseID.Equals(54) || orderEnt.HouseID.Equals(13) || orderEnt.HouseID.Equals(14) || orderEnt.HouseID.Equals(15) || orderEnt.HouseID.Equals(23) || orderEnt.HouseID.Equals(30) || orderEnt.HouseID.Equals(93))
                        {
                            //判断必须选择好来运速递
                            if (orderEnt.LogisID.Equals(34))
                            {
                                //广州仓库
                                if (orderEnt.HouseID.Equals(9))
                                {
                                    //等通知发货的订单不推送
                                    if (orderEnt.PostponeShip != "1")
                                    {
                                        List<CargoContainerShowEntity> outHouseList = obus.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = orderEnt.OrderNo });
                                        //内部订单
                                        obus.SaveHlyOrderData(outHouseList, orderEnt);
                                    }
                                }
                                else
                                {
                                    List<CargoContainerShowEntity> outHouseList = obus.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = orderEnt.OrderNo });
                                    //内部订单
                                    obus.SaveHlyOrderData(outHouseList, orderEnt);
                                }
                            }
                        }
                        else
                        {
                            obus.InsertCargoOrderPush(new CargoOrderPushEntity
                            {
                                OrderNo = orderEnt.OrderNo,
                                Dep = orderEnt.Dep,
                                Dest = orderEnt.Dest,
                                Piece = orderEnt.Piece,
                                TransportFee = orderEnt.TransportFee,
                                ClientNum = orderEnt.ClientNum.ToString(),
                                AcceptAddress = orderEnt.AcceptAddress,
                                AcceptCellphone = orderEnt.AcceptCellphone,
                                AcceptTelephone = orderEnt.AcceptTelephone,
                                AcceptPeople = orderEnt.AcceptPeople,
                                AcceptUnit = orderEnt.AcceptUnit,
                                HouseID = orderEnt.HouseID.ToString(),
                                HouseName = houseEnt.Name,
                                OP_ID = qup.ApplyName,
                                PushType = "0",
                                PushStatus = "0",
                                LogisID = orderEnt.LogisID
                            }, log);
                        }
                    }
                    #endregion

                    List<QyUserEntity> cQyU = new List<QyUserEntity>();
                    if (!string.IsNullOrEmpty(AppSet.CopyCheck))
                    {
                        cQyU = q.QueryUserList(new QyUserEntity { CheckRole = AppSet.CopyCheck });
                    }
                    foreach (var c in cQyU)
                    {
                        //添加申请单与审批人关系数据
                        if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = OID, CheckUserID = c.UserID, ApproveType = "1" }))
                        {
                            f.AddApproveCheck(new CargoApproveCheckEntity
                            {
                                ApproveID = OID,
                                CheckUserID = c.UserID,
                                CheckName = c.WxName,
                                CheckType = "1",
                                ReadStatus = "1",
                                ApproveType = "1"
                            }, log);
                        }
                        if (!copy.Contains(c.UserID))
                        {
                            copy += c.UserID + ",";
                        }
                    }
                    if (!string.IsNullOrEmpty(AppSet.CopyUserID) && !string.IsNullOrEmpty(AppSet.CopyCheckName))
                    {
                        string[] uS = AppSet.CopyUserID.Split(',');
                        string[] uName = AppSet.CopyUserName.Split(',');
                        if (uS.Length > 0)
                        {
                            for (int i = 0; i < uS.Length; i++)
                            {
                                if (!string.IsNullOrEmpty(uS[i]))
                                {
                                    //添加申请单与审批人关系数据
                                    if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = OID, CheckUserID = uS[i], ApproveType = "1" }))
                                    {
                                        f.AddApproveCheck(new CargoApproveCheckEntity
                                        {
                                            ApproveID = OID,
                                            CheckUserID = uS[i],
                                            CheckName = uName[i],
                                            CheckType = "1",
                                            ReadStatus = "1",
                                            ApproveType = "1"
                                        }, log);
                                    }
                                    if (!copy.Contains(uS[i]))
                                    {
                                        copy += uS[i] + ",";
                                    }
                                }
                            }
                        }
                    }
                    try
                    {
                        if (OrderType.Equals("0"))
                        {
                            CargoOrderBus obus = new CargoOrderBus();
                            string wxopenID = obus.QueryWeixinOpenIDByOrderNo(OrderNo);
                            //推送客户改价成功通知
                            WxCustomSend wxsend = new WxCustomSend();
                            string token = Common.GetWeixinToken(Common.GetdltAPPID(), Common.GetdltAppSecret());
                            wxsend.SendWeiXinInfo(token, wxopenID, new QySendInfoEntity { content = "您的订单：" + OrderNo + "改价申请已通过，请到我的订单进行支付，谢谢！", msgType = msgType.text });
                        }
                    }
                    catch (ApplicationException exx)
                    {
                        msg.Result = true;
                        Common.WriteTextLog(OrderNo + "推送客户通知失败");
                    }
                }
                if (qyUser.Count > 0 || IsEnd)
                {
                    #region 推送通知
                    try
                    {
                        //推送给提交人
                        send.msgType = msgType.textcard;
                        send.toUser = qup.ApplyID;
                        //send.toUser = ou.ApplyID;
                        //send.toTag = strTag;
                        send.content = "<div></div><div>订单号：" + OrderNo + "</div><div>收货人：" + Name + "  " + Cellphone + "</div><div>审批人：" + QyUserInfo.UserName + "</div><div>审批时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>审批意见：" + result.CheckResult + "</div><div></div>";
                        send.url = "http://dlt.neway5.com/QY/qyApproveCheck.aspx?OrderNo=" + OrderNo + "&OID=" + OID + "&OrderType=" + OrderType;
                        WxQYSendHelper.PushInfo("0", "3", send);
                    }
                    catch (Exception)
                    {
                        msg.Result = true;
                    }
                    //推送给下一审批人
                    foreach (var it in qyUser)
                    {
                        try
                        {
                            send.toUser = it.UserID;
                            WxQYSendHelper.PushInfo("0", "2", send);
                        }
                        catch (Exception ex)
                        {
                            continue;
                        }
                    }
                    if (!string.IsNullOrEmpty(copy))
                    {
                        copy = copy.Substring(0, copy.Length - 1);
                        try
                        {
                            send.toUser = copy;
                            WxQYSendHelper.PushInfo("0", "2", send);
                        }
                        catch (Exception ex)
                        {
                            msg.Result = true;
                        }
                    }
                    #endregion
                }
                #region 创建群聊窗口和推送信息
                ////创建群聊窗口和推送信息
                //if (!qup.HouseID.Equals(64))
                //{
                //    try
                //    {
                //        string oU = "http://dlt.neway5.com/QY/qyApproveCheck.aspx?OrderNo=" + OrderNo + "&OID=" + OID + "&OrderType=" + OrderType;
                //        QyGroupChatEntity chat = q.QueryGroupChatEntity(new QyGroupChatEntity { HouseID = qup.HouseID, ChatType = "0" });
                //        if (chat.ID.Equals(0))
                //        {
                //            //string[] ul = { "0007", "2081", "1079" };
                //            List<string> lis = new List<string>();
                //            lis.Add("0007");
                //            lis.Add("2081");
                //            lis.Add("1079");
                //            //lis.Add("1000");
                //            //lis.Add("2076");
                //            //lis.Add(qup.ApplyID);
                //            string hN = string.Empty;
                //            switch (qup.HouseID)
                //            {
                //                case 1: hN = "湖南迪乐泰改价审批群"; lis.Add("1006"); break;
                //                case 3: hN = "湖北迪乐泰改价审批群"; lis.Add("1061"); break;
                //                //case 9: hN = "广州迪乐泰改价审批群"; lis.Add("2096"); break;
                //                case 11: hN = "西安迪乐泰改价审批群"; lis.Add("1061"); break;
                //                //case 34: hN = "海南迪乐泰改价审批群"; lis.Add("2096"); break;
                //                //case 12: hN = "梅州迪乐泰改价审批群"; lis.Add("2096"); break;
                //                //case 44: hN = "揭阳迪乐泰改价审批群"; lis.Add("2096"); break;
                //                //case 45: hN = "广东仓库改价审批群"; lis.Add("2096"); break;
                //                case 46: hN = "四川迪乐泰改价审批群"; break;
                //                case 48: hN = "重庆迪乐泰改价审批群"; lis.Add("1061"); break;
                //                default:
                //                    break;
                //            }
                //            string ChatID = DateTime.Now.ToString("yyMMddHHmmss");

                //            //表示没有群聊，要新增
                //            q.AddGroupChat(new QyGroupChatEntity { ChatName = hN, HouseID = qup.HouseID, ChatType = "0", Owner = "0007", ChatID = ChatID }, log);
                //            WxQYSendHelper.CreateChat(ChatID, hN, "0007", lis.ToArray(), "1000003");

                //            //向群聊里推送审批通知
                //            QySendInfoEntity qysend = new QySendInfoEntity();
                //            qysend.agentID = "1000003";
                //            qysend.msgType = msgType.markdown;
                //            qysend.ChatID = ChatID;
                //            qysend.content = "订单号**" + qup.OrderNo + "**改价审批已通过\n>**审批意见** \n>\n><font color=\"info\">" + Reason + "</font>\n>\n>审批人：" + qup.CheckName + "\n>\n>查看审批流程请点击：[审批流程](" + oU + ")";
                //            WxQYSendHelper.SendChatInfo(qysend);
                //        }
                //        else
                //        {
                //            //向群聊里推送审批通知
                //            QySendInfoEntity qysend = new QySendInfoEntity();
                //            qysend.agentID = "1000003";
                //            qysend.msgType = msgType.markdown;
                //            qysend.ChatID = chat.ChatID;
                //            qysend.content = "订单号**" + qup.OrderNo + "**改价审批已通过\n>**审批意见** \n>\n><font color=\"info\">" + Reason + "</font>\n>\n>审批人：" + qup.CheckName + "\n>\n>查看审批流程请点击：[审批流程](" + oU + ")";
                //            WxQYSendHelper.SendChatInfo(qysend);
                //        }
                //    }
                //    catch (ApplicationException ex)
                //    {
                //        msg.Result = true;
                //    }
                //}
                #endregion
            }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 拒绝审批
        /// </summary>
        public void PurchaseCheckNo()
        {
            string Reason = Convert.ToString(Request["Reason"]);
            string OrderNo = Convert.ToString(Request["OrderNo"]);
            long OID = Convert.ToInt64(Request["OID"]);
            string Name = Convert.ToString(Request["Name"]);//收货人姓名 
            string Cellphone = Convert.ToString(Request["Cellphone"]);
            string OrderType = Convert.ToString(Request["OrderType"]);//订单类型0：商城订单1：电脑订单
            QyOrderUpdatePriceEntity result = new QyOrderUpdatePriceEntity();
            ErrMessage msg = new ErrMessage(); msg.Message = ""; msg.Result = true;
            result.HouseID = QyUserInfo.HouseID;
            result.CheckID = "";// QyUserInfo.UserID;
            result.CheckName = "";// QyUserInfo.UserName;
            result.CheckTime = DateTime.Now;
            result.OrderNo = OrderNo;
            result.ApplyStatus = "2";
            result.CheckResult = Reason;
            result.OID = OID;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "报销审批";
            log.NvgPage = "修改价格审批";
            log.UserID = QyUserInfo.UserID;
            log.Status = "0";
            log.Operate = "U";
            QiyeBus bus = new QiyeBus();
            QyOrderUpdatePriceEntity qup = bus.QueryOrderUpdatePriceEntity(result);
            if (qup.ApplyStatus.Equals("3"))
            {
                msg.Result = false;
                msg.Message = "该订单已审批结束，请勿重复审批";
            }
            if (!QyUserInfo.CheckRole.Contains(qup.CheckID))
            {
                msg.Result = false;
                msg.Message = "流程未到您审批";
            }
            if (msg.Result)
            {
                CargoExpenseApproveRoutEntity approveRoute = new CargoExpenseApproveRoutEntity();
                approveRoute.ExID = OID;
                approveRoute.UserID = QyUserInfo.UserID;
                approveRoute.UserName = QyUserInfo.UserName;
                approveRoute.ApproveType = "1";
                approveRoute.Result = Reason;
                approveRoute.Opera = "1";//拒审

                CargoFinanceBus f = new CargoFinanceBus();
                bus.CheckUpdatePrice(result, log);
                f.AddExpenseApproveRout(approveRoute);
                //添加申请单与审批人关系数据
                if (!f.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = OID, CheckUserID = QyUserInfo.UserID, CheckType = "0", ApproveType = "1" }))
                {
                    f.AddApproveCheck(new CargoApproveCheckEntity
                    {
                        ApproveID = OID,
                        CheckUserID = QyUserInfo.UserID,
                        CheckName = QyUserInfo.UserName,
                        CheckType = "0",
                        ReadStatus = "1",
                        ApproveType = "1"
                    }, log);
                }
                if (OrderType.Equals("1"))
                {
                    //电脑订单，删除订单
                    CargoOrderBus obus = new CargoOrderBus();
                    CargoOrderEntity orderEnt = obus.QueryOrderInfoByOrderID(qup.OrderID);
                    orderEnt.DeleteID = QyUserInfo.UserID;
                    orderEnt.DeleteName = QyUserInfo.UserName;
                    List<CargoOrderEntity> ol = new List<CargoOrderEntity>();
                    ol.Add(orderEnt);

                    //仓库同步缓存
                    CargoHouseBus house = new CargoHouseBus();
                    List<CargoProductEntity> syncProduct = house.SyncTypeOrderNo(OrderNo);
                    foreach (CargoProductEntity product in syncProduct)
                    {

                        if (product.SyncType == "2" || (product.SyncType == "1" && product.TypeID == 34))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + product.HouseID + "_" + product.TypeID + "_" + product.ProductCode + "", product.GoodsCode);
                        }
                    }

                    obus.DeleteOrderInfo(ol, log);
                }
                try
                {
                    QySendInfoEntity send = new QySendInfoEntity();
                    send.title = "订单改价申请拒审";
                    send.msgType = msgType.textcard;
                    send.toUser = qup.ApplyID;
                    //send.toTag = strTag;
                    send.content = "<div></div><div>订单号：" + OrderNo + "</div><div>收货人：" + Name + "  " + Cellphone + "</div><div>审批人：" + result.CheckName + "</div><div>审批时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>审批意见：" + result.CheckResult + "</div><div>审批结果：未通过</div>";
                    send.url = "http://dlt.neway5.com/QY/qyApproveCheck.aspx?OrderNo=" + OrderNo + "&OID=" + OID + "&OrderType=" + OrderType;
                    WxQYSendHelper.PushInfo("0", "3", send);
                    //send.toUser = "0007";
                    //WxQYSendHelper.PushInfo("0", "2", send);
                }
                catch (ApplicationException ex)
                {
                    msg.Result = true;
                }
                ////创建群聊窗口和推送信息
                //if (!qup.HouseID.Equals(64))
                //{
                //    try
                //    {
                //        string oU = "http://dlt.neway5.com/QY/qyApproveCheck.aspx?OrderNo=" + OrderNo + "&OID=" + OID + "&OrderType=" + OrderType;
                //        QyGroupChatEntity chat = bus.QueryGroupChatEntity(new QyGroupChatEntity { HouseID = qup.HouseID, ChatType = "0" });
                //        if (!chat.ID.Equals(0))
                //        {
                //            //向群聊里推送审批通知
                //            QySendInfoEntity qysend = new QySendInfoEntity();
                //            qysend.agentID = "1000003";
                //            qysend.msgType = msgType.markdown;
                //            qysend.ChatID = chat.ChatID;
                //            qysend.content = "订单号**" + OrderNo + "**改价审批拒绝\n>**拒审意见** \n>\n><font color=\"info\">" + Reason + "</font>\n>\n>审批人：" + qup.CheckName + "\n>\n>查看审批流程请点击：[审批流程](" + oU + ")";
                //            WxQYSendHelper.SendChatInfo(qysend);
                //        }
                //    }
                //    catch (ApplicationException ex)
                //    {
                //        msg.Result = true;
                //    }
                //}
            }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }

        #endregion
    }
}