<%@ Page Title="批量导入订单" Language="C#" MasterPageFile="~/Site.Master" AutoEventWireup="true" CodeBehind="BatchImportOrder.aspx.cs" Inherits="Cargo.Order.BatchImportOrder" %>

<asp:Content ID="Content1" ContentPlaceHolderID="head" runat="server">
    <script type="text/javascript">
        //页面加载时执行
        window.onload = function () {
            //$.ajaxSetup({ async: true });
            document.body.style.overflow = 'hidden';
            adjustment();
            document.body.style.overflow = 'auto';
        }
        $(window).resize(function () {
            document.body.style.overflow = 'hidden';
            adjustment();
            document.body.style.overflow = 'auto';
        });
        function adjustment() {
            var height = Number($(window).height()) - $("div[name='SelectDiv1']").outerHeight(true);
            $('#dg').datagrid({ height: height });

            var bodyWidth = document.body.clientWidth;
            // 输出宽度
            $('#saPanel').width(bodyWidth);
            $('#saPanel').parent('div').css('width', bodyWidth + 'px');

        }
        //页面加载显示遮罩层防止用户看见未加载CSS的页面
        var pc;
        $.parser.onComplete = function () {
            if (pc) {
                clearTimeout(pc);
            }
            pc = setTimeout(closemask, 10);
        }
        //加载完成后关闭遮罩层
        function closemask() {
            $("#Loading").fadeOut("normal", function () {
                $(this).remove();
            });
        }

        $(document).ready(function () {
            var columns = [];
            columns.push({ title: '', field: '', checkbox: true });
            columns.push({ title: 'ID号', field: 'TID' });
            columns.push({ title: '区域', field: 'Region' });
            columns.push({ title: '省份', field: 'Province' });
            columns.push({ title: '城市', field: 'City' });
            columns.push({ title: '店代码', field: 'SourceCode' });
            columns.push({ title: '客户名称', field: 'SourceName' });
            columns.push({ title: '发票号码', field: 'GtmcNo' });
            columns.push({ title: '订单所属公司', field: 'OrderOwnerName' });
            columns.push({ title: '货品代码', field: 'GoodsCode' });
            columns.push({ title: '数量', field: 'Piece', align: 'right' });
            columns.push({ title: '总库存', field: 'InPiece', align: 'right' });
            columns.push({
                title: '订单状态', field: 'OrderStatus', formatter: function (val, row, index) {
                    if (val == "0") { return "<span title='未生成'>未生成</span>"; }
                    else if (val == "1") { return "<span title='已生成'>已生成</span>"; }
                    else { return "<span title=''></span>" }
                }
            });
            columns.push({ title: '出库单号', field: 'OrderNo' });
            columns.push({
                title: '出库状态', field: 'AwbStatus', formatter: function (val, row, index) {
                    if (val == "0") { return "<span title='未出库'>未出库</span>"; }
                    else if (val == "1") { return "<span title='出库中'>出库中</span>"; }
                    else if (val == "2") { return "<span title='已出库'>已出库</span>" }
                    else { return "<span title=''></span>" }
                }
            });
            columns.push({ title: '开单时间', field: 'CreateDate' });
            columns.push({ title: '运输线路', field: 'LineName' });
            
            columns.push({ title: '品牌', field: 'TypeName' });
            columns.push({ title: '规格', field: 'Specs' });
            columns.push({ title: '花纹', field: 'Figure' });
            columns.push({
                title: '载速', field: 'LoadIndexSpeedLevel', formatter: function (val, row, index) {
                    return row.LoadIndex + row.SpeedLevel;
                }
            });
            columns.push({ title: '备注', field: 'Memo' });
            columns.push({ title: '业务名称', field: 'BusinessName' });
            columns.push({
                title: '分配订单类型', field: 'OrderAlloType', formatter: function (val, row, index) {
                    if (val == "0") { return "<span title='手工开单'>正常</span>"; }
                    else if (val == "1") { return "<span title='自动开单'>跨仓</span>"; }
                    else if (val == "2") { return "<span title='自动开单'>外采</span>"; }
                    else { return "<span title=''></span>" }
                }
            });
            //columns.push({ title: '清单ID', field: 'ExterOrderAlloNum' });
            columns.push({
                title: '清单ID', field: 'ExterOrderAlloNum', formatter: function (val, row, index) {
                    console.log(val,"11111111111111111111111")
                    if (val != "0") { return val; }
                    return "-";
                    //if (val == "0") { return "1111"; }
                    //else {  }
                }
            });
            columns.push({
                title: '处理状态', field: 'AutoOrderHandleStatus', formatter: function (val, row, index) {
                    if (val == "0") { return "<span title='未处理'>未处理</span>"; }
                    else if (val == "1") { return "<span title='已处理'>已处理</span>"; }
                    else { return "<span title=''></span>" }
                }
            });
            columns.push({
                title: '处理类型', field: 'OrderHandleType', formatter: function (val, row, index) {
                    if (val == "0") { return "<span title='手工开单'>手工处理</span>"; }
                    else if (val == "1") { return "<span title='自动开单'>自动处理</span>"; }
                    else { return "<span title=''></span>" }
                }
            });
            columns.push({ title: '处理时间', field: 'AutoOrderHandleTime', formatter: DateTimeFormatter });
            columns.push({ title: '操作人员', field: 'OPName' });
            columns.push({ title: '导单时间', field: 'OPDATE', formatter: DateTimeFormatter });
            $('#dg').datagrid({
                width: '100%',
                title: '', //标题内容
                loadMsg: '数据加载中请稍候...',
                autoRowHeight: false, //行高是否自动
                collapsible: true, //是否可折叠
                pagination: true, //分页是否显示
                pageSize: 100, //每页多少条
                pageList: [100, 200],
                //pageSize: Math.floor((Number($(window).height()) - $("div[name='SelectDiv1']").outerHeight(true) - 58) / 28), //每页多少条
                //pageList: [Math.floor((Number($(window).height()) - $("div[name='SelectDiv1']").outerHeight(true) - 58) / 28), Math.floor((Number($(window).height()) - $("div[name='SelectDiv1']").outerHeight(true) - 58) / 28) * 2],
                fitColumns: true, //设置为 true，则会自动扩大或缩小列的尺寸以适应网格的宽度并且防止水平滚动
                singleSelect: false, //设置为 true，则只允许选中一行。
                checkOnSelect: true, //如果设置为 true，当用户点击某一行时，则会选中/取消选中复选框。如果设置为 false 时，只有当用户点击了复选框时，才会选中/取消选中复选框
                idField: 'TID',
                url: null,
                toolbar: '#toolbar',
                columns: [columns],
                onLoadSuccess: function (data) { },
                onClickRow: function (index, row) {
                    $('#dg').datagrid('clearSelections');
                    $('#dg').datagrid('selectRow', index);
                },
                rowStyler: function (index, row) {

                    if (row.OrderAlloType == "0") { return "background-color:#EEF9FF"; }//正常
                    if (row.OrderAlloType == "1") { return "background-color:#FFFCF2"; }//跨仓
                    if (row.OrderAlloType == "2") { return "background-color:#FFF3F3"; }//外采

                    //if (row.InPiece < row.Piece && row.OrderStatus == "0") { return "background-color:#FCC7C7"; }
                    //if (row.OrderStatus == "0") { return "background-color:#FCF3CF"; }
                },
                onDblClickRow: function (index, row) {
                    editItemByID(index);
                }
            });
            //所在仓库
            $('#AHouseID').combobox({
                url: '../House/houseApi.aspx?method=CargoPermisionHouse',
                valueField: 'HouseID', textField: 'Name',
                onSelect: function (rec) {
                    $('#ALineID').combobox('clear');
                    var url = '../House/houseApi.aspx?method=QueryCargoLogisLineList&hid=' + rec.HouseID;
                    $('#ALineID').combobox('reload', url);
                }
            });
            $('#AHouseID').combobox('setValue', '<%=UserInfor.HouseID%>');
            $('#ALineID').combobox('clear');
            var url = '../House/houseApi.aspx?method=QueryCargoLogisLineList&hid=<%=UserInfor.HouseID%>';
            $('#ALineID').combobox('reload', url);
            var datenow = new Date();
            $('#StartDate').datebox('setValue', getLastDayFormatDate(datenow));
            $('#EndDate').datebox('setValue', getNowFormatDate(datenow));
            $('#StartDate').datebox('textbox').bind('focus', function () { $('#StartDate').datebox('showPanel'); });
            $('#EndDate').datebox('textbox').bind('focus', function () { $('#EndDate').datebox('showPanel'); });
        });
        //查询
        function dosearch() {
            $('#dg').datagrid('clearSelections');
            var gridOpts = $('#dg').datagrid('options');
            gridOpts.url = 'orderApi.aspx?method=QueryBatchImportOrderData';
            $('#dg').datagrid('load', {
                //TakeNo: $('#TakeNo').val(),
                GtmcNo: $("#GtmcNo").val(),
                SourceCode: $("#SourceCode").val(),
                SourceName: $("#SourceName").val(),
                Route: $("#Route").val(),
                FrequentNo: $("#FrequentNo").val(),
                OrderNo: $("#OrderNo").val(),
                HouseID: $("#AHouseID").combobox('getValue'),//仓库ID
                AwbStatus: $('#AwbStatus').combobox('getValue'),
                OrderStatus: $('#OrderStatus').combobox('getValue'),
                StartDate: $('#StartDate').datebox('getValue'),
                EndDate: $("#EndDate").datebox('getValue'),
                OPName: $("#OPName").val(),
                LineID: $("#ALineID").combobox('getValue'),
                StockType: $('#StockType').combobox('getValue'),
                OrderHandleType: $('#OrderHandleType').combobox('getValue'),
                BusinessName: $("#BusinessName").val(),
                OrderAlloType: $('#OrderAlloType').combobox('getValue')            });

        }

        //双击显示库存详细界面
        function editItemByID(Did) {
            var row = $("#dg").datagrid('getData').rows[Did];
            if (row) {
                $('#dlgedit').dialog('open').dialog('setTitle', '查看库存：' + row.GtmcNo);
                $('#fmDep').form('clear');
                $('#fmDep').form('load', row);
                showGrid();
                $("#btnSave").hide();

                if (row.OrderStatus == "0") {
                    $("#btnSave").show();
                }
                var gridOpts = $('#dgSave').datagrid('options');
                gridOpts.url = 'orderApi.aspx?method=QueryAllBatchImportOrder&ProductCode=' + row.ProductCode + '&GoodsCode=' + row.GoodsCode + '&HouseID=' + row.HouseID + '&SourceCode=' + row.SourceCode + '&GtmcNo=' + row.GtmcNo;
            }
        }
    </script>
</asp:Content>
<asp:Content ID="Content2" ContentPlaceHolderID="ContentPlaceHolder1" runat="server">
    <%--此div用于在界面未完全加载样式前显示内容--%>
    <div id='Loading' style="position: absolute; z-index: 1000; top: 0px; left: 0px; width: 100%; height: 100%; background: white; text-align: center; padding: 5px 10px; display: table;">
        <div style="display: table-cell; vertical-align: middle">
            <h1><font size="9">页面加载中……</font></h1>
        </div>
    </div>
    <%--此div用于在界面未完全加载样式前显示内容--%>
    <%--此div用于显示查询条件--%>
    <div id="saPanel" name="SelectDiv1" class="easyui-panel" title="" data-options="iconCls:'icon-search'" style="width: 100%">
        <table id="saPanelTab">
            <tr>
                <td style="text-align: right;" id="shry">店代码:
                </td>
                <td>
                    <input id="SourceCode" class="easyui-textbox" data-options="prompt:'请输入店代码'" style="width: 100px" />
                </td>
                <td style="text-align: right;">区域大仓:
                </td>
                <td>
                    <input id="AHouseID" class="easyui-combobox" style="width: 100px;" />
                </td>
                <td style="text-align: right;">导入人员:
                </td>
                <td>
                    <input id="OPName" class="easyui-textbox" data-options="prompt:'请输入导入人员'" style="width: 100px" />
                </td>
                
                <td style="text-align: right;">订单所属公司:
                </td>
                <td>
                    <input id="OrderOwner" class="easyui-textbox" data-options="prompt:'输入订单所属公司'" style="width: 100px" />
                </td>

                <td style="text-align: right;">业务名称:
                </td>
                <td>
                    <input id="BusinessName" class="easyui-textbox" data-options="prompt:'业务名称'" style="width: 100px" />
                </td>
                <td style="text-align: right;">订单状态:
                </td>
                <td>
                    <select class="easyui-combobox" id="OrderStatus" style="width: 100px;" panelheight="auto">
                        <option value="-1">全部</option>
                        <option value="0">未生成</option>
                        <option value="1">已生成</option>
                    </select>
                </td>
                <td style="text-align: right;">库存状态:
                </td>
                <td>
                    <select class="easyui-combobox" id="StockType" style="width: 100px;" panelheight="auto">
                        <option value="0">全部</option>
                        <option value="-1">无库存</option>
                        <option value="1">有库存</option>
                    </select>
                </td>
                <td colspan="2"></td>
            </tr>
            <tr>
                <td style="text-align: right;">发票号码:
                </td>
                <td>
                    <input id="GtmcNo" class="easyui-textbox" data-options="prompt:'请输入发票号码'" style="width: 100px" />
                </td>
                <td class="LogisLine" style="text-align: right;">运输线路:
                </td>
                <td class="LogisLine">
                    <input id="ALineID" class="easyui-combobox" style="width: 100px;" data-options="valueField:'LineID',textField:'LineName'" />
                </td>
                <td style="text-align: right;">客户名称:
                </td>
                <td>
                    <input id="SourceName" class="easyui-textbox" data-options="prompt:'请输入客户名称'" style="width: 100px" />
                </td>
                <td style="text-align: right;">订单分配类型:
                </td>
                <td>
                    <select class="easyui-combobox" id="OrderAlloType" style="width: 100px" panelheight="auto">
                        <option value="">全部</option>
                        <option value="0">正常</option>
                        <option value="1">跨仓</option>
                        <option value="2">外采</option>
                    </select>
                </td>
                <td style="text-align: right;">出库状态:
                </td>
                <td>
                    <select class="easyui-combobox" id="AwbStatus" style="width: 100px;" panelheight="auto">
                        <option value="-1">全部</option>
                        <option value="0">未出库</option>
                        <option value="1">出库中</option>
                        <option value="2">已出库</option>
                    </select>
                </td>
                <td style="text-align: right;">处理类型:
                </td>
                <td>
                    <select class="easyui-combobox" id="OrderHandleType" style="width: 100px;" panelheight="auto">
                        <option value="-1">全部</option>
                        <option value="0">手工处理</option>
                        <option value="1">自动处理</option>
                    </select>
                </td>
                <td style="text-align: right;">导单时间:
                </td>
                <td>
                    <input id="StartDate" class="easyui-datebox" style="width: 100px" />~
                    <input id="EndDate" class="easyui-datebox" style="width: 100px" />
                </td>
            </tr>
        </table>
    </div>
    <%--此div用于显示查询条件--%>
    <table id="dg" class="easyui-datagrid">
    </table>
    <%--此div用于显示按钮操作--%>
    <div id="toolbar">
        
        <a href="#" class="easyui-linkbutton" iconcls="icon-search" plain="false" onclick="dosearch()">&nbsp;查&nbsp;询&nbsp;</a>&nbsp;&nbsp;
        <a href="#" class="easyui-linkbutton" iconcls="icon-in_cargo" plain="false" onclick="PlImport()">&nbsp;批量导入&nbsp;</a>&nbsp;&nbsp;
        <a href="#" class="easyui-linkbutton" id="btnSaveOrder" iconcls="icon-ok" onclick="saveItem()">&nbsp;生成订单&nbsp;</a>&nbsp;&nbsp;&nbsp;&nbsp;
        <a href="#" class="easyui-linkbutton" iconcls="icon-cut" plain="false" onclick="DelItem()" id="btnDel">&nbsp;删&nbsp;除&nbsp;</a>&nbsp;&nbsp;
        <a href="#" class="easyui-linkbutton" iconcls="icon-application_view_list" plain="false" onclick="saveExter()" id="btnSaveExter">&nbsp;生成外采清单列表&nbsp;</a>&nbsp;&nbsp;
        <a href="#" id="btnExportOrder" class="easyui-linkbutton" iconcls="icon-application_put" plain="false" onclick="BatchExportOrderInfo()">&nbsp;导出订单列表&nbsp;</a>&nbsp;&nbsp;
        <form runat="server" id="fm1">
            <asp:Button ID="btnOrderInfo" runat="server" Style="display: none;" Text="导出" OnClick="btnOrderInfo_Click" />
        </form>
    </div>

    <%--此div用于导入数据--%>
    <%--此div用于查看/新增/编辑数据--%>
    <div id="dlgedit" class="easyui-dialog" style="width: 1200px; height: 500px; padding: 0px"
        closed="true" buttons="#dlg-buttons">
        <form id="fmDep" class="easyui-form" method="post">
            <input type="hidden" name="ProductCode" />
            <input type="hidden" name="GtmcNo" />
            <input type="hidden" name="SourceCode" />
            <table id="saPanel">
                <tr>
                    <td style="text-align: right;">货品代码:
                    </td>
                    <td>
                        <input name="GoodsCode" class="easyui-textbox" style="width: 120px;" readonly />
                    </td>
                    <td style="text-align: right;">开单数量:
                    </td>
                    <td>
                        <input name="Piece" class="easyui-textbox" style="width: 100px;" readonly />
                    </td>
                </tr>
            </table>
        </form>
        <table id="dgSave" class="easyui-datagrid">
        </table>
    </div>
    <div id="dlg-buttons">
        <div style="text-align: left;color: red;">*线网内库存充足可正常生成订单</div>
        <a href="#" class="easyui-linkbutton" id="btnSave" iconcls="icon-ok" onclick="saveItemHouseID()">&nbsp;保存开单&nbsp;</a>&nbsp;&nbsp;&nbsp;&nbsp;
    <a href="#" class="easyui-linkbutton" iconcls="icon-cancel" onclick="javascript:$('#dlgedit').dialog('close')">&nbsp;关&nbsp;闭&nbsp;</a>
    </div>



    <%--此div用于显示按钮操作--%>
    <%--此div用于导入数据--%>
    <div id="dlgPL" class="easyui-dialog" style="width: 1000px; height: 550px; padding: 2px 2px" closed="true" buttons="#dlgPL-buttons">
        <table id="dgPLImport" class="easyui-datagrid">
        </table>
        <div id="dgPLInporttoolbar">
            <input type="file" id="fileTPL" name="file" accept=".xls,.xlsx,.pdf" multiple="multiple" onchange="savePLFile()" style="width: 250px;" />
            &nbsp;&nbsp;
            <a href="#" class="easyui-linkbutton" iconcls="icon-out_cargo" plain="false" onclick="savePLFile()">&nbsp;重新上传&nbsp;</a>&nbsp;&nbsp;
             <a href="#" class="easyui-linkbutton" iconcls="icon-ok" plain="false" onclick="btnPLSaveData()">&nbsp;保存数据&nbsp;</a>&nbsp;&nbsp;
            <a href="../upload/sFile/狄乐汽服订单导入模板1127.xls" id="dowloadTaishiHouse" class="easyui-linkbutton" iconcls="icon-application_put" plain="false">&nbsp;下载模板&nbsp;</a>&nbsp;&nbsp;
            <a href="#" class="easyui-linkbutton" iconcls="icon-cancel" onclick="closedlgPL()">&nbsp;关&nbsp;闭&nbsp;</a>
        </div>
    </div>
    <%--此div用于导入数据--%>
    <%--此div用于查看/新增/编辑数据--%>
    <script src="../JS/easy/js/ajaxfileupload.js" type="text/javascript"></script>
    <%--此div用于新增/编辑数据--%>
    <script type="text/javascript">
        //查询库存信息
        function showGrid() {
            var columns = [];
            columns.push({ title: '', field: 'HouseID', checkbox: true });
            columns.push({
                title: '是否在线网内', field: 'IsNetwork', formatter: function (val, row, index) {
                    if (val == "0") { return "<span title='否'>否</span>"; }
                    else if (val == "1") { return "<span title='是'>是</span>"; }
                    else { return "<span title=''></span>" }
                }
            });
            columns.push({ title: '仓库名称', field: 'HouseName', width: '150px' });
            columns.push({ title: '总库存', field: 'Piece', width: '150px' });
            columns.push({ title: '周期9月内', field: 'Stock', width: '150px' });
            columns.push({ title: '周期9月外', field: 'NoStock', width: '150px' });
            columns.push({ title: '当天预计到仓数量', field: 'QtyToday', width: '150px' });
            columns.push({ title: '明天预计到仓数量', field: 'QtyTomorrow', width: '150px' });
            columns.push({ title: '后天预计到仓数量', field: 'QtyDayAfterTomorrow', width: '150px' });


            $('#dgSave').datagrid({
                width: '100%',
                height: '380px',
                title: '', //标题内容
                loadMsg: '数据加载中请稍候...',
                autoRowHeight: false, //行高是否自动
                collapsible: false, //是否可折叠
                pagination: false, //分页是否显示
                rownumbers: true,//显示序号
                fitColumns: true, //设置为 true，则会自动扩大或缩小列的尺寸以适应网格的宽度并且防止水平滚动
                singleSelect: true, //设置为 true，则只允许选中一行。
                checkOnSelect: false, //如果设置为 true，当用户点击某一行时，则会选中/取消选中复选框。如果设置为 false 时，只有当用户点击了复选框时，才会选中/取消选中复选框
                url: null,
                columns: [columns]
            });
        }


        //批量导出订单信息
        function BatchExportOrderInfo() {
            $.messager.progress({ msg: '请稍后,正在导出...' });
            $.ajax({
                url: "orderApi.aspx?method=QueryBatchImportOrderDataExport&GtmcNo=" + $('#GtmcNo').val() + "&SourceCode=" + $("#SourceCode").val() + "&SourceName=" + $("#SourceName").val() + "&Route=" + $('#Route').val() + "&FrequentNo=" + $('#FrequentNo').val() + "&OrderNo=" + $('#OrderNo').val() + "&HouseID=" + $('#AHouseID').combobox('getValue') + "&AwbStatus=" + $('#AwbStatus').combobox('getValue') + "&OrderStatus=" + $('#OrderStatus').combobox('getValue') + "&StockType=" + $('#StockType').combobox('getValue') + "&OPName=" + $('#OPName').val() + "&StartDate=" + $('#StartDate').datebox('getValue') + "&EndDate=" + $('#EndDate').datebox('getValue'),
                success: function (text) {
                    $.messager.progress("close");
                    if (text == "OK") { var obj = document.getElementById("<%=btnOrderInfo.ClientID %>"); obj.click() }
                    else { $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', text, 'warning'); }
                }
            });
        }
        //关闭数据导入弹出框
        function closedlgPL() {
            $('#dlgPL').dialog('close');
            $('#dgPLImport').datagrid('loadData', { total: 0, rows: [] });
            $('#fileTPL').val("");
        }
        //批量导入
        function PlImport() {
            $('#dlgPL').dialog('open').dialog('setTitle', '批量导入订单数据');
            showPLData();
            $('#dgPLImport').datagrid('loadData', { total: 0, rows: [] });
        }
        //批量DataGrid数据
        function showPLData() {
            var columns = [];
            columns.push({ title: '店代码', field: 'SourceCode' });
            columns.push({ title: '公司名称',          field: 'SourceName' });
            columns.push({ title: '发票号码', field: 'GtmcNo' });
            columns.push({ title: '货品代码', field: 'GoodsCode' });
            columns.push({ title: '订单数量', field: 'Piece', align: 'right' });
            columns.push({ title: '备注', field: 'Memo' });
            columns.push({ title: '业务名称', field: 'BusinessName' });
            $('#dgPLImport').datagrid({
                width: '100%',
                height: '500px',
                title: '', //标题内容
                loadMsg: '数据加载中请稍候...',
                autoRowHeight: false, //行高是否自动
                collapsible: false, //是否可折叠
                pagination: false, //分页是否显示
                rownumbers: true,//显示序号
                pageSize: 12, //每页多少条
                pageList: [12, 20],
                fitColumns: true, //设置为 true，则会自动扩大或缩小列的尺寸以适应网格的宽度并且防止水平滚动
                singleSelect: true, //设置为 true，则只允许选中一行。
                checkOnSelect: false, //如果设置为 true，当用户点击某一行时，则会选中/取消选中复选框。如果设置为 false 时，只有当用户点击了复选框时，才会选中/取消选中复选框
                url: null,
                toolbar: '#dgPLInporttoolbar',
                columns: [columns],
                rowStyler: function (index, row) {
                    if (row.OrderType == "1") { return "background-color:#f38f8f"; };
                }
            });
        }
        //批量保存上传的文件
        function savePLFile() {
            var file = $("#fileTPL").val();
            if (file == null || file == "") {
                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', '请选择导入文件!', 'info');
                return;
            }
            $('#dgPLImport').datagrid('loadData', { total: 0, rows: [] });
            ajaxFilePLUpload();
        }
        //批量文件上传
        function ajaxFilePLUpload() {
            $.messager.progress({ msg: '请稍后,正在导入中...' });
            $.ajaxFileUpload({
                url: 'orderApi.aspx?method=batchImportOrder',
                secureuri: false, dataType: 'json', fileElementId: 'fileTPL',
                success: function (data) {
                    $.messager.progress("close");
                    var val = JSON.parse(data.responseText);
                    var result = val.Result;
                    if (result == true) {
                        var value = eval(val.Data);
                        $('#dgPLImport').datagrid('loadData', value);
                        if (val.Type == 1) {
                            $('#IsExistOrder').val(1);
                            var reg = new RegExp("\r\n", "g");
                            var message = val.Message.replace(reg, "<br>");
                            $.messager.alert('以下Excel数据有误已跳过导入', message, 'warning');
                        }
                    }
                    else {
                        var message = val.Message;
                        $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', message, 'warning');
                    }
                },
                error: function (data) {
                    $.messager.progress("close");
                    var val = JSON.parse(data.responseText);
                    var result = val.Result;
                    if (result == true) {
                        var value = eval(val.Data);
                        $('#dgPLImport').datagrid('loadData', value);
                        // $('#GTMCOrder').val(val.TempData);
                        if (val.Type == 1) {
                            $('#IsExistOrder').val(1);

                            var reg = new RegExp("\r\n", "g");
                            var message = val.Message.replace(reg, "<br>");
                            $.messager.alert('以下Excel数据有误已跳过导入', message, 'warning');
                        }
                    }
                    else {
                        var message = val.Message;
                        $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', message, 'warning');
                    }

                }
            })
            return false;
        }
        //保存批量导入的数据
        function btnPLSaveData() {
            var rows = $("#dgPLImport").datagrid('getData').rows;
            if (rows == null || rows == "") {
                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', '请先导入需要保存的数据！', 'warning');
                return;
            }
            var msg = "确定保存？";
            $.messager.confirm('<%= Cargo.Common.GetSystemNameAndVersion()%>', msg, function (r) {
                if (r) {
                    $.messager.progress({ msg: '请稍后,正在保存中...' });
                    var json = JSON.stringify(rows)
                    $.ajax({
                        url: 'orderApi.aspx?method=SavebatchImportOrder',
                        type: 'post', dataType: 'json', data: { data: json },
                        success: function (text) {
                            $.messager.progress("close");
                            if (text.Result == true) {
                                if (text.Message == "成功") {
                                    $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', '保存成功!', 'info');
                                } else {
                                    $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', text.Message, 'info');
                                }
                                $('#dlgPL').dialog('close');
                                dosearch();
                                $("#fileTPL").val("");
                                $('#dgPLImport').datagrid('loadData', { total: 0, rows: [] });
                            }
                            else {
                                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', text.Message, 'warning');
                            }
                        }
                    });
                }
            });
        }
        //删除数据
        function DelItem() {
            var rows = $('#dg').datagrid('getSelections');
            if (rows == null || rows == "") {
                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', '请选择要删除的数据！', 'warning');
                return;
            }
            for (var i = 0; i < rows.length; i++) {
                if (rows[i].OrderStatus == 1 && rows[i].CreateDate != "") {
                    $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', '所选数据中包含已开单数据！', 'warning'); return;
                }
            }
            $.messager.confirm('<%= Cargo.Common.GetSystemNameAndVersion()%>', '确定删除？', function (r) {
                if (r) {
                    $.messager.progress({ msg: '请稍后,正在保存中...' });
                    var json = JSON.stringify(rows)
                    $.ajax({
                        url: 'orderApi.aspx?method=DelBatchImportOrder',
                        type: 'post', dataType: 'json', data: { data: json },
                        success: function (text) {
                            $.messager.progress("close");
                            if (text.Result == true) {
                                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', '删除成功！', 'info');
                                $('#dg').datagrid('clearSelections');
                                $('#dg').datagrid('reload');
                            }
                            else {
                                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', text.Message, 'warning');
                            }
                        },
                        error: function (text) {
                            $.messager.progress("close");
                        }
                    });
                }
            });
        }
        //查询库存后开单
        function saveItemHouseID() {
            var rows = $('#dgSave').datagrid('getSelections');
            if (rows == null || rows == "") {
                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', '请选择要开单的数据！', 'warning');
                return;
            }
            $.messager.confirm('<%= Cargo.Common.GetSystemNameAndVersion()%>', '确定开单？', function (r) {
                if (r) {
                    $.messager.progress({ msg: '请稍后,正在保存中...' });
                    var json = JSON.stringify(rows)
                    $.ajax({
                        url: 'orderApi.aspx?method=SaveAllBatchImportOrder',
                        type: 'post', dataType: 'json', data: { data: json },
                        success: function (text) {
                            $.messager.progress("close");
                            if (text.Result == true) {
                                if (text.Message == "成功") {
                                    $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', '保存成功!', 'info');
                                } else {
                                    $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', text.Message, 'info');
                                }
                                $('#dlgedit').dialog('close');
                                dosearch();

                            }
                            else {
                                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', text.Message, 'warning');
                            }
                        },
                        error: function (text) {
                            $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', text.Message, 'warning');
                        }
                    });
                }
            });
        }
        //批量开单
        function saveItem() {
            var rows = $('#dg').datagrid('getSelections');
            if (rows == null || rows == "") {
                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', '请选择要开单的数据！', 'warning');
                return;
            }
            $.messager.confirm('<%= Cargo.Common.GetSystemNameAndVersion()%>', '确定开单？', function (r) {
                if (r) {
                    $.messager.progress({ msg: '请稍后,正在保存中...' });
                    var json = JSON.stringify(rows)
                    $.ajax({
                        url: 'orderApi.aspx?method=SaveBatchImportOrderData',
                        type: 'post', dataType: 'json', data: { data: json },
                        success: function (text) {
                            debugger;
                            $.messager.progress("close");
                            var reg = new RegExp("\r\n", "g");
                            var message = text.Message.replace(reg, "<br>");
                            if (text.Result == true) {
                                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', message, 'info');
                                $('#dg').datagrid('clearSelections');
                                $('#dg').datagrid('reload');
                            }
                            else {
                                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', message, 'warning');
                                $('#dg').datagrid('clearSelections');
                                $('#dg').datagrid('reload');
                            }
                        },
                        error: function (text) {
                            $('#dg').datagrid('clearSelections');
                            $('#dg').datagrid('reload');
                            $.messager.progress("close");
                        }
                    });
                }
            });
        }
        //批量生成清单
        function saveExter() {
            var rows = $('#dg').datagrid('getSelections');
            if (rows == null || rows == "") {
                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', '请选择要生成清单的数据！', 'warning');
                return;
            }
            $.messager.confirm('<%= Cargo.Common.GetSystemNameAndVersion()%>', '确定生成？', function (r) {
                if (r) {
                    $.messager.progress({ msg: '请稍后,正在保存中...' });
                    var json = JSON.stringify(rows)
                    $.ajax({
                        url: 'orderApi.aspx?method=SaveExterOrderAlloData',
                        type: 'post', dataType: 'json', data: { data: json },
                        success: function (text) {
                            debugger;
                            $.messager.progress("close");
                            var reg = new RegExp("\r\n", "g");
                            var message = text.Message.replace(reg, "<br>");
                            if (text.Result == true) {
                                $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', message, 'info');
                     $('#dg').datagrid('clearSelections');
                     $('#dg').datagrid('reload');
                 }
                 else {
                     $.messager.alert('<%= Cargo.Common.GetSystemNameAndVersion()%>', message, 'warning');
                     $('#dg').datagrid('clearSelections');
                     $('#dg').datagrid('reload');
                 }
             },
             error: function (text) {
                 $('#dg').datagrid('clearSelections');
                 $('#dg').datagrid('reload');
                 $.messager.progress("close");
             }
         });
                }
            });

        }

    </script>
</asp:Content>
