using House.Business.Cargo;
using House.Entity;
using House.Entity.Cargo;
using House.Entity.Cargo.Order;
using House.Entity.Cargo.Product;
using iText.Layout.Element;
using Memcached.ClientLibrary;
using NPOI.HSSF.Record.Formula.Functions;
using NPOI.POIFS.Properties;
using Org.BouncyCastle.Asn1.Ocsp;
using Senparc.Weixin.MP.AdvancedAPIs.MerChant;
using Senparc.Weixin.MP.TenPayLibV3;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.Configuration;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Runtime.Remoting.Contexts;
using System.Security.Cryptography;
using System.Text;
using System.Web;
using static NPOI.HSSF.Record.Formula.AttrPtg;
using static System.Runtime.CompilerServices.RuntimeHelpers;

namespace Cargo.Interface
{
    /// <summary>
    /// 仓库管理数据接口
    /// HouseInterface 的摘要说明
    /// </summary>
    public class HouseInterface : IHttpHandler
    {
        public static MemcachedClient memClient = new MemcachedClient();

        /// <summary>
        /// 接口方法请求入口
        /// </summary>
        /// <param name="context"></param>
        public void ProcessRequest(HttpContext context)
        {
            #region 缓存
            string[] serverlist = ConfigurationSettings.AppSettings["memcachedServer"].Split('/');
            SockIOPool pool = SockIOPool.GetInstance(ConfigurationSettings.AppSettings["PoolName"]);
            pool.SetServers(serverlist);
            pool.InitConnections = Convert.ToInt32(ConfigurationSettings.AppSettings["InitConnections"]);//连接池初始容量
            pool.MinConnections = Convert.ToInt32(ConfigurationSettings.AppSettings["MinConnections"]);//最小容量
            pool.MaxConnections = Convert.ToInt32(ConfigurationSettings.AppSettings["MaxConnections"]);//最大容量
            pool.SocketConnectTimeout = Convert.ToInt32(ConfigurationSettings.AppSettings["SocketConnectTimeout"]);//数据读取超时时间
            pool.SocketTimeout = Convert.ToInt32(ConfigurationSettings.AppSettings["SocketTimeout"]);//Socket连接超时时间
            pool.MaintenanceSleep = Convert.ToInt64(ConfigurationSettings.AppSettings["MaintenanceSleep"]);//线程池维护线程之间的休眠时间
            pool.Failover = Convert.ToBoolean(ConfigurationSettings.AppSettings["Failover"]);//使用缓存服务器自动切换功能，当一台服务器死了可以自动切换到另外一台查找缓存

            pool.Nagle = Convert.ToBoolean(ConfigurationSettings.AppSettings["Nagle"]);//禁用Nagle算法
            pool.Initialize();
            memClient.PoolName = ConfigurationSettings.AppSettings["PoolName"];
            memClient.EnableCompression = true;
            memClient.CompressionThreshold = 10240;
            #endregion

            context.Response.ContentType = "text/plain";
            string cmd = context.Request["cmd"];
            MethodInfo Method = this.GetType().GetMethod(cmd, BindingFlags.NonPublic | BindingFlags.Instance);//通过反射机制,直接对应到相应的方法
            if (Method != null)
            {
                Method.Invoke(this, new object[] { context });
            }
            else
            {
                context.Response.Write("传入参数不正确");
            }
        }
        /// <summary>
        /// 查询仓库系统库存返回库存数据实体List
        /// </summary>
        private void queryCargoStock(HttpContext context)
        {
            string ProductName = context.Request["ProductName"];//产品名称
            string GoodsCode = context.Request["GoodsCode"];//货品代码
            int HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID
            int TypeID = Convert.ToInt32(context.Request["TypeID"]);//产品类型ID
            string Specs = context.Request["Specs"];
            string Figure = context.Request["Figure"];
            string Model = context.Request["Model"];
            string Batch = context.Request["Batch"];
            int BatckWeek = 0, BatchYear = 0;
            CargoInterfaceBus bus = new CargoInterfaceBus();
            CargoAPIMessage result = new CargoAPIMessage();
            CargoProductBus product = new CargoProductBus();

            result.Result = true;
            result.Message = "查询成功";
            if (string.IsNullOrEmpty(GoodsCode))
            {
                result.Result = false;
                result.Message = "货品代码不能为空";
            }
            if (HouseID.Equals(0))
            {
                result.Result = false;
                result.Message = "仓库代码不能为空";
            }
            if (TypeID.Equals(0))
            {
                result.Result = false;
                result.Message = "产品类型不能为空";
            }
            int parentID = 0;
            List<CargoProductTypeEntity> ptype = product.QueryProductType(new CargoProductTypeEntity { TypeID = TypeID, ParentID = -1 });
            if (ptype.Count > 0) { parentID = ptype[0].ParentID; }
            if (string.IsNullOrEmpty(Batch))
            {
                if (parentID.Equals(1))
                {
                    BatckWeek = DateTime.Now.DayOfYear / 7 + 1;
                    if (TypeID.Equals(258))
                    {
                        //安泰路斯特殊处理周期，一年半以前的不能出
                        BatckWeek = DateTime.Now.AddDays(-547).DayOfYear / 7 + 1;
                    }
                }
            }
            if (result.Result)
            {
                CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                {
                    ProductName = ProductName,
                    HouseID = HouseID,
                    GoodsCode = GoodsCode,
                    TypeID = TypeID,
                    Model = Model,
                    Specs = Specs,
                    Batch = Batch,
                    BatckWeek = BatckWeek,
                    ParentID = parentID,
                    Figure = Figure
                };
                result.cargoList = bus.queryCargoStock(queryEntity);
                result.Number = result.cargoList.Sum(c => c.StockNum);
            }

            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        private void WriteTextLog(string strMessage, DateTime time)
        {
            string path = AppDomain.CurrentDomain.BaseDirectory + @"System\Log\";
            if (!Directory.Exists(path))
                Directory.CreateDirectory(path);

            string fileFullPath = path + time.ToString("yyyy-MM-dd") + ".System.txt";
            StringBuilder str = new StringBuilder();
            str.Append("Time:    " + time.ToString() + "\r\n");
            str.Append("Message: " + strMessage + "\r\n");
            str.Append("-----------------------------------------------------------\r\n\r\n");
            StreamWriter sw;
            if (!File.Exists(fileFullPath))
            {
                sw = File.CreateText(fileFullPath);
            }
            else
            {
                sw = File.AppendText(fileFullPath);
            }
            sw.WriteLine(str.ToString());
            sw.Close();
        }
        /// <summary>
        /// 保存订单
        /// </summary>
        /// <param name="context"></param>
        private void saveCargoOrder(HttpContext context)
        {
            String orderData = context.Request["OrderList"];
            CargoAPIMessage result = new CargoAPIMessage();
            result.Result = true;
            result.Message = "保存成功";
            if (string.IsNullOrEmpty(orderData))
            {
                result.Result = false;
                result.Message = "订单数据为空";
                //context.Response.Write(JSON.Encode(result));
                goto ErrEND;
            }
            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            CargoOrderBus bus = new CargoOrderBus();
            CargoHouseBus house = new CargoHouseBus();
            CargoInterfaceBus interBus = new CargoInterfaceBus();
            CargoProductBus product = new CargoProductBus();

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "新增订单";
            //log.UserID = "";//限定某一账号
            log.Operate = "A";
            log.Status = "0";

            ArrayList rows = (ArrayList)JSON.Decode(orderData);

            foreach (Hashtable row in rows)
            {
                log.UserID = Convert.ToString(row["UserID"]);
                ent.Dep = Convert.ToString(row["Dep"]);
                if (string.IsNullOrEmpty(ent.Dep))
                {
                    result.Result = false;
                    result.Message = "出发站不能为空";
                    goto ErrEND;
                }
                if (string.IsNullOrEmpty(Convert.ToString(row["HouseID"])))
                {
                    result.Result = false;
                    result.Message = "仓库代码不能为空";
                    goto ErrEND;
                }
                int OrderNum = 0;
                CargoHouseEntity houEnt = house.QueryCargoHouseByID(Convert.ToInt32(row["HouseID"]));
                if (houEnt == null && string.IsNullOrEmpty(houEnt.HouseCode))
                {
                    result.Result = false;
                    result.Message = "仓库代码不存在";
                    goto ErrEND;
                }
                if (row["HouseID"].ToString() == "23")
                {
                    WriteTextLog(orderData, DateTime.Now);
                }
                ent.HouseID = Convert.ToInt32(row["HouseID"]);
                //ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(Convert.ToInt32(row["HouseID"]), houEnt.HouseCode, out OrderNum); // Convert.ToString(row["OrderNo"]);//生成最新顺序订单号
                //ent.OrderNum = OrderNum;//最新订单顺序号
                ent.HAwbNo = Convert.ToString(row["HAwbNo"]);
                ent.LogisAwbNo = Convert.ToString(row["LogisAwbNo"]);//物流公司运单号
                ent.LogisID = 34;//好来运速递
                ent.Dep = Convert.ToString(row["Dep"]);
                ent.Dest = Convert.ToString(row["Dest"]);
                ent.Piece = string.IsNullOrEmpty(Convert.ToString(row["Piece"])) ? 0 : Convert.ToInt32(row["Piece"]);
                ent.Weight = string.IsNullOrEmpty(Convert.ToString(row["Weight"])) ? 0 : Convert.ToDecimal(row["Weight"]);
                ent.Volume = string.IsNullOrEmpty(Convert.ToString(row["Volume"])) ? 0 : Convert.ToDecimal(row["Volume"]);
                ent.InsuranceFee = string.IsNullOrEmpty(Convert.ToString(row["InsuranceFee"])) ? 0 : Convert.ToDecimal(row["InsuranceFee"]);
                ent.TransitFee = string.IsNullOrEmpty(Convert.ToString(row["TransitFee"])) ? 0 : Convert.ToDecimal(row["TransitFee"]);
                ent.TransportFee = string.IsNullOrEmpty(Convert.ToString(row["TransportFee"])) ? 0 : Convert.ToDecimal(row["TransportFee"]);
                ent.DeliveryFee = string.IsNullOrEmpty(Convert.ToString(row["DeliverFee"])) ? 0 : Convert.ToDecimal(row["DeliverFee"]);
                ent.OtherFee = string.IsNullOrEmpty(Convert.ToString(row["OtherFee"])) ? 0 : Convert.ToDecimal(row["OtherFee"]);
                ent.TotalCharge = string.IsNullOrEmpty(Convert.ToString(row["TotalCharge"])) ? 0 : Convert.ToDecimal(row["TotalCharge"]);
                ent.Rebate = string.IsNullOrEmpty(Convert.ToString(row["Rebate"])) ? 0 : Convert.ToDecimal(row["Rebate"]);

                ent.CheckOutType = "0";//Convert.ToString(row["CheckOutType"]);
                //ent.ReturnAwb = string.IsNullOrEmpty(Convert.ToString(row["ReturnAwb"])) ? 0 : Convert.ToInt32(row["ReturnAwb"]);
                ent.TrafficType = "0";// Convert.ToString(row["TrafficType"]);
                ent.DeliveryType = "0";//Convert.ToString(row["DeliveryType"]);
                ent.AcceptUnit = Convert.ToString(row["AcceptUnit"]);
                ent.AcceptAddress = Convert.ToString(row["AcceptAddress"]);
                ent.AcceptPeople = Convert.ToString(row["AcceptPeople"]);
                ent.AcceptTelephone = Convert.ToString(row["AcceptTelephone"]);
                ent.AcceptCellphone = Convert.ToString(row["AcceptCellphone"]);
                ent.CreateAwb = Convert.ToString(row["CreateAwb"]);//好来运系统
                ent.CreateAwbID = Convert.ToString(row["UserID"]);// UserInfor.LoginName;好来运系统
                ent.CreateDate = DateTime.Now;
                ent.OP_ID = Convert.ToString(row["UserID"]);//好来运系统UserInfor.LoginName.Trim();
                ent.SaleManID = "";// Convert.ToString(row["SaleManID"]);
                ent.SaleManName = "";// Convert.ToString(row["SaleManName"]);
                ent.Remark = Convert.ToString(row["Remark"]);
                ent.BelongHouse = "1";//1：好来运订单
                ent.ClientNum = 0;// Common.GetClientNum();//生成随机的六位数字做为客户编码
                string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                //2.处理订单与产品关联数据，查库存
                ArrayList goods = (ArrayList)row["Goods"];
                List<CargoInterfaceEntity> goodList = new List<CargoInterfaceEntity>();
                for (int i = 0; i < goods.Count; i++)
                {
                    Hashtable ht = (Hashtable)goods[i];
                    //如果件数为空或为0则忽略处理
                    if (string.IsNullOrEmpty(Convert.ToString(ht["Piece"])))
                    {
                        continue;
                    }
                    if (Convert.ToInt32(ht["Piece"]).Equals(0))
                    {
                        continue;
                    }
                    if (goodList.Exists(c => c.GoodsCode.Trim().Equals(Convert.ToString(ht["GoodsCode"]).Trim()) && c.TypeID.Equals(Convert.ToInt32(ht["TypeID"])) && c.Batch.Trim().Equals(Convert.ToString(ht["Batch"]))))
                    {
                        CargoInterfaceEntity cie = goodList.Find(c => c.GoodsCode.Trim().Equals(Convert.ToString(ht["GoodsCode"]).Trim()) && c.TypeID.Equals(Convert.ToInt32(ht["TypeID"])) && c.Batch.Trim().Equals(Convert.ToString(ht["Batch"])));
                        cie.StockNum += Convert.ToInt32(ht["Piece"]);
                    }
                    else
                    {
                        goodList.Add(new CargoInterfaceEntity
                        {
                            ProductName = Convert.ToString(ht["ProductName"]),
                            GoodsCode = Convert.ToString(ht["GoodsCode"]),
                            TypeID = Convert.ToInt32(ht["TypeID"]),
                            Model = Convert.ToString(ht["Model"]),
                            Specs = Convert.ToString(ht["Specs"]),
                            Batch = Convert.ToString(ht["Batch"]),
                            StockNum = Convert.ToInt32(ht["Piece"]),
                            Figure = Convert.ToString(ht["Figure"])

                        });
                    }
                }
                #region 旧版本
                //for (int i = 0; i < goods.Count; i++)
                //{
                //    Hashtable ht = (Hashtable)goods[i];
                //    //如果件数为空或为0则忽略处理
                //    if (string.IsNullOrEmpty(Convert.ToString(ht["Piece"])))
                //    {
                //        continue;
                //    }
                //    if (Convert.ToInt32(ht["Piece"]).Equals(0))
                //    {
                //        continue;
                //    }
                //    pieceSum += Convert.ToInt32(ht["Piece"]);
                //    int piece = Convert.ToInt32(ht["Piece"]);
                //    CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                //    {
                //        ProductName = Convert.ToString(ht["ProductName"]),
                //        HouseID = ent.HouseID,
                //        GoodsCode = Convert.ToString(ht["GoodsCode"]),
                //        TypeID = Convert.ToInt32(ht["TypeID"]),
                //        Model = Convert.ToString(ht["Model"]),
                //        Specs = Convert.ToString(ht["Specs"]),
                //        Batch = Convert.ToString(ht["Batch"]),
                //        Figure = Convert.ToString(ht["Figure"])
                //    };
                //    List<CargoInterfaceEntity> stockList = interBus.queryCargoStock(queryEntity);
                //    if (stockList.Count <= 0)
                //    {
                //        result.Result = false;
                //        result.Message = "产品名称：" + queryEntity.ProductName + "，货品代码：" + queryEntity.GoodsCode + "库存为空";
                //        goto ErrEND;
                //    }
                //    //减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                //    foreach (var it in stockList)
                //    {
                //        CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                //        cargo.OrderNo = ent.OrderNo;//订单号
                //        cargo.OutCargoID = outID;
                //        cargo.ContainerID = it.ContainerID;
                //        cargo.TypeID = it.TypeID;
                //        cargo.ProductID = it.ProductID;

                //        cargo.ID = it.ContainerGoodsID;//库存表ID

                //        //cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                //        cargo.HouseName = houEnt.Name;
                //        //cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                //        cargo.ProductName = it.ProductName;
                //        cargo.Model = it.Model;
                //        cargo.Specs = it.Specs;
                //        cargo.Figure = it.Figure;
                //        #region 减库存逻辑
                //        if (piece < it.StockNum)
                //        {
                //            //部分出
                //            entDest.Add(new CargoOrderGoodsEntity
                //            {
                //                OrderNo = ent.OrderNo,
                //                ProductID = it.ProductID,
                //                HouseID = ent.HouseID,
                //                AreaID = it.AreaID,
                //                Piece = piece,
                //                ActSalePrice = 0,
                //                ContainerCode = it.ContainerCode,
                //                OutCargoID = outID,
                //                OP_ID = log.UserID
                //            });
                //            cargo.Piece = piece;
                //            cargo.InPiece = it.StockNum;

                //            outHouseList.Add(cargo);
                //            break;
                //        }
                //        if (piece.Equals(it.StockNum))
                //        {
                //            //要出库件数和第一条库存件数刚刚好，则就全部出
                //            entDest.Add(new CargoOrderGoodsEntity
                //            {
                //                OrderNo = ent.OrderNo,
                //                ProductID = it.ProductID,
                //                HouseID = ent.HouseID,
                //                AreaID = it.AreaID,
                //                Piece = piece,
                //                ActSalePrice = 0,
                //                ContainerCode = it.ContainerCode,
                //                OutCargoID = outID,
                //                OP_ID = log.UserID
                //            });
                //            cargo.Piece = piece;
                //            cargo.InPiece = it.StockNum;

                //            outHouseList.Add(cargo);
                //            break;
                //        }
                //        if (piece > it.StockNum)
                //        {
                //            //全部出
                //            entDest.Add(new CargoOrderGoodsEntity
                //            {
                //                OrderNo = ent.OrderNo,
                //                ProductID = it.ProductID,
                //                HouseID = ent.HouseID,
                //                AreaID = it.AreaID,
                //                Piece = it.StockNum,
                //                ActSalePrice = 0,
                //                ContainerCode = it.ContainerCode,
                //                OutCargoID = outID,
                //                OP_ID = log.UserID
                //            });
                //            cargo.Piece = it.StockNum;
                //            cargo.InPiece = it.StockNum;

                //            outHouseList.Add(cargo);
                //            piece = piece - it.StockNum;
                //            continue;
                //        }
                //        #endregion
                //    }
                //}
                #endregion
                int pieceSum = 0;
                foreach (var itt in goodList)
                {
                    pieceSum += itt.StockNum;
                    int piece = itt.StockNum;
                    //如果周期为空，产品类型是轮胎，则判断当前日期是本年的第几周，不能出一年以前周期轮胎
                    int BatckWeek = 0;
                    int parentID = 0;
                    List<CargoProductTypeEntity> ptype = product.QueryProductType(new CargoProductTypeEntity { TypeID = itt.TypeID, ParentID = -1 });
                    if (ptype.Count > 0) { parentID = ptype[0].ParentID; }
                    if (string.IsNullOrEmpty(itt.Batch))
                    {
                        if (parentID.Equals(1))
                        {
                            BatckWeek = DateTime.Now.DayOfYear / 7 + 1;
                            if (itt.TypeID.Equals(258))
                            {
                                //安泰路斯特殊处理周期，一年半以前的不能出
                                BatckWeek = DateTime.Now.AddDays(-547).DayOfYear / 7;
                            }
                        }
                    }
                    CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                    {
                        ProductName = itt.ProductName,
                        HouseID = ent.HouseID,
                        GoodsCode = itt.GoodsCode,
                        TypeID = itt.TypeID,
                        Model = itt.Model,
                        Specs = itt.Specs,
                        Batch = itt.Batch,
                        BatckWeek = BatckWeek,
                        ParentID = parentID,
                        Figure = itt.Figure
                    };
                    List<CargoInterfaceEntity> stockList = interBus.queryCargoStock(queryEntity);
                    if (stockList.Count <= 0)
                    {
                        result.Result = false;
                        result.Message = "产品名称：" + queryEntity.ProductName + "，货品代码：" + queryEntity.GoodsCode + "库存为空";
                        goto ErrEND;
                    }
                    if (stockList.Sum(c => c.StockNum) < piece)
                    {
                        result.Result = false;
                        result.Message = "产品名称：" + queryEntity.ProductName + "，货品代码：" + queryEntity.GoodsCode + "库存不足，库存只剩：" + stockList.Sum(c => c.StockNum).ToString();
                        goto ErrEND;
                    }
                    //减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                    foreach (var it in stockList)
                    {
                        if (it.StockNum <= 0) { continue; }
                        CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                        cargo.OrderNo = ent.OrderNo;//订单号
                        cargo.OutCargoID = outID;
                        cargo.ContainerID = it.ContainerID;
                        cargo.TypeID = it.TypeID;
                        cargo.ProductID = it.ProductID;

                        cargo.ID = it.ContainerGoodsID;//库存表ID

                        //cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                        cargo.HouseName = houEnt.Name;
                        //cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                        cargo.ProductName = it.ProductName;
                        cargo.Model = it.Model;
                        cargo.Specs = it.Specs;
                        cargo.Figure = it.Figure;
                        #region 减库存逻辑
                        if (piece < it.StockNum)
                        {
                            //部分出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = piece,
                                ActSalePrice = 0,
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                OP_ID = log.UserID
                            });
                            cargo.Piece = piece;
                            cargo.InPiece = it.StockNum;

                            outHouseList.Add(cargo);
                            break;
                        }
                        if (piece.Equals(it.StockNum))
                        {
                            //要出库件数和第一条库存件数刚刚好，则就全部出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = piece,
                                ActSalePrice = 0,
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                OP_ID = log.UserID
                            });
                            cargo.Piece = piece;
                            cargo.InPiece = it.StockNum;

                            outHouseList.Add(cargo);
                            break;
                        }
                        if (piece > it.StockNum)
                        {
                            //全部出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = it.StockNum,
                                ActSalePrice = 0,
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                OP_ID = log.UserID
                            });
                            cargo.Piece = it.StockNum;
                            cargo.InPiece = it.StockNum;

                            outHouseList.Add(cargo);
                            piece = piece - it.StockNum;
                            continue;
                        }
                        #endregion
                    }
                }
                if (!ent.Piece.Equals(pieceSum))
                {
                    result.Result = false;
                    result.Message = "出库件数不一致";
                    goto ErrEND;
                }
                ent.BusinessID = "0";
                ent.AwbStatus = "0";
                ent.OrderType = "0";
                ent.goodsList = entDest;
                ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(Convert.ToInt32(row["HouseID"]), houEnt.HouseCode, out OrderNum); // Convert.ToString(row["OrderNo"]);//生成最新顺序订单号
                ent.OrderNum = OrderNum;//最新订单顺序号
                //int RetryCount = 0;
                //while (Order.orderApi.OrderNoList.Contains(ent.OrderNo))
                //{
                //    RetryCount++;
                //    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(Convert.ToInt32(row["HouseID"]), houEnt.HouseCode, out OrderNum, RetryCount);
                //}
                //Order.orderApi.OrderNoList.Add(ent.OrderNo);
                //outHouseList[0].OrderNo = ent.OrderNo;
                foreach (var outH in outHouseList)
                {
                    outH.OrderNo = ent.OrderNo;
                }
                foreach (var gl in ent.goodsList)
                {
                    gl.OrderNo = ent.OrderNo;
                }
                //bus.AddOrderInfo(ent, log);
                //house.saveOutCargoData(outHouseList, log);

                //仓库同步缓存
                foreach (CargoContainerShowEntity time in outHouseList)
                {
                    CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                    //34 马牌  1 同步马牌  2 同步全部品牌
                    if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                    {
                        RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                    }
                }

                bus.AddOrderInfo(ent, outHouseList, log);
                result.OrderNo = ent.OrderNo;
            }
        //String json = JSON.Encode(result);
        //context.Response.Write(json);

        ErrEND:
            String errjson = JSON.Encode(result);
            context.Response.Write(errjson);
        }
        /// <summary>
        /// 删除订单
        /// </summary>
        /// <param name="context"></param>
        private void deleteCargoOrder(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();
            result.Result = true;
            result.Message = "删除成功";
            string OrderNo = context.Request["OrderNo"];//订单号
            string LogisAwbNo = context.Request["LogisAwbNo"];//好来运单号
            string UserID = context.Request["UserID"];//用户账号
            if (string.IsNullOrEmpty(OrderNo))
            {
                result.Result = false;
                result.Message = "传入订单号为空";
                goto ErrEND;
            }
            if (string.IsNullOrEmpty(UserID))
            {
                result.Result = false;
                result.Message = "传入用户账号为空";
                goto ErrEND;
            }

            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "订单管理";
            log.UserID = UserID;
            log.Operate = "D";
            List<CargoOrderEntity> list = new List<CargoOrderEntity>();
            CargoOrderEntity orderEnt = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = OrderNo });
            if (orderEnt == null || orderEnt.OrderID == 0)
            {
                result.Result = false;
                result.Message = "删除失败，订单不存在";
                goto ErrEND;
            }
            list.Add(new CargoOrderEntity
            {
                OrderID = orderEnt.OrderID,
                Dep = orderEnt.Dep.Trim(),
                Dest = orderEnt.Dest.Trim(),
                Piece = orderEnt.Piece,
                TransportFee = orderEnt.TransportFee,
                TotalCharge = orderEnt.TotalCharge,
                AcceptUnit = orderEnt.AcceptUnit.Trim(),
                AcceptPeople = orderEnt.AcceptPeople.Trim(),
                AcceptTelephone = orderEnt.AcceptTelephone.Trim(),
                AcceptCellphone = orderEnt.AcceptCellphone.Trim(),
                AcceptAddress = orderEnt.AcceptAddress.Trim(),
                SaleManName = orderEnt.SaleManName,
                CreateAwb = orderEnt.CreateAwb,
                CreateDate = orderEnt.CreateDate,
                OrderNo = OrderNo,
                LogisAwbNo = LogisAwbNo
            });


            //仓库同步缓存
            CargoHouseBus house = new CargoHouseBus();
            List<CargoProductEntity> syncProduct = house.SyncTypeOrderNo(OrderNo);
            foreach (CargoProductEntity product in syncProduct)
            {

                if (product.SyncType == "2" || (product.SyncType == "1" && product.TypeID == 34))
                {
                    RedisHelper.HashSet("OpenSystemStockSyc", "" + product.HouseID + "_" + product.TypeID + "_" + product.ProductCode + "", product.GoodsCode);
                }
            }

            bus.DeleteOrderInfo(list, log);
        ErrEND:
            String errjson = JSON.Encode(result);
            context.Response.Write(errjson);
        }
        /// <summary>
        /// 养护品扫描入库
        /// </summary>
        /// <param name="context"></param>
        private void scanTagInMaintenance(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();
            #region 数据验证
            if (string.IsNullOrEmpty(context.Request["HouseID"]))
            {
                result.Result = false;
                result.Message = "仓库代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(context.Request["TypeID"]))
            {
                result.Result = false;
                result.Message = "产品类型不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(context.Request["ProductName"]))
            {
                result.Result = false;
                result.Message = "产品名称不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(context.Request["Specs"]))
            {
                result.Result = false;
                result.Message = "规格不能为空";
                goto ERR;
            }
            //if (string.IsNullOrEmpty(context.Request["Figure"]))
            //{
            //    result.Result = false;
            //    result.Message = "花纹不能为空";
            //    goto ERR;
            //}
            if (string.IsNullOrEmpty(context.Request["Model"]))
            {
                result.Result = false;
                result.Message = "型号不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(context.Request["Batch"]))
            {
                result.Result = false;
                result.Message = "批次不能为空";
                goto ERR;
            }
            //if (!Common.IsInt(context.Request["Batch"]))
            //{
            //    result.Result = false;
            //    result.Message = "周期批次输入有误";
            //    goto ERR;
            //}
            //if (context.Request["Batch"].Length != 8)
            //{
            //    result.Result = false;
            //    result.Message = "周期批次输入有误";
            //    goto ERR;
            //}
            if (string.IsNullOrEmpty(context.Request["Package"]))
            {
                result.Result = false;
                result.Message = "产品包装不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(context.Request["PackageNum"]))
            {
                result.Result = false;
                result.Message = "产品包装数量不能为空";
                goto ERR;
            }
            if (!Common.IsInt(context.Request["PackageNum"]))
            {
                result.Result = false;
                result.Message = "产品包装数量数据有误";
                goto ERR;
            }
            if (string.IsNullOrEmpty(context.Request["ContainerCode"]))
            {
                result.Result = false;
                result.Message = "货位代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(context.Request["TagCode"]))
            {
                result.Result = false;
                result.Message = "标签码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(context.Request["InCargoNum"]))
            {
                result.Result = false;
                result.Message = "入库数量不能为空";
                goto ERR;
            }
            if (!Common.IsInt(context.Request["InCargoNum"]))
            {
                result.Result = false;
                result.Message = "入库数量数据有误";
                goto ERR;
            }
            #endregion
            int HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID
            int TypeID = Convert.ToInt32(context.Request["TypeID"]);//产品类型ID
            string ProductName = Convert.ToString(context.Request["ProductName"]).Trim();//产品名称
            string Specs = Convert.ToString(context.Request["Specs"]).Trim().ToUpper();//规格
            string Figure = Convert.ToString(context.Request["Figure"]).Trim().ToUpper();//花纹
            string Model = Convert.ToString(context.Request["Model"]).Trim();//型号
            string GoodsCode = Convert.ToString(context.Request["GoodsCode"]).Trim();//货品代码
            string Batch = Convert.ToString(context.Request["Batch"]).Trim();//周期
            string Package = Convert.ToString(context.Request["Package"]).Trim();//产品包装
            int PackageNum = Convert.ToInt32(context.Request["PackageNum"]);//产品包装数量
            string ContainerCode = Convert.ToString(context.Request["ContainerCode"]).Trim();//货位代码
            string TagCode = Convert.ToString(context.Request["TagCode"]).Trim();//产品唯一编码标签码
            string InCargoNum = Convert.ToString(context.Request["InCargoNum"]);//入库数量
            string SourceOrderNo = Convert.ToString(context.Request["SourceOrderNo"]);//工厂订单号
            string UserID = Convert.ToString(context.Request["UserID"]).Trim();//操作人账号
            string Source = Convert.ToString(context.Request["Source"]);//产品来源
            string BelongMonth = Convert.ToString(context.Request["BelongMonth"]);//订单归属月
            string OrderType = Convert.ToString(context.Request["OrderType"]);//订单类型ID
            result.Result = true;
            result.Message = "保存成功";

            CargoProductBus bus = new CargoProductBus();
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoHouseBus house = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "产品管理";
            log.NvgPage = "养护品扫描入库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "A";
            log.Status = "0";

            List<CargoProductTypeEntity> ptype = bus.QueryProductType(new CargoProductTypeEntity { TypeID = TypeID, ParentID = -1 });
            int parentID = 0;
            if (ptype.Count > 0)
            {
                parentID = ptype[0].ParentID;
            }

            CargoContainerEntity contain = house.QueryContainerEntityByCode(ContainerCode, HouseID);
            if (contain == null || contain.ContainerID.Equals(0))
            {
                result.Result = false;
                result.Message = "货位代码不存在";
                goto ERR;
            }
            if (bus.IsExistCargoProductTag(new CargoProductTagEntity { TagCode = TagCode }))
            {
                result.Result = false;
                result.Message = "已经存在相同的产品编码：" + TagCode;
                goto ERR;
            }

            inter.scanTagInMaintenance(new CargoProductEntity { HouseID = HouseID, TypeID = TypeID, ProductName = ProductName, Specs = Specs, Model = Model, Figure = Figure, GoodsCode = GoodsCode, Batch = Batch, Package = Package, PackageNum = PackageNum, ContainerCode = ContainerCode, TagCode = TagCode, Numbers = Convert.ToInt32(InCargoNum), ParentID = parentID, OPID = UserID, SourceOrderNo = SourceOrderNo, Source = Source, BelongMonth = BelongMonth, InCargoID = DateTime.Now.ToString("MMdd") + Common.GetRandomSixNum().ToString(), Company = "1" }, log);

        ERR:
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 养护品扫描出库
        /// </summary>
        /// <param name="context"></param>
        private void saveMaintenanceOutCargoOk(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();
            string OrderNo = context.Request["OrderNo"];//订单号
            if (string.IsNullOrEmpty(context.Request["ProductID"]))
            {
                result.Result = false;
                result.Message = "产品ID不能为空";
                goto ERR;
            }
            long ProductID = Convert.ToInt32(context.Request["ProductID"]);//产品ID
            string TagCode = context.Request["TagCode"];//产品唯一编码标签码
            string Piece = context.Request["Piece"];//出库数量
            string UserID = context.Request["UserID"];//操作人账号
            CargoProductBus bus = new CargoProductBus();
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoOrderBus order = new CargoOrderBus();
            result.Result = true;
            result.Message = "保存成功";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "产品管理";
            log.NvgPage = "养护品扫描出库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "A";
            log.Status = "0";
            #region 验证

            if (ProductID.Equals(0))
            {
                result.Result = false;
                result.Message = "产品ID不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(OrderNo))
            {
                result.Result = false;
                result.Message = "订单号不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                result.Result = false;
                result.Message = "标签编码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(Piece))
            {
                result.Result = false;
                result.Message = "出库数量不能为空";
                goto ERR;
            }
            List<CargoOrderGoodsEntity> orderTag = order.QueryOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = OrderNo, ProductID = ProductID });
            if (orderTag.Count <= 0)
            {
                result.Result = false;
                result.Message = "该订单不存在该产品ID";
                goto ERR;
            }

            if (inter.GetMaintenanceOrderOutCargoType(new CargoProductTagEntity { OrderNo = OrderNo }))
            {
                result.Result = false;
                result.Message = "该订单已出库完成";
                goto ERR;
            }
            else
            {
                if (inter.GetMaintenanceOrderProductOutCargoType(new CargoProductTagEntity { OrderNo = OrderNo, ProductID = ProductID }).Equals(1))
                {
                    result.Result = false;
                    result.Message = "该订单下该产品已出库完成";
                    goto ERR;
                }
            }
            int OutPiece = inter.GetMaintenanceProductOutCargoNum(OrderNo, ProductID.ToString());
            if (Convert.ToInt32(Piece) > OutPiece)
            {
                result.Result = false;
                result.Message = "出库数量大于订单实际出库数量";
                goto ERR;
            }
            else if (Convert.ToInt32(Piece) < OutPiece)
            {
                result.Result = false;
                result.Message = "出库数量小于订单实际出库数量";
                goto ERR;
            }

            #endregion
            inter.UpdateMaintenanceProductOutCargoType(OrderNo, ProductID.ToString(), true, log);
            try
            {
                log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                log.Moudle = "订单管理";
                log.NvgPage = "订单状态跟踪";
                log.UserID = "2029";
                log.Status = "0";
                log.Operate = "U";
                CargoOrderEntity orderEn = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = OrderNo });
                if (orderEn.Piece.Equals(Convert.ToInt32(Piece)))
                {
                    //出库完成
                    order.SaveOrderStatus(new CargoOrderStatusEntity
                    {
                        OrderID = orderEn.OrderID,
                        OrderNo = orderEn.OrderNo,
                        OrderStatus = "2",
                        WXOrderNo = orderEn.WXOrderNo,
                        OP_ID = "2029",
                        OP_Name = UserID,
                        OP_DATE = DateTime.Now,
                        DetailInfo = ""
                    }, log);
                }
                else
                {
                    if (!memClient.KeyExists(OrderNo))
                    {
                        //已经出库的数量
                        if (Convert.ToInt32(Piece) < orderEn.Piece)
                        {
                            if (orderEn.AwbStatus.Equals("0") || orderEn.AwbStatus.Equals("6"))
                            {
                                //未出库完成 加入缓存，订单状态为正在出库中
                                order.SaveOrderStatus(new CargoOrderStatusEntity
                                {
                                    OrderID = orderEn.OrderID,
                                    OrderNo = orderEn.OrderNo,
                                    OrderStatus = "1",
                                    WXOrderNo = orderEn.WXOrderNo,
                                    OP_ID = "2029",
                                    OP_Name = UserID,
                                    OP_DATE = DateTime.Now,
                                    DetailInfo = ""
                                }, log);
                            }
                            memClient.Add(OrderNo, Convert.ToInt32(Piece));
                        }
                        else
                        {
                            #region 出库完成
                            //出库完成
                            order.SaveOrderStatus(new CargoOrderStatusEntity
                            {
                                OrderID = orderEn.OrderID,
                                OrderNo = orderEn.OrderNo,
                                OrderStatus = "2",
                                WXOrderNo = orderEn.WXOrderNo,
                                OP_ID = "2029",
                                OP_Name = UserID,
                                OP_DATE = DateTime.Now,
                                DetailInfo = ""
                            }, log);
                            #endregion
                            memClient.Delete(OrderNo);
                        }
                    }
                    else
                    {
                        //如果已经存在缓存，表示不是第一次扫描，要判断扫描出库数量与订单数量是否一致，一致则推送出库通知给客户
                        int OutNum = (int)memClient.Get(OrderNo);
                        OutNum = OutNum + Convert.ToInt32(Piece);
                        memClient.Delete(OrderNo);
                        if (OutNum.Equals(orderEn.Piece))
                        {
                            #region 出库完成
                            order.SaveOrderStatus(new CargoOrderStatusEntity
                            {
                                OrderID = orderEn.OrderID,
                                OrderNo = orderEn.OrderNo,
                                OrderStatus = "2",
                                WXOrderNo = orderEn.WXOrderNo,
                                OP_ID = "2029",
                                OP_Name = UserID,
                                OP_DATE = DateTime.Now,
                                DetailInfo = ""
                            }, log);
                            #endregion
                        }
                        else
                        {
                            memClient.Add(OrderNo, OutNum);
                        }
                    }
                }

            }
            catch (Exception)
            {
                goto ERR;
            }
        ERR:
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 扫描入库
        /// </summary>
        /// <param name="context"></param>
        private void scanTagInCargo(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();
            string ProductName = Convert.ToString(context.Request["ProductName"]).Trim();//产品名称
            string GoodsCode = Convert.ToString(context.Request["GoodsCode"]).Trim();//货品代码或品番号
            if (string.IsNullOrEmpty(context.Request["HouseID"]))
            {
                result.Result = false;
                result.Message = "仓库代码不能为空";
                goto ERR;
            }
            int HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID
            if (string.IsNullOrEmpty(context.Request["TypeID"]))
            {
                result.Result = false;
                result.Message = "产品ID不能为空";
                goto ERR;
            }

            int TypeID = Convert.ToInt32(context.Request["TypeID"]);//产品类型ID
            string Specs = Convert.ToString(context.Request["Specs"]).Trim().ToUpper();//规格和背番号
            //string Figure = HttpUtility.UrlDecode(Convert.ToString(context.Request["Figure"]).Trim().ToUpper());//花纹
            string Figure = Convert.ToString(context.Request["Figure"]).Trim().ToUpper();//花纹PDA调用接口未对特殊字符转码，取消转码

            string Model = Convert.ToString(context.Request["Model"]).Trim();//型号
            string Batch = Convert.ToString(context.Request["Batch"]).Trim();//周期
            string ContainerCode = Convert.ToString(context.Request["ContainerCode"]).Trim();//货位代码
            string LoadIndex = Convert.ToString(context.Request["LoadIndex"]).Trim();//载重指数
            string SpeedLevel = Convert.ToString(context.Request["SpeedLevel"]).Trim().ToUpper();//速度级别
            string UserID = Convert.ToString(context.Request["UserID"]).Trim();//操作人账号
            string Born = Convert.ToString(context.Request["Born"]).Trim();//生产地 0：国产1：进口
            string Assort = Convert.ToString(context.Request["Assort"]).Trim();//OER  REP 胎
            string TyreCode = Convert.ToString(context.Request["TyreCode"]).Trim();//轮胎编码
            string InCargoNum = Convert.ToString(context.Request["InCargoNum"]);//入库数量
            string Source = Convert.ToString(context.Request["Source"]);//产品来源
            if (string.IsNullOrEmpty(context.Request["SourceOrderNo"]))
            {
                result.Result = false;
                result.Message = "工厂订单号不能为空";
                goto ERR;
            }
            string SourceOrderNo = Convert.ToString(context.Request["SourceOrderNo"]);//工厂订单号
            string BelongMonth = Convert.ToString(context.Request["BelongMonth"]);//订单归属月
            string OrderType = Convert.ToString(context.Request["OrderType"]);//订单类型ID
            string HLYReturnID = Convert.ToString(context.Request["id"]);//好来运ID
            string BelongDepart = Convert.ToString(context.Request["BelongDepart"]);//归属部门
            string ProductCode = Convert.ToString(context.Request["ProductCode"]);//产品编码
            string Package = Convert.ToString(context.Request["Package"]);//产品单位包装
            string PackageNum = string.IsNullOrEmpty(Convert.ToString(context.Request["PackageNum"])) ? "1" : Convert.ToString(context.Request["PackageNum"]);//产品单位包装数量

            string TagCode = Convert.ToString(context.Request["TagCode"]).Trim();//产品唯一编码标签码
            //string TagCode = context.Request["TagCode"];//产品唯一编码标签码
            string[] tArr = TagCode.Split('=');
            if (tArr.Length > 1)
            {
                TagCode = tArr[1];
            }
            else
            {
                string[] gtc = TagCode.Split('|');
                if (gtc.Length > 1)
                {
                    TagCode = gtc[5];
                    //TagCode = tc.Substring(8, tc.Length - 8);
                }
            }
            CargoClientBus clientBus = new CargoClientBus();
            CargoProductBus bus = new CargoProductBus();
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoHouseBus house = new CargoHouseBus();
            CargoFactoryOrderBus ProductUnitPriceBus = new CargoFactoryOrderBus();
            result.Result = true;
            result.Message = "保存成功";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "产品管理";
            log.NvgPage = "扫描入库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "A";
            log.Status = "0";
            #region 通用数据检验
            if (HouseID.Equals(0))
            {
                result.Result = false;
                result.Message = "仓库代码不能为空";
                goto ERR;
            }
            if (TypeID.Equals(0))
            {
                result.Result = false;
                result.Message = "产品ID不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(ContainerCode))
            {
                result.Result = false;
                result.Message = "货位代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                result.Result = false;
                result.Message = "产品编码不能为空";
                goto ERR;
            }
            if (!HouseID.Equals(62))
            {
                if (string.IsNullOrEmpty(Batch))
                {
                    result.Result = false;
                    result.Message = "周期批次不能为空";
                    goto ERR;
                }

            }

            #endregion

            List<CargoProductTypeEntity> ptype = bus.QueryProductType(new CargoProductTypeEntity { TypeID = TypeID, ParentID = -1 });
            int parentID = 0;
            if (ptype.Count > 0) { parentID = ptype[0].ParentID; }
            if (HouseID.Equals(62)) { parentID = 354; }

            int bYear = 0, bWeek = 0, flatRadio = 0, HubDiameter = 0, TreadWidth = 0;
            switch (parentID)
            {
                case 1:
                    if (TypeID.Equals(540) || TypeID.Equals(541) || TypeID.Equals(542) || TypeID.Equals(543) || TypeID.Equals(565) || TypeID.Equals(566) || TypeID.Equals(641) || TypeID.Equals(649) || TypeID.Equals(657))
                    {
                        //两轮轮胎特殊处理
                        if (string.IsNullOrEmpty(ProductCode))
                        {
                            result.Result = false;
                            result.Message = "产品编码不能为空";
                            goto ERR;
                        }
                        CargoProductSpecEntity specEntity = bus.GetProductSpecByProductCode(ProductCode);
                        if (specEntity == null)
                        {
                            result.Result = false;
                            result.Message = "产品编码不存在";
                            goto ERR;
                        }
                        Specs = specEntity.Specs;
                        Figure = specEntity.Figure;
                        Model = specEntity.Model;
                        GoodsCode = specEntity.GoodsCode;
                        HubDiameter = specEntity.HubDiameter;
                        Package = specEntity.ProductUnit;
                        PackageNum = Convert.ToString(specEntity.BundleNum);
                        InCargoNum = specEntity.BundleNum.Equals(0) ? "1" : Convert.ToString(specEntity.BundleNum);
                    }
                    else
                    {
                        #region 轮胎
                        if (string.IsNullOrEmpty(GoodsCode))
                        {
                            result.Result = false;
                            result.Message = "货品代码不能为空";
                            goto ERR;
                        }
                        if (string.IsNullOrEmpty(Specs))
                        {
                            result.Result = false;
                            result.Message = "规格不能为空";
                            goto ERR;
                        }
                        if (string.IsNullOrEmpty(Figure))
                        {
                            result.Result = false;
                            result.Message = "花纹不能为空";
                            goto ERR;
                        }
                        if (string.IsNullOrEmpty(SpeedLevel))
                        {
                            result.Result = false;
                            result.Message = "速度级别不能为空";
                            goto ERR;
                        }
                        if (SpeedLevel.Length > 2)
                        {
                            result.Result = false;
                            result.Message = "速度级别长度有误";
                            goto ERR;
                        }
                        if (Batch.Length != 4)
                        {
                            result.Result = false;
                            result.Message = "周期批次输入有误";
                            goto ERR;
                        }
                        if (!Common.IsInt(Batch))
                        {
                            result.Result = false;
                            result.Message = "周期批次输入有误";
                            goto ERR;
                        }
                        if (TyreCode.Length > 20)
                        {
                            result.Result = false;
                            result.Message = "轮胎码长度有误";
                            goto ERR;
                        }
                        if (Batch.Length == 4)
                        {
                            bWeek = Convert.ToInt32(Batch.Substring(0, 2));
                            bYear = Convert.ToInt32(Batch.Substring(2, 2));
                        }
                        else if (Batch.Length == 3)
                        {
                            bWeek = Convert.ToInt32(Batch.Substring(0, 1));
                            bYear = Convert.ToInt32(Batch.Substring(1, 2));
                        }
                        string[] sp = Specs.Split('/');
                        if (sp.Length > 1)
                        {
                            if (Common.IsInt(sp[0]))
                            {
                                TreadWidth = Convert.ToInt32(sp[0]);
                            }
                            string gg = Convert.ToString(sp[1]);
                            //if (gg.Length < 5 && TypeID != 31)
                            //{
                            //    result.Result = false;
                            //    result.Message = "请检查规格是否有误";
                            //    goto ERR;
                            //}y
                            if (Common.IsInt(gg.Substring(0, 2)))
                            {
                                flatRadio = Convert.ToInt32(gg.Substring(0, 2));
                            }
                            if (gg.Length > 5)
                            {
                                if (Common.IsInt(gg.Substring(3, 2)))
                                {
                                    HubDiameter = Convert.ToInt32(gg.Substring(3, 2));
                                }
                            }
                            //HubDiameter = Convert.ToInt32(gg.Substring(gg.Length - 2, 2));
                        }
                        #endregion
                        InCargoNum = "1";
                        //Figure = Figure.Replace(" ", "");
                    }
                    break;
                case 354:
                    //太石仓生产物流
                    if (string.IsNullOrEmpty(GoodsCode))
                    {
                        result.Result = false;
                        result.Message = "品番不能为空";
                        goto ERR;
                    }
                    //if (string.IsNullOrEmpty(Specs))
                    //{
                    //    result.Result = false;
                    //    result.Message = "背番不能为空";
                    //    goto ERR;
                    //}
                    break;
                case 113:
                    if (string.IsNullOrEmpty(GoodsCode))
                    {
                        result.Result = false;
                        result.Message = "货品代码不能为空";
                        goto ERR;
                    }
                    //车模
                    if (string.IsNullOrEmpty(InCargoNum))
                    {
                        result.Result = false;
                        result.Message = "入库数量不能为空";
                        goto ERR;
                    }
                    if (!Common.IsInt(InCargoNum))
                    {
                        result.Result = false;
                        result.Message = "入库数量数据有误";
                        goto ERR;
                    }
                    break;
                default:
                    if (string.IsNullOrEmpty(GoodsCode))
                    {
                        result.Result = false;
                        result.Message = "货品代码不能为空";
                        goto ERR;
                    }
                    break;
            }
            #region 验证
            CargoContainerEntity contain = house.QueryContainerEntityByCode(ContainerCode, HouseID);
            if (contain == null || contain.ContainerID.Equals(0))
            {
                result.Result = false;
                result.Message = "货位代码不存在";
                goto ERR;
            }
            if (bus.IsExistCargoProductTag(new CargoProductTagEntity { TagCode = TagCode }))
            {
                result.Result = false;
                result.Message = "已经存在相同的产品编码：" + TagCode;
                goto ERR;
            }
            CargoFactoryOrderEntity cargoFactoryOrder = ProductUnitPriceBus.QueryFactoryOrderData(new CargoFactoryOrderEntity { FacOrderNo = SourceOrderNo, HouseID = HouseID, TypeID = TypeID, Specs = Specs, Figure = Figure, GoodsCode = GoodsCode, LoadIndex = LoadIndex, SpeedLevel = SpeedLevel });
            if (cargoFactoryOrder == null)
            {
                result.Result = false;
                result.Message = "请检查来货导入数据：" + SourceOrderNo + ",规格:" + Specs;
                goto ERR;
            }
            //入库状态
            if (!string.IsNullOrEmpty(cargoFactoryOrder.FacOrderNo))
            {
                if (cargoFactoryOrder.InCargoStatus.Equals("1"))
                {
                    result.Result = false;
                    result.Message = "来货单号：" + SourceOrderNo + ",规格:" + Specs + "已入库完成";
                    goto ERR;
                }
                //回告数量    入库数量合计
                if (cargoFactoryOrder.ReplyNumber == cargoFactoryOrder.InPiece)
                {
                    result.Result = false;
                    result.Message = "来货单号：" + SourceOrderNo + ",规格:" + Specs + "已入库完成";
                    goto ERR;
                }
            }
            #endregion

            #region 获取基础价格数据
            Decimal unitPrice = 0.00M, finalCostPrice = 0.00M, costPrice = 0.00M, taxCostPrice = 0.00M, noTaxCostPrice = 0.00M, tradePrice = 0.00M, salePrice = 0.00M, InHousePrice = 0.00M, NextDayPrice = 0.00M;
            string Company = "";
            string BelongDepartName = string.Empty;
            string SpecsType = string.Empty;
            string Supplier = string.Empty;
            int SuppClientNum = 0;
            string SupplierAddress = string.Empty;
            if (!HouseID.Equals(62))
            {
                CargoFactoryOrderEntity factoryOrderEntity = new CargoFactoryOrderEntity();
                CargoFactoryOrderEntity productUnitPrice = new CargoFactoryOrderEntity();
                CargoProductBasicPriceEntity basicPriceEntity = new CargoProductBasicPriceEntity();
                factoryOrderEntity.HLYReturnID = HLYReturnID;

                if (TypeID == 34)
                {
                    factoryOrderEntity.FacOrderNo = SourceOrderNo;
                    factoryOrderEntity.HouseID = HouseID;
                    factoryOrderEntity.TypeID = TypeID;
                    factoryOrderEntity.GoodsCode = GoodsCode;
                }
                else
                {
                    //根据产品类型ID、规格、花纹、速度指数、载重指数、订单月
                    if (BelongMonth.Length.Equals(6))
                    {
                        factoryOrderEntity.FacOrderNo = SourceOrderNo;
                        factoryOrderEntity.HouseID = HouseID;
                        factoryOrderEntity.TypeID = TypeID;
                        factoryOrderEntity.Born = Born;
                        factoryOrderEntity.Assort = Assort;
                        factoryOrderEntity.GoodsCode = GoodsCode;
                        factoryOrderEntity.Specs = Specs;
                        factoryOrderEntity.Figure = Figure;
                        factoryOrderEntity.LoadIndex = LoadIndex;
                        factoryOrderEntity.SpeedLevel = SpeedLevel;
                        factoryOrderEntity.BelongMonth = BelongMonth;
                        factoryOrderEntity.ProductCode = ProductCode;
                    }
                }
                //获取单价
                productUnitPrice = ProductUnitPriceBus.QueryProductUnitPrice(factoryOrderEntity);
                if (productUnitPrice != null && productUnitPrice.ID != 0)
                {
                    GoodsCode = productUnitPrice.GoodsCode;
                    Model = productUnitPrice.Model;
                    Figure = productUnitPrice.Figure;
                    //if (productUnitPrice.Specs.Trim().ToUpper() != Specs.ToUpper() || productUnitPrice.Figure.Trim().ToUpper() != Figure.ToUpper() || productUnitPrice.Model.Trim().ToUpper() != Model.ToUpper() || productUnitPrice.GoodsCode.Trim().ToUpper() != GoodsCode.ToUpper() || productUnitPrice.Born.Trim() != Born || productUnitPrice.Assort.Trim().ToUpper() != Assort.ToUpper() || productUnitPrice.LoadIndex.Trim() != LoadIndex || productUnitPrice.SpeedLevel.Trim().ToUpper() != SpeedLevel.ToUpper())
                    //{
                    //    #region
                    //    if (productUnitPrice.Specs.Trim().ToUpper() != Specs.ToUpper() || productUnitPrice.Figure.Trim().ToUpper() != Figure.ToUpper())
                    //    {
                    //        result.Result = false;
                    //        result.Message = "规格花纹与来货不匹配";
                    //        goto ERR;
                    //    }
                    //    else if (productUnitPrice.Model.Trim().ToUpper() != Model.ToUpper() || productUnitPrice.GoodsCode.Trim().ToUpper() != GoodsCode.ToUpper())
                    //    {
                    //        result.Result = false;
                    //        result.Message = "型号货品代码与来货不匹配";
                    //        goto ERR;
                    //    }
                    //    else if (productUnitPrice.Born.Trim() != Born || productUnitPrice.Assort.Trim().ToUpper() != Assort.ToUpper())
                    //    {
                    //        result.Result = false;
                    //        result.Message = "产地类型与来货不匹配";
                    //        goto ERR;
                    //    }
                    //    else if (productUnitPrice.LoadIndex.Trim() != LoadIndex || productUnitPrice.SpeedLevel.Trim().ToUpper() != SpeedLevel.ToUpper())
                    //    {
                    //        result.Result = false;
                    //        result.Message = "载重速度与来货不匹配";
                    //        goto ERR;
                    //    }
                    //    #endregion
                    //}
                    Company = productUnitPrice.Company;
                    BelongDepart = productUnitPrice.BelongDepart;
                    BelongDepartName = productUnitPrice.BelongDepartName;
                    //OrderType = productUnitPrice.OrderType.ToString();
                    InHousePrice = Convert.ToDecimal(productUnitPrice.InHousePrice);
                    unitPrice = Convert.ToDecimal(productUnitPrice.UnitPrice);
                    salePrice = Convert.ToDecimal(productUnitPrice.SalePrice);
                    tradePrice = Convert.ToDecimal(productUnitPrice.TradePrice);

                    //20230418不再匹配成本价
                    //costPrice = Convert.ToDecimal(productUnitPrice.CostPrice);
                    //taxCostPrice = Convert.ToDecimal(productUnitPrice.TaxCostPrice);
                    //noTaxCostPrice = Convert.ToDecimal(productUnitPrice.NoTaxCostPrice);
                    SpecsType = productUnitPrice.SpecsType;
                    Supplier = productUnitPrice.Supplier;
                    SuppClientNum = string.IsNullOrEmpty(productUnitPrice.SuppClientNum) ? 0 : Convert.ToInt32(productUnitPrice.SuppClientNum);
                    ProductCode = productUnitPrice.ProductCode;
                    SupplierAddress = productUnitPrice.SupplierAddress;
                    //20231011狄乐汽服仓库匹配成本价//供应商进仓来源匹配成本价
                    if (HouseID.Equals(65) || productUnitPrice.Source.Equals(83))
                    {
                        costPrice = Convert.ToDecimal(productUnitPrice.CostPrice);
                    }
                }
                //20230418不再匹配成本价
                //if (BelongDepartName.ToUpper().IndexOf("RE") > -1)//RE渠道销售部门的去获取价格数据
                //20231011狄乐汽服仓库匹配成本价
                //20240110华南配件仓库匹配成本价
                //20250705 所有仓库都要匹配单价  门店价  销售价
                string proYear, proMonth;
                if (BelongMonth.Length.Equals(6))
                {
                    proYear = BelongMonth.Substring(0, 4);
                    proMonth = BelongMonth.Substring(4, 2);
                    if (proMonth.Substring(0, 1) == "0")
                    {
                        proMonth = DateTime.Now.ToString("MM").Substring(1, 1);
                    }
                }
                else
                {
                    proYear = DateTime.Now.ToString("yyyy");
                    proMonth = DateTime.Now.ToString("MM");
                    if (proMonth.Substring(0, 1) == "0")
                    {
                        proMonth = DateTime.Now.ToString("MM").Substring(1, 1);
                    }
                }
                CargoProductBasicPriceEntity basicPrice = house.QueryProductBasicPrice(new CargoProductBasicPriceEntity
                {
                    HouseID = HouseID,
                    TypeID = TypeID,
                    GoodsCode = GoodsCode,
                    ProductCode = ProductCode,
                    Born = -1,
                    ProYear = proYear,
                    ProMonth = proMonth,
                });
                //250807  价格赋值修改
                //单价、成本价用原值
                //进仓价、小程序价、门店价、次日达价  赋值

                if (basicPrice != null && basicPrice.PID != 0)
                {
                    //销售价
                    if (basicPrice.SalePrice > 0) salePrice = Convert.ToDecimal(basicPrice.SalePrice);
                    //门店价
                    if (basicPrice.TradePrice > 0) tradePrice = Convert.ToDecimal(basicPrice.TradePrice);
                    //进仓价
                    if (basicPrice.InHousePrice > 0) InHousePrice = Convert.ToDecimal(basicPrice.InHousePrice);
                    //单价
                    //if (basicPrice.UnitPrice > 0) unitPrice = Convert.ToDecimal(basicPrice.UnitPrice);
                    //次日达价格
                    if (basicPrice.NextDayPrice > 0) NextDayPrice = Convert.ToDecimal(basicPrice.NextDayPrice);
                    ////最终成本价
                    //finalCostPrice = Convert.ToDecimal(basicPrice.FinalCostPrice);
                    //if (basicPrice.CostPrice > 0)
                    //{
                    //    //成本价
                    //    costPrice = Convert.ToDecimal(basicPrice.CostPrice);
                    //    //含税成本价
                    //    taxCostPrice = Convert.ToDecimal(basicPrice.TaxCostPrice);
                    //    //不含税成本价
                    //    noTaxCostPrice = Convert.ToDecimal(basicPrice.NoTaxCostPrice);
                    //}
                    //if (!basicPrice.TradePrice.Equals(0))
                    //{
                    //    tradePrice = Convert.ToDecimal(basicPrice.TradePrice);
                    //    salePrice = Convert.ToDecimal(basicPrice.TradePrice);
                    //}
                }

                //if (HouseID.Equals(65) || HouseID.Equals(82))
                //{
                //    //获取基础价格成本价
                //    //外部订单、外采订单类型和订单类型为空时不匹配基础价格
                //    //if (!string.IsNullOrEmpty(OrderType) && OrderType != "3" && OrderType != "1")
                //    //{
                //    if (BelongMonth.Length.Equals(6))
                //    {
                //        string proYear, proMonth;
                //        proYear = BelongMonth.Substring(0, 4);
                //        proMonth = BelongMonth.Substring(4, 2);
                //        CargoProductBasicPriceEntity basicPrice = new CargoProductBasicPriceEntity();
                //        if (TypeID == 34)
                //        {
                //            basicPriceEntity.HouseID = HouseID;
                //            basicPriceEntity.TypeID = TypeID;
                //            basicPriceEntity.GoodsCode = GoodsCode;
                //            basicPriceEntity.ProYear = proYear;
                //            basicPriceEntity.ProMonth = proMonth;
                //            basicPriceEntity.Born = string.IsNullOrEmpty(Born) ? -1 : Convert.ToInt32(Born);
                //        }
                //        else
                //        {
                //            basicPriceEntity.HouseID = HouseID;
                //            basicPriceEntity.TypeID = TypeID;
                //            basicPriceEntity.Born = string.IsNullOrEmpty(Born) ? -1 : Convert.ToInt32(Born);
                //            basicPriceEntity.Assort = Assort;
                //            basicPriceEntity.GoodsCode = GoodsCode;
                //            basicPriceEntity.Specs = Specs;
                //            basicPriceEntity.Figure = Figure;
                //            basicPriceEntity.LoadIndex = LoadIndex;
                //            basicPriceEntity.SpeedLevel = SpeedLevel;
                //            basicPriceEntity.ProYear = proYear;
                //            basicPriceEntity.ProMonth = proMonth;
                //        }
                //        basicPrice = house.QueryProductBasicPrice(basicPriceEntity);
                //        if (basicPrice != null && basicPrice.PID != 0)
                //        {
                //            finalCostPrice = Convert.ToDecimal(basicPrice.FinalCostPrice);
                //            if (costPrice.Equals(0))
                //            {
                //                costPrice = Convert.ToDecimal(basicPrice.CostPrice);
                //                taxCostPrice = Convert.ToDecimal(basicPrice.TaxCostPrice);
                //                noTaxCostPrice = Convert.ToDecimal(basicPrice.NoTaxCostPrice);
                //            }
                //            if (!basicPrice.TradePrice.Equals(0))
                //            {
                //                tradePrice = Convert.ToDecimal(basicPrice.TradePrice);
                //                salePrice = Convert.ToDecimal(basicPrice.TradePrice);
                //            }
                //            if (!basicPrice.UnitPrice.Equals(0))
                //            {
                //                unitPrice = Convert.ToDecimal(basicPrice.UnitPrice);
                //            }
                //        }
                //        //}
                //    }
                //}
            }

            #endregion
            //仓库同步缓存
            //CargoProductEntity syncProduct = house.SyncTypeProduct(parentID.ToString());
            ////34 马牌  1 同步马牌  2 同步全部品牌
            //if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
            //{
            //    RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
            //}
            //主仓缓存更改
            if (house.IsAddCaching(HouseID, TypeID))
            {
                RedisHelper.HashSet("HCYCHouseStockSyc", HouseID + "_" + TypeID + "_" + ProductCode, ProductCode);
            }
            string GoodsClass = "2";
            if (!SuppClientNum.Equals(0))
            {
                CargoClientEntity cce = clientBus.QueryCargoClientEntity(new CargoClientEntity { ClientNum = SuppClientNum });
                if (cce.ClientType.Equals(4))
                {
                    if (cce.UpClientID.Equals(1))
                    {
                        GoodsClass = "0";
                    }
                    else
                    {
                        GoodsClass = "1";
                    }
                }
            }
            inter.scanTagInCargo(new CargoProductEntity { ProductName = ProductName, GoodsCode = GoodsCode, HouseID = HouseID, TypeID = TypeID, Specs = Specs, Figure = Figure, Model = Model, Batch = Batch, ContainerCode = ContainerCode, TagCode = TagCode, BatchYear = bYear, BatchWeek = bWeek, InCargoID = DateTime.Now.ToString("MMdd") + Common.GetRandomSixNum().ToString(), OPID = UserID, LoadIndex = LoadIndex, SpeedLevel = SpeedLevel, Meridian = "R", TreadWidth = TreadWidth, FlatRatio = flatRadio, HubDiameter = HubDiameter, InCargoStatus = "1", InHouseTime = DateTime.Now, OperaType = "1", Born = Born, Assort = Assort, TyreCode = TyreCode, Numbers = Convert.ToInt32(InCargoNum), ParentID = parentID, Source = Source, SourceOrderNo = SourceOrderNo, BelongMonth = BelongMonth, UnitPrice = unitPrice, NextDayPrice = NextDayPrice, FinalCostPrice = finalCostPrice, CostPrice = costPrice, InHousePrice = InHousePrice, TaxCostPrice = taxCostPrice, NoTaxCostPrice = noTaxCostPrice, TradePrice = tradePrice, SalePrice = salePrice, HLYReturnID = HLYReturnID, BelongDepart = BelongDepart, Company = Company, SpecsType = SpecsType, Supplier = Supplier, SuppClientNum = SuppClientNum, ProductCode = ProductCode, SupplierAddress = SupplierAddress, Package = Package, PackageNum = Convert.ToInt32(PackageNum), GoodsClass = GoodsClass, OwnerShip = cargoFactoryOrder.OwnerShip }, log);

        ERR:
            //JSON  
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }

        /// <summary>
        /// 扫描马牌轮胎二维码入库
        /// </summary>
        /// <param name="context"></param>
        private void ScanQRCodeInCargo(HttpContext context)
        {
            string ContainerCode = Convert.ToString(context.Request["ContainerCode"]);//货位代码
            string TagCode = Convert.ToString(context.Request["TagCode"]);//马牌二维码
            string[] tArr = TagCode.Split('=');
            if (tArr.Length > 1)
            {
                TagCode = tArr[1];
            }
            string QrText = Convert.ToString(context.Request["QrText"]);//轮胎内侧码
            string[] QtArr = QrText.Split('=');
            if (QtArr.Length > 1)
            {
                QrText = QtArr[1];
            }
            string UserID = Convert.ToString(context.Request["UserID"]);//操作人账号
            string ProductName = Convert.ToString(context.Request["ProductName"]);//产品名称
            int HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID
            string Source = Convert.ToString(context.Request["Source"]);//产品来源
            string GoodsCode = string.Empty;//货品代码
            int TypeID = 34;//产品类型ID
            string Specs = string.Empty;//规格
            string Figure = string.Empty;//花纹

            string Company = "0";//所属公司 0:迪乐泰1:好来运
            string Model;//型号
            string Batch = string.Empty;//周期
            string QRcode = string.IsNullOrEmpty(QrText) ? TagCode : QrText;//产品唯一编码标签码
            TagCode = String.IsNullOrEmpty(TagCode) ? QRcode : TagCode;
            string LoadIndex = string.Empty;//载重指数
            string SpeedLevel = string.Empty;//速度级别
            string Born = Convert.ToString(context.Request["Born"]);// "0";//生产地 0：国产1：进口
            string Assort = "";//OER  REP 胎
            string TyreCode = string.Empty;//轮胎编码
            string InCargoNum = "1";//入库数量
            string SourceOrderNo;//工厂订单号
            string BelongMonth = DateTime.Now.ToString("yyyyMM");//订单归属月
            string OrderType = "0";//订单类型ID
            string HLYReturnID = string.Empty;//好来运ID

            ErrMessage msg = new ErrMessage(); msg.Message = "保存成功"; msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "产品管理";
            log.NvgPage = "PDA马牌扫描入库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "A";
            log.Status = "0";

            if (string.IsNullOrEmpty(QRcode))
            {
                msg.Result = false;
                msg.Message = "二维码不能为空";
                goto ERR;
            }
            //if (QRcode.IndexOf("R") < -1)
            //{
            //    msg.Result = false;
            //    msg.Message = "请扫描正确的二维码";
            //    goto ERR;
            //}
            if (string.IsNullOrEmpty(ContainerCode))
            {
                msg.Result = false;
                msg.Message = "货位代码不能为空";
                goto ERR;
            }
            CargoProductBus bus = new CargoProductBus();
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoHouseBus house = new CargoHouseBus();
            CargoOrderBus order = new CargoOrderBus();
            #region 验证
            CargoContainerEntity contain = house.QueryContainerEntityByCode(ContainerCode, HouseID);
            if (contain == null || contain.ContainerID.Equals(0))
            {
                msg.Result = false;
                msg.Message = "货位代码不存在";
                goto ERR;
            }
            if (bus.IsExistCargoProductTag(new CargoProductTagEntity { TagCode = TagCode }))
            {
                msg.Result = false;
                msg.Message = "已经存在相同的产品编码：" + TagCode;
                goto ERR;
            }
            #endregion

            //调用马牌接口查询轮胎数据
            TimeSpan ts = DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0);
            string tms = Convert.ToInt64(ts.TotalSeconds).ToString();
            string sign = string.Empty;
            //二维码转条码 通过扫描轮胎上二维码查询该条轮胎具体信息

            string ss = "QRcode=" + QRcode + "&appKey=" + Common.GetContiappKey() + "&noise=" + Common.GetContinoise() + "&timestamp=" + tms + "&appSecret=" + Common.GetContiappSecret();
            if (!QRcode.ToUpper().Contains("R"))
            {
                ss = "appKey=" + Common.GetContiappKey() + "&barcodes=%5B" + QRcode + "%5D" + "&noise=" + Common.GetContinoise() + "&timestamp=" + tms + "&appSecret=" + Common.GetContiappSecret();
            }
            string reValue = string.Empty;
            //MD5加密
            using (MD5 md5Hash = MD5.Create())
            {
                sign = Common.GetMd5Hash(md5Hash, ss);
            }
            NameValueCollection nvc = new NameValueCollection();
            nvc.Add("appKey", Common.GetContiappKey());
            nvc.Add("noise", Common.GetContinoise());
            nvc.Add("timestamp", tms);
            nvc.Add("sign", sign);
            //if (!QRcode.ToUpper().Contains("R"))
            if (!QRcode.ToUpper().Contains("R"))
            {
                nvc.Add("barcodes", "%5B" + QRcode + "%5D");
                reValue = wxHttpUtility.PostForm("https://contiid.continental-tires.cn/api/2.0/TTP/getBarcodeInfo", nvc, null);
                ArrayList GridRows = (ArrayList)JSON.Decode("[" + reValue + "]");
                foreach (Hashtable item in GridRows)
                {
                    //数据返回正确
                    if (Convert.ToString(item["code"]).Equals("1000"))
                    {
                        ArrayList datalit = (ArrayList)JSON.Decode("[" + JSON.Encode(item["data"]) + "]");
                        foreach (Hashtable ri in datalit)
                        {
                            ArrayList datalitt = (ArrayList)JSON.Decode("[" + JSON.Encode(ri["" + QRcode + ""]) + "]");
                            foreach (Hashtable rit in datalitt)
                            {
                                string[] description = Convert.ToString(rit["Description"]).Split(' ');
                                for (int i = 2; i < description.Length; i++)
                                {
                                    Figure += description[i];//花纹
                                }
                                Specs = description[0];
                                string loadSpeed = description[1].Replace("(", "").Replace(")", "");
                                LoadIndex = loadSpeed.Substring(0, loadSpeed.Length - 1);
                                SpeedLevel = loadSpeed.Substring(loadSpeed.Length - 1);
                                TyreCode = Convert.ToString(rit["barcode"]);
                                GoodsCode = Convert.ToString(rit["material"]);
                                if (GoodsCode.Length > 6)
                                {
                                    GoodsCode = GoodsCode + "0000";
                                }
                                else if (GoodsCode.Length == 5)
                                {
                                    GoodsCode = "0" + GoodsCode + "0000";
                                }
                                Batch = Convert.ToString(rit["DOT"]);
                                string singleBrand = Convert.ToString(rit["brand"]);
                                if (singleBrand.ToUpper().Contains("VIKING"))
                                {
                                    TypeID = 345;
                                    ProductName = "维京轮胎";
                                }
                            }
                        }
                    }
                    else
                    {
                        msg.Result = false;
                        msg.Message = Convert.ToString(item["code"].ToString() + " " + item["data"].ToString());
                        goto ERR;
                    }
                }
            }
            else
            {
                nvc.Add("QRcode", QRcode);
                //二维码转条码 接口
                reValue = wxHttpUtility.PostForm("https://contiid.continental-tires.cn/api/2.0/TTP/QRgetBarcode", nvc, null);
                ArrayList GridRows = (ArrayList)JSON.Decode("[" + reValue + "]");
                foreach (Hashtable item in GridRows)
                {
                    //数据返回正确
                    if (Convert.ToString(item["code"]).Equals("1000"))
                    {
                        ArrayList datalit = (ArrayList)JSON.Decode("[" + JSON.Encode(item["data"]) + "]");
                        foreach (Hashtable ri in datalit)
                        {
                            string[] description = Convert.ToString(ri["Description"]).Split(' ');
                            for (int i = 2; i < description.Length; i++)
                            {
                                Figure += description[i];//花纹
                            }
                            Specs = description[0];
                            string loadSpeed = description[1].Replace("(", "").Replace(")", "");
                            LoadIndex = loadSpeed.Substring(0, loadSpeed.Length - 1);
                            SpeedLevel = loadSpeed.Substring(loadSpeed.Length - 1);
                            TyreCode = Convert.ToString(ri["barcode"]);
                            GoodsCode = Convert.ToString(ri["material"]);
                            if (GoodsCode.Length > 6)
                            {
                                GoodsCode = GoodsCode + "0000";
                            }
                            else if (GoodsCode.Length == 5)
                            {
                                GoodsCode = "0" + GoodsCode + "0000";
                            }
                            Batch = Convert.ToString(ri["DOT"]);
                            string singleBrand = Convert.ToString(ri["singleBrand"]);
                            if (singleBrand.ToUpper().Contains("VIKING"))
                            {
                                TypeID = 345;
                                ProductName = "维京轮胎";
                            }
                        }
                    }
                    else
                    {
                        msg.Result = false;
                        msg.Message = Convert.ToString(item["code"].ToString() + " " + item["data"].ToString());
                        goto ERR;
                    }
                }
            }


            //查询原仓库的产品信息
            Model = Specs;


            List<CargoFactoryOrderBarcodeEntity> barlist = order.QueryBarcodeInfo(new CargoFactoryOrderBarcodeEntity { Barcode = TyreCode });
            if (barlist.Count <= 0)
            {
                msg.Result = false;
                msg.Message = "请重新获取该船运号标签";
                goto ERR;
            }
            SourceOrderNo = barlist[0].VehicleNo;
            #region 通用数据检验

            if (string.IsNullOrEmpty(GoodsCode))
            {
                msg.Result = false;
                msg.Message = "货品代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(ContainerCode))
            {
                msg.Result = false;
                msg.Message = "货位代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                msg.Result = false;
                msg.Message = "产品编码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(Batch))
            {
                msg.Result = false;
                msg.Message = "周期批次不能为空";
                goto ERR;
            }
            #endregion
            List<CargoProductTypeEntity> ptype = bus.QueryProductType(new CargoProductTypeEntity { TypeID = TypeID, ParentID = -1 });
            int parentID = 0;
            if (ptype.Count > 0)
            {
                parentID = ptype[0].ParentID;
            }
            int bYear = 0, bWeek = 0, flatRadio = 0, HubDiameter = 0, TreadWidth = 0;
            switch (parentID)
            {
                case 1:
                    #region 轮胎
                    if (string.IsNullOrEmpty(Specs))
                    {
                        msg.Result = false;
                        msg.Message = "规格不能为空";
                        goto ERR;
                    }
                    if (string.IsNullOrEmpty(Figure))
                    {
                        msg.Result = false;
                        msg.Message = "花纹不能为空";
                        goto ERR;
                    }
                    if (!Common.IsInt(LoadIndex))
                    {
                        msg.Result = false;
                        msg.Message = "载重指数数据有误";
                        goto ERR;
                    }
                    if (string.IsNullOrEmpty(SpeedLevel))
                    {
                        msg.Result = false;
                        msg.Message = "速度级别不能为空";
                        goto ERR;
                    }
                    if (Batch.Length != 4)
                    {
                        msg.Result = false;
                        msg.Message = "周期批次输入有误";
                        goto ERR;
                    }
                    if (!Common.IsInt(Batch))
                    {
                        msg.Result = false;
                        msg.Message = "周期批次输入有误";
                        goto ERR;
                    }
                    if (Batch.Length == 4)
                    {
                        bWeek = Convert.ToInt32(Batch.Substring(0, 2));
                        bYear = Convert.ToInt32(Batch.Substring(2, 2));
                    }
                    else if (Batch.Length == 3)
                    {
                        bWeek = Convert.ToInt32(Batch.Substring(0, 1));
                        bYear = Convert.ToInt32(Batch.Substring(1, 2));
                    }
                    string[] sp = Specs.Split('/');
                    if (sp.Length > 1)
                    {
                        if (Common.IsInt(sp[0]))
                        {
                            TreadWidth = Convert.ToInt32(sp[0]);
                        }
                        string gg = Convert.ToString(sp[1]);
                        if (Common.IsInt(gg.Substring(0, 2)))
                        {
                            flatRadio = Convert.ToInt32(gg.Substring(0, 2));
                        }
                        if (Common.IsInt(gg.Substring(3, 2)))
                        {
                            HubDiameter = Convert.ToInt32(gg.Substring(3, 2));
                        }
                        //HubDiameter = Convert.ToInt32(gg.Substring(gg.Length - 2, 2));
                    }
                    #endregion
                    InCargoNum = "1";
                    //Figure = Figure.Replace(" ", "");
                    break;
                default:
                    break;
            }
            CargoFactoryOrderBus ProductUnitPrice = new CargoFactoryOrderBus();

            CargoFactoryOrderEntity cargoFactoryOrder = ProductUnitPrice.QueryFactoryOrderData(new CargoFactoryOrderEntity { FacOrderNo = SourceOrderNo, HouseID = HouseID, TypeID = TypeID, Specs = Specs, Figure = Figure, GoodsCode = GoodsCode, LoadIndex = LoadIndex, SpeedLevel = SpeedLevel });
            if (cargoFactoryOrder == null)
            {
                msg.Result = false;
                msg.Message = "请检查来货导入数据：" + SourceOrderNo + ",规格:" + Specs;
                goto ERR;
            }
            if (!string.IsNullOrEmpty(cargoFactoryOrder.FacOrderNo))
            {
                if (cargoFactoryOrder.InCargoStatus.Equals("1"))
                {
                    msg.Result = false;
                    msg.Message = "来货单号：" + SourceOrderNo + ",规格:" + Specs + "已入库完成";
                    goto ERR;
                }
                if (cargoFactoryOrder.ReplyNumber == cargoFactoryOrder.InPiece)
                {
                    msg.Result = false;
                    msg.Message = "来货单号：" + SourceOrderNo + ",规格:" + Specs + "已入库完成";
                    goto ERR;
                }
            }
            //根据产品类型ID、规格、花纹、速度指数、载重指数、订单月
            Decimal unitPrice = 0.00M, finalCostPrice = 0.00M, costPrice = 0.00M, taxCostPrice = 0.00M, noTaxCostPrice = 0.00M, tradePrice = 0.00M, salePrice = 0.00M, InHousePrice = 0.00M, NextDayPrice = 0.00M;
            string BelongDepart = "";
            string BelongDepartName = string.Empty;
            string SpecsType = string.Empty;
            string Supplier = string.Empty;
            int SuppClientNum = 0;
            string SupplierAddress = string.Empty;
            string ProductCode = string.Empty;

            Supplier = cargoFactoryOrder.Supplier;
            SuppClientNum = string.IsNullOrEmpty(cargoFactoryOrder.SuppClientNum) ? 0 : Convert.ToInt32(cargoFactoryOrder.SuppClientNum);
            ProductCode = cargoFactoryOrder.ProductCode;
            SupplierAddress = cargoFactoryOrder.SupplierAddress;
            #region 获取基础价格数据

            //获取单价
            CargoFactoryOrderEntity factoryOrderentity = new CargoFactoryOrderEntity();
            CargoProductBasicPriceEntity basicPriceEntity = new CargoProductBasicPriceEntity();
            factoryOrderentity.FacOrderNo = SourceOrderNo;
            factoryOrderentity.HouseID = HouseID;
            factoryOrderentity.TypeID = TypeID;
            factoryOrderentity.GoodsCode = GoodsCode;
            CargoFactoryOrderEntity productUnitPrice = ProductUnitPrice.QueryProductUnitPrice(factoryOrderentity);
            if (productUnitPrice != null && productUnitPrice.ID != 0)
            {
                BelongDepart = productUnitPrice.BelongDepart;
                BelongDepartName = productUnitPrice.BelongDepartName;

                unitPrice = Convert.ToDecimal(productUnitPrice.UnitPrice);
                salePrice = Convert.ToDecimal(productUnitPrice.SalePrice);//小程序价
                tradePrice = Convert.ToDecimal(productUnitPrice.TradePrice);//门店价
                InHousePrice = Convert.ToDecimal(productUnitPrice.InHousePrice);
                costPrice = Convert.ToDecimal(productUnitPrice.CostPrice);
                taxCostPrice = Convert.ToDecimal(productUnitPrice.TaxCostPrice);
                noTaxCostPrice = Convert.ToDecimal(productUnitPrice.NoTaxCostPrice);
                //从来货单导入数据表中取产品来源和产地20220827
                Source = Convert.ToString(productUnitPrice.Source);
                Born = Convert.ToString(productUnitPrice.Born);
                SpecsType = productUnitPrice.SpecsType;

                Supplier = productUnitPrice.Supplier;
                SuppClientNum = string.IsNullOrEmpty(productUnitPrice.SuppClientNum) ? 0 : Convert.ToInt32(productUnitPrice.SuppClientNum);
                ProductCode = productUnitPrice.ProductCode;
                SupplierAddress = productUnitPrice.SupplierAddress;
            }

            //20250705 所有仓库都要匹配单价  门店价  销售价
            string proYear, proMonth;
            if (BelongMonth.Length.Equals(6))
            {
                proYear = BelongMonth.Substring(0, 4);
                proMonth = BelongMonth.Substring(4, 2);
                if (proMonth.Substring(0, 1) == "0")
                {
                    proMonth = DateTime.Now.ToString("MM").Substring(1, 1);
                }
            }
            else
            {
                proYear = DateTime.Now.ToString("yyyy");
                proMonth = DateTime.Now.ToString("MM");
                if (proMonth.Substring(0, 1) == "0")
                {
                    proMonth = DateTime.Now.ToString("MM").Substring(1, 1);
                }
            }
            CargoProductBasicPriceEntity basicPrice = house.QueryProductBasicPrice(new CargoProductBasicPriceEntity
            {
                HouseID = HouseID,
                TypeID = TypeID,
                GoodsCode = GoodsCode,
                ProductCode = ProductCode,
                Born = -1,
                ProYear = proYear,
                ProMonth = proMonth,
            });
            if (basicPrice != null && basicPrice.PID != 0)
            {
                //销售价
                if (basicPrice.SalePrice > 0) salePrice = Convert.ToDecimal(basicPrice.SalePrice);
                //门店价
                if (basicPrice.TradePrice > 0) tradePrice = Convert.ToDecimal(basicPrice.TradePrice);
                //进仓价
                if (basicPrice.InHousePrice > 0) InHousePrice = Convert.ToDecimal(basicPrice.InHousePrice);
                //单价
                //if (basicPrice.UnitPrice > 0) unitPrice = Convert.ToDecimal(basicPrice.UnitPrice);
                //次日达价格
                if (basicPrice.NextDayPrice > 0) NextDayPrice = Convert.ToDecimal(basicPrice.NextDayPrice);
                ////最终成本价
                //finalCostPrice = Convert.ToDecimal(basicPrice.FinalCostPrice);
                //if (basicPrice.CostPrice > 0)
                //{
                //    //成本价
                //    costPrice = Convert.ToDecimal(basicPrice.CostPrice);
                //    //含税成本价
                //    taxCostPrice = Convert.ToDecimal(basicPrice.TaxCostPrice);
                //    //不含税成本价
                //    noTaxCostPrice = Convert.ToDecimal(basicPrice.NoTaxCostPrice);
                //}
                //if (!basicPrice.TradePrice.Equals(0))
                //{
                //    tradePrice = Convert.ToDecimal(basicPrice.TradePrice);
                //    salePrice = Convert.ToDecimal(basicPrice.TradePrice);
                //}
            }
            //if (BelongDepartName.ToUpper().IndexOf("RE") > -1)//RE渠道销售部门的去获取价格数据
            //{
            //    //获取基础价格成本价
            //    //外采订单类型和订单类型为空时不匹配基础价格
            //    if (!string.IsNullOrEmpty(OrderType) && OrderType != "3")
            //    {
            //        if (BelongMonth.Length.Equals(6))
            //        {
            //            string proYear, proMonth;
            //            proYear = BelongMonth.Substring(0, 4);
            //            proMonth = BelongMonth.Substring(4, 2);
            //            CargoProductBasicPriceEntity basicPrice = new CargoProductBasicPriceEntity();
            //            if (TypeID == 34)
            //            {
            //                basicPriceEntity.HouseID = HouseID;
            //                basicPriceEntity.TypeID = TypeID;
            //                basicPriceEntity.GoodsCode = GoodsCode;
            //                basicPriceEntity.ProYear = proYear;
            //                basicPriceEntity.ProMonth = proMonth;
            //            }
            //            else
            //            {
            //                basicPriceEntity.HouseID = HouseID;
            //                basicPriceEntity.TypeID = TypeID;
            //                basicPriceEntity.Born = string.IsNullOrEmpty(Born) ? -1 : Convert.ToInt32(Born);
            //                basicPriceEntity.Assort = Assort;
            //                basicPriceEntity.GoodsCode = GoodsCode;
            //                basicPriceEntity.Specs = Specs;
            //                basicPriceEntity.Figure = Figure;
            //                basicPriceEntity.LoadIndex = LoadIndex;
            //                basicPriceEntity.SpeedLevel = SpeedLevel;
            //                basicPriceEntity.ProYear = proYear;
            //                basicPriceEntity.ProMonth = proMonth;
            //            }
            //            basicPrice = house.QueryProductBasicPrice(basicPriceEntity);
            //            if (basicPrice != null && basicPrice.PID != 0)
            //            {
            //                finalCostPrice = Convert.ToDecimal(basicPrice.FinalCostPrice);
            //                if (costPrice.Equals(0))
            //                {
            //                    costPrice = Convert.ToDecimal(basicPrice.CostPrice);
            //                    taxCostPrice = Convert.ToDecimal(basicPrice.TaxCostPrice);
            //                    noTaxCostPrice = Convert.ToDecimal(basicPrice.NoTaxCostPrice);
            //                }
            //                if (!basicPrice.TradePrice.Equals(0))
            //                {
            //                    tradePrice = Convert.ToDecimal(basicPrice.TradePrice);
            //                    salePrice = Convert.ToDecimal(basicPrice.TradePrice);
            //                }
            //            }
            //        }
            //    }
            //}
            #endregion
            //仓库同步缓存
            CargoProductEntity syncProduct = house.SyncTypeProduct(parentID.ToString());
            //34 马牌  1 同步马牌  2 同步全部品牌
            if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
            {
                RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
            }
            inter.scanTagInCargo(new CargoProductEntity { ProductName = ProductName, GoodsCode = GoodsCode, HouseID = HouseID, TypeID = TypeID, Specs = Specs, Figure = Figure, Model = Model, Batch = Batch, ContainerCode = ContainerCode, TagCode = TagCode, BatchYear = bYear, BatchWeek = bWeek, InCargoID = DateTime.Now.ToString("MMdd") + Common.GetRandomSixNum().ToString(), OPID = UserID, LoadIndex = LoadIndex, SpeedLevel = SpeedLevel, Meridian = "R", TreadWidth = TreadWidth, FlatRatio = flatRadio, HubDiameter = HubDiameter, InCargoStatus = "1", InHouseTime = DateTime.Now, OperaType = "1", Born = Born, Assort = Assort, TyreCode = TyreCode, Numbers = Convert.ToInt32(InCargoNum), ParentID = parentID, Source = Source, SourceOrderNo = SourceOrderNo, BelongMonth = BelongMonth, UnitPrice = unitPrice, FinalCostPrice = finalCostPrice, CostPrice = costPrice, InHousePrice = InHousePrice, TaxCostPrice = taxCostPrice, NoTaxCostPrice = noTaxCostPrice, TradePrice = tradePrice, SalePrice = salePrice, HLYReturnID = HLYReturnID, Company = Company, BelongDepart = BelongDepart, SpecsType = SpecsType, Supplier = Supplier, SuppClientNum = SuppClientNum, ProductCode = ProductCode, SupplierAddress = SupplierAddress, NextDayPrice = NextDayPrice, GoodsClass = "0" }, log);
            msg.Message = Batch;
        ERR:
            //返回处理结果
            string ress = JSON.Encode(msg);
            context.Response.Write(ress);

        }
        /// <summary>
        /// 获取所有产品来源
        /// </summary>
        private void QueryAllProductSource(HttpContext context)
        {
            CargoProductBus bus = new CargoProductBus();
            List<CargoProductSourceEntity> list = bus.QueryAllProductSource();
            String json = JSON.Encode(list);
            context.Response.Write(json);
        }
        /// <summary>
        /// 查询订单信息
        /// </summary>
        /// <param name="context"></param>
        private void queryOrderNo(HttpContext context)
        {
            string LogisAwbNo = context.Request["HLYAwbNo"];//物流运单号
            string AcceptPeople = context.Request["AcceptPeople"];//收货人姓名
            string OrderNo = context.Request["OrderNo"];//订单号
            CargoAPIMessage err = new CargoAPIMessage();
            err.Result = true;
            int HouseID = 0;
            if (string.IsNullOrEmpty(LogisAwbNo))
            {
                if (string.IsNullOrEmpty(context.Request["HouseID"]))
                {
                    err.Result = false;
                    err.Message = "仓库代码不能为空";
                    //JSON
                    String jsons = JSON.Encode(err);
                    context.Response.Write(jsons);
                    return;
                }
                HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID

                if (HouseID.Equals(0))
                {
                    err.Result = false;
                    err.Message = "仓库代码不能为空";
                    //JSON
                    String jsons = JSON.Encode(err);
                    context.Response.Write(jsons);
                    return;

                }
            }

            string AcceptCellphone = context.Request["AcceptCellphone"];//收货人电话
            DateTime StartDate = string.IsNullOrEmpty(Convert.ToString(context.Request["StartDate"])) ? DateTime.Now.AddMonths(-1) : Convert.ToDateTime(context.Request["StartDate"]);
            DateTime EndDate = string.IsNullOrEmpty(Convert.ToString(context.Request["EndDate"])) ? DateTime.Now : Convert.ToDateTime(context.Request["EndDate"]);
            CargoInterfaceBus bus = new CargoInterfaceBus();
            List<CargoAPIMessage> result = new List<CargoAPIMessage>();
            result = bus.queryOrderDataList(new CargoOrderEntity
            {
                OrderNo = OrderNo,
                AcceptPeople = AcceptPeople,
                HouseID = HouseID,
                StartDate = !string.IsNullOrEmpty(OrderNo) ? Convert.ToDateTime("0001-01-01") : StartDate,
                EndDate = EndDate,
                LogisAwbNo = LogisAwbNo,
                AcceptCellphone = AcceptCellphone
            });
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 扫描出库 保存产品出库完成
        /// </summary>
        /// <param name="context"></param>
        private void saveOutCargoOk(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();
            result.Result = true;
            string reprint = context.Request["reprint"];//补打标签
            CargoProductBus bus = new CargoProductBus();
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoOrderBus order = new CargoOrderBus();
            if (!reprint.Equals("1"))
            {
                string OrderNo = context.Request["OrderNo"];//订单号
                if (string.IsNullOrEmpty(context.Request["ProductID"]))
                {
                    result.Result = false;
                    result.Message = "产品ID不能为空";
                    goto ERR;
                }
                long ProductID = Convert.ToInt32(context.Request["ProductID"]);//仓库代码ID
                string TagCode = context.Request["TagCode"];//产品唯一编码标签码
                string[] tArr = TagCode.Split('=');
                if (tArr.Length > 1)
                {
                    TagCode = tArr[1];
                }
                else
                {
                    string[] gtc = TagCode.Split('|');
                    if (gtc.Length > 1)
                    {
                        TagCode = gtc[5];
                        //TagCode = tc.Substring(8, tc.Length - 8);
                    }
                }
                string UserID = context.Request["UserID"];//操作人账号

                result.Message = "保存成功";
                LogEntity log = new LogEntity();
                log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                log.Moudle = "产品管理";
                log.NvgPage = "扫描出库";
                log.UserID = UserID;//限定某一账号
                log.Operate = "A";
                log.Status = "0";
                #region 验证

                if (ProductID.Equals(0))
                {
                    result.Result = false;
                    result.Message = "产品ID不能为空";
                    goto ERR;
                }
                if (string.IsNullOrEmpty(OrderNo))
                {
                    result.Result = false;
                    result.Message = "订单号不能为空";
                    goto ERR;
                }
                if (string.IsNullOrEmpty(TagCode))
                {
                    result.Result = false;
                    result.Message = "标签编码不能为空";
                    goto ERR;
                }
                if (bus.IsExistCargoProductTag(new CargoProductTagEntity { TagCode = TagCode, OutCargoStatus = "1" }))
                {
                    result.Result = false;
                    result.Message = "标签编码：" + TagCode + "已经出库";
                    goto ERR;
                }
                //这里可以拿 到ContainerID ContainerCode
                CargoProductEntity proTag = bus.QueryProductInfoByTagCode(new CargoProductTagEntity { TagCode = TagCode });
                if (proTag.ProductID.Equals(0))
                {
                    result.Result = false;
                    result.Message = "标签编码不存在";
                    goto ERR;
                }
                if (proTag.MoveStatus == "0")
                {
                    result.Result = false;
                    result.Message = "该标签正在移库无法出库";
                    goto ERR;
                }
                List<CargoOrderGoodsEntity> orderTag = order.QueryOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = OrderNo, ProductID = ProductID, ContainerCode = proTag.ContainerCode });
                if (orderTag.Count <= 0)
                {
                    result.Result = false;
                    result.Message = "该订单不存在该产品ID";
                    goto ERR;
                }
                bool existContainerCode = false;
                foreach (var o in orderTag)
                {
                    if (o.ContainerCode.Equals(proTag.ContainerCode))
                    {
                        existContainerCode = true;
                        break;
                    }
                }
                if (!existContainerCode)
                {
                    result.Result = false;
                    result.Message = "该标签编码不在出库列表";
                    goto ERR;
                }
                if (!inter.IsSetOutCargoOK(new CargoProductTagEntity
                {
                    OrderNo = OrderNo,
                    ProductID = ProductID,
                    ContainerID = proTag.ContainerID,
                    ContainerCode = proTag.ContainerCode,
                    BundleNum = proTag.PackageNum.Equals(0) ? 1 : proTag.PackageNum
                }))
                {
                    //该订单和该产品ID已经出库完成，查找相同运单 号的其它订单上要出库的产品
                    List<CargoProductTagEntity> orderList = inter.QueryScanOutCargoOrderList(new CargoProductTagEntity { OrderNo = OrderNo, ProductID = ProductID });
                    if (orderList.Count <= 0)
                    {
                        result.Result = false;
                        result.Message = "该订单已出库完成";
                        goto ERR;
                    }
                    bool AOut = false;
                    foreach (var it in orderList)
                    {
                        if (it.OrderNo.Equals(OrderNo)) { continue; }
                        if (inter.IsSetOutCargoOK(new CargoProductTagEntity
                        {
                            OrderNo = OrderNo,
                            ProductID = ProductID,
                            ContainerID = proTag.ContainerID,
                            ContainerCode = proTag.ContainerCode,
                            BundleNum = proTag.PackageNum.Equals(0) ? 1 : proTag.PackageNum
                        }))
                        {
                            AOut = true;
                            OrderNo = it.OrderNo;
                            break;
                        }
                    }
                    if (!AOut)
                    {
                        result.Result = false;
                        result.Message = "该运单下所有订单该产品已出库完成";
                        goto ERR;
                    }
                }
                #endregion

                inter.SetProductTag(new CargoProductTagEntity { OrderNo = OrderNo, OutCargoStatus = "1", OutCargoOperID = UserID, ProductID = ProductID, TagCode = TagCode }, log);
                //inter.scanTagInCargo(new CargoProductEntity { GoodsCode = GoodsCode, HouseID = HouseID, TypeID = TypeID, Specs = Specs, Figure = Figure, Model = Model, Batch = Batch, ContainerCode = ContainerCode, TagCode = TagCode, BatchYear = bYear, BatchWeek = bWeek, InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString() }, log);
                try
                {
                    log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                    log.Moudle = "订单管理";
                    log.NvgPage = "订单状态跟踪";
                    log.UserID = "2029";
                    log.Status = "0";
                    log.Operate = "U";
                    //如果存在产品编码，根据产品编码查询捆包数量
                    //如果使用的是共享编码，则根据共享编码查询基础资料信息用于标签打印
                    CargoProductSpecEntity specEntity = new CargoProductSpecEntity();
                    if (!string.IsNullOrEmpty(orderTag[0].ShowProductCode))
                    {
                        specEntity = bus.GetProductSpecByProductCode(orderTag[0].ShowProductCode);
                    }
                    else
                    {
                        if (!string.IsNullOrEmpty(proTag.ProductCode))
                        {
                            specEntity = bus.GetProductSpecByProductCode(proTag.ProductCode);
                        }
                    }
                    //查询订单信息，修改订单状态和商城订单状态 ，推送订单状态通知
                    CargoOrderEntity orderEn = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = OrderNo });
                    CargoProductInfoEntity infoEntity = new CargoProductInfoEntity();
                    infoEntity.ProductName = specEntity.ProductName;
                    infoEntity.BrandCode = specEntity.BrandCode;
                    infoEntity.TagCode = TagCode;
                    infoEntity.Specs = specEntity.Specs;
                    infoEntity.Figure = specEntity.Figure;
                    infoEntity.GoodsCode = specEntity.GoodsCode;
                    infoEntity.Model = specEntity.Model;
                    infoEntity.SpeedLevel = specEntity.SpeedLevel;
                    infoEntity.LoadIndex = specEntity.LoadIndex;
                    infoEntity.Batch = proTag.Batch;
                    infoEntity.CarModel = specEntity.CarModel;
                    infoEntity.Manufacturer = specEntity.Manufacturer;
                    infoEntity.ManufacturerAddress = specEntity.ManufacturerAddress;
                    infoEntity.Seller = specEntity.Seller;
                    infoEntity.SellerAddress = specEntity.SellerAddress;
                    infoEntity.Servicer = specEntity.Servicer;
                    infoEntity.ServicerAddress = specEntity.ServicerAddress;
                    infoEntity.UpClientID = Convert.ToInt32(orderEn.UpClientID);
                    infoEntity.UpClientShortName = orderEn.UpClientShortName;
                    result.ProductTagInfo = infoEntity;
                    if (orderEn.Piece.Equals(1) || orderEn.Piece.Equals(specEntity.BundleNum))
                    {
                        #region 出库完成
                        //出库完成
                        order.SaveOrderStatus(new CargoOrderStatusEntity
                        {
                            OrderID = orderEn.OrderID,
                            OrderNo = orderEn.OrderNo,
                            OrderStatus = "2",
                            WXOrderNo = orderEn.WXOrderNo,
                            OP_ID = "2029",
                            OP_Name = UserID,
                            OP_DATE = DateTime.Now,
                            DetailInfo = ""
                        }, log);
                        //如果前置仓不为0且订单号不为空，则同步更新前置仓关联订单的出库状态
                        if (!orderEn.OrignHouseID.Equals(0) && !string.IsNullOrEmpty(orderEn.OpenOrderNo))
                        {
                            order.SaveOrderStatus(new CargoOrderStatusEntity
                            {
                                OrderNo = orderEn.OpenOrderNo,
                                OrderStatus = "2",
                                WXOrderNo = orderEn.WXOrderNo,
                                OP_ID = "2029",
                                OP_Name = UserID,
                                OP_DATE = DateTime.Now,
                                DetailInfo = "共享仓同步出库"
                            }, log);
                        }

                        #region 推送客户通知
                        //推送客户通知
                        //if (!string.IsNullOrEmpty(orderEn.WXOrderNo))
                        //{
                        //    string title = string.Empty;
                        //    switch (orderEn.HouseID)
                        //    {
                        //        case 1: title = "尊敬的湖南迪乐泰客户，您的订单已出库！"; break;
                        //        case 3: title = "尊敬的湖北迪乐泰客户，您的订单已出库！"; break;
                        //        case 11: title = "尊敬的西北迪乐泰客户，您的订单已出库！"; break;
                        //        case 12: title = "尊敬的梅州迪乐泰客户，您的订单已出库！"; break;
                        //        case 9: title = "尊敬的客户，您的订单已出库！"; break;
                        //        case 34: title = "尊敬的海南迪乐泰客户，您的订单已出库！"; break;
                        //        case 46: title = "尊敬的四川迪乐泰客户，您的订单已出库！"; break;
                        //        default: break;
                        //    }
                        //    if (string.IsNullOrEmpty(title)) { goto ERR; }
                        //    List<WXOrderManagerEntity> wxOrderList = order.QueryWeixinOrderInfo(new WXOrderManagerEntity { OrderNo = orderEn.WXOrderNo });
                        //    if (wxOrderList.Count > 0)
                        //    {
                        //        CargoHouseBus house = new CargoHouseBus();
                        //        CargoHouseEntity hEnt = house.QueryCargoHouseByID(orderEn.HouseID);
                        //        CargoStaticBus sb = new CargoStaticBus();
                        //        CargoPushDataEntity push = new CargoPushDataEntity();
                        //        push.PushTitle = title;
                        //        push.OrderInfo = wxOrderList[0].Title;
                        //        push.TotalCharge = wxOrderList[0].TotalCharge;
                        //        push.WXOrderNo = orderEn.WXOrderNo;
                        //        push.wxOpenID = wxOrderList[0].wxOpenID;
                        //        push.TemplateID = "heDfICkOgVf3gfod4kM6CL4MiK4YikrFGm6k9QgUZ8A";
                        //        push.HouseID = orderEn.HouseID;
                        //        push.HouseName = hEnt.Name;
                        //        push.PushType = "0";
                        //        push.PushStatus = "0";
                        //        sb.AddPushData(push, log);
                        //        //WriteTextLog(orderEn.OrderNo + orderEn.WXOrderNo + "推送微信通知", DateTime.Now);
                        //        //仓库确认成功向客户微信发送推送消息
                        //        //推送客户消息
                        //        //TemplateMsg tmMsg = new TemplateMsg
                        //        //{
                        //        //    first = new TemplateDataItem(title, "#173177"),
                        //        //    keyword1 = new TemplateDataItem(wxOrderList[0].Title, "#173177"),
                        //        //    keyword2 = new TemplateDataItem(wxOrderList[0].TotalCharge.ToString("F2") + "元", "#173177"),
                        //        //    keyword3 = new TemplateDataItem(orderEn.WXOrderNo, "#173177"),
                        //        //    remark = new TemplateDataItem("点击查看物流跟踪详情!", "#173177")
                        //        //};
                        //        //SendTempleteMessage send = new SendTempleteMessage();
                        //        //string token = Common.GetWeixinToken(Common.GetdltAPPID(), Common.GetdltAppSecret());
                        //        //string errmsg = send.SendMessage(token, wxOrderList[0].wxOpenID, "heDfICkOgVf3gfod4kM6CL4MiK4YikrFGm6k9QgUZ8A", "http://dlt.neway5.com/Weixin/OrderInfo.aspx?orderNo=" + orderEn.WXOrderNo, tmMsg);
                        //        //WriteTextLog(errmsg, DateTime.Now);
                        //    }
                        //}
                        #endregion
                        #endregion
                    }
                    else
                    {
                        if (!memClient.KeyExists(OrderNo))
                        {
                            //已经出库的数量
                            int outN = 0;
                            if (!string.IsNullOrEmpty(proTag.ProductCode) && specEntity.BundleNum > 1)
                            {
                                outN = inter.GetOutCargoNumByBundle(new CargoProductTagEntity { OrderNo = OrderNo });
                            }
                            else
                            {
                                outN = inter.GetOutCargoNum(new CargoProductTagEntity { OrderNo = OrderNo });
                            }
                            if (outN < orderEn.Piece)
                            {
                                if (orderEn.AwbStatus.Equals("0") || orderEn.AwbStatus.Equals("6"))
                                {
                                    //未出库完成 加入缓存，订单状态为正在出库中
                                    order.SaveOrderStatus(new CargoOrderStatusEntity
                                    {
                                        OrderID = orderEn.OrderID,
                                        OrderNo = orderEn.OrderNo,
                                        OrderStatus = "1",
                                        WXOrderNo = orderEn.WXOrderNo,
                                        OP_ID = "2029",
                                        OP_Name = UserID,
                                        OP_DATE = DateTime.Now,
                                        DetailInfo = ""
                                    }, log);
                                }
                                memClient.Add(OrderNo, outN);
                            }
                            else
                            {
                                #region 出库完成
                                //出库完成
                                order.SaveOrderStatus(new CargoOrderStatusEntity
                                {
                                    OrderID = orderEn.OrderID,
                                    OrderNo = orderEn.OrderNo,
                                    OrderStatus = "2",
                                    WXOrderNo = orderEn.WXOrderNo,
                                    OP_ID = "2029",
                                    OP_Name = UserID,
                                    OP_DATE = DateTime.Now,
                                    DetailInfo = ""
                                }, log);

                                //如果前置仓不为0且订单号不为空，则同步更新前置仓关联订单的出库状态
                                if (!orderEn.OrignHouseID.Equals(0) && !string.IsNullOrEmpty(orderEn.OpenOrderNo))
                                {
                                    order.SaveOrderStatus(new CargoOrderStatusEntity
                                    {
                                        OrderNo = orderEn.OpenOrderNo,
                                        OrderStatus = "2",
                                        WXOrderNo = orderEn.WXOrderNo,
                                        OP_ID = "2029",
                                        OP_Name = UserID,
                                        OP_DATE = DateTime.Now,
                                        DetailInfo = "共享仓同步出库"
                                    }, log);
                                }
                                #region 推送客户通知
                                //if (!string.IsNullOrEmpty(orderEn.WXOrderNo))
                                //{
                                //    string title = string.Empty;
                                //    switch (orderEn.HouseID)
                                //    {
                                //        case 1: title = "尊敬的湖南迪乐泰客户，您的订单已出库！"; break;
                                //        case 3: title = "尊敬的湖北迪乐泰客户，您的订单已出库！"; break;
                                //        case 11: title = "尊敬的西北迪乐泰客户，您的订单已出库！"; break;
                                //        case 12: title = "尊敬的梅州迪乐泰客户，您的订单已出库！"; break;
                                //        case 9: title = "尊敬的客户，您的订单已出库！"; break;
                                //        case 34: title = "尊敬的海南迪乐泰客户，您的订单已出库！"; break;
                                //        case 46: title = "尊敬的四川迪乐泰客户，您的订单已出库！"; break;
                                //        default: break;
                                //    }
                                //    if (string.IsNullOrEmpty(title))
                                //    {
                                //        goto ERR;
                                //    }
                                //    List<WXOrderManagerEntity> wxOrderList = order.QueryWeixinOrderInfo(new WXOrderManagerEntity { OrderNo = orderEn.WXOrderNo });
                                //    if (wxOrderList.Count > 0)
                                //    {
                                //        CargoHouseBus house = new CargoHouseBus();
                                //        CargoHouseEntity hEnt = house.QueryCargoHouseByID(orderEn.HouseID);
                                //        CargoStaticBus sb = new CargoStaticBus();
                                //        CargoPushDataEntity push = new CargoPushDataEntity();
                                //        push.PushTitle = title;
                                //        push.OrderInfo = wxOrderList[0].Title;
                                //        push.TotalCharge = wxOrderList[0].TotalCharge;
                                //        push.WXOrderNo = orderEn.WXOrderNo;
                                //        push.wxOpenID = wxOrderList[0].wxOpenID;
                                //        push.TemplateID = "heDfICkOgVf3gfod4kM6CL4MiK4YikrFGm6k9QgUZ8A";
                                //        push.HouseID = orderEn.HouseID;
                                //        push.HouseName = hEnt.Name;
                                //        push.PushType = "0";
                                //        push.PushStatus = "0";
                                //        sb.AddPushData(push, log);
                                //        //WriteTextLog(orderEn.OrderNo + orderEn.WXOrderNo + "推送微信通知", DateTime.Now);
                                //        //仓库确认成功向客户微信发送推送消息
                                //        //推送客户消息
                                //        //TemplateMsg tmMsg = new TemplateMsg
                                //        //{
                                //        //    first = new TemplateDataItem(title, "#173177"),
                                //        //    keyword1 = new TemplateDataItem(wxOrderList[0].Title, "#173177"),
                                //        //    keyword2 = new TemplateDataItem(wxOrderList[0].TotalCharge.ToString("F2") + "元", "#173177"),
                                //        //    keyword3 = new TemplateDataItem(orderEn.WXOrderNo, "#173177"),
                                //        //    remark = new TemplateDataItem("点击查看物流跟踪详情!", "#173177")
                                //        //};
                                //        //SendTempleteMessage send = new SendTempleteMessage();
                                //        //string token = Common.GetWeixinToken(Common.GetdltAPPID(), Common.GetdltAppSecret());
                                //        //string errmsg = send.SendMessage(token, wxOrderList[0].wxOpenID, "heDfICkOgVf3gfod4kM6CL4MiK4YikrFGm6k9QgUZ8A", "http://dlt.neway5.com/Weixin/OrderInfo.aspx?orderNo=" + orderEn.WXOrderNo, tmMsg);
                                //        //WriteTextLog(errmsg, DateTime.Now);
                                //    }
                                //}
                                #endregion
                                memClient.Delete(OrderNo);
                                #endregion
                            }
                        }
                        else
                        {
                            //如果已经存在缓存，表示不是第一次扫描，要判断扫描出库数量与订单数量是否一致，一致则推送出库通知给客户
                            int OutNum = (int)memClient.Get(OrderNo);
                            if (specEntity.BundleNum > 1)
                            {
                                OutNum += specEntity.BundleNum;
                            }
                            else
                            {
                                OutNum++;
                            }
                            memClient.Delete(OrderNo);
                            if (OutNum.Equals(orderEn.Piece))
                            {
                                #region 出库完成
                                order.SaveOrderStatus(new CargoOrderStatusEntity
                                {
                                    OrderID = orderEn.OrderID,
                                    OrderNo = orderEn.OrderNo,
                                    OrderStatus = "2",
                                    WXOrderNo = orderEn.WXOrderNo,
                                    OP_ID = "2029",
                                    OP_Name = UserID,
                                    OP_DATE = DateTime.Now,
                                    DetailInfo = ""
                                }, log);

                                //如果前置仓不为0且订单号不为空，则同步更新前置仓关联订单的出库状态
                                if (!orderEn.OrignHouseID.Equals(0) && !string.IsNullOrEmpty(orderEn.OpenOrderNo))
                                {
                                    order.SaveOrderStatus(new CargoOrderStatusEntity
                                    {
                                        OrderNo = orderEn.OpenOrderNo,
                                        OrderStatus = "2",
                                        WXOrderNo = orderEn.WXOrderNo,
                                        OP_ID = "2029",
                                        OP_Name = UserID,
                                        OP_DATE = DateTime.Now,
                                        DetailInfo = "共享仓同步出库"
                                    }, log);
                                }
                                #region 推送客户通知
                                //if (!string.IsNullOrEmpty(orderEn.WXOrderNo))
                                //{
                                //    string title = string.Empty;
                                //    switch (orderEn.HouseID)
                                //    {
                                //        case 1: title = "尊敬的湖南迪乐泰客户，您的订单已出库！"; break;
                                //        case 3: title = "尊敬的湖北迪乐泰客户，您的订单已出库！"; break;
                                //        case 11: title = "尊敬的西北迪乐泰客户，您的订单已出库！"; break;
                                //        case 12: title = "尊敬的梅州迪乐泰客户，您的订单已出库！"; break;
                                //        case 9: title = "尊敬的客户，您的订单已出库！"; break;
                                //        case 34: title = "尊敬的海南迪乐泰客户，您的订单已出库！"; break;
                                //        case 46: title = "尊敬的四川迪乐泰客户，您的订单已出库！"; break;
                                //        default: break;
                                //    }
                                //    if (string.IsNullOrEmpty(title))
                                //    {
                                //        goto ERR;
                                //    }
                                //    List<WXOrderManagerEntity> wxOrderList = order.QueryWeixinOrderInfo(new WXOrderManagerEntity { OrderNo = orderEn.WXOrderNo });
                                //    if (wxOrderList.Count > 0)
                                //    {
                                //        CargoHouseBus house = new CargoHouseBus();
                                //        CargoHouseEntity hEnt = house.QueryCargoHouseByID(orderEn.HouseID);
                                //        CargoStaticBus sb = new CargoStaticBus();
                                //        CargoPushDataEntity push = new CargoPushDataEntity();
                                //        push.PushTitle = title;
                                //        push.OrderInfo = wxOrderList[0].Title;
                                //        push.TotalCharge = wxOrderList[0].TotalCharge;
                                //        push.WXOrderNo = orderEn.WXOrderNo;
                                //        push.wxOpenID = wxOrderList[0].wxOpenID;
                                //        push.TemplateID = "heDfICkOgVf3gfod4kM6CL4MiK4YikrFGm6k9QgUZ8A";
                                //        push.HouseID = orderEn.HouseID;
                                //        push.HouseName = hEnt.Name;
                                //        push.PushType = "0";
                                //        push.PushStatus = "0";
                                //        sb.AddPushData(push, log);
                                //        //WriteTextLog(orderEn.OrderNo + orderEn.WXOrderNo + "推送微信通知", DateTime.Now);
                                //        //仓库确认成功向客户微信发送推送消息
                                //        //推送客户消息
                                //        //TemplateMsg tmMsg = new TemplateMsg
                                //        //{
                                //        //    first = new TemplateDataItem(title, "#173177"),
                                //        //    keyword1 = new TemplateDataItem(wxOrderList[0].Title, "#173177"),
                                //        //    keyword2 = new TemplateDataItem(wxOrderList[0].TotalCharge.ToString("F2") + "元", "#173177"),
                                //        //    keyword3 = new TemplateDataItem(orderEn.WXOrderNo, "#173177"),
                                //        //    remark = new TemplateDataItem("点击查看物流跟踪详情!", "#173177")
                                //        //};
                                //        //SendTempleteMessage send = new SendTempleteMessage();
                                //        //string token = Common.GetWeixinToken(Common.GetdltAPPID(), Common.GetdltAppSecret());
                                //        //string errmsg = send.SendMessage(token, wxOrderList[0].wxOpenID, "heDfICkOgVf3gfod4kM6CL4MiK4YikrFGm6k9QgUZ8A", "http://dlt.neway5.com/Weixin/OrderInfo.aspx?orderNo=" + orderEn.WXOrderNo, tmMsg);
                                //        //WriteTextLog(errmsg, DateTime.Now);
                                //    }
                                //}
                                #endregion
                                #endregion
                            }
                            else
                            {
                                memClient.Add(OrderNo, OutNum);
                            }
                        }
                    }

                }
                catch (Exception)
                {
                    goto ERR;
                }
            }
            else
            {
                result.Message = "查询成功";
                //补打
                string TagCode = context.Request["TagCode"];//产品唯一编码标签码
                string[] tArr = TagCode.Split('=');
                if (tArr.Length > 1)
                {
                    TagCode = tArr[1];
                }
                else
                {
                    string[] gtc = TagCode.Split('|');
                    if (gtc.Length > 1)
                    {
                        TagCode = gtc[5];
                        //TagCode = tc.Substring(8, tc.Length - 8);
                    }
                }
                //这里可以拿 到ContainerID ContainerCode
                CargoProductEntity proTag = bus.QueryProductInfoByTagCode(new CargoProductTagEntity { TagCode = TagCode });
                if (proTag.ProductID.Equals(0))
                {
                    result.Result = false;
                    result.Message = "标签编码不存在";
                    goto ERR;
                }
                if (!proTag.OutCargoStatus.Equals("1"))
                {
                    result.Result = false;
                    result.Message = "该标签未出库";
                    goto ERR;
                }
                if (string.IsNullOrEmpty(proTag.OrderNo))
                {
                    result.Result = false;
                    result.Message = "该标签未出库";
                    goto ERR;
                }
                List<CargoOrderGoodsEntity> orderTag = order.QueryOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = proTag.OrderNo, ProductID = proTag.ProductID, ContainerCode = proTag.ContainerCode });

                //如果存在产品编码，根据产品编码查询捆包数量
                CargoProductSpecEntity specEntity = new CargoProductSpecEntity();

                if (!string.IsNullOrEmpty(orderTag[0].ShowProductCode))
                {
                    specEntity = bus.GetProductSpecByProductCode(orderTag[0].ShowProductCode);
                }
                else
                {
                    if (!string.IsNullOrEmpty(proTag.ProductCode))
                    {
                        specEntity = bus.GetProductSpecByProductCode(proTag.ProductCode);
                    }
                }

                //if (!string.IsNullOrEmpty(proTag.ProductCode))
                //{
                //    specEntity = bus.GetProductSpecByProductCode(proTag.ProductCode);
                //}
                //查询订单信息，修改订单状态和商城订单状态 ，推送订单状态通知
                CargoOrderEntity orderEn = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = proTag.OrderNo });
                CargoProductInfoEntity infoEntity = new CargoProductInfoEntity();
                infoEntity.ProductName = specEntity.ProductName;
                infoEntity.BrandCode = specEntity.BrandCode;
                infoEntity.TagCode = TagCode;
                infoEntity.Specs = specEntity.Specs;
                infoEntity.Figure = specEntity.Figure;
                infoEntity.GoodsCode = specEntity.GoodsCode;
                infoEntity.Model = specEntity.Model;
                infoEntity.SpeedLevel = specEntity.SpeedLevel;
                infoEntity.LoadIndex = specEntity.LoadIndex;
                infoEntity.Batch = proTag.Batch;
                infoEntity.CarModel = specEntity.CarModel;
                infoEntity.Manufacturer = specEntity.Manufacturer;
                infoEntity.ManufacturerAddress = specEntity.ManufacturerAddress;
                infoEntity.Seller = specEntity.Seller;
                infoEntity.SellerAddress = specEntity.SellerAddress;
                infoEntity.Servicer = specEntity.Servicer;
                infoEntity.ServicerAddress = specEntity.ServicerAddress;
                infoEntity.UpClientID = Convert.ToInt32(orderEn.UpClientID);
                infoEntity.UpClientShortName = orderEn.UpClientShortName;
                result.ProductTagInfo = infoEntity;
            }
        ERR:
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 查询订单出库标签信息
        /// </summary>
        /// <param name="context"></param>
        private void QueryOrderTagInfo(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();
            result.Result = true;
            CargoOrderBus order = new CargoOrderBus();
            result.Message = "查询成功";
            string OrderNo = context.Request["OrderNo"];
            //查询订单信息，修改订单状态和商城订单状态 ，推送订单状态通知
            CargoOrderEntity orderEn = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = OrderNo });
            if (orderEn.Piece.Equals(0))
            {
                result.Result = false;
                result.Message = "订单数据不存在";
                goto ERR;
            }
            result.OrderNo = OrderNo;
            result.Number = orderEn.Piece;
            result.Dep = orderEn.Dep;
            result.Dest = orderEn.Dest;

            List<CargoProductInfoEntity> cpieList = order.QueryOrderTagInfo(new CargoOrderEntity { OrderNo = OrderNo });

            result.ProductTagInfoList = cpieList;
        ERR:
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 修改物流 单号
        /// </summary>
        /// <param name="context"></param>
        private void UpdateLogisAwbNo(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();
            string OrderNo = context.Request["OrderNo"];//订单号
            string OrderAging = context.Request["OrderAging"];//订单时效
            if (string.IsNullOrEmpty(context.Request["OrderNo"]))
            {
                result.Result = false;
                result.Message = "订单号不能为空";
                goto ERR;
            }
            string logisNo = context.Request["logisNo"];//物流单号
            CargoOrderBus bus = new CargoOrderBus();
            result.Result = true;
            result.Message = "保存成功";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "修改物流单号";
            log.UserID = "HLY";//限定某一账号
            log.Operate = "U";
            log.Status = "0";
            string[] oN = OrderNo.Split('/');
            try
            {
                for (int i = 0; i < oN.Length; i++)
                {
                    if (string.IsNullOrEmpty(oN[i])) { continue; }
                    bus.UpdateLogisAwbNo(Convert.ToString(oN[i]), logisNo, string.IsNullOrEmpty(OrderAging) ? "" : OrderAging, log);
                }
            }
            catch (ApplicationException ex)
            {
                result.Result = false;
                result.Message = "物流单号修改报错";
            }


        ERR:
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 仓库内货位移动
        /// </summary>
        /// <param name="context"></param>
        private void MoveCargoContainer(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();
            string ContainerCode = context.Request["ContainerCode"];//目标货位
            int HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID
            string TagCode = context.Request["TagCode"];//产品唯一编码标签码
            Common.WriteTextLog("货位移动：" + TagCode);
            string[] tArr = TagCode.Split('=');
            if (tArr.Length > 1)
            {
                TagCode = tArr[1];
            }
            else
            {
                string[] gtc = TagCode.Split('|');
                if (gtc.Length > 1)
                {
                    TagCode = gtc[5];
                    //TagCode = tc.Substring(8, tc.Length - 8);
                }
            }
            string UserID = context.Request["UserID"];//操作人账号
            result.Result = true;
            result.Message = "移库成功";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "仓库管理";
            log.NvgPage = "扫描移库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "U";
            log.Status = "0";
            #region 验证

            if (HouseID.Equals(0))
            {
                result.Result = false;
                result.Message = "仓库ID不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(ContainerCode))
            {
                result.Result = false;
                result.Message = "目标货位不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                result.Result = false;
                result.Message = "产品编码列表不能为空";
                goto ERR;
            }
            #endregion
            List<CargoProductTagEntity> taglist = new List<CargoProductTagEntity>();
            CargoHouseBus house = new CargoHouseBus();
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoContainerEntity tagartCon = house.QueryContainerEntityByCode(ContainerCode, HouseID);
            CargoContainerShowEntity newContainer = new CargoContainerShowEntity();//目标货位实体
            newContainer.ContainerID = tagartCon.ContainerID;//新货位ID
            newContainer.ContainerCode = tagartCon.ContainerCode;//新货位代码
            newContainer.HouseID = tagartCon.HouseID;//目标仓库ID
            newContainer.AreaID = tagartCon.AreaID;//目标仓库区域ID
            newContainer.InCargoID = DateTime.Now.ToString("MMdd") + Common.GetRandomSixNum().ToString();//入库单号

            //string tagList = string.Empty;
            string[] tag = TagCode.Split('/');
            for (int i = 0; i < tag.Length; i++)
            {
                if (!string.IsNullOrEmpty(tag[i].Trim()) && !taglist.Exists(c => c.TagCode.Equals(tag[i].Trim())))
                {
                    //tagList += tag[i] + "','";
                    taglist.Add(new CargoProductTagEntity
                    {
                        TagCode = tag[i],
                        ContainerID = tagartCon.ContainerID
                    });
                }
            }
            //if (!string.IsNullOrEmpty(tagList))
            //{
            //    tagList = tagList.Substring(0, tagList.Length - 3);
            //}
            foreach (var tg in taglist)
            {
                List<CargoContainerShowEntity> oldGoods = inter.QueryOldContainerList(tg.TagCode);
                if (oldGoods.Count > 0)
                {
                    CargoContainerShowEntity it = oldGoods[0];
                    it.Piece = 1;
                    if (it.InPiece < 1)
                    {
                        result.Result = false;
                        result.Message = "在库数量少于移库数量";
                        goto ERR;
                    }
                    if (!it.HouseID.Equals(HouseID))
                    {
                        result.Result = false;
                        result.Message = "非本仓库产品";
                        goto ERR;
                    }
                    if (!string.IsNullOrEmpty(it.MoveOrderNo) && it.MoveStatus.Equals("0"))
                    {
                        result.Result = false;
                        result.Message = "该标签是移库标签请用移库入库扫描";
                        goto ERR;
                    }
                    if (it.ContainerID.Equals(newContainer.ContainerID))
                    {
                        //result.Result = false;
                        //result.Message = "仓库ID相同货位不能移库";
                        //goto ERR;
                        continue;
                    }
                    newContainer.TagCode = tg.TagCode;

                    //仓库同步缓存(缓存的旧的仓库信息)
                    CargoProductEntity syncProduct = house.SyncTypeProduct(it.ProductID.ToString());
                    //34 马牌  1 同步马牌  2 同步全部品牌
                    if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                    {
                        RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                    }
                    house.SaveMoveContainer(it, newContainer, log);

                    //List<CargoProductTagEntity> tli = new List<CargoProductTagEntity>();
                    //tli.Add(tg);
                    //inter.UpdateProductTagContainID(tli, log);
                }
            }

        ERR:
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 查询订单产品数据
        /// </summary>
        /// <param name="context"></param>
        private void QueryProductOrderTagList(HttpContext context)
        {
            string OrderNo = context.Request["OrderNo"];
            string TagCode = context.Request["TagCode"];
            CargoProductOrderEntity err = new CargoProductOrderEntity();
            err.Result = false;
            if (string.IsNullOrEmpty(OrderNo) && string.IsNullOrEmpty(TagCode))
            {
                err.Result = false;
                err.Message = "参数不误";
                goto ERROR;
            }
            CargoInterfaceBus bus = new CargoInterfaceBus();
            List<CargoProductOrderTagEntity> result = bus.QueryProductOrderTagList(new CargoProductOrderTagEntity { OrderNo = OrderNo, TagCode = TagCode });
            if (result.Count > 0)
            {
                err.Result = true;
                err.Message = "成功";
                err.OrderTag = result;
            }
        ERROR:
            //JSON
            String json = JSON.Encode(err);
            context.Response.Write(json);
        }

        /// <summary>
        /// 查询移库单数据
        /// </summary>
        /// <param name="context"></param>
        private void QueryMoveOrderData(HttpContext context)
        {
            int HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID
            CargoAPIMessage err = new CargoAPIMessage();
            err.Result = true;
            if (HouseID.Equals(0))
            {
                err.Result = false;
                err.Message = "仓库代码不能为空";
                //JSON
                String jsons = JSON.Encode(err);
                context.Response.Write(jsons);
                return;
            }
            //string MoveOrderType = Convert.ToString(context.Request["MoveOrderType"]);//0：移库单出库1：移库单入库
            CargoMoveOrderEntity cargoMoveOrder = new CargoMoveOrderEntity();
            DateTime startDate = Convert.ToDateTime(context.Request["StartDate"]);
            DateTime endDate = Convert.ToDateTime(context.Request["EndDate"]);
            cargoMoveOrder.StartDate = startDate;
            cargoMoveOrder.EndDate = endDate;
            cargoMoveOrder.OldHouseID = HouseID.ToString();
            //if (MoveOrderType.Equals("0"))
            //{
            //    cargoMoveOrder.OldHouseID = HouseID.ToString();
            //}
            //else
            //{
            //    cargoMoveOrder.NewHouseID = HouseID;
            //}
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoMoveOrderEntity> result = bus.QueryMoveOrderList(cargoMoveOrder);
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 通过移库单号查询移库单明细数据
        /// </summary>
        /// <param name="context"></param>
        private void QueryMoveOrderGoodsList(HttpContext context)
        {
            string OrderNo = context.Request["MoveNo"];//移库订单号
            string MoveStatus = context.Request["MoveStatus"];//移库类型0:出库扫描 1:入库扫描
            CargoAPIMessage err = new CargoAPIMessage();
            err.Result = true;
            if (string.IsNullOrEmpty(OrderNo))
            {
                err.Result = false;
                err.Message = "移库单号不能为空";
                //JSON
                String jsons = JSON.Encode(err);
                context.Response.Write(jsons);
                return;
            }
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoMoveOrderGoodsEntity> result = bus.QueryMoveOrderGoodsList(new CargoMoveOrderGoodsEntity { MoveNo = OrderNo, MoveStatus = MoveStatus });
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);

        }
        /// <summary>
        /// 扫描移库的标签标记
        /// </summary>
        /// <param name="context"></param>
        private void ScanMoveOrderOutOK(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();
            string OrderNo = context.Request["MoveNo"];
            //移库订单号
            //if (string.IsNullOrEmpty(context.Request["ProductID"]))
            //{
            //    result.Result = false;
            //    result.Message = "产品ID不能为空";
            //    goto ERR;
            //}
            //long ProductID = Convert.ToInt32(context.Request["ProductID"]);//仓库代码ID
            //string TagCode = context.Request["TagCode"];//产品唯一编码标签码
            //string[] tArr = TagCode.Split('=');
            //if (tArr.Length > 1)
            //{
            //    TagCode = tArr[1];
            //}
            string TagCode = context.Request["TagCode"];//产品唯一编码标签码
            string[] tArr = TagCode.Split('=');
            if (tArr.Length > 1)
            {
                TagCode = tArr[1];
            }
            else
            {
                string[] gtc = TagCode.Split('|');
                if (gtc.Length > 1)
                {
                    TagCode = gtc[5];
                    //TagCode = tc.Substring(8, tc.Length - 8);
                }
            }
            string UserID = context.Request["UserID"];//操作人账号
            CargoProductBus bus = new CargoProductBus();
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoOrderBus order = new CargoOrderBus();
            result.Result = true;
            result.Message = "保存成功";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "移库管理";
            log.NvgPage = "扫描移库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "U";
            log.Status = "0";
            #region 验证

            //if (ProductID.Equals(0))
            //{
            //    result.Result = false;
            //    result.Message = "产品ID不能为空";
            //    goto ERR;
            //}
            if (string.IsNullOrEmpty(OrderNo))
            {
                result.Result = false;
                result.Message = "移库单号不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                result.Result = false;
                result.Message = "标签编码不能为空";
                goto ERR;
            }
            if (bus.IsExistCargoProductTag(new CargoProductTagEntity { TagCode = TagCode, OutCargoStatus = "1" }))
            {
                result.Result = false;
                result.Message = "标签编码:" + TagCode + "已经出库";
                goto ERR;
            }
            //这里可以拿 到ContainerID ContainerCode
            CargoProductEntity proTag = bus.QueryProductInfoByTagCode(new CargoProductTagEntity { TagCode = TagCode });
            if (proTag.ProductID.Equals(0))
            {
                result.Result = false;
                result.Message = "标签编码不存在";
                goto ERR;
            }
            if (proTag.MoveStatus.Equals("0"))
            {
                result.Result = false;
                result.Message = "标签编码:" + TagCode + "重复扫描";
                goto ERR;
            }
            List<CargoMoveOrderGoodsEntity> orderTag = order.QueryMoveOrderGoodsList(new CargoMoveOrderGoodsEntity { MoveNo = OrderNo, ProductID = proTag.ProductID, ContainerID = proTag.ContainerID });
            if (orderTag.Count <= 0)
            {
                result.Result = false;
                result.Message = "移库单不存在该产品ID";
                goto ERR;
            }
            bool existContainerCode = false;
            foreach (var o in orderTag)
            {
                if (o.ContainerID.Equals(proTag.ContainerID))
                {
                    existContainerCode = true;
                    break;
                }
            }
            if (!existContainerCode)
            {
                result.Result = false;
                result.Message = "该标签编码不在移库列表";
                goto ERR;
            }
            if (!inter.IsSetOutMoveCargoOK(new CargoProductTagEntity { MoveOrderNo = OrderNo, ProductID = proTag.ProductID, ContainerID = proTag.ContainerID }))
            {
                result.Result = false;
                result.Message = "该移库单上的该产品已扫描完成";
                goto ERR;
            }
            #endregion

            inter.SetProductTagMove(new CargoProductTagEntity { MoveOrderNo = OrderNo, ProductID = proTag.ProductID, TagCode = TagCode, MoveStatus = "0", OutCargoStatus = "1", OutCargoTime = DateTime.Now, OutCargoOperID = UserID }, log);
            //判断移库扫描的状态
            CargoMoveOrderEntity mOrder = order.QueryMoveOrderEntity(new CargoMoveOrderEntity { MoveNo = OrderNo, MoveStatus = "0" });
            if (mOrder.ScanNum.Equals(1))
            {
                //修改移库状态为移库中
                order.UpdateMoveOrderStatus(new CargoMoveOrderEntity { MoveNo = OrderNo, MoveStatus = "3" }, log);
            }
            if (mOrder.MoveNum.Equals(mOrder.ScanNum))
            {
                //修改移库状态为全扫描
                order.UpdateMoveOrderStatus(new CargoMoveOrderEntity { MoveNo = OrderNo, MoveStatus = "1" }, log);
            }
            List<CargoMoveOrderGoodsEntity> mOrderList = order.QueryMoveOrderGoodsList(new CargoMoveOrderGoodsEntity { MoveNo = OrderNo, MoveStatus = "0" });
            result.ScanNum = mOrderList.Find(c => c.ProductID == proTag.ProductID && c.ContainerID == proTag.ContainerID).ScanNum;
            result.ContainerGoodsID = mOrderList.Find(c => c.ProductID == proTag.ProductID && c.ContainerID == proTag.ContainerID).ContainerGoodsID;
        ERR:
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 扫描移库单上的标签进行入库
        /// </summary>
        /// <param name="context"></param>
        private void ScanMoveOrderInCargo(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();

            if (string.IsNullOrEmpty(context.Request["HouseID"]))
            {
                result.Result = false;
                result.Message = "仓库代码不能为空";
                goto ERR;
            }
            int HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID

            string ContainerCode = Convert.ToString(context.Request["ContainerCode"]).Trim();//货位代码
            string TagCode = Convert.ToString(context.Request["TagCode"]).Trim();//产品唯一编码标签码
            string UserID = Convert.ToString(context.Request["UserID"]).Trim();//操作人账号

            //string TagCode = context.Request["TagCode"];//产品唯一编码标签码
            string[] tArr = TagCode.Split('=');
            if (tArr.Length > 1)
            {
                TagCode = tArr[1];
            }
            else
            {
                string[] gtc = TagCode.Split('|');
                if (gtc.Length > 1)
                {
                    TagCode = gtc[5];
                    //TagCode = tc.Substring(8, tc.Length - 8);
                }
            }

            CargoProductBus bus = new CargoProductBus();
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoHouseBus house = new CargoHouseBus();
            CargoOrderBus order = new CargoOrderBus();
            result.Result = true;
            result.Message = "保存成功";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "移库管理";
            log.NvgPage = "扫描入库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "A";
            log.Status = "0";
            #region 通用数据检验
            if (HouseID.Equals(0))
            {
                result.Result = false;
                result.Message = "仓库代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(ContainerCode))
            {
                result.Result = false;
                result.Message = "货位代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                result.Result = false;
                result.Message = "产品编码不能为空";
                goto ERR;
            }
            #endregion

            #region 验证
            CargoContainerEntity contain = house.QueryContainerEntityByCode(ContainerCode, HouseID);
            if (contain == null || contain.ContainerID.Equals(0))
            {
                result.Result = false;
                result.Message = "货位代码不存在";
                goto ERR;
            }
            CargoProductTagEntity tag = bus.QueryTagByTagCode(new CargoProductTagEntity { TagCode = TagCode });
            if (string.IsNullOrEmpty(tag.TagCode))
            {
                result.Result = false;
                result.Message = "标签编码不存在";
                goto ERR;
            }
            if (string.IsNullOrEmpty(tag.MoveOrderNo))
            {
                result.Result = false;
                result.Message = "非移库产品标签";
                goto ERR;
            }
            if (tag.OutCargoStatus.Equals("1") && !string.IsNullOrEmpty(tag.OrderNo))
            {
                result.Result = false;
                result.Message = "已出库标签,不能移库,订单号:" + tag.OrderNo;
                goto ERR;
            }
            if (string.IsNullOrEmpty(tag.MoveStatus))
            {
                result.Result = false;
                result.Message = "非移库标签，请核对:" + tag.TagCode;
                goto ERR;
            }
            if (tag.MoveStatus.Equals("1"))
            {
                result.Result = false;
                result.Message = "标签已入库，请勿重复入库";
                goto ERR;
            }
            if (contain.ContainerID.Equals(tag.ContainerID))
            {
                result.Result = false;
                result.Message = "重复扫描";
                goto ERR;
            }
            CargoMoveOrderEntity mOrderh = order.QueryMoveOrderByMoveNo(new CargoMoveOrderEntity { MoveNo = tag.MoveOrderNo });
            if (mOrderh.NewHouseID != HouseID)
            {
                result.Result = false;
                result.Message = "仓库代码与移库单号不一致";
                goto ERR;
            }
            #endregion



            //查询原仓库的产品信息
            CargoProductEntity entity = bus.QueryProductInfoByID(tag.ProductID);
            entity.OPID = UserID;
            entity.HouseID = HouseID;//目标仓库ID
            entity.ContainerCode = contain.ContainerCode;//目标货位
            entity.ContainerID = contain.ContainerID;
            entity.InCargoID = DateTime.Now.ToString("MMdd") + Common.GetRandomSixNum().ToString();
            entity.InCargoStatus = "1";
            entity.OperaType = "1";
            entity.Numbers = 1;//数量
            entity.SourceOrderNo = tag.MoveOrderNo;//移库单号
            entity.TagCode = TagCode;//标签
            entity.ParentID = tag.ContainerID;//旧货位ID


            //仓库同步缓存
            CargoProductEntity syncProduct = house.SyncTypeProduct(tag.ProductID.ToString());
            //34 马牌  1 同步马牌  2 同步全部品牌
            if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
            {
                RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
            }
            //主仓缓存更改
            if (house.IsAddCaching(syncProduct.HouseID, syncProduct.TypeID))
            {
                RedisHelper.HashSet("HCYCHouseStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
            }

            inter.ScanMoveOrderInCargo(entity, log);

            //判断移库扫描的状态
            CargoMoveOrderEntity mOrder = order.QueryMoveOrderEntity(new CargoMoveOrderEntity { MoveNo = tag.MoveOrderNo, MoveStatus = "1" });
            if (mOrder.ScanNum.Equals(1))
            {
                //修改移库状态为移库中
                order.UpdateMoveOrderStatus(new CargoMoveOrderEntity { MoveNo = tag.MoveOrderNo, MoveStatus = "4" }, log);
            }
            if (mOrder.MoveNum.Equals(mOrder.ScanNum))
            {
                //修改移库状态为全扫描
                order.UpdateMoveOrderStatus(new CargoMoveOrderEntity { MoveNo = tag.MoveOrderNo, MoveStatus = "2" }, log);
            }
            //inter.scanTagInCargo(new CargoProductEntity { ProductName = ProductName, GoodsCode = GoodsCode, HouseID = HouseID, TypeID = TypeID, Specs = Specs, Figure = Figure, Model = Model, Batch = Batch, ContainerCode = ContainerCode, TagCode = TagCode, BatchYear = bYear, BatchWeek = bWeek, InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString(), OPID = UserID, LoadIndex = Convert.ToInt32(LoadIndex), SpeedLevel = SpeedLevel, Meridian = "R", TreadWidth = TreadWidth, FlatRatio = flatRadio, HubDiameter = HubDiameter, InCargoStatus = "1", InHouseTime = DateTime.Now, OperaType = "1", Born = Born, Assort = Assort, TyreCode = TyreCode, Numbers = Convert.ToInt32(InCargoNum), ParentID = parentID, Source = Source, SourceOrderNo = SourceOrderNo, BelongMonth = BelongMonth, UnitPrice = unitPrice, FinalCostPrice = finalCostPrice, CostPrice = costPrice, TaxCostPrice = taxCostPrice, NoTaxCostPrice = noTaxCostPrice, TradePrice = tradePrice, SalePrice = salePrice }, log);
            List<CargoMoveOrderGoodsEntity> mOrderList = order.QueryMoveOrderGoodsList(new CargoMoveOrderGoodsEntity { MoveNo = tag.MoveOrderNo, MoveStatus = "1" });
            result.ScanNum = mOrderList.Find(c => c.ProductID == tag.ProductID && c.ContainerID == tag.ContainerID).NewPiece;
            result.ContainerGoodsID = mOrderList.Find(c => c.ProductID == tag.ProductID && c.ContainerID == tag.ContainerID).ContainerGoodsID;

        ERR:
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 设置标签为未出库  退回仓库
        /// </summary>
        /// <param name="context"></param>
        private void SetTagCodeUnOutCargo(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();
            string TagCode = context.Request["TagCode"];//产品唯一编码标签码
            string UserID = context.Request["UserID"];//操作人账号
            result.Result = false;
            result.Message = "暂时关闭此功能";
            goto ERR;
            result.Result = true;
            result.Message = "设置成功";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "产品管理";
            log.NvgPage = "标签管理";
            log.UserID = UserID;//限定某一账号
            log.Operate = "U";
            log.Status = "0";
            List<CargoProductTagEntity> list = new List<CargoProductTagEntity>();
            #region 验证

            if (string.IsNullOrEmpty(TagCode))
            {
                result.Result = false;
                result.Message = "产品编码列表不能为空";
                goto ERR;
            }
            #endregion
            CargoProductBus bus = new CargoProductBus();

            string[] tag = TagCode.Split('/');
            for (int i = 0; i < tag.Length; i++)
            {
                if (!string.IsNullOrEmpty(tag[i]))
                {
                    CargoProductTagEntity tagE = bus.QueryTagByTagCode(new CargoProductTagEntity { TagCode = Convert.ToString(tag[i]) });
                    if (tagE.OutCargoStatus.Equals("0"))
                    {
                        //表示未出库
                        continue;
                    }
                    list.Add(new CargoProductTagEntity { TagCode = tag[i], OutCargoStatus = "0" });
                }
            }
            bus.ScanTagUnOutCargo(list, log);
        ERR:
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 太石仓库通过品番查询库存明细
        /// </summary>
        /// <param name="context"></param>
        private void queryGtmcStock(HttpContext context)
        {
            string ContainerCode = context.Request["ContainerCode"];//货位代码
            string GoodsCode = context.Request["GoodsCode"];//品番
            int HouseID = Convert.ToInt32(context.Request["HouseID"]);//区域大仓仓库ID
            int FirstAreaID = Convert.ToInt32(context.Request["FirstAreaID"]);//二级仓库代码ID
            int ParentAreaID = Convert.ToInt32(context.Request["ParentAreaID"]);//三级仓库代码ID
            string SourceCode = context.Request["SourceCode"];//供应商代码
            List<CargoInterfaceEntity> cargoList = new List<CargoInterfaceEntity>();
            CargoAPIMessage result = new CargoAPIMessage();
            result.Result = true;
            CargoHouseBus house = new CargoHouseBus();
            CargoProductBus product = new CargoProductBus();
            result.Result = true;
            result.Message = "查询成功";
            //if (string.IsNullOrEmpty(GoodsCode))
            //{
            //    result.Result = false;
            //    result.Message = "品番不能为空";
            //}
            if (HouseID.Equals(0))
            {
                result.Result = false;
                result.Message = "仓库代码不能为空";
            }
            if (!string.IsNullOrEmpty(SourceCode))
            {
                if (SourceCode.Equals("3404B"))
                {
                    CargoGtmcProductBasicEntity gtmcB = product.QueryGtmcProductInfo(new CargoGtmcProductBasicEntity { SupplierPinfan = GoodsCode });
                    GoodsCode = gtmcB.GtmcPinfan;
                }

            }
            if (result.Result)
            {
                CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
                queryEntity.HouseID = HouseID;
                queryEntity.FirstAreaID = FirstAreaID;
                queryEntity.GoodsCode = GoodsCode;
                queryEntity.ContainerCode = ContainerCode;
                queryEntity.ParentAreaID = ParentAreaID;
                List<CargoContainerShowEntity> list = house.QueryALLHouseData(queryEntity);
                if (list.Count > 0)
                {
                    foreach (var it in list)
                    {
                        cargoList.Add(new CargoInterfaceEntity
                        {
                            ContainerGoodsID = it.ID,
                            ContainerID = it.ContainerID,
                            ProductID = it.ProductID,
                            ContainerCode = it.ContainerCode,
                            GoodsCode = it.GoodsCode,
                            Specs = it.Specs,
                            StockNum = it.Piece,
                            AreaName = it.AreaName,
                            TypeID = it.TypeID,
                            TypeName = it.TypeName,
                            InHouseTime = it.InHouseTime,
                            Batch = it.Batch
                        });
                    }
                }
                result.cargoList = cargoList;
            }

            //JSON
            String json = JSON.EncodeDateTime(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 保存移库单
        /// </summary>
        /// <param name="context"></param>
        private void saveGtmcMoveOrder(HttpContext context)
        {
            String orderData = context.Request["OrderList"];
            CargoAPIMessage result = new CargoAPIMessage();
            result.Result = true;
            result.Message = "保存成功";
            if (string.IsNullOrEmpty(orderData))
            {
                result.Result = false;
                result.Message = "移库单数据为空";
                //context.Response.Write(JSON.Encode(result));
                goto ErrEND;
            }

            CargoMoveOrderEntity ent = new CargoMoveOrderEntity();
            List<CargoMoveOrderGoodsEntity> entDest = new List<CargoMoveOrderGoodsEntity>();
            CargoHouseBus house = new CargoHouseBus();
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "移库订单";
            //log.UserID = "";//限定某一账号
            log.Operate = "A";
            log.Status = "0";
            ArrayList rows = (ArrayList)JSON.Decode(orderData);
            foreach (Hashtable row in rows)
            {
                log.UserID = Convert.ToString(row["UserID"]);
                if (string.IsNullOrEmpty(Convert.ToString(row["HouseID"])))
                {
                    result.Result = false;
                    result.Message = "仓库代码不能为空";
                    goto ErrEND;
                }
                CargoHouseEntity houEnt = house.QueryCargoHouseByID(Convert.ToInt32(row["HouseID"]));
                if (houEnt == null && string.IsNullOrEmpty(houEnt.HouseCode))
                {
                    result.Result = false;
                    result.Message = "仓库代码不存在";
                    goto ErrEND;
                }

                ent.MoveNo = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumInt().ToString(); //生成最新顺序订单号
                ent.MoveNum = Convert.ToInt32(row["MoveNum"]); //移库数量
                ent.MoveStatus = "0";
                ent.OldHouseID = Convert.ToString(row["HouseID"]);
                ent.OldHouseName = houEnt.Name;//原仓库
                ent.NewHouseID = Convert.ToInt32(row["HouseID"]);
                ent.NewHouseName = houEnt.Name;//原仓库
                ent.Memo = Convert.ToString(row["Memo"]);
                ent.OPID = Convert.ToString(row["UserID"]);
                ent.IsSaveIncomming = "0";
                //2.处理订单与产品关联数据，查库存
                ArrayList goods = (ArrayList)row["Goods"];
                List<CargoInterfaceEntity> goodList = new List<CargoInterfaceEntity>();
                for (int i = 0; i < goods.Count; i++)
                {
                    Hashtable ht = (Hashtable)goods[i];
                    //如果件数为空或为0则忽略处理
                    if (string.IsNullOrEmpty(Convert.ToString(ht["Piece"])))
                    {
                        continue;
                    }
                    if (Convert.ToInt32(ht["Piece"]).Equals(0))
                    {
                        continue;
                    }
                    CargoContainerGoodsEntity cont = house.QueryCargoContainerGoods(new CargoContainerGoodsEntity { ID = Convert.ToInt64(ht["ContainerGoodsID"]) });

                    #region 订单详情
                    entDest.Add(new CargoMoveOrderGoodsEntity
                    {
                        MoveNo = ent.MoveNo,
                        ProductID = Convert.ToInt64(ht["ProductID"]),
                        ContainerGoodsID = Convert.ToInt64(ht["ContainerGoodsID"]),
                        ContainerID = Convert.ToInt32(ht["ContainerID"]),
                        Piece = Convert.ToInt32(ht["Piece"]),
                        OPID = ent.OPID
                    });

                    //仓库同步缓存
                    CargoProductEntity syncProduct = house.SyncTypeProduct(Convert.ToString(ht["ProductID"]));
                    //34 马牌  1 同步马牌  2 同步全部品牌
                    if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                    {
                        RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                    }
                    #endregion

                }

            }
            ent.MoveGoodsList = entDest;
            bus.AddMoveOrderData(ent, log);

        ErrEND:
            String errjson = JSON.Encode(result);
            context.Response.Write(errjson);
        }
        /// <summary>
        /// 根据纳入番号查询广丰订单数据
        /// </summary>
        /// <param name="context"></param>
        private void QueryGTMCOrderByNo(HttpContext context)
        {

            List<CargoInterfaceEntity> cargoList = new List<CargoInterfaceEntity>();
            CargoAPIMessage result = new CargoAPIMessage();
            result.Result = true;
            CargoHouseBus house = new CargoHouseBus();
            CargoProductBus product = new CargoProductBus();
            result.Result = true;
            result.Message = "查询成功";
            string TakeNo = context.Request["TakeNo"];//纳入番号
            CargoGtmcProOrderEntity queryEntity = new CargoGtmcProOrderEntity();

            if (string.IsNullOrEmpty(TakeNo))
            {
                result.Result = false;
                result.Message = "纳入番号不能为空";
                context.Response.Write(JSON.Encode(result));
                return;
            }
            queryEntity.TakeNo = TakeNo;
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            CargoGtmcProOrderEntity gtmcOrder = bus.QueryGtmcProOrderEntity(queryEntity);
            if (gtmcOrder.TID.Equals(0))
            {
                result.Result = false;
                result.Message = "订单数据不存在";
                context.Response.Write(JSON.Encode(result));
                return;
            }
            //查询库存
            foreach (var o in gtmcOrder.orderDetail)
            {
                CargoInterfaceEntity qEntity = new CargoInterfaceEntity
                {
                    ProductName = "",
                    HouseID = gtmcOrder.HouseID,
                    GoodsCode = o.GoodsCode,
                    TypeID = o.TypeID,
                    Model = "",
                    Specs = "",// o.Specs,
                    Batch = "",
                    BatckWeek = 0,
                    ParentID = 354,
                    Figure = ""
                };
                int tn = inter.queryCargoStock(qEntity).Sum(c => c.StockNum);
                o.Stock = inter.queryCargoStock(qEntity).Where(c => c.IsAddOrder.Equals("0")).Sum(c => c.StockNum);
                o.NoStock = tn - o.Stock;
            }
            result.CargoGtmcProOrderEntity = gtmcOrder;
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 保存广丰订单数据生成系统出库单
        /// </summary>
        /// <param name="context"></param>
        private void SaveGTMCImportData(HttpContext context)
        {
            CargoAPIMessage msg = new CargoAPIMessage();
            msg.Result = true;
            msg.Message = "保存成功";
            CargoOrderBus bus = new CargoOrderBus();
            CargoFactoryOrderBus factbus = new CargoFactoryOrderBus();
            string UserID = Convert.ToString(context.Request["UserID"]);
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "PDA接口";
            log.Status = "0";
            log.NvgPage = "PDA生成订单";
            log.UserID = UserID;
            log.Operate = "A";
            //string TID = Convert.ToString(context.Request["TID"]);
            string TakeNo = Convert.ToString(context.Request["TakeNo"]);
            //if (String.IsNullOrEmpty(TID)) return;

            if (string.IsNullOrEmpty(TakeNo))
            {
                msg.Result = false;
                msg.Message = "纳入番号参数为空";
                //context.Response.Write(JSON.Encode(result));
                goto ErrEND;
            }
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoGtmcProOrderEntity gtmcOrder = factbus.QueryGtmcProOrderEntity(new CargoGtmcProOrderEntity { TakeNo = TakeNo });
            if (!string.IsNullOrEmpty(gtmcOrder.OrderNo))
            {
                msg.Result = false;
                msg.Message = "该订单已开单，请刷新后保存";
                goto ErrEND;
            }
            List<CargoGtmcProOrderDetailEntity> list = gtmcOrder.orderDetail;

            //生成系统订单
            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            List<QyOrderUpdateGoodsEntity> goods = new List<QyOrderUpdateGoodsEntity>();
            int HouseID = gtmcOrder.HouseID;
            try
            {
                if (msg.Result)
                {
                    #region 赋值
                    ent.HAwbNo = gtmcOrder.GtmcNo;//关联订单号
                    ent.LogisAwbNo = gtmcOrder.TakeNo;
                    if (HouseID.Equals(62))
                    {
                        //太石仓库特殊处理
                        ent.Dest = ent.Dep = "南沙";
                    }
                    ent.Piece = 0;
                    ent.Weight = ent.Volume = ent.InsuranceFee = ent.TransitFee = ent.TransportFee = ent.DeliveryFee = ent.OtherFee = ent.TotalCharge = ent.Rebate = 0;
                    ent.HouseID = HouseID;
                    ent.CheckOutType = "";
                    ent.TrafficType = "0";// 内部订单
                    ent.DeliveryType = "0";//Convert.ToString(Request["DeliveryType"]);
                    ent.AcceptAddress = "广丰生产公司";
                    ent.AcceptPeople = "丰通物流";
                    ent.AcceptUnit = "丰通物流";
                    ent.AcceptTelephone = "";
                    ent.AcceptCellphone = "";
                    ent.ShopCode = "";
                    ent.CreateAwb = UserID;
                    ent.CreateAwbID = "";
                    ent.CreateDate = DateTime.Now;// Convert.ToDateTime(Request["CreateDate"]);
                    ent.OP_ID = UserID;
                    ent.ThrowGood = "0";
                    ent.IsPrintPrice = 0;
                    ent.TranHouse = "";
                    ent.PostponeShip = "0";
                    ent.LogisID = 0;
                    ent.ClientNum = ent.PayClientNum = 783644;
                    ent.PayClientName = "丰通物流";
                    ent.DeliverySettlement = null;
                    int OrderNum = 0;
                    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, "GF", out OrderNum); // Convert.ToString(Request["OrderNo"]);//生成最新顺序订单号
                    ent.OrderNum = OrderNum;//最新订单顺序号

                    #endregion
                    int pieceSum = 0;
                    string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                    string oS = "1";
                    foreach (var o in list)
                    {
                        int piece = o.Piece;
                        CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                        {
                            ProductName = "",
                            HouseID = HouseID,
                            GoodsCode = o.GoodsCode,
                            TypeID = o.TypeID,
                            Model = "",
                            Specs = "",//o.Specs,
                            Batch = "",
                            BatckWeek = 0,
                            ParentID = 354,
                            Figure = ""
                        };
                        List<CargoInterfaceEntity> stockList = inter.queryCargoStock(queryEntity).Where(c => c.IsAddOrder.Equals("0")).ToList();
                        List<CargoInterfaceEntity> NostockList = inter.queryCargoStock(queryEntity).Where(c => c.IsAddOrder != "0").ToList();
                        if (stockList.Count <= 0)
                        {
                            oS = "2";
                            //continue;
                            msg.Result = false;
                            msg.Message = "公司代码：" + o.SourceCode + "，品番：" + o.GoodsCode + "，背番：" + o.Specs + "出库仓库存为空";
                            goto ErrEND;
                        }
                        if (stockList.Sum(c => c.StockNum) < piece)
                        {
                            oS = "2";
                            //continue;
                            msg.Result = false;
                            msg.Message = "公司代码：" + o.SourceCode + "，品番：" + o.GoodsCode + "，背番：" + o.Specs + "出库仓库存为：" + stockList.Sum(c => c.StockNum).ToString();
                            goto ErrEND;
                        }
                        //减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                        foreach (var it in stockList)
                        {
                            if (it.StockNum <= 0) { continue; }
                            if (NostockList.Exists(c => Convert.ToInt32(c.Batch) < Convert.ToInt32(it.Batch)))
                            {
                                msg.Result = false;
                                msg.Message = "存储区有更早周期产品，请优先出库";
                                break;
                            }
                            CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                            cargo.OrderNo = ent.OrderNo;//订单号
                            cargo.OutCargoID = outID;
                            cargo.ContainerID = it.ContainerID;
                            cargo.TypeID = it.TypeID;
                            cargo.ProductID = it.ProductID;

                            cargo.ID = it.ContainerGoodsID;//库存表ID

                            cargo.HouseName = "生产物流仓库";
                            cargo.ProductName = it.ProductName;
                            cargo.Model = it.Model;
                            cargo.Specs = it.Specs;
                            cargo.Figure = it.Figure;
                            #region 减库存逻辑
                            if (piece < it.StockNum)
                            {
                                //部分出
                                entDest.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    ProductID = it.ProductID,
                                    HouseID = ent.HouseID,
                                    AreaID = it.AreaID,
                                    Piece = piece,
                                    ActSalePrice = 0,
                                    ContainerCode = it.ContainerCode,
                                    OutCargoID = outID,
                                    OP_ID = log.UserID
                                });
                                cargo.Piece = piece;
                                cargo.InPiece = it.StockNum;

                                outHouseList.Add(cargo);
                                pieceSum += cargo.Piece;
                                break;
                            }
                            if (piece.Equals(it.StockNum))
                            {
                                //要出库件数和第一条库存件数刚刚好，则就全部出
                                entDest.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    ProductID = it.ProductID,
                                    HouseID = ent.HouseID,
                                    AreaID = it.AreaID,
                                    Piece = piece,
                                    ActSalePrice = 0,
                                    ContainerCode = it.ContainerCode,
                                    OutCargoID = outID,
                                    OP_ID = log.UserID
                                });
                                cargo.Piece = piece;
                                cargo.InPiece = it.StockNum;

                                outHouseList.Add(cargo);
                                pieceSum += cargo.Piece;
                                break;
                            }
                            if (piece > it.StockNum)
                            {
                                //全部出
                                entDest.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    ProductID = it.ProductID,
                                    HouseID = ent.HouseID,
                                    AreaID = it.AreaID,
                                    Piece = it.StockNum,
                                    ActSalePrice = 0,
                                    ContainerCode = it.ContainerCode,
                                    OutCargoID = outID,
                                    OP_ID = log.UserID
                                });
                                cargo.Piece = it.StockNum;
                                cargo.InPiece = it.StockNum;

                                outHouseList.Add(cargo);
                                pieceSum += cargo.Piece;
                                piece = piece - it.StockNum;
                                continue;
                            }
                            #endregion
                        }
                    }
                    ent.Piece = pieceSum;
                    ent.OutHouseName = "生产物流仓库";
                    ent.TransportFee = 0;
                    ent.TotalCharge = 0;
                    ent.AwbStatus = "0";
                    ent.OrderType = "0";
                    ent.HouseID = HouseID;
                    ent.HouseName = "生产物流仓库";
                    ent.goodsList = entDest;
                    ent.ModifyPriceStatus = "0";
                    if (outHouseList.Count <= 0)
                    {
                        msg.Message = "订单库存不足"; msg.Result = false;
                    }
                    if (msg.Result)
                    {
                        if (pieceSum < gtmcOrder.Piece)
                        {
                            oS = "2";
                            msg.Result = false;
                            msg.Message = "缺货订单，请查找库存或移库";
                            goto ErrEND;

                        }

                        //仓库同步缓存
                        CargoHouseBus house = new CargoHouseBus();
                        foreach (CargoContainerShowEntity time in outHouseList)
                        {
                            CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                            //34 马牌  1 同步马牌  2 同步全部品牌
                            if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                            {
                                RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                            }
                        }

                        bus.AddOrderInfo(ent, outHouseList, log);

                        gtmcOrder.OrderNo = ent.OrderNo;
                        gtmcOrder.OrderStatus = oS;
                        factbus.UpdateGtmcProOrderStatus(gtmcOrder);
                        //推送好来运系统
                        bus.InsertCargoOrderPush(new CargoOrderPushEntity
                        {
                            OrderNo = ent.OrderNo,
                            Dep = ent.Dep,
                            Dest = ent.Dest,
                            Piece = ent.Piece,
                            TransportFee = ent.TransportFee,
                            ClientNum = ent.ClientNum.ToString(),
                            AcceptAddress = ent.AcceptAddress,
                            AcceptCellphone = ent.AcceptCellphone,
                            AcceptTelephone = ent.AcceptTelephone,
                            AcceptPeople = ent.AcceptPeople,
                            AcceptUnit = ent.AcceptUnit,
                            HouseID = ent.HouseID.ToString(),
                            HouseName = ent.OutHouseName,
                            OP_ID = UserID,
                            PushType = "0",
                            PushStatus = "0",
                            LogisID = ent.LogisID
                        }, log);
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }

        ErrEND:
            String errjson = JSON.Encode(msg);
            context.Response.Write(errjson);

        }
        public bool IsReusable
        {
            get
            {
                return false;
            }
        }
        /// <summary>
        /// 查询盘点数据列表
        /// </summary>
        private void QueryCargoStockTakeList(HttpContext context)
        {
            CargoHouseBus bus = new CargoHouseBus();
            string HouseCode = context.Request["HouseCode"];//仓库代码ID
            CargoAPIMessage msg = new CargoAPIMessage();
            msg.Result = true;
            if (string.IsNullOrEmpty(HouseCode))
            {
                msg.Result = false;
                msg.Message = "仓库代码不能为空";
                //JSON
                String jsons = JSON.Encode(msg);
                context.Response.Write(jsons);
                return;
            }
            CargoHouseEntity houseEntity = bus.QueryCargoHouse(new CargoHouseEntity { HouseCode = HouseCode });
            if (houseEntity.HouseID.Equals(0))
            {
                msg.Result = false;
                msg.Message = "仓库代码不存在";
                //JSON
                String jsons = JSON.Encode(msg);
                context.Response.Write(jsons);
                return;
            }

            CargoStockTakeEntity entity = new CargoStockTakeEntity();
            entity.TakeStatus = Convert.ToString(context.Request["TakeStatus"]);//盘点状态 0：未盘点1：盘点中2：盘点完成
            entity.HouseID = houseEntity.HouseID;//仓库代码ID
            entity.StartDate = string.IsNullOrEmpty(Convert.ToString(context.Request["StartDate"])) ? DateTime.Now.AddDays(-1) : Convert.ToDateTime(context.Request["StartDate"]);
            entity.EndDate = string.IsNullOrEmpty(Convert.ToString(context.Request["EndDate"])) ? DateTime.Now : Convert.ToDateTime(context.Request["EndDate"]);
            List<CargoStockTakeEntity> order = bus.QueryCargoStockTakeList(entity);
            //JSON
            String json = JSON.Encode(order);
            context.Response.Write(json);
        }
        /// <summary>
        /// 根据盘点单号查询该盘点单下的所有货位
        /// </summary>
        /// <param name="context"></param>
        private void QueryCargoStockTakeContainerList(HttpContext context)
        {
            CargoHouseBus bus = new CargoHouseBus();
            CargoAPIMessage msg = new CargoAPIMessage();
            msg.Result = true;

            CargoStockTakeContainerEntity queryEntity = new CargoStockTakeContainerEntity();

            queryEntity.StockID = Convert.ToInt32(context.Request["StockID"]);
            List<CargoStockTakeContainerEntity> order = bus.QueryCargoStockTakeContainerList(queryEntity);
            //JSON
            String json = JSON.Encode(order);
            context.Response.Write(json);
        }

        /// <summary>
        /// 通过盘点单号，货位代码查询标签数据列表
        /// </summary>
        private void QueryCargoStockTagList(HttpContext context)
        {
            string HouseCode = context.Request["HouseCode"];//仓库代码ID
            CargoAPIMessage msg = new CargoAPIMessage();
            msg.Result = true;
            if (string.IsNullOrEmpty(HouseCode))
            {
                msg.Result = false;
                msg.Message = "仓库代码不能为空";
                //JSON
                String jsons = JSON.Encode(msg);
                context.Response.Write(jsons);
                return;
            }

            CargoStockTakeTagEntity entity = new CargoStockTakeTagEntity();
            entity.ContainerCode = Convert.ToString(context.Request["ContainerCode"]);//货位代码
            //entity.HouseID = wxUser.HouseID;
            entity.StockID = Convert.ToInt32(context.Request["StockID"]);
            CargoHouseBus bus = new CargoHouseBus();
            CargoHouseEntity houseEntity = bus.QueryCargoHouse(new CargoHouseEntity { HouseCode = HouseCode });
            if (houseEntity.HouseID.Equals(0))
            {
                msg.Result = false;
                msg.Message = "仓库代码不存在";
                //JSON
                String jsons = JSON.Encode(msg);
                context.Response.Write(jsons);
                return;
            }
            if (!bus.IsExistCargoContainerCode(new CargoContainerEntity { HouseID = houseEntity.HouseID, ContainerCode = entity.ContainerCode }))
            {
                msg.Message = "货位代码不存在";
                msg.Result = false;
                //JSON
                String jsons = JSON.Encode(msg);
                context.Response.Write(jsons);
                return;
            }
            CargoStockTakeContainerEntity stcon = bus.QueryStockTakeContainerCode(new CargoStockTakeContainerEntity { StockID = entity.StockID, ContainerCode = entity.ContainerCode });
            if (stcon == null || stcon.StockID.Equals(0))
            {
                msg.Message = "非盘点单下的货位";
                msg.Result = false;
                //JSON
                String jsons = JSON.Encode(msg);
                context.Response.Write(jsons);
                return;
            }
            if (stcon.StockStatus.Equals("1"))
            {
                msg.Message = "货位已盘点";
                msg.Result = false;
                //JSON
                String jsons = JSON.Encode(msg);
                context.Response.Write(jsons);
                return;
            }
            try
            {
                List<CargoStockTakeTagEntity> order = bus.QueryCargoStockTagList(entity);
                //JSON
                String jsons = JSON.Encode(order);
                context.Response.Write(jsons);
            }
            catch (ApplicationException ex)
            {

                msg.Message = "查询错误" + ex.Message;
                msg.Result = false;
                //JSON
                String jsons = JSON.Encode(msg);
                context.Response.Write(jsons);
            }

        }

        /// <summary>
        /// 修改盘点货位的提交状态
        /// </summary>
        /// <param name="entity"></param>
        private void UpdateStockTakeStatus(HttpContext context)
        {
            string StockID = context.Request["StockID"];//盘点单ID
            string ContainerCode = context.Request["ContainerCode"];//货位代码
            CargoAPIMessage msg = new CargoAPIMessage();
            msg.Result = true;
            if (string.IsNullOrEmpty(StockID))
            {
                msg.Result = false;
                msg.Message = "盘点单号不能为空";
                goto ERR;
            }
            if (StockID.Equals("0"))
            {
                msg.Result = false;
                msg.Message = "盘点单号有误";
                goto ERR;
            }

            if (string.IsNullOrEmpty(ContainerCode))
            {
                msg.Result = false;
                msg.Message = "货位代码不能为空";
                goto ERR;
            }
            string StockStatus = "1";// Request["StockStatus"];//盘点完成提交状态
            string UserID = context.Request["UserID"];//操作人账号
            CargoHouseBus bus = new CargoHouseBus();

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "盘点管理";
            log.NvgPage = "提交货位盘点";
            log.UserID = UserID;//限定某一账号
            log.Operate = "U";
            log.Status = "0";


            try
            {
                bus.UpdateStockTakeStatus(new CargoStockTakeContainerEntity { StockID = Convert.ToInt32(StockID), ContainerCode = ContainerCode, StockStatus = StockStatus }, log);
                msg.Result = true;
                msg.Message = "盘点成功";
            }
            catch (ApplicationException ex)
            {
                msg.Result = false;
                msg.Message = "盘点提交失败" + ex.Message;
            }
        ERR:
            //JSON
            String json = JSON.Encode(msg);
            context.Response.Write(json);
        }
        /// <summary>
        /// 保存盘点标签扫描状态数据
        /// </summary>
        private void SaveStockTakeTagScan(HttpContext context)
        {
            CargoAPIMessage msg = new CargoAPIMessage();
            msg.Result = true;

            string StockID = context.Request["StockID"];//盘点单ID
            string ContainerCode = context.Request["ContainerCode"];//货位代码
            string TagCode = context.Request["TagCode"];//扫描的标签号码
            string UserID = context.Request["UserID"];//操作人账号
            CargoHouseBus bus = new CargoHouseBus();
            CargoProductBus proBus = new CargoProductBus();

            //string TagCode = context.Request["TagCode"];//产品唯一编码标签码
            string[] tArr = TagCode.Split('=');
            if (tArr.Length > 1)
            {
                TagCode = tArr[1];
            }
            else
            {
                string[] gtc = TagCode.Split('|');
                if (gtc.Length > 1)
                {
                    TagCode = gtc[5];
                    //TagCode = tc.Substring(8, tc.Length - 8);
                }
            }

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "盘点管理";
            log.NvgPage = "提交标签扫描";
            log.UserID = UserID;//限定某一账号
            log.Operate = "U";
            log.Status = "0";

            if (string.IsNullOrEmpty(StockID))
            {
                msg.Result = false;
                msg.Message = "盘点单号不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(ContainerCode))
            {
                msg.Result = false;
                msg.Message = "货位代码不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(TagCode))
            {
                msg.Result = false;
                msg.Message = "标签号码不能为空";
                goto ERR;
            }
            CargoStockTakeEntity stockTakeEntity = bus.QueryStockTake(new CargoStockTakeEntity { StockID = Convert.ToInt32(StockID) });
            CargoContainerEntity containerEntity = bus.QueryContainerEntity(new CargoContainerEntity { ContainerCode = ContainerCode, HouseID = stockTakeEntity.HouseID });
            if (containerEntity == null || containerEntity.ContainerID.Equals(0))
            {
                msg.Result = false;
                msg.Message = "货位代码不存在";
                goto ERR;
            }
            CargoStockTakeTagEntity tagEntity = new CargoStockTakeTagEntity();
            tagEntity.TagCode = TagCode;
            tagEntity.ContainerCode = ContainerCode;
            tagEntity.StockID = Convert.ToInt32(StockID);
            tagEntity.ProductID = 0;
            tagEntity.ScanStatus = "1";
            tagEntity.ContainerID = containerEntity.ContainerID;//获取到的ContainerID
            tagEntity.ScanLoginName = UserID;
            tagEntity.ScanUserName = UserID;
            tagEntity.ScanDate = DateTime.Now;
            tagEntity.StockStatus = "1";

            CargoProductTagEntity tag = proBus.QueryTagByTagCode(new CargoProductTagEntity { TagCode = TagCode });
            tagEntity.ScanContainerID = containerEntity.ContainerID;//获取到的ContainerID
            if (tag == null || string.IsNullOrEmpty(tag.TagCode))
            {
                tagEntity.StockStatus = "3";
                tagEntity.Remark = "标签：" + TagCode + "不存在";
                bus.AddStockTakeTag(tagEntity, log);
                //扫描到的标签不存在系统中，说明没有入库
                msg.Result = false;
                msg.Message = "标签：" + TagCode + "不存在";
                msg.VoiceContent = "标签不存在";
                goto ERR;
            }
            tagEntity.ProductID = tag.ProductID;
            if (tag.OutCargoStatus.Equals("1"))
            {
                tagEntity.StockStatus = "2";
                tagEntity.Remark = "标签：" + TagCode + "已出库";
                bus.AddStockTakeTag(tagEntity, log);
                msg.Result = false;
                msg.Message = "标签：" + TagCode + "已出库";
                msg.VoiceContent = "已出库";
                goto ERR;
            }
            if (!string.IsNullOrEmpty(tag.MoveOrderNo) && tag.MoveStatus.Equals("0"))
            {
                tagEntity.StockStatus = "6";
                tagEntity.Remark = "标签在移库单上，" + tag.MoveOrderNo;
                bus.AddStockTakeTag(tagEntity, log);
                msg.Result = false;
                msg.Message = "标签：" + TagCode + "已出库";
                msg.VoiceContent = "已出库";
                goto ERR;
            }
            if (!tag.ContainerID.Equals(containerEntity.ContainerID))
            {
                tagEntity.StockStatus = "4";
                tagEntity.Remark = "标签：" + TagCode + "不在此货位，在：" + tag.ContainerCode;
                //tagEntity.OldContainerID = Convert.ToInt32(tag.ContainerID);
                bus.AddStockTakeTag(tagEntity, log);
                //扫描到的标签不在盘点的货位
                msg.Result = false;
                msg.Message = "标签：" + TagCode + "不在此货位，在：" + tag.ContainerCode;
                msg.VoiceContent = "错位";
                goto ERR;
            }
            CargoStockTakeTagEntity takeTag = bus.QueryStockTakeTagEntity(new CargoStockTakeTagEntity { TagCode = TagCode, StockID = tagEntity.StockID });
            if (takeTag == null || string.IsNullOrEmpty(takeTag.TagCode))
            {
                tagEntity.StockStatus = "5";
                tagEntity.Remark = "标签：" + TagCode + "不在此盘点单";
                bus.AddStockTakeTag(tagEntity, log);
                //非盘点单上的标签
                msg.Result = false;
                msg.Message = "标签：" + TagCode + "不在此盘点单";
                goto ERR;
            }
            if (takeTag.ScanStatus.Equals("1"))
            {
                msg.Result = false;
                msg.Message = "标签：" + TagCode + "已盘点扫描";
                msg.VoiceContent = "已盘点";
                goto ERR;
            }

            try
            {
                bus.AddStockTakeTag(tagEntity, log);
                msg.Result = true;
                msg.Message = "扫描成功";
                msg.VoiceContent = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Result = false;
                msg.Message = "扫描失败" + ex.Message;
            }
        ERR:
            //JSON
            String json = JSON.Encode(msg);
            context.Response.Write(json);

        }
        private void QueryPickPlanOrderLists(HttpContext context)
        {
            int HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID
            string PickPlanNo = Convert.ToString(context.Request["PickPlanNo"]);
            CargoAPIMessage err = new CargoAPIMessage();
            err.Result = true;
            if (HouseID.Equals(0))
            {
                err.Result = false;
                err.Message = "仓库代码不能为空";
                //JSON
                String jsons = JSON.Encode(err);
                context.Response.Write(jsons);
                return;
            }
            DateTime startDate = Convert.ToDateTime(context.Request["StartDate"]);
            DateTime endDate = Convert.ToDateTime(context.Request["EndDate"]);
            if ((startDate.ToString("yyyy-MM-dd") == "0001-01-01" || startDate.ToString("yyyy-MM-dd") == "1900-01-01"))
            {
                startDate = DateTime.Now.AddDays(-30).Date;
            }
            if ((endDate.ToString("yyyy-MM-dd") == "0001-01-01" || endDate.ToString("yyyy-MM-dd") == "1900-01-01"))
            {
                endDate = DateTime.Now.Date;
            }

            CargoOrderBus bus = new CargoOrderBus();
            List<CargoOrderPickPlanEntity> result = bus.QueryOrderPickPlanList(new CargoOrderPickPlanEntity { HouseID = Convert.ToString(HouseID), StartDate = startDate, EndDate = endDate, PickPlanNo = PickPlanNo });
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 查询拣货计划数据
        /// </summary>
        /// <param name="context"></param>
        private void QueryPickPlanOrderData(HttpContext context)
        {
            string PickPlanNo = Convert.ToString(context.Request["PickPlanNo"]);
            CargoAPIMessage err = new CargoAPIMessage();
            err.Result = true;
            if (string.IsNullOrEmpty(PickPlanNo))
            {
                err.Result = false;
                err.Message = "拣货单号不能为空";
                //JSON
                String jsons = JSON.Encode(err);
                context.Response.Write(jsons);
                return;
            }
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoOrderPickPlanGoodsEntity> result = bus.GetOrderPickPlanGoodsList(PickPlanNo);
            List<CargoOrderPickPlanGoodsEntity> _PickPlanGoodsList = new List<CargoOrderPickPlanGoodsEntity>();
            List<CargoOrderPickPlanGoodsEntity> _AcceptUnitGoodsList = new List<CargoOrderPickPlanGoodsEntity>();
            foreach (var PickPlanGoodsList in result)
            {

                var GoodsList = _PickPlanGoodsList.Where(x => x.AcceptUnit == PickPlanGoodsList.AcceptUnit && x.GoodsCode == PickPlanGoodsList.GoodsCode);
                if (GoodsList.Count().Equals(0))
                {
                    _PickPlanGoodsList.Add(new CargoOrderPickPlanGoodsEntity
                    {
                        PickGoodsID = PickPlanGoodsList.PickGoodsID,
                        PickPlanNo = PickPlanGoodsList.PickPlanNo,
                        ProductID = PickPlanGoodsList.ProductID,
                        ProductName = PickPlanGoodsList.ProductName,
                        OrderNo = PickPlanGoodsList.OrderNo,
                        HouseID = PickPlanGoodsList.HouseID,
                        AreaID = PickPlanGoodsList.AreaID,
                        ContainerCode = PickPlanGoodsList.ContainerCode,
                        GoodsCode = PickPlanGoodsList.GoodsCode,
                        Piece = PickPlanGoodsList.Piece,
                        ScanPiece = PickPlanGoodsList.ScanPiece,
                        LogisAwbNo = PickPlanGoodsList.LogisAwbNo,
                        Dep = PickPlanGoodsList.Dep,
                        Dest = PickPlanGoodsList.Dest,
                        ScanStatus = PickPlanGoodsList.ScanStatus,
                        AcceptUnit = PickPlanGoodsList.AcceptUnit,
                        AcceptAddress = PickPlanGoodsList.AcceptAddress,
                        AcceptPeople = PickPlanGoodsList.AcceptPeople,
                        AcceptTelephone = PickPlanGoodsList.AcceptTelephone,
                        AcceptCellphone = PickPlanGoodsList.AcceptCellphone,
                        PitNum = PickPlanGoodsList.PitNum,
                    });
                }
                else
                {
                    _PickPlanGoodsList.Where(x => x.AcceptUnit == PickPlanGoodsList.AcceptUnit && x.GoodsCode == PickPlanGoodsList.GoodsCode).ToList()[0].Piece = Convert.ToString(Convert.ToInt32(GoodsList.ToList()[0].Piece) + Convert.ToInt32(PickPlanGoodsList.Piece));
                    _PickPlanGoodsList.Where(x => x.AcceptUnit == PickPlanGoodsList.AcceptUnit && x.GoodsCode == PickPlanGoodsList.GoodsCode).ToList()[0].ScanPiece = GoodsList.ToList()[0].ScanPiece + PickPlanGoodsList.ScanPiece;
                }
                var AcceptUnitGoodsList = _AcceptUnitGoodsList.Where(x => x.AcceptUnit == PickPlanGoodsList.AcceptUnit);
                if (AcceptUnitGoodsList.Count().Equals(0))
                {
                    _AcceptUnitGoodsList.Add(new CargoOrderPickPlanGoodsEntity
                    {
                        PickGoodsID = PickPlanGoodsList.PickGoodsID,
                        PickPlanNo = PickPlanGoodsList.PickPlanNo,
                        ProductID = PickPlanGoodsList.ProductID,
                        ProductName = PickPlanGoodsList.ProductName,
                        OrderNo = PickPlanGoodsList.OrderNo,
                        HouseID = PickPlanGoodsList.HouseID,
                        AreaID = PickPlanGoodsList.AreaID,
                        ContainerCode = PickPlanGoodsList.ContainerCode,
                        GoodsCode = PickPlanGoodsList.GoodsCode,
                        Piece = PickPlanGoodsList.Piece,
                        ScanPiece = PickPlanGoodsList.ScanPiece,
                        LogisAwbNo = PickPlanGoodsList.LogisAwbNo,
                        Dep = PickPlanGoodsList.Dep,
                        Dest = PickPlanGoodsList.Dest,
                        ScanStatus = PickPlanGoodsList.ScanStatus,
                        AcceptUnit = PickPlanGoodsList.AcceptUnit,
                        AcceptAddress = PickPlanGoodsList.AcceptAddress,
                        AcceptPeople = PickPlanGoodsList.AcceptPeople,
                        AcceptTelephone = PickPlanGoodsList.AcceptTelephone,
                        AcceptCellphone = PickPlanGoodsList.AcceptCellphone,
                        PitNum = PickPlanGoodsList.PitNum,
                    });
                }
                else
                {
                    _AcceptUnitGoodsList.Where(x => x.AcceptUnit == PickPlanGoodsList.AcceptUnit).ToList()[0].Piece = Convert.ToString(Convert.ToInt32(AcceptUnitGoodsList.ToList()[0].Piece) + Convert.ToInt32(PickPlanGoodsList.Piece));
                    _AcceptUnitGoodsList.Where(x => x.AcceptUnit == PickPlanGoodsList.AcceptUnit).ToList()[0].ScanPiece = AcceptUnitGoodsList.ToList()[0].ScanPiece + PickPlanGoodsList.ScanPiece;
                }
            }
            CargoOrderPickPlanEntity _result = bus.QueryOrderPickPlanInfo(PickPlanNo);
            _result.PickPlanGoodsList = _PickPlanGoodsList;
            _result.AcceptUnitGoodsList = _AcceptUnitGoodsList;
            //JSON
            String json = JSON.Encode(_result);
            context.Response.Write(json);
        }
        /// <summary>
        /// 扫描汽配零部件零件号码出库
        /// </summary>
        /// <param name="context"></param>
        private void ScanPickPlanOrder(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();

            if (string.IsNullOrEmpty(context.Request["HouseID"]))
            {
                result.Result = false;
                result.Message = "仓库代码不能为空";
                goto ERR;
            }
            int HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID
            string PickPlanNo = Convert.ToString(context.Request["PickPlanNo"]).Trim();//拣货计划单号
            string ContainerCode = Convert.ToString(context.Request["ContainerCode"]).Trim();//货位代码
            string GoodsCode = Convert.ToString(context.Request["GoodsCode"]).Trim();//产品编码
            string UserID = Convert.ToString(context.Request["UserID"]).Trim();//操作人账号

            CargoOrderBus bus = new CargoOrderBus();
            result.Result = true;
            result.Message = "拣货成功";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "拣货计划";
            log.NvgPage = "扫描出库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "U";
            log.Status = "0";
            #region 通用数据检验
            if (HouseID.Equals(0))
            {
                result.Result = false;
                result.Message = "仓库代码不能为空";
                goto ERR;
            }
            //if (string.IsNullOrEmpty(ContainerCode))
            //{
            //    result.Result = false;
            //    result.Message = "货位代码不能为空";
            //    goto ERR;
            //}
            if (string.IsNullOrEmpty(GoodsCode))
            {
                result.Result = false;
                result.Message = "产品编码不能为空";
                goto ERR;
            }
            GoodsCode = GoodsCode.Split('|')[0];
            GoodsCode = GoodsCode.Split(' ')[0];
            #endregion
            List<CargoOrderPickPlanGoodsEntity> GetOrderPickPlanGoodsInfoLists = bus.GetOrderPickPlanGoodsInfoList(new CargoOrderPickPlanGoodsEntity { PickPlanNo = PickPlanNo, HouseID = HouseID.ToString() });
            if (GetOrderPickPlanGoodsInfoLists.Count.Equals(0))
            {
                result.Result = false;
                result.Message = "未查询到此拣货计划数据";
                goto ERR;
            }
            if (GetOrderPickPlanGoodsInfoLists.Where(x => x.ScanStatus.Equals("0")).ToList().Count.Equals(0))
            {
                result.Result = false;
                result.Message = "此拣货计划已完成";
                goto ERR;
            }
            if (GetOrderPickPlanGoodsInfoLists.Where(x => x.ContainerCode == ContainerCode).Count() <= 0)
            {
                result.Result = false;
                result.Message = "此货位为无拣货产品";
                goto ERR;
            }
            if (GetOrderPickPlanGoodsInfoLists.Where(x => x.GoodsCode == GoodsCode).Count() <= 0)
            {
                result.Result = false;
                result.Message = "此产品不在拣货计划中";
                goto ERR;
            }
            List<CargoOrderPickPlanGoodsEntity> GetOrderPickPlanGoodsInfoList = GetOrderPickPlanGoodsInfoLists.Where(x => x.ContainerCode == ContainerCode && x.GoodsCode == GoodsCode && x.ScanStatus != "1").OrderByDescending(x => x.ScanStatus).OrderBy(x => x.OrderNo).ToList();
            if (GetOrderPickPlanGoodsInfoList.Count() == 0)
            {
                result.Result = false;
                result.Message = "此产品已拣货完成";
                goto ERR;
            }
            List<CargoOrderPickPlanGoodsEntity> resultList = new List<CargoOrderPickPlanGoodsEntity>();
            List<CargoOrderPickPlanGoodsEntity> list = new List<CargoOrderPickPlanGoodsEntity>();
            string OrderStatus = "1";
            string ScanStatus = "2";
            foreach (var planGoods in GetOrderPickPlanGoodsInfoList)
            {
                List<CargoOrderPickPlanGoodsEntity> SumPieceList = GetOrderPickPlanGoodsInfoLists.Where(x => x.AcceptUnit == planGoods.AcceptUnit && x.GoodsCode == planGoods.GoodsCode).ToList();
                List<CargoOrderPickPlanGoodsEntity> SumScanPieceList = GetOrderPickPlanGoodsInfoLists.Where(x => x.AcceptUnit == planGoods.AcceptUnit && x.GoodsCode == planGoods.GoodsCode).ToList();
                int SumPiece = 0;
                int SumScanPiece = 0;
                foreach (var item in SumPieceList)
                {
                    SumPiece = SumPiece + Convert.ToInt32(item.Piece);
                }
                foreach (var item in SumScanPieceList)
                {
                    SumScanPiece = SumScanPiece + Convert.ToInt32(item.ScanPiece);
                }
                resultList.Add(new CargoOrderPickPlanGoodsEntity
                {
                    PickPlanNo = planGoods.PickPlanNo,
                    OrderNo = planGoods.OrderNo,
                    GoodsCode = planGoods.GoodsCode,
                    Piece = planGoods.Piece + "-" + (planGoods.ScanPiece + 1),
                    LogisAwbNo = planGoods.LogisAwbNo,
                    Dep = planGoods.Dep,
                    Dest = planGoods.Dest,
                    AcceptUnit = planGoods.AcceptUnit,
                    AcceptUnitCN = planGoods.AcceptUnitCN,
                    AcceptAddress = planGoods.AcceptAddress,
                    AcceptPeople = planGoods.AcceptPeople,
                    AcceptTelephone = planGoods.AcceptTelephone,
                    AcceptCellphone = planGoods.AcceptCellphone
                });
                if (bus.GetOrderPickPlanGoodsScanNum(new CargoOrderPickPlanGoodsEntity { PickPlanNo = planGoods.PickPlanNo, OrderNo = planGoods.OrderNo }))
                {
                    OrderStatus = "2";
                }
                if (Convert.ToInt32(planGoods.Piece).Equals(planGoods.ScanPiece + 1))
                {
                    ScanStatus = "1";
                }
                list.Add(new CargoOrderPickPlanGoodsEntity
                {
                    OrderID = planGoods.OrderID,
                    OrderNo = planGoods.OrderNo,
                    PickPlanNo = PickPlanNo,
                    HouseID = HouseID.ToString(),
                    ContainerCode = ContainerCode,
                    GoodsCode = GoodsCode,
                    ProductID = planGoods.ProductID,
                    TagCode = GoodsCode,
                    ScanStatus = ScanStatus,
                    OrderStatus = OrderStatus,
                    ScanPiece = planGoods.ScanPiece + 1,
                    OP_ID = UserID
                });
                result.PitNum = planGoods.PitNum;
                result.SumPiece = SumPiece;
                result.SumScanPiece = SumScanPiece + 1;
                result.AcceptPeople = planGoods.AcceptUnit;
                break;
            }
            result.orderPickPlanList = resultList;
            bus.UpdateOrderPickPlanGoodsScanStatus(list, log);
        ERR:
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);

        }
        /// <summary>
        /// 扫描轮胎拣货单
        /// </summary>
        /// <param name="context"></param>
        private void ScanTirePickPlanOrder(HttpContext context)
        {
            CargoAPIMessage result = new CargoAPIMessage();

            if (string.IsNullOrEmpty(context.Request["HouseID"]))
            {
                result.Result = false;
                result.Message = "仓库代码不能为空";
                goto ERR;
            }
            int HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID
            string PickPlanNo = Convert.ToString(context.Request["PickPlanNo"]).Trim();//拣货计划单号
            string ContainerCode = Convert.ToString(context.Request["ContainerCode"]).Trim();//货位代码
            string GoodsCode = Convert.ToString(context.Request["GoodsCode"]).Trim();//产品编码
            string UserID = Convert.ToString(context.Request["UserID"]).Trim();//操作人账号

            CargoOrderBus bus = new CargoOrderBus();
            result.Result = true;
            result.Message = "拣货成功";
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "拣货计划";
            log.NvgPage = "扫描出库";
            log.UserID = UserID;//限定某一账号
            log.Operate = "U";
            log.Status = "0";
            #region 通用数据检验
            if (HouseID.Equals(0))
            {
                result.Result = false;
                result.Message = "仓库代码不能为空";
                goto ERR;
            }
            //if (string.IsNullOrEmpty(ContainerCode))
            //{
            //    result.Result = false;
            //    result.Message = "货位代码不能为空";
            //    goto ERR;
            //}
            if (string.IsNullOrEmpty(GoodsCode))
            {
                result.Result = false;
                result.Message = "产品编码不能为空";
                goto ERR;
            }
            GoodsCode = GoodsCode.Split('|')[0];
            #endregion
            List<CargoOrderPickPlanGoodsEntity> GetOrderPickPlanGoodsInfoList = bus.GetOrderPickPlanGoodsInfoList(new CargoOrderPickPlanGoodsEntity { PickPlanNo = PickPlanNo, HouseID = HouseID.ToString() });
            if (GetOrderPickPlanGoodsInfoList.Count.Equals(0))
            {
                result.Result = false;
                result.Message = "未查询到此拣货计划数据";
                goto ERR;
            }
            if (GetOrderPickPlanGoodsInfoList.Where(x => x.ScanStatus.Equals("0") || x.ScanStatus.Equals("2")).ToList().Count.Equals(0))
            {
                result.Result = false;
                result.Message = "此拣货计划已完成";
                goto ERR;
            }
            if (GetOrderPickPlanGoodsInfoList.Where(x => x.ContainerCode == ContainerCode).Count() <= 0)
            {
                result.Result = false;
                result.Message = "此货位为无拣货产品";
                goto ERR;
            }
            CargoProductBus proBus = new CargoProductBus();
            CargoProductEntity tag = proBus.QueryProductInfoByTagCode(new CargoProductTagEntity { TagCode = GoodsCode });
            if (tag.ProductID.Equals(0))
            {
                result.Result = false;
                result.Message = "标签编码不存在";
                goto ERR;
            }
            if (GetOrderPickPlanGoodsInfoList.Where(x => x.ProductID == tag.ProductID.ToString() && x.GoodsCode == tag.GoodsCode && x.ContainerCode == ContainerCode).Count() <= 0)
            {
                result.Result = false;
                result.Message = "此产品不在拣货计划中";
                goto ERR;
            }
            GetOrderPickPlanGoodsInfoList = GetOrderPickPlanGoodsInfoList.Where(x => x.ContainerCode == ContainerCode && x.ProductID == tag.ProductID.ToString() && x.GoodsCode == tag.GoodsCode && x.ScanStatus != "1").ToList();
            if (GetOrderPickPlanGoodsInfoList.Count() == 0)
            {
                result.Result = false;
                result.Message = "此产品已拣货完成";
                goto ERR;
            }
            if (proBus.IsExistCargoProductTag(new CargoProductTagEntity { TagCode = GoodsCode, OutCargoStatus = "1" }))
            {
                result.Result = false;
                result.Message = "此产品已拣货";
                goto ERR;
            }
            List<CargoOrderPickPlanGoodsEntity> resultList = new List<CargoOrderPickPlanGoodsEntity>();
            string ScanStatus = "2";
            CargoOrderPickPlanGoodsEntity cargoOrderPick = GetOrderPickPlanGoodsInfoList[0];
            int ScanPiece = cargoOrderPick.ScanPiece + 1;
            if (Convert.ToInt32(cargoOrderPick.Piece) <= ScanPiece)
            {
                ScanStatus = "1";
            }
            resultList.Add(new CargoOrderPickPlanGoodsEntity
            {
                PickPlanNo = cargoOrderPick.PickPlanNo,
                OrderNo = cargoOrderPick.OrderNo,
                GoodsCode = cargoOrderPick.GoodsCode,
                Piece = cargoOrderPick.Piece + "-" + cargoOrderPick.ScanPiece + 1,
                LogisAwbNo = cargoOrderPick.LogisAwbNo,
                Dep = cargoOrderPick.Dep,
                Dest = cargoOrderPick.Dest,
                AcceptUnit = cargoOrderPick.AcceptUnit,
                AcceptUnitCN = cargoOrderPick.AcceptUnitCN,
                AcceptAddress = cargoOrderPick.AcceptAddress,
                AcceptPeople = cargoOrderPick.AcceptPeople,
                AcceptTelephone = cargoOrderPick.AcceptTelephone,
                AcceptCellphone = cargoOrderPick.AcceptCellphone
            });
            CargoOrderEntity orderEntity = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = cargoOrderPick.OrderNo });
            CargoInterfaceBus inter = new CargoInterfaceBus();
            int outN = inter.GetOutCargoNum(new CargoProductTagEntity { OrderNo = cargoOrderPick.OrderNo });
            string OrderStatus = "1";
            if (outN + 1 >= orderEntity.Piece)
            {
                OrderStatus = "2";
            }

            result.orderPickPlanList = resultList;
            bus.UpdateOrderPickPlanGoodsScanStatus(new List<CargoOrderPickPlanGoodsEntity>
            {
                new CargoOrderPickPlanGoodsEntity
                {
                    OrderID = orderEntity.OrderID,
                    OrderNo = cargoOrderPick.OrderNo,
                    PickPlanNo = PickPlanNo,
                    HouseID = HouseID.ToString(),
                    ContainerCode = ContainerCode,
                    GoodsCode = tag.GoodsCode,
                    TagCode = GoodsCode,
                    ProductID = tag.ProductID.ToString(),
                    ScanStatus = ScanStatus,
                    ScanPiece = ScanPiece,
                    OrderStatus=OrderStatus,
                    OP_ID = UserID
                }
            }, log);
        ERR:
            //JSON
            String json = JSON.Encode(result);
            context.Response.Write(json);

        }
        /// <summary>
        /// 生成捆包单
        /// </summary>
        /// <param name="context"></param>
        private void CreateBundleOrder(HttpContext context)
        {
            CargoAPIMessage msg = new CargoAPIMessage();
            msg.Result = true;
            if (string.IsNullOrEmpty(context.Request["HouseID"]))
            {
                msg.Result = false;
                msg.Message = "仓库代码不能为空";
                goto ERR;
            }
            int HouseID = Convert.ToInt32(context.Request["HouseID"]);//仓库代码ID
            string UserID = Convert.ToString(context.Request["UserID"]).Trim();//操作人账号
            CargoOrderBundleEntity ent = new CargoOrderBundleEntity();
            CargoOrderBus bus = new CargoOrderBus();
            CargoHouseBus house = new CargoHouseBus();
            CargoHouseEntity houseEnt = house.QueryCargoHouseByID(HouseID);
            int OrderNum = 0;
            ent.BundleNo = "B" + Common.GetMaxBundleOrderNumByCurrentDate(HouseID, houseEnt.HouseCode, out OrderNum);
            ent.OrderNum = OrderNum;
            ent.HouseID = HouseID;
            ent.BundleStatus = "0";
            ent.OP_ID = UserID;
            ent.BundleType = "0";
            ent.CreateDate = DateTime.Now;
            ent.OP_DATE = DateTime.Now;


            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "捆包管理";
            log.NvgPage = "创建捆包单";
            log.UserID = UserID;//限定某一账号
            log.Operate = "A";
            log.Status = "0";

            try
            {
                bus.AddBundleOrder(ent, log);
                msg.Result = true;
                msg.OrderNo = ent.BundleNo;
                msg.Message = "创建成功";
            }
            catch (ApplicationException ex)
            {
                msg.Result = false;
                msg.Message = "失败" + ex.Message;
            }
        ERR:
            //JSON
            String json = JSON.Encode(msg);
            context.Response.Write(json);
        }
        /// <summary>
        /// 扫描零件标签进行捆包
        /// </summary>
        /// <param name="context"></param>
        private void ScanProductTagBundle(HttpContext context)
        {
            string BundleNo = Convert.ToString(context.Request["BundleNo"]).Trim();//捆包箱标签
            string GoodsCode = Convert.ToString(context.Request["GoodsCode"]).Trim();//零件号码标签
            string UserID = Convert.ToString(context.Request["UserID"]).Trim();//操作人账号
            int Piece = string.IsNullOrEmpty(context.Request["Piece"]) ? 1 : Convert.ToInt32(context.Request["Piece"]);//数量
            CargoAPIMessage msg = new CargoAPIMessage();
            msg.Result = true;
            if (string.IsNullOrEmpty(GoodsCode))
            {
                msg.Result = false;
                msg.Message = "零件号码标签不能为空";
                goto ERR;
            }
            if (string.IsNullOrEmpty(BundleNo))
            {
                msg.Result = false;
                msg.Message = "捆包标签不能为空";
                goto ERR;
            }
            CargoOrderBus bus = new CargoOrderBus();
            CargoPriceBus priceBus = new CargoPriceBus();
            string ProductName = string.Empty;
            CargoOrderBundleEntity bundleEntity = bus.QueryBundleOrderEntity(new CargoOrderBundleEntity { BundleNo = BundleNo });
            if (bundleEntity == null)
            {
                msg.Result = false;
                msg.Message = "捆包单数据不存在";
                goto ERR;
            }
            if (bundleEntity.BundleStatus.Equals("2"))
            {
                msg.Result = false;
                msg.Message = "捆包单已完成";
                goto ERR;
            }
            List<CargoProductPriceEntity> priceEntities = priceBus.QueryCargoProductPrice(new CargoProductPriceEntity { PriceType = "7", ProductCode = GoodsCode });
            if (priceEntities.Count > 0)
            {
                ProductName = priceEntities[0].ProductName;
            }
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "捆包管理";
            log.NvgPage = "扫描捆包";
            log.UserID = UserID;//限定某一账号
            log.Operate = "U";
            log.Status = "0";
            try
            {
                bus.ScanProductTagBundle(new CargoOrderBundleEntity { BundleNo = BundleNo, GoodsCode = GoodsCode, ProductName = ProductName, Piece = Piece, OP_ID = UserID, HouseID = bundleEntity.HouseID }, log);
                bus.UpdateBundleOrderStatus(new CargoOrderBundleEntity { BundleStatus = "1", Piece = Piece, OP_ID = UserID, BundleNo = BundleNo });
                msg.Result = true;
                msg.Message = "保存成功";
            }
            catch (ApplicationException ex)
            {
                msg.Result = false;
                msg.Message = "失败" + ex.Message;
            }
        ERR:
            //JSON
            String json = JSON.Encode(msg);
            context.Response.Write(json);
        }
        /// <summary>
        /// 设置捆包单结束
        /// </summary>
        /// <param name="context"></param>
        private void SetBundleComplete(HttpContext context)
        {
            string BundleNo = Convert.ToString(context.Request["BundleNo"]).Trim();//捆包箱标签
            string UserID = Convert.ToString(context.Request["UserID"]).Trim();//操作人账号
            CargoAPIMessage msg = new CargoAPIMessage();
            msg.Result = true;
            if (string.IsNullOrEmpty(BundleNo))
            {
                msg.Result = false;
                msg.Message = "捆包标签不能为空";
                goto ERR;
            }
            CargoOrderBus bus = new CargoOrderBus();
            CargoOrderBundleEntity bundleEntity = bus.QueryBundleOrderEntity(new CargoOrderBundleEntity { BundleNo = BundleNo });
            if (bundleEntity == null)
            {
                msg.Result = false;
                msg.Message = "捆包单数据不存在";
                goto ERR;
            }

            try
            {
                bus.UpdateBundleOrderStatus(new CargoOrderBundleEntity { BundleStatus = "2", Piece = 0, OP_ID = UserID, BundleNo = BundleNo });
                msg.Result = true;
                msg.Message = "保存成功";
            }
            catch (ApplicationException ex)
            {
                msg.Result = false;
                msg.Message = "失败" + ex.Message;
            }
        ERR:
            //JSON
            String json = JSON.Encode(msg);
            context.Response.Write(json);
        }
    }
}