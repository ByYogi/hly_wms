using Cargo.Extensions;
using House.Business;
using House.Business.Cargo;
using House.Business.Log;
using House.Entity;
using House.Entity.Cargo;
using House.Entity.Cargo.Order;
using House.Entity.Cargo.Product;
using House.Entity.Dto;
using House.Entity.Dto.Base;
using House.Entity.Dto.Order;
using House.Entity.Dto.Order.CargoRpl;
using House.Entity.House;
using iText.Kernel.Pdf;
using iText.Layout.Element;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using NPOI.HSSF.Record.Formula;
using NPOI.HSSF.Record.Formula.Functions;
using NPOI.POIFS.Properties;
using NPOI.POIFS.Storage;
using Senparc.Weixin.Helpers;
using Senparc.Weixin.MP.AdvancedAPIs.MerChant;
using Senparc.Weixin.MP.AdvancedAPIs.TemplateMessage;
using Senparc.Weixin.MP.TenPayLibV3;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.Data;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Net;
using System.Reflection;
using System.Security.Cryptography;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.Script.Serialization;
using System.Web.UI.WebControls;

namespace Cargo.Order
{
    public partial class orderApi : BasePage
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            string methodName = string.Empty;
            try
            {
                methodName = Request["method"];
                if (String.IsNullOrEmpty(methodName)) return;
                Type type = this.GetType();
                MethodInfo method = type.GetMethod(methodName);
                method.Invoke(this, null);
            }
            catch (Exception ex)
            {
                LogBus bus = new LogBus();
                LogEntity log = new LogEntity();
                log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                log.Operate = "";
                log.Moudle = "";
                log.Status = "1";
                log.NvgPage = "";
                log.UserID = UserInfor == null ? "" : UserInfor.LoginName.Trim();
                log.Memo = methodName + " " + ex.FormatErr();
                bus.InsertLog(log);
            }
            finally
            {
                HttpContext.Current.Response.End();
            }

        }
        #region 进仓单操作方法集合

        /// <summary>
        /// 分页查询进货单数据
        /// </summary>
        public void QueryAllPagePurcgaseOrders()
        {
            CargoPurchaseOrderEntity queryEntity = new CargoPurchaseOrderEntity();
            #region 查询条件
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]).Equals(0) ? 1 : Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]).Equals(0) ? 10 : Convert.ToInt32(Request["rows"]);

            queryEntity.TrafficType = 4;//订单类型默认查询进仓单

            if (!string.IsNullOrEmpty(Convert.ToString(Request["FacOrderNo"])))
            {
                queryEntity.FacOrderNo = Convert.ToString(Request["FacOrderNo"]);
            }

            //客户编码输入查询
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientNum"])))
            {
                queryEntity.ClientNum = Convert.ToInt32(Request["ClientNum"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"])))
            {
                queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]);
            }
            if (Convert.ToString(Request["ReceivingStatus"]) != "-1")
            {
                queryEntity.ReceivingStatus = Convert.ToString(Request["ReceivingStatus"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Request["HID"]))
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HID"]);
            }
            #endregion
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryAllPagePurcgaseOrders(pageIndex, pageSize, queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 分页查询该进货单下的明细商品
        /// </summary>
        public void QueryAllPurcgaseOrderGoods()
        {
            CargoPurchaseOrderGoodsEntity queryEntity = new CargoPurchaseOrderGoodsEntity();
            CargoOrderBus bus = new CargoOrderBus();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["OrderID"])))
            {
                queryEntity.OrderID = Convert.ToInt64(Request["OrderID"]);
            }
            List<CargoPurchaseOrderGoodsEntity> result = bus.QueryAllPurcgaseOrderGoods(queryEntity);
            String json = JSON.Encode(result);
            Response.Clear();
            Response.Write(json);
            Response.End();
        }

        /// <summary>
        /// 修改进仓单明细来货件数 及更新主表收货状态
        /// </summary>
        /// <remarks>现逻辑：前置条件[收货状态ReceivingStatus = 未收货0]
        /// 1.保存子表收货件数、退货件数 -》
        /// 2.拿list收货总和、来货总和比较，若收货件数总和ReceivePiece>=来货件数总和Piece ？主表ReceivingStatus已收货1： 部分收货2 -》
        /// 3.保存“收货件数”来货导入数据 =》
        /// 4.若退货件数 > 0  则新增订单类型TrafficType = 2退货订单的进仓单主表及对应退货明细数据。
        /// </remarks>
        public void UpdatePurchaseOrderGoodsPiece()
        {
            //拿到json数据做转换处理
            String json = Request["orderData"];
            if (String.IsNullOrEmpty(json)) return;
            CargoPurchaseOrderDto orderDto = JsonConvert.DeserializeObject<CargoPurchaseOrderDto>(json);
            ErrMessage msg = new ErrMessage()
            {
                Result = true,
                Message = ""
            };
            if (string.IsNullOrEmpty(orderDto.PurchaseOrder.ReceivingStatus) || !orderDto.PurchaseOrder.ReceivingStatus.Equals("0"))
            {
                msg.Result = false;
                msg.Message = "此订单已收货";
                goto Error;
            }
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "进仓管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            try
            {
                CargoOrderBus bus = new CargoOrderBus();
                CargoHouseBus house = new CargoHouseBus();
                if (orderDto.List.Count > 0 && msg.Result)
                {
                    #region 组织数据
                    List<CargoFactoryOrderEntity> factoryOrders = new List<CargoFactoryOrderEntity>();
                    foreach (var order in orderDto.List)
                    {
                        if (order.ReceivePiece <= 0)
                        {
                            msg.Message = "请填写收货数量";
                            msg.Result = false;
                            goto Error;
                        }
                        factoryOrders.Add(new CargoFactoryOrderEntity()
                        {
                            Supplier = Convert.ToString(orderDto.PurchaseOrder.AcceptUnit),
                            SuppClientNum = Convert.ToString(orderDto.PurchaseOrder.ClientNum),//客户编码
                            SupplierAddress = Convert.ToString(orderDto.PurchaseOrder.AcceptAddress),
                            HouseID = orderDto.PurchaseOrder.HouseID,//进仓单所在仓库
                            FacOrderNo = orderDto.PurchaseOrder.FacOrderNo,//进仓单号
                            Source = 83,//写死
                            SourceName = "供应商进仓",//写死
                            TypeID = order.TypeID,//进仓订单详情产品类型ID,
                            TypeName = order.TypeName,//进仓订单详情产品类型名称,
                            OrderType = 0,//内部订单
                            Model = order.Model,//进仓订单详情型号
                            BelongMonth = DateTime.Now.ToString("yyyyMM"),//当前年月
                            Born = Convert.ToString(order.Born),//进仓订单详情产地
                            Assort = "OER",
                            Specs = order.Specs,//进仓订单详情规格
                            LoadIndex = order.LoadIndex, //进仓订单详情载重
                            SpeedLevel = order.SpeedLevel,//进仓订单详情速度
                            Figure = order.Figure,//进仓订单详情花纹
                            GoodsCode = order.GoodsCode,//进仓订单详情货品代码
                            Batch = order.Batch,//进仓订单详情批次
                            OrderNum = order.Piece,//进仓订单详情来货件数,
                            ReplyNumber = order.ReceivePiece,//进仓订单详情收货件数,
                            InPiece = 0,
                            InCargoStatus = 0,
                            InHousePrice = order.InHousePrice,//进仓价
                            UnitPrice = order.UnitPrice,//进仓订单详情进货价,
                            CostPrice = order.CostPrice,
                            TradePrice = order.TradePrice,//进仓订单详情门店价,
                            SalePrice = order.SalePrice,//进仓订单详情销售价,
                            WhetherTax = 0,
                            SaleMoney = order.SalePrice * order.ReceivePiece,
                            OP_Name = UserInfor.UserName.Trim(),
                            //CargoDepart = (house.QueryCargoHouse(new CargoHouseEntity { HouseID = orderDto.HouseID })).CargoDepart,
                            ProductName = (house.QueryCargoHouse(new CargoHouseEntity { HouseID = orderDto.PurchaseOrder.HouseID })).CargoDepart,
                            BelongDepart = "1",
                            Company = "0",
                            SpecsType = "4",
                            ProductCode = order.ProductCode
                        });
                    }
                    #endregion
                    orderDto.UserName = UserInfor.UserName;
                    orderDto.LoginName = UserInfor.LoginName;
                    CargoFactoryOrderBus factoryBus = new CargoFactoryOrderBus();
                    // 1.更新进仓单 [来货件数、退货件数] 主表及明细表
                    bus.UpdatePurchaseOrderGoodsPiece(orderDto, log);
                    //2.新增收货件数-入库导入记录
                    factoryBus.SaveFactoryOrderData(factoryOrders, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
        Error:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion

        #region 订单操作方法集合

        /// <summary>
        /// 查询订单数据
        /// </summary>
        public void QueryOrderInfo()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Piece"]))) { queryEntity.Piece = Convert.ToInt32(Request["Piece"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
            queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])))
            {
                queryEntity.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
            }
            queryEntity.PayClientName = Convert.ToString(Request["PayClientName"]);
            queryEntity.Dep = Convert.ToString(Request["Dep"]);
            queryEntity.Dest = Convert.ToString(Request["Dest"]);
            queryEntity.CreateAwb = Convert.ToString(Request["CreateAwb"]);
            queryEntity.HAwbNo = Convert.ToString(Request["HAwbNo"]);
            queryEntity.OutHouseName = Convert.ToString(Request["OutHouseName"]);
            if (Convert.ToString(Request["OpenOrderSource"]) != "-1")
            {
                queryEntity.OpenOrderSource = Convert.ToString(Request["OpenOrderSource"]);
            }
            if (Convert.ToString(Request["OrderType"]) != "-1")
            {
                queryEntity.OrderType = Convert.ToString(Request["OrderType"]);
            }
            if (Convert.ToString(Request["AwbStatus"]) != "-1")
            {
                queryEntity.AwbStatus = Convert.ToString(Request["AwbStatus"]);
            }
            if (Convert.ToString(Request["FinanceSecondCheck"]) != "-1")
            {
                queryEntity.FinanceSecondCheck = Convert.ToString(Request["FinanceSecondCheck"]);
            }
            if (Convert.ToString(Request["CheckStatus"]) != "-1")
            {
                queryEntity.CheckStatus = Convert.ToString(Request["CheckStatus"]);
            }
            //ueryEntity.CheckOutType = Convert.ToString(Request["CheckOutType"]);
            //queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            queryEntity.SaleManID = Convert.ToString(Request["SaleManID"]);
            if (Convert.ToString(Request["OrderModel"]) != "-1")
            {
                queryEntity.OrderModel = Convert.ToString(Request["OrderModel"]);
            }
            if (Convert.ToString(Request["ThrowGood"]) != "-1")
            {
                queryEntity.ThrowGood = Convert.ToString(Request["ThrowGood"]);
            }
            //2021-01-21 添加公司类型查询条件
            if (Convert.ToString(Request["BelongHouse"]) != "-1")
            {
                queryEntity.BelongHouse = Convert.ToString(Request["BelongHouse"]);
            }
            //2021-01-30 添加客户名称查询条件
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            //if (!string.IsNullOrEmpty(Request["FirstID"]))//一级仓库
            //{
            //    queryEntity.FirstAreaID = Convert.ToInt32(Request["FirstID"]);
            //}

            //2021-10-20 添加出库类型查询条件
            if (Convert.ToString(Request["OutCargoType"]) != "-1")
            {
                queryEntity.OutCargoType = Convert.ToString(Request["OutCargoType"]);
            }
            //2021-10-25 添加推送类型查询条件
            if (Convert.ToString(Request["PostponeShip"]) != "-1")
            {
                queryEntity.PostponeShip = Convert.ToString(Request["PostponeShip"]);
            }
            if (Convert.ToString(Request["TrafficType"]) != "-1")
            {
                queryEntity.TrafficType = Convert.ToString(Request["TrafficType"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["LineID"])))
            {
                queryEntity.LineID = Convert.ToInt32(Request["LineID"]);
            }
            queryEntity.ShopCode = Convert.ToString(Request["ShopCode"]);
            if (!string.IsNullOrEmpty(Request["SuppClientNum"]))//一级分类
            {
                queryEntity.SuppClientNum = Convert.ToInt32(Request["SuppClientNum"]);//所属仓库ID
            }
            if (!string.IsNullOrEmpty(Request["BusinessID"]))//业务名称
            {
                queryEntity.BusinessID = Convert.ToString(Request["BusinessID"]);//业务名称
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryOrderInfo(pageIndex, pageSize, queryEntity);
            //if (list != null) { QueryOrderInfoList = list; }
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        public void QueryOrderExcel()
        {
            try
            {
                CargoOrderEntity queryEntity = new CargoOrderEntity()
                {
                    StartDate = Request.GetDateTime("StartDate").GetValueOrDefault(),
                    EndDate = Request.GetDateTime("EndDate").GetValueOrDefault(),
                    Piece = Request.GetInt("Piece").GetValueOrDefault(),
                    OrderNo = Request.GetString("OrderNo"),
                    LogisAwbNo = Request.GetString("LogisAwbNo"),
                    AcceptPeople = Request.GetString("AcceptPeople"),
                    PayClientNum = Request.GetInt("PayClientNum").GetValueOrDefault(),
                    PayClientName = Request.GetString("PayClientName"),
                    Dep = Request.GetString("Dep"),
                    Dest = Request.GetString("Dest"),
                    CreateAwb = Request.GetString("CreateAwb"),
                    HAwbNo = Request.GetString("HAwbNo"),
                    OutHouseName = Request.GetString("OutHouseName"),
                    OpenOrderSource = Request.GetString("OpenOrderSource") == "-1" ? null : Request.GetString("OpenOrderSource"),
                    OrderType = Request.GetString("OrderType") == "-1" ? null : Request.GetString("OrderType"),
                    AwbStatus = Request.GetString("AwbStatus") == "-1" ? null : Request.GetString("AwbStatus"),
                    FinanceSecondCheck = Request.GetString("FinanceSecondCheck") == "-1" ? null : Request.GetString("FinanceSecondCheck"),
                    CheckStatus = Request.GetString("CheckStatus") == "-1" ? null : Request.GetString("CheckStatus"),
                    CargoPermisID = string.IsNullOrEmpty(Request["HouseID"])
                        ? UserInfor.CargoPermisID
                        : Request.GetString("HouseID"),
                    SaleManID = Request.GetString("SaleManID"),
                    OrderModel = Request.GetString("OrderModel") == "-1" ? null : Request.GetString("OrderModel"),
                    ThrowGood = Request.GetString("ThrowGood") == "-1" ? null : Request.GetString("ThrowGood"),
                    BelongHouse = Request.GetString("BelongHouse") == "-1" ? null : Request.GetString("BelongHouse"),
                    AcceptUnit = Request.GetString("AcceptUnit"),
                    OutCargoType = Request.GetString("OutCargoType") == "-1" ? null : Request.GetString("OutCargoType"),
                    PostponeShip = Request.GetString("PostponeShip") == "-1" ? null : Request.GetString("PostponeShip"),
                    TrafficType = Request.GetString("TrafficType") == "-1" ? null : Request.GetString("TrafficType"),
                    LineID = Request.GetInt("LineID").GetValueOrDefault(),
                    ShopCode = Request.GetString("ShopCode"),
                    SuppClientNum = Request.GetInt("SuppClientNum").GetValueOrDefault(),
                    BusinessID = Request.GetString("BusinessID"),
                    MarketType = Request.GetString("MarketType"),
                };

                // 分页参数
                int pageIndex = 0;
                int pageSize = 0;

                CargoOrderBus bus = new CargoOrderBus();
                Hashtable rslt = bus.QueryOrderInfo(pageIndex, pageSize, queryEntity);

                var CargoOrderEntityList = (List<CargoOrderEntity>)rslt["rows"];
                if (CargoOrderEntityList.Count <= 0)
                {
                    return;
                }
                CargoHouseBus houseBus = new CargoHouseBus();
                CargoHouseEntity houseEntity = houseBus.QueryCargoHouseByID(UserInfor.HouseID);

                DataTable table = new DataTable();
                table.Columns.Add("序号", typeof(int));
                table.Columns.Add("订单号", typeof(string));
                if (houseEntity.BelongHouse.Equals("6"))
                {
                    table.Columns.Add("数量", typeof(decimal));
                    table.Columns.Add("供应商进仓价", typeof(decimal));
                    table.Columns.Add("轮胎收入", typeof(decimal));
                    table.Columns.Add("配送费", typeof(decimal));
                    table.Columns.Add("平台费", typeof(decimal));
                    table.Columns.Add("优惠券", typeof(decimal));
                    table.Columns.Add("超期费", typeof(decimal));
                    table.Columns.Add("合计", typeof(decimal));
                }
                else
                {
                    table.Columns.Add("数量", typeof(decimal));
                    table.Columns.Add("收入", typeof(decimal));
                    table.Columns.Add("合计", typeof(decimal));
                }
                table.Columns.Add("审核状态", typeof(string));
                table.Columns.Add("结算状态", typeof(string));
                table.Columns.Add("所属仓库", typeof(string));
                table.Columns.Add("品牌", typeof(string));
                table.Columns.Add("规格", typeof(string));
                table.Columns.Add("花纹", typeof(string));
                table.Columns.Add("载速", typeof(string));
                table.Columns.Add("货品代码", typeof(string));
                table.Columns.Add("周期", typeof(string));
                //table.Columns.Add("出发站", typeof(string));
                //table.Columns.Add("到达站", typeof(string));
                table.Columns.Add("公司名称", typeof(string));
                table.Columns.Add("客户名称", typeof(string));//
                table.Columns.Add("收货人", typeof(string));
                table.Columns.Add("联系手机", typeof(string));
                table.Columns.Add("收货地址", typeof(string));
                table.Columns.Add("业务员", typeof(string));
                table.Columns.Add("订单类型", typeof(string));
                table.Columns.Add("开单员", typeof(string));
                table.Columns.Add("开单时间", typeof(string));
                table.Columns.Add("订单状态", typeof(string));
                table.Columns.Add("下单方式", typeof(string));
                table.Columns.Add("销售分类", typeof(string));
                table.Columns.Add("商城订单号", typeof(string));
                table.Columns.Add("付款方式", typeof(string));
                table.Columns.Add("支付订单号", typeof(string));
                table.Columns.Add("供应商", typeof(string));
                table.Columns.Add("优惠券类型", typeof(string));
                table.Columns.Add("送货方式", typeof(string));
                table.Columns.Add("物流公司单号", typeof(string));
                //table.Columns.Add("物流配送费用", typeof(string));
                table.Columns.Add("物流公司名称", typeof(string));
                table.Columns.Add("通联订单ID", typeof(string));
                table.Columns.Add("入库时间", typeof(DateTime));
                table.Columns.Add("入库天数", typeof(string));
                table.Columns.Add("共享仓库", typeof(string));
                table.Columns.Add("共享订单号", typeof(string));
                CargoOrderBus orderBus = new CargoOrderBus();
                int i = 0;
                string GetText(string value, string id)
                {
                    string retStr = string.Empty;
                    if (id.Contains("OrderModel"))
                    {
                        if (value.Trim() == "0")
                            retStr = "发货单";
                        else if (value.Trim() == "1")
                            retStr = "退货单";
                    }
                    else if (id.Contains("DeliveryType"))
                    {
                        if (value.Trim() == "0")
                            retStr = "急送";
                        else if (value.Trim() == "1")
                            retStr = "自提";
                        else if (value.Trim() == "2")
                            retStr = "普送";
                        else
                            retStr = "";
                    }
                    else if (id.Contains("PayWay"))
                    {
                        if (value.Trim() == "0")
                            retStr = "微信付款";
                        else if (value.Trim() == "1")
                            retStr = "额度付款";
                        else
                            retStr = "";
                    }
                    else if (id.Contains("FinanceSecondCheck"))
                    {
                        if (value.Trim() == "0")
                            retStr = "未审";
                        else if (value.Trim() == "1")
                            retStr = "已审";
                    }
                    else if (id.Contains("CouponType"))
                    {
                        if (value.Trim() == "0")
                            retStr = "平台券";
                        else if (value.Trim() == "1")
                            retStr = "供应商券";
                    }
                    else if (id.Contains("CheckStatus"))
                    {
                        if (value.Trim() == "0")
                            retStr = "未结算";
                        else if (value.Trim() == "1")
                            retStr = "已结清";
                        else if (value.Trim() == "2")
                            retStr = "未结清";
                    }
                    else if (id.Contains("TradeType"))
                    {
                        if (value.Trim() == "0")
                            retStr = "账号交易";
                        else if (value.Trim() == "1")
                            retStr = "预收款交易";
                        else if (value.Trim() == "2")
                            retStr = "返利款交易";
                        else if (value.Trim() == "3")
                            retStr = "微信支付";
                    }
                    else if (id.Contains("OrderType"))
                    {
                        if (value.Trim() == "0")
                            retStr = "电脑单";
                        else if (value.Trim() == "1")
                            retStr = "企业微信单";
                        else if (value.Trim() == "2")
                            retStr = "微信商城单";
                        else if (value.Trim() == "3")
                            retStr = "APP单";
                        else if (value.Trim() == "4")
                            retStr = "小程序单";
                    }
                    else if (id.Contains("AwbStatus"))
                    {
                        if (value.Trim() == "0")
                            retStr = "已下单";
                        else if (value.Trim() == "1")
                            retStr = "出库中";
                        else if (value.Trim() == "2")
                            retStr = "已出库";
                        else if (value.Trim() == "3")
                            retStr = "运输在途";
                        else if (value.Trim() == "4")
                            retStr = "已到达";
                        else if (value.Trim() == "5")
                            retStr = "已签收";
                    }
                    else if (id.Contains("MarketType"))
                    {
                        if (value.Trim() == "0")
                            retStr = "OES";
                        else if (value.Trim() == "1")
                            retStr = "大客户";
                        else if (value.Trim() == "2")
                            retStr = "云仓";
                    }
                    
                    return retStr;
                }
                var OrderNos = CargoOrderEntityList.Select(x => x.OrderNo).ToArray();
                var productShelves = orderBus.queryOrderProductForAPP(OrderNos);
                foreach (var it in CargoOrderEntityList)
                {
                    i++;
                    it.EnSafe();
                    var matchedPrdctShelve = productShelves.FirstOrDefault(c => c.OrderNo == it.OrderNo);
                    if(matchedPrdctShelve == null)
                    {
                        continue;
                    }
                    DataRow newRows = table.NewRow();
                    newRows["序号"] = i;
                    newRows["订单号"] = it.OrderNo.Trim();
                    if (houseEntity.BelongHouse.Equals("6"))
                    {
                        newRows["数量"] = it.Piece;
                        newRows["供应商进仓价"] = matchedPrdctShelve.originalPrice;
                        newRows["轮胎收入"] = it.OrderModel.Trim().Equals("1") ? -it.TransportFee : it.TransportFee;
                        newRows["配送费"] = it.TransitFee;
                        newRows["平台费"] = it.OtherFee;
                        newRows["优惠券"] = it.InsuranceFee;
                        newRows["超期费"] = it.OverDueFee;

                        newRows["合计"] = it.OrderModel.Trim().Equals("1") ? -it.TotalCharge : it.TotalCharge;
                    }
                    else
                    {
                        newRows["数量"] = it.Piece;
                        newRows["收入"] = it.OrderModel.Trim().Equals("1") ? -it.TransportFee : it.TransportFee;
                        newRows["合计"] = it.OrderModel.Trim().Equals("1") ? -it.TotalCharge : it.TotalCharge;
                    }
                    newRows["审核状态"] = GetText(it.FinanceSecondCheck.Trim(), "FinanceSecondCheck");
                    newRows["结算状态"] = GetText(it.CheckStatus.Trim(), "CheckStatus");
                    newRows["所属仓库"] = it.HouseName.Trim();
                    newRows["品牌"] = matchedPrdctShelve.TypeName;
                    newRows["规格"] = matchedPrdctShelve.Specs;
                    newRows["花纹"] = matchedPrdctShelve.Figure;
                    newRows["载速"] = matchedPrdctShelve.LoadIndex + matchedPrdctShelve.SpeedLevel;
                    newRows["货品代码"] = matchedPrdctShelve.GoodsCode;
                    newRows["周期"] = matchedPrdctShelve.Batch;
                    //newRows["出发站"] = it.Dep.Trim();
                    //newRows["到达站"] = it.Dest.Trim();
                    newRows["公司名称"] = it.ClientName.Trim();
                    newRows["客户名称"] = it.AcceptUnit.Trim();
                    newRows["收货人"] = it.AcceptPeople.Trim();
                    newRows["联系手机"] = it.AcceptCellphone.Trim();
                    newRows["收货地址"] = it.AcceptAddress.Trim();
                    newRows["业务员"] = it.SaleManName.Trim();
                    newRows["订单类型"] = GetText(it.OrderModel.Trim(), "OrderModel");
                    newRows["开单员"] = it.CreateAwb.Trim();
                    newRows["开单时间"] = it.CreateDate.ToString("yyyy-MM-dd HH:mm:ss");
                    newRows["订单状态"] = GetText(it.AwbStatus.Trim(), "AwbStatus");
                    newRows["下单方式"] = GetText(it.OrderType.Trim(), "OrderType");
                    newRows["销售分类"] = GetText(it.MarketType.Trim(), "MarketType");
                    newRows["商城订单号"] = it.WXOrderNo;
                    newRows["付款方式"] = GetText(it.PayWay, "PayWay");
                    newRows["支付订单号"] = it.WXPayOrderNo;
                    newRows["供应商"] = it.SuppClientName;
                    newRows["优惠券类型"] = GetText(it.CouponType, "CouponType");
                    newRows["送货方式"] = GetText(it.DeliveryType, "DeliveryType");
                    newRows["物流公司单号"] = it.LogisAwbNo;
                    //newRows["物流配送费用"] = it.TransitFee;
                    newRows["物流公司名称"] = it.LogisticName;
                    newRows["通联订单ID"] = it.Trxid;
                    if (matchedPrdctShelve.InCargoStatus == 0)
                    {
                        newRows["入库时间"] = DateTime.Now.ToString("1900-01-01");
                        newRows["入库天数"] = "";
                    }
                    else
                    {
                        var inTime = Convert.ToDateTime(matchedPrdctShelve.InHouseTime);
                        var CreateDate = Convert.ToDateTime(it.CreateDate);
                        var day = (CreateDate - inTime).Days;
                        newRows["入库时间"] = inTime;
                        newRows["入库天数"] = day;
                    }
                    newRows["共享仓库"] = it.ShareHouseName;
                    newRows["共享订单号"] = it.OpenOrderNo;

                    table.Rows.Add(newRows);
                }

                ToExcel.DataTableToExcel(table, "", "应收账款管理数据表" + DateTime.Now.ToString("yyMMddHHmmss"));

            }catch(Exception ex)
            {
                Response.StatusCode = (int)HttpStatusCode.InternalServerError;
                Response.Write($"{{\"success\": false, \"message\": \"{ex.Message}\", \"errorCode\": \"SYSTEM_ERROR\"}}");
            }
        }

        public void QueryOrderPickPlan()
        {
            CargoOrderPickPlanEntity queryEntity = new CargoOrderPickPlanEntity();//HouseID
            string[] HouseID = Request["HouseID"].Split(',');
            for (int i = 0; i < HouseID.Length; i++)
            {
                queryEntity.HouseID += Convert.ToInt32(HouseID[i]);
                if (i + 1 == HouseID.Length)
                {
                    continue;
                }
                queryEntity.HouseID += ",";
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["PickPlanNo"]))) { queryEntity.PickPlanNo = Convert.ToString(Request["PickPlanNo"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["PickStatus"]))) { queryEntity.PickStatus = Convert.ToString(Request["PickStatus"]); }
            //if (!string.IsNullOrEmpty(Convert.ToString(Request["HouseID"]))) { queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]); }
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryOrderPickPlan(queryEntity, pageIndex, pageSize);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void DelOrderPickPlan()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoOrderPickPlanEntity> list = new List<CargoOrderPickPlanEntity>();
            CargoOrderBus bus = new CargoOrderBus();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "删除拣货单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoOrderPickPlanEntity
                    {
                        PickID = Convert.ToInt32(row["PickID"]),
                        PickPlanNo = Convert.ToString(row["PickPlanNo"])
                    });
                }
                bus.DelOrderPickPlan(list, log);
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }


            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        public List<CargoOrderPickPlanGoodsEntity> QueryOrderPickPlanGoodsEntityList
        {
            get
            {
                if (Session["QueryOrderPickPlanGoodsEntityList"] == null)
                {
                    Session["QueryOrderPickPlanGoodsEntityList"] = new List<CargoOrderPickPlanGoodsEntity>();
                }
                return (List<CargoOrderPickPlanGoodsEntity>)(Session["QueryOrderPickPlanGoodsEntityList"]);
            }
            set
            {
                Session["QueryOrderPickPlanGoodsEntityList"] = value;
            }
        }
        public void QueryOrderPickPlanGoods()
        {
            CargoOrderPickPlanGoodsEntity queryEntity = new CargoOrderPickPlanGoodsEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["PickPlanNo"]))) { queryEntity.PickPlanNo = Convert.ToString(Request["PickPlanNo"]); }
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoOrderPickPlanGoodsEntity> recalls = bus.QueryOrderPickPlanGoods(queryEntity);
            if (recalls != null) { QueryOrderPickPlanGoodsEntityList = recalls; }
            String json = JSON.Encode(recalls);
            Response.Clear();
            Response.Write(json);
        }
        public Hashtable QueryOrderInfoList
        {
            get
            {
                if (Session["QueryOrderInfoList"] == null)
                {
                    Session["QueryOrderInfoList"] = new Hashtable();
                }
                return (Hashtable)(Session["QueryOrderInfoList"]);
            }
            set
            {
                Session["QueryOrderInfoList"] = value;
            }
        }
        /// <summary>
        /// 查询订单数据导出
        /// </summary>
        public void QueryOrderInfoExport()
        {
            string err = "OK";
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Piece"]))) { queryEntity.Piece = Convert.ToInt32(Request["Piece"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
            queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            //if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])))
            //{
            //    queryEntity.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
            //}
            queryEntity.PayClientName = Convert.ToString(Request["PayClientName"]);
            queryEntity.Dep = Convert.ToString(Request["Dep"]);
            queryEntity.Dest = Convert.ToString(Request["Dest"]);
            queryEntity.CreateAwb = Convert.ToString(Request["CreateAwb"]);
            queryEntity.OutHouseName = Convert.ToString(Request["OutHouseName"]);
            if (Convert.ToString(Request["OrderType"]) != "-1" && Request["OrderType"] != "undefined")
            {
                queryEntity.OrderType = Convert.ToString(Request["OrderType"]);
            }
            if (Convert.ToString(Request["AwbStatus"]) != "-1" && Request["AwbStatus"] != "undefined")
            {
                queryEntity.AwbStatus = Convert.ToString(Request["AwbStatus"]);
            }
            if (Convert.ToString(Request["FinanceSecondCheck"]) != "-1")
            {
                queryEntity.FinanceSecondCheck = Convert.ToString(Request["FinanceSecondCheck"]);
            }
            //ueryEntity.CheckOutType = Convert.ToString(Request["CheckOutType"]);
            //queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            if (!string.IsNullOrEmpty(Request["HouseID"]) && Request["HouseID"] != "undefined")//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            if (!string.IsNullOrEmpty(Request["SaleManID"]) && Request["SaleManID"] != "undefined")
            {
                queryEntity.SaleManID = Convert.ToString(Request["SaleManID"]);
            }
            if (Convert.ToString(Request["OrderModel"]) != "-1")
            {
                queryEntity.OrderModel = Convert.ToString(Request["OrderModel"]);
            }
            if (Convert.ToString(Request["ThrowGood"]) != "-1" && Request["ThrowGood"] != "undefined")
            {
                queryEntity.ThrowGood = Convert.ToString(Request["ThrowGood"]);
            }
            //2021-01-21 添加公司类型查询条件
            if (Convert.ToString(Request["BelongHouse"]) != "-1")
            {
                queryEntity.BelongHouse = Convert.ToString(Request["BelongHouse"]);
            }
            //2021-01-30 添加客户名称查询条件
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            //if (!string.IsNullOrEmpty(Request["FirstID"]))//一级仓库
            //{
            //    queryEntity.FirstAreaID = Convert.ToInt32(Request["FirstID"]);
            //}
            //2021-10-20 添加出库类型查询条件
            if (Convert.ToString(Request["OutCargoType"]) != "-1")
            {
                queryEntity.OutCargoType = Convert.ToString(Request["OutCargoType"]);
            }
            //2021-10-25 添加推送类型查询条件
            if (Convert.ToString(Request["PostponeShip"]) != "-1")
            {
                queryEntity.PostponeShip = Convert.ToString(Request["PostponeShip"]);
            }

            if (!string.IsNullOrEmpty(Convert.ToString(Request["LineID"])))
            {
                queryEntity.LineID = Convert.ToInt32(Request["LineID"]);
            }
            queryEntity.ShopCode = Convert.ToString(Request["ShopCode"]);
            if (!string.IsNullOrEmpty(Request["SuppClientNum"]))//一级分类
            {
                queryEntity.SuppClientNum = Convert.ToInt32(Request["SuppClientNum"]);//所属仓库ID
            }
            if (!string.IsNullOrEmpty(Request["BusinessID"]))//业务名称
            {
                queryEntity.BusinessID = Convert.ToString(Request["BusinessID"]);//业务名称
            }

            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryOrderInfo(1, 100000, queryEntity);
            if (list != null) { QueryOrderInfoList = list; }

            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        public void QueryOrderTyreCodeForExport()
        {
            QueryOrderInfoExport();
            List<string> OrderNo = new List<string>();
            var List = QueryOrderInfoList["rows"];
            string err = "OK";

            IEnumerable<object> list = List as IEnumerable<object>;

            if (list != null && list.Count() > 0)
            {
                foreach (var item in list)
                {
                    OrderNo.Add(item.GetType().GetProperty("OrderNo").GetValue(item, null).ToString());
                }
                CargoOrderBus bus = new CargoOrderBus();
                QueryOrderTyreCodeList = bus.QueryTyreCodeByOrderNo(OrderNo);
                if (QueryOrderTyreCodeList.Count() == 0)
                {
                    err = "无数据导出";
                }
            }
            else
            {
                err = "无数据导出";
            }

            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        public List<CargoContainerShowEntity> QueryOrderTyreCodeList
        {
            get
            {
                if (Session["QueryOrderTyreCodeList"] == null)
                {
                    Session["QueryOrderTyreCodeList"] = new List<CargoContainerShowEntity>();
                }
                return (List<CargoContainerShowEntity>)(Session["QueryOrderTyreCodeList"]);
            }
            set
            {
                Session["QueryOrderTyreCodeList"] = value;
            }
        }

        /// <summary>
        /// 导出
        /// </summary>
        public void QueryOrderInfoForExport()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            //查询条件
            string key = Request["key"];
            if (string.IsNullOrEmpty(key))
            {
                Response.Clear();
                Response.Write(JSON.Encode(queryEntity));
                return;
            }
            string[] arr = key.Split(',');
            for (int i = 0; i < arr.Length; i++)
            {
                switch (i)
                {
                    case 0:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.OrderNo = arr[i].Trim(); }
                        break;
                    case 1:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.AcceptPeople = arr[i].Trim(); }
                        break;
                    case 2:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.StartDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 3:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.EndDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 4:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.Dest = Convert.ToString(arr[i]); }
                        break;
                    case 5:
                        if (!string.IsNullOrEmpty(arr[i]))//所属仓库
                        {
                            queryEntity.CargoPermisID = Convert.ToString(arr[i]);//所属仓库ID
                        }
                        else
                        {
                            queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                        }
                        break;
                    case 6:
                        if (!arr[i].Equals("-1")) { queryEntity.OrderType = Convert.ToString(arr[i]); }
                        break;
                    case 7:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.SaleManID = Convert.ToString(arr[i]); }
                        break;
                    case 8:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.Piece = Convert.ToInt32(arr[i]); }
                        break;
                    case 9:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.CheckOutType = arr[i].Trim(); }
                        break;
                    case 10:
                        if (!arr[i].Equals("-1")) { queryEntity.FinanceSecondCheck = arr[i].Trim(); }
                        break;
                    case 11:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.Dep = Convert.ToString(arr[i]); }
                        break;
                    case 12:
                        if (!arr[i].Equals("-1")) { queryEntity.OrderModel = Convert.ToString(arr[i]); }
                        break;
                    case 13:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.PayClientNum = Convert.ToInt32(arr[i]); }
                        break;
                    case 14:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.SuppClientNum = Convert.ToInt32(arr[i]); }
                        break;
                    case 15:
                        if (!arr[i].Equals("-1")) { queryEntity.AwbStatus = Convert.ToString(arr[i]); }
                        break;
                    case 16:
                        if (!arr[i].Equals("-1")) { queryEntity.CheckStatus = Convert.ToString(arr[i]); }
                        break;
                    default:
                        break;
                }
            }
            //分页
            int pageIndex = 1;
            int pageSize = 100000;
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryOrderInfo(pageIndex, pageSize, queryEntity);

            string err = "OK";
            List<CargoOrderEntity> awbList = list["rows"] as List<CargoOrderEntity>;
            if (awbList.Count > 0) { CargoOrderEntityList = awbList; } else { err = "没有数据可以进行导出，请重新查询！"; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);

        }
        public List<CargoOrderEntity> CargoOrderEntityList
        {
            get
            {
                if (Session["CargoOrderEntityList"] == null)
                {
                    Session["CargoOrderEntityList"] = new List<CargoOrderEntity>();
                }
                return (List<CargoOrderEntity>)(Session["CargoOrderEntityList"]);
            }
            set
            {
                Session["CargoOrderEntityList"] = value;
            }
        }
        /// <summary>
        /// 通过订单号查询订单数据
        /// </summary>
        public void QueryOrderByOrderNo()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            //查询条件
            string key = Request["OrderNo"];
            if (string.IsNullOrEmpty(key)) { Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return; }
            queryEntity.OrderNo = key.Trim();
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoContainerShowEntity> list = bus.QueryOrderByOrderNo(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        public void UpdatePrintNum()
        {
            string OrderNo = Request["OrderNo"];
            CargoOrderBus bus = new CargoOrderBus();
            if (!string.IsNullOrWhiteSpace(OrderNo))
            {
                bus.UpdatePrintNum(new CargoOrderEntity { OrderNo = OrderNo });
            }
        }
        public void GetHouseSendTitle()
        {
            string HouseID = Request["HouseID"];
            CargoHouseBus bus = new CargoHouseBus();
            if (!string.IsNullOrWhiteSpace(HouseID))
            {
                CargoHouseEntity entity = bus.QueryCargoHouseByID(Convert.ToInt32(HouseID));
                String result = JSON.Encode(entity.SendTitle);
                Response.Clear();
                Response.Write(result);
            }
        }
        /// <summary>
        /// 查询符合规则的优惠信息
        /// </summary>
        public void QueryPriceRuleBankInfo()
        {
            string houseID = Request["HouseID"];
            string typeID = Request["TypeID"];
            string specs = Request["Specs"];
            string figure = Request["Figure"];
            string batch = Request["Batch"];
            string clientNum = Request["ClientNum"];
            if (!string.IsNullOrEmpty(batch) && !batch.Equals("0"))
            {
                string aB = batch.Substring(0, 2);
                string bB = batch.Substring(2, batch.Length - 2);
                batch = bB + aB;
            }
            if (!string.IsNullOrEmpty(houseID) && !string.IsNullOrEmpty(typeID))
            {
                CargoOrderEntity entity = new CargoOrderEntity();
                entity.HouseID = Convert.ToInt32(houseID);
                entity.TypeID = Convert.ToInt32(typeID);
                entity.ClientNum = Convert.ToInt32(clientNum);
                CargoPriceBus bus = new CargoPriceBus();
                DataTable dt = bus.QueryPriceRuleBankInfo(entity);
                PriceRuleReturnEntity prrEnter = new PriceRuleReturnEntity();
                string res = "<div style='text-align: left;'>可使用优惠：</div><div id='rule' class='easyui-tabs' style='width: 100%; height: 180px;'>";
                #region 限购
                bool quotaNumType = false;
                int QuotaNum = -1;
                string QuotaSpecs = "";
                string QuotaFigure = "";
                int QuotaStartBatch = -1;
                int QuotaEndBatch = -1;
                //规格、花纹、周期匹配
                DataRow[] rows = dt.Select("RuleType=4 and Specs='" + specs + "' and Figure='" + figure + "' and StartBatch <=" + batch + " and EndBatch >=" + batch);
                for (int i = 0; i < rows.Count(); i++)
                {
                    res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "</td><td style='text-align: right;'><input type='hidden' id='LimitNum' value='" + rows[i]["LimitNum"] + "' /><input type='hidden' id='LimitID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='LimitTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='4' /></td></tr><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;' colspan='2'>" + rows[i]["Figure"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    QuotaNum = Convert.ToInt32(rows[i]["LimitNum"]);
                    QuotaSpecs = rows[i]["Specs"].ToString();
                    QuotaFigure = rows[i]["Figure"].ToString();
                    QuotaStartBatch = Convert.ToInt32(rows[i]["StartBatch"]);
                    QuotaEndBatch = Convert.ToInt32(rows[i]["EndBatch"]);
                    entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                    entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                    dt.Rows.Remove(rows[i]);
                    int num = 0;
                    DataTable oridt = bus.QueryClientOrderInfo(entity);
                    DataRow[] orirows = oridt.Select("Specs='" + specs + "' and Figure='" + figure + "' and Batch >=" + QuotaStartBatch + " and Batch <=" + QuotaEndBatch);
                    for (int j = 0; j < orirows.Count(); j++)
                    {
                        num += Convert.ToInt32(orirows[j]["Piece"]);
                    }
                    QuotaNum = QuotaNum - num;
                    quotaNumType = true;
                    break;
                }
                //规格、花纹匹配
                if (!quotaNumType)
                {
                    rows = dt.Select("RuleType=4 and Specs='" + specs + "' and Figure='" + figure + "'");
                    for (int i = 0; i < rows.Count(); i++)
                    {
                        res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "</td><td style='text-align: right;'><input type='hidden' id='LimitNum' value='" + rows[i]["LimitNum"] + "' /><input type='hidden' id='LimitID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='LimitTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='4' /></td></tr><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;' colspan='2'>" + rows[i]["Figure"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                        QuotaNum = Convert.ToInt32(rows[i]["LimitNum"]);
                        QuotaSpecs = rows[i]["Specs"].ToString();
                        QuotaFigure = rows[i]["Figure"].ToString();
                        entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                        entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                        dt.Rows.Remove(rows[i]);
                        int num = 0;
                        DataTable oridt = bus.QueryClientOrderInfo(entity);
                        DataRow[] orirows = oridt.Select("Specs='" + specs + "' and Figure='" + figure + "'");
                        for (int j = 0; j < orirows.Count(); j++)
                        {
                            num += Convert.ToInt32(orirows[j]["Piece"]);
                        }
                        QuotaNum = QuotaNum - num;
                        quotaNumType = true;
                        break;
                    }
                }
                //规格、周期匹配
                if (!quotaNumType)
                {
                    rows = dt.Select("RuleType=4 and Specs='" + specs + "' and StartBatch <=" + batch + " and EndBatch >=" + batch);
                    for (int i = 0; i < rows.Count(); i++)
                    {
                        res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "</td><td style='text-align: right;'><input type='hidden' id='LimitNum' value='" + rows[i]["LimitNum"] + "' /><input type='hidden' id='LimitID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='LimitTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='4' /></td></tr><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                        QuotaNum = Convert.ToInt32(rows[i]["LimitNum"]);
                        QuotaSpecs = rows[i]["Specs"].ToString();
                        QuotaStartBatch = Convert.ToInt32(rows[i]["StartBatch"]);
                        QuotaEndBatch = Convert.ToInt32(rows[i]["EndBatch"]);
                        entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                        entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                        dt.Rows.Remove(rows[i]);
                        int num = 0;
                        DataTable oridt = bus.QueryClientOrderInfo(entity);
                        DataRow[] orirows = oridt.Select("Specs='" + specs + "' and Batch >=" + QuotaStartBatch + " and Batch <=" + QuotaEndBatch);
                        for (int j = 0; j < orirows.Count(); j++)
                        {
                            num += Convert.ToInt32(orirows[j]["Piece"]);
                        }
                        QuotaNum = QuotaNum - num;
                        quotaNumType = true;
                        break;
                    }
                }
                //花纹、周期匹配
                if (!quotaNumType)
                {
                    rows = dt.Select("RuleType=4 and Figure='" + figure + "' and StartBatch <=" + batch + " and EndBatch >=" + batch);
                    for (int i = 0; i < rows.Count(); i++)
                    {
                        res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;'>" + rows[i]["Figure"] + "</td><td style='text-align: right;'><input type='hidden' id='LimitNum' value='" + rows[i]["LimitNum"] + "' /><input type='hidden' id='LimitID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='LimitTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='4' /></td></tr><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                        QuotaNum = Convert.ToInt32(rows[i]["LimitNum"]);
                        QuotaFigure = rows[i]["Figure"].ToString();
                        QuotaStartBatch = Convert.ToInt32(rows[i]["StartBatch"]);
                        QuotaEndBatch = Convert.ToInt32(rows[i]["EndBatch"]);
                        entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                        entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                        dt.Rows.Remove(rows[i]);
                        int num = 0;
                        DataTable oridt = bus.QueryClientOrderInfo(entity);
                        DataRow[] orirows = oridt.Select("Figure='" + figure + "' and Batch >=" + QuotaStartBatch + " and Batch <=" + QuotaEndBatch);
                        for (int j = 0; j < orirows.Count(); j++)
                        {
                            num += Convert.ToInt32(orirows[j]["Piece"]);
                        }
                        QuotaNum = QuotaNum - num;
                        quotaNumType = true;
                        break;
                    }
                }
                //规格匹配
                if (!quotaNumType)
                {
                    rows = dt.Select("RuleType=4 and Specs='" + specs + "'");
                    for (int i = 0; i < rows.Count(); i++)
                    {
                        res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "</td><td style='text-align: right;'><input type='hidden' id='LimitNum' value='" + rows[i]["LimitNum"] + "' /><input type='hidden' id='LimitID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='LimitTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='4' /></td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                        QuotaNum = Convert.ToInt32(rows[i]["LimitNum"]);
                        QuotaSpecs = rows[i]["Specs"].ToString();
                        entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                        entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                        dt.Rows.Remove(rows[i]);
                        int num = 0;
                        DataTable oridt = bus.QueryClientOrderInfo(entity);
                        DataRow[] orirows = oridt.Select("Specs='" + specs + "'");
                        for (int j = 0; j < orirows.Count(); j++)
                        {
                            num += Convert.ToInt32(orirows[j]["Piece"]);
                        }
                        QuotaNum = QuotaNum - num;
                        quotaNumType = true;
                        break;
                    }
                }
                //花纹匹配
                if (!quotaNumType)
                {
                    rows = dt.Select("RuleType=4 and Figure='" + figure + "'");
                    for (int i = 0; i < rows.Count(); i++)
                    {
                        res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;'>" + rows[i]["Figure"] + "</td><td style='text-align: right;'><input type='hidden' id='LimitNum' value='" + rows[i]["LimitNum"] + "' /><input type='hidden' id='LimitID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='LimitTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='4' /></td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                        QuotaNum = Convert.ToInt32(rows[i]["LimitNum"]);
                        QuotaFigure = rows[i]["Figure"].ToString();
                        entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                        entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                        dt.Rows.Remove(rows[i]);
                        int num = 0;
                        DataTable oridt = bus.QueryClientOrderInfo(entity);
                        DataRow[] orirows = oridt.Select("Figure='" + figure + "'");
                        for (int j = 0; j < orirows.Count(); j++)
                        {
                            num += Convert.ToInt32(orirows[j]["Piece"]);
                        }
                        QuotaNum = QuotaNum - num;
                        quotaNumType = true;
                        break;
                    }
                }
                //周期匹配
                if (!quotaNumType)
                {
                    rows = dt.Select("RuleType=4 and StartBatch <=" + batch + " and EndBatch >=" + batch);
                    for (int i = 0; i < rows.Count(); i++)
                    {
                        res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td><td style='text-align: right;'><input type='hidden' id='LimitNum' value='" + rows[i]["LimitNum"] + "' /><input type='hidden' id='LimitID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='LimitTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='4' /></td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                        QuotaNum = Convert.ToInt32(rows[i]["LimitNum"]);
                        QuotaStartBatch = Convert.ToInt32(rows[i]["StartBatch"]);
                        QuotaEndBatch = Convert.ToInt32(rows[i]["EndBatch"]);
                        entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                        entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                        dt.Rows.Remove(rows[i]);
                        int num = 0;
                        DataTable oridt = bus.QueryClientOrderInfo(entity);
                        DataRow[] orirows = oridt.Select("Batch >=" + QuotaStartBatch + " and Batch <=" + QuotaEndBatch);
                        for (int j = 0; j < orirows.Count(); j++)
                        {
                            num += Convert.ToInt32(orirows[j]["Piece"]);
                        }
                        QuotaNum = QuotaNum - num;
                        quotaNumType = true;
                        break;
                    }
                }
                #endregion

                #region 满赠
                bool FullDiscountType = false;
                int FullDiscountSum = -1;
                string FullDiscountSpecs = "";
                string FullDiscountFigure = "";
                int FullDiscountStartBatch = -1;
                int FullDiscountEndBatch = -1;
                //规格、花纹、周期匹配
                rows = dt.Select("RuleType=1 and Specs='" + specs + "' and Figure='" + figure + "' and StartBatch <=" + batch + " and EndBatch >=" + batch);
                for (int i = 0; i < rows.Count(); i++)
                {
                    res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "</td><td style='text-align: right;'><input type='hidden' id='FullDiscountFull' value='" + rows[i]["FullEntry"] + "' /><input type='hidden' id='FullDiscountCut' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='FullDiscountID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='FullDiscountTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='1' /></td></tr><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;' colspan='2'>" + rows[i]["Figure"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    FullDiscountSum = 0;
                    FullDiscountSpecs = rows[i]["Specs"].ToString();
                    FullDiscountFigure = rows[i]["Figure"].ToString();
                    FullDiscountStartBatch = Convert.ToInt32(rows[i]["StartBatch"]);
                    FullDiscountEndBatch = Convert.ToInt32(rows[i]["EndBatch"]);
                    entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                    entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                    dt.Rows.Remove(rows[i]);
                    int num = 0;
                    DataTable oridt = bus.QueryClientOrderInfo(entity);
                    DataRow[] orirows = oridt.Select("Specs='" + specs + "' and Figure='" + figure + "' and Batch >=" + FullDiscountStartBatch + " and Batch <=" + FullDiscountEndBatch);
                    for (int j = 0; j < orirows.Count(); j++)
                    {
                        num += Convert.ToInt32(orirows[j]["Piece"]);
                    }
                    FullDiscountSum = FullDiscountSum + num;
                    FullDiscountType = true;
                    break;
                }
                //规格、花纹匹配
                if (!FullDiscountType)
                {
                    rows = dt.Select("RuleType=1 and Specs='" + specs + "' and Figure='" + figure + "'");
                    for (int i = 0; i < rows.Count(); i++)
                    {
                        res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "</td><td style='text-align: right;'><input type='hidden' id='FullDiscountFull' value='" + rows[i]["FullEntry"] + "' /><input type='hidden' id='FullDiscountCut' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='FullDiscountID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='FullDiscountTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='1' /></td></tr><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;' colspan='2'>" + rows[i]["Figure"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                        FullDiscountSum = 0;
                        FullDiscountSpecs = rows[i]["Specs"].ToString();
                        FullDiscountFigure = rows[i]["Figure"].ToString();
                        entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                        entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                        dt.Rows.Remove(rows[i]);
                        int num = 0;
                        DataTable oridt = bus.QueryClientOrderInfo(entity);
                        DataRow[] orirows = oridt.Select("Specs='" + specs + "' and Figure='" + figure + "'");
                        for (int j = 0; j < orirows.Count(); j++)
                        {
                            num += Convert.ToInt32(orirows[j]["Piece"]);
                        }
                        FullDiscountSum = FullDiscountSum + num;
                        FullDiscountType = true;
                        break;
                    }
                }
                //规格、周期匹配
                if (!FullDiscountType)
                {
                    rows = dt.Select("RuleType=1 and Specs='" + specs + "' and StartBatch <=" + batch + " and EndBatch >=" + batch);
                    for (int i = 0; i < rows.Count(); i++)
                    {
                        res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "</td><td style='text-align: right;'><input type='hidden' id='FullDiscountFull' value='" + rows[i]["FullEntry"] + "' /><input type='hidden' id='FullDiscountCut' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='FullDiscountID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='FullDiscountTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='1' /></td></tr><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                        FullDiscountSum = 0;
                        FullDiscountSpecs = rows[i]["Specs"].ToString();
                        FullDiscountStartBatch = Convert.ToInt32(rows[i]["StartBatch"]);
                        FullDiscountEndBatch = Convert.ToInt32(rows[i]["EndBatch"]);
                        entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                        entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                        dt.Rows.Remove(rows[i]);
                        int num = 0;
                        DataTable oridt = bus.QueryClientOrderInfo(entity);
                        DataRow[] orirows = oridt.Select("Specs='" + specs + "' and Batch >=" + FullDiscountStartBatch + " and Batch <=" + FullDiscountEndBatch);
                        for (int j = 0; j < orirows.Count(); j++)
                        {
                            num += Convert.ToInt32(orirows[j]["Piece"]);
                        }
                        FullDiscountSum = FullDiscountSum + num;
                        FullDiscountType = true;
                        break;
                    }
                }
                //花纹、周期匹配
                if (!FullDiscountType)
                {
                    rows = dt.Select("RuleType=1 and Figure='" + figure + "' and StartBatch <=" + batch + " and EndBatch >=" + batch);
                    for (int i = 0; i < rows.Count(); i++)
                    {
                        res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;'>" + rows[i]["Figure"] + "</td><td style='text-align: right;'><input type='hidden' id='FullDiscountFull' value='" + rows[i]["FullEntry"] + "' /><input type='hidden' id='FullDiscountCut' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='FullDiscountID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='FullDiscountTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='1' /></td></tr><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                        FullDiscountSum = 0;
                        FullDiscountFigure = rows[i]["Figure"].ToString();
                        FullDiscountStartBatch = Convert.ToInt32(rows[i]["StartBatch"]);
                        FullDiscountEndBatch = Convert.ToInt32(rows[i]["EndBatch"]);
                        entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                        entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                        dt.Rows.Remove(rows[i]);
                        int num = 0;
                        DataTable oridt = bus.QueryClientOrderInfo(entity);
                        DataRow[] orirows = oridt.Select("Figure='" + figure + "' and Batch >=" + FullDiscountStartBatch + " and Batch <=" + FullDiscountEndBatch);
                        for (int j = 0; j < orirows.Count(); j++)
                        {
                            num += Convert.ToInt32(orirows[j]["Piece"]);
                        }
                        FullDiscountSum = FullDiscountSum + num;
                        FullDiscountType = true;
                        break;
                    }
                }
                //规格匹配
                if (!FullDiscountType)
                {
                    rows = dt.Select("RuleType=1 and Specs='" + specs + "'");
                    for (int i = 0; i < rows.Count(); i++)
                    {
                        res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "</td><td style='text-align: right;'><input type='hidden' id='FullDiscountFull' value='" + rows[i]["FullEntry"] + "' /><input type='hidden' id='FullDiscountCut' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='FullDiscountID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='FullDiscountTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='1' /></td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                        FullDiscountSum = 0;
                        FullDiscountSpecs = rows[i]["Specs"].ToString();
                        entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                        entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                        dt.Rows.Remove(rows[i]);
                        int num = 0;
                        DataTable oridt = bus.QueryClientOrderInfo(entity);
                        DataRow[] orirows = oridt.Select("Specs='" + specs + "'");
                        for (int j = 0; j < orirows.Count(); j++)
                        {
                            num += Convert.ToInt32(orirows[j]["Piece"]);
                        }
                        FullDiscountSum = FullDiscountSum + num;
                        FullDiscountType = true;
                        break;
                    }
                }
                //花纹匹配
                if (!FullDiscountType)
                {
                    rows = dt.Select("RuleType=1 and Figure='" + figure + "'");
                    for (int i = 0; i < rows.Count(); i++)
                    {
                        res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;'>" + rows[i]["Figure"] + "</td><td style='text-align: right;'><input type='hidden' id='FullDiscountFull' value='" + rows[i]["FullEntry"] + "' /><input type='hidden' id='FullDiscountCut' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='FullDiscountID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='FullDiscountTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='1' /></td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                        FullDiscountSum = 0;
                        FullDiscountFigure = rows[i]["Figure"].ToString();
                        entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                        entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                        dt.Rows.Remove(rows[i]);
                        int num = 0;
                        DataTable oridt = bus.QueryClientOrderInfo(entity);
                        DataRow[] orirows = oridt.Select("Figure='" + figure + "'");
                        for (int j = 0; j < orirows.Count(); j++)
                        {
                            num += Convert.ToInt32(orirows[j]["Piece"]);
                        }
                        FullDiscountSum = FullDiscountSum + num;
                        FullDiscountType = true;
                        break;
                    }
                }
                //周期匹配
                if (!FullDiscountType)
                {
                    rows = dt.Select("RuleType=1 and StartBatch <=" + batch + " and EndBatch >=" + batch);
                    for (int i = 0; i < rows.Count(); i++)
                    {
                        res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td><td style='text-align: right;'><input type='hidden' id='FullDiscountFull' value='" + rows[i]["FullEntry"] + "' /><input type='hidden' id='FullDiscountCut' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='FullDiscountID' value='" + rows[i]["ID"] + "' /><input type='hidden' id='FullDiscountTitle' value='" + rows[i]["Title"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='1' /></td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                        FullDiscountSum = 0;
                        FullDiscountStartBatch = Convert.ToInt32(rows[i]["StartBatch"]);
                        FullDiscountEndBatch = Convert.ToInt32(rows[i]["EndBatch"]);
                        entity.StartDate = Convert.ToDateTime(rows[i]["StartDate"]);
                        entity.EndDate = Convert.ToDateTime(rows[i]["EndDate"]);
                        dt.Rows.Remove(rows[i]);
                        int num = 0;
                        DataTable oridt = bus.QueryClientOrderInfo(entity);
                        DataRow[] orirows = oridt.Select("Batch >=" + FullDiscountStartBatch + " and Batch <=" + FullDiscountEndBatch);
                        for (int j = 0; j < orirows.Count(); j++)
                        {
                            num += Convert.ToInt32(orirows[j]["Piece"]);
                        }
                        FullDiscountSum = FullDiscountSum + num;
                        FullDiscountType = true;
                        break;
                    }
                }
                #endregion
                #region 直减优惠
                //规格、花纹、周期匹配
                rows = dt.Select("RuleType=6 and Specs='" + specs + "' and Figure='" + figure + "' and StartBatch <=" + batch + " and EndBatch >=" + batch);
                for (int i = 0; i < rows.Count(); i++)
                {
                    res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "<div style='float: right;margin-top: -20px;'>使用<input class='RuleBankCheck' type='checkbox' id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' style='zoom: 200%;' /></div><input type='hidden' id='CutTitle" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /><input type='hidden' id='CutEntry" + rows[i]["ID"] + "' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='6' /></td></tr><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;' colspan='2'>" + rows[i]["Figure"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    //res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "</td><td style='text-align: right;'>使用<input class='RuleBankCheck' type='checkbox' id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /></td></tr><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;' colspan='2'>" + rows[i]["Figure"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    dt.Rows.Remove(rows[i]);
                }
                //规格、花纹匹配
                rows = dt.Select("RuleType=6 and Specs='" + specs + "' and Figure='" + figure + "' and StartBatch=0 and EndBatch=0");
                for (int i = 0; i < rows.Count(); i++)
                {
                    res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "<div style='float: right;margin-top: -20px;'>使用<input class='RuleBankCheck' type='checkbox' id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' style='zoom: 200%;' /></div><input type='hidden' id='CutTitle" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /><input type='hidden' id='CutEntry" + rows[i]["ID"] + "' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='6' /></td></tr><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;' colspan='2'>" + rows[i]["Figure"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    //res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "</td><td style='text-align: right;'>使用<input class='RuleBankCheck' type='checkbox'  id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /></td></tr><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;' colspan='2'>" + rows[i]["Figure"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    dt.Rows.Remove(rows[i]);
                }
                //规格、周期匹配
                rows = dt.Select("RuleType=6 and Specs='" + specs + "' and StartBatch <=" + batch + " and EndBatch >=" + batch + " and Figure=''");
                for (int i = 0; i < rows.Count(); i++)
                {
                    res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "<div style='float: right;margin-top: -20px;'>使用<input class='RuleBankCheck' type='checkbox' id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' style='zoom: 200%;' /></div><input type='hidden' id='CutTitle" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /><input type='hidden' id='CutEntry" + rows[i]["ID"] + "' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='6' /></td></tr><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    //res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "</td><td style='text-align: right;'>使用<input class='RuleBankCheck' type='checkbox' id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /></td></tr><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    dt.Rows.Remove(rows[i]);
                }
                //花纹、周期匹配
                rows = dt.Select("RuleType=6 and Figure='" + figure + "' and StartBatch <=" + batch + " and EndBatch >=" + batch + " and Specs=''");
                for (int i = 0; i < rows.Count(); i++)
                {
                    res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;' >" + rows[i]["Figure"] + "<div style='float: right;margin-top: -20px;'>使用<input class='RuleBankCheck' type='checkbox' id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' style='zoom: 200%;' /></div><input type='hidden' id='CutTitle" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /><input type='hidden' id='CutEntry" + rows[i]["ID"] + "' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='6' /></td></tr><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    //res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;'>" + rows[i]["Figure"] + "</td><td style='text-align: right;'>使用<input class='RuleBankCheck' type='checkbox' id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /></td></tr><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    dt.Rows.Remove(rows[i]);
                }
                //规格匹配
                rows = dt.Select("RuleType=6 and Specs='" + specs + "' and Figure='' and StartBatch=0 and EndBatch=0");
                for (int i = 0; i < rows.Count(); i++)
                {
                    res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "<div style='float: right;margin-top: -20px;'>使用<input class='RuleBankCheck' type='checkbox' id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' style='zoom: 200%;' /></div><input type='hidden' id='CutTitle" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /><input type='hidden' id='CutEntry" + rows[i]["ID"] + "' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='6' /></td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    //res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>规格：</td><td style='text-align: left;' >" + rows[i]["Specs"] + "</td><td style='text-align: right;'>使用<input class='RuleBankCheck' type='checkbox'  id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /></td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    dt.Rows.Remove(rows[i]);
                }
                //花纹匹配
                rows = dt.Select("RuleType=6 and Figure='" + figure + "' and Specs='' and StartBatch=0 and EndBatch=0");
                for (int i = 0; i < rows.Count(); i++)
                {
                    res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;' >" + rows[i]["Figure"] + "<div style='float: right;margin-top: -20px;'>使用<input class='RuleBankCheck' type='checkbox' id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' style='zoom: 200%;' /></div><input type='hidden' id='CutTitle" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /><input type='hidden' id='CutEntry" + rows[i]["ID"] + "' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='6' /></td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    //res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>花纹：</td><td style='text-align: left;'>" + rows[i]["Figure"] + "</td><td style='text-align: right;'>使用<input class='RuleBankCheck' type='checkbox'  id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /></td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    dt.Rows.Remove(rows[i]);
                }
                //周期匹配
                rows = dt.Select("RuleType=6 and StartBatch <=" + batch + " and EndBatch >=" + batch + " and Specs='' and Figure=''");
                for (int i = 0; i < rows.Count(); i++)
                {

                    res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;' colspan='2'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "<div style='float: right;margin-top: -20px;'>使用<input class='RuleBankCheck' type='checkbox' id='" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' style='zoom: 200%;' /></div><input type='hidden' id='CutTitle" + rows[i]["ID"] + "' value='" + rows[i]["Title"] + "' /><input type='hidden' id='CutEntry" + rows[i]["ID"] + "' value='" + rows[i]["CutEntry"] + "' /><input type='hidden' id='RuleType" + rows[i]["ID"] + "' value='6' /></td></tr></table></div>";
                    //res += "<div title='" + rows[i]["Title"] + "' style='padding: 20px;'><table style='width: 100%;'><tr><td style='text-align: right;width: 40px;'>批次：</td><td style='text-align: left;'>" + rows[i]["StartBatch"] + "---" + rows[i]["EndBatch"] + "</td><td style='text-align: right;'>使用<input class='RuleBankCheck' type='checkbox' id='" + rows[i]["Title"] + "' value='" + rows[i]["ID"] + "' /></td></tr><tr><td style='text-align: right;width: 40px;'>期限：</td><td style='text-align: left;' colspan='2'>" + Convert.ToDateTime(rows[i]["StartDate"]).ToString("yyyy-MM-dd") + "---" + Convert.ToDateTime(rows[i]["EndDate"]).ToString("yyyy-MM-dd") + "</td></tr></table></div>";
                    dt.Rows.Remove(rows[i]);
                }
                #endregion
                res += "</div>";
                prrEnter.Html = res;
                prrEnter.QuotaNum = QuotaNum;
                prrEnter.QuotaSpecs = QuotaSpecs;
                prrEnter.QuotaFigure = QuotaFigure;
                prrEnter.QuotaStartBatch = QuotaStartBatch;
                prrEnter.QuotaEndBatch = QuotaEndBatch;
                prrEnter.FullDiscountSum = FullDiscountSum;
                prrEnter.FullDiscountSpecs = FullDiscountSpecs;
                prrEnter.FullDiscountFigure = FullDiscountFigure;
                prrEnter.FullDiscountStartBatch = FullDiscountStartBatch;
                prrEnter.FullDiscountEndBatch = FullDiscountEndBatch;
                String json = JSON.Encode(prrEnter);
                Response.Write(json);
            }
        }
        /// <summary>
        /// 查询指定ID的优惠细则
        /// </summary>
        public void QueryPriceRuleBankInfoToID()
        {
            string clientNum = Request["ClientNum"];
            string ruleID = Request["RuleID"];
            string ruleType = Request["RuleType"];
            string houseID = Request["HouseID"];
            string typeID = Request["TypeID"];
            string specs = Request["Specs"];
            string figure = Request["Figure"];
            string batch = Request["Batch"];
            string OrderNo = Request["OrderNo"];
            RuleBankReturnEntity rbrEntity = new RuleBankReturnEntity();
            try
            {
                if (!string.IsNullOrEmpty(ruleID))
                {
                    RuleBankReturnEntity entity = new RuleBankReturnEntity();
                    entity.RuleID = ruleID;
                    CargoPriceBus bus = new CargoPriceBus();
                    List<CargoRuleBankEntity> list = bus.QueryPriceRuleBankInfoToID(entity);
                    CargoOrderEntity orEntity = new CargoOrderEntity();
                    orEntity.HouseID = Convert.ToInt32(houseID);
                    orEntity.TypeID = Convert.ToInt32(typeID);
                    orEntity.ClientNum = Convert.ToInt32(clientNum);
                    rbrEntity.Result = true;
                    foreach (var item in list)
                    {
                        if (item.RuleType == ruleType)
                        {
                            switch (item.RuleType)
                            {
                                case "0":
                                    rbrEntity.RuleType = "0";
                                    rbrEntity.RuleContent = item.FullEntry.ToString();
                                    rbrEntity.RuleID = Convert.ToString(item.ID);
                                    rbrEntity.RuleTitle = item.Title;
                                    break;
                                case "1":
                                    rbrEntity.RuleType = "1";
                                    rbrEntity.RuleContent = item.ProductID.ToString();
                                    rbrEntity.RuleID = Convert.ToString(item.ID);
                                    rbrEntity.RuleTitle = item.Title;
                                    break;
                                case "2":
                                    rbrEntity.RuleType = "2";
                                    rbrEntity.RuleContent = item.SaleEntry.ToString();
                                    rbrEntity.RuleID = Convert.ToString(item.ID);
                                    rbrEntity.RuleTitle = item.Title;
                                    break;
                                case "3":
                                    rbrEntity.RuleType = "3";
                                    rbrEntity.RuleContent = item.ProductID.ToString();
                                    rbrEntity.RuleID = Convert.ToString(item.ID);
                                    rbrEntity.RuleTitle = item.Title;
                                    break;
                                case "4":
                                    int num = 0;
                                    orEntity.StartDate = item.StartDate;
                                    orEntity.EndDate = item.EndDate;
                                    orEntity.OrderNo = OrderNo;
                                    DataTable oridt = bus.QueryClientOrderInfo(orEntity);
                                    string str = "1=1";
                                    if (!string.IsNullOrEmpty(item.Specs))
                                    {
                                        str += " and Specs='" + item.Specs + "'";
                                    }
                                    if (!string.IsNullOrEmpty(item.Figure))
                                    {
                                        str += " and Figure='" + item.Figure + "'";
                                    }
                                    if (item.StartBatch != 0)
                                    {
                                        str += " and Batch >=" + item.StartBatch + " and Batch <=" + item.EndBatch;
                                    }
                                    DataRow[] orirows = oridt.Select(str);
                                    for (int j = 0; j < orirows.Count(); j++)
                                    {
                                        num += Convert.ToInt32(orirows[j]["Piece"]);
                                    }
                                    rbrEntity.RuleType = "4";
                                    rbrEntity.RuleContent = (item.LimitNum - num).ToString();
                                    rbrEntity.RuleID = Convert.ToString(item.ID);
                                    rbrEntity.RuleTitle = item.Title;
                                    break;
                                case "6":
                                    rbrEntity.RuleType = "6";
                                    rbrEntity.RuleContent = item.CutEntry.ToString();
                                    rbrEntity.RuleID = Convert.ToString(item.ID);
                                    rbrEntity.RuleTitle = item.Title;
                                    break;
                            }
                        }
                    }
                }
            }
            catch (ApplicationException ex)
            {
                rbrEntity.Result = false;
                rbrEntity.RuleType = "-1";
                rbrEntity.RuleContent = ex.Message;
            }
            //返回处理结果
            string res = JSON.Encode(rbrEntity);
            Response.Write(res);

        }

        /// <summary>
        /// 删除订单
        /// </summary>
        public void DelOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoOrderEntity> list = new List<CargoOrderEntity>();
            List<CargoOrderEntity> Oeslist = new List<CargoOrderEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            bool HlyOrder = false;
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "订单管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            int HouseID = 0;

            if (!UserInfor.IsDelOrder.Equals("1"))
            {
                msg.Message = "您没有删除订单权限";
                msg.Result = false;
                goto ERROR;
            }
            try
            {
                foreach (Hashtable row in rows)
                {
                    CargoOrderEntity ord = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = Convert.ToString(row["OrderNo"]) });
                    HouseID = ord.HouseID;
                    if (HouseID != 0)
                    {
                        //if (ord.OrderType.Equals("2"))
                        //{
                        //    msg.Message = "微信商城订单，不允许删除";
                        //    msg.Result = false;
                        //    break;
                        //}
                        if (ord.FinanceSecondCheck.Equals("1"))
                        {
                            if (ord.ThrowGood.Equals("21"))
                            {
                                TimeSpan hoursSpan = new TimeSpan(DateTime.Now.Ticks - ord.CreateDate.Ticks);
                                if (hoursSpan.TotalHours <= 10)
                                {
                                    msg.Message = "订货单下单10小时后才可删除";
                                    msg.Result = false;
                                    break;
                                }
                            }
                            else
                            {
                                msg.Message = "财务已审核，不允许删除";
                                msg.Result = false;
                                break;
                            }
                        }
                        if (ord.CheckStatus.Equals("1"))
                        {
                            msg.Message = Convert.ToString(row["OrderNo"]) + "已结清，不允许删除";
                            msg.Result = false;
                            break;
                        }
                        if (ord.CheckStatus.Equals("2"))
                        {
                            msg.Message = Convert.ToString(row["OrderNo"]) + "结算中，不允许删除";
                            msg.Result = false;
                            break;
                        }
                        if (ord.AwbStatus != "0")
                        {
                            if (UserInfor.LoginName != "1000" && UserInfor.LoginName != "3080")
                            {
                                msg.Message = Convert.ToString(row["OrderNo"]) + "已出库，不允许删除";
                                msg.Result = false;
                                break;
                            }
                        }
                        if (bus.QueryOrderApprovalOrNot(row["OrderNo"].ToString().Trim()))
                        {
                            msg.Message = Convert.ToString(row["OrderNo"]) + "正在审批，不允许删除";
                            msg.Result = false;
                            break;
                        }
                        if (ord.HouseID.Equals(9) || ord.HouseID.Equals(15) || ord.HouseID.Equals(49) || ord.HouseID.Equals(50) || ord.HouseID.Equals(51) || ord.HouseID.Equals(52) || ord.HouseID.Equals(53) || ord.HouseID.Equals(54) || ord.HouseID.Equals(93) || ord.TrafficType == "2")
                        {
                            //if (ord.HouseID.Equals(9) || ord.HouseID.Equals(93))
                            //{
                            //    string jsonString = "{\"PlanOrderNo\": \"" + ord.PlanOrderNo + "\"}";
                            //    string hlyres = wxHttpUtility.SendHttpRequest(Common.GetHLYAPI() + "/api/CargoInterface/getByOrderNo", jsonString, "application/json");
                            //    JavaScriptSerializer js = new JavaScriptSerializer();
                            //    HLYgetByOrderNoReturn HLYReturn = js.Deserialize<HLYgetByOrderNoReturn>(hlyres);
                            //    if (!HLYReturn.State)
                            //    {
                            //        msg.Message = Convert.ToString(row["OrderNo"]) + "无法删除，好来运系统" + HLYReturn.Errmsg;
                            //        msg.Result = false;
                            //        break;
                            //    }
                            //}
                            //else
                            //{

                            //}
                            HlyOrder = true;
                            CargoOrderEntity hlyOrder = bus.QueryHlyOrderData(ord.OrderNo);
                            if (!string.IsNullOrEmpty(hlyOrder.AwbStatus) && hlyOrder.AwbStatus.Equals("已开单"))
                            {
                                msg.Message = Convert.ToString(row["OrderNo"]) + "好来运系统已开单，请联系系统人员删除";
                                msg.Result = false;
                                break;
                            }
                        }
                    }
                    else
                    {
                        if (row["HouseID"].ToString() != "47")
                        {
                            msg.Message = Convert.ToString(row["OrderNo"]) + "未查询到订单数据";
                            msg.Result = false;
                            break;
                        }
                    }
                    list.Add(new CargoOrderEntity
                    {
                        OrderID = Convert.ToInt64(row["OrderID"]),
                        OrderNo = Convert.ToString(row["OrderNo"]),
                        Dep = Convert.ToString(row["Dep"]),
                        Dest = Convert.ToString(row["Dest"]),
                        Piece = Convert.ToInt32(row["Piece"]),
                        TransportFee = Convert.ToDecimal(row["TransportFee"]),
                        TransitFee = Convert.ToDecimal(row["TransitFee"]),
                        DeliveryFee = Convert.ToDecimal(row["DeliveryFee"]),
                        InsuranceFee = Convert.ToDecimal(row["InsuranceFee"]),
                        OtherFee = Convert.ToDecimal(row["OtherFee"]),
                        TotalCharge = Convert.ToDecimal(row["TotalCharge"]),
                        AcceptUnit = Convert.ToString(row["AcceptUnit"]),
                        AcceptPeople = Convert.ToString(row["AcceptPeople"]),
                        AcceptTelephone = Convert.ToString(row["AcceptTelephone"]),
                        AcceptCellphone = Convert.ToString(row["AcceptCellphone"]),
                        AcceptAddress = Convert.ToString(row["AcceptAddress"]),
                        SaleManName = Convert.ToString(row["SaleManName"]),
                        CreateAwb = Convert.ToString(row["CreateAwb"]),
                        CreateAwbID = UserInfor.LoginName,
                        CreateDate = Convert.ToDateTime(row["CreateDate"]),
                        LogisAwbNo = Convert.ToString(row["LogisAwbNo"]),
                        LogisticName = Convert.ToString(row["LogisticName"]),
                        WXOrderNo = Convert.ToString(row["WXOrderNo"]),
                        OutHouseName = Convert.ToString(row["OutHouseName"]),
                        Remark = Convert.ToString(row["Remark"]),
                        ThrowGood = Convert.ToString(row["ThrowGood"]),
                        HouseID = HouseID,
                        TrafficType = Convert.ToString(row["TrafficType"]),
                        OpenOrderNo = Convert.ToString(row["OpenOrderNo"]),
                        OpenOrderSource = Convert.ToString(row["OpenOrderSource"]),
                        DeleteID = UserInfor.LoginName,
                        DeleteName = UserInfor.UserName,
                        LogisID = Convert.ToInt32(row["LogisID"])
                    });
                    if (Convert.ToString(row["TrafficType"]).Equals("2") && ord.PostponeShip.Equals("2"))
                    {
                        List<CargoContainerShowEntity> oesOrder = bus.QueryOesPreOrderByOrderNo(new CargoOrderEntity { OrderNo = ord.OrderNo });
                        string good = string.Empty;
                        foreach (var oes in oesOrder)
                        {
                            good += "品牌：" + oes.TypeName + "，规格：" + oes.Specs + "，" + oes.Figure + "，" + oes.LoadIndex + oes.SpeedLevel + "，数量：" + oes.Piece.ToString() + " |";
                        }
                        Oeslist.Add(new CargoOrderEntity
                        {
                            OrderNo = ord.OrderNo,
                            OutHouseName = ord.OutHouseName,
                            HouseID = ord.HouseID,
                            TrafficType = ord.TrafficType,
                            Piece = ord.Piece,
                            PurchaseRemark = good,
                            Remark = ord.Remark,
                            CreateDate = ord.CreateDate,
                            AcceptPeople = oesOrder[0].PurchaserBoss,
                            AcceptAddress = oesOrder[0].PurchaserAddress,
                            AcceptCellphone = oesOrder[0].PurchaserCellphone,
                        });
                    }

                    //仓库同步缓存
                    CargoHouseBus house = new CargoHouseBus();
                    List<CargoProductEntity> syncProduct = house.SyncTypeOrderNo(ord.OrderNo);
                    foreach (CargoProductEntity product in syncProduct)
                    {

                        if (product.SyncType == "2" || (product.SyncType == "1" && product.TypeID == 34))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + product.HouseID + "_" + product.TypeID + "_" + product.ProductCode + "", product.GoodsCode);
                        }
                    }
                }
                if (msg.Result)
                {
                    bus.DeleteOrderInfo(list, log);
                    foreach (var item in list)
                    {
                        //if (item.HouseID.Equals(9) || item.HouseID.Equals(93))
                        //{
                        //    string returnJson = wxHttpUtility.SendGetHttpRequest(Common.GetHLYAPI() + "/api/CargoInterface/DeletePlanOutOrder?PlanOrderNo=" + item.PlanOrderNo, "application/json");
                        //}
                        //else
                        //{

                        //}
                        if (HlyOrder)
                        {
                            bus.DelHlyOrderData(list);
                        }
                    }
                    msg.Result = true;
                    msg.Message = "成功";
                }
                foreach (var it in list)
                {
                    bus.UpdateCargoOrderPush(new CargoOrderPushEntity { OrderNo = it.OrderNo, PushType = "2", PushStatus = "0", Dest = it.Dest, Piece = it.Piece, AcceptUnit = it.AcceptUnit, AcceptAddress = it.AcceptAddress, AcceptPeople = it.AcceptPeople, AcceptTelephone = it.AcceptTelephone, AcceptCellphone = it.AcceptCellphone, ClientNum = it.ClientNum.ToString(), LogisID = it.LogisID }, log);
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            try
            {
                foreach (var it in Oeslist)
                {
                    //向好来运企业微信推送提货通知
                    if (msg.Result)
                    {
                        int tag = 2;
                        switch (HouseID)
                        {
                            case 9: tag = 2; break;//广州
                            case 91: tag = 2; break;//广州
                            case 97: tag = 2; break;//广州
                            case 106: tag = 2; break;//广州
                            case 107: tag = 2; break;//广州
                            case 129: tag = 2; break;//广州
                            case 31: tag = 4; break;//北京
                            case 109: tag = 4; break;//北京
                            case 24: tag = 33; break;//福州
                            case 123: tag = 33; break;//福州
                            case 25: tag = 5; break;//常熟
                            case 118: tag = 5; break;//常熟
                            case 14: tag = 6; break;//成都
                            case 121: tag = 6; break;//成都
                            case 32: tag = 8; break;//杭州
                            case 119: tag = 8; break;//杭州
                            case 69: tag = 9; break;//合肥
                            case 29: tag = 10; break;//济南
                            case 114: tag = 10; break;//济南
                            case 70: tag = 12; break;//兰州
                            case 124: tag = 12; break;//兰州
                            case 68: tag = 13; break;//南昌
                            case 55: tag = 20; break;//厦门
                            case 15: tag = 14; break;//上海
                            case 117: tag = 14; break;//上海
                            case 23: tag = 15; break;//沈阳
                            case 113: tag = 15; break;//沈阳
                            case 30: tag = 16; break;//武汉
                            case 99: tag = 16; break;//武汉
                            case 130: tag = 16; break;//武汉
                            case 10: tag = 17; break;//西安
                            case 98: tag = 17; break;//西安
                            case 102: tag = 17; break;//西安
                            case 27: tag = 3; break;//长沙
                            case 96: tag = 3; break;//长沙
                            case 100: tag = 3; break;//长沙
                            case 33: tag = 18; break;//郑州
                            case 48: tag = 19; break;//郑州
                            case 50: tag = 7; break;//贵阳
                            case 53: tag = 11; break;//贵阳
                            case 71: tag = 21; break;//贵阳
                            case 72: tag = 22; break;//石家庄
                            case 112: tag = 22; break;//石家庄
                            case 73: tag = 23; break;//南京仓库
                            case 74: tag = 24; break;//宁波仓库
                            case 75: tag = 25; break;//大连仓库
                            case 76: tag = 26; break;//哈尔滨仓库
                            case 77: tag = 27; break;//长春仓库
                            case 110: tag = 27; break;//长春仓库
                            case 78: tag = 29; break;//呼和浩特仓库
                            case 79: tag = 28; break;//西宁仓库
                            case 43: tag = 30; break;//新疆仓库
                            case 80: tag = 31; break;//银川仓库
                            case 81: tag = 32; break;//太原仓库
                            case 115: tag = 32; break;//太原仓库
                            case 13: tag = 34; break;//天津仓库
                            case 105: tag = 34; break;//天津仓库
                            case 127: tag = 34; break;//天津仓库
                            default:
                                break;
                        }

                        //微信企业号推送
                        QySendInfoEntity send = new QySendInfoEntity();
                        send.title = "取消提货通知";
                        send.msgType = msgType.textcard;
                        //send.toUser = "1000";
                        send.toTag = Convert.ToString(tag);
                        send.content = "<div>出库仓库：" + it.OutHouseName + "</div><div>订单号码：" + it.OrderNo + "</div><div>下单时间：" + it.CreateDate.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>提货联系人：" + it.AcceptPeople + " " + it.AcceptCellphone + "</div><div>提货地址：" + it.AcceptAddress + "</div><div>提货数量：" + it.Piece.ToString() + " 条</div><div>物品明细：" + it.PurchaseRemark + "</div><div>备注说明：" + it.Remark + "</div>";
                        send.url = "http://oa.hlyex.com/HLYQY/OESDelivery/DeliverySure.aspx?OrderNo=" + it.OrderNo + "&AgentID=1000021";
                        QyConfigEntity agentEnt = new QyConfigEntity();
                        agentEnt.AgentID = "1000021";
                        agentEnt.AgentSecret = "0iV_tGVHzE6-kJsrdWADQZOG5U-vz939_gIMSRnQXc0";
                        WxQYSendHelper.HLYQYPushInfo(agentEnt, send);
                    }
                }

            }
            catch (Exception)
            {

            }
        ERROR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 订单集合用于判断是否存在重复订单
        /// </summary>
        public static ArrayList OrderNoList = new ArrayList();
        /// <summary>
        /// 简易开单保存方法
        /// </summary>
        public void saveSimpleOrderData()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            CargoHouseBus house = new CargoHouseBus();
            CargoProductBus productBus = new CargoProductBus();
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }

            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "新增销售单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            log.Status = "0";
            int HouseID = Convert.ToInt32(Request["HouseID"]);
            CargoHouseEntity houseEnt = house.QueryCargoHouseByID(HouseID);
            string HouseCode = houseEnt.HouseCode;
            string HouseName = houseEnt.Name;

            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            bool IsModify = false;
            List<QyOrderUpdateGoodsEntity> goods = new List<QyOrderUpdateGoodsEntity>();

            try
            {
                #region 赋值
                ent.HAwbNo = Convert.ToString(Request["HAwbNo"]);//关联订单号
                ent.BusinessID = Convert.ToString(Request["BusinessID"]);
                if (!string.IsNullOrEmpty(ent.BusinessID)) {
                    CargoClientBus clientBus = new CargoClientBus();
                    ent.MarketType = clientBus.QueryBusinessIDDefault(new CargoUpClientEntity() { ID = Convert.ToInt32(ent.BusinessID) }).FirstOrDefault().MarketType;
                }
                
                ent.Dep = Convert.ToString(Request["Dep"]);
                if (string.IsNullOrEmpty(Convert.ToString(Request["Dest"])))
                {
                    ent.Dest = Convert.ToString(Request["ADest"]);
                }
                else
                {
                    ent.Dest = Convert.ToString(Request["Dest"]);
                }
                ent.Piece = string.IsNullOrEmpty(Convert.ToString(Request["Piece"])) ? 0 : Convert.ToInt32(Request["Piece"]);
                ent.Weight = 0; ent.Volume = 0; ent.InsuranceFee = 0; ent.TransitFee = 0;
                ent.DeliveryFee = 0; ent.OtherFee = 0;
                ent.TotalCharge = string.IsNullOrEmpty(Convert.ToString(Request["TotalCharge"])) ? 0 : Convert.ToDecimal(Request["TotalCharge"]);
                ent.TransportFee = ent.TotalCharge;
                ent.Rebate = 0;
                ent.HouseID = HouseID;
                ent.CheckOutType = Convert.ToString(Request["CheckOutType"]);
                ent.TrafficType = "0";// 内部订单
                ent.DeliveryType = "0";//Convert.ToString(Request["DeliveryType"]);
                ent.AcceptAddress = Convert.ToString(Request["AcceptAddress"]);
                ent.AcceptPeople = Convert.ToString(Request["AAcceptPeople"]);
                ent.AcceptUnit = string.IsNullOrEmpty(Convert.ToString(Request["AAcceptUnit"])) ? ent.AcceptPeople : Convert.ToString(Request["AAcceptUnit"]);
                ent.AcceptTelephone = Convert.ToString(Request["AAcceptTelephone"]);
                ent.AcceptCellphone = Convert.ToString(Request["AAcceptCellphone"]);
                ent.ShopCode = Convert.ToString(Request["ShopCode"]);
                ent.CreateAwb = UserInfor.UserName;
                ent.CreateAwbID = UserInfor.LoginName;
                ent.CreateDate = DateTime.Now;
                ent.OP_ID = UserInfor.LoginName;
                ent.SaleManID = Convert.ToString(Request["SaleManID"]);
                ent.SaleManName = Convert.ToString(Request["SaleManName"]);
                ent.SaleCellPhone = Convert.ToString(Request["SaleCellPhone"]);
                ent.FinanceSecondCheck = "1";
                ent.FinanceSecondCheckDate = DateTime.Now;
                ent.FinanceSecondCheckName = UserInfor.UserName;
                ent.Remark = Convert.ToString(Request["Remark"]);
                //ent.ThrowGood = "0";
                ent.ThrowGood = string.IsNullOrEmpty(Convert.ToString(Request["ThrowGood"])) ? "0" : Convert.ToString(Request["ThrowGood"]);
                ent.IsPrintPrice = string.IsNullOrEmpty(Convert.ToString(Request["IsPrintPrice"])) ? 0 : 1;
                //ent.OrderModel = string.IsNullOrEmpty(Convert.ToString(Request["OrderModel"])) ? "0" : Convert.ToString(Request["OrderModel"]);
                ent.TranHouse = "";
                ent.PostponeShip = "0";
                ent.LogisID = 0;
                if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientNum"])) && !Convert.ToString(Request["ClientNum"]).Equals("0"))
                {
                    ent.ClientNum = Convert.ToInt32(Request["ClientNum"]);
                }
                else
                {
                    msg.Message = "未获取到客户编码";
                    msg.Result = false;
                    //ent.ClientNum = Common.GetClientNum();//生成随机的六位数字做为客户编码
                }

                if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])) && !Convert.ToString(Request["PayClientNum"]).Equals("0"))
                {
                    ent.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
                    ent.PayClientName = Convert.ToString(Request["PayClientName"]);//付款人客户姓名
                }
                else
                {
                    ent.PayClientNum = ent.ClientNum;
                    ent.PayClientName = Convert.ToString(Request["HiddenClientSelectName"]);
                }
                #endregion
                decimal trFee = 0.00M;
                int pieceN = 0;
                int pieceSum = 0;
                string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                foreach (Hashtable row in GridRows)
                {
                    CargoAreaEntity careaEnt = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(row["FirstAreaID"]) });
                    //HouseName = Convert.ToString(row["HouseName"]);
                    HouseName = careaEnt.Name;
                    ent.LogisID = careaEnt.LogisID;
                    if (!string.IsNullOrEmpty(careaEnt.OrderCode) && !string.IsNullOrEmpty(careaEnt.OrderDep))
                    {
                        HouseCode = careaEnt.OrderCode;
                        ent.Dep = careaEnt.OrderDep;
                    }
                    else
                    {
                        HouseCode = Convert.ToString(row["HouseCode"]);
                    }
                    int OrderNum = 0;
                    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, HouseCode, out OrderNum);
                    ent.OrderNum = OrderNum;//最新订单顺序号
                    break;
                }
                List<CargoProductEntity> product = new List<CargoProductEntity>();
                foreach (Hashtable row in GridRows)
                {
                    #region 获取规格
                    product.Add(new CargoProductEntity
                    {
                        GoodsCode = Convert.ToString(row["GoodsCode"]),
                        TypeID = Convert.ToInt32(row["TypeID"]),
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        Specs = Convert.ToString(row["Specs"]),
                        Figure = Convert.ToString(row["Figure"]),
                        ProductID = Convert.ToInt64(row["ProductID"]),
                        FirstAreaID = Convert.ToInt32(row["FirstAreaID"]),
                        Model = Convert.ToString(row["Model"]),

                    });

                    #endregion
                    #region 订单详情
                    if (Convert.ToDecimal(row["ActSalePrice"]) < Convert.ToDecimal(row["CostPrice"]))
                    {
                        IsModify = true;
                        QyOrderUpdateGoodsEntity res = new QyOrderUpdateGoodsEntity();
                        res.ModifyPrice = Convert.ToDecimal(row["ActSalePrice"]);//修改后价格
                        res.OrderNum = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);//订单数量
                        res.OrderPrice = Convert.ToDecimal(row["CostPrice"]);//原价格
                        res.ProductID = Convert.ToInt64(row["ProductID"]);
                        res.ContainerCode = Convert.ToString(row["ContainerCode"]);
                        goods.Add(res);
                    }
                    entDest.Add(new CargoOrderGoodsEntity
                    {
                        OrderNo = ent.OrderNo,
                        ProductID = Convert.ToInt64(row["ProductID"]),
                        HouseID = HouseID,
                        AreaID = Convert.ToInt32(row["AreaID"]),
                        Piece = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]),
                        ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
                        ContainerCode = Convert.ToString(row["ContainerCode"]),
                        OutCargoID = outID,
                        OP_ID = UserInfor.LoginName.Trim()
                    });
                    pieceN = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);
                    trFee += pieceN * Convert.ToDecimal(row["ActSalePrice"]);
                    CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                    cargo.OrderNo = ent.OrderNo;//订单号
                    cargo.OutCargoID = outID;
                    cargo.ContainerID = Convert.ToInt32(row["ContainerID"]);
                    cargo.TypeID = Convert.ToInt32(row["TypeID"]);
                    cargo.ProductID = Convert.ToInt64(row["ProductID"]);
                    cargo.Piece = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);//出库件数
                    cargo.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                    cargo.InPiece = Convert.ToInt32(row["InPiece"]);
                    cargo.ID = Convert.ToInt64(row["ID"]);

                    cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                    cargo.HouseName = HouseName;
                    cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                    cargo.ProductName = Convert.ToString(row["ProductName"]).Trim();
                    cargo.Model = Convert.ToString(row["Model"]).Trim();
                    cargo.Specs = Convert.ToString(row["Specs"]).Trim();
                    cargo.Figure = Convert.ToString(row["Figure"]).Trim();
                    cargo.GoodsCode = Convert.ToString(row["GoodsCode"]).Trim();
                    cargo.Batch = Convert.ToString(row["Batch"]).Trim();
                    outHouseList.Add(cargo);
                    pieceSum += cargo.Piece;
                    #endregion
                }

                ent.Piece = pieceSum;
                ent.OutHouseName = HouseName;
                ent.AwbStatus = "0";
                ent.OrderType = "0";
                ent.HouseID = HouseID;
                ent.HouseName = HouseName;
                ent.goodsList = entDest;
                ent.ModifyPriceStatus = "0";
                if (IsModify) { ent.ModifyPriceStatus = "1"; }//表示需要提交改价申请
                if (msg.Result)
                {
                    //仓库同步缓存
                    foreach (CargoContainerShowEntity time in outHouseList)
                    {
                        CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                        //34 马牌  1 同步马牌  2 同步全部品牌
                        if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                        }
                    }

                    bus.AddOrderInfo(ent, outHouseList, log);
                    foreach (var item in product)
                    {
                        productBus.AddChangeStock(item);
                    }
                    if ((HouseID.Equals(64) && (HouseCode.Equals("FO") || HouseCode.Equals("GN"))) || HouseID.Equals(89) || HouseID.Equals(136))
                    {
                        bus.InsertCargoOrderPush(new CargoOrderPushEntity
                        {
                            OrderNo = ent.OrderNo,
                            Dep = ent.Dep,
                            Dest = ent.Dest,
                            Piece = ent.Piece,
                            TransportFee = ent.TransportFee,
                            ClientNum = ent.ClientNum.ToString(),
                            AcceptAddress = ent.AcceptAddress,
                            AcceptCellphone = ent.AcceptCellphone,
                            AcceptTelephone = ent.AcceptTelephone,
                            AcceptPeople = ent.AcceptPeople,
                            AcceptUnit = ent.AcceptUnit,
                            HouseID = ent.HouseID.ToString(),
                            HouseName = houseEnt.Name,
                            OP_ID = ent.OP_ID,
                            PushType = "0",
                            PushStatus = "0",
                            LogisID = ent.LogisID
                        }, log);
                    }
                    msg.Message = ent.OrderNo + "/" + outID;//订单号和出库单号
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            try
            {
                if (msg.Result)
                {
                    #region 推送给相关领导审批改价申请
                    if (IsModify)
                    {
                        CargoFinanceBus financeBus = new CargoFinanceBus();
                        CargoExpenseApproveRoutEntity approveRoute = new CargoExpenseApproveRoutEntity();
                        CargoOrderEntity order = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = ent.OrderNo });
                        //推送给相关领导审批改价申请
                        QyOrderUpdatePriceEntity result = new QyOrderUpdatePriceEntity();
                        result.HouseID = ent.HouseID;
                        result.ApplyID = UserInfor.LoginName;
                        result.ApplyName = UserInfor.UserName;
                        result.ApplyDate = DateTime.Now;
                        result.OrderNo = ent.OrderNo;
                        result.ApplyStatus = "0";
                        result.OrderType = "1";
                        result.OrderID = order.OrderID;
                        result.OrderCheckType = "0";
                        string ApproveType = "3";
                        //1.查询审批设置表获得审批流程
                        QiyeBus qiye = new QiyeBus();
                        CargoFinanceBus f = new CargoFinanceBus();
                        //CargoApproveSetEntity AppSet = f.QueryApproveSetByID(33);
                        CargoApproveSetEntity AppSet = new CargoApproveSetEntity();
                        List<CargoApproveSetEntity> aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = ApproveType, DelFlag = "0", HouseID = UserInfor.HouseID });
                        if (aset.Count > 0) { AppSet = aset[0]; }
                        else
                        {
                            aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = "3", DelFlag = "0", HouseID = UserInfor.HouseID });
                            if (aset.Count > 0) { AppSet = aset[0]; }
                        }
                        List<QyUserEntity> qyUser = new List<QyUserEntity>();
                        //2.审批流程的每一级和当前人的审批角色相匹配
                        if (AppSet.OneCheckID.Equals("3"))
                        {
                            SystemUserEntity entity = new SystemUserEntity();
                            entity.LoginName = UserInfor.LoginName;
                            SystemUserEntity bossLeader = bus.QueryBossLeaderByLoginName(entity);
                            if (bossLeader != null)
                            {
                                //申请人有部门负责人
                                if (!string.IsNullOrEmpty(bossLeader.LoginName))
                                {
                                    if (bossLeader.LoginName != UserInfor.LoginName)
                                    {
                                        qyUser.Add(new QyUserEntity { UserID = bossLeader.LoginName, WxName = bossLeader.UserName });
                                        result.CheckID = AppSet.OneCheckID;
                                        result.CheckName = AppSet.OneCheckName;
                                    }
                                    //申请人部门负责人是自己，推送给下一级
                                    else
                                    {
                                        qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID, CheckHouseID = ent.HouseID.ToString() });
                                        result.CheckID = AppSet.TwoCheckID;
                                        result.CheckName = AppSet.TwoCheckName;
                                    }
                                }
                                //申请人没有部门负责人，推送给下一级
                                else
                                {
                                    qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID, CheckHouseID = ent.HouseID.ToString() });
                                    result.CheckID = AppSet.TwoCheckID;
                                    result.CheckName = AppSet.TwoCheckName;
                                }
                            }
                            //申请人信息跳过操作记录错误
                            else
                            {
                                Common.WriteTextLog("推送失败：申请人未查询到数据");
                                msg.Result = true;
                                return;
                            }
                        }
                        else
                        {
                            qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = AppSet.OneCheckID, CheckHouseID = ent.HouseID.ToString() });
                            result.CheckID = AppSet.OneCheckID;
                            result.CheckName = AppSet.OneCheckName;
                        }

                        result.Reason = ent.Remark;
                        result.SaleManName = ent.SaleManName;
                        result.SaleManID = ent.SaleManID;
                        result.UpdatePriceGoodsList = goods;
                        long OID = qiye.AddOrderUpdatePrice(result, log);
                        approveRoute.ExID = OID;
                        approveRoute.UserID = Convert.ToString(UserInfor.UserID);
                        approveRoute.UserName = UserInfor.UserName;
                        approveRoute.Opera = "3";
                        approveRoute.Result = ent.Remark;
                        approveRoute.ApproveType = "1";
                        financeBus.AddExpenseApproveRout(approveRoute);
                        try
                        {

                            QySendInfoEntity send = new QySendInfoEntity();
                            send.title = "订单改价申请";
                            send.msgType = msgType.textcard;
                            //send.toTag = strTag;
                            send.content = "<div></div><div>订单号：" + ent.OrderNo + "</div><div>收货人：" + ent.AcceptPeople + "  " + ent.AcceptCellphone + "</div><div>申请人：" + result.ApplyName + "</div><div>申请时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>申请原因：" + result.Reason + "</div><div>订单类型：电脑订单</div><div></div><div class=\"highlight\">请点击本通知进行审批！</div>";
                            send.url = "http://dlt.neway5.com/QY/qyApproveCheck.aspx?OrderNo=" + ent.OrderNo + "&OID=" + OID + "&OrderType=1";
                            foreach (var it in qyUser)
                            {
                                send.toUser = it.UserID;
                                WxQYSendHelper.PushInfo("0", "2", send);
                                Common.WriteTextLog("推送成功：" + it.WxName + ent.OrderNo);
                            }

                        }
                        catch (ApplicationException ex)
                        {
                            Common.WriteTextLog("推送失败：" + ent.OrderNo);
                            msg.Result = true;
                        }
                    }
                    #endregion
                }
            }
            catch (Exception)
            {
                msg.Result = true;
            }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
            Response.End();
        }
        public void QueryOrderInfoByOrderNo()
        {
            CargoOrderBus bus = new CargoOrderBus();
            CargoOrderEntity order = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = Convert.ToString(Request["OrderNo"]) });
            //JSON
            String json = JSON.Encode(order);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 保存订单
        /// </summary>
        public void saveOrderData()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            CargoHouseBus house = new CargoHouseBus();
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "新增订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            log.Status = "0";

            Dictionary<int, ArrayList> rows = new Dictionary<int, ArrayList>();
            foreach (Hashtable item in GridRows)
            {
                if (rows.ContainsKey(Convert.ToInt32(item["HouseID"])))
                {
                    ArrayList list = new ArrayList();
                    foreach (var row in rows[Convert.ToInt32(item["HouseID"])])
                    {
                        list.Add(row);
                    }
                    list.Add(item);
                    rows[Convert.ToInt32(item["HouseID"])] = list;
                }
                else
                {
                    ArrayList list = new ArrayList();
                    list.Add(item);
                    rows.Add(Convert.ToInt32(item["HouseID"]), list);
                }
            }

            foreach (var item in rows)
            {
                CargoOrderBus bus = new CargoOrderBus();
                CargoProductBus productBus = new CargoProductBus();
                CargoHouseEntity houseEnt = house.QueryCargoHouseByID(item.Key);
                string source = string.Empty;
                //List<string> HouseStr = new List<string>();
                int HouseID = houseEnt.HouseID;
                string HouseCode = houseEnt.HouseCode;
                string HouseName = houseEnt.Name;
                List<CargoProductEntity> ProductInfo = new List<CargoProductEntity>();
                Dictionary<string, CargoOrderEntity> HouseStr = new Dictionary<string, CargoOrderEntity>();


                //非湖南仓库不需要分库下单
                if (!HouseID.Equals(1) && !HouseID.Equals(45) && !HouseID.Equals(3) && !HouseID.Equals(44) && !HouseID.Equals(34) && !HouseID.Equals(11) && !HouseID.Equals(46) && !HouseID.Equals(48) && !HouseID.Equals(49) && !HouseID.Equals(50) && !HouseID.Equals(84) && !HouseID.Equals(65) && !HouseID.Equals(64))
                {
                    CargoOrderEntity coe = new CargoOrderEntity();
                    int OrderNum = 0;
                    coe.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, HouseCode, out OrderNum);
                    coe.OrderNum = OrderNum;
                    coe.Dep = houseEnt.DepCity;
                    HouseStr.Add(HouseName, coe);
                    //HouseStr.Add(HouseName);
                }
                else
                {
                    #region 仓库搜索
                    foreach (Hashtable row in item.Value)
                    {
                        HouseID = Convert.ToInt32(row["HouseID"]);
                        HouseCode = Convert.ToString(row["HouseCode"]);
                        HouseName = Convert.ToString(row["HouseName"]);
                        ProductInfo.Add(new CargoProductEntity
                        {
                            Model = Convert.ToString(row["Model"]),
                            GoodsCode = Convert.ToString(row["GoodsCode"]),
                            TypeID = Convert.ToInt32(row["TypeID"]),
                            HouseID = Convert.ToInt32(row["HouseID"]),
                            Specs = Convert.ToString(row["Specs"]),
                            Figure = Convert.ToString(row["Figure"]),
                            ProductID = Convert.ToInt64(row["ProductID"]),
                            FirstAreaID = Convert.ToInt32(row["FirstAreaID"]),
                        });
                        int p = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);
                        CargoContainerGoodsEntity goods = house.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ProductID = Convert.ToInt64(row["ProductID"]), ContainerID = Convert.ToInt32(row["ContainerID"]) });
                        if (goods == null)
                        {
                            msg.Message = "规格：" + Convert.ToString(row["Specs"]).Trim() + "，型号：" + Convert.ToString(row["Model"]).Trim() + "，花纹：" + Convert.ToString(row["Figure"]).Trim() + "库存不足";
                            msg.Result = false;
                            break;
                        }
                        if (goods.Piece < p)
                        {
                            msg.Message = "规格：" + Convert.ToString(row["Specs"]).Trim() + "，型号：" + Convert.ToString(row["Model"]).Trim() + "，花纹：" + Convert.ToString(row["Figure"]).Trim() + "库存不足";
                            msg.Result = false;
                            break;
                        }
                        //如果不是同一个仓库，则分开开单
                        if (!HouseStr.ContainsKey(Convert.ToString(row["FirstAreaName"])))
                        {
                            CargoOrderEntity coe = new CargoOrderEntity();
                            CargoAreaEntity careaEnt = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(row["FirstAreaID"]) });
                            if (!string.IsNullOrEmpty(careaEnt.OrderCode) && !string.IsNullOrEmpty(careaEnt.OrderDep))
                            {
                                HouseCode = careaEnt.OrderCode;
                                coe.Dep = careaEnt.OrderDep;
                            }
                            else
                            {
                                HouseCode = Convert.ToString(row["HouseCode"]);
                            }
                            int OrderNum = 0;
                            coe.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, HouseCode, out OrderNum);
                            coe.OrderNum = OrderNum;
                            HouseStr.Add(Convert.ToString(row["FirstAreaName"]), coe);
                            // HouseStr.Add(Convert.ToString(row["FirstAreaName"]));
                        }
                        //if (!HouseStr.Exists(c => c.Equals(Convert.ToString(row["FirstAreaName"]))))
                        //{

                        //    CargoAreaEntity careaEnt = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(row["FirstAreaID"]) });
                        //    if (!string.IsNullOrEmpty(careaEnt.OrderCode) && !string.IsNullOrEmpty(careaEnt.OrderDep))
                        //    {
                        //        HouseCode = careaEnt.OrderCode;
                        //        ent.Dep = careaEnt.OrderDep;
                        //    }
                        //    else
                        //    {
                        //        HouseCode = Convert.ToString(row["HouseCode"]);
                        //    }
                        //    int OrderNum = 0;
                        //    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, HouseCode, out OrderNum);

                        //    HouseStr.Add(Convert.ToString(row["FirstAreaName"]));
                        //}
                        source = Convert.ToString(row["Source"]);
                    }
                    #endregion
                }
                foreach (var hhh in HouseStr)
                {
                    CargoOrderEntity ent = new CargoOrderEntity();
                    List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
                    List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
                    List<QyOrderUpdateGoodsEntity> goods = new List<QyOrderUpdateGoodsEntity>();
                    bool IsModify = false;
                    bool NoPromise = Convert.ToString(Request["ClientType"]).Equals("3") ? true : false;
                    try
                    {
                        if (msg.Result)
                        {
                            #region 赋值
                            ent.HAwbNo = Convert.ToString(Request["HAwbNo"]);//关联订单号
                            ent.BusinessID = Convert.ToString(Request["BusinessID"]);
                            if (!string.IsNullOrEmpty(ent.BusinessID))
                            {
                                CargoClientBus clientBus = new CargoClientBus();
                                ent.MarketType = clientBus.QueryBusinessIDDefault(new CargoUpClientEntity() { ID = Convert.ToInt32(ent.BusinessID) }).FirstOrDefault().MarketType;
                            }
                            ent.Dep = Convert.ToString(houseEnt.DepCity);
                            if (string.IsNullOrEmpty(Convert.ToString(Request["Dest"])))
                            {
                                ent.Dest = Convert.ToString(Request["ADest"]);
                            }
                            else
                            {
                                ent.Dest = Convert.ToString(Request["Dest"]);
                            }
                            if (HouseID.Equals(62))
                            {
                                //太石仓库特殊处理
                                ent.Dest = ent.Dep;
                            }
                            ent.Piece = string.IsNullOrEmpty(Convert.ToString(Request["Piece"])) ? 0 : Convert.ToInt32(Request["Piece"]);
                            ent.Weight = string.IsNullOrEmpty(Convert.ToString(Request["Weight"])) ? 0 : Convert.ToDecimal(Request["Weight"]);
                            ent.Volume = string.IsNullOrEmpty(Convert.ToString(Request["Volume"])) ? 0 : Convert.ToDecimal(Request["Volume"]);
                            ent.InsuranceFee = string.IsNullOrEmpty(Convert.ToString(Request["InsuranceFee"])) ? 0 : Convert.ToDecimal(Request["Coupon"]);//优惠券
                            ent.TransitFee = string.IsNullOrEmpty(Convert.ToString(Request["TransitFee"])) ? 0 : Convert.ToDecimal(Request["TransitFee"]);
                            ent.TransportFee = string.IsNullOrEmpty(Convert.ToString(Request["TransportFee"])) ? 0 : Convert.ToDecimal(Request["TransportFee"]);
                            ent.CollectMoney = string.IsNullOrEmpty(Convert.ToString(Request["CollectMoney"])) ? 0 : Convert.ToDecimal(Request["CollectMoney"]);
                            if (!string.IsNullOrEmpty(Convert.ToString(Request["InsuranceFee"])))
                            {
                                ent.CouponID = Convert.ToInt64(Request["InsuranceFee"]);
                            }
                            ent.DeliveryFee = string.IsNullOrEmpty(Convert.ToString(Request["DeliveryFee"])) ? 0 : Convert.ToDecimal(Request["DeliveryFee"]);
                            ent.OtherFee = string.IsNullOrEmpty(Convert.ToString(Request["OtherFee"])) ? 0 : Convert.ToDecimal(Request["OtherFee"]);
                            ent.TotalCharge = string.IsNullOrEmpty(Convert.ToString(Request["TotalCharge"])) ? 0 : Convert.ToDecimal(Request["TotalCharge"]);
                            ent.Rebate = string.IsNullOrEmpty(Convert.ToString(Request["Rebate"])) ? 0 : Convert.ToDecimal(Request["Rebate"]);
                            ent.HouseID = HouseID;
                            ent.CheckOutType = Convert.ToString(Request["CheckOutType"]);
                            //ent.ReturnAwb = string.IsNullOrEmpty(Convert.ToString(Request["ReturnAwb"])) ? 0 : Convert.ToInt32(Request["ReturnAwb"]);
                            if (ent.HouseID.Equals(9) || ent.HouseID.Equals(49))
                            {
                                if (!source.Equals("9"))
                                {
                                    ent.TrafficType = "0";// 内部订单
                                }
                                else
                                {
                                    ent.TrafficType = "1";// 外采订单
                                }
                            }
                            ent.DeliveryType = Convert.ToString(Request["DeliveryType"]);
                            ent.AcceptAddress = Convert.ToString(Request["AcceptAddress"]);
                            if (string.IsNullOrEmpty(Convert.ToString(Request["AcceptPeople"])))
                            {
                                ent.AcceptPeople = Convert.ToString(Request["AAcceptPeople"]);
                            }
                            else
                            {
                                ent.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
                            }
                            ent.AcceptPeople = ent.AcceptPeople.Split(',')[0];
                            ent.AcceptUnit = string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"])) ? ent.AcceptPeople : Convert.ToString(Request["AcceptUnit"]);
                            ent.AcceptTelephone = Convert.ToString(Request["AcceptTelephone"]);
                            ent.AcceptCellphone = Convert.ToString(Request["AcceptCellphone"]);
                            ent.ShopCode = Convert.ToString(Request["ShopCode"]);
                            ent.CreateAwb = HouseID.Equals(62) ? UserInfor.UserName : Convert.ToString(Request["CreateAwb"]);
                            ent.CreateAwbID = UserInfor.LoginName;
                            ent.CreateDate = DateTime.Now;// Convert.ToDateTime(Request["CreateDate"]);
                            ent.OP_ID = UserInfor.LoginName.Trim();
                            ent.SaleManID = Convert.ToString(Request["SaleManID"]);
                            ent.SaleManName = Convert.ToString(Request["SaleManName"]);
                            ent.SaleCellPhone = Convert.ToString(Request["SaleCellPhone"]);
                            ent.Remark = Convert.ToString(Request["Remark"]);
                            ent.OpenOrderNo = Convert.ToString(Request["OpenOrderNo"]);
                            if (!string.IsNullOrEmpty(Convert.ToString(Request["OpenOrderNo"])))
                            {
                                ent.OpenOrderSource = "0";
                            }
                            ent.ThrowGood = string.IsNullOrEmpty(Convert.ToString(Request["ThrowGood"])) ? "0" : Convert.ToString(Request["ThrowGood"]);
                            ent.IsPrintPrice = string.IsNullOrEmpty(Convert.ToString(Request["IsPrintPrice"])) ? 0 : 1;
                            //ent.OrderModel = string.IsNullOrEmpty(Convert.ToString(Request["OrderModel"])) ? "0" : Convert.ToString(Request["OrderModel"]);
                            //ent.TranHouse = ent.ThrowGood.Equals("0") ? "" : Convert.ToString(Request["TranHouse"]);
                            //2021-04-14代发仓库逻辑改为订单发送为指定仓库货物
                            ent.TranHouse = Convert.ToString(Request["TranHouse"]);
                            ent.PostponeShip = string.IsNullOrEmpty(Convert.ToString(Request["PostponeShip"])) ? "0" : Convert.ToString(Request["PostponeShip"]);
                            ent.LogisID = string.IsNullOrEmpty(Convert.ToString(Request["LogisID"])) ? 0 : Convert.ToInt32(Request["LogisID"]);
                            if (hhh.Key == "深圳仓库")
                            {
                                ent.Latitude = "22.666994";
                                ent.Longitude = "114.016802";
                            }
                            else if (hhh.Key.Equals("东莞仓库"))
                            {
                                ent.LogisID = 62;
                                ent.Latitude = "22.948104";
                                ent.Longitude = "113.683191";
                            }
                            else if (hhh.Key.Equals("揭阳主仓库") || hhh.Key.Equals("梅州主仓库"))
                            {
                                ent.LogisID = 62;
                            }
                            else if (!string.IsNullOrEmpty(Convert.ToString(Request["LogisID"])))
                            {
                                ent.LogisID = Convert.ToInt32(Request["LogisID"]);

                            }
                            if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientNum"])) && !Convert.ToString(Request["ClientNum"]).Equals("0"))
                            {
                                ent.ClientNum = Convert.ToInt32(Request["ClientNum"]);
                                ////如果订单仓库不是用户登录仓库--21-4-12取消客户复制调整为单一客户多收货地址
                                //if (UserInfor.HouseID != HouseID)
                                //{
                                //    CargoClientBus client = new CargoClientBus();
                                //    //判断订单仓库是否拥有此客户
                                //    if (!client.QueryCargoClientNum(Convert.ToString(Request["AcceptPeople"]), Convert.ToString(Request["AcceptCellphone"]), HouseID))
                                //    {
                                //        //将指定客户复制到订单仓库
                                //        client.CopyCargoClientData(Convert.ToInt32(Request["ClientNum"]), Common.GetClientNum(), HouseID);
                                //    }
                                //}
                            }
                            else
                            {
                                msg.Message = "未获取到客户编码";
                                msg.Result = false;
                                //ent.ClientNum = Common.GetClientNum();//生成随机的六位数字做为客户编码
                            }

                            if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])) && !Convert.ToString(Request["PayClientNum"]).Equals("0"))
                            {
                                ent.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
                                ent.PayClientName = Convert.ToString(Request["PayClientName"]);//付款人客户姓名
                            }
                            else
                            {
                                ent.PayClientNum = ent.ClientNum;
                                ent.PayClientName = Convert.ToString(Request["HiddenClientSelectName"]);
                            }
                            //物流结算方式
                            if (Convert.ToString(Request["DeliverySettlement"]) != "-1")
                            {
                                ent.DeliverySettlement = Convert.ToString(Request["DeliverySettlement"]);
                            }
                            else
                            {
                                ent.DeliverySettlement = null;
                            }

                            #endregion
                            decimal trFee = 0.00M; decimal OverDayFee = 0.00M; int pieceN = 0; int pieceSum = 0;
                            string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                            string SuppClientNum = "";
                            foreach (Hashtable row in GridRows)
                            {
                                //查询基础规格
                                int inHouseDay = (int)(DateTime.Now - Convert.ToDateTime(row["InHouseTime"])).TotalDays;
                                int OverDay = 0; decimal OnlyOverDayFee = 0;
                                //判断是云仓订单，如果在库天数大于了用户设置的天数，则按照超期天数计算超期费用
                                if (houseEnt.BelongHouse.Equals("6") && inHouseDay > houseEnt.OverDayNum)
                                {
                                    OverDay = inHouseDay - houseEnt.OverDayNum;
                                    OnlyOverDayFee = OverDay * houseEnt.OverDueUnitPrice * (Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]));
                                    OverDayFee += OnlyOverDayFee;
                                }
                                if (Convert.ToInt32(row["HouseID"]).Equals(HouseID))
                                {
                                    //湖南仓库特殊处理
                                    if (HouseID.Equals(1) || HouseID.Equals(3) || HouseID.Equals(11) || HouseID.Equals(45) || HouseID.Equals(46) || HouseID.Equals(44))
                                    {
                                        if (Convert.ToString(row["FirstAreaName"]).Equals(hhh.Key))
                                        {
                                            ent.OrderNo = HouseStr[hhh.Key].OrderNo;
                                            ent.Dep = HouseStr[hhh.Key].Dep;
                                            ent.OrderNum = HouseStr[hhh.Key].OrderNum;


                                            //CargoAreaEntity careaEnt = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(row["FirstAreaID"]) });
                                            //HouseName = Convert.ToString(row["HouseName"]);
                                            //if (!string.IsNullOrEmpty(careaEnt.OrderCode) && !string.IsNullOrEmpty(careaEnt.OrderDep))
                                            //{
                                            //    HouseCode = careaEnt.OrderCode;
                                            //    ent.Dep = careaEnt.OrderDep;
                                            //}
                                            //else
                                            //{
                                            //    HouseCode = Convert.ToString(row["HouseCode"]);
                                            //}
                                            //int OrderNum = 0;
                                            //ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, HouseCode, out OrderNum); // Convert.ToString(Request["OrderNo"]);//生成最新顺序订单号
                                            //int RetryCount = 0;
                                            //while (OrderNoList.Contains(ent.OrderNo))
                                            //{
                                            //    RetryCount++;
                                            //    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, HouseCode, out OrderNum, RetryCount);
                                            //}
                                            //OrderNoList.Add(ent.OrderNo);
                                            // ent.OrderNum = OrderNum;//最新订单顺序号

                                            #region 改价审批

                                            if (Convert.ToDecimal(row["ActSalePrice"]) < Convert.ToDecimal(row["TradePrice"]))
                                            {
                                                if (row["IsRuleBank"].ToString() != "1")
                                                {
                                                    IsModify = true;
                                                }
                                            }
                                            QyOrderUpdateGoodsEntity res = new QyOrderUpdateGoodsEntity();
                                            res.ModifyPrice = Convert.ToDecimal(row["ActSalePrice"]);//修改后价格
                                            res.OrderNum = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);//订单数量
                                            res.OrderPrice = Convert.ToDecimal(row["TradePrice"]);//原价格
                                            res.ProductID = Convert.ToInt64(row["ProductID"]);
                                            res.ContainerCode = Convert.ToString(row["ContainerCode"]);
                                            goods.Add(res);
                                            #endregion
                                            #region 订单详情
                                            //移库单实际销售价为0
                                            if (ent.ThrowGood == "9") { row["ActSalePrice"] = 0; }

                                            entDest.Add(new CargoOrderGoodsEntity
                                            {
                                                OrderNo = ent.OrderNo,
                                                ProductID = Convert.ToInt64(row["ProductID"]),
                                                HouseID = HouseID,
                                                AreaID = Convert.ToInt32(row["AreaID"]),
                                                Piece = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]),
                                                ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
                                                ContainerCode = Convert.ToString(row["ContainerCode"]),
                                                OutCargoID = outID,
                                                RuleType = Convert.ToString(row["RuleType"]).Trim(),
                                                RuleID = Convert.ToString(row["RuleID"]).Trim(),
                                                RuleTitle = Convert.ToString(row["RuleTitle"]).Trim(),
                                                OverDayNum = OverDay,
                                                OverDueFee = OnlyOverDayFee,
                                                OP_ID = UserInfor.LoginName.Trim()
                                            });
                                            pieceN = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);
                                            trFee += pieceN * Convert.ToDecimal(row["ActSalePrice"]);
                                            CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                                            cargo.OrderNo = ent.OrderNo;//订单号
                                            cargo.OutCargoID = outID;
                                            cargo.ContainerID = Convert.ToInt32(row["ContainerID"]);
                                            cargo.TypeID = Convert.ToInt32(row["TypeID"]);
                                            cargo.TypeParentID = Convert.ToInt32(row["TypeParentID"]);
                                            cargo.ProductID = Convert.ToInt64(row["ProductID"]);
                                            cargo.Piece = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);//出库件数
                                            cargo.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                                            cargo.InPiece = Convert.ToInt32(row["InPiece"]);
                                            cargo.ID = Convert.ToInt64(row["ID"]);

                                            cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                                            cargo.HouseName = HouseName;
                                            cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                                            cargo.ProductName = Convert.ToString(row["ProductName"]).Trim();
                                            cargo.Model = Convert.ToString(row["Model"]).Trim();
                                            cargo.Specs = Convert.ToString(row["Specs"]).Trim();
                                            cargo.Figure = Convert.ToString(row["Figure"]).Trim();
                                            cargo.GoodsCode = Convert.ToString(row["GoodsCode"]).Trim();
                                            cargo.Batch = Convert.ToString(row["Batch"]).Trim();
                                            cargo.BelongDepart = Convert.ToString(row["BelongDepart"]).Trim();
                                            cargo.Born = Convert.ToString(row["Born"]).Trim();
                                            cargo.SpeedLevel = Convert.ToString(row["SpeedLevel"]).Trim();
                                            cargo.LoadIndex = Convert.ToString(row["LoadIndex"]).Trim();
                                            outHouseList.Add(cargo);
                                            pieceSum += cargo.Piece;
                                            #endregion
                                        }
                                    }
                                    else
                                    {
                                        ent.OrderNo = HouseStr[hhh.Key].OrderNo;
                                        ent.Dep = HouseStr[hhh.Key].Dep;
                                        ent.OrderNum = HouseStr[hhh.Key].OrderNum;

                                        //CargoAreaEntity careaEnt = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(row["FirstAreaID"]) });
                                        //HouseName = Convert.ToString(row["HouseName"]);
                                        //if (!string.IsNullOrEmpty(careaEnt.OrderCode) && !string.IsNullOrEmpty(careaEnt.OrderDep))
                                        //{
                                        //    HouseCode = careaEnt.OrderCode;
                                        //    ent.Dep = careaEnt.OrderDep;
                                        //}
                                        //else
                                        //{
                                        //    HouseCode = Convert.ToString(row["HouseCode"]);
                                        //}
                                        //int OrderNum = 0;
                                        //ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, HouseCode, out OrderNum); // Convert.ToString(Request["OrderNo"]);//生成最新顺序订单号
                                        //                                                                                    //int RetryCount = 0;
                                        //                                                                                    //while (OrderNoList.Contains(ent.OrderNo))
                                        //                                                                                    //{
                                        //                                                                                    //    RetryCount++;
                                        //                                                                                    //    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, HouseCode, out OrderNum, RetryCount);
                                        //                                                                                    //}
                                        //                                                                                    //OrderNoList.Add(ent.OrderNo);
                                        //ent.OrderNum = OrderNum;//最新订单顺序号
                                        #region 改价审批


                                        if (Convert.ToDecimal(row["ActSalePrice"]) < Convert.ToDecimal(row["TradePrice"]))
                                        {
                                            if (row["IsRuleBank"].ToString() != "1")
                                            {
                                                IsModify = true;
                                            }
                                        }
                                        QyOrderUpdateGoodsEntity res = new QyOrderUpdateGoodsEntity();
                                        res.ModifyPrice = Convert.ToDecimal(row["ActSalePrice"]);//修改后价格
                                        res.OrderNum = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);//订单数量
                                        res.OrderPrice = Convert.ToDecimal(row["TradePrice"]);//原价格
                                        res.ProductID = Convert.ToInt64(row["ProductID"]);
                                        res.ContainerCode = Convert.ToString(row["ContainerCode"]);
                                        goods.Add(res);
                                        #endregion
                                        #region 订单详情
                                        //移库单实际销售价为0
                                        if (ent.ThrowGood == "9")
                                        {
                                            row["ActSalePrice"] = 0;
                                        }
                                        entDest.Add(new CargoOrderGoodsEntity
                                        {
                                            OrderNo = ent.OrderNo,
                                            ProductID = Convert.ToInt64(row["ProductID"]),
                                            HouseID = HouseID,
                                            AreaID = Convert.ToInt32(row["AreaID"]),
                                            Piece = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]),
                                            ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
                                            ContainerCode = Convert.ToString(row["ContainerCode"]),
                                            OutCargoID = outID,
                                            RuleType = Convert.ToString(row["RuleType"]).Trim(),
                                            RuleID = Convert.ToString(row["RuleID"]).Trim(),
                                            RuleTitle = Convert.ToString(row["RuleTitle"]).Trim(),
                                            OverDayNum = OverDay,
                                            OverDueFee = OnlyOverDayFee,
                                            SupplySalePrice = string.IsNullOrEmpty(row["InHousePrice"].ToString())?0:Convert.ToDecimal(row["InHousePrice"]),
                                            OP_ID = UserInfor.LoginName.Trim()
                                        });
                                        pieceN = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);
                                        trFee += pieceN * Convert.ToDecimal(row["ActSalePrice"]);
                                        CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                                        cargo.OrderNo = ent.OrderNo;//订单号
                                        cargo.OutCargoID = outID;
                                        cargo.ContainerID = Convert.ToInt32(row["ContainerID"]);
                                        cargo.TypeID = Convert.ToInt32(row["TypeID"]);
                                        cargo.TypeParentID = Convert.ToInt32(row["TypeParentID"]);
                                        cargo.ProductID = Convert.ToInt64(row["ProductID"]);
                                        cargo.Piece = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);//出库件数
                                        cargo.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                                        cargo.InPiece = Convert.ToInt32(row["InPiece"]);
                                        cargo.ID = Convert.ToInt64(row["ID"]);

                                        cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                                        cargo.HouseName = HouseName;
                                        cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                                        cargo.ProductName = Convert.ToString(row["ProductName"]).Trim();
                                        cargo.Model = Convert.ToString(row["Model"]).Trim();
                                        cargo.Specs = Convert.ToString(row["Specs"]).Trim();
                                        cargo.Figure = Convert.ToString(row["Figure"]).Trim();
                                        cargo.GoodsCode = Convert.ToString(row["GoodsCode"]).Trim();
                                        cargo.Batch = Convert.ToString(row["Batch"]).Trim();
                                        cargo.BelongDepart = Convert.ToString(row["BelongDepart"]).Trim();
                                        cargo.Born = Convert.ToString(row["Born"]).Trim();
                                        cargo.SpeedLevel = Convert.ToString(row["SpeedLevel"]).Trim();
                                        cargo.LoadIndex = Convert.ToString(row["LoadIndex"]).Trim();
                                        outHouseList.Add(cargo);
                                        pieceSum += cargo.Piece;
                                        #endregion
                                    }
                                }

                                if (!string.IsNullOrEmpty(row["SuppClientNum"].ToString())) {
                                    SuppClientNum = row["SuppClientNum"].ToString();
                                }

                            }
                            //if (!UserInfor.HouseID.Equals(1))
                            //{
                            //    if (!ent.Piece.Equals(pieceSum))
                            //    {
                            //        msg.Message = "订单件数不一致，请核对";
                            //        msg.Result = false;
                            //    }
                            //}
                            if (ent.HouseID.Equals(83) || ent.HouseID.Equals(85) || ent.HouseID.Equals(89) || ent.HouseID.Equals(90))
                            {
                                IsModify = false;
                            }
                            if (IsModify)
                            {
                                if (string.IsNullOrEmpty(ent.Remark))
                                {
                                    msg.Message = "请输入改价原因";
                                    msg.Result = false;
                                }
                            }
                            ent.CargoDepart = houseEnt.CargoDepart;
                            //if (ent.ThrowGood.Equals("16") || ent.ThrowGood.Equals("17") || ent.ThrowGood.Equals("20"))20250602去掉促销单和急送单的不走改价审批逻辑功能
                            if (ent.ThrowGood.Equals("20"))
                            {
                                /*(ent.ThrowGood.Equals("12") && !ent.HouseID.Equals(9) && !ent.HouseID.Equals(82))*/ /*|| ent.ThrowGood.Equals("15")*/ /*||*/
                                //OE订单广州仓库之外的不走审批流程
                                //速配单不走审批流程
                                //16 促销单  17  急送单不走审批  20 电商单
                                IsModify = false;
                                NoPromise = false;
                                ent.CargoDepart = houseEnt.OESCargoDepart;
                            }
                            //表示需要提交改价申请
                            //广州、广东、揭阳仓库异地单走审批
                            if (ent.ThrowGood.Equals("18") && (ent.HouseID.Equals(9) || ent.HouseID.Equals(44) || ent.HouseID.Equals(45)))
                            {
                                IsModify = true;
                            }
                            ent.Piece = pieceSum;
                            ent.OutHouseName = hhh.Key;
                            if (ent.ThrowGood != "9")
                            {
                                ent.TransportFee = trFee;
                                ent.TotalCharge = ent.TransportFee + ent.TransitFee + ent.OtherFee - ent.InsuranceFee;
                            }
                            else
                            {
                                ent.TransportFee = 0;
                                ent.TotalCharge = 0;
                            }
                            ent.OrderType = "0";
                            //20240904 退仓单修改为不计算费用
                            if (ent.ThrowGood.Equals("25"))
                            {
                                //ent.OrderType= "4";
                                ent.SuppClientNum = ent.PayClientNum;
                                ent.TransportFee = 0;
                                ent.TotalCharge = 0;
                                ent.BusinessID = "22";
                                ent.MarketType = "2";
                            }
                            ent.OverDueFee = OverDayFee;
                            ent.AwbStatus = "0";
                            ent.HouseID = HouseID;
                            if (HouseID.Equals(47))
                            {
                                ent.BelongHouse = "2";
                            }
                            ent.HouseName = HouseName;
                            ent.goodsList = entDest;
                            ent.ModifyPriceStatus = "0";

                            //天猫订单/开思订单==》转小程序订单
                            if (ent.ClientNum == 863602|| ent.ClientNum == 165462)
                            {
                                ent.ThrowGood = "22";//即日达
                                ent.OrderType = "4";//微信小程序下单
                                ent.CheckStatus = "1";
                                ent.FinanceSecondCheck = "1";
                                if (!string.IsNullOrEmpty(SuppClientNum)) {
                                    ent.SuppClientNum=Convert.ToInt32(SuppClientNum);
                                }
                            }

                            if (IsModify || NoPromise) { ent.ModifyPriceStatus = "1"; }//表示需要提交改价申请，逾期客户也提交审批
                            if (msg.Result)
                            {

                                //仓库同步缓存
                                foreach (CargoContainerShowEntity time in outHouseList)
                                {
                                    CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                                    //34 马牌  1 同步马牌  2 同步全部品牌
                                    if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                                    {
                                        RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                                    }

                                    //主仓缓存更改
                                    if (house.IsAddCaching(ent.HouseID, time.TypeID))
                                    {

                                        RedisHelper.HashSet("HCYCHouseStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                                    }
                                }
                                //bus.AddOrderInfo(ent, log);
                                //house.saveOutCargoData(outHouseList, log);
                                bus.AddOrderInfo(ent, outHouseList, log);

                                foreach (var ProductItem in ProductInfo)
                                {
                                    productBus.AddChangeStock(ProductItem);
                                }

                                msg.Message = ent.OrderNo + "/" + outID + "/" + ent.ModifyPriceStatus;//订单号和出库单号
                            }
                        }
                    }
                    catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }

                    try
                    {
                        if (msg.Result)
                        {

                            if (ent.HouseID.Equals(9) && !ent.ThrowGood.Equals("15") && !ent.ModifyPriceStatus.Equals("1"))
                            {
                                bus.InsertCargoOrderPush(new CargoOrderPushEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    Dep = ent.Dep,
                                    Dest = ent.Dest,
                                    Piece = ent.Piece,
                                    TransportFee = ent.TransportFee,
                                    ClientNum = ent.ClientNum.ToString(),
                                    AcceptAddress = ent.AcceptAddress,
                                    AcceptCellphone = ent.AcceptCellphone,
                                    AcceptTelephone = ent.AcceptTelephone,
                                    AcceptPeople = ent.AcceptPeople,
                                    AcceptUnit = ent.AcceptUnit,
                                    HouseID = ent.HouseID.ToString(),
                                    HouseName = "广州仓库",
                                    OP_ID = UserInfor.UserName,
                                    PushType = "0",
                                    PushStatus = "0",
                                    LogisID = ent.LogisID
                                }, log);
                            }
                            #region 推送好来运系统

                            if ((ent.HouseID.Equals(9) && !ent.ThrowGood.Equals("15")) || ent.HouseID.Equals(15) || ent.HouseID.Equals(49) || ent.HouseID.Equals(50) || ent.HouseID.Equals(51) || ent.HouseID.Equals(52) || ent.HouseID.Equals(53) || ent.HouseID.Equals(54) || ent.HouseID.Equals(13) || ent.HouseID.Equals(14) || (ent.HouseID.Equals(10) && !UserInfor.RoleCName.Contains("安泰路斯")) || ent.HouseID.Equals(23) || ent.HouseID.Equals(30) || ent.HouseID.Equals(93))
                            {
                                //判断必须选择好来运速递
                                if (ent.LogisID.Equals(34))
                                {
                                    //等通知发货的订单不推送
                                    if (ent.PostponeShip != "1")
                                    {
                                        if (!source.Equals("9"))
                                        {
                                            if (!IsModify && !NoPromise)
                                            {
                                                //内部订单
                                                bus.SaveHlyOrderData(outHouseList, ent);
                                                //东平云仓重新写入推送订单表进行大屏订单数据处理
                                                //if (ent.HouseID.Equals(93))
                                                //{
                                                //    bus.InsertCargoOrderPush(new CargoOrderPushEntity
                                                //    {
                                                //        OrderNo = ent.OrderNo,
                                                //        Dep = ent.Dep,
                                                //        Dest = ent.Dest,
                                                //        Piece = ent.Piece,
                                                //        TransportFee = ent.TransportFee,
                                                //        ClientNum = ent.ClientNum.ToString(),
                                                //        AcceptAddress = ent.AcceptAddress,
                                                //        AcceptCellphone = ent.AcceptCellphone,
                                                //        AcceptTelephone = ent.AcceptTelephone,
                                                //        AcceptPeople = ent.AcceptPeople,
                                                //        AcceptUnit = ent.AcceptUnit,
                                                //        HouseID = ent.HouseID.ToString(),
                                                //        HouseName = "东平云仓",
                                                //        OP_ID = UserInfor.UserName,
                                                //        PushType = "0",
                                                //        PushStatus = "0",
                                                //        LogisID = ent.LogisID
                                                //    }, log);
                                                //}
                                            }
                                        }
                                        else
                                        {
                                            Common.WriteTextLog("市场采购" + ent.OrderNo);
                                            //市场采购
                                            bus.SaveHlyOutOrderData(ent);
                                            Common.WriteTextLog("保存成功市场采购" + ent.OrderNo);
                                        }
                                    }
                                }
                            }
                            else
                            {
                                string hName = ent.HouseName;
                                string HLYSendUnit = "";
                                if (ent.HouseID.Equals(9) && ent.ThrowGood.Equals("15"))
                                {
                                    //速配单
                                    hName = "新陆城配";
                                }
                                else if (ent.HouseID.Equals(65))
                                {
                                    HLYSendUnit = "狄乐汽服广州仓广丰业务部";

                                }
                                if (!IsModify && !NoPromise)
                                {
                                    bus.InsertCargoOrderPush(new CargoOrderPushEntity
                                    {
                                        OrderNo = ent.OrderNo,
                                        Dep = ent.Dep,
                                        Dest = ent.Dest,
                                        Piece = ent.Piece,
                                        TransportFee = ent.TransportFee,
                                        ClientNum = ent.ClientNum.ToString(),
                                        AcceptAddress = ent.AcceptAddress,
                                        AcceptCellphone = ent.AcceptCellphone,
                                        AcceptTelephone = ent.AcceptTelephone,
                                        AcceptPeople = ent.AcceptPeople,
                                        AcceptUnit = ent.AcceptUnit,
                                        HouseID = ent.HouseID.ToString(),
                                        HouseName = hName,
                                        OP_ID = UserInfor.UserName,
                                        PushType = "0",
                                        PushStatus = "0",
                                        HLYSendUnit = HLYSendUnit,
                                        LogisID = ent.LogisID
                                    }, log);
                                }
                            }

                            //if (ent.HouseID.Equals(9))
                            //{
                            //    int pushType = 1;
                            //    if (!ent.LogisID.Equals(34))
                            //    {
                            //        bus.InsertCargoOrderPush(new CargoOrderPushEntity
                            //        {
                            //            OrderNo = ent.OrderNo,
                            //            Dep = ent.Dep,
                            //            Dest = ent.Dest,
                            //            Piece = ent.Piece,
                            //            TransportFee = ent.TransportFee,
                            //            ClientNum = ent.ClientNum.ToString(),
                            //            AcceptAddress = ent.AcceptAddress,
                            //            AcceptCellphone = ent.AcceptCellphone,
                            //            AcceptTelephone = ent.AcceptTelephone,
                            //            AcceptPeople = ent.AcceptPeople,
                            //            AcceptUnit = ent.AcceptUnit,
                            //            HouseID = ent.HouseID.ToString(),
                            //            HouseName = "广州仓库",
                            //            OP_ID = UserInfor.UserName,
                            //            PushType = "0",
                            //            PushStatus = "0",
                            //            LogisID = ent.LogisID,
                            //            Type = pushType
                            //        }, log);
                            //    }
                            //    else
                            //    {
                            //        if (ent.PostponeShip != "1")
                            //        {
                            //            if (!IsModify && !NoPromise)
                            //            {
                            //                bus.InsertCargoOrderPush(new CargoOrderPushEntity
                            //                {
                            //                    OrderNo = ent.OrderNo,
                            //                    Dep = ent.Dep,
                            //                    Dest = ent.Dest,
                            //                    Piece = ent.Piece,
                            //                    TransportFee = ent.TransportFee,
                            //                    ClientNum = ent.ClientNum.ToString(),
                            //                    AcceptAddress = ent.AcceptAddress,
                            //                    AcceptCellphone = ent.AcceptCellphone,
                            //                    AcceptTelephone = ent.AcceptTelephone,
                            //                    AcceptPeople = ent.AcceptPeople,
                            //                    AcceptUnit = ent.AcceptUnit,
                            //                    HouseID = ent.HouseID.ToString(),
                            //                    HouseName = "广州仓库",
                            //                    OP_ID = UserInfor.UserName,
                            //                    PushType = "0",
                            //                    PushStatus = "0",
                            //                    LogisID = ent.LogisID,
                            //                    Type = pushType
                            //                }, log);
                            //            }
                            //        }
                            //    }
                            //}
                            //else
                            //{


                            //}

                            #endregion
                            #region 推送企业微信通知
#if DEBUG
                            // DEBUG模式不执行企业微信推送
#else
                            QiyeBus qy = new QiyeBus();
                            //判断销售员ID是否绑定微信，如果绑定就推送下单消息，没有则不推
                            if (qy.IsExistQYUser(ent.SaleManID))
                            {
                                //微信企业号推送
                                string currDate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                                QySendInfoEntity send = new QySendInfoEntity();
                                send.title = "已开单";
                                send.msgType = msgType.textcard;
                                send.toUser = ent.SaleManID;
                                send.content = "<div>" + currDate + "</div><div></div><div>订单号：" + ent.OrderNo + "</div><div>到达站：" + ent.Dest + "</div><div>开单件数：" + ent.Piece.ToString() + " 件 --- 金额：" + ent.TotalCharge.ToString() + "元</div><div>收货人：" + ent.AcceptPeople + "</div><div>手机号码：" + ent.AcceptCellphone + "</div><div>收货地址：" + ent.AcceptAddress + "</div>";
                                send.url = "http://dlt.neway5.com/QY/qyQueryMyOrderInfo.aspx?OrderNo=" + ent.OrderNo;
                                WxQYSendHelper.PushInfo("0", "0", send);
                            }
                            if (ent.SaleManID.Equals("2407") || ent.SaleManID.Equals("2192") || ent.SaleManID.Equals("2352"))
                            {
                                //微信企业号推送
                                string currDate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                                QySendInfoEntity send = new QySendInfoEntity();
                                send.title = "已开单";
                                send.msgType = msgType.textcard;
                                send.toTag = "16";
                                send.content = "<div>" + currDate + "</div><div></div><div>订单号：" + ent.OrderNo + "</div><div>到达站：" + ent.Dest + "</div><div>开单件数：" + ent.Piece.ToString() + " 件 --- 金额：" + ent.TotalCharge.ToString() + "元</div><div>收货人：" + ent.AcceptPeople + "</div><div>手机号码：" + ent.AcceptCellphone + "</div><div>收货地址：" + ent.AcceptAddress + "</div><div>业务员：" + ent.SaleManName + "</div>";
                                send.url = "http://dlt.neway5.com/QY/qyQueryMyOrderInfo.aspx?OrderNo=" + ent.OrderNo;
                                WxQYSendHelper.PushInfo("0", "0", send);

                            }
                            //if (HouseID.Equals(10) && ent.ThrowGood.Equals("15"))
                            //{
                            //    List<QyTagEntity> tag = qy.QueryTagList(new QyTagEntity { TagType = "0", HouseID = entDest[0].HouseID });//查询所有用于推送下单信息的标签ID
                            //    string strTag = string.Empty;
                            //    if (tag != null && tag.Count > 0)
                            //    {
                            //        foreach (var it in tag)
                            //        {
                            //            strTag += it.Id.ToString() + "|";
                            //        }
                            //        strTag = strTag.Substring(0, strTag.Length - 1);
                            //    }
                            //    if (!string.IsNullOrEmpty(strTag))
                            //    {
                            //        //微信企业号推送
                            //        string currDate = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                            //        QySendInfoEntity send = new QySendInfoEntity();
                            //        send.title = "已开单";
                            //        send.msgType = msgType.textcard;
                            //        send.toTag = strTag;
                            //        send.content = "<div>" + currDate + "</div><div></div><div>订单号：" + ent.OrderNo + "</div><div>到达站：" + ent.Dest + "</div><div>开单件数：" + ent.Piece.ToString() + " 件 --- 金额：" + ent.TotalCharge.ToString() + "元</div><div>收货人：" + ent.AcceptPeople + "</div><div>手机号码：" + ent.AcceptCellphone + "</div><div>收货地址：" + ent.AcceptAddress + "</div>";
                            //        send.url = "http://dlt.neway5.com/QY/qyQueryMyOrderInfo.aspx?OrderNo=" + ent.OrderNo;
                            //        WxQYSendHelper.PushInfo("0", "0", send);
                            //    }
                            //}
#endif
                            #endregion

                        }
                    }
                    catch (Exception ex)
                    {
                        Common.WriteTextLog("市场采购错误" + ex.Message);
                        msg.Result = true;
                    }
                    try
                    {
                        if (msg.Result)
                        {
                            #region 推送给相关领导审批改价申请
                            if (IsModify || NoPromise)
                            {
                                CargoFinanceBus financeBus = new CargoFinanceBus();
                                CargoExpenseApproveRoutEntity approveRoute = new CargoExpenseApproveRoutEntity();
                                CargoOrderEntity order = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = ent.OrderNo });
                                //推送给相关领导审批改价申请
                                QyOrderUpdatePriceEntity result = new QyOrderUpdatePriceEntity();
                                result.HouseID = ent.HouseID;
                                result.ApplyID = UserInfor.LoginName;
                                result.ApplyName = UserInfor.UserName;
                                result.ApplyDate = DateTime.Now;
                                result.OrderNo = ent.OrderNo;
                                result.ApplyStatus = "0";
                                result.OrderType = "1";
                                result.OrderID = order.OrderID;
                                result.OrderCheckType = NoPromise && !ent.ThrowGood.Equals("12") ? "1" : ent.ThrowGood.Equals("13") ? "2" : ent.ThrowGood.Equals("4") ? "3" : ent.ThrowGood.Equals("12") ? "4" : ent.ThrowGood.Equals("18") ? "5" : ent.ThrowGood.Equals("15") ? "6" : ent.ThrowGood.Equals("16") ? "18" : ent.ThrowGood.Equals("17") ? "19" : "0";
                                string ApproveType = "3";
                                switch (ent.ThrowGood)
                                {
                                    case "13": ApproveType = "9"; break;//二批单
                                    case "4": ApproveType = "10"; break;//周期胎
                                    case "12": ApproveType = "11"; break;//OE订单单
                                    case "18": ApproveType = "12"; break;//异地单
                                    case "15": ApproveType = "13"; break;//城配单
                                    case "16": ApproveType = "18"; break;//促销单
                                    case "17": ApproveType = "19"; break;//急送单
                                    default: ApproveType = "3"; break;
                                }
                                //促销单
                                //if (ent.ThrowGood.Equals("16")) { ApproveType = "9"; result.OrderCheckType = "2"; }
                                //if (ent.ThrowGood.Equals("13")) { ApproveType = "9"; }
                                //1.查询审批设置表获得审批流程
                                QiyeBus qiye = new QiyeBus();
                                CargoFinanceBus f = new CargoFinanceBus();
                                //CargoApproveSetEntity AppSet = f.QueryApproveSetByID(33);
                                CargoApproveSetEntity AppSet = new CargoApproveSetEntity();
                                List<CargoApproveSetEntity> aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = ApproveType, DelFlag = "0", HouseID = ent.HouseID });
                                if (aset.Count > 0) { AppSet = aset[0]; }
                                else
                                {
                                    aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = "3", DelFlag = "0", HouseID = ent.HouseID });
                                    if (aset.Count > 0) { AppSet = aset[0]; }
                                }
                                List<QyUserEntity> qyUser = new List<QyUserEntity>();
                                //2.审批流程的每一级和当前人的审批角色相匹配
                                if (AppSet.OneCheckID.Equals("3"))
                                {
                                    SystemUserEntity entity = new SystemUserEntity();
                                    entity.LoginName = UserInfor.LoginName;
                                    SystemUserEntity bossLeader = bus.QueryBossLeaderByLoginName(entity);
                                    if (bossLeader != null)
                                    {
                                        //申请人有部门负责人
                                        if (!string.IsNullOrEmpty(bossLeader.LoginName))
                                        {
                                            if (bossLeader.LoginName != UserInfor.LoginName)
                                            {
                                                qyUser.Add(new QyUserEntity { UserID = bossLeader.LoginName, WxName = bossLeader.UserName });
                                                result.CheckID = AppSet.OneCheckID;
                                                result.CheckName = AppSet.OneCheckName;
                                            }
                                            //申请人部门负责人是自己，推送给下一级
                                            else
                                            {
                                                qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID, CheckHouseID = ent.HouseID.ToString() });
                                                result.CheckID = AppSet.TwoCheckID;
                                                result.CheckName = AppSet.TwoCheckName;
                                            }
                                        }
                                        //申请人没有部门负责人，推送给下一级
                                        else
                                        {
                                            qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID, CheckHouseID = ent.HouseID.ToString() });
                                            result.CheckID = AppSet.TwoCheckID;
                                            result.CheckName = AppSet.TwoCheckName;
                                        }
                                    }
                                    #region 2021-02-26替换为上方规则
                                    ////2021-02-26替换为上方规则
                                    //List<SystemUserEntity> Bosslist = bus.QueryUserBossLoginName(entity);
                                    //if (Bosslist.Count > 0)
                                    //{
                                    //    //申请人有部门负责人
                                    //    if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                    //    {
                                    //        //申请人部门负责人不是自己，推送给部门负责人
                                    //        if (Bosslist[0].LoginName != UserInfor.LoginName)
                                    //        {
                                    //            qyUser.Add(new QyUserEntity { UserID = Bosslist[0].LoginName, WxName = Bosslist[0].UserName });
                                    //            result.CheckID = AppSet.OneCheckID;
                                    //            result.CheckName = AppSet.OneCheckName;
                                    //        }
                                    //        //申请人部门负责人是自己，推送给下一级
                                    //        else
                                    //        {
                                    //            qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID });
                                    //            result.CheckID = AppSet.TwoCheckID;
                                    //            result.CheckName = AppSet.TwoCheckName;
                                    //        }
                                    //    }
                                    //    //申请人没有部门负责人，推送给下一级
                                    //    else
                                    //    {
                                    //        qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID });
                                    //        result.CheckID = AppSet.TwoCheckID;
                                    //        result.CheckName = AppSet.TwoCheckName;
                                    //    }
                                    //}
                                    #endregion
                                    //申请人信息跳过操作记录错误
                                    else
                                    {
                                        Common.WriteTextLog("推送失败：申请人未查询到数据");
                                        msg.Result = true;
                                        return;
                                    }
                                }
                                else
                                {
                                    qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = AppSet.OneCheckID, CheckHouseID = ent.HouseID.ToString() });
                                    result.CheckID = AppSet.OneCheckID;
                                    result.CheckName = AppSet.OneCheckName;
                                }

                                result.Reason = NoPromise ? "逾期客户目前有欠款未结清" : ent.Remark;
                                result.SaleManName = ent.SaleManName;
                                result.SaleManID = ent.SaleManID;
                                result.UpdatePriceGoodsList = goods;
                                long OID = qiye.AddOrderUpdatePrice(result, log);
                                approveRoute.ExID = OID;
                                approveRoute.UserID = Convert.ToString(UserInfor.UserID);
                                approveRoute.UserName = UserInfor.UserName;
                                approveRoute.Opera = "3";
                                approveRoute.Result = ent.Remark;
                                approveRoute.ApproveType = "1";
                                financeBus.AddExpenseApproveRout(approveRoute);
                                try
                                {
                                    ////推送通知给审批人  单价修改审批的标签
                                    //List<QyTagEntity> tag = qiye.QueryTagList(new QyTagEntity { TagType = "2", HouseID = UserInfor.HouseID });//查询所有用于推送下单信息的标签ID
                                    //string strTag = string.Empty;
                                    //if (tag != null && tag.Count > 0)
                                    //{
                                    //    foreach (var it in tag)
                                    //    {
                                    //        strTag += it.Id.ToString() + "|";
                                    //    }
                                    //    strTag = strTag.Substring(0, strTag.Length - 1);
                                    //}
                                    QySendInfoEntity send = new QySendInfoEntity();
                                    send.title = NoPromise ? "逾期客户下单申请" : "订单改价申请";
                                    send.msgType = msgType.textcard;
                                    //send.toTag = strTag;
                                    send.content = "<div></div><div>订单号：" + ent.OrderNo + "</div><div>收货人：" + ent.AcceptPeople + "  " + ent.AcceptCellphone + "</div><div>申请人：" + result.ApplyName + "</div><div>申请时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>申请原因：" + result.Reason + "</div><div>订单类型：电脑订单</div><div></div><div class=\"highlight\">请点击本通知进行审批！</div>";
                                    send.url = "http://dlt.neway5.com/QY/qyApproveCheck.aspx?OrderNo=" + ent.OrderNo + "&OID=" + OID + "&OrderType=1";
                                    foreach (var it in qyUser)
                                    {
                                        send.toUser = it.UserID;
                                        WxQYSendHelper.PushInfo("0", "2", send);
                                        Common.WriteTextLog("推送成功：" + it.WxName + ent.OrderNo);
                                    }

                                }
                                catch (ApplicationException ex)
                                {
                                    Common.WriteTextLog("推送失败：" + ent.OrderNo);
                                    msg.Result = true;
                                }
                            }
                            #endregion
                        }
                    }
                    catch (Exception)
                    {
                        msg.Result = true;
                    }
                }
            }

            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }

        /// <summary>
        /// 修改订单
        /// </summary>
        public void updateOrderData()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            CargoOrderBus bus = new CargoOrderBus();
            CargoHouseBus house = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "修改订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            string source = string.Empty;
            CargoOrderEntity hlyOrder = new CargoOrderEntity();
            CargoOrderEntity oldOrder = new CargoOrderEntity();
            CargoOrderEntity ord = new CargoOrderEntity();
            try
            {
                if (!UserInfor.IsModifyOrder.Equals("1"))
                {
                    msg.Message = "您没有修改订单的权限";
                    msg.Result = false;
                    goto ERROR;
                }
                ent.OrderID = Convert.ToInt64(Request["OrderID"]);
                ent.OrderNo = Convert.ToString(Request["OrderNo"]);
                ent.ThrowGood = string.IsNullOrEmpty(Convert.ToString(Request["ThrowGood"])) ? "0" : Convert.ToString(Request["ThrowGood"]);
                ord = bus.QueryOrderInfoByOrderID(ent.OrderID);
                //2021-11-25取消管理员特殊操作权限
                if (ord.FinanceSecondCheck.Equals("1"))
                {
                    msg.Message = "财务已审核，不允许修改"; msg.Result = false; goto ERROR;
                }
                if (!UserInfor.IsAdmin.Equals("1"))
                {
                    ////如果是管理员则不限制随便改
                    //if (ord.FinanceSecondCheck.Equals("1"))
                    //{
                    //    msg.Message = "财务已审核，不允许修改"; msg.Result = false;
                    //}
                    if (ord.CheckStatus.Equals("1"))
                    {
                        msg.Message = ent.OrderNo + "已结清，不允许修改"; msg.Result = false; goto ERROR;
                    }
                    if (ord.CheckStatus.Equals("2"))
                    {
                        msg.Message = ent.OrderNo + "结算中，不允许修改"; msg.Result = false; goto ERROR;
                    }
                }
                if (ord.HouseID.Equals(9) && !ent.ThrowGood.Equals("15"))
                {
                    hlyOrder = bus.QueryHlyOrderData(ord.OrderNo);
                }
                if (msg.Result)
                {
                    #region 赋值
                    ent.HAwbNo = Convert.ToString(Request["HAwbNo"]);
                    ent.Dep = Convert.ToString(Request["Dep"]);
                    ent.Dest = Convert.ToString(Request["Dest"]);
                    ent.Piece = string.IsNullOrEmpty(Convert.ToString(Request["Piece"])) ? 0 : Convert.ToInt32(Request["Piece"]);
                    ent.Weight = string.IsNullOrEmpty(Convert.ToString(Request["Weight"])) ? 0 : Convert.ToDecimal(Request["Weight"]);
                    ent.Volume = string.IsNullOrEmpty(Convert.ToString(Request["Volume"])) ? 0 : Convert.ToDecimal(Request["Volume"]);
                    ent.InsuranceFee = string.IsNullOrEmpty(Convert.ToString(Request["InsuranceFee"])) ? 0 : Convert.ToDecimal(Request["InsuranceFee"]);
                    ent.BateAmount = string.IsNullOrEmpty(Convert.ToString(Request["BateAmount"])) ? 0 : Convert.ToDecimal(Request["BateAmount"]);
                    ent.TransitFee = string.IsNullOrEmpty(Convert.ToString(Request["TransitFee"])) ? 0 : Convert.ToDecimal(Request["TransitFee"]);
                    ent.TransportFee = string.IsNullOrEmpty(Convert.ToString(Request["TransportFee"])) ? 0 : Convert.ToDecimal(Request["TransportFee"]);
                    ent.DeliveryFee = string.IsNullOrEmpty(Convert.ToString(Request["DeliveryFee"])) ? 0 : Convert.ToDecimal(Request["DeliveryFee"]);
                    ent.OtherFee = string.IsNullOrEmpty(Convert.ToString(Request["OtherFee"])) ? 0 : Convert.ToDecimal(Request["OtherFee"]);
                    ent.TotalCharge = string.IsNullOrEmpty(Convert.ToString(Request["TotalCharge"])) ? 0 : Convert.ToDecimal(Request["TotalCharge"]);
                    ent.Rebate = string.IsNullOrEmpty(Convert.ToString(Request["Rebate"])) ? 0 : Convert.ToDecimal(Request["Rebate"]);
                    ent.CollectMoney = string.IsNullOrEmpty(Convert.ToString(Request["CollectMoney"])) ? 0 : Convert.ToDecimal(Request["CollectMoney"]);

                    ent.CheckOutType = Convert.ToString(Request["CheckOutType"]);
                    //ent.ReturnAwb = string.IsNullOrEmpty(Convert.ToString(Request["ReturnAwb"])) ? 0 : Convert.ToInt32(Request["ReturnAwb"]);
                    ent.TrafficType = Convert.ToString(Request["TrafficType"]);
                    ent.DeliveryType = Convert.ToString(Request["DeliveryType"]);
                    ent.AcceptUnit = Convert.ToString(Request["AcceptUnit"]);
                    ent.AcceptAddress = Convert.ToString(Request["AcceptAddress"]);
                    ent.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
                    ent.AcceptPeople = ent.AcceptPeople.Split(',')[0];
                    ent.AcceptTelephone = Convert.ToString(Request["AcceptTelephone"]);
                    ent.AcceptCellphone = Convert.ToString(Request["AcceptCellphone"]);
                    ent.CreateAwb = Convert.ToString(Request["CreateAwb"]);
                    ent.CreateDate = Convert.ToDateTime(Request["CreateDate"]);
                    ent.OP_ID = UserInfor.LoginName.Trim();
                    ent.SaleManID = Convert.ToString(Request["SaleManID"]);
                    ent.SaleManName = Convert.ToString(Request["SaleManName"]);
                    ent.SaleCellPhone = Convert.ToString(Request["SaleCellPhone"]);
                    ent.Remark = Convert.ToString(Request["Remark"]);
                    ent.LogisID = Convert.ToInt32(Request["LogisID"]);
                    ent.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
                    ent.ClientNum = Convert.ToInt32(Request["ClientNum"]);
                    ent.ThrowGood = string.IsNullOrEmpty(Convert.ToString(Request["ThrowGood"])) ? "0" : Convert.ToString(Request["ThrowGood"]);
                    ent.IsPrintPrice = string.IsNullOrEmpty(Convert.ToString(Request["IsPrintPrice"])) ? 0 : 1;
                    //ent.TranHouse = Convert.ToString(Request["TranHouse"]);
                    ent.TranHouse = ent.ThrowGood.Equals("0") ? "" : Convert.ToString(Request["TranHouse"]);
                    ent.PostponeShip = string.IsNullOrEmpty(Convert.ToString(Request["PostponeShip"])) ? "0" : Convert.ToString(Request["PostponeShip"]);
                    ent.OpenOrderNo = Convert.ToString(Request["OpenOrderNo"]);
                    //ent.ClientNum = Common.GetClientNum();//生成随机的六位数字做为客户编码

                    if (Convert.ToString(Request["DeliverySettlement"]) != "-1")
                    {
                        ent.DeliverySettlement = Convert.ToString(Request["DeliverySettlement"]);
                    }
                    else
                    {
                        ent.DeliverySettlement = null;
                    }
                    #endregion
                    decimal trFee = 0.00M;
                    int pieceN = 0, pieceTotal = 0;
                    string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                                                                                                     //新的订单产品数据
                    foreach (Hashtable row in GridRows)
                    {
                        source = Convert.ToString(row["Source"]);
                        if (Convert.ToInt32(row["InPiece"]).Equals(0) && Convert.ToInt32(row["Piece"]).Equals(0))
                        {
                            continue;
                        }
                        entDest.Add(new CargoOrderGoodsEntity
                        {
                            OrderNo = ent.OrderNo,
                            ProductID = Convert.ToInt64(row["ProductID"]),
                            HouseID = Convert.ToInt32(row["HouseID"]),
                            AreaID = Convert.ToInt32(row["AreaID"]),
                            Piece = Convert.ToInt32(row["InPiece"]) == 0 ? Convert.ToInt32(row["Piece"]) : Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]),
                            ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
                            ContainerCode = Convert.ToString(row["ContainerCode"]),
                            OutCargoID = string.IsNullOrEmpty(Convert.ToString(row["OutCargoID"])) ? outID : Convert.ToString(row["OutCargoID"]),
                            ID = Convert.ToInt64(row["ID"]),
                            RuleType = Convert.ToString(row["RuleType"]).Trim(),
                            RuleID = Convert.ToString(row["RuleID"]).Trim(),
                            RuleTitle = Convert.ToString(row["RuleTitle"]).Trim(),
                            ShowGoodsCode = Convert.ToString(row["ShowGoodsCode"]),
                            ShowTypeName = Convert.ToString(row["ShowTypeName"]),
                            ShowProductCode = Convert.ToString(row["ShowProductCode"]),
                            OP_ID = UserInfor.LoginName.Trim()
                        });

                        pieceN = Convert.ToInt32(row["InPiece"]) == 0 ? Convert.ToInt32(row["Piece"]) : Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);
                        pieceTotal += pieceN;
                        trFee += pieceN * Convert.ToDecimal(row["ActSalePrice"]);
                        CargoContainerShowEntity cargo = new CargoContainerShowEntity();

                        cargo.OutCargoID = string.IsNullOrEmpty(Convert.ToString(row["OutCargoID"])) ? outID : Convert.ToString(row["OutCargoID"]);
                        cargo.ContainerID = Convert.ToInt32(row["ContainerID"]);
                        cargo.TypeID = Convert.ToInt32(row["TypeID"]);
                        cargo.ProductID = Convert.ToInt64(row["ProductID"]);
                        cargo.Piece = Convert.ToInt32(row["InPiece"]) == 0 ? Convert.ToInt32(row["Piece"]) : Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);//出库件数
                        cargo.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                        cargo.InPiece = Convert.ToInt32(row["InPiece"]);
                        cargo.ID = Convert.ToInt64(row["ID"]);

                        cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                        cargo.HouseName = Convert.ToString(row["HouseName"]).Trim();
                        cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                        cargo.ProductName = Convert.ToString(row["ProductName"]).Trim();
                        cargo.Model = Convert.ToString(row["Model"]).Trim();
                        cargo.Specs = Convert.ToString(row["Specs"]).Trim();
                        cargo.Figure = Convert.ToString(row["Figure"]).Trim();
                        cargo.Batch = Convert.ToString(row["Batch"]).Trim();
                        cargo.GoodsCode = Convert.ToString(row["GoodsCode"]).Trim();
                        cargo.OrderNo = ent.OrderNo;
                        outHouseList.Add(cargo);
                    }
                    if (ent.ThrowGood != "9")
                    {
                        //马牌不用再减去优惠卷，TransportFee已经去了优惠卷金额
                        if (!string.IsNullOrEmpty(ord.OpenOrderNo) && ord.OpenOrderSource == "0")
                        {
                            ent.TransportFee = trFee;
                            ent.TotalCharge = ent.TransportFee + ent.TransitFee + ent.OtherFee - ent.BateAmount;
                        }
                        else
                        {
                            ent.TransportFee = trFee;
                            ent.TotalCharge = ent.TransportFee + ent.TransitFee + ent.OtherFee - ent.InsuranceFee - ent.BateAmount;
                        }

                    }
                    else
                    {
                        ent.TransportFee = 0;
                        ent.TotalCharge = 0;
                    }
                    //ent.TransportFee = trFee;
                    ent.Piece = pieceTotal;
                    //ent.TotalCharge = ent.TransportFee + ent.TransitFee + ent.DeliveryFee + ent.OtherFee + ent.InsuranceFee;
                    ent.HouseID = entDest[0].HouseID;
                    ent.goodsList = entDest;
                    oldOrder = bus.QueryOrderInfoByOrderID(ent.OrderID);

                    if (oldOrder.Dep != ent.Dep || oldOrder.Dest != ent.Dest || oldOrder.Piece != ent.Piece || oldOrder.AcceptUnit != ent.AcceptUnit || oldOrder.AcceptPeople != ent.AcceptPeople || oldOrder.AcceptCellphone != ent.AcceptCellphone || oldOrder.AcceptTelephone != ent.AcceptTelephone || oldOrder.AcceptAddress != ent.AcceptAddress)
                    {
                        if (!string.IsNullOrEmpty(hlyOrder.AwbStatus) && hlyOrder.AwbStatus.Equals("已开单"))
                        {
                            msg.Message = ent.OrderNo + "好来运系统已开单，请联系系统人员修改";
                            msg.Result = false;
                        }
                    }
                    //if (oldOrder.HouseID.Equals(9) || oldOrder.HouseID.Equals(93))
                    //{
                    //    if (oldOrder.LogisID.Equals(34))
                    //    {
                    //        string jsonString = "{\"PlanOrderNo\": \"" + oldOrder.PlanOrderNo + "\"}";
                    //        string hlyres = wxHttpUtility.SendHttpRequest(Common.GetHLYAPI() + "/api/CargoInterface/getByOrderNo", jsonString, "application/json");
                    //        JavaScriptSerializer js = new JavaScriptSerializer();
                    //        HLYgetByOrderNoReturn HLYReturn = js.Deserialize<HLYgetByOrderNoReturn>(hlyres);
                    //        if (!HLYReturn.State)
                    //        {
                    //            msg.Message = ent.OrderNo + "无法修改，好来运系统" + HLYReturn.Errmsg;
                    //            msg.Result = false;
                    //            goto ERROR;
                    //        }
                    //    }
                    //}
                    //else
                    //{

                    //}

                    //如果修改了件数则验证好来运
                    //if (oldOrder.Piece != ent.Piece)
                    //{
                    //    if (!string.IsNullOrEmpty(hlyOrder.AwbStatus) && hlyOrder.AwbStatus.Equals("已开单"))
                    //    {
                    //        msg.Message = ent.OrderNo + "好来运系统已开单，请联系系统人员修改";
                    //        msg.Result = false;
                    //    }
                    //}

                    //if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])) && !Convert.ToString(Request["PayClientNum"]).Equals("0"))
                    //{
                    //    ent.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
                    //    if (ent.PayClientNum.Equals(ent.ClientNum))
                    //    {
                    //        ent.PayClientName = ent.AcceptPeople;
                    //    }
                    //    else
                    //    {
                    //        ent.PayClientName = Convert.ToString(Request["PayClientName"]);//付款人客户姓名
                    //    }
                    //}
                    //else
                    //{
                    //    ent.PayClientNum = ent.ClientNum;
                    //    ent.PayClientName = ent.AcceptPeople;
                    //}

                    if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])) && !Convert.ToString(Request["PayClientNum"]).Equals("0"))
                    {
                        ent.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
                        ent.PayClientName = Convert.ToString(Request["PayClientName"]);//付款人客户姓名
                    }
                    else
                    {
                        ent.PayClientNum = ent.ClientNum;
                        ent.PayClientName = Convert.ToString(Request["HiddenClientSelectName"]);
                    }


                    if (msg.Result)
                    {

                        //仓库同步缓存
                        foreach (CargoContainerShowEntity time in outHouseList)
                        {
                            CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                            //34 马牌  1 同步马牌  2 同步全部品牌
                            if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                            {
                                RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                            }
                        }

                        bus.UpdateOrderInfo(ent, outHouseList, log);
                        msg.Result = true;
                        msg.Message = ent.OrderNo + "/" + outID;//订单号和出库单号
                                                                //house.saveOutCargoData(outHouseList, log);
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            try
            {
                //订单数量和订单总收入不相等说明修改了件数和价格，要推送消息给财务
                //if (oldOrder.Piece != ent.Piece || oldOrder.TotalCharge != ent.TotalCharge)
                //{
                //    QiyeBus qy = new QiyeBus();

                //    List<QyTagEntity> tag = qy.QueryTagList(new QyTagEntity { TagType = "1", HouseID = entDest[0].HouseID });//查询所有用于推送下单信息的标签ID
                //    string strTag = string.Empty;
                //    if (tag != null && tag.Count > 0)
                //    {
                //        foreach (var it in tag)
                //        {
                //            strTag += it.Id.ToString() + "|";
                //        }
                //        strTag = strTag.Substring(0, strTag.Length - 1);

                //        string currDate = DateTime.Now.Year.ToString() + "年" + DateTime.Now.Month.ToString() + "月" + DateTime.Now.Day.ToString() + "日";
                //        QySendInfoEntity send = new QySendInfoEntity();
                //        send.title = "订单修改通知";
                //        send.msgType = msgType.textcard;
                //        send.toTag = strTag;
                //        send.content = "<div>" + currDate + "</div><div></div><div>订单号：" + ent.OrderNo + "    " + ent.AcceptPeople.ToString() + "</div><div>修改前：" + oldOrder.Piece.ToString() + " 条   " + oldOrder.TotalCharge.ToString() + " 元</div><div>修改后：" + ent.Piece.ToString() + " 条   " + ent.TotalCharge.ToString() + " 元</div><div>业务员：" + ent.SaleManName + "</div><div></div><div class=\"highlight\">操作人：" + UserInfor.UserName + " 于" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + " 修改了订单数据！</div>";
                //        send.url = "dlt.neway5.com";
                //        WxQYSendHelper.PushInfo("0", "0", send);
                //    }
                //}
                if ((ent.HouseID.Equals(9) && !ent.ThrowGood.Equals("15")) || ent.HouseID.Equals(15) || ent.HouseID.Equals(49) || ent.HouseID.Equals(50) || ent.HouseID.Equals(51) || ent.HouseID.Equals(52) || ent.HouseID.Equals(53) || ent.HouseID.Equals(54) || ent.HouseID.Equals(13) || ent.HouseID.Equals(14) || ent.HouseID.Equals(10) || ent.HouseID.Equals(23) || ent.HouseID.Equals(30) || ent.HouseID.Equals(93))
                {
                    if (!string.IsNullOrEmpty(ent.CreateAwb) && (ord.AwbStatus.Equals("0") || ord.AwbStatus.Equals("1")))
                    {
                        if (string.IsNullOrEmpty(hlyOrder.AwbStatus) || hlyOrder.AwbStatus.Equals("未开单"))
                        {
                            //判断必须选择好来运速递
                            if (ent.LogisID.Equals(34))
                            {
                                //等通知发货的订单不推送
                                if (ent.PostponeShip != "1")
                                {
                                    List<CargoOrderEntity> oe = new List<CargoOrderEntity>();
                                    oe.Add(ent);
                                    bus.DelHlyOrderData(oe);
                                    //内部订单
                                    bus.SaveHlyOrderData(outHouseList, ent);
                                    //if (!source.Equals("9"))
                                    //{
                                    //    List<CargoOrderEntity> oe = new List<CargoOrderEntity>();
                                    //    oe.Add(ent);
                                    //    bus.DelHlyOrderData(oe);
                                    //    //内部订单
                                    //    bus.SaveHlyOrderData(outHouseList, ent);
                                    //}
                                    //else
                                    //{
                                    //    Common.WriteTextLog("修改市场采购" + ent.OrderNo);
                                    //    bus.DelHlyOutOrderData(ent.OrderNo);
                                    //    //市场采购
                                    //    bus.SaveHlyOutOrderData(ent);
                                    //}
                                }
                            }
                        }
                    }
                }
                else
                {

                    CargoHouseEntity cargoHouseEntity = house.QueryCargoHouseByID(ord.HouseID);
                    //bus.InsertCargoOrderPush(new CargoOrderPushEntity
                    //{
                    //    OrderNo = ent.OrderNo,
                    //    Dep = ent.Dep,
                    //    Dest = ent.Dest,
                    //    Piece = ent.Piece,
                    //    TransportFee = ent.TransportFee,
                    //    ClientNum = ent.ClientNum.ToString(),
                    //    AcceptAddress = ent.AcceptAddress,
                    //    AcceptCellphone = ent.AcceptCellphone,
                    //    AcceptTelephone = ent.AcceptTelephone,
                    //    AcceptPeople = ent.AcceptPeople,
                    //    AcceptUnit = ent.AcceptUnit,
                    //    HouseID = ent.HouseID.ToString(),
                    //    HouseName = cargoHouseEntity.Name,
                    //    OP_ID = UserInfor.UserName,
                    //    PushType = "1",
                    //    PushStatus = "0",
                    //    LogisID = ent.LogisID,
                    //    Type = 1
                    //}, log);


                    bus.UpdateCargoOrderPush(new CargoOrderPushEntity { OrderNo = ent.OrderNo, Piece = ent.Piece, PushType = "1", PushStatus = "0", Dest = ent.Dest, ClientNum = Convert.ToString(ent.ClientNum), AcceptUnit = ent.AcceptUnit, AcceptAddress = ent.AcceptAddress, AcceptPeople = ent.AcceptPeople, AcceptCellphone = ent.AcceptCellphone, AcceptTelephone = ent.AcceptTelephone, LogisID = ent.LogisID }, log);
                }
            }
            catch (Exception ex)
            {
                Common.WriteTextLog("修改出错" + ex.Message);
                msg.Result = true;
            }
        ERROR:
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 保存物流单号
        /// </summary>
        public void UpdateLogisAwbNo()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderEntity ent = new CargoOrderEntity();
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "订单管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";

            try
            {
                ent.OrderID = Convert.ToInt64(Request["OrderID"]);
                ent.OrderNo = Convert.ToString(Request["OrderNo"]);
                ent.LogisID = Convert.ToInt32(Request["LogisID"]);
                ent.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
                ent.Dest = Convert.ToString(Request["Dest"]);
                ent.SaleManID = Convert.ToString(Request["SaleManID"]);
                ent.SaleManName = Convert.ToString(Request["BSaleManName"]);
                ent.SaleCellPhone = Convert.ToString(Request["BSaleCellPhone"]);
                ent.DeliveryFee = string.IsNullOrEmpty(Convert.ToString(Request["BTransitFee"])) ? 0 : Convert.ToDecimal(Request["BTransitFee"]);
                ent.HAwbNo = Convert.ToString(Request["HAwbNo"]);
                ent.OpenExpressName = Convert.ToString(Request["OpenExpressName"]);
                ent.OpenExpressNum = Convert.ToString(Request["OpenExpressNum"]);
                //物流结算方式
                if (Convert.ToString(Request["BDeliverySettlement"]) != "-1")
                {
                    ent.DeliverySettlement = Convert.ToString(Request["BDeliverySettlement"]);
                }
                else
                {
                    ent.DeliverySettlement = "";
                }
                bus.UpdateLogisAwbNo(ent, log);
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 保存订单自提的提货数据
        /// </summary>
        public void SaveOrderDeliveryInfo()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderStatusEntity entity = new CargoOrderStatusEntity();
            entity.OrderNo = Convert.ToString(Request["OrderNo"]);
            entity.OrderID = Convert.ToInt64(Request["OrderID"]);
            entity.OrderStatus = "10";//上传提货照片
            entity.OP_ID = UserInfor.LoginName;
            entity.OP_Name = UserInfor.UserName;
            entity.OP_DATE = DateTime.Now;

            entity.DeliveryDriverName = Convert.ToString(Request["DeliveryDriverName"]);
            entity.DriverCellphone = Convert.ToString(Request["DriverCellphone"]);
            entity.DriverCarNum = Convert.ToString(Request["DriverCarNum"]);
            entity.DriverIDNum = Convert.ToString(Request["DriverIDNum"]);
            CargoOrderBus bus = new CargoOrderBus();
            string SignImagStr = string.Empty;
            for (int i = 0; i < Request.Files.Count; i++)
            {
                string imgName = string.Empty;
                string imgPath = string.Empty;
                HttpPostedFile imgFile = Request.Files[i];
                if (string.IsNullOrEmpty(imgFile.FileName)) { continue; }
                Common.SavePic(Request.Files[i], "../upload/SignImage", ref imgName, ref imgPath);
                SignImagStr += "http://dlt.neway5.com/upload/SignImage/" + imgName + "|";
            }
            entity.SignImage = SignImagStr;
            bus.SaveOrderDeliveryInfo(entity);

            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }

        public void QueryDeliveryOrderStatus()
        {
            CargoOrderStatusEntity queryEntity = new CargoOrderStatusEntity();
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.OrderStatus = Convert.ToString(Request["OrderStatus"]);
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoOrderStatusEntity> result = bus.QueryOrderStatus(queryEntity);
            List<CargoOrderStatusEntity> statusEntities = new List<CargoOrderStatusEntity>();
            if (result.Count > 0)
            {
                foreach (var it in result)
                {
                    string tf = string.Empty;
                    string img = string.Empty;
                    switch (it.OrderStatus.Trim())
                    {
                        case "10":
                            string[] im = it.SignImage.Split('|');
                            if (im.Length > 0)
                            {
                                for (int i = 0; i < im.Length; i++)
                                {
                                    if (string.IsNullOrEmpty(im[i])) { continue; }
                                    statusEntities.Add(new CargoOrderStatusEntity
                                    {
                                        ID = it.ID,
                                        SignImage = im[i],
                                        OP_DATE = it.OP_DATE
                                    });
                                }
                            }
                            break;
                        default:
                            break;
                    }
                }
            }
            String json = JSON.Encode(statusEntities);
            Response.Write(json);
        }
        /// <summary>
        /// 通过部门代码查询该部门下用户
        /// </summary>
        public void QueryUserByDepCode()
        {
            string depCode = Common.GetDLTDepCode();
            string houseID = string.IsNullOrEmpty(Convert.ToString(Request["houseID"])) ? UserInfor.HouseID.ToString() : Convert.ToString(Request["houseID"]);
            string cqd = string.Format("cmd={0}&depCode={1}&houseID={2}", "queryUserInfoByDepCode", depCode, houseID);
            string result = wxHttpUtility.SendHttpRequest(Common.GethouseAPI(), cqd);
            userAPIMessage rows = Newtonsoft.Json.JsonConvert.DeserializeObject<userAPIMessage>(result);
            List<SystemUserEntity> list = new List<SystemUserEntity>();
            if (rows.Result)
            {
                list = rows.userList;
            }
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 通过部门代码查询该部门下用户
        /// </summary>
        public void QueryUserByDepCodes()
        {
            CargoOrderBus orderBus = new CargoOrderBus();
            var UserByDepCode = orderBus.GetSysUsers();
            var UserByDepCodes = UserByDepCode.GroupBy(a => new { a.UserName, a.LoginName, a.CellPhone })
                .Select(a => new { UserName = a.Key.UserName, LoginName = a.Key.LoginName, CellPhone = a.Key.CellPhone }).ToList();
            //JSON
            String json = JSON.Encode(UserByDepCodes);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 根据订单号查询订单的跟踪状态 
        /// </summary>
        public void QueryOrderStatus()
        {
            string OrderNo = Request["OrderNo"];
            string LogisAwbNo = Request["LogisAwbNo"];
            string ThrowGood = Convert.ToString(Request["ThrowGood"]);
            string BelongHouse = Convert.ToString(Request["BelongHouse"]);
            string TrafficType = Convert.ToString(Request["TrafficType"]);
            int HouseID = Convert.ToInt32(Request["HouseID"]);
            int LogisID = Convert.ToInt32(Request["LogisID"]);
            string res = string.Empty;
            CargoOrderBus bus = new CargoOrderBus();
            OrderStatusReturnEntity returnEntity = new OrderStatusReturnEntity();
            if (LogisID.Equals(34) && !string.IsNullOrEmpty(LogisAwbNo))
            {
                string source = string.Empty;
                CargoOrderEntity ord = new CargoOrderEntity();
                List<CargoContainerShowEntity> show = bus.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = OrderNo });
                if (show.Count > 0)
                {
                    source = show[0].Source;
                }
                if (source.Equals("9"))
                {
                    //外采
                    ord = bus.QueryHlyOutOrderData(OrderNo);
                    if (string.IsNullOrEmpty(ord.HAwbNo))
                    {
                        ord = bus.QueryHlyOutOrderAwbno(OrderNo);
                    }
                }
                else
                {
                    ord = bus.QueryHlyOrderData(OrderNo);

                }
                if (!string.IsNullOrEmpty(ord.HAwbNo))
                {
                    //广州仓库查询好来运运单跟踪表
                    res = "<div style='font-size:14px;font-weight:bold'>订单号：" + OrderNo + " 物流单号：" + ord.HAwbNo + " 的物流跟踪状态";
                    res += "</div>";
                    res += "<table class='commTblStyle_8' border='0' width='100%' style='border-spacing:0;border-collapse:collapse;font-size:14px;'><tbody><tr><th>操作时间</th><th>操作人</th><th>物流状态</th></tr>";
                    List<CargoOrderStatusEntity> HlyOrderStatus = bus.QueryHlyOrderStatus(ord.HAwbNo);
                    if (HlyOrderStatus.Count > 0)
                    {
                        foreach (var it in HlyOrderStatus)
                        {
                            string url = "http://sign.haolaiyun.com:998/images/";
                            if (!string.IsNullOrEmpty(it.Signer))
                            {
                                url += it.Signer;
                                res += "<tr><td>" + it.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss") + "</td><td>" + it.OP_Name + "</td><td>" + it.DetailInfo + "<img  onclick=download(\"" + url + "\") src=" + url + " style='width:30px; height:20px;margin-left:3px;'></td></tr>";
                            }
                            else
                            {
                                res += "<tr><td>" + it.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss") + "</td><td>" + it.OP_Name + "</td><td>" + it.DetailInfo + "</td></tr>";
                            }
                        }
                        res += "</tbody><table>";
                    }
                }
                else
                {
                    //广州仓库查询好来运运单跟踪表
                    res = "<div style='font-size:14px;font-weight:bold'>订单号：" + OrderNo + "  的物流跟踪状态";
                    res += "</div>";
                    res += "<table class='commTblStyle_8' border='0' width='100%' style='border-spacing:0;border-collapse:collapse;font-size:14px;'><tbody><tr><th>操作时间</th><th>操作人</th><th>物流状态</th></tr>";
                    res += "<tr><td colspan=3>无数据</td></tr></tbody><table>";
                }
                returnEntity.HtmlStr2 = res;
            }
            CargoOrderStatusEntity queryEntity = new CargoOrderStatusEntity();
            queryEntity.OrderNo = OrderNo;
            returnEntity.Status = -1;
            List<CargoOrderStatusEntity> result = bus.QueryOrderStatus(queryEntity);
            if (result.Count > 0)
            {
                if (!string.IsNullOrEmpty(LogisAwbNo))
                {
                    res = "<div style='font-size:14px;font-weight:bold'>订单号：" + result[0].OrderNo + " 物流单号：" + LogisAwbNo + " 的物流跟踪状态";
                }
                else
                {
                    res = "<div style='font-size:14px;font-weight:bold'>订单号：" + result[0].OrderNo + "  的跟踪记录";
                }
                res += "</div>";
                res += "<table class='commTblStyle_8' border='0' width='100%' style='border-spacing:0;border-collapse:collapse;font-size:14px;'><tbody><tr><th>操作时间</th><th>操作人</th><th>订单状态</th></tr>";
                foreach (var it in result)
                {
                    string tf = string.Empty;
                    string img = string.Empty;
                    switch (it.OrderStatus.Trim())
                    {
                        case "0":
                            returnEntity.StartLatitude = it.Latitude;
                            returnEntity.StartLongitude = it.Longitude;
                            returnEntity.StartTime = it.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss");
                            if (returnEntity.Status == -1)
                            {
                                returnEntity.Status = 0;
                            }
                            tf = "<span style='color:red;font-weight:bold;'>已下单</span>"; break;
                        case "1":
                            if (returnEntity.Status == -1)
                            {
                                returnEntity.Status = 1;
                            }
                            tf = "<span style='color:red;font-weight:bold;'>出库中</span>"; break;
                        case "2":
                            if (returnEntity.Status == -1)
                            {
                                returnEntity.Status = 2;
                            }
                            tf = "<span style='color:red;font-weight:bold;'>已出库</span>"; break;
                        case "3":
                            if (returnEntity.Status == -1)
                            {
                                returnEntity.Status = 3;
                            }
                            tf = "<span style='color:red;font-weight:bold;'>已发车</span>"; break;
                        case "4":
                            if (returnEntity.Status == -1)
                            {
                                returnEntity.Status = 4;
                            }
                            tf = "<span style='color:red;font-weight:bold;'>已到达</span>"; break;
                        case "5":
                            if (returnEntity.Status == -1)
                            {
                                returnEntity.Status = 5;
                            }
                            //if (string.IsNullOrEmpty(it.Latitude) || string.IsNullOrEmpty(it.Longitude))
                            //{
                            //    string[] coordinate = geocodeAddress(it.OrderNo);
                            //    if (coordinate != null)
                            //    {
                            //        returnEntity.EndLongitude = coordinate[0];
                            //        returnEntity.EndLatitude = coordinate[1];
                            //    }
                            //}
                            //else
                            //{
                            //    returnEntity.EndLatitude = it.Latitude;
                            //    returnEntity.EndLongitude = it.Longitude;
                            //}
                            returnEntity.EndTime = it.SignTime.ToString("yyyy-MM-dd HH:mm:ss");

                            tf = "<span style='color:red;font-weight:bold;'>已签收</span>"; it.OP_Name = it.Signer;
                            string[] im = it.SignImage.Split('|');
                            if (im.Length > 0)
                            {
                                for (int i = 0; i < im.Length; i++)
                                {
                                    if (string.IsNullOrEmpty(im[i])) { continue; }
                                    img += "<img onclick=download(\"" + im[i] + "\") style='width:30px; height:20px;margin-left:3px;' src='" + im[i] + "' title='点击查看图片'/>";
                                }
                            }
                            //tf += "<img onclick=download(\"" + file.TbFilePath + "\") style='width:30px; height:20px;margin-left:3px;' src='../" + file.TbFilePath + "' title='点击查看图片'/>";
                            break;
                        case "6":
                            if (returnEntity.Status == -1)
                            {
                                returnEntity.Status = 6;
                            }
                            tf = "<span style='color:red;font-weight:bold;'>已拣货</span>"; break;
                        case "8":
                            if (returnEntity.Status == -1)
                            {
                                returnEntity.Status = 8;
                            }
                            tf = "<span style='color:red;font-weight:bold;'>已接单</span>"; break;
                        case "9":
                            if (returnEntity.Status == -1)
                            {
                                returnEntity.Status = 9;
                            }
                            tf = "<span style='color:red;font-weight:bold;'>已提货</span>"; break;
                        default:
                            break;
                    }
                    res += "<tr><td>" + it.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss") + "</td><td>" + it.OP_Name + "</td><td>" + tf + it.DetailInfo + img + "</td></tr>";
                }
                //if (!string.IsNullOrEmpty(returnEntity.StartLatitude) && !string.IsNullOrEmpty(returnEntity.EndLatitude))
                //{
                //    decimal differ = Convert.ToDecimal(returnEntity.EndLatitude) - Convert.ToDecimal(returnEntity.StartLatitude);
                //    if (System.Math.Abs(differ) < Convert.ToDecimal(0.01))
                //    {
                //        string[] coordinate = geocodeAddress(OrderNo);
                //        if (coordinate != null)
                //        {
                //            returnEntity.EndLongitude = coordinate[0];
                //            returnEntity.EndLatitude = coordinate[1];
                //        }
                //    }
                //}
                //else
                //{
                //    string[] coordinate = geocodeAddress(OrderNo);
                //    if (coordinate != null)
                //    {
                //        returnEntity.EndLongitude = coordinate[0];
                //        returnEntity.EndLatitude = coordinate[1];
                //    }
                //}
                //if (!string.IsNullOrEmpty(returnEntity.StartLatitude) && !string.IsNullOrEmpty(returnEntity.StartLongitude) && !string.IsNullOrEmpty(returnEntity.EndLatitude) && !string.IsNullOrEmpty(returnEntity.EndLongitude))
                //{
                //    returnEntity.Distance = (GetDistance(Convert.ToDouble(returnEntity.StartLatitude), Convert.ToDouble(returnEntity.StartLongitude), Convert.ToDouble(returnEntity.EndLatitude), Convert.ToDouble(returnEntity.EndLongitude))).ToString("f0");
                //}
                res += "</tbody><table>";
                returnEntity.HtmlStr = res;
            }
            #region 采用以上同时查询好来运与系统状态
            //if ((HouseID.Equals(9) && !ThrowGood.Equals("15")) && BelongHouse.Contains("0") || HouseID.Equals(50) || HouseID.Equals(53) || TrafficType.Equals("2"))
            //{
            //    string source = string.Empty;
            //    CargoOrderEntity ord = new CargoOrderEntity();
            //    List<CargoContainerShowEntity> show = bus.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = OrderNo });
            //    if (show.Count > 0)
            //    {
            //        source = show[0].Source;
            //    }
            //    if (source.Equals("9"))
            //    {
            //        //外采
            //        ord = bus.QueryHlyOutOrderData(OrderNo);
            //        if (string.IsNullOrEmpty(ord.HAwbNo))
            //        {
            //            ord = bus.QueryHlyOutOrderAwbno(OrderNo);
            //        }
            //    }
            //    else
            //    {
            //        ord = bus.QueryHlyOrderData(OrderNo);

            //    }
            //    if (!string.IsNullOrEmpty(ord.HAwbNo))
            //    {
            //        //广州仓库查询好来运运单跟踪表
            //        res = "<div style='font-size:14px;font-weight:bold'>订单号：" + OrderNo + " 物流单号：" + ord.HAwbNo + " 的物流跟踪状态";
            //        res += "</div>";
            //        res += "<table class='commTblStyle_8' border='0' width='100%' style='border-spacing:0;border-collapse:collapse;font-size:14px;'><tbody><tr><th>操作时间</th><th>操作人</th><th>物流状态</th></tr>";
            //        List<CargoOrderStatusEntity> result = bus.QueryHlyOrderStatus(ord.HAwbNo);
            //        if (result.Count > 0)
            //        {

            //            foreach (var it in result)
            //            {
            //                string url = "http://sign.haolaiyun.com:998/images/";
            //                if (!string.IsNullOrEmpty(it.Signer))
            //                {
            //                    url += it.Signer;
            //                    res += "<tr><td>" + it.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss") + "</td><td>" + it.OP_Name + "</td><td>" + it.DetailInfo + "<img  onclick=download(\"" + url + "\") src=" + url + " style='width:30px; height:20px;margin-left:3px;'></td></tr>";
            //                }
            //                else
            //                {
            //                    res += "<tr><td>" + it.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss") + "</td><td>" + it.OP_Name + "</td><td>" + it.DetailInfo + "</td></tr>";
            //                }
            //            }
            //            res += "</tbody><table>";
            //        }
            //    }
            //    else
            //    {
            //        //广州仓库查询好来运运单跟踪表
            //        res = "<div style='font-size:14px;font-weight:bold'>订单号：" + OrderNo + "  的物流跟踪状态";
            //        res += "</div>";
            //        res += "<table class='commTblStyle_8' border='0' width='100%' style='border-spacing:0;border-collapse:collapse;font-size:14px;'><tbody><tr><th>操作时间</th><th>操作人</th><th>物流状态</th></tr>";
            //        res += "<tr><td colspan=3>无数据</td></tr></tbody><table>";
            //    }
            //}
            //else
            //{
            //    List<CargoContainerShowEntity> show = bus.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = OrderNo });

            //    CargoOrderStatusEntity queryEntity = new CargoOrderStatusEntity();
            //    queryEntity.OrderNo = OrderNo;
            //    returnEntity.Status = -1;
            //    List<CargoOrderStatusEntity> result = bus.QueryOrderStatus(queryEntity);
            //    if (result.Count > 0)
            //    {
            //        if (!string.IsNullOrEmpty(LogisAwbNo))
            //        {
            //            res = "<div style='font-size:14px;font-weight:bold'>订单号：" + result[0].OrderNo + " 物流单号：" + LogisAwbNo + " 的物流跟踪状态";
            //        }
            //        else
            //        {
            //            res = "<div style='font-size:14px;font-weight:bold'>订单号：" + result[0].OrderNo + "  的跟踪记录";
            //        }
            //        res += "</div>";
            //        res += "<table class='commTblStyle_8' border='0' width='100%' style='border-spacing:0;border-collapse:collapse;font-size:14px;'><tbody><tr><th>操作时间</th><th>操作人</th><th>订单状态</th></tr>";
            //        foreach (var it in result)
            //        {
            //            string tf = string.Empty;
            //            string img = string.Empty;
            //            switch (it.OrderStatus.Trim())
            //            {
            //                case "0":
            //                    returnEntity.StartLatitude = it.Latitude;
            //                    returnEntity.StartLongitude = it.Longitude;
            //                    returnEntity.StartTime = it.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss");
            //                    if (returnEntity.Status == -1)
            //                    {
            //                        returnEntity.Status = 0;
            //                    }
            //                    tf = "<span style='color:red;font-weight:bold;'>已下单</span>"; break;
            //                case "1":
            //                    if (returnEntity.Status == -1)
            //                    {
            //                        returnEntity.Status = 1;
            //                    }
            //                    tf = "<span style='color:red;font-weight:bold;'>出库中</span>"; break;
            //                case "2":
            //                    if (returnEntity.Status == -1)
            //                    {
            //                        returnEntity.Status = 2;
            //                    }
            //                    tf = "<span style='color:red;font-weight:bold;'>已出库</span>"; break;
            //                case "3":
            //                    if (returnEntity.Status == -1)
            //                    {
            //                        returnEntity.Status = 3;
            //                    }
            //                    tf = "<span style='color:red;font-weight:bold;'>运输在途</span>"; break;
            //                case "4":
            //                    if (returnEntity.Status == -1)
            //                    {
            //                        returnEntity.Status = 4;
            //                    }
            //                    tf = "<span style='color:red;font-weight:bold;'>已到达</span>"; break;
            //                case "5":
            //                    if (returnEntity.Status == -1)
            //                    {
            //                        returnEntity.Status = 5;
            //                    }
            //                    if (string.IsNullOrEmpty(it.Latitude) || string.IsNullOrEmpty(it.Longitude))
            //                    {
            //                        string[] coordinate = geocodeAddress(it.OrderNo);
            //                        if (coordinate != null)
            //                        {
            //                            returnEntity.EndLongitude = coordinate[0];
            //                            returnEntity.EndLatitude = coordinate[1];
            //                        }
            //                    }
            //                    else
            //                    {
            //                        returnEntity.EndLatitude = it.Latitude;
            //                        returnEntity.EndLongitude = it.Longitude;
            //                    }
            //                    returnEntity.EndTime = it.SignTime.ToString("yyyy-MM-dd HH:mm:ss");

            //                    tf = "<span style='color:red;font-weight:bold;'>已签收</span>"; it.OP_Name = it.Signer;
            //                    string[] im = it.SignImage.Split('|');
            //                    if (im.Length > 0)
            //                    {
            //                        for (int i = 0; i < im.Length; i++)
            //                        {
            //                            if (string.IsNullOrEmpty(im[i])) { continue; }
            //                            img += "<img onclick=download(\"" + im[i] + "\") style='width:30px; height:20px;margin-left:3px;' src='" + im[i] + "' title='点击查看图片'/>";
            //                        }
            //                    }
            //                    //tf += "<img onclick=download(\"" + file.TbFilePath + "\") style='width:30px; height:20px;margin-left:3px;' src='../" + file.TbFilePath + "' title='点击查看图片'/>";
            //                    break;
            //                case "6":
            //                    if (returnEntity.Status == -1)
            //                    {
            //                        returnEntity.Status = 6;
            //                    }
            //                    tf = "<span style='color:red;font-weight:bold;'>已拣货</span>"; break;
            //                default:
            //                    break;
            //            }
            //            res += "<tr><td>" + it.OP_DATE.ToString("yyyy-MM-dd HH:mm:ss") + "</td><td>" + it.OP_Name + "</td><td>" + tf + it.DetailInfo + img + "</td></tr>";
            //        }
            //        if (!string.IsNullOrEmpty(returnEntity.StartLatitude) && !string.IsNullOrEmpty(returnEntity.EndLatitude))
            //        {
            //            decimal differ = Convert.ToDecimal(returnEntity.EndLatitude) - Convert.ToDecimal(returnEntity.StartLatitude);
            //            if (System.Math.Abs(differ) < Convert.ToDecimal(0.01))
            //            {
            //                string[] coordinate = geocodeAddress(OrderNo);
            //                if (coordinate != null)
            //                {
            //                    returnEntity.EndLongitude = coordinate[0];
            //                    returnEntity.EndLatitude = coordinate[1];
            //                }
            //            }
            //        }
            //        else
            //        {
            //            string[] coordinate = geocodeAddress(OrderNo);
            //            if (coordinate != null)
            //            {
            //                returnEntity.EndLongitude = coordinate[0];
            //                returnEntity.EndLatitude = coordinate[1];
            //            }
            //        }
            //        if (!string.IsNullOrEmpty(returnEntity.StartLatitude) && !string.IsNullOrEmpty(returnEntity.StartLongitude) && !string.IsNullOrEmpty(returnEntity.EndLatitude) && !string.IsNullOrEmpty(returnEntity.EndLongitude))
            //        {
            //            returnEntity.Distance = (GetDistance(Convert.ToDouble(returnEntity.StartLatitude), Convert.ToDouble(returnEntity.StartLongitude), Convert.ToDouble(returnEntity.EndLatitude), Convert.ToDouble(returnEntity.EndLongitude))).ToString("f0");
            //        }
            //        res += "</tbody><table>";
            //    }
            //}
            #endregion
            String json = JSON.Encode(returnEntity);
            Response.Write(json);

        }
        /// <summary>
        /// 获取订单收货地址坐标
        /// </summary>
        /// <param name="OrderNo"></param>
        /// <returns></returns>
        public string[] geocodeAddress(string OrderNo)
        {
            string[] coordinate = new string[2];
            CargoOrderBus bus = new CargoOrderBus();
            CargoOrderEntity ent = bus.QueryOrderInfo(new CargoOrderEntity() { OrderNo = OrderNo });
            if (ent != null)
            {
                string url = "https://apis.map.qq.com/ws/geocoder/v1/?address=" + ent.Dest + ent.AcceptAddress.Replace("#", "").Replace("&", "") + "&key=" + "CMZBZ-64RLS-7FROW-6SNUF-C3P5Z-DGB2J";
                string returnJson = wxHttpUtility.SendGetHttpRequest(url, "application/json");
                if (returnJson.IndexOf("查询无结果") < 0)
                {
                    returnJson = Regex.Replace(returnJson, @"\s", "");
                    returnJson = Regex.Replace(returnJson, "[ \\[ \\] \\^ \\-_*×――(^)（^）$%~!@#$…&%￥—+=<>《》!！??？{}:：•`·、。，；,;\"‘’“”-]", "");
                    string strtempa = "location";
                    returnJson = returnJson.Substring(returnJson.IndexOf(strtempa) + strtempa.Length, returnJson.Length - returnJson.IndexOf(strtempa) - strtempa.Length);
                    strtempa = "lng";
                    string strtempb = "lat";
                    string lng = returnJson.Substring(returnJson.IndexOf(strtempa) + strtempa.Length, returnJson.IndexOf(strtempb) - (returnJson.IndexOf(strtempa) + strtempa.Length));
                    strtempa = "lat"; strtempb = "adinfo";
                    string lat = returnJson.Substring(returnJson.IndexOf(strtempa) + strtempa.Length, returnJson.IndexOf(strtempb) - (returnJson.IndexOf(strtempa) + strtempa.Length));
                    coordinate[0] = lng;
                    coordinate[1] = lat;
                }
            }
            return coordinate;
        }
        //地球半径，单位米
        private const double EARTH_RADIUS = 6378137;
        /// <summary>
        /// 计算两点位置的距离，返回两点的距离，单位 米
        /// 该公式为GOOGLE提供，误差小于0.2米
        /// </summary>
        /// <param name="lat1">第一点纬度</param>
        /// <param name="lng1">第一点经度</param>
        /// <param name="lat2">第二点纬度</param>
        /// <param name="lng2">第二点经度</param>
        /// <returns></returns>
        public static double GetDistance(double lat1, double lng1, double lat2, double lng2)
        {
            double radLat1 = Rad(lat1);
            double radLng1 = Rad(lng1);
            double radLat2 = Rad(lat2);
            double radLng2 = Rad(lng2);
            double a = radLat1 - radLat2;
            double b = radLng1 - radLng2;
            double result = 2 * Math.Asin(Math.Sqrt(Math.Pow(Math.Sin(a / 2), 2) + Math.Cos(radLat1) * Math.Cos(radLat2) * Math.Pow(Math.Sin(b / 2), 2))) * EARTH_RADIUS;
            return result;
        }

        /// <summary>
        /// 经纬度转化成弧度
        /// </summary>
        /// <param name="d"></param>
        /// <returns></returns>
        private static double Rad(double d)
        {
            return (double)d * Math.PI / 180d;
        }
        /// <summary>
        /// 拉上订单
        /// </summary>
        public void DrawUpOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "订单管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            try
            {
                CargoContainerShowEntity entity = new CargoContainerShowEntity();

                foreach (Hashtable row in rows)
                {
                    entity.ID = Convert.ToInt64(row["ID"]);
                    entity.ProductID = Convert.ToInt64(row["ProductID"]);
                    entity.ContainerID = Convert.ToInt32(row["ContainerID"]);
                    entity.ContainerCode = Convert.ToString(row["ContainerCode"]);
                    entity.AreaID = Convert.ToInt32(row["AreaID"]);
                    entity.TypeID = Convert.ToInt32(row["TypeID"]);
                    entity.Piece = Convert.ToInt32(row["Piece"]);//新数量
                    entity.InPiece = Convert.ToInt32(row["InPiece"]);//旧数量
                    entity.HouseID = Convert.ToInt32(row["HouseID"]);
                    entity.HouseName = Convert.ToString(row["HouseName"]);
                    entity.OrderNo = Convert.ToString(row["OrderNo"]);
                    entity.RuleType = Convert.ToString(row["RuleType"]).Trim();
                    entity.RuleID = Convert.ToString(row["RuleID"]).Trim();
                    entity.RuleTitle = Convert.ToString(row["RuleTitle"]).Trim();

                    entity.Specs = Convert.ToString(row["Specs"]);
                    entity.Model = Convert.ToString(row["Model"]);
                    entity.GoodsCode = Convert.ToString(row["GoodsCode"]);
                    entity.Figure = Convert.ToString(row["Figure"]);
                    entity.OutCargoID = Convert.ToString(row["OutCargoID"]);
                    entity.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                }
                if (msg.Result)
                {


                    //仓库同步缓存
                    CargoHouseBus house = new CargoHouseBus();
                    CargoProductEntity syncProduct = house.SyncTypeProduct(entity.ProductID.ToString());
                    //34 马牌  1 同步马牌  2 同步全部品牌
                    if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                    {
                        RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                    }
                    CargoOrderBus bus = new CargoOrderBus();
                    bus.DrawUpOrder(entity, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 保存订单跟踪状态 
        /// </summary>
        public void SaveOrderStatus()
        {
            CargoOrderStatusEntity queryEntity = new CargoOrderStatusEntity();
            queryEntity.OrderID = Convert.ToInt64(Request["OrderID"]);
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.DetailInfo = Convert.ToString(Request["DetailInfo"]);
            queryEntity.OrderStatus = Convert.ToString(Request["OrderStatus"]);
            queryEntity.WXOrderNo = Convert.ToString(Request["WXOrderNo"]);//微信订单号
            queryEntity.OP_ID = UserInfor.LoginName;
            queryEntity.OP_Name = UserInfor.UserName;
            queryEntity.OP_DATE = DateTime.Now;
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            if (string.IsNullOrEmpty(queryEntity.OrderNo))
            {
                msg.Message = "订单号为空，系统错误！";
                msg.Result = false;
            }
            CargoOrderBus bus = new CargoOrderBus();
            CargoOrderEntity order = bus.QueryOrderInfoByOrderID(queryEntity.OrderID);
            if (order.AwbStatus.Equals("5"))//已签收不允许再修改状态
            {
                msg.Message = "订单已签收！";
                msg.Result = false;
            }

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "订单状态跟踪";
            log.UserID = UserInfor.LoginName.Trim();
            log.Status = "0";
            log.Operate = "U";
            if (queryEntity.OrderStatus == "5")
            {
                queryEntity.Signer = UserInfor.UserName;
                queryEntity.SignTime = DateTime.Now;
                queryEntity.SignImage = "";
            }
            if (msg.Result)
            {
                bus.SaveOrderStatus(queryEntity, log);
            }
            try
            {
                if (!string.IsNullOrEmpty(queryEntity.WXOrderNo))
                {
                    WXOrderEntity wxent = new WXOrderEntity();
                    wxent.OrderNo = queryEntity.WXOrderNo;
                    string title = string.Empty;
                    switch (queryEntity.OrderStatus)
                    {
                        case "2": wxent.OrderStatus = "2"; title = "尊敬的迪乐泰客户，您的订单已出库！"; break;
                        case "3": wxent.OrderStatus = "3"; title = "尊敬的迪乐泰客户，您的订单在运输途中，请耐心等待哦！"; break;
                        case "5": wxent.OrderStatus = "4"; title = "尊敬的迪乐泰客户，您的订单已签收，谢谢您的支持！"; break;
                        default: break;
                    }
                    if (string.IsNullOrEmpty(title))
                    {
                        goto ERR;
                    }
                    //CargoWeiXinBus weixin = new CargoWeiXinBus();
                    //weixin.setWeixinOrderStatus(wxent, log);
                    List<WXOrderManagerEntity> wxOrderList = bus.QueryWeixinOrderInfo(new WXOrderManagerEntity { OrderNo = queryEntity.WXOrderNo });
                    if (wxOrderList.Count > 0)
                    {
                        //仓库确认成功向客户微信发送推送消息
                        //推送客户消息
                        TemplateMsg tmMsg = new TemplateMsg
                        {
                            first = new TemplateDataItem(title, "#173177"),
                            keyword1 = new TemplateDataItem(wxOrderList[0].Title, "#173177"),
                            keyword2 = new TemplateDataItem(wxOrderList[0].TotalCharge.ToString("F2") + "元", "#173177"),
                            keyword3 = new TemplateDataItem(queryEntity.WXOrderNo, "#173177"),
                            remark = new TemplateDataItem("点击查看物流跟踪详情!", "#173177")
                        };
                        SendTempleteMessage send = new SendTempleteMessage();
                        //string token = AccessTokenContainer.TryGetAccessToken(Common.GetdltAPPID(), Common.GetdltAppSecret(), false);
                        string token = Common.GetWeixinToken(Common.GetdltAPPID(), Common.GetdltAppSecret());
                        //oo1LEt_z6Yhx-g_qdgrYhLaYaazE//测试
                        string errmsg = send.SendMessage(token, wxOrderList[0].wxOpenID, "heDfICkOgVf3gfod4kM6CL4MiK4YikrFGm6k9QgUZ8A", "http://dlt.neway5.com/Weixin/OrderInfo.aspx?orderNo=" + queryEntity.WXOrderNo, tmMsg);
                    }

                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = true;
            }

        ERR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }
        /// <summary>
        /// 修改订单中的产品数量
        /// </summary>
        public void UpdateOrderPiece()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "订单管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            try
            {
                CargoContainerShowEntity entity = new CargoContainerShowEntity();
                CargoHouseBus house = new CargoHouseBus();
                CargoOrderBus bus = new CargoOrderBus();

                foreach (Hashtable row in rows)
                {
                    if (!UserInfor.IsModifyOrder.Equals("1"))
                    {
                        msg.Message = "您没有修改订单权限";
                        msg.Result = false;
                        break;
                    }
                    CargoOrderEntity ord = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = Convert.ToString(row["OrderNo"]) });
                    if (!ord.AwbStatus.Equals("0"))
                    {
                        msg.Message = "订单非已开单状态，不允许修改";
                        msg.Result = false;
                        break;
                    }
                    if (ord.FinanceSecondCheck.Equals("1"))
                    {
                        msg.Message = "财务已审核，不允许修改";
                        msg.Result = false;
                        break;
                    }
                    if (ord.CheckStatus.Equals("1"))
                    {
                        msg.Message = Convert.ToString(row["OrderNo"]) + "已结清，不允许修改";
                        msg.Result = false;
                        break;
                    }
                    if (ord.CheckStatus.Equals("2"))
                    {
                        msg.Message = Convert.ToString(row["OrderNo"]) + "结算中，不允许修改";
                        msg.Result = false;
                        break;
                    }
                    entity.Specs = Convert.ToString(row["Specs"]);
                    entity.ProductID = Convert.ToInt64(row["ProductID"]);
                    entity.ContainerID = Convert.ToInt32(row["ContainerID"]);
                    entity.TypeID = Convert.ToInt32(row["TypeID"]);
                    entity.OldPiece = Convert.ToInt32(row["oldPiece"]);//旧数量

                    entity.OrderNo = Convert.ToString(row["OrderNo"]);
                    entity.AreaID = Convert.ToInt32(row["AreaID"]);
                    entity.ContainerCode = Convert.ToString(row["ContainerCode"]);
                    entity.Piece = Convert.ToInt32(row["Piece"]);//新数量
                    entity.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                    entity.OutCargoID = Convert.ToString(row["OutCargoID"]);

                    if (entity.Piece.Equals(entity.OldPiece))
                    {
                        msg.Result = false;
                        msg.Message = "未修改数量";
                        break;
                    }

                    if (!house.IsExistCargoContainerCode(new CargoContainerEntity { ContainerCode = entity.ContainerCode }))
                    {
                        msg.Result = false;
                        msg.Message = entity.ContainerCode + "货位不存在";
                        break;
                    }
                    //拉上的
                    if (entity.Piece > entity.OldPiece)
                    {
                        CargoContainerGoodsEntity contgood = house.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ContainerID = entity.ContainerID, TypeID = entity.TypeID, ProductID = entity.ProductID });

                        if (contgood == null || contgood.ID == 0)
                        {
                            msg.Result = false;
                            msg.Message = entity.Specs + "没有库存";
                            if (row["HouseID"].ToString() == "47")
                            {
                                msg.Message = row["ProductName"].ToString() + "没有库存";
                            }
                            break;
                        }
                        int diffPiece = entity.Piece - entity.OldPiece;
                        if (contgood.Piece < diffPiece)
                        {
                            msg.Result = false;
                            msg.Message = entity.Specs + "在库库存不足";
                            if (row["HouseID"].ToString() == "47")
                            {
                                msg.Message = row["ProductName"].ToString() + "在库库存不足";
                            }
                            break;
                        }
                    }
                    entity.Batch = Convert.ToString(row["Batch"]);
                    CargoOrderEntity hlyOrder = new CargoOrderEntity();
                    if (ord.HouseID.Equals(9))
                    {
                        hlyOrder = bus.QueryHlyOrderData(entity.OrderNo);
                        if (!string.IsNullOrEmpty(hlyOrder.AwbStatus) && hlyOrder.AwbStatus.Equals("已开单"))
                        {
                            msg.Message = entity.OrderNo + "好来运系统已开单，请联系系统人员修改";
                            msg.Result = false;
                        }
                    }
                }
                if (msg.Result)
                {
                    //仓库同步缓存
                    CargoProductEntity syncProduct = house.SyncTypeProduct(entity.ProductID.ToString());
                    //34 马牌  1 同步马牌  2 同步全部品牌
                    if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                    {
                        RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                    }

                    bus.UpdateOrderPiece(entity, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 修改订单中产品价格
        /// </summary>
        public void UpdateOrderSalePrice()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "订单管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            try
            {
                CargoContainerShowEntity entity = new CargoContainerShowEntity();
                CargoOrderBus bus = new CargoOrderBus();
                foreach (Hashtable row in rows)
                {
                    if (!UserInfor.IsModifyOrder.Equals("1"))
                    {
                        msg.Message = "您没有修改订单权限";
                        msg.Result = false;
                        break;
                    }
                    CargoOrderEntity ord = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = Convert.ToString(row["OrderNo"]) });
                    if (ord.FinanceSecondCheck.Equals("1"))
                    {
                        msg.Message = "财务已审核，不允许修改";
                        msg.Result = false;
                        break;
                    }
                    if (ord.CheckStatus.Equals("1"))
                    {
                        msg.Message = Convert.ToString(row["OrderNo"]) + "已结清，不允许修改";
                        msg.Result = false;
                        break;
                    }
                    if (ord.CheckStatus.Equals("2"))
                    {
                        msg.Message = Convert.ToString(row["OrderNo"]) + "结算中，不允许修改";
                        msg.Result = false;
                        break;
                    }
                    entity.Specs = Convert.ToString(row["Specs"]);
                    entity.ProductID = Convert.ToInt64(row["ProductID"]);
                    entity.ContainerID = Convert.ToInt32(row["ContainerID"]);
                    entity.TypeID = Convert.ToInt32(row["TypeID"]);
                    entity.OrderNo = Convert.ToString(row["OrderNo"]);
                    entity.AreaID = Convert.ToInt32(row["AreaID"]);
                    entity.ContainerCode = Convert.ToString(row["ContainerCode"]);
                    entity.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);//新价格
                    entity.SalePrice = Convert.ToDecimal(row["SalePrice"]);//旧价格
                    entity.OutCargoID = Convert.ToString(row["OutCargoID"]);
                    entity.ThrowGood = ord.ThrowGood;

                    entity.Batch = Convert.ToString(row["Batch"]);

                    CargoOrderEntity hlyOrder = new CargoOrderEntity();
                    if (ord.HouseID.Equals(9))
                    {
                        hlyOrder = bus.QueryHlyOrderData(entity.OrderNo);
                        if (!string.IsNullOrEmpty(hlyOrder.AwbStatus) && hlyOrder.AwbStatus.Equals("已开单"))
                        {
                            msg.Message = entity.OrderNo + "好来运系统已开单，请联系系统人员修改";
                            msg.Result = false;
                        }
                    }
                }
                if (msg.Result)
                {
                    bus.UpdateOrderSalePrice(entity, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 打印发货单
        /// </summary>
        public void QueryOrderDataForPrePrint()
        {

            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            string orderno = string.Empty;
            PropertyInfo[] propertys = rows.GetType().GetProperties();
            DataTable newData = new DataTable();
            newData.Columns.Add("ID");
            newData.Columns.Add("Piece");
            newData.Columns.Add("ActSalePrice");
            newData.Columns.Add("ProductName");
            newData.Columns.Add("Specs");
            newData.Columns.Add("GoodsCode");
            newData.Columns.Add("Model");
            newData.Columns.Add("Figure");
            newData.Columns.Add("Batch");
            newData.Columns.Add("SpeedLevel");
            newData.Columns.Add("LoadIndex");
            newData.Columns.Add("TypeName");
            newData.Columns.Add("Package");
            newData.Columns.Add("ContainerCode");
            newData.Columns.Add("AreaName");
            newData.Columns.Add("FirstAreaName");
            newData.Columns.Add("ProductID");
            newData.Columns.Add("RuleTitle");
            newData.Columns.Add("TypeParentID");
            newData.Columns.Add("ShowGoodsCode");
            newData.Columns.Add("ShowTypeName");

            int i = 0;
            foreach (Hashtable row in rows)
            {
                DataRow drNew = newData.NewRow();

                DataRow[] NewRows = newData.Select("Model='" + row["Model"] + "' and Specs ='" + row["Specs"] + "' and Figure='" + row["Figure"] + "' and Batch='" + row["Batch"] + "' and GoodsCode='" + row["GoodsCode"] + "' and ActSalePrice='" + row["ActSalePrice"] + "' and TypeName='" + row["TypeName"] + "'");
                if (NewRows.Count() <= 0)
                {
                    object[] objs = { row["ID"], row["Piece"], row["ActSalePrice"], row["ProductName"], row["Specs"], row["GoodsCode"], row["Model"], row["Figure"], row["Batch"], row["SpeedLevel"], row["LoadIndex"], row["TypeName"], row["Package"], row["ContainerCode"], row["AreaName"], row["FirstAreaName"], row["ProductID"], row["RuleTitle"], row["TypeParentID"], row["ShowGoodsCode"], row["ShowTypeName"] };
                    drNew.ItemArray = objs;
                    newData.Rows.Add(drNew);
                }
                else
                {
                    for (int j = 0; j < NewRows.Length; j++)
                    {
                        DataRow drEmployee = NewRows[j];
                        drEmployee.BeginEdit();
                        drEmployee["Piece"] = Convert.ToInt32(NewRows[0]["Piece"]) + Convert.ToInt32(row["Piece"]);
                        drEmployee.EndEdit();
                    }
                }
                i++;
            }

            //newData.DefaultView.Sort = "Specs asc";
            DataTable dtSort = newData.DefaultView.ToTable();

            //JSON
            String result = JSON.Encode(dtSort);
            Response.Clear();
            Response.Write(result);
        }
        /// <summary>
        /// 查询订单数据用以批量打印
        /// </summary>
        public void QueryOrderDataForMassPrint()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            string orderno = string.Empty;
            foreach (Hashtable row in rows)
            {
                if (Convert.ToString(row["AwbStatus"]).Equals("0") || Convert.ToString(row["AwbStatus"]).Equals("1"))
                {
                    orderno += Convert.ToString(row["OrderNo"]) + ",";
                }
            }
            if (!string.IsNullOrEmpty(orderno))
            {
                orderno = orderno.Substring(0, orderno.Length - 1);
            }

            CargoOrderBus bus = new CargoOrderBus();
            List<CargoContainerShowEntity> list = bus.QueryOrderDataForMassPrint(orderno);
            if (list.Count > 0)
            {
                if (list[0].TypeParentID.Equals(1))
                {
                    //表示 是轮胎订单
                    list = list.OrderBy(c => c.LogisAwbNo).ThenBy(c => c.AreaName).ToList();
                }
            }
            //JSON
            String result = JSON.Encode(list);
            Response.Clear();
            Response.Write(result);
        }
        public void CreateOrderPickPlan()
        {
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "新增拣货计划";
            log.UserID = UserInfor.LoginName;
            log.Operate = "A";
            log.Status = "0";
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            try
            {
                String json = Request["data"];
                if (String.IsNullOrEmpty(json)) return;
                ArrayList rows = (ArrayList)JSON.Decode(json);
                string orderno = string.Empty;
                int HouseID = 0;
                string HouseCode = string.Empty;
                foreach (Hashtable row in rows)
                {
                    if (Convert.ToString(row["PickStatus"]).Equals("0"))
                    {
                        orderno += Convert.ToString(row["OrderNo"]) + ",";
                    }
                    else
                    {
                        msg.Message = "只能选择未生成拣货计划的订单";
                        msg.Result = false;
                        goto END;
                    }
                    HouseID = Convert.ToInt32(row["HouseID"]);
                    if (string.IsNullOrEmpty(HouseCode))
                    {
                        HouseCode = Convert.ToString(row["OrderNo"]).Substring(0, 2);
                    }
                    else
                    {
                        if (!HouseCode.Equals(Convert.ToString(row["OrderNo"]).Substring(0, 2)))
                        {
                            msg.Message = "只能选择相同仓库的订单生成拣货计划";
                            msg.Result = false;
                            goto END;
                        }
                    }
                }
                if (!string.IsNullOrEmpty(orderno))
                {
                    orderno = orderno.Substring(0, orderno.Length - 1);
                }
                CargoOrderBus bus = new CargoOrderBus();
                List<CargoContainerShowEntity> list = bus.QueryOrderDataForMassPrint(orderno);
                CargoOrderPickPlanEntity orderPickPlanEntity = new CargoOrderPickPlanEntity();
                CargoHouseBus house = new CargoHouseBus();
                int PickNum = 0;
                orderPickPlanEntity.OrderNoStr = orderno;
                orderPickPlanEntity.PickStatus = "0";
                orderPickPlanEntity.PickPlanNo = Common.GetMaxPickNumByCurrentDate(HouseID, HouseCode, out PickNum);
                orderPickPlanEntity.PickNum = PickNum;//最新订单顺序号
                orderPickPlanEntity.HouseID = Convert.ToString(HouseID);
                orderPickPlanEntity.TotalNum = list.Sum(x => x.Piece);
                orderPickPlanEntity.OP_ID = UserInfor.LoginName;
                orderPickPlanEntity.PickType = "0";
                List<CargoOrderPickPlanGoodsEntity> orderPickPlanGoodsEntityList = new List<CargoOrderPickPlanGoodsEntity>();
                Dictionary<string, int> pairs = new Dictionary<string, int>();
                int PitNum = 0;
                foreach (CargoContainerShowEntity item in list)
                {
                    if (!pairs.ContainsKey(item.AcceptUnit))
                    {
                        PitNum++;
                        pairs.Add(item.AcceptUnit, PitNum);
                    }

                    orderPickPlanGoodsEntityList.Add(new CargoOrderPickPlanGoodsEntity
                    {
                        PickPlanNo = orderPickPlanEntity.PickPlanNo,
                        OrderNo = item.OrderNo,
                        ProductID = item.ProductID.ToString(),
                        HouseID = item.HouseID.ToString(),
                        AreaID = item.AreaID.ToString(),
                        ContainerCode = item.ContainerCode,
                        GoodsCode = item.GoodsCode,
                        Piece = item.Piece.ToString(),
                        OP_ID = UserInfor.LoginName,
                        LogisAwbNo = item.LogisAwbNo,
                        Dep = item.Dep,
                        Dest = item.Dest,
                        AcceptUnit = item.AcceptUnit,
                        AcceptAddress = item.AcceptAddress,
                        AcceptPeople = item.AcceptPeople,
                        AcceptTelephone = item.AcceptTelephone,
                        AcceptCellphone = item.AcceptCellphone,
                        PitNum = pairs[item.AcceptUnit]
                    });
                }
                orderPickPlanEntity.PickPlanGoodsList = orderPickPlanGoodsEntityList;
                bus.AddOrderPickPlan(orderPickPlanEntity, log);
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message; msg.Result = false;
            }
        END:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 批量导出拣货单
        /// </summary>
        public void QuerymassExportOrder()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            //查询条件
            string key = Request["key"];
            if (string.IsNullOrEmpty(key))
            {
                Response.Clear();
                Response.Write(JSON.Encode(queryEntity));
                return;
            }
            string[] arr = key.Split(',');
            for (int i = 0; i < arr.Length; i++)
            {
                switch (i)
                {
                    case 0:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.StartDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 1:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.EndDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 2:
                        if (!string.IsNullOrEmpty(arr[i]))//所属仓库
                        {
                            queryEntity.CargoPermisID = Convert.ToString(arr[i]);//所属仓库ID
                        }
                        else
                        {
                            queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                        }
                        break;
                    case 3:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.FirstAreaID = Convert.ToInt32(arr[i]); }
                        break;
                    case 4:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.TypeID = Convert.ToInt32(arr[i]); }
                        break;
                    default:
                        break;
                }
            }
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoContainerShowEntity> list = bus.QueryOrderDataForMassExport(queryEntity);
            string err = "OK";

            if (list.Count > 0) { massExportOrder = list; massExportOrderType = Convert.ToString(queryEntity.CargoPermisID); } else { err = "没有数据可以进行导出，请重新查询！"; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 导出实体
        /// </summary>
        public List<CargoContainerShowEntity> massExportOrder
        {
            get
            {
                if (Session["massExportOrder"] == null) { Session["massExportOrder"] = new List<CargoContainerShowEntity>(); }
                return (List<CargoContainerShowEntity>)(Session["massExportOrder"]);
            }
            set
            {
                Session["massExportOrder"] = value;
            }
        }
        public void QueryOrderPicekPieceExport()
        {
            string OrderNoStr = Convert.ToString(Request["OrderNoStr"]);
            string err = "OK";
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            queryEntity.OrderNoStr = OrderNoStr.TrimEnd(',');
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoOrderGoodsEntity> list = bus.QueryOrderPicekPieceExport(queryEntity);
            if (list.Count > 0) { QueryOrderPicekPieceExportList = list; } else { err = "无数据导出"; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        public List<CargoOrderGoodsEntity> QueryOrderPicekPieceExportList
        {
            get
            {
                if (Session["QueryOrderPicekPieceExportList"] == null) { Session["QueryOrderPicekPieceExportList"] = new List<CargoOrderGoodsEntity>(); }
                return (List<CargoOrderGoodsEntity>)(Session["QueryOrderPicekPieceExportList"]);
            }
            set
            {
                Session["QueryOrderPicekPieceExportList"] = value;
            }
        }
        /// <summary>
        /// 导出类型实体
        /// </summary>
        public string massExportOrderType
        {
            get
            {
                if (Session["massExportOrderType"] == null)
                {
                    Session["massExportOrderType"] = "";
                }
                return (string)(Session["massExportOrderType"]);
            }
            set
            {
                Session["massExportOrderType"] = value;
            }
        }
        /// <summary>
        /// 导出实体
        /// </summary>
        public List<CargoContainerShowEntity> tagCodeExport
        {
            get
            {
                if (Session["tagCodeExport"] == null) { Session["tagCodeExport"] = new List<CargoContainerShowEntity>(); }
                return (List<CargoContainerShowEntity>)(Session["tagCodeExport"]);
            }
            set
            {
                Session["tagCodeExport"] = value;
            }
        }
        /// <summary>
        /// 查询出库标签列表 
        /// </summary>
        public void QueryTagByOrderNo()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            //查询条件
            string key = Request["OrderNo"];
            if (string.IsNullOrEmpty(key)) { Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return; }
            queryEntity.OrderNo = Convert.ToString(key.Trim());
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoContainerShowEntity> list = bus.QueryTagByOrderNo(queryEntity);
            tagCodeExport = list;
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 撤回出库轮胎标签
        /// </summary>
        public void RebackOutTag()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoContainerShowEntity> list = new List<CargoContainerShowEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            CargoOrderBus bus = new CargoOrderBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "订单管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            try
            {
                if (!UserInfor.IsRevokeOutCargo.Equals("1"))
                {
                    msg.Message = "您无权撤销出库"; msg.Result = false; goto ERROR;
                }
                CargoOrderEntity ord = new CargoOrderEntity();
                CargoOrderEntity ent = new CargoOrderEntity();
                ent.OrderID = Convert.ToInt64(Request["OrderID"]);
                ent.OrderNo = Convert.ToString(Request["OrderNo"]);
                ord = bus.QueryOrderInfoByOrderID(ent.OrderID);
                //因为客服在财务审核后撤销标签，所以取消管理员直接撤销标签功能
                //if (!UserInfor.IsAdmin.Equals("1"))
                //{
                //如果是管理员则不限制随便改
                if (ord.FinanceSecondCheck.Equals("1"))
                {
                    msg.Message = "财务已审核，不允许撤销标签"; msg.Result = false; goto ERROR;
                }
                if (ord.CheckStatus.Equals("1"))
                {
                    msg.Message = ent.OrderNo + "已结清，不允许撤销标签"; msg.Result = false; goto ERROR;
                }
                if (ord.CheckStatus.Equals("2"))
                {
                    msg.Message = ent.OrderNo + "结算中，不允许撤销标签"; msg.Result = false; goto ERROR;
                }
                //}
                if (msg.Result)
                {
                    foreach (Hashtable row in rows)
                    {
                        list.Add(new CargoContainerShowEntity
                        {
                            TagCode = Convert.ToString(row["TagCode"]),
                            OrderNo = Convert.ToString(row["OrderNo"]),
                            ProductID = Convert.ToInt64(row["ProductID"]),
                            OutCargoID = Convert.ToString(row["OutCargoID"]),
                            ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
                            ContainerID = Convert.ToInt32(row["ContainerID"]),
                            ContainerCode = Convert.ToString(row["ContainerCode"]),
                            ProductCode = Convert.ToString(row["ProductCode"]),
                            PackageNum = Convert.ToInt32(row["PackageNum"]),
                            Piece = string.IsNullOrEmpty(Convert.ToString(row["ProductCode"])) || Convert.ToInt32(row["PackageNum"]).Equals(0) ? 1 : Convert.ToInt32(row["PackageNum"]),
                            HouseID = Convert.ToInt32(row["HouseID"])
                        });
                    }

                    if (list.Count <= 0)
                    {
                        msg.Result = false;
                        msg.Message = "数据有误，请重新选择数据";
                    }
                }
                if (msg.Result)
                {
                    //仓库同步缓存
                    CargoHouseBus house = new CargoHouseBus();
                    foreach (CargoContainerShowEntity time in list)
                    {
                        CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                        //34 马牌  1 同步马牌  2 同步全部品牌
                        if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                        }
                    }

                    bus.RebackOutTag(list, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
        ERROR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 修改订单延迟发货状态
        /// </summary>
        public void PostponeShip()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单修改";
            log.NvgPage = "修改订单延迟发货状态";
            log.UserID = UserInfor.LoginName.ToString();
            log.Status = "0";
            log.Operate = "U";
            try
            {
                foreach (Hashtable row in rows)
                {
                    if (string.IsNullOrEmpty(Convert.ToString(row["OrderNo"])))
                    {
                        msg.Message = "未获取到订单号";
                        msg.Result = false;
                        break;
                    }
                    if (Convert.ToString(row["ModifyPriceStatus"]) == "1")
                    {
                        msg.Message = Convert.ToString(row["OrderNo"]) + "改价申请中";
                        msg.Result = false;
                        break;
                    }

                    if (Convert.ToString(row["TrafficType"]).Equals("2"))
                    {
                        CargoOrderEntity orderEnt = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = Convert.ToString(row["OrderNo"]) });
                        List<CargoContainerShowEntity> orderContainerList = bus.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = orderEnt.OrderNo });
                        //CargoOrderEntity orderEnt = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = it.OrderNo });
                        bus.SaveHlyOrderData(orderContainerList, orderEnt);
                        List<CargoContainerShowEntity> cargoShow = bus.QueryOesPreOrderByOrderNo(new CargoOrderEntity { OrderNo = orderEnt.OrderNo });
                        //采购订单 向好来运企业微信推送提货通知
                        if (msg.Result && cargoShow.Count > 0)
                        {
                            int TPiece = 0;
                            int tag = 2;
                            switch (cargoShow[0].HouseID)
                            {
                                case 9: tag = 2; break;//广州
                                case 91: tag = 2; break;//广州
                                case 97: tag = 2; break;//广州
                                case 106: tag = 2; break;//广州
                                case 107: tag = 2; break;//广州
                                case 129: tag = 2; break;//广州
                                case 31: tag = 4; break;//北京
                                case 109: tag = 4; break;//北京
                                case 24: tag = 33; break;//福州
                                case 123: tag = 33; break;//福州
                                case 25: tag = 5; break;//常熟
                                case 118: tag = 5; break;//常熟
                                case 14: tag = 6; break;//成都
                                case 121: tag = 6; break;//成都
                                case 32: tag = 8; break;//杭州
                                case 119: tag = 8; break;//杭州
                                case 69: tag = 9; break;//合肥
                                case 29: tag = 10; break;//济南
                                case 114: tag = 10; break;//济南
                                case 70: tag = 12; break;//兰州
                                case 124: tag = 12; break;//兰州
                                case 68: tag = 13; break;//南昌
                                case 55: tag = 20; break;//厦门
                                case 15: tag = 14; break;//上海
                                case 117: tag = 14; break;//上海
                                case 23: tag = 15; break;//沈阳
                                case 113: tag = 15; break;//沈阳
                                case 30: tag = 16; break;//武汉
                                case 99: tag = 16; break;//武汉
                                case 130: tag = 16; break;//武汉
                                case 10: tag = 17; break;//西安
                                case 98: tag = 17; break;//西安
                                case 102: tag = 17; break;//西安
                                case 27: tag = 3; break;//长沙
                                case 96: tag = 3; break;//长沙
                                case 100: tag = 3; break;//长沙
                                case 33: tag = 18; break;//郑州
                                case 48: tag = 19; break;//郑州
                                case 50: tag = 7; break;//贵阳
                                case 53: tag = 11; break;//贵阳
                                case 71: tag = 21; break;//贵阳
                                case 72: tag = 22; break;//石家庄
                                case 112: tag = 22; break;//石家庄
                                case 73: tag = 23; break;//南京仓库
                                case 74: tag = 24; break;//宁波仓库
                                case 75: tag = 25; break;//大连仓库
                                case 76: tag = 26; break;//哈尔滨仓库
                                case 77: tag = 27; break;//长春仓库
                                case 110: tag = 27; break;//长春仓库
                                case 78: tag = 29; break;//呼和浩特仓库
                                case 79: tag = 28; break;//西宁仓库
                                case 43: tag = 30; break;//新疆仓库
                                case 80: tag = 31; break;//银川仓库
                                case 81: tag = 32; break;//太原仓库
                                case 115: tag = 32; break;//太原仓库
                                case 13: tag = 34; break;//天津仓库
                                case 105: tag = 34; break;//天津仓库
                                case 127: tag = 34; break;//天津仓库
                                default:
                                    break;
                            }
                            string good = string.Empty;
                            foreach (var it in cargoShow)
                            {
                                good += "品牌：" + it.TypeName + "，规格：" + it.Specs + "，" + it.Figure + "，" + it.LoadIndex + it.SpeedLevel + "，数量：" + it.Piece.ToString() + " |";
                                TPiece += it.Piece;
                            }
                            //微信企业号推送
                            QySendInfoEntity send = new QySendInfoEntity();
                            send.title = "提货通知";
                            send.msgType = msgType.textcard;
                            //send.toUser = "1000";
                            send.toTag = Convert.ToString(tag);
                            send.content = "<div>出库仓库：" + Convert.ToString(row["OutHouseName"]) + "</div><div>订单号码：" + Convert.ToString(row["OrderNo"]) + "</div><div>提货联系人：" + cargoShow[0].PurchaserBoss + " " + cargoShow[0].PurchaserCellphone + "</div><div>提货地址：" + cargoShow[0].PurchaserAddress + "</div><div>提货数量：" + TPiece + " 条</div><div>物品明细：" + good + "</div><div>收货人：" + orderEnt.AcceptPeople + " " + orderEnt.AcceptCellphone + "</div><div>收货地址：" + orderEnt.AcceptAddress + "</div><div>备注说明：" + Convert.ToString(row["Remark"]) + "</div>";
                            send.url = "http://oa.hlyex.com/HLYQY/OESDelivery/DeliverySure.aspx?OrderNo=" + Convert.ToString(row["OrderNo"]) + "&AgentID=1000021";
                            QyConfigEntity agentEnt = new QyConfigEntity();
                            agentEnt.AgentID = "1000021";
                            agentEnt.AgentSecret = "0iV_tGVHzE6-kJsrdWADQZOG5U-vz939_gIMSRnQXc0";
                            WxQYSendHelper.HLYQYPushInfo(agentEnt, send);

                        }
                    }
                    else
                    {
                        CargoOrderEntity orderEnt = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = Convert.ToString(row["OrderNo"]) });
                        CargoHouseBus house = new CargoHouseBus();
                        CargoHouseEntity houseEnt = house.QueryCargoHouseByID(orderEnt.HouseID);
                        if (orderEnt.ThrowGood.Equals("21") || houseEnt.HouseID.Equals(120))
                        {
                            bus.InsertCargoOrderPush(new CargoOrderPushEntity
                            {
                                OrderNo = orderEnt.OrderNo,
                                Dep = orderEnt.Dep,
                                Dest = orderEnt.Dest,
                                Piece = orderEnt.Piece,
                                TransportFee = orderEnt.TransportFee,
                                ClientNum = orderEnt.ClientNum.ToString(),
                                AcceptAddress = orderEnt.AcceptAddress,
                                AcceptCellphone = orderEnt.AcceptCellphone,
                                AcceptTelephone = orderEnt.AcceptTelephone,
                                AcceptPeople = orderEnt.AcceptPeople,
                                AcceptUnit = orderEnt.AcceptUnit,
                                HouseID = orderEnt.HouseID.ToString(),
                                HouseName = houseEnt.Name,
                                OP_ID = UserInfor.UserName,
                                PushType = "0",
                                PushStatus = "0",
                                LogisID = orderEnt.LogisID
                            }, log);
                        }
                        else
                        {
                            List<CargoContainerShowEntity> list = bus.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = Convert.ToString(row["OrderNo"]) });
                            List<CargoOrderEntity> oe = new List<CargoOrderEntity>();
                            oe.Add(orderEnt);
                            bus.DelHlyOrderData(oe);
                            //内部订单
                            bus.SaveHlyOrderData(list, orderEnt);
                            //if (!Convert.ToString(list[0].Source).Equals("9"))
                            //{
                            //    List<CargoOrderEntity> oe = new List<CargoOrderEntity>();
                            //    oe.Add(orderEnt);
                            //    bus.DelHlyOrderData(oe);
                            //    //内部订单
                            //    bus.SaveHlyOrderData(list, orderEnt);
                            //}
                            //else
                            //{
                            //    Common.WriteTextLog("修改订单延迟发货状态" + orderEnt.OrderNo);
                            //    bus.DelHlyOutOrderData(orderEnt.OrderNo);
                            //    //市场采购
                            //    bus.SaveHlyOutOrderData(orderEnt);
                            //}
                        }
                    }
                    bus.UpdateCargoOrderPostponeShipStatus(new CargoOrderEntity { OrderNo = Convert.ToString(row["OrderNo"]), PostponeShip = "2" }, log);
                }
                if (msg.Result)
                {
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 查询未签收订单数据
        /// </summary>
        public void QueryNotSignedOrderData()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
            queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]);
            queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }

            CargoOrderBus bus = new CargoOrderBus();
            List<CargoOrderEntity> list = bus.QueryNotSignedOrderData(queryEntity);
            notSignedOrderList = list;

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 导出实体
        /// </summary>
        public List<CargoOrderEntity> notSignedOrderList
        {
            get
            {
                if (Session["notSignedOrderList"] == null) { Session["notSignedOrderList"] = new List<CargoOrderEntity>(); }
                return (List<CargoOrderEntity>)(Session["notSignedOrderList"]);
            }
            set
            {
                Session["notSignedOrderList"] = value;
            }
        }
        public void QueryMoveScanTagByMoveNo()
        {
            CargoProductTagEntity queryEntity = new CargoProductTagEntity();
            queryEntity.MoveOrderNo = Convert.ToString(Request["MoveNo"]);
            CargoProductBus bus = new CargoProductBus();
            List<CargoProductTagEntity> list = bus.QueryTagByProductID(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 退货单操作方法集合
        /// <summary>
        /// 查询订单数据用以退货单
        /// </summary>
        public void QueryOrderInfoForReturn()
        {
            CargoOrderReturnOrderEntity queryEntity = new CargoOrderReturnOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Piece"]))) { queryEntity.Piece = Convert.ToInt32(Request["Piece"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            queryEntity.Dep = Convert.ToString(Request["Dep"]);
            queryEntity.Dest = Convert.ToString(Request["Dest"]);
            if (Convert.ToString(Request["OrderType"]) != "-1")
            {
                queryEntity.OrderType = Convert.ToString(Request["OrderType"]);
            }
            //ueryEntity.CheckOutType = Convert.ToString(Request["CheckOutType"]);
            //queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            queryEntity.SaleManID = Convert.ToString(Request["SaleManID"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["OrderModel"])))
            {
                queryEntity.OrderModel = Convert.ToString(Request["OrderModel"]);
            }
            if (Request["BelongDepart"] != "-1") { queryEntity.BelongDepart = Convert.ToString(Request["BelongDepart"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Specs"])))
            {
                string spe = Convert.ToString(Request["Specs"]);

                if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
                {
                    queryEntity.Specs = spe;
                }
                else
                {
                    if (spe.Length <= 3)
                    {
                        queryEntity.Specs = spe;
                    }
                    if (spe.Length > 3 && spe.Length <= 5)
                    {
                        queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                    }
                    if (spe.Length > 5)
                    {
                        queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                    }
                }
            }
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoOrderReturnOrderEntity> list = bus.QueryOrderInfoForReturn(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 保存退货单数据
        /// </summary>
        public void saveReturn()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            CargoOrderBus bus = new CargoOrderBus();
            CargoHouseBus busHouse = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "新增退货单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            log.Status = "0";

            try
            {
                string orderNo = Convert.ToString(Request["OrderNo"]);
                CargoOrderEntity orderEnt = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = orderNo });
                #region 赋值
                int OrderNum = 0;
                int goHouseID = Convert.ToInt32(Request["eHouseID"]);
                //查询新仓库信息
                CargoHouseEntity goHouse = busHouse.QueryCargoHouse(new CargoHouseEntity { HouseID= goHouseID });
                if (string.IsNullOrEmpty(goHouse.HouseCode)) {
                    msg.Message = "退货仓库无仓库代码，联系管理人员新增";
                    msg.Result = false;
                    //返回处理结果
                    string res = JSON.Encode(msg);
                    Response.Write(res);
                    return;
                }

                //ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(goHouseID, orderNo.Substring(0, 2), out OrderNum);
                ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(goHouse.HouseID, goHouse.HouseCode, out OrderNum); 
                ent.OrderNum = OrderNum;//最新订单顺序号
                //ent.HAwbNo = Convert.ToString(Request["HAwbNo"]);

                ent.Dep = orderEnt.Dest.Trim();
                ent.Dest = orderEnt.Dep.Trim();

                ent.Piece = string.IsNullOrEmpty(Convert.ToString(Request["Piece"])) ? 0 : Convert.ToInt32(Request["Piece"]);

                ent.TransportFee = string.IsNullOrEmpty(Convert.ToString(Request["TransportFee"])) ? 0 : Convert.ToDecimal(Request["TransportFee"]);
                ent.TotalCharge = ent.TransportFee;

                ent.CheckOutType = orderEnt.CheckOutType; //"0";//Convert.ToString(Request["CheckOutType"]);
                                                          //ent.ReturnAwb = string.IsNullOrEmpty(Convert.ToString(Request["ReturnAwb"])) ? 0 : Convert.ToInt32(Request["ReturnAwb"]);
                ent.TrafficType = orderEnt.TrafficType; //"0";// Convert.ToString(Request["TrafficType"]);
                ent.DeliveryType = orderEnt.DeliveryType; //"0";//Convert.ToString(Request["DeliveryType"]);
                ent.AcceptUnit = orderEnt.AcceptUnit;
                ent.AcceptAddress = orderEnt.AcceptAddress;
                ent.AcceptPeople = orderEnt.AcceptPeople;
                ent.AcceptTelephone = orderEnt.AcceptTelephone;
                ent.AcceptCellphone = orderEnt.AcceptCellphone;
                ent.ClientNum = orderEnt.ClientNum;
                ent.PayClientNum = orderEnt.PayClientNum;
                ent.PayClientName = orderEnt.PayClientName;
                ent.BelongHouse = orderEnt.BelongHouse;
                ent.OutHouseName = orderEnt.OutHouseName;
                ent.CreateAwb = UserInfor.UserName;
                ent.CreateAwbID = UserInfor.LoginName;
                ent.CreateDate = DateTime.Now;
                ent.OP_ID = UserInfor.LoginName.Trim();
                ent.SaleManID = Convert.ToString(Request["SaleManID"]);
                ent.SaleManName = Convert.ToString(Request["SaleManName"]);
                ent.Remark = Convert.ToString(Request["Remark"]);
                ent.OutHouseName = Convert.ToString(Request["ReturnHouse"]);

                #endregion
                string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//入库单号
                foreach (Hashtable row in GridRows)
                {
                    entDest.Add(new CargoOrderGoodsEntity
                    {
                        OrderNo = ent.OrderNo,
                        ProductID = Convert.ToInt64(row["ProductID"]),
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        AreaID = Convert.ToInt32(row["AreaID"]),
                        Piece = Convert.ToInt32(row["Piece"]),
                        ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
                        ContainerCode = Convert.ToString(row["ContainerCode"]),
                        ContainerID = Convert.ToInt32(row["ContainerID"]),
                        TypeID = Convert.ToInt32(row["TypeID"]),
                        TypeName = Convert.ToString(row["TypeName"]),
                        OutCargoID = outID,
                        RelateOrderNo = Convert.ToString(row["OrderNo"]),
                        OP_ID = UserInfor.LoginName.Trim(),
                        Born = Convert.ToString(row["Born"]),
                        Batch = Convert.ToString(row["Batch"]),
                        Model = Convert.ToString(row["Model"]),
                        Specs = Convert.ToString(row["Specs"]),
                        LoadIndex = Convert.ToString(row["LoadIndex"]),
                        SpeedLevel = Convert.ToString(row["SpeedLevel"]),
                        Figure = Convert.ToString(row["Figure"]),
                        GoodsCode = Convert.ToString(row["GoodsCode"]),
                        UnitPrice = Convert.ToDecimal(row["UnitPrice"]),
                        SalePrice = Convert.ToDecimal(row["SalePrice"]),
                        CostPrice = Convert.ToDecimal(row["CostPrice"]),
                        TradePrice = Convert.ToDecimal(row["TradePrice"]),
                        InHousePrice = Convert.ToDecimal(row["InHousePrice"]),
                        Supplier = Convert.ToString(row["Supplier"]),
                        ProductCode = Convert.ToString(row["ProductCode"]),
                        SuppClientNum = Convert.ToInt32(row["SuppClientNum"]),
                        SupplierAddress = Convert.ToString(row["SupplierAddress"]),
                        SpecsType = Convert.ToString(row["SpecsType"]),
                    });
                }
                ent.AwbStatus = "0";
                ent.OrderType = orderEnt.OrderType; //"0";
                ent.OrderModel = "1";//退货单
                ent.ThrowGood = "5";//退货单
                //ent.HouseID = entDest[0].HouseID;
                ent.HouseID = goHouseID;
                ent.goodsList = entDest;
                ent.UserInfor = UserInfor;

                ent.LogisID = string.IsNullOrEmpty(Convert.ToString(Request["LogisID"])) ? 0 : Convert.ToInt32(Request["LogisID"]);
                if (ent.HouseName == "东莞仓库" || ent.HouseName == "揭阳主仓库" || ent.HouseName == "梅州主仓库")
                {
                    ent.LogisID = 62;
                }
                if (ent.LogisID == 0)
                {
                    ent.LogisID = 34;
                }
                //ent.LogisticName = string.IsNullOrEmpty(Convert.ToString(Request["LogisID"])) ? "好来运供应商" : Convert.ToString(Request["LogisticName"]);
                //251023  已生成退货单不可再次生成
                CargoOrderEntity relateOrderEnt = bus.QueryOrderInfo(new CargoOrderEntity { RelateOrderNo = orderNo });
                if (!string.IsNullOrEmpty(relateOrderEnt.OrderNo))
                {
                    msg.Message = "已生成退货单不可再次生成";
                    msg.Result = false;
                    //返回处理结果
                    string res = JSON.Encode(msg);
                    Response.Write(res);
                    return;
                }
                //判断退货数量小于等于订单数量
                if (orderEnt.Piece < (ent.Piece+ relateOrderEnt.Piece))
                {
                    msg.Message = "退货数量大于订单数量";
                    msg.Result = false;
                    //返回处理结果
                    string res = JSON.Encode(msg);
                    Response.Write(res);
                    return;
                }

                if (msg.Result)
                {
                    bus.AddReturnOrderInfo(ent, log);
                    msg.Message = ent.OrderNo + "/" + outID;//订单号和重新入库单号

                    ent.HouseID = Convert.ToInt32(Request["eHouseID"]);

                    //新增推送信息
                    CargoHouseBus house = new CargoHouseBus();
                    CargoHouseEntity houseData = house.QueryCargoHouseByID(ent.HouseID);//查询仓库代码
                                                                                        //添加推送信息
                    bus.InsertCargoOrderPush(new CargoOrderPushEntity
                    {
                        OrderNo = ent.OrderNo,//订单号
                        Dep = ent.Dest,//出发站
                        Dest = ent.Dep,//到达站
                        Piece = ent.Piece,//总件数
                        TransportFee = ent.TransportFee,//总收入
                        ClientNum = ent.ClientNum.ToString(),//客户编码
                        AcceptAddress = houseData.Address,//客户详细地址
                        AcceptCellphone = houseData.Cellphone,//客户手机
                        AcceptTelephone = houseData.Cellphone,//客户联系电话
                        AcceptPeople = houseData.Person,//客户联系人
                        AcceptUnit = houseData.Name,//客户名称
                        HouseID = ent.HouseID.ToString(),
                        HouseName = houseData.Name,
                        OP_ID = UserInfor.UserName,
                        PushType = "0",
                        PushStatus = "0",
                        LogisID = ent.LogisID,
                        Type = 3
                    }, log);
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 删除退货单
        /// </summary>
        public void DelReturnOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoOrderEntity> list = new List<CargoOrderEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            CargoHouseBus house = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "退货管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    CargoOrderEntity ord = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = Convert.ToString(row["OrderNo"]) });
                    if (ord.FinanceSecondCheck.Equals("1"))
                    {
                        msg.Message = "财务已审核，不允许删除";
                        msg.Result = false;
                        break;
                    }
                    if (ord.CheckStatus.Equals("1"))
                    {
                        msg.Message = Convert.ToString(row["OrderNo"]) + "已结清，不允许删除";
                        msg.Result = false;
                        break;
                    }
                    if (ord.CheckStatus.Equals("2"))
                    {
                        msg.Message = Convert.ToString(row["OrderNo"]) + "结算中，不允许删除";
                        msg.Result = false;
                        break;
                    }
                    List<CargoOrderGoodsEntity> goodsList = bus.QueryOrderGoodsInfo(new CargoOrderGoodsEntity { OrderNo = Convert.ToString(row["OrderNo"]) });
                    foreach (var good in goodsList)
                    {
                        CargoContainerEntity contain = house.QueryContainerEntityByCode(good.ContainerCode, good.HouseID);
                        //根据货位ID和产品ID判断是否存在此货位
                        CargoContainerGoodsEntity cgood = house.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ContainerID = contain.ContainerID, ProductID = good.ProductID });
                        if (cgood == null || cgood.ID.Equals(0))
                        {
                            msg.Result = false;
                            msg.Message = "货位不存在";
                            break;
                        }
                        //if (good.Piece > cgood.Piece)
                        //{
                        //    msg.Result = false;
                        //    msg.Message = "库存不足";
                        //    break;
                        //}
                    }
                    if (!msg.Result)
                    {
                        break;
                    }

                    list.Add(new CargoOrderEntity
                    {
                        OrderID = Convert.ToInt64(row["OrderID"]),
                        OrderNo = Convert.ToString(row["OrderNo"]),
                        Dep = Convert.ToString(row["Dep"]),
                        Dest = Convert.ToString(row["Dest"]),
                        Piece = Convert.ToInt32(row["Piece"]),
                        TransportFee = Convert.ToDecimal(row["TransportFee"]),
                        TotalCharge = Convert.ToDecimal(row["TotalCharge"]),
                        AcceptUnit = Convert.ToString(row["AcceptUnit"]),
                        AcceptPeople = Convert.ToString(row["AcceptPeople"]),
                        AcceptTelephone = Convert.ToString(row["AcceptTelephone"]),
                        AcceptCellphone = Convert.ToString(row["AcceptCellphone"]),
                        AcceptAddress = Convert.ToString(row["AcceptAddress"]),
                        SaleManName = Convert.ToString(row["SaleManName"]),
                        CreateAwb = Convert.ToString(row["CreateAwb"]),
                        CreateAwbID = UserInfor.LoginName,
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        CreateDate = Convert.ToDateTime(row["CreateDate"])
                    });

                    //仓库同步缓存
                    List<CargoProductEntity> syncProduct = house.SyncTypeOrderNo(Convert.ToString(row["OrderNo"]));
                    foreach (CargoProductEntity product in syncProduct)
                    {

                        if (product.SyncType == "2" || (product.SyncType == "1" && product.TypeID == 34))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + product.HouseID + "_" + product.TypeID + "_" + product.ProductCode + "", product.GoodsCode);
                        }
                    }
                }
                if (msg.Result)
                {


                    bus.DelReturnOrder(list, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }
        /// <summary>
        /// 退货的物流快递数据保存
        /// </summary>
        public void UpdateReturnLogisAwbNo()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;

            CargoOrderEntity ent = new CargoOrderEntity();

            CargoOrderBus bus = new CargoOrderBus();

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "退货管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";

            try
            {
                ent.OrderID = Convert.ToInt64(Request["OrderID"]);
                ent.OrderNo = Convert.ToString(Request["OrderNo"]);
                if (!string.IsNullOrEmpty(Convert.ToString(Request["LogisID"])))
                {
                    ent.LogisID = Convert.ToInt32(Request["LogisID"]);

                }
                ent.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
                ent.TransitFee = string.IsNullOrEmpty(Convert.ToString(Request["BTransitFee"])) ? 0 : Convert.ToDecimal(Request["BTransitFee"]);
                bus.UpdateReturnLogisAwbNo(ent, log);
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }

        public void CheckReturnOrder()
        {
            String json = Request["data"];
            ArrayList rows = (ArrayList)JSON.Decode(json);
            List<CargoOrderEntity> list = new List<CargoOrderEntity>();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "销售管理";
            log.NvgPage = "退货订单审核";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            log.Memo = "批量审核成功";
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            string check = Convert.ToString(Request["Check"]);
            try
            {
                foreach (Hashtable row in rows)
                {
                    if (!Convert.ToString(row["FinanceSecondCheck"]).Trim().Equals(check)) { continue; }
                    list.Add(new CargoOrderEntity
                    {
                        OrderID = Convert.ToInt64(row["OrderID"]),
                        OrderNo = Convert.ToString(row["OrderNo"]),
                        FinanceSecondCheck = (check.Equals("0") ? "1" : "0"),
                        FinanceSecondCheckName = UserInfor.UserName,
                        FinanceSecondCheckDate = DateTime.Now
                    });
                }
                CargoFinanceBus bus = new CargoFinanceBus();
                if (msg.Result)
                {
                    if (list.Count > 0)
                    {
                        bus.plSecondCheckOrder(list, log);
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 根据订单号查询该订单的流程图
        /// </summary>
        public void QueryExpenseRoutAtOrderNo()
        {
            string res = "<div style='text-align: center'>该订单没有审批流程</div>";

            string applyID = Request["CreateAwbID"];
            string applyName = Request["CreateAwb"];
            int HouseID = Convert.ToInt32(Request["HouseID"]);
            QiyeBus qiye = new QiyeBus();

            CargoOrderEntity queryEntity = new CargoOrderEntity();
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoExpenseApproveRoutEntity> result = bus.QueryExpenseRoutAtOrderNo(queryEntity);

            ArrayList checklist = new ArrayList();

            bool operaType = false;
            if (result.Count > 0)
            {
                res = "<table class='commTblStyle_8' border='0' width='100%' style='border-spacing:0;border-collapse:collapse;font-size:14px;'><tbody><tr><th>处理人</th><th>操作</th><th>处理时间</th><th>结果</th></tr>";
                foreach (var it in result)
                {
                    checklist.Add(it.UserName);
                    string op = "通过";
                    if (it.Opera.Equals("1")) { op = "拒审"; }
                    else if (it.Opera.Equals("2")) { op = "结束"; operaType = true; }
                    else if (it.Opera.Equals("3")) { op = "提交申请"; }
                    res += "<tr><td>" + it.UserName + "</td><td>" + op + "</td><td>" + it.OperaDate.ToString("yyyy-MM-dd HH:mm:ss") + "</td><td>" + it.Result + "</td></tr>";
                }
                res += "</tbody><table>";

                #region 步骤图
                string str = "<div class='content' style='margin: -3% 5%;'><div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'><span class='poetry'>" + applyName + "</span></div><div class='bar b-select'><div class='c-step c-select'></div></div><div class='text' style='margin: 10px -25px;'><span class='poetry'>发起申请</span></div></div>";
                //string str = "";
                CargoFinanceBus f = new CargoFinanceBus();
                List<QyUserEntity> qyUser = new List<QyUserEntity>();
                //CargoApproveSetEntity AppSet = f.QueryApproveSetByID(33);
                CargoApproveSetEntity AppSet = new CargoApproveSetEntity();
                //string ApproveType = result[0].OrderCheckType.Equals("2") ? "9" : result[0].OrderCheckType.Equals("4") ? "11" : "3";
                string ApproveType = result[0].OrderCheckType.Equals("2") ? "9" : result[0].OrderCheckType.Equals("3") ? "10" : result[0].OrderCheckType.Equals("4") ? "11" : result[0].OrderCheckType.Equals("5") ? "12" : result[0].OrderCheckType.Equals("6") ? "13" : result[0].OrderCheckType.Equals("18") ? "18" : result[0].OrderCheckType.Equals("19") ? "19" : "3";
                List<CargoApproveSetEntity> aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = ApproveType, DelFlag = "0", HouseID = HouseID });
                if (aset.Count > 0) { AppSet = aset[0]; }
                else
                {
                    aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = "3", DelFlag = "0", HouseID = HouseID });
                    if (aset.Count > 0) { AppSet = aset[0]; }
                }
                CargoOrderBus orderBus = new CargoOrderBus();

                if (!string.IsNullOrEmpty(AppSet.OneCheckID))
                {
                    string CheckID = AppSet.OneCheckID;
                    string CheckName = AppSet.OneCheckName;
                    qyUser.Clear();
                    string userStr = "", name = "";
                    if (CheckID == "3")
                    {
                        SystemUserEntity entity = new SystemUserEntity();
                        entity.LoginName = applyID;
                        List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                        if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                        {
                            userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                            name = Bosslist[0].UserName;
                        }
                    }
                    else
                    {
                        qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                        //foreach (var user in qyUser)
                        if (!string.IsNullOrEmpty(qyUser[0].WxName))
                        {
                            userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                            name = qyUser[0].WxName;
                        }
                    }
                    if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                    str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                    if (checklist.Contains(name))
                    {
                        str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                    }
                    else
                    {
                        str += "<div class='bar'><div class='c-step'></div></div>";
                    }
                    str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                    if (!string.IsNullOrEmpty(AppSet.TwoCheckID))
                    {
                        CheckID = AppSet.TwoCheckID;
                        CheckName = AppSet.TwoCheckName;
                        qyUser.Clear();
                        userStr = "";
                        if (CheckID == "3")
                        {
                            SystemUserEntity entity = new SystemUserEntity();
                            entity.LoginName = applyID;
                            List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                            if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                            {
                                userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                name = Bosslist[0].UserName;
                            }
                        }
                        else
                        {
                            qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                            if (!string.IsNullOrEmpty(qyUser[0].WxName))
                            {
                                userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                name = qyUser[0].WxName;
                            }
                        }
                        if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                        str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                        if (checklist.Contains(name))
                        {
                            str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                        }
                        else
                        {
                            str += "<div class='bar'><div class='c-step'></div></div>";
                        }
                        str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                        if (!string.IsNullOrEmpty(AppSet.ThreeCheckID))
                        {
                            CheckID = AppSet.ThreeCheckID;
                            CheckName = AppSet.ThreeCheckName;
                            qyUser.Clear();
                            userStr = "";
                            if (CheckID == "3")
                            {
                                SystemUserEntity entity = new SystemUserEntity();
                                entity.LoginName = applyID;
                                List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                {
                                    userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                    name = Bosslist[0].UserName;
                                }
                            }
                            else
                            {
                                qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                if (qyUser.Count > 0)
                                {
                                    if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                    {
                                        userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                        name = qyUser[0].WxName;
                                    }
                                }
                            }
                            if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                            str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                            if (checklist.Contains(name))
                            {
                                str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                            }
                            else
                            {
                                str += "<div class='bar'><div class='c-step'></div></div>";
                            }
                            str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                            if (!string.IsNullOrEmpty(AppSet.FourCheckID))
                            {
                                CheckID = AppSet.FourCheckID;
                                CheckName = AppSet.FourCheckName;
                                qyUser.Clear();
                                userStr = "";
                                if (CheckID == "3")
                                {
                                    SystemUserEntity entity = new SystemUserEntity();
                                    entity.LoginName = applyID;
                                    List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                    if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                    {
                                        userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                        name = Bosslist[0].UserName;
                                    }
                                }
                                else
                                {
                                    qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                    if (qyUser.Count > 0)
                                    {
                                        if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                        {
                                            userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                            name = qyUser[0].WxName;
                                        }
                                    }
                                }
                                if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                if (checklist.Contains(name))
                                {
                                    str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                }
                                else
                                {
                                    str += "<div class='bar'><div class='c-step'></div></div>";
                                }
                                str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                if (!string.IsNullOrEmpty(AppSet.FiveCheckID))
                                {
                                    CheckID = AppSet.FiveCheckID;
                                    CheckName = AppSet.FiveCheckName;
                                    qyUser.Clear();
                                    userStr = "";
                                    if (CheckID == "3")
                                    {
                                        SystemUserEntity entity = new SystemUserEntity();
                                        entity.LoginName = applyID;
                                        List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                        if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                        {
                                            userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                            name = Bosslist[0].UserName;
                                        }
                                    }
                                    else
                                    {
                                        qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                        if (qyUser.Count > 0)
                                        {
                                            if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                            {
                                                userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                                name = qyUser[0].WxName;
                                            }
                                        }
                                    }
                                    if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                    str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                    if (checklist.Contains(name))
                                    {
                                        str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                    }
                                    else
                                    {
                                        str += "<div class='bar'><div class='c-step'></div></div>";
                                    }
                                    str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                    if (!string.IsNullOrEmpty(AppSet.SixCheckID))
                                    {
                                        CheckID = AppSet.SixCheckID;
                                        CheckName = AppSet.SixCheckName;
                                        qyUser.Clear();
                                        userStr = "";
                                        if (CheckID == "3")
                                        {
                                            SystemUserEntity entity = new SystemUserEntity();
                                            entity.LoginName = applyID;
                                            List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                            if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                            {
                                                userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                                name = Bosslist[0].UserName;
                                            }
                                        }
                                        else
                                        {
                                            qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                            if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                            {
                                                userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                                name = qyUser[0].WxName;
                                            }
                                        }
                                        if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                        str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                        if (checklist.Contains(name))
                                        {
                                            str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                        }
                                        else
                                        {
                                            str += "<div class='bar'><div class='c-step'></div></div>";
                                        }
                                        str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                        if (!string.IsNullOrEmpty(AppSet.SevenCheckID))
                                        {
                                            CheckID = AppSet.SevenCheckID;
                                            CheckName = AppSet.SevenCheckName;
                                            qyUser.Clear();
                                            userStr = "";
                                            if (CheckID == "3")
                                            {
                                                SystemUserEntity entity = new SystemUserEntity();
                                                entity.LoginName = applyID;
                                                List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                                if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                                {
                                                    userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                                    name = Bosslist[0].UserName;
                                                }
                                            }
                                            else
                                            {
                                                qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                                if (qyUser.Count > 0)
                                                {
                                                    if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                                    {
                                                        userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                                        name = qyUser[0].WxName;
                                                    }
                                                }
                                            }
                                            if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                            str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                            if (checklist.Contains(name))
                                            {
                                                str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                            }
                                            else
                                            {
                                                str += "<div class='bar'><div class='c-step'></div></div>";
                                            }
                                            str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                            if (!string.IsNullOrEmpty(AppSet.EightCheckID))
                                            {
                                                CheckID = AppSet.EightCheckID;
                                                CheckName = AppSet.EightCheckName;
                                                qyUser.Clear();
                                                userStr = "";
                                                if (CheckID == "3")
                                                {
                                                    SystemUserEntity entity = new SystemUserEntity();
                                                    entity.LoginName = applyID;
                                                    List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                                    if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                                    {
                                                        userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                                        name = Bosslist[0].UserName;
                                                    }
                                                }
                                                else
                                                {
                                                    qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                                    if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                                    {
                                                        userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                                        name = qyUser[0].WxName;
                                                    }
                                                }
                                                if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                                str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                                if (checklist.Contains(name))
                                                {
                                                    str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                                }
                                                else
                                                {
                                                    str += "<div class='bar'><div class='c-step'></div></div>";
                                                }
                                                str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                if (operaType)
                {
                    str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'><span class='poetry'>&nbsp;</span></div><div class='bar b-select' style='width: 0;'><div class='c-step c-select'></div></div><div class='text' style='margin: 10px -15px;'><span class='poetry'>结束</span></div></div></div>";
                }
                else
                {
                    str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'><span class='poetry'>&nbsp;</span></div><div class='bar' style='width: 0;'><div class='c-step'></div></div><div class='text' style='margin: 10px -15px;'><span class='poetry'>结束</span></div></div></div>";
                }
                #endregion
                res = str + res;
            }

            String json = JSON.Encode(res);
            Response.Write(json);
        }
        /// <summary>
        /// 查询退货单明细
        /// </summary>
        public void QuerReturnOrderInfo()
        {
            string err = "OK";
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Piece"]))) { queryEntity.Piece = Convert.ToInt32(Request["Piece"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.Dep = Convert.ToString(Request["Dep"]);
            queryEntity.Dest = Convert.ToString(Request["Dest"]);
            if (!string.IsNullOrEmpty(Request["HouseID"]) && Request["HouseID"] != "undefined")//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            //2021-01-30 添加客户名称查询条件
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoOrderEntity> list = bus.QuerReturnOrderInfo(queryEntity);
            if (list != null) { QueryReturnOrderInfoList = list; }

            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        public List<CargoOrderEntity> QueryReturnOrderInfoList
        {
            get
            {
                if (Session["QueryReturnOrderInfoList"] == null)
                {
                    Session["QueryReturnOrderInfoList"] = new List<CargoOrderEntity>();
                }
                return (List<CargoOrderEntity>)(Session["QueryReturnOrderInfoList"]);
            }
            set
            {
                Session["QueryReturnOrderInfoList"] = value;
            }
        }
        #endregion
        #region 微信商城操作方法集合
        /// <summary>
        /// 查询微信商城订单数据
        /// </summary>
        public void QueryWeixinOrderInfo()
        {
            WXOrderManagerEntity queryEntity = new WXOrderManagerEntity();
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            if (Request["PayStatus"] != "-1") { queryEntity.PayStatus = Convert.ToString(Request["PayStatus"]); }
            if (Request["PayWay"] != "-1") { queryEntity.PayWay = Convert.ToString(Request["PayWay"]); }
            if (Request["OrderStatus"] != "-1") { queryEntity.OrderStatus = Convert.ToString(Request["OrderStatus"]); }
            queryEntity.Name = Convert.ToString(Request["Name"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Request["HID"]))
            {

                queryEntity.CargoPermisID = Convert.ToString(Request["HID"]);
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            }
            List<WXOrderManagerEntity> list = new List<WXOrderManagerEntity>();
            CargoOrderBus bus = new CargoOrderBus();
            if (Convert.ToString(Request["HID"]).Equals("83"))
            {
                queryEntity.CargoPermisID = "83";
                list = bus.QueryWeixinOrderInfoNew(queryEntity);
            }
            else
            {
                list = bus.QueryWeixinOrderInfo(queryEntity);

            }

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 删除微信订单
        /// </summary>
        public void DeleteWeixinOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoWeiXinBus bus = new CargoWeiXinBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "微信商城订单";
            log.Status = "0";
            log.NvgPage = "删除订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            WXOrderEntity entity = new WXOrderEntity();
            try
            {
                entity.OrderNo = json;

                WXOrderEntity wo = bus.QueryWeixinOrderByOrderNo(entity);
                if (wo != null && !wo.ID.Equals(0))
                {
                    //if (wo.PayStatus.Equals("1"))
                    //{
                    //    msg.Message = "订单已付款，不允许删除";
                    //    msg.Result = false;
                    //}
                    if (!wo.OrderStatus.Equals("0"))
                    {
                        msg.Message = "仓库已发货，不允许删除";
                        msg.Result = false;
                    }
                }
                if (msg.Result)
                {
                    bus.DeleteWeixinOrder(wo, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }
        /// <summary>
        /// 仓库 确认订单
        /// </summary>
        public void makeSureWxOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "微信商城订单";
            log.Status = "0";
            log.NvgPage = "仓库确认订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            List<WXOrderManagerEntity> wxOrderList = new List<WXOrderManagerEntity>();
            try
            {
                WXOrderManagerEntity queryEntity = new WXOrderManagerEntity();
                queryEntity.OrderNo = json;
                CargoOrderBus bus = new CargoOrderBus();

                wxOrderList = bus.QueryContainerGoodsMakeSureWeixinOrder(queryEntity);
                if (wxOrderList.Count <= 0)
                {
                    msg.Message = "订单数据有误";
                    msg.Result = false;
                    goto ERR;
                }
                if (!wxOrderList[0].OrderStatus.Equals("0"))
                {
                    msg.Message = "商城订单已确认，请重新查询后再操作";
                    msg.Result = false;
                    goto ERR;
                }

                CargoHouseBus house = new CargoHouseBus();
                CargoAreaEntity careaEnt = new CargoAreaEntity();
                List<CargoAreaEntity> areaList = new List<CargoAreaEntity>();
                //1.根据城市查询该城市是否在仓库配送区域，在则从该仓库出库，不在
                //2.根据区域查询 该区域是否在仓库配送区域 ，在则从该仓库出库，不在，则直接返回
                //deliv = house.IsExistDeliveryArea(new CargoAreaEntity { HouseID = houseID, DeliveryArea = Country });
                careaEnt = house.QueryAreaByDeliveryArea(new CargoAreaEntity { HouseID = wxOrderList[0].HouseID, DeliveryArea = wxOrderList[0].Country });
                if (careaEnt.AreaID.Equals(0))
                {
                    careaEnt = house.QueryAreaByDeliveryArea(new CargoAreaEntity { HouseID = wxOrderList[0].HouseID, DeliveryArea = wxOrderList[0].City });
                    if (careaEnt.AreaID.Equals(0))
                    {
                        //该省份未开放购买权限
                        msg.Message = "该省份未开放购买权限";
                        msg.Result = false;
                        goto ERR;
                    }
                }
                areaList = house.QueryAreaListByDeliveryArea(new CargoAreaEntity { HouseID = wxOrderList[0].HouseID, DeliveryArea = wxOrderList[0].City });

                CargoHouseEntity houseEnt = house.QueryCargoHouseByID(wxOrderList[0].HouseID);
                CargoOrderEntity order = new CargoOrderEntity();
                CargoWeiXinBus wx = new CargoWeiXinBus();
                WXCouponEntity coupon = new WXCouponEntity();
                if (!wxOrderList[0].CouponID.Equals(0))
                {
                    coupon = wx.QueryCouponByID(new WXCouponEntity { ID = wxOrderList[0].CouponID });
                }
                #region 建订单
                int OrderNum = 0;
                order.OrderNo = Common.GetMaxOrderNumByCurrentDate(wxOrderList[0].HouseID, houseEnt.HouseCode, out OrderNum); // Convert.ToString(Request["OrderNo"]);//生成最新顺序订单号
                                                                                                                              //int RetryCount = 0;
                                                                                                                              //while (OrderNoList.Contains(order.OrderNo))
                                                                                                                              //{
                                                                                                                              //    RetryCount++;
                                                                                                                              //    order.OrderNo = Common.GetMaxOrderNumByCurrentDate(wxOrderList[0].HouseID, houseEnt.HouseCode, out OrderNum, RetryCount);
                                                                                                                              //}
                                                                                                                              //OrderNoList.Add(order.OrderNo);
                order.OrderNum = OrderNum;//最新订单顺序号
                order.WXOrderNo = json;
                order.HAwbNo = "";
                order.Dep = houseEnt.DepCity; order.Dest = wxOrderList[0].City;
                order.Piece = wxOrderList[0].Piece; order.Weight = order.Volume = order.DeliveryFee = order.InsuranceFee = order.OtherFee = order.Rebate = 0.00M;
                order.TransitFee = wxOrderList[0].TransitFee;
                order.InsuranceFee = Convert.ToDecimal(coupon.Money);
                order.TransportFee = wxOrderList[0].TotalCharge - wxOrderList[0].TransitFee + Convert.ToDecimal(coupon.Money);
                order.TotalCharge = wxOrderList[0].TotalCharge;
                order.CheckOutType = "0";
                if (wxOrderList[0].PayWay.Equals("0"))
                {
                    order.CheckOutType = "5";
                }
                else if (wxOrderList[0].PayWay.Equals("1"))
                {
                    order.CheckOutType = "6";
                }
                order.TrafficType = order.DeliveryType = "0";
                order.ClientNum = wxOrderList[0].ClientNum;
                order.PayClientNum = wxOrderList[0].ClientNum;
                order.AcceptUnit = order.AcceptPeople = wxOrderList[0].Name;
                order.PayClientName = wxOrderList[0].Name;
                order.AcceptTelephone = order.AcceptCellphone = wxOrderList[0].Cellphone;
                order.AcceptAddress = wxOrderList[0].AcceptAddress;
                order.HouseID = wxOrderList[0].HouseID;
                order.PayWay = wxOrderList[0].PayWay;
                order.PayStatus = wxOrderList[0].PayStatus;
                if ((wxOrderList[0].PayWay.Equals("0") && wxOrderList[0].PayStatus.Equals("1")) || wxOrderList[0].PayWay.Equals("2"))
                {
                    //微信付款并且支付成功
                    order.FinanceSecondCheck = "1";
                    order.FinanceSecondCheckName = UserInfor.UserName;
                    order.FinanceSecondCheckDate = DateTime.Now;
                }
                order.OP_ID = UserInfor.LoginName;
                order.AwbStatus = "1";//正在备货
                                      //order.OrderType = "2";//微信公众号下单 
                order.OrderType = wxOrderList[0].OrderType;
                order.OrderModel = "0";//订货单 
                order.Remark = wxOrderList[0].Memo;
                order.LogisID = wxOrderList[0].LogisID;
                order.CreateAwbID = UserInfor.LoginName;
                order.CreateAwb = UserInfor.UserName;
                order.CreateDate = DateTime.Now;
                order.IsAppFirstOrder = wxOrderList[0].IsAppFirstOrder;
                order.CouponID = wxOrderList[0].CouponID;
                //CargoClientBus client = new CargoClientBus();
                // CargoClientEntity clientEnt = client.QueryCargoClient(order.ClientNum);
                WXUserAddressEntity clerkEntity = wx.QueryWxAreaClient(new WXUserAddressEntity { Province = wxOrderList[0].Province, City = wxOrderList[0].City });
                if (!string.IsNullOrEmpty(clerkEntity.LoginName))
                {
                    order.SaleManID = clerkEntity.LoginName;
                    order.SaleManName = clerkEntity.UserName;
                }

                #endregion
                string OutHouseName = careaEnt.Name;//出库仓库名称
                List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
                List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
                string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                CargoInterfaceBus interBus = new CargoInterfaceBus();
                bool bz = false;
                foreach (var it in wxOrderList)
                {
                    if (it.HouseID.Equals(9) && it.TypeID.Equals(34)) { bz = true; }
                    int piece = it.OrderNum;
                    if (it.SaleType.Equals("1") || it.PayWay.Equals("2"))
                    {
                        #region 直接出库
                        entDest.Add(new CargoOrderGoodsEntity
                        {
                            OrderNo = order.OrderNo,
                            ProductID = it.ProductID,
                            HouseID = it.HouseID,
                            AreaID = it.AreaID,
                            Piece = it.OrderNum,
                            ActSalePrice = it.OrderPrice,
                            ContainerCode = it.ContainerCode,
                            OutCargoID = outID,
                            OP_ID = UserInfor.LoginName.Trim()
                        });

                        CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                        cargo.OrderNo = order.OrderNo;//订单号
                        cargo.OutCargoID = outID;
                        cargo.ContainerID = it.ContainerID;
                        cargo.TypeID = it.TypeID;
                        cargo.ProductID = it.ProductID;
                        cargo.Piece = it.OrderNum;//出库件数
                        cargo.ActSalePrice = it.OrderPrice;
                        cargo.InPiece = it.InCargoPiece;
                        cargo.ID = it.InContainID;

                        //cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                        cargo.HouseName = houseEnt.Name;
                        cargo.AreaName = it.AreaName;
                        cargo.ProductName = it.ProductName;
                        cargo.Model = it.Model;
                        cargo.Specs = it.Specs;
                        cargo.Figure = it.Figure;
                        outHouseList.Add(cargo);
                        CargoAreaEntity cae = house.QueryHouseByAreaID(new CargoAreaEntity { AreaID = it.AreaID });
                        if (!cae.AreaID.Equals(0))
                        {
                            OutHouseName = cae.Name;
                        }
                        #endregion
                    }
                    else
                    {
                        #region 优先出库方法
                        bool noTyre = false;//没有库存
                        CargoInterfaceEntity stockEntity = new CargoInterfaceEntity
                        {
                            HouseID = it.HouseID,
                            AreaID = careaEnt.AreaID,
                            //GoodsCode = it.GoodsCode,
                            Specs = it.Specs,
                            TypeID = it.TypeID,
                            Figure = it.Figure,
                            BatchYear = it.BatchYear,
                            //LoadIndex = it.LoadIndex,
                            //SpeedLevel = it.SpeedLevel,
                        };
                        List<CargoInterfaceEntity> stockList = interBus.queryMiniCargoStock(stockEntity);
                        if (stockList.Count <= 0)
                        {
                            msg.Result = false;
                            msg.Message = "商品名称：" + it.Title + "库存为空";
                            noTyre = true;
                            //goto ERR;
                        }
                        if (stockList.Sum(c => c.StockNum) < piece)
                        {
                            msg.Result = false;
                            msg.Message = "商品名称：" + it.Title + "库存不足，库存只剩：" + stockList.Sum(c => c.StockNum).ToString();
                            noTyre = true;
                            //goto ERR;
                        }
                        bool HaveTyre = false;
                        //查询另外仓库
                        if (noTyre)
                        {
                            foreach (var area in areaList)
                            {
                                if (area.AreaID.Equals(careaEnt.AreaID)) { continue; }
                                CargoInterfaceEntity stockEntityA = new CargoInterfaceEntity
                                {
                                    HouseID = it.HouseID,
                                    AreaID = area.AreaID,
                                    //GoodsCode = it.GoodsCode,
                                    Specs = it.Specs,
                                    TypeID = it.TypeID,
                                    Figure = it.Figure,
                                    BatchYear = it.BatchYear,
                                    //LoadIndex = it.LoadIndex,
                                    //SpeedLevel = it.SpeedLevel,
                                };
                                int curKC = stockList.Sum(c => c.StockNum);//现在库存
                                List<CargoInterfaceEntity> stock = interBus.queryMiniCargoStock(stockEntityA);
                                if (stock.Count <= 0)
                                {
                                    msg.Result = false;
                                    msg.Message = "商品名称：" + it.Title + "库存为空";
                                    continue;
                                }
                                stockList.AddRange(stock);
                                if (stock.Sum(c => c.StockNum) + curKC < piece)
                                {
                                    msg.Result = false;
                                    msg.Message = "商品名称：" + it.Title + "库存不足，库存只剩：" + (stockList.Sum(c => c.StockNum) + curKC).ToString();
                                    continue;
                                }
                                HaveTyre = true; break;
                            }
                        }
                        if (!noTyre || (noTyre && HaveTyre))
                        {
                            //减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                            foreach (var kc in stockList)
                            {
                                if (kc.StockNum <= 0) { continue; }
                                CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                                cargo.OrderNo = order.OrderNo;//订单号
                                cargo.OutCargoID = outID;
                                cargo.ContainerID = kc.ContainerID;
                                cargo.TypeID = kc.TypeID;
                                cargo.ProductID = kc.ProductID;

                                cargo.ID = kc.ContainerGoodsID;//库存表ID

                                //cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                                cargo.HouseName = houseEnt.Name;
                                //cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                                cargo.ProductName = kc.ProductName;
                                cargo.GoodsCode = kc.GoodsCode;
                                cargo.Model = kc.Model;
                                cargo.Specs = kc.Specs;
                                cargo.Figure = kc.Figure;
                                #region 减库存逻辑
                                if (piece < kc.StockNum)
                                {
                                    //部分出
                                    entDest.Add(new CargoOrderGoodsEntity
                                    {
                                        OrderNo = order.OrderNo,
                                        ProductID = kc.ProductID,
                                        HouseID = order.HouseID,
                                        AreaID = kc.AreaID,
                                        Piece = piece,
                                        ActSalePrice = it.OrderPrice,
                                        ContainerCode = kc.ContainerCode,
                                        OutCargoID = outID,
                                        OP_ID = log.UserID
                                    });
                                    cargo.Piece = piece;
                                    cargo.ActSalePrice = it.OrderPrice;
                                    cargo.InPiece = kc.StockNum;

                                    outHouseList.Add(cargo);
                                    break;
                                }
                                if (piece.Equals(kc.StockNum))
                                {
                                    //要出库件数和第一条库存件数刚刚好，则就全部出
                                    entDest.Add(new CargoOrderGoodsEntity
                                    {
                                        OrderNo = order.OrderNo,
                                        ProductID = kc.ProductID,
                                        HouseID = order.HouseID,
                                        AreaID = kc.AreaID,
                                        Piece = piece,
                                        ActSalePrice = it.OrderPrice,
                                        ContainerCode = kc.ContainerCode,
                                        OutCargoID = outID,
                                        OP_ID = log.UserID
                                    });
                                    cargo.Piece = piece;
                                    cargo.ActSalePrice = it.OrderPrice;
                                    cargo.InPiece = kc.StockNum;

                                    outHouseList.Add(cargo);
                                    break;
                                }
                                if (piece > kc.StockNum)
                                {
                                    //全部出
                                    entDest.Add(new CargoOrderGoodsEntity
                                    {
                                        OrderNo = order.OrderNo,
                                        ProductID = kc.ProductID,
                                        HouseID = order.HouseID,
                                        AreaID = kc.AreaID,
                                        Piece = kc.StockNum,
                                        ActSalePrice = it.OrderPrice,
                                        ContainerCode = kc.ContainerCode,
                                        OutCargoID = outID,
                                        OP_ID = log.UserID
                                    });
                                    cargo.Piece = kc.StockNum;
                                    cargo.InPiece = kc.StockNum;
                                    cargo.ActSalePrice = it.OrderPrice;

                                    outHouseList.Add(cargo);
                                    piece = piece - kc.StockNum;
                                    continue;
                                }
                                #endregion
                            }
                            CargoAreaEntity cae = house.QueryHouseByAreaID(new CargoAreaEntity { AreaID = stockList[0].AreaID });
                            if (!cae.AreaID.Equals(0))
                            {
                                OutHouseName = cae.Name;
                            }
                        }
                        else
                        {
                            goto ERR;
                        }

                        #endregion
                    }
                }
                order.OutHouseName = OutHouseName;
                if (bz) { order.Remark += "  打包装"; }
                order.goodsList = entDest;


                //仓库同步缓存
                foreach (CargoContainerShowEntity time in outHouseList)
                {
                    CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                    //34 马牌  1 同步马牌  2 同步全部品牌
                    if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                    {
                        RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                    }
                }

                bus.makeSureWxOrder(order, outHouseList, log);
                //bus.DeleteOrderInfo(list, log);
                msg.Result = true;
                msg.Message = "成功";

                if (order.HouseID.Equals(9) || order.HouseID.Equals(15) || order.HouseID.Equals(49) || order.HouseID.Equals(50) || order.HouseID.Equals(51) || order.HouseID.Equals(52) || order.HouseID.Equals(53) || order.HouseID.Equals(54) || order.HouseID.Equals(13) || order.HouseID.Equals(14) || order.HouseID.Equals(15) || order.HouseID.Equals(23) || order.HouseID.Equals(30))
                {
                    //内部订单
                    bus.SaveHlyOrderData(outHouseList, order);
                }
                else
                {
                    bus.InsertCargoOrderPush(new CargoOrderPushEntity
                    {
                        OrderNo = order.OrderNo,
                        Dep = order.Dep,
                        Dest = order.Dest,
                        Piece = order.Piece,
                        TransportFee = order.TransportFee,
                        ClientNum = order.ClientNum.ToString(),
                        AcceptAddress = order.AcceptAddress,
                        AcceptCellphone = order.AcceptCellphone,
                        AcceptTelephone = order.AcceptTelephone,
                        AcceptPeople = order.AcceptPeople,
                        AcceptUnit = order.AcceptUnit,
                        HouseID = order.HouseID.ToString(),
                        HouseName = houseEnt.Name,
                        OP_ID = UserInfor.LoginName,
                        PushType = "0",
                        PushStatus = "0",
                        LogisID = order.LogisID
                    }, log);
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            try
            {
                if (!string.IsNullOrEmpty(wxOrderList[0].wxOpenID))
                {
                    //仓库确认成功向客户微信发送推送消息
                    //推送客户消息
                    TemplateMsg tmMsg = new TemplateMsg
                    {
                        first = new TemplateDataItem("尊敬的迪乐泰客户，您的订单仓库已确认！~正在秒速为您安排发货，请耐心等待哦~", "#173177"),
                        keyword1 = new TemplateDataItem(wxOrderList[0].Title, "#173177"),
                        keyword2 = new TemplateDataItem(wxOrderList[0].TotalCharge.ToString("F2") + "元", "#173177"),
                        keyword3 = new TemplateDataItem(wxOrderList[0].OrderNo, "#173177"),
                        remark = new TemplateDataItem("点击查看物流跟踪详情!", "#173177")
                    };
                    SendTempleteMessage send = new SendTempleteMessage();
                    string token = Common.GetWeixinToken(Common.GetdltAPPID(), Common.GetdltAppSecret());

                    //oo1LEt_z6Yhx-g_qdgrYhLaYaazE//测试
                    string errmsg = send.SendMessage(token, wxOrderList[0].wxOpenID, "heDfICkOgVf3gfod4kM6CL4MiK4YikrFGm6k9QgUZ8A", "http://dlt.neway5.com/Weixin/OrderInfo.aspx?orderNo=" + wxOrderList[0].OrderNo, tmMsg);
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = true;
            }
        ERR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 修改商城订单金额
        /// </summary>
        public void modifyOrderCharge()
        {
            ErrMessage msg = new ErrMessage();
            String total = Request["total"];
            String orderno = Request["orderno"];
            if (String.IsNullOrEmpty(orderno))
            {
                msg.Message = "订单号不能为空";
                msg.Result = false;

                goto ERR;
            }
            if (String.IsNullOrEmpty(total))
            {
                msg.Message = "订单金额不能为空";
                msg.Result = false;

                goto ERR;
            }

            if (String.IsNullOrEmpty(orderno)) return;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "微信商城订单";
            log.Status = "0";
            log.NvgPage = "修改订单金额";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";

            WXOrderEntity entity = new WXOrderEntity();
            entity.OrderNo = orderno;
            entity.TotalCharge = Convert.ToDecimal(total);
            CargoWeiXinBus bus = new CargoWeiXinBus();

            bus.UpdateWxOrderTotalCharge(entity, log);
            msg.Result = true;
            msg.Message = "成功";
        ERR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }
        #endregion
        #region 改价申请审批操作方法集合
        /// <summary>
        /// 查询改价申请审批数据表
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public void QueryUpdatePriceInfo()
        {
            QyOrderUpdatePriceEntity queryEntity = new QyOrderUpdatePriceEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }

            if (!string.IsNullOrEmpty(Request["HID"]))
            {
                queryEntity.HouseID = Convert.ToInt32(Request["HID"]);
            }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.ApplyName = Convert.ToString(Request["ApplyName"]);
            queryEntity.SaleManName = Convert.ToString(Request["SaleManName"]);

            if (Convert.ToString(Request["OrderType"]) != "-1")
            {
                queryEntity.OrderType = Convert.ToString(Request["OrderType"]);
            }
            if (Convert.ToString(Request["ApplyStatus"]) != "-1")
            {
                queryEntity.ApplyStatus = Convert.ToString(Request["ApplyStatus"]);
            }

            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryUpdatePriceInfo(pageIndex, pageSize, queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询电脑下单改价明细
        /// </summary>
        public void queryOrderUpdateGoodsByOIDComputer()
        {
            //查询条件
            string OID = Request["OID"];
            string OrderType = Convert.ToString(Request["OrderType"]);
            if (string.IsNullOrEmpty(OID)) { return; }
            QiyeBus bus = new QiyeBus();
            List<QyOrderUpdateGoodsEntity> list = new List<QyOrderUpdateGoodsEntity>();
            if (OrderType.Equals("0"))
            {
                //商城订单
                list = bus.queryOrderUpdateGoodsByOID(Convert.ToInt64(OID));
            }
            else
            {
                //电脑订单
                list = bus.queryOrderUpdateGoodsByOIDComputer(Convert.ToInt64(OID));
            }
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询统计
        /// </summary>
        public void QueryStatisOrderType()
        {
            QyOrderUpdatePriceEntity queryEntity = new QyOrderUpdatePriceEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }

            if (!string.IsNullOrEmpty(Request["AID"]))
            {
                queryEntity.HouseID = Convert.ToInt32(Request["AID"]);
            }
            CargoOrderBus bus = new CargoOrderBus();
            List<QyOrderUpdatePriceEntity> list = bus.QueryUpdatePriceStatis(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询统计
        /// </summary>
        public void QueryStatisSaleMan()
        {
            QyOrderUpdatePriceEntity queryEntity = new QyOrderUpdatePriceEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }

            if (!string.IsNullOrEmpty(Request["AID"]))
            {
                queryEntity.HouseID = Convert.ToInt32(Request["AID"]);
            }
            CargoOrderBus bus = new CargoOrderBus();
            List<QyOrderUpdatePriceEntity> list = bus.QueryUpdatePriceStatisSaleMan(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 优惠券使用方法集合
        /// <summary>
        /// 查询我客户编码下面的所有优惠券
        /// </summary>
        public void QueryMyCoupon()
        {
            WXCouponEntity queryEntity = new WXCouponEntity();
            if (!string.IsNullOrEmpty(Request["ClientNum"]))
            {
                queryEntity.ClientNum = Convert.ToInt32(Request["ClientNum"]);
            }
            if (!string.IsNullOrEmpty(Request["ClientID"]))
            {
                queryEntity.ClientID = Convert.ToInt64(Request["ClientID"]);
            }
            queryEntity.UseStatus = "0";
            CargoWeiXinBus bus = new CargoWeiXinBus();
            List<WXCouponEntity> result = bus.QueryCouponData(queryEntity);
            //JSON
            String json = JSON.Encode(result);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 优惠规则操作方法集合
        /// <summary>
        /// 查询优惠规则
        /// </summary>
        public void QueryRuleBank()
        {
            CargoRuleBankEntity queryEntity = new CargoRuleBankEntity();
            queryEntity.HouseID = UserInfor.HouseID;
            queryEntity.TypeID = Convert.ToInt32(Request["TypeID"]);
            queryEntity.Specs = Convert.ToString(Request["Specs"]);
            queryEntity.Figure = Convert.ToString(Request["Figure"]);
            string Batck = Convert.ToString(Request[""]);
            queryEntity.DelFlag = "0";
            CargoPriceBus bus = new CargoPriceBus();
            List<CargoRuleBankEntity> result = bus.QueryRuleBank(queryEntity);
            //JSON
            String json = JSON.Encode(result);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 工厂订单导入
        public void QueryData()
        {
            CargoFactoryOrderEntity queryEntity = new CargoFactoryOrderEntity();

            if (!string.IsNullOrEmpty(Request["HouseID"]))
            {
                queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);
            }
            else
            {
                queryEntity.HouseID = -1;
            }
            if (!string.IsNullOrEmpty(Request["OrderType"]))
            {
                queryEntity.OrderType = Convert.ToInt32(Request["OrderType"]);
            }
            else
            {
                queryEntity.OrderType = -1;
            }
            queryEntity.Model = Convert.ToString(Request["Model"]).Trim();
            queryEntity.Figure = Convert.ToString(Request["Figure"]).Trim();
            //queryEntity.ReceiveCity = Convert.ToString(Request["ReceiveCity"]).Trim();
            queryEntity.ReceiveName = Convert.ToString(Request["ReceiveName"]).Trim();
            queryEntity.OP_Name = Convert.ToString(Request["OP_Name"]).Trim();
            queryEntity.ProductName = Convert.ToString(Request["ProductName"]).Trim();
            if (!string.IsNullOrEmpty(Request["InCargoStatus"]))
            {
                queryEntity.InCargoStatus = Convert.ToInt32(Request["InCargoStatus"]);
            }
            else
            {
                queryEntity.InCargoStatus = -1;
            }
            if (!string.IsNullOrEmpty(Request["TypeID"]))
            {
                queryEntity.TypeID = Convert.ToInt32(Request["TypeID"]);
            }
            else
            {
                queryEntity.TypeID = -1;
            }
            queryEntity.FacOrderNo = Request["FacOrderNo"];
            if (!string.IsNullOrEmpty(queryEntity.FacOrderNo))
            {
                queryEntity.FacOrderNo = Regex.Replace(queryEntity.FacOrderNo, @"\s+", "");
                queryEntity.FacOrderNo = queryEntity.FacOrderNo.Replace('，', ',');
                var strList = queryEntity.FacOrderNo.Split(',').Where(a=>!string.IsNullOrEmpty(a)).ToList();
                queryEntity.FacOrderNo = $@"'{string.Join("','", strList)}'";
            }
            string spe = Convert.ToString(Request["Specs"]).ToUpper();
            if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
            {
                queryEntity.Specs = spe;
            }
            else
            {
                if (spe.Length <= 3)
                {
                    queryEntity.Specs = spe;
                }
                if (spe.Length > 3 && spe.Length <= 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                }
                if (spe.Length > 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                }
            }
            //queryEntity.Specs = Request["Specs"].Trim();
            queryEntity.GoodsCode = Request["GoodsCode"].Trim();
            //queryEntity.SpeedLevel = Request["SpeedLevel"].Trim();
            //queryEntity.ReceiveMobile = Request["ReceiveMobile"].Trim();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"])))
            {
                queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"])))
            {
                queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]);
            }

            if (!string.IsNullOrEmpty(Convert.ToString(Request["ETAStartDate"])))
            {
                queryEntity.ETAStartDate = Convert.ToDateTime(Request["ETAStartDate"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ETAEndDate"])))
            {
                queryEntity.ETAEndDate = Convert.ToDateTime(Request["ETAEndDate"]);
            }

            if (!string.IsNullOrEmpty(Convert.ToString(Request["Source"])))
            {
                queryEntity.Source = Convert.ToInt32(Request["Source"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]).Equals(0) ? 1 : Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]).Equals(0) ? 1000 : Convert.ToInt32(Request["rows"]);
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            Hashtable list = bus.QueryData(pageIndex, pageSize, queryEntity);
            var rows = list["rows"];

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        public void QueryShopOrderImport()
        {
            string err = "OK";
            CargoFactoryOrderEntity queryEntity = new CargoFactoryOrderEntity();

            if (!string.IsNullOrEmpty(Request["HouseID"]))
            {
                queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);
            }
            else
            {
                queryEntity.HouseID = -1;
            }
            if (!string.IsNullOrEmpty(Request["OrderType"]))
            {
                queryEntity.OrderType = Convert.ToInt32(Request["OrderType"]);
            }
            else
            {
                queryEntity.OrderType = -1;
            }
            queryEntity.Model = Request["Model"].Trim();
            queryEntity.Figure = Request["Figure"].Trim();
            queryEntity.ProductName = Request["ProductName"].Trim();
            if (!string.IsNullOrEmpty(Request["InCargoStatus"]))
            {
                queryEntity.InCargoStatus = Convert.ToInt32(Request["InCargoStatus"]);
            }
            else
            {
                queryEntity.InCargoStatus = -1;
            }
            if (!string.IsNullOrEmpty(Request["TypeID"]))
            {
                queryEntity.TypeID = Convert.ToInt32(Request["TypeID"]);
            }
            else
            {
                queryEntity.TypeID = -1;
            }
            queryEntity.FacOrderNo = Request["FacOrderNo"];
            if (!string.IsNullOrEmpty(queryEntity.FacOrderNo))
            {
                queryEntity.FacOrderNo = Regex.Replace(queryEntity.FacOrderNo, @"\s+", "");
                queryEntity.FacOrderNo = queryEntity.FacOrderNo.Replace('，', ',');
                var strList = queryEntity.FacOrderNo.Split(',').Where(a => !string.IsNullOrEmpty(a)).ToList();
                queryEntity.FacOrderNo = $@"'{string.Join("','", strList)}'";
            }
            string spe = Convert.ToString(Request["Specs"]).ToUpper();
            if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
            {
                queryEntity.Specs = spe;
            }
            else
            {
                if (spe.Length <= 3)
                {
                    queryEntity.Specs = spe;
                }
                if (spe.Length > 3 && spe.Length <= 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                }
                if (spe.Length > 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                }
            }
            queryEntity.GoodsCode = Request["GoodsCode"].Trim();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"])))
            {
                queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"])))
            {
                queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]).Equals(0) ? 1 : Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]).Equals(0) ? 1000 : Convert.ToInt32(Request["rows"]);
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            Hashtable list = bus.QueryData(1, 50000, queryEntity);
            if (list != null) { QueryShopOrderDataList = list; } else { err = "无数据导出"; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);

        }
        public Hashtable QueryShopOrderDataList
        {
            get
            {
                if (Session["QueryShopOrderDataList"] == null)
                {
                    Session["QueryShopOrderDataList"] = new Hashtable();
                }
                return (Hashtable)(Session["QueryShopOrderDataList"]);
            }
            set
            {
                Session["QueryShopOrderDataList"] = value;
            }
        }
        /// <summary>
        /// 获取所有品牌
        /// </summary>
        public void QueryALLBrandType()
        {
            CargoProductBasicPriceBus bus = new CargoProductBasicPriceBus();

            List<CargoProductTypeEntity> list = new List<CargoProductTypeEntity>();

            list = bus.QueryAllBrand();

            string type = Request.QueryString["type"];

            if (type == null)
            {
                list.Insert(0, new CargoProductTypeEntity
                {
                    TypeID = -1,
                    TypeName = "全部"
                });
            }

            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 获取所有仓库
        /// </summary>
        public void QueryALLHouse()
        {
            CargoProductBasicPriceBus bus = new CargoProductBasicPriceBus();

            List<CargoProductBasicPriceEntity> list = new List<CargoProductBasicPriceEntity>();

            //list = bus.QueryAllHouse();
            foreach (var item in UserInfor.CargoList)
            {
                list.Add(new CargoProductBasicPriceEntity { HouseID = item.ID, HouseName = item.Name });
            }

            string type = Request.QueryString["type"];

            if (type == null)
            {
                list.Insert(0, new CargoProductBasicPriceEntity
                {
                    HouseID = -1,
                    HouseName = "全部"
                });
            }

            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public class Scource
        {
            public int id;
            public string text;
        }
        /// <summary>
        /// 来货导入Excel文件
        /// </summary>
        public void saveFile()
        {
            System.Web.HttpFileCollection files = this.Request.Files;
            if (files == null || files.Count == 0) return;
            string attachmentId = Guid.NewGuid().ToString();
            DataTable data = ToExcel.ImportExcelData(files);

            CargoImportEntity import = new CargoImportEntity();
            import.Result = true;
            import.Data = "";
            import.Message = "";
            import.Type = 0;
            import.ExistCount = 0;
            string msg = "";

            List<CargoFactoryOrderEntity> ent = new List<CargoFactoryOrderEntity>();
            CargoProductBasicPriceBus bus = new CargoProductBasicPriceBus();
            CargoFactoryOrderBus FacBus = new CargoFactoryOrderBus();

            //验证上传excel文件列数是否有效
            //if (data.Columns.Count != 31 && data.Columns.Count != 8 && data.Columns.Count != 7)
            if (data.Columns.Count != 30 && data.Columns.Count != 9 && data.Columns.Count != 7)
            {
                import.Result = false;
                import.Type = 1;
                import.Message = "模板有误或缺少列，请重新下载模板";
                String abnormalJson = JSON.Encode(import);
                Response.Clear();
                Response.Write(abnormalJson);
                Response.End();
                return;
            }
            //清空table中的空行
            removeEmpty(data);


            if (data.Rows.Count <= 0)
            {
                import.Result = false;
                import.Type = 1;
                import.Message = "Excel无有效数据，请检查导入数据";
                String abnormalJson = JSON.Encode(import);
                Response.Clear();
                Response.Write(abnormalJson);
                Response.End();
                return;
            }

            //获取所有供应商信息用于表格显示供应商
            CargoClientBus client = new CargoClientBus();
            CargoClientEntity SupplierData = new CargoClientEntity();
            List<CargoClientEntity> allSupplier = client.QueryCargoClientList(new CargoClientEntity() { ClientType = "4" });
            if (allSupplier.Count() == 0)
            {
                import.Result = false;
                import.Message = "无供应商信息，不可导入";

                Response.Clear();
                Response.Write(JSON.Encode(import));
                Response.End();
                return;
            }

            //模板是6列的是太石仓库的导入模板
            if (data.Columns.Count.Equals(2))
            {

                CargoProductBus productBus = new CargoProductBus();
                CargoHouseBus house = new CargoHouseBus();
                Dictionary<string, int> dicScource = new Dictionary<string, int>();
                List<CargoProductSourceEntity> allProductSourcelist = new List<CargoProductSourceEntity>();
                allProductSourcelist = productBus.QueryAllProductSource();
                foreach (var item in allProductSourcelist)
                {
                    if (!dicScource.ContainsKey(item.SourceName))
                    {
                        dicScource.Add(item.SourceName, item.Source);
                    }
                }

                //获取所有可用品牌用于表格显示品牌
                List<CargoProductTypeEntity> allSpesc = new List<CargoProductTypeEntity>();
                allSpesc = bus.QueryAllBrand(new CargoProductTypeEntity { ParentID = 354 });
                Dictionary<string, int> dic = new Dictionary<string, int>();
                foreach (var item in allSpesc)
                {
                    if (!dic.ContainsKey(item.TypeName))
                    {
                        dic.Add(item.TypeName, item.TypeID);
                    }
                }
                int abnormalCount = 0;

                DataTable newData = new DataTable();
                newData.Columns.Add("HouseID");
                newData.Columns.Add("HouseName");
                newData.Columns.Add("FacOrderNo");
                newData.Columns.Add("Source");
                newData.Columns.Add("SourceName");
                newData.Columns.Add("GoodsCode");
                newData.Columns.Add("Specs");
                newData.Columns.Add("OrderNum");
                newData.Columns.Add("TypeID");
                newData.Columns.Add("TypeName");
                newData.Columns.Add("BelongMonth");
                newData.Columns.Add("Batch");
                newData.Columns.Add("ReplyNumber");
                newData.Columns.Add("Model");
                newData.Columns.Add("ProductName");

                string CargoDepart = string.Empty;
                for (int i = 0; i < data.Rows.Count; i++)
                {
                    //验证Excel表格指定列是否缺少数据
                    bool isContinue = false;
                    for (int j = 0; j < data.Columns.Count; j++)
                    {
                        if (string.IsNullOrEmpty((data.Rows[i][j]).ToString()))
                        {
                            isContinue = true;
                            break;
                        }
                    }
                    if (isContinue)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据有空值\r\n";
                        continue;
                    }
                    //验证导入产品来源是否在数据中有效，无效则跳过
                    int Source = 0;
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][2]).Trim()))
                    {
                        if (!dicScource.ContainsKey(Convert.ToString(data.Rows[i][2]).Trim()))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据产品来源不存在\r\n";
                            continue;
                        }
                        else
                        {
                            dicScource.TryGetValue(Convert.ToString(data.Rows[i][2]).Trim(), out Source);
                        }
                    }
                    //验证导入品牌是否在数据库中有效，无效则跳过
                    int typeID = 0;
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][3]).Trim()))
                    {
                        if (!dic.ContainsKey(Convert.ToString(data.Rows[i][3]).Trim()))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据产品分类不存在\r\n";
                            continue;
                        }
                        else
                        {
                            dic.TryGetValue(Convert.ToString(data.Rows[i][3]).Trim(), out typeID);
                        }
                    }
                    //验证原始订单数量是否为数字
                    if (!IsNumber(data.Rows[i][7].ToString()))
                    {
                        if (!IsNumber(data.Rows[i][7].ToString().Trim().Replace("_", "")))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据订单数量有误\r\n";
                            continue;
                        }
                        data.Rows[i][7] = data.Rows[i][7].ToString().Trim().Replace("_", "");
                    }
                    string FacOrderNo = Convert.ToString(data.Rows[i][1]).Trim();
                    string GoodsCode = Convert.ToString(data.Rows[i][4]).Trim().Replace("-", "").Replace("_", "");//品番
                    string Specs = Convert.ToString(data.Rows[i][5]).Trim().Replace("-", "").Replace("_", "");//背番
                    string Batch = Convert.ToString(data.Rows[i][6]).Trim();//周期批次
                    int TypeID = typeID;//产品ID
                    string TypeName = Convert.ToString(data.Rows[i][3]);//"广丰近地零件";产品分类名称
                    string BelongMonth = DateTime.Now.ToString("yyyyMM");
                    string BusinessName = Convert.ToString(data.Rows[i][30]).Trim();
                    string SQL = "HouseID =62 and FacOrderNo = '" + FacOrderNo + "' and GoodsCode='" + GoodsCode + "' and Specs='" + Specs + "' and typeID=" + typeID;
                    if (!string.IsNullOrEmpty(Batch))
                    {
                        SQL += " and Batch='" + Batch + "'";
                    }
                    DataRow[] NewRows = newData.Select(SQL);
                    DataRow drNew = newData.NewRow();
                    if (NewRows.Count() <= 0)
                    {
                        object[] objs = { 62, Convert.ToString(data.Rows[i][0]).Trim(), Convert.ToString(data.Rows[i][1]).Trim(), Source, Convert.ToString(data.Rows[i][2]).Trim(), Convert.ToString(data.Rows[i][4]).Trim().Replace("-", "").Replace("_", ""), Convert.ToString(data.Rows[i][5]).Trim().Replace("-", "").Replace("_", ""), Convert.ToString(data.Rows[i][7]).Trim(), TypeID, TypeName, BelongMonth, Convert.ToString(data.Rows[i][6]).Trim() };
                        drNew.ItemArray = objs;
                        newData.Rows.Add(drNew);
                    }
                    else
                    {
                        for (int j = 0; j < NewRows.Length; j++)
                        {
                            DataRow drEmployee = NewRows[j];
                            drEmployee.BeginEdit();
                            drEmployee["OrderNum"] = Convert.ToInt32(NewRows[0][7]) + Convert.ToInt32(data.Rows[i][7]);
                            drEmployee.EndEdit();
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据出现重复已自动合并\r\n";
                        }
                    }
                }
                if (newData.Rows.Count > 0)
                {
                    for (int i = 0; i < newData.Rows.Count; i++)
                    {
                        ent.Add(new CargoFactoryOrderEntity
                        {
                            HouseID = Convert.ToInt32(newData.Rows[i][0]),
                            HouseName = Convert.ToString(newData.Rows[i][1]).Trim(),
                            FacOrderNo = Convert.ToString(newData.Rows[i][2]).Trim(),
                            Source = Convert.ToInt32(newData.Rows[i][3]),
                            SourceName = Convert.ToString(newData.Rows[i][4]).Trim(),
                            GoodsCode = Convert.ToString(newData.Rows[i][5]).Trim().Replace("-", "").Replace("_", ""),
                            Specs = Convert.ToString(newData.Rows[i][6]).Trim().Replace("-", "").Replace("_", ""),
                            OrderNum = Convert.ToInt32(newData.Rows[i][7]),
                            TypeID = Convert.ToInt32(newData.Rows[i][8]),
                            TypeName = Convert.ToString(newData.Rows[i][9]).Trim(),
                            BelongMonth = Convert.ToString(newData.Rows[i][10]),
                            ReplyNumber = Convert.ToInt32(newData.Rows[i][7]),
                            Model = Convert.ToString(newData.Rows[i][5]).Trim(),
                            BusinessName = Convert.ToString(newData.Rows[i][30]).Trim(),
                            Batch = string.IsNullOrEmpty(Convert.ToString(newData.Rows[i][11])) ? DateTime.Now.ToString("yyyyMMdd") : Convert.ToString(newData.Rows[i][11]),
                            ProductName = "好来运太石仓业务部"
                        });

                    }
                }
                //ent = ent.OrderBy(e => e.Specs).ToList();
                String json = JSON.Encode(ent);

                if (abnormalCount > 0)
                {
                    import.Type = 1;
                    import.Message = msg;
                }
                import.Result = true;
                import.Data = json;
                json = JSON.Encode(import);
                Response.Clear();
                Response.Write(json);
                Response.End();
            }
            else if (data.Columns.Count.Equals(9))
            {
                //获取所有可用品牌用于表格显示品牌
                List<CargoProductTypeEntity> allSpesc = new List<CargoProductTypeEntity>();
                allSpesc = bus.QueryAllBrand();
                Dictionary<int, string> dic = new Dictionary<int, string>();
                foreach (var item in allSpesc)
                {
                    if (!dic.ContainsKey(item.TypeID))
                    {
                        dic.Add(item.TypeID, item.TypeName);
                    }
                }

                //获取所有仓库用于表格显示仓库
                List<CargoProductBasicPriceEntity> allHouse = new List<CargoProductBasicPriceEntity>();
                Dictionary<string, int> dicHouse = new Dictionary<string, int>();
                foreach (var item in UserInfor.CargoList)
                {
                    if (!dicHouse.ContainsKey(item.Name))
                    {
                        dicHouse.Add(item.Name, item.ID);
                    }
                }
                CargoProductBus productBus = new CargoProductBus();
                List<CargoProductSourceEntity> allProductSourcelist = new List<CargoProductSourceEntity>();
                allProductSourcelist = productBus.QueryAllProductSource();
                Dictionary<string, int> dicScource = new Dictionary<string, int>();
                foreach (var item in allProductSourcelist)
                {
                    if (!dicScource.ContainsKey(item.SourceName))
                    {
                        dicScource.Add(item.SourceName, item.Source);
                    }
                }
                DataTable ProductBasicDt = new DataTable();
                ProductBasicDt = bus.QueryProductSpecDate(new CargoProductEntity { });

                DataTable newData = new DataTable();
                newData.Columns.Add("HouseID");
                newData.Columns.Add("HouseName");
                newData.Columns.Add("FacOrderNo");
                newData.Columns.Add("Source");
                newData.Columns.Add("SourceName");
                newData.Columns.Add("ProductName");
                newData.Columns.Add("TypeID");
                newData.Columns.Add("TypeName");
                newData.Columns.Add("OrderType");
                newData.Columns.Add("BelongMonth");
                newData.Columns.Add("Born");
                newData.Columns.Add("Model");
                newData.Columns.Add("Specs");
                newData.Columns.Add("LoadIndex");
                newData.Columns.Add("SpeedLevel");
                newData.Columns.Add("Figure");
                newData.Columns.Add("GoodsCode");
                newData.Columns.Add("Batch");
                newData.Columns.Add("OrderNum");
                newData.Columns.Add("SuppClientNum");
                newData.Columns.Add("Supplier");
                newData.Columns.Add("SupplierAddress");
                int abnormalCount = 0;
                for (int i = 0; i < data.Rows.Count; i++)
                {
                    //验证Excel表格指定列是否缺少数据
                    bool isContinue = false;
                    for (int j = 0; j < data.Columns.Count; j++)
                    {
                        if (string.IsNullOrEmpty((data.Rows[i][j]).ToString()))
                        {
                            isContinue = true;
                            break;
                        }
                    }
                    if (isContinue)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据有空值\r\n";
                        continue;
                    }
                    //验证导入仓库是否在数据库中有效，无效则跳过
                    int houseID = 0;
                    int HouseID = 0;
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][0]).Trim()))
                    {
                        if (!dicHouse.ContainsKey(Convert.ToString(data.Rows[i][0]).Trim()))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行所属仓库不存在\r\n";
                            continue;
                        }
                        else
                        {
                            dicHouse.TryGetValue(Convert.ToString(data.Rows[i][0]).Trim(), out houseID);
                            if (HouseID != 0)
                            {
                                if (houseID != HouseID)
                                {
                                    abnormalCount++;
                                    msg += "一次只能导入同一仓库的订单\r\n";
                                    continue;
                                }
                            }
                            else
                            {
                                HouseID = houseID;
                            }
                        }
                    }
                    //验证导入产品来源是否在数据中有效，无效则跳过
                    int Source = 0;
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][2]).Trim()))
                    {
                        if (!dicScource.ContainsKey(Convert.ToString(data.Rows[i][2]).Trim()))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据产品来源不存在\r\n";
                            continue;
                        }
                        else
                        {
                            dicScource.TryGetValue(Convert.ToString(data.Rows[i][2]).Trim(), out Source);
                        }
                    }
                    //验证批次是否合法
                    if (!IsNumber(data.Rows[i][5].ToString()))
                    {
                        if (!IsNumber(data.Rows[i][5].ToString().Trim().Replace("_", "")))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据批次有误\r\n";
                            continue;
                        }
                        data.Rows[i][5] = data.Rows[i][5].ToString().Trim().Replace("_", "");
                    }
                    else if (data.Rows[i][5].ToString().Length > 4)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据批次长度有误\r\n";
                        continue;

                    }
                    //验证原始订单数量是否为数字
                    if (!IsNumber(data.Rows[i][6].ToString()))
                    {
                        if (!IsNumber(data.Rows[i][6].ToString().Trim()))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据订单数量有误\r\n";
                            continue;
                        }
                        data.Rows[i][6] = data.Rows[i][6].ToString().Trim();
                    }

                    string GoodsCode = Convert.ToString(data.Rows[i][4]).Trim();
                    string Specs = string.Empty;
                    string Figure = string.Empty;
                    string LoadIndex = string.Empty;
                    string SpeedLevel = string.Empty;
                    string ProductName = string.Empty;
                    string TypeID = string.Empty;
                    string TypeName = string.Empty;
                    string Born = string.Empty;
                    string Model = string.Empty;
                    DataRow[] rows = ProductBasicDt.Select("GoodsCode='" + GoodsCode + "'");
                    if (rows.Count() <= 0)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据基础规格不存在\r\n";
                        continue;
                    }
                    else
                    {
                        DataRow row = rows[0];
                        ProductName = Convert.ToString(data.Rows[i][7]).Trim();
                        //ProductName = string.IsNullOrEmpty(Convert.ToString(row[16]).Trim()) ? Convert.ToString(data.Rows[i][7]).Trim() : Convert.ToString(row[16]).Trim();
                        TypeID = Convert.ToString(row[1]).Trim();
                        if (dic.ContainsKey(Convert.ToInt32(TypeID)))
                        {
                            TypeName = dic[Convert.ToInt32(TypeID)].Trim();
                        }
                        Specs = Convert.ToString(row[4]).Trim();
                        Figure = Convert.ToString(row[5]).Trim();
                        LoadIndex = Convert.ToString(row[9]).Trim();
                        SpeedLevel = Convert.ToString(row[10]).Trim().Length > 1 ? Convert.ToString(row[10]).Trim().Substring(0, 1) : Convert.ToString(row[10]).Trim();
                        Born = Convert.ToString(row[11]).Trim();
                        Model = Convert.ToString(row[4]).Trim();

                    }
                    int OrderType = 0;
                    switch (Convert.ToString(data.Rows[i][3]))
                    {
                        case "内部订单":
                            OrderType = 0;
                            break;
                        case "外部订单":
                            OrderType = 1;
                            break;
                        case "退货订单":
                            OrderType = 2;
                            break;
                        case "外采订单":
                            OrderType = 3;
                            break;
                    }
                    //供应商信息
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][8]).Trim()))
                    {
                        SupplierData = allSupplier.Where(w => w.ClientNum == Convert.ToInt32(data.Rows[i][8])).FirstOrDefault();
                        if (SupplierData == null)
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行供应商编号填写有误\r\n";
                            continue;
                        }
                    }
                    else
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行未填写供应商编号\r\n";
                        continue;
                    }
                    string SuppClientNum = SupplierData.ClientNum.ToString();
                    string Supplier = SupplierData.ClientName;
                    string SupplierAddress = SupplierData.Address;


                    DataRow[] NewRows = newData.Select("GoodsCode='" + GoodsCode + "' and FacOrderNo='" + Convert.ToString(data.Rows[i][1]).Trim() + "' and Source='" + Source + "'");
                    DataRow drNew = newData.NewRow();
                    if (NewRows.Count() <= 0)
                    {
                        object[] objs = {
                            houseID,
                            Convert.ToString(data.Rows[i][0]).Trim(),
                            Convert.ToString(data.Rows[i][1]).Trim(),
                            Source,
                            Convert.ToString(data.Rows[i][2]).Trim(),
                            ProductName,
                            TypeID,
                            TypeName,
                            OrderType,
                            DateTime.Now.ToString("yyyyMM"),
                            Born,
                            Model,
                            Specs,
                            LoadIndex,
                            SpeedLevel,
                            Figure,
                            GoodsCode,
                            Convert.ToString(data.Rows[i][5]).Trim(),
                            Convert.ToInt32(data.Rows[i][6]),
                            SuppClientNum,
                            Supplier,
                            SupplierAddress
                        };
                        drNew.ItemArray = objs;
                        newData.Rows.Add(drNew);
                    }
                    else
                    {
                        for (int j = 0; j < NewRows.Length; j++)
                        {
                            DataRow drEmployee = NewRows[j];
                            drEmployee.BeginEdit();
                            drEmployee["OrderNum"] = Convert.ToInt32(NewRows[0][6]) + Convert.ToInt32(data.Rows[i][6]);
                            drEmployee.EndEdit();
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据出现重复已自动合并\r\n";
                        }
                    }
                }
                if (newData.Rows.Count > 0)
                {
                    for (int i = 0; i < newData.Rows.Count; i++)
                    {
                        ent.Add(new CargoFactoryOrderEntity
                        {
                            HouseID = Convert.ToInt32(newData.Rows[i][0]),
                            HouseName = Convert.ToString(newData.Rows[i][1]).Trim(),
                            FacOrderNo = Convert.ToString(newData.Rows[i][2]).Trim(),
                            Source = Convert.ToInt32(newData.Rows[i][3]),
                            SourceName = Convert.ToString(newData.Rows[i][4]).Trim(),
                            ProductName = Convert.ToString(newData.Rows[i][5]).Trim(),
                            TypeID = Convert.ToInt32(newData.Rows[i][6]),
                            TypeName = Convert.ToString(newData.Rows[i][7]).Trim(),
                            OrderType = Convert.ToInt32(newData.Rows[i][8]),
                            BelongMonth = Convert.ToString(newData.Rows[i][9]).Trim(),
                            Born = Convert.ToString(newData.Rows[i][10]),
                            Model = Convert.ToString(newData.Rows[i][11]).Trim(),
                            Specs = Convert.ToString(newData.Rows[i][12]).Trim(),
                            LoadIndex = Convert.ToString(newData.Rows[i][13]).Trim(),
                            SpeedLevel = Convert.ToString(newData.Rows[i][14]).Trim().Length > 1 ? Convert.ToString(newData.Rows[i][14]).Trim().Substring(0, 1) : Convert.ToString(newData.Rows[i][14]).Trim(),
                            Figure = Convert.ToString(newData.Rows[i][15]).Trim(),
                            GoodsCode = Convert.ToString(newData.Rows[i][16]).Trim(),
                            Batch = Convert.ToString(newData.Rows[i][17]).Trim(),
                            OrderNum = Convert.ToInt32(newData.Rows[i][18]),
                            ReplyNumber = Convert.ToInt32(newData.Rows[i][18]),
                            BelongDepart = "OE渠道销售部",
                            Assort = "OER",
                            //SuppClientNum = "551098",
                            //Supplier = "狄乐汽服OE",
                            ReceiveName = UserInfor.HouseName,
                            ReceiveCity = UserInfor.UserName,
                            SuppClientNum = Convert.ToString(newData.Rows[i][19]).Trim(),
                            Supplier = Convert.ToString(newData.Rows[i][20]).Trim(),
                            SupplierAddress = Convert.ToString(newData.Rows[i][21]).Trim(),
                        });
                    }
                }
                String json = JSON.Encode(ent);

                if (abnormalCount > 0)
                {
                    import.Type = 1;
                    import.Message = msg;
                }
                import.Result = true;
                import.Data = json;
                json = JSON.Encode(import);
                Response.Clear();
                Response.Write(json);
                Response.End();
            }
            else
            {
                //获取所有可用品牌用于表格显示品牌
                List<CargoProductTypeEntity> allSpesc = new List<CargoProductTypeEntity>();
                allSpesc = bus.QueryAllBrand();
                Dictionary<string, int> dic = new Dictionary<string, int>();
                foreach (var item in allSpesc)
                {
                    if (!dic.ContainsKey(item.TypeName))
                    {
                        dic.Add(item.TypeName, item.TypeID);
                    }
                }

                //获取所有仓库用于表格显示仓库
                List<CargoProductBasicPriceEntity> allHouse = new List<CargoProductBasicPriceEntity>();
                Dictionary<string, int> dicHouse = new Dictionary<string, int>();
                foreach (var item in UserInfor.CargoList)
                {
                    if (!dicHouse.ContainsKey(item.Name))
                    {
                        dicHouse.Add(item.Name, item.ID);
                    }
                }

                //ent.Supplier = clientData.ClientName;
                //ent.SuppClientNum = clientData.ClientNum.ToString();
                //ent.SupplierAddress = clientData.Address;
                //获取json文件中的来源数据
                //Dictionary<string, int> dicScource = new Dictionary<string, int>();
                //var fileName = Server.MapPath("../Data/ProductSource.json");
                //using (StreamReader r = new StreamReader(fileName))
                //{
                //    string scourceJson = r.ReadToEnd();
                //    List<Scource> items = JsonConvert.DeserializeObject<List<Scource>>(scourceJson);
                //    foreach (var item in items)
                //    {
                //        if (!dicScource.ContainsKey(item.text))
                //        {
                //            dicScource.Add(item.text, item.id);
                //        }
                //    }
                //}
                CargoProductBus productBus = new CargoProductBus();
                CargoHouseBus house = new CargoHouseBus();
                Dictionary<string, int> dicScource = new Dictionary<string, int>();
                List<CargoProductSourceEntity> allProductSourcelist = new List<CargoProductSourceEntity>();
                allProductSourcelist = productBus.QueryAllProductSource();
                foreach (var item in allProductSourcelist)
                {
                    if (!dicScource.ContainsKey(item.SourceName))
                    {
                        dicScource.Add(item.SourceName, item.Source);
                    }
                }

                List<int> HouseIDList = new List<int>();
                int HouseID = 0;
                string HouseIDs = string.Empty;
                List<int> UpClientHouseIDs = new List<int>();
                List<int> BelongMonthList = new List<int>();
                for (int i = 0; i < data.Rows.Count; i++)
                {

                    var type = Convert.ToString(data.Rows[i][4]).Trim();
                    int houseID = 0;

                    if (type == "优科豪马")
                    {
                        //获取导入数据中所有仓库
                        if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][0]).Trim()))
                        {
                            if (dicHouse.ContainsKey(Convert.ToString(data.Rows[i][0]).Trim()))
                            {
                                dicHouse.TryGetValue(Convert.ToString(data.Rows[i][0]).Trim(), out houseID);
                                if (!HouseIDList.Contains(houseID))
                                {
                                    HouseIDList.Add(houseID);
                                }
                            }
                        }
                        //获取导入数据中所有订单归属月
                        if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][6]).Trim()))
                        {
                            if (!IsNumber(data.Rows[i][6].ToString()))
                            {
                                msg += "第" + (i + 2) + "行订单归属月有误\r\n";

                                import.Result = false;
                                import.Message = msg;

                                Response.Clear();
                                Response.Write(JSON.Encode(import));
                                Response.End();
                                return;
                            }
                            int BelongMonth = Convert.ToInt32(Convert.ToString(data.Rows[i][6]).Trim());
                            if (!BelongMonthList.Contains(BelongMonth))
                            {
                                BelongMonthList.Add(BelongMonth);
                            }
                        }
                    }
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][6]).Trim()))
                    {
                        //订单归属于必须为数字，且长度等于6，后两位小于12
                        if (!IsNumber(data.Rows[i][6].ToString()) || data.Rows[i][6].ToString().Length != 6 || Convert.ToInt32(data.Rows[i][6].ToString().Substring(4, 2)) > 12 || Convert.ToInt32(data.Rows[i][6].ToString().Substring(4, 2)) < 1)
                        {
                            msg += "第" + (i + 2) + "行订单归属月有误\r\n";

                            import.Result = false;
                            import.Message = msg;

                            Response.Clear();
                            Response.Write(JSON.Encode(import));
                            Response.End();
                            return;
                        }
                    }
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][0]).Trim()))
                    {
                        if (dicHouse.ContainsKey(Convert.ToString(data.Rows[i][0]).Trim()))
                        {
                            dicHouse.TryGetValue(Convert.ToString(data.Rows[i][0]).Trim(), out houseID);
                            if (!UpClientHouseIDs.Contains(houseID))
                            {
                                UpClientHouseIDs.Add(houseID);
                                HouseIDs += houseID + ",";
                            }
                        }
                    }

                    //if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][30]).Trim()))
                    //{
                    //根据用户信息查询业务信息

                    //var BusinessName = Convert.ToString(data.Rows[i][30]).Trim();

                    ////订单归属于必须为数字，且长度等于6，后两位小于12
                    //if (!IsNumber(data.Rows[i][6].ToString()) || data.Rows[i][6].ToString().Length != 6 || Convert.ToInt32(data.Rows[i][6].ToString().Substring(4, 2)) > 12 || Convert.ToInt32(data.Rows[i][6].ToString().Substring(4, 2)) < 1)
                    //{
                    //    msg += "第" + (i + 2) + "行订单归属月有误\r\n";

                    //    import.Result = false;
                    //    import.Message = msg;

                    //    Response.Clear();
                    //    Response.Write(JSON.Encode(import));
                    //    Response.End();
                    //    return;
                    //}
                    //}
                    //else
                    //{
                    //    msg += "第" + (i + 2) + "行未填写业务名称\r\n";

                    //    import.Result = false;
                    //    import.Message = msg;

                    //    Response.Clear();
                    //    Response.Write(JSON.Encode(import));
                    //    Response.End();
                    //    return;
                    //}
                }
                //CargoClientBus clientBus = new CargoClientBus();
                //Dictionary<string, int> dicUpClient = new Dictionary<string, int>();
                //List<CargoUpClientEntity> UpClientlist = new List<CargoUpClientEntity>();
                //UpClientlist = clientBus.QueryAllUpClientDep(new CargoUpClientEntity { HouseIDs = HouseIDs.Substring(0, HouseIDs.Length - 1) });
                //foreach (var item in UpClientlist)
                //{
                //    if (!dicUpClient.ContainsKey(item.DepName))
                //    {
                //        dicUpClient.Add(item.DepName, item.ID);
                //    }
                //}

                DataTable ProductBasicDt = new DataTable();
                //if (HouseIDList.Count > 0)
                //{
                ProductBasicDt = bus.QueryProductSpecDate(new CargoProductEntity { });
                //}

                int abnormalCount = 0;

                DataTable newData = new DataTable();
                newData.Columns.Add("HouseID");
                newData.Columns.Add("HouseName");
                newData.Columns.Add("FacOrderNo");
                newData.Columns.Add("Source");
                newData.Columns.Add("SourceName");
                newData.Columns.Add("ProductName");
                newData.Columns.Add("TypeID");
                newData.Columns.Add("TypeName");
                newData.Columns.Add("OrderType");
                newData.Columns.Add("BelongMonth");
                newData.Columns.Add("Born");

                newData.Columns.Add("Assort");
                newData.Columns.Add("Model");
                newData.Columns.Add("Specs");
                newData.Columns.Add("LoadIndex");
                newData.Columns.Add("SpeedLevel");
                newData.Columns.Add("Figure");
                newData.Columns.Add("GoodsCode");
                newData.Columns.Add("Batch");
                newData.Columns.Add("OrderNum");
                newData.Columns.Add("ReplyNumber");

                newData.Columns.Add("SalePrice");
                newData.Columns.Add("UnitPrice");
                newData.Columns.Add("InHousePrice");
                newData.Columns.Add("ProductCode");
                newData.Columns.Add("SupplierCode");
                newData.Columns.Add("WhetherTax");
                newData.Columns.Add("ReceiveName");
                newData.Columns.Add("ReceiveCity");
                newData.Columns.Add("ReceiveMobile");
                newData.Columns.Add("SourceHouse");

                newData.Columns.Add("BelongDepart");
                newData.Columns.Add("SpecsType");
                newData.Columns.Add("HouseCode");
                newData.Columns.Add("BusinessName");
                newData.Columns.Add("SuppClientNum");
                newData.Columns.Add("Supplier");
                newData.Columns.Add("SupplierAddress");
                string CargoDepart = string.Empty;
                for (int i = 0; i < data.Rows.Count; i++)
                {
                    //验证Excel表格指定列是否缺少数据
                    bool isContinue = false;
                    for (int j = 0; j < data.Columns.Count; j++)
                    {
                        if (string.IsNullOrEmpty((data.Rows[i][j]).ToString()))
                        {
                            //型号必填
                            if (j == 9)
                            {
                                isContinue = true;
                                break;
                            }
                            //除优科豪马外产地可不填
                            else if (j == 7)
                            {
                                var type = Convert.ToString(data.Rows[i][4]).Trim();
                                if (!string.IsNullOrEmpty(type))
                                {
                                    if (type == "优科豪马")
                                    {
                                        isContinue = true;
                                        break;
                                    }
                                }
                            }
                            //除优科豪马外OERE类型可不填
                            else if (j == 8)
                            {
                                var type = Convert.ToString(data.Rows[i][4]).Trim();
                                if (!string.IsNullOrEmpty(type))
                                {
                                    if (type == "优科豪马")
                                    {
                                        isContinue = true;
                                        break;
                                    }
                                }
                            }
                            else if (j == 26)
                            {
                                if (Convert.ToString(data.Rows[i][0]).Trim() == "广东仓库" || Convert.ToString(data.Rows[i][0]).Trim() == "广州仓库" || Convert.ToString(data.Rows[i][0]).Trim() == "揭阳仓库")
                                {
                                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][2]).Trim()) && Convert.ToString(data.Rows[i][2]).Trim() == "马牌轮胎厂家")
                                    {
                                        isContinue = true;
                                        break;
                                    }
                                }
                            }
                            else if (j == 24 || j == 3 || j == 25 || j == 20 || j == 22 || j == 27 || j == 28 || j == 29)
                            {

                            }
                            else
                            {
                                isContinue = true;
                                break;
                            }
                        }
                    }
                    if (isContinue)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据有空值\r\n";
                        continue;
                    }
                    if (FacBus.GetCargoType(new CargoFactoryOrderEntity { FacOrderNo = Convert.ToString(data.Rows[i][1]).Trim() }) > 0)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行销售订单号已存在\r\n";
                        continue;
                    }
                    //验证导入仓库是否在数据库中有效，无效则跳过
                    int houseID = 0;
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][0]).Trim()))
                    {
                        if (!dicHouse.ContainsKey(Convert.ToString(data.Rows[i][0]).Trim()))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行所属仓库不存在\r\n";
                            continue;
                        }
                        else
                        {
                            dicHouse.TryGetValue(Convert.ToString(data.Rows[i][0]).Trim(), out houseID);
                            if (HouseID != 0)
                            {
                                if (houseID != HouseID)
                                {
                                    abnormalCount++;
                                    msg += "一次只能导入同一仓库的订单\r\n";
                                    continue;
                                }
                            }
                            else
                            {
                                HouseID = houseID;
                            }
                        }
                    }

                    //验证导入产品来源是否在数据中有效，无效则跳过
                    int Source = 0;
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][2]).Trim()))
                    {
                        if (!dicScource.ContainsKey(Convert.ToString(data.Rows[i][2]).Trim()))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据产品来源不存在\r\n";
                            continue;
                        }
                        else
                        {
                            dicScource.TryGetValue(Convert.ToString(data.Rows[i][2]).Trim(), out Source);
                        }
                    }
                    //验证导入品牌是否在数据库中有效，无效则跳过
                    int typeID = 0;
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][4]).Trim()))
                    {
                        if (!dic.ContainsKey(Convert.ToString(data.Rows[i][4]).Trim()))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据品牌不存在\r\n";
                            continue;
                        }
                        else
                        {
                            dic.TryGetValue(Convert.ToString(data.Rows[i][4]).Trim(), out typeID);
                        }
                    }
                    //验证订单类型是否有效
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][5]).Trim()))
                    {
                        if (Convert.ToString(data.Rows[i][5]).Trim() != "内部订单" && Convert.ToString(data.Rows[i][5]).Trim() != "外部订单" && Convert.ToString(data.Rows[i][5]).Trim() != "退货订单" && Convert.ToString(data.Rows[i][5]).Trim() != "外采订单")
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据订单类型有误\r\n";
                            continue;
                        }
                    }
                    //验证订单归属月是否为数字
                    if (!IsNumber(data.Rows[i][6].ToString()))
                    {
                        if (!IsNumber(data.Rows[i][6].ToString().Trim().Replace("_", "")))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据订单归属月有误\r\n";
                            continue;
                        }
                        data.Rows[i][6] = data.Rows[i][6].ToString().Trim().Replace("_", "");
                    }
                    else if (data.Rows[i][6].ToString().Length > 6)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据订单归属月长度有误\r\n";
                        continue;
                    }
                    //验证产地是否有效
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][7]).Trim()))
                    {
                        if (Convert.ToString(data.Rows[i][7]).Trim() != "国产" && Convert.ToString(data.Rows[i][7]).Trim() != "进口")
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据产地有误\r\n";
                            continue;
                        }
                    }
                    CargoProductTypeEntity cpte = allSpesc.Find(c => c.TypeID.Equals(typeID));
                    if (cpte.ParentID.Equals(1))
                    {
                        //轮胎分类处理周期
                        //验证批次是否合法
                        if (!IsNumber(data.Rows[i][15].ToString()))
                        {
                            if (!IsNumber(data.Rows[i][15].ToString().Trim().Replace("_", "")))
                            {
                                abnormalCount++;
                                msg += "第" + (i + 2) + "行数据批次有误\r\n";
                                continue;
                            }
                            data.Rows[i][15] = data.Rows[i][15].ToString().Trim().Replace("_", "");
                        }
                        else if (data.Rows[i][15].ToString().Length > 4)
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据批次长度有误\r\n";
                            continue;

                        }
                    }

                    //验证原始订单数量是否为数字
                    if (!IsNumber(data.Rows[i][16].ToString()))
                    {
                        if (!IsNumber(data.Rows[i][16].ToString().Trim().Replace("_", "")))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据原始订单数量有误\r\n";
                            continue;
                        }
                        data.Rows[i][16] = data.Rows[i][16].ToString().Trim().Replace("_", "");
                    }
                    //验证回告数量是否为数字
                    if (!IsNumber(data.Rows[i][17].ToString()))
                    {
                        if (!IsNumber(data.Rows[i][17].ToString().Trim().Replace("_", "")))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据回告数量有误\r\n";
                            continue;
                        }
                        data.Rows[i][17] = data.Rows[i][17].ToString().Trim().Replace("_", "");
                    }
                    //验证销售价
                    if (!string.IsNullOrEmpty(data.Rows[i][18].ToString().Trim()))
                    {
                        if (!isNumeric(data.Rows[i][18].ToString()))
                        {
                            string str = data.Rows[i][18].ToString().Trim();
                            str = str.Replace("_", "");
                            str = str.Replace("*", "");
                            if (!isNumeric(str))
                            {
                                abnormalCount++;
                                msg += "第" + (i + 2) + "行数据门店价有误\r\n";
                                continue;
                            }
                            data.Rows[i][18] = str;
                        }
                    }
                    else
                    {
                        data.Rows[i][18] = 0;
                    }
                    //验证单价
                    if (!string.IsNullOrEmpty(data.Rows[i][19].ToString().Trim()))
                    {
                        if (!isNumeric(data.Rows[i][19].ToString()))
                        {
                            string str = data.Rows[i][19].ToString().Trim();
                            str = str.Replace("_", "");
                            str = str.Replace("*", "");
                            if (!isNumeric(str))
                            {
                                abnormalCount++;
                                msg += "第" + (i + 2) + "行数据单价有误\r\n";
                                continue;
                            }
                            data.Rows[i][19] = str;
                        }
                    }
                    else
                    {
                        data.Rows[i][19] = 0;
                    }
                    //验证进仓价
                    if (!string.IsNullOrEmpty(data.Rows[i][20].ToString().Trim()))
                    {
                        if (!isNumeric(data.Rows[i][20].ToString()))
                        {
                            string str = data.Rows[i][20].ToString().Trim();
                            str = str.Replace("_", "");
                            str = str.Replace("*", "");
                            if (!isNumeric(str))
                            {
                                abnormalCount++;
                                msg += "第" + (i + 2) + "行数据进仓价有误\r\n";
                                continue;
                            }
                            data.Rows[i][20] = str;
                        }
                    }
                    else
                    {
                        data.Rows[i][20] = 0;
                    }

                    if (string.IsNullOrEmpty(Convert.ToString(data.Rows[i][22]).Trim()))
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据供应商编码不能为空\r\n";
                        continue;
                    }

                    //云仓仓库
                    string ProductCode = Convert.ToString(data.Rows[i][21]);
                    if (string.IsNullOrEmpty(ProductCode))
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据产品编码不能为空\r\n";
                        continue;
                    }
                    //获取基础规格信息
                    DataRow[] prows = ProductBasicDt.Select("ProductCode='" + ProductCode + "'");
                    if (prows.Count() <= 0)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据产品编码不存在\r\n";
                        continue;
                    }


                    if (Convert.ToString(data.Rows[i][0]).Contains("云仓"))
                    {
                        //获取基础规格信息
                        //DataRow[] rows = ProductBasicDt.Select("ProductCode='" + ProductCode + "'");
                        //if (rows.Count() <= 0)
                        //{
                        //    abnormalCount++;
                        //    msg += "第" + (i + 2) + "行数据产品编码不存在\r\n";
                        //    continue;
                        //}
                        string dtSQL = "Specs='" + Convert.ToString(data.Rows[i][10]) + "' and Figure='" + Convert.ToString(data.Rows[i][13]).Trim() + "' and LoadIndex='" + Convert.ToString(data.Rows[i][11]).Trim() + "' and SpeedLevel='" + Convert.ToString(data.Rows[i][12]).Trim() + "' and GoodsCode='" + Convert.ToString(data.Rows[i][14]).Trim() + "' and TypeID=" + typeID;
                        if (typeID.Equals(34) || typeID.Equals(345))
                        {
                            dtSQL = " GoodsCode='" + Convert.ToString(data.Rows[i][14]).Trim() + "' and TypeID=" + typeID;
                        }
                        //根据品牌，规格，花纹，载重，速度，货品代码查询产品编码进行验证
                        DataRow[] rowss = ProductBasicDt.Select(dtSQL);
                        bool isOK = false;
                        for (int j = 0; j < rowss.Length; j++)
                        {
                            //Convert.ToString(rowss[j]["ProductCode"])
                            if (Convert.ToString(rowss[j]["ProductCode"]).Equals(Convert.ToString(data.Rows[i][21])))
                            {
                                isOK = true;
                                break;
                            }

                        }
                        if (!isOK)
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据产品编码有误\r\n";
                            continue;
                        }

                    }

                    //验证是否含税是否有效
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][23]).Trim()))
                    {
                        if (Convert.ToString(data.Rows[i][23]).Trim() != "含税" && Convert.ToString(data.Rows[i][23]).Trim() != "不含税")
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据是否含税有误\r\n";
                            continue;
                        }
                    }
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][25]).Trim()) && Convert.ToString(data.Rows[i][25]).Trim().Length > 20)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据来货城市长度有误\r\n";
                        continue;
                    }

                    //验证收货电话是否有效
                    if (!IsphoneNumber(data.Rows[i][26].ToString()) && !IsTelephoneNumber(data.Rows[i][26].ToString()))
                    {
                        if (!IsphoneNumber(data.Rows[i][26].ToString().Trim().Replace("_", "")))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据收货人电话有误\r\n";
                            continue;
                        }
                        data.Rows[i][26] = data.Rows[i][26].ToString().Trim().Replace("_", "");
                    }
                    string Born = Convert.ToString(data.Rows[i][7]) != "" ? Convert.ToString(data.Rows[i][7]) == "国产" ? "0" : "1" : "";
                    string FacOrderNo = Convert.ToString(data.Rows[i][1]).Trim();
                    int OrderType = 0;
                    switch (Convert.ToString(data.Rows[i][5]))
                    {
                        case "内部订单":
                            OrderType = 0;
                            break;
                        case "外部订单":
                            OrderType = 1;
                            break;
                        case "退货订单":
                            OrderType = 2;
                            break;
                        case "外采订单":
                            OrderType = 3;
                            break;
                    }
                    string SpecsType = string.Empty;
                    switch (Convert.ToString(data.Rows[i][29]))
                    {
                        case "分配规格":
                            SpecsType = "0";
                            break;
                        case "普通规格":
                            SpecsType = "1";
                            break;
                        case "特价分配规格":
                            SpecsType = "2";
                            break;
                        case "手工单":
                            SpecsType = "3";
                            break;
                    }
                    string Assort = Convert.ToString(data.Rows[i][8]).Trim();
                    string GoodsCode = Convert.ToString(data.Rows[i][14]).Trim();
                    string Specs = Convert.ToString(data.Rows[i][10]).Trim();
                    string Figure = Convert.ToString(data.Rows[i][13]).Trim();
                    string LoadIndex = Convert.ToString(data.Rows[i][11]).Trim();
                    string SpeedLevel = Convert.ToString(data.Rows[i][12]).Trim().Length > 1 ? Convert.ToString(data.Rows[i][12]).Trim().Substring(0, 1) : Convert.ToString(data.Rows[i][12]).Trim();
                    string BelongMonth = Convert.ToString(data.Rows[i][6]).Trim();
                    string year = BelongMonth.Substring(0, 4);
                    string month = BelongMonth.Substring(4, 2);
                    string batch = data.Rows[i][15].ToString();
                    string BelongDepart = data.Rows[i][28].ToString();
                    //供应商信息
                    if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][22]).Trim()))
                    {
                        SupplierData = allSupplier.Where(w => w.ClientNum == Convert.ToInt32(data.Rows[i][22])).FirstOrDefault();
                        if (SupplierData == null)
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行供应商编号填写有误\r\n";
                            continue;
                        }
                    }
                    else
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行未填写供应商编号\r\n";
                        continue;
                    }
                    string SuppClientNum = SupplierData.ClientNum.ToString();
                    string Supplier = SupplierData.ClientName;
                    string SupplierAddress = SupplierData.Address;
                    //string BusinessName = data.Rows[i][30].ToString();
                    //马牌产品验证货品代码
                    if (Convert.ToString(data.Rows[i][4]).Trim() == "马牌")
                    {
                        if (GoodsCode.Length == 10)
                        {
                            if (GoodsCode.Substring(0, 1) != "0")
                            {
                                GoodsCode = "0" + GoodsCode;
                            }
                            else
                            {
                                abnormalCount++;
                                msg += "第" + (i + 2) + "行数据货品代码有误\r\n";
                                continue;
                            }
                        }
                        else if (GoodsCode.Length < 10)
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据货品代码有误\r\n";
                            continue;
                        }
                        else if (GoodsCode.Length > 15)
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据货品代码有误\r\n";
                            continue;
                        }
                    }
                    string ProductName = Convert.ToString(data.Rows[i][3]).Trim();
                    //验证数据是否已有基础价格
                    if (Convert.ToString(data.Rows[i][4]).Trim() == "优科豪马" && string.IsNullOrEmpty(ProductName))
                    {
                        //外部订单与外采订单不限制匹配价格
                        if (OrderType != 3 && OrderType != 1)
                        {
                            DataRow[] rows = ProductBasicDt.Select("TypeID =" + typeID + " and GoodsCode='" + GoodsCode + "' and Specs='" + Specs + "' and Figure='" + Figure + "' and LoadIndex='" + LoadIndex + "' and SpeedLevel='" + SpeedLevel + "'");

                            if (rows.Count() <= 0)
                            {
                                abnormalCount++;
                                msg += "第" + (i + 2) + "行数据基础规格不存在\r\n";
                                continue;
                            }
                        }
                    }
                    //仓库id    退货来货入库单号  品牌ID  下单方式  生产地  OE RE胎  订单来源  订单归属月  归属部门  规格类型  产品编码   and SuppClientNum='" + SuppClientNum + "' and Supplier='" + Supplier + "' and SupplierAddress='"+ SupplierAddress + "'
                    string SQL = "HouseID =" + houseID + " and FacOrderNo = '" + FacOrderNo + "' and typeID=" + typeID + " and OrderType='" + OrderType + "'";
                    if (!string.IsNullOrEmpty(Born))
                    {
                        SQL += " and Born=" + Born;
                    }
                    if (!string.IsNullOrEmpty(Assort))
                    {
                        SQL += "  and Assort='" + Assort + "'";
                    }

                    SQL += "and ProductCode='" + ProductCode + "'  and Source='" + Source + "' and BelongMonth=" + BelongMonth;

                    if (!string.IsNullOrEmpty(BelongDepart))
                    {
                        SQL += "  and BelongDepart='" + BelongDepart + "'";
                    }
                    //if (!string.IsNullOrEmpty(BusinessName))
                    //{
                    //    SQL += "  and BusinessName='" + BusinessName + "'";
                    //}
                    if (!string.IsNullOrEmpty(SpecsType))
                    {
                        SQL += "  and SpecsType='" + SpecsType + "'";
                    }

                    DataRow[] NewRows = newData.Select(SQL);
                    DataRow drNew = newData.NewRow();
                    string HouseCode = string.Empty;
                    CargoHouseEntity houseEntity = house.QueryCargoHouse(new CargoHouseEntity { HouseID = houseID });
                    HouseCode = houseEntity.HouseCode;
                    if (NewRows.Count() <= 0)
                    {
                        if (string.IsNullOrEmpty(ProductName))
                        {
                            if (string.IsNullOrEmpty(CargoDepart))
                            {
                                CargoDepart = houseEntity.CargoDepart;
                            }
                            if (!string.IsNullOrEmpty(CargoDepart))
                            {
                                ProductName = CargoDepart;
                            }
                            else
                            {
                                abnormalCount++;
                                msg += "第" + (i + 2) + "行数据无仓库部门请联系IT\r\n";
                                return;
                            }
                        }
                        //,BusinessName
                        object[] objs = { houseID, Convert.ToString(data.Rows[i][0]).Trim(), Convert.ToString(data.Rows[i][1]).Trim(), Source, Convert.ToString(data.Rows[i][2]).Trim(), ProductName, typeID, Convert.ToString(data.Rows[i][4]).Trim(), OrderType, Convert.ToString(data.Rows[i][6]).Trim(), Convert.ToString(data.Rows[i][7]) != "" ? Convert.ToString(data.Rows[i][7]) == "国产" ? "0" : "1" : "", Convert.ToString(data.Rows[i][8]).Trim(), Convert.ToString(data.Rows[i][9]).Trim(), Convert.ToString(data.Rows[i][10]).Trim(), Convert.ToString(data.Rows[i][11]).Trim(), Convert.ToString(data.Rows[i][12]).Trim().Length > 1 ? Convert.ToString(data.Rows[i][12]).Trim().Substring(0, 1) : Convert.ToString(data.Rows[i][12]).Trim(), Convert.ToString(data.Rows[i][13]).Trim(), GoodsCode, Convert.ToString(data.Rows[i][15]).Trim(), Convert.ToString(data.Rows[i][16]).Trim(), Convert.ToString(data.Rows[i][17]).Trim(), Math.Round(Convert.ToDouble(data.Rows[i][18]), 2), Math.Round(Convert.ToDouble(data.Rows[i][19]), 2), Math.Round(Convert.ToDouble(data.Rows[i][20]), 2), Convert.ToString(data.Rows[i][21]).Trim(), Convert.ToString(data.Rows[i][22]).Trim(), Convert.ToString(data.Rows[i][23]) == "含税" ? 1 : 0, Convert.ToString(data.Rows[i][24]).Trim(), Convert.ToString(data.Rows[i][25]).Trim(), Convert.ToString(data.Rows[i][26]).Trim(), Convert.ToString(data.Rows[i][27]), BelongDepart, SpecsType, HouseCode, SuppClientNum, Supplier, SupplierAddress };
                        drNew.ItemArray = objs;
                        newData.Rows.Add(drNew);
                    }
                    else
                    {
                        for (int j = 0; j < NewRows.Length; j++)
                        {
                            DataRow drEmployee = NewRows[j];
                            drEmployee.BeginEdit();
                            drEmployee["OrderNum"] = Convert.ToInt32(NewRows[0][19]) + Convert.ToInt32(data.Rows[i][16]);
                            drEmployee["ReplyNumber"] = Convert.ToInt32(NewRows[0][20]) + Convert.ToInt32(data.Rows[i][17]);
                            drEmployee.EndEdit();
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据出现重复已自动合并\r\n";
                        }
                    }
                }

                CargoPriceBus busPrice = new CargoPriceBus();
                if (newData.Rows.Count > 0)
                {
                    for (int i = 0; i < newData.Rows.Count; i++)
                    {
                        double inhouseprice = Math.Round(Convert.ToDouble(newData.Rows[i][23]), 2);
                        double SalePrice = Math.Round(Convert.ToDouble(newData.Rows[i][21]), 2);

                        //云仓仓库
                        if (Convert.ToString(newData.Rows[i][1]).Contains("云仓"))
                        {
                            CargoProductBasicPriceEntity list = busPrice.QueryBasicPriceEntity(new CargoProductBasicPriceEntity
                            {
                                HouseID = Convert.ToInt32(newData.Rows[i][0]),
                                CloudHouseType = "1",
                                ProductCode = Convert.ToString(newData.Rows[i][24]),
                            });
                            if (list.InHousePrice <= 0)
                            {
                                inhouseprice = Convert.ToDouble(Math.Ceiling(Convert.ToDecimal(newData.Rows[i][23])));
                                SalePrice = Convert.ToDouble(Math.Ceiling(inhouseprice * 1.009));
                            }
                            else
                            {
                                inhouseprice = list.InHousePrice;
                                SalePrice = list.SalePrice;
                            }
                        }

                        ent.Add(new CargoFactoryOrderEntity
                        {
                            HouseID = Convert.ToInt32(newData.Rows[i][0]),
                            HouseName = Convert.ToString(newData.Rows[i][1]).Trim(),
                            FacOrderNo = Convert.ToString(newData.Rows[i][2]).Trim(),
                            Source = Convert.ToInt32(newData.Rows[i][3]),
                            SourceName = Convert.ToString(newData.Rows[i][4]).Trim(),
                            ProductName = Convert.ToString(newData.Rows[i][5]).Trim(),
                            TypeID = Convert.ToInt32(newData.Rows[i][6]),
                            TypeName = Convert.ToString(newData.Rows[i][7]).Trim(),
                            //OrderType = Convert.ToString(data.Rows[i][5]) == "内部订单" ? 0 : 1,
                            OrderType = Convert.ToInt32(newData.Rows[i][8]),
                            BelongMonth = Convert.ToString(newData.Rows[i][9]).Trim(),
                            Born = Convert.ToString(newData.Rows[i][10]),
                            Assort = Convert.ToString(newData.Rows[i][11]).Trim(),
                            Model = Convert.ToString(newData.Rows[i][12]).Trim(),
                            Specs = Convert.ToString(newData.Rows[i][13]).Trim(),
                            LoadIndex = Convert.ToString(newData.Rows[i][14]).Trim(),
                            SpeedLevel = Convert.ToString(newData.Rows[i][15]).Trim().Length > 1 ? Convert.ToString(newData.Rows[i][15]).Trim().Substring(0, 1) : Convert.ToString(newData.Rows[i][15]).Trim(),
                            Figure = Convert.ToString(newData.Rows[i][16]).Trim(),
                            GoodsCode = Convert.ToString(newData.Rows[i][17]).Trim(),
                            Batch = Convert.ToString(newData.Rows[i][18]).Trim(),
                            OrderNum = Convert.ToInt32(newData.Rows[i][19]),
                            ReplyNumber = Convert.ToInt32(newData.Rows[i][20]),
                            //InPiece = Convert.ToInt32(data.Rows[i][18]),
                            SalePrice = SalePrice,
                            UnitPrice = Math.Round(Convert.ToDouble(newData.Rows[i][22]), 2),
                            //CostPrice = Math.Round(Convert.ToDouble(data.Rows[i][20]), 2),//从基础价格数据中匹配
                            TradePrice = Math.Round(Convert.ToDouble(newData.Rows[i][21]), 2),
                            InHousePrice = inhouseprice,
                            ProductCode = Convert.ToString(newData.Rows[i][24]).Trim(),
                            SuppClientNum = Convert.ToString(newData.Rows[i][34]).Trim(),
                            WhetherTax = Convert.ToInt32(newData.Rows[i][26]),
                            //SaleMoney = Math.Round(Convert.ToDouble(data.Rows[i][18]), 2) * Convert.ToInt32(data.Rows[i][17]),
                            ReceiveName = Convert.ToString(newData.Rows[i][27]).Trim(),
                            ReceiveCity = Convert.ToString(newData.Rows[i][28]).Trim(),
                            ReceiveMobile = Convert.ToString(newData.Rows[i][29]).Trim(),
                            SourceHouse = Convert.ToString(newData.Rows[i][30]),
                            BelongDepart = Convert.ToString(newData.Rows[i][31]),
                            //BusinessName = Convert.ToString(newData.Rows[i][34]),
                            SpecsType = Convert.ToString(newData.Rows[i][32]),
                            HouseCode = Convert.ToString(newData.Rows[i][33]),
                            Supplier = Convert.ToString(newData.Rows[i][35]),
                            //SuppClientNum = Convert.ToString(newData.Rows[i][36]),
                            SupplierAddress = Convert.ToString(newData.Rows[i][36]),
                        });

                    }
                }
                //ent = ent.OrderBy(e => e.Specs).ToList();
                String json = JSON.Encode(ent);

                if (abnormalCount > 0)
                {
                    import.Type = 1;
                    import.Message = msg;
                }
                import.Result = true;
                import.Data = json;
                json = JSON.Encode(import);
                Response.Clear();
                Response.Write(json);
                Response.End();
            }
        }
        #region 验证
        /// <summary>
        /// 判断字符串是否为整数或小数
        /// </summary>
        /// <param name="value">验证字符串</param>
        /// <returns></returns>
        public static bool isNumeric(String value)
        {
            return Regex.IsMatch(value, "^(\\-|\\+)?\\d+(\\.\\d+)?$");
        }
        /// <summary>
        /// 判断字符串是否为数字
        /// </summary>
        /// <param name="message"></param>
        /// <returns></returns>
        public static bool IsNumber(string value)
        {
            return Regex.IsMatch(value, @"^\d+$");
        }
        /// <summary>
        /// 验证是否为手机号码
        /// </summary>
        /// <param name="value"></param>
        /// <returns></returns>
        public static bool IsphoneNumber(string value)
        {
            return Regex.IsMatch(value, @"^1[3456789]\d{9}$");
        }
        /// <summary>
        /// 验证是否为电话号码
        /// </summary>
        /// <param name="value"></param>
        /// <returns></returns>
        public bool IsTelephoneNumber(string value)
        {
            return Regex.IsMatch(value, @"^(\d{3,4}-)?\d{6,8}$");
        }

        /// <summary>
        /// 删除导入的table中的空行
        /// </summary>
        /// <param name="dt"></param>
        protected void removeEmpty(DataTable dt)
        {
            List<DataRow> removelist = new List<DataRow>();
            for (int i = 0; i < dt.Rows.Count; i++)
            {
                bool rowdataisnull = true;
                for (int j = 0; j < dt.Columns.Count; j++)
                {
                    if (!string.IsNullOrEmpty(dt.Rows[i][j].ToString().Trim()))
                    {

                        rowdataisnull = false;
                    }
                }
                if (rowdataisnull)
                {
                    removelist.Add(dt.Rows[i]);
                }

            }
            for (int i = 0; i < removelist.Count; i++)
            {
                dt.Rows.Remove(removelist[i]);
            }
        }
        #endregion
        /// <summary>
        /// 保存导入的数据
        /// </summary>
        public void SaveImportData()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoFactoryOrderEntity> list = new List<CargoFactoryOrderEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "工厂订单导入";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            CargoHouseEntity entity = new CargoHouseEntity();
            CargoHouseBus house = new CargoHouseBus();
            ArrayList VehicleNoList = new ArrayList();
            CargoOrderBus orderBus = new CargoOrderBus();
            CargoClientBus clientBus = new CargoClientBus();
            //Dictionary<string, string> dicUpClient = new Dictionary<string, string>();
            //List<CargoUpClientEntity> UpClientlist = new List<CargoUpClientEntity>();

            try
            {
                string clientNumStr = string.Empty;
                string HouseIDs = string.Empty;
                foreach (Hashtable row in rows)
                {
                    HouseIDs += Convert.ToInt32(row["HouseID"]) + ",";
                    clientNumStr = Convert.ToString(row["SuppClientNum"]);
                }
                HouseIDs = HouseIDs.Substring(0, HouseIDs.Length - 1);

                CargoClientEntity cargoClient = new CargoClientEntity();
                if (!string.IsNullOrEmpty(clientNumStr))
                {
                    cargoClient = clientBus.QueryCargoClient(Convert.ToInt32(clientNumStr), 0);
                }

                //UpClientlist = clientBus.QueryAllUpClientDep(new CargoUpClientEntity { HouseIDs = HouseIDs });
                //foreach (var item in UpClientlist)
                //{
                //    if (!dicUpClient.ContainsKey(item.DepName))
                //    {
                //        dicUpClient.Add(item.DepName, item.ID.ToString());
                //    }
                //}
                CargoProductBasicPriceBus basicBus = new CargoProductBasicPriceBus();
                DataTable ProductBasicDt = new DataTable();
                ProductBasicDt = basicBus.QueryProductSpecDate(new CargoProductEntity { });
                string FacOrderNo = string.Empty;
                List<HLYAddReceiptDetails> HLYAddReceiptDetailsList = new List<HLYAddReceiptDetails>();
                string belongDepart = string.Empty;
                string belongMonth = string.Empty;
                string OrderType = string.Empty;
                foreach (Hashtable row in rows)
                {
                    belongMonth = Convert.ToString(row["BelongMonth"]).Trim();
                    FacOrderNo = Convert.ToString(row["FacOrderNo"]).Trim();
                    OrderType = Convert.ToString(row["OrderType"]).Trim();
                    if (!string.IsNullOrEmpty(FacOrderNo))
                    {
                        try
                        {
                            if (row["TypeID"].ToString() == "34" || row["TypeID"].ToString() == "345")
                            {
                                if (!VehicleNoList.Contains(FacOrderNo))
                                {
                                    VehicleNoList.Add(FacOrderNo);

                                    if (orderBus.IsExistBarcodeData(FacOrderNo) <= 0)
                                    {
                                        TimeSpan ts = DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0);
                                        string tms = Convert.ToInt64(ts.TotalSeconds).ToString();
                                        string sign = string.Empty;
                                        string appKey = Common.GetContiappKey();
                                        string noise = Common.GetContinoise();
                                        string appSecret = Common.GetContiappSecret();
                                        string ss = "appKey=" + appKey + "&noise=" + noise + "&timestamp=" + tms + "&vehicleNo=" + FacOrderNo + "&appSecret=" + appSecret;
                                        //MD5加密
                                        using (MD5 md5Hash = MD5.Create())
                                        {
                                            sign = Common.GetMd5Hash(md5Hash, ss);
                                        }
                                        NameValueCollection nvc = new NameValueCollection();
                                        nvc.Add("appKey", appKey);
                                        nvc.Add("noise", noise);
                                        nvc.Add("timestamp", tms);
                                        nvc.Add("sign", sign);
                                        nvc.Add("vehicleNo", FacOrderNo);

                                        string returnJson = wxHttpUtility.PostForm("https://contiid.continental-tires.cn/api/2.0/TTP/getRDCout", nvc, null);

                                        JavaScriptSerializer js = new JavaScriptSerializer();
                                        if (returnJson.IndexOf("1000") >= 0)
                                        {
                                            RetunBarcodeJson returnList = js.Deserialize<RetunBarcodeJson>(returnJson);

                                            string code = returnList.code;
                                            switch (code)
                                            {
                                                case "1000":
                                                    if (returnList.data.Count() <= 0)
                                                    {
                                                        msg.Message += FacOrderNo + " 未获取到轮胎条码\r\n";
                                                        break;
                                                    }
                                                    List<data> checkindata = returnList.data;
                                                    msg.Result = true;
                                                    List<CargoFactoryOrderBarcodeEntity> entityList = new List<CargoFactoryOrderBarcodeEntity>();
                                                    log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                                                    log.Moudle = "订单管理";
                                                    log.Status = "0";
                                                    log.NvgPage = "来货订单导入";
                                                    log.UserID = UserInfor.LoginName.Trim();
                                                    log.Operate = "A";

                                                    foreach (var item in checkindata)
                                                    {
                                                        string[] description = item.Description.Split(' ');
                                                        string figure = string.Empty;
                                                        for (int i = 2; i < description.Length; i++)
                                                        {
                                                            figure += description[i];
                                                        }
                                                        string goodsCode = string.Empty;
                                                        if (item.material.Length > 6)
                                                        {
                                                            goodsCode = item.material + "0000";
                                                        }
                                                        else if (item.material.Length == 5)
                                                        {
                                                            goodsCode = "0" + item.material + "0000";
                                                        }
                                                        string loadSpeed = description[1].Replace("(", "").Replace(")", "");
                                                        entityList.Add(new CargoFactoryOrderBarcodeEntity
                                                        {
                                                            VehicleNo = FacOrderNo,
                                                            Barcode = item.barcode,
                                                            RDC = item.RDC,
                                                            GoodsCode = goodsCode,
                                                            Batch = item.DOT,
                                                            Description = item.Description,
                                                            OutTime = Convert.ToDateTime(item.outtime),
                                                            Specs = description[0],
                                                            Figure = figure,
                                                            LoadIndex = loadSpeed.Substring(0, loadSpeed.Length - 1),
                                                            SpeedLevel = loadSpeed.Substring(loadSpeed.Length - 1)
                                                        });
                                                    }
                                                    orderBus.InsertBarcodeData(entityList, log);
                                                    break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        catch (Exception ex)
                        {
                        }
                    }
                    entity.HouseID = Convert.ToInt32(row["HouseID"]);
                    entity.Name = Convert.ToString(row["HouseName"]);
                    entity.HouseCode = Convert.ToString(row["HouseCode"]);

                    string Company = "";
                    if (!string.IsNullOrEmpty(UserInfor.DepCode))
                    {
                        if (UserInfor.DepCode.Length > 1)
                        {
                            if (UserInfor.DepCode.Substring(0, 2) == "B1")
                            {
                                Company = "0";
                            }
                            else if (UserInfor.DepCode.Substring(0, 2) == "B2")
                            {
                                Company = "2";
                            }
                            else
                            {
                                Company = "1";
                            }
                        }
                        else
                        {
                            Company = "1";
                        }
                    }
                    else
                    {
                        Company = "1";
                    }
                    if (Convert.ToString(row["BelongDepart"]).Trim().Equals("OE渠道销售部"))
                    {
                        belongDepart = "1";
                    }
                    else if (Convert.ToString(row["BelongDepart"]).Trim().Equals("RE渠道销售部"))
                    {
                        belongDepart = "0";
                    }
                    //dicUpClient.TryGetValue(Convert.ToString(row["BelongDepart"]).Trim(), out belongDepart);
                    //if (belongDepart == null) { belongDepart = ""; }
                    DataRow[] basicRows = ProductBasicDt.Select("GoodsCode='" + Convert.ToString(row["GoodsCode"]).Trim() + "'");
                    string CarModel = string.Empty;
                    string Manufacturer = string.Empty;
                    string Seller = string.Empty;
                    string SellerAddress = string.Empty;
                    string Servicer = string.Empty;
                    string BrandCode = string.Empty;
                    string ProName = string.Empty;
                    string ProductCode = string.Empty;
                    if (basicRows.Count() > 0 && Convert.ToInt32(row["HouseID"]).Equals(65))
                    {
                        CarModel = basicRows[0]["CarModel"].ToString();
                        Manufacturer = basicRows[0]["Manufacturer"].ToString();
                        Seller = basicRows[0]["Seller"].ToString();
                        SellerAddress = basicRows[0]["SellerAddress"].ToString();
                        Servicer = basicRows[0]["Servicer"].ToString();
                        BrandCode = basicRows[0]["BrandCode"].ToString();
                        ProName = basicRows[0]["ProductName"].ToString();
                        ProductCode = basicRows[0]["ProductCode"].ToString();
                    }
                    list.Add(new CargoFactoryOrderEntity
                    {
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        FacOrderNo = Convert.ToString(row["FacOrderNo"]).Trim(),
                        Source = Convert.ToInt32(row["Source"]),
                        SourceName = Convert.ToString(row["SourceName"]).Trim(),
                        ProductName = !string.IsNullOrEmpty(ProName) ? ProName : Convert.ToString(row["ProductName"]).Trim(),
                        CargoDepart = !string.IsNullOrEmpty(Convert.ToString(row["ProductName"]).Trim()) ? Convert.ToString(row["ProductName"]).Trim() : (house.QueryCargoHouse(entity)).CargoDepart,
                        TypeID = Convert.ToInt32(row["TypeID"]),
                        TypeName = Convert.ToString(row["TypeName"]).Trim(),
                        OrderType = string.IsNullOrEmpty(Convert.ToString(row["OrderType"])) ? 0 : Convert.ToInt32(row["OrderType"]),
                        Model = Convert.ToString(row["Model"]).Trim(),
                        BelongMonth = Convert.ToString(row["BelongMonth"]).Trim(),
                        Born = Convert.ToString(row["Born"]),
                        Assort = Convert.ToString(row["Assort"]).Trim(),
                        Specs = Convert.ToString(row["Specs"]).Trim(),
                        LoadIndex = string.IsNullOrEmpty(Convert.ToString(row["LoadIndex"])) ? "0" : Convert.ToString(row["LoadIndex"]).Trim(),
                        SpeedLevel = Convert.ToString(row["SpeedLevel"]).Trim(),
                        Figure = Convert.ToString(row["Figure"]).Trim(),
                        GoodsCode = Convert.ToString(row["GoodsCode"]).Trim(),
                        Batch = Convert.ToString(row["Batch"]).Trim(),
                        OrderNum = Convert.ToInt32(row["OrderNum"]),
                        ReplyNumber = string.IsNullOrEmpty(Convert.ToString(row["ReplyNumber"])) ? 0 : Convert.ToInt32(row["ReplyNumber"]),
                        InPiece = 0,
                        InCargoStatus = 0,
                        SalePrice = string.IsNullOrEmpty(Convert.ToString(row["SalePrice"])) ? 0 : Convert.ToDouble(row["SalePrice"]),
                        UnitPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDouble(row["UnitPrice"]),
                        TradePrice = string.IsNullOrEmpty(Convert.ToString(row["TradePrice"])) ? 0 : Convert.ToDouble(row["TradePrice"]),//门店价等于销售价
                        InHousePrice = string.IsNullOrEmpty(Convert.ToString(row["InHousePrice"])) ? 0 : Convert.ToDouble(row["InHousePrice"]),
                        WhetherTax = Convert.ToInt32(row["WhetherTax"]) == 0 ? 0 : 1,
                        SaleMoney = string.IsNullOrEmpty(Convert.ToString(row["ReplyNumber"])) ? 0 : Convert.ToDouble(Convert.ToDouble(row["SalePrice"]) * Convert.ToInt32(row["ReplyNumber"])),//销售价*回告数量
                        ReceiveName = Convert.ToString(row["ReceiveName"]).Trim(),
                        ReceiveCity = Convert.ToString(row["ReceiveCity"]).Trim(),
                        ReceiveMobile = Convert.ToString(row["ReceiveMobile"]).Trim(),
                        OP_Name = UserInfor.UserName.Trim(),
                        SourceHouse = Convert.ToString(row["SourceHouse"]),
                        BelongDepart = belongDepart,
                        Company = Company,
                        SpecsType = !string.IsNullOrEmpty(Convert.ToString(row["SuppClientNum"])) ? "4" : Convert.ToString(row["SpecsType"]),
                        Supplier = cargoClient.ClientShortName,
                        SuppClientNum = Convert.ToString(row["SuppClientNum"]),
                        SupplierAddress = cargoClient.Address,
                        CarModel = CarModel,
                        Manufacturer = Manufacturer,
                        Seller = Seller,
                        SellerAddress = SellerAddress,
                        Servicer = Servicer,
                        BrandCode = BrandCode,
                        ProductCode = !string.IsNullOrEmpty(Convert.ToString(row["ProductCode"])) ? Convert.ToString(row["ProductCode"]) : ProductCode
                    });
                    //HLYAddReceiptDetailsList.Add(new HLYAddReceiptDetails
                    //{
                    //    Specs = Convert.ToString(row["Specs"]).Trim(),
                    //    Figure = Convert.ToString(row["Figure"]).Trim(),
                    //    Model = Convert.ToString(row["Model"]).Trim(),
                    //    GoodsCode = Convert.ToString(row["GoodsCode"]).Trim(),
                    //    LoadIndex = Convert.ToString(row["LoadIndex"]).Trim(),
                    //    SpeedLevel = Convert.ToString(row["SpeedLevel"]).Trim(),
                    //    Born = Convert.ToString(row["Born"]),
                    //    Assort = Convert.ToString(row["Assort"]).Trim(),
                    //    Brand = Convert.ToString(row["TypeName"]).Trim(),
                    //    SupplierCode = "狄乐汽服",
                    //    ProductName = Convert.ToString(row["TypeName"]).Trim() + "轮胎",
                    //    QtyInUint = 1,
                    //    BoxType = "S01",
                    //    Unit = "条",
                    //    QtyDelivery = string.IsNullOrEmpty(Convert.ToString(row["ReplyNumber"])) ? 0 : Convert.ToInt32(row["ReplyNumber"]),
                    //    CargoTypeID = Convert.ToInt32(row["TypeID"]),
                    //    CargoTypeName = Convert.ToString(row["TypeName"]).Trim(),
                    //    SpecsType = Convert.ToString(row["SpecsType"]),
                    //});
                }
                //HLYAddReceipt addReceipt = new HLYAddReceipt();
                //addReceipt.DepartmentID = "B0002";
                //addReceipt.BusinessID = "151";
                //addReceipt.CustomerCode = "狄乐汽服";
                //addReceipt.CargoHouseID = entity.HouseID;
                ////addReceipt.FactoryID = "";
                //addReceipt.HouseCode = entity.HouseCode;
                //addReceipt.HouseName = entity.Name;
                //addReceipt.SupplierDeliveryNo = FacOrderNo;
                //addReceipt.SupplierCode = "DLQF";
                ////addReceipt.SupplierContact = "";
                ////addReceipt.SupplierPhone = "";
                ////addReceipt.CarNumber = "";
                ////addReceipt.DriverName = "";
                ////addReceipt.DriverPhone = "";
                ////addReceipt.Remark = "";
                //addReceipt.BelongMonth = belongMonth;
                //addReceipt.BelongDepart = belongDepart.Equals("0") ? "RE" : "OE";
                //addReceipt.Status = 1;
                //addReceipt.CreateBy = UserInfor.UserName;
                //addReceipt.ReceiptDatePlan = DateTime.Now.ToString("yyyy-MM-dd");
                //addReceipt.CreateBy = UserInfor.UserName;
                //addReceipt.details = HLYAddReceiptDetailsList;
                //string jsonString = JsonConvert.SerializeObject(addReceipt);

                //#if DEBUG
                //                string hlyres = wxHttpUtility.SendHttpRequest("http://192.168.3.231:9003/api/CargoInterface/AddReceipt", jsonString, "application/json");
                //#endif
                //东平城配仓、广州仓库|| entity.HouseID.Equals(93)
                //if (entity.HouseID.Equals(9))
                //{
                //    if (OrderType.Equals("0") || OrderType.Equals("2"))
                //    {
                //        string hlyres = wxHttpUtility.SendHttpRequest(Common.GetHLYAPI() + "/api/CargoInterface/AddReceipt", jsonString, "application/json");
                //        JavaScriptSerializer js = new JavaScriptSerializer();
                //        HLYAddReceiptReturn HLYReturn = js.Deserialize<HLYAddReceiptReturn>(hlyres);
                //        if (!HLYReturn.State)
                //        {
                //            msg.Result = false;
                //            msg.Message += $"写入好来运接口失败{HLYReturn.Errmsg}\r\n";
                //            goto Error;
                //        }
                //        foreach (var item in list)
                //        {
                //            var returnList = HLYReturn.data.details.Where(x => x.Specs.Equals(item.Specs) && x.Figure.Equals(item.Figure) && x.Model.Equals(item.Model) && x.GoodsCode.Equals(item.GoodsCode) && x.Born.Equals(item.Born) && x.BelongDepart.Equals(item.BelongDepart.Equals("0") ? "RE" : "OE") && x.BelongMonth.Equals(item.BelongMonth) && x.SpecsType.Equals(item.SpecsType)).ToList();
                //            if (returnList.Count() > 0)
                //            {
                //                item.HLYReturnID = returnList[0].ID;
                //            }
                //        }
                //    }
                //}


                list = list.OrderBy(e => e.Specs).ToList();
                if (msg.Result)
                {
                    bus.SaveFactoryOrderData(list, log);
                    //var FacOrderNoList = list.GroupBy(x => x.FacOrderNo).ToList();
                    //foreach (var item in FacOrderNoList)
                    //{
                    //    string result = wxHttpUtility.SendHttpRequest(Common.GetHLYAPI() + "/api/cargo/sync/ReceiptFromCargo?SupplierDeliveryNo=" + item.Key, "");
                    //    Hashtable hlyResult = (Hashtable)JSON.Decode(result);
                    //    if (hlyResult["State"].ToString().ToUpper().Equals("FALSE"))
                    //    {
                    //        msg.Message += item.Key + "同步到好来运失败：" + hlyResult["Errcode"] + hlyResult["Errmsg"] + "\r\n";
                    //    }
                    //}
                    msg.Result = true;
                    if (string.IsNullOrEmpty(msg.Message))
                    {
                        msg.Message = "成功";
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
        Error:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 上传来货订单成本价
        /// </summary>
        public void savePriceFile()
        {
            System.Web.HttpFileCollection files = this.Request.Files;
            if (files == null || files.Count == 0) return;
            string attachmentId = Guid.NewGuid().ToString();
            DataTable data = ToExcel.ImportExcelData(files);

            CargoImportEntity import = new CargoImportEntity();
            import.Result = true;
            import.Data = "";
            import.Message = "";
            import.Type = 0;
            import.ExistCount = 0;
            string msg = "";

            List<CargoFactoryOrderEntity> ent = new List<CargoFactoryOrderEntity>();
            CargoProductBasicPriceBus bus = new CargoProductBasicPriceBus();

            //验证上传excel文件列数是否有效
            if (data.Columns.Count != 20)
            {
                import.Result = false;
                import.Type = 1;
                import.Message = "模板有误或缺少列，请使用指定模板";
                String abnormalJson = JSON.Encode(import);
                Response.Clear();
                Response.Write(abnormalJson);
                Response.End();
                return;
            }
            //清空table中的空行
            removeEmpty(data);


            if (data.Rows.Count <= 0)
            {
                import.Result = false;
                import.Type = 1;
                import.Message = "Excel无有效数据，请检查导入数据";
                String abnormalJson = JSON.Encode(import);
                Response.Clear();
                Response.Write(abnormalJson);
                Response.End();
                return;
            }

            //获取所有可用品牌用于表格显示
            List<CargoProductTypeEntity> allSpesc = new List<CargoProductTypeEntity>();
            allSpesc = bus.QueryAllBrand();
            Dictionary<string, int> dic = new Dictionary<string, int>();
            foreach (var item in allSpesc)
            {
                if (!dic.ContainsKey(item.TypeName))
                {
                    dic.Add(item.TypeName, item.TypeID);
                }
            }

            //获取所有仓库用于表格显示
            List<CargoProductBasicPriceEntity> allHouse = new List<CargoProductBasicPriceEntity>();
            Dictionary<string, int> dicHouse = new Dictionary<string, int>();

            foreach (var item in UserInfor.CargoList)
            {
                if (!dicHouse.ContainsKey(item.Name))
                {
                    dicHouse.Add(item.Name, item.ID);
                }
            }
            //获取所有来源用于表格显示
            CargoProductBus productBus = new CargoProductBus();
            Dictionary<string, int> dicScource = new Dictionary<string, int>();
            List<CargoProductSourceEntity> allProductSourcelist = new List<CargoProductSourceEntity>();
            allProductSourcelist = productBus.QueryAllProductSource();
            foreach (var item in allProductSourcelist)
            {
                if (!dicScource.ContainsKey(item.SourceName))
                {
                    dicScource.Add(item.SourceName, item.Source);
                }
            }

            int HouseID = 0;

            int abnormalCount = 0;

            for (int i = 0; i < data.Rows.Count; i++)
            {
                //验证Excel表格指定列是否缺少数据
                bool isContinue = false;
                for (int j = 0; j < data.Columns.Count; j++)
                {
                    if (string.IsNullOrEmpty((data.Rows[i][j]).ToString()))
                    {
                        //除优科豪马外产地可不填
                        if (j == 7)
                        {
                            var type = Convert.ToString(data.Rows[i][5]).Trim();
                            if (!string.IsNullOrEmpty(type))
                            {
                                if (type == "优科豪马")
                                {
                                    isContinue = true;
                                    break;
                                }
                            }
                        }
                        //除优科豪马外OERE类型可不填
                        else if (j == 8)
                        {
                            var type = Convert.ToString(data.Rows[i][5]).Trim();
                            if (!string.IsNullOrEmpty(type))
                            {
                                if (type == "优科豪马")
                                {
                                    isContinue = true;
                                    break;
                                }
                            }
                        }
                        else
                        {
                            isContinue = true;
                            break;
                        }
                    }
                }
                if (isContinue)
                {
                    abnormalCount++;
                    msg += "第" + (i + 2) + "行数据有空值\r\n";
                    continue;
                }

                //验证导入仓库是否在数据库中有效，无效则跳过
                int houseID = 0;
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][0]).Trim()))
                {
                    if (!dicHouse.ContainsKey(Convert.ToString(data.Rows[i][0]).Trim()))
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行所属仓库不存在\r\n";
                        continue;
                    }
                    else
                    {
                        dicHouse.TryGetValue(Convert.ToString(data.Rows[i][0]).Trim(), out houseID);
                        if (HouseID != 0)
                        {
                            if (houseID != HouseID)
                            {
                                abnormalCount++;
                                msg += "一次只能导入同一仓库的订单\r\n";
                                continue;
                            }
                        }
                        else
                        {
                            HouseID = houseID;
                        }
                    }
                }

                //验证导入产品来源是否在数据中有效，无效则跳过
                int Source = 0;
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][2]).Trim()))
                {
                    if (!dicScource.ContainsKey(Convert.ToString(data.Rows[i][2]).Trim()))
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据产品来源不存在\r\n";
                        continue;
                    }
                    else
                    {
                        dicScource.TryGetValue(Convert.ToString(data.Rows[i][2]).Trim(), out Source);
                    }
                }
                //验证导入品牌是否在数据库中有效，无效则跳过
                int typeID = 0;
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][4]).Trim()))
                {
                    if (!dic.ContainsKey(Convert.ToString(data.Rows[i][4]).Trim()))
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据品牌不存在\r\n";
                        continue;
                    }
                    else
                    {
                        dic.TryGetValue(Convert.ToString(data.Rows[i][4]).Trim(), out typeID);
                    }
                }
                //验证订单类型是否有效
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][5]).Trim()))
                {
                    if (Convert.ToString(data.Rows[i][5]).Trim() != "内部订单" && Convert.ToString(data.Rows[i][5]).Trim() != "外部订单" && Convert.ToString(data.Rows[i][5]).Trim() != "退货订单" && Convert.ToString(data.Rows[i][5]).Trim() != "外采订单")
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据订单类型有误\r\n";
                        continue;
                    }
                }
                //验证订单归属月是否为数字
                if (!IsNumber(data.Rows[i][6].ToString()))
                {
                    abnormalCount++;
                    msg += "第" + (i + 2) + "行数据订单归属月有误\r\n";
                    continue;

                }
                else if (data.Rows[i][6].ToString().Length > 6)
                {
                    abnormalCount++;
                    msg += "第" + (i + 2) + "行数据订单归属月长度有误\r\n";
                    continue;
                }
                //验证产地是否有效
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][7]).Trim()))
                {
                    if (Convert.ToString(data.Rows[i][7]).Trim() != "国产" && Convert.ToString(data.Rows[i][7]).Trim() != "进口")
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据产地有误\r\n";
                        continue;
                    }
                }

                ////验证类型是否有效
                //if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][8]).Trim()))
                //{
                //    if (Convert.ToString(data.Rows[i][8]).Trim() != "OER" && Convert.ToString(data.Rows[i][8]).Trim() != "REP")
                //    {
                //        abnormalCount++;
                //        msg += "第" + (i + 2) + "行数据类型有误\r\n";
                //        continue;
                //    }
                //}

                //验证载重指数是否为数字
                //if (!IsNumber(data.Rows[i][11].ToString()))
                //{
                //    abnormalCount++;
                //    msg += "第" + (i + 2) + "行数据载重指数有误\r\n";
                //    continue;
                //}

                string GoodsCode = Convert.ToString(data.Rows[i][14]).Trim();
                //马牌产品验证货品代码
                if (Convert.ToString(data.Rows[i][4]).Trim() == "马牌")
                {
                    if (GoodsCode.Length == 10)
                    {
                        if (GoodsCode.Substring(0, 1) != "0")
                        {
                            GoodsCode = "0" + GoodsCode;
                        }
                        else
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据货品代码有误\r\n";
                            continue;
                        }
                    }
                    else if (GoodsCode.Length < 10)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据货品代码有误\r\n";
                        continue;
                    }
                    else if (GoodsCode.Length > 11)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据货品代码有误\r\n";
                        continue;
                    }
                }

                //验证批次是否合法
                if (!IsNumber(data.Rows[i][15].ToString()))
                {
                    abnormalCount++;
                    msg += "第" + (i + 2) + "行数据批次有误\r\n";
                    continue;
                }
                else if (data.Rows[i][15].ToString().Length > 4)
                {
                    abnormalCount++;
                    msg += "第" + (i + 2) + "行数据批次长度有误\r\n";
                    continue;

                }
                //验证成本价
                if (!string.IsNullOrEmpty(data.Rows[i][16].ToString().Trim()))
                {
                    if (!isNumeric(data.Rows[i][16].ToString()))
                    {
                        string str = data.Rows[i][16].ToString().Trim();
                        str = str.Replace("_", "");
                        str = str.Replace("*", "");
                        if (!isNumeric(str))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据成本价有误\r\n";
                            continue;
                        }
                        data.Rows[i][16] = str;
                    }
                }
                else
                {
                    data.Rows[i][15] = 0;
                }
                //验证含税成本价
                if (!string.IsNullOrEmpty(data.Rows[i][17].ToString().Trim()))
                {
                    if (!isNumeric(data.Rows[i][17].ToString()))
                    {
                        string str = data.Rows[i][17].ToString().Trim();
                        str = str.Replace("_", "");
                        str = str.Replace("*", "");
                        if (!isNumeric(str))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据含税成本价有误\r\n";
                            continue;
                        }
                        data.Rows[i][17] = str;
                    }
                }
                else
                {
                    data.Rows[i][16] = 0;
                }
                //验证不含税成本价
                if (!string.IsNullOrEmpty(data.Rows[i][18].ToString().Trim()))
                {
                    if (!isNumeric(data.Rows[i][18].ToString()))
                    {
                        string str = data.Rows[i][18].ToString().Trim();
                        str = str.Replace("_", "");
                        str = str.Replace("*", "");
                        if (!isNumeric(str))
                        {
                            abnormalCount++;
                            msg += "第" + (i + 2) + "行数据不含税成本价有误\r\n";
                            continue;
                        }
                        data.Rows[i][18] = str;
                    }
                }
                else
                {
                    data.Rows[i][17] = 0;
                }
                //验证是否含税是否有效
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][19]).Trim()))
                {
                    if (Convert.ToString(data.Rows[i][19]).Trim() != "含税" && Convert.ToString(data.Rows[i][19]).Trim() != "不含税")
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据是否含税有误\r\n";
                        continue;
                    }
                }
                int OrderType = 0;
                switch (Convert.ToString(data.Rows[i][5]))
                {
                    case "内部订单":
                        OrderType = 0;
                        break;
                    case "外部订单":
                        OrderType = 1;
                        break;
                    case "退货订单":
                        OrderType = 2;
                        break;
                    case "外采订单":
                        OrderType = 3;
                        break;
                }
                ent.Add(new CargoFactoryOrderEntity
                {
                    HouseID = houseID,
                    HouseName = Convert.ToString(data.Rows[i][0]).Trim(),
                    FacOrderNo = Convert.ToString(data.Rows[i][1]).Trim(),
                    Source = Source,
                    SourceName = Convert.ToString(data.Rows[i][2]).Trim(),
                    TypeID = typeID,
                    TypeName = Convert.ToString(data.Rows[i][4]).Trim(),
                    OrderType = OrderType,
                    BelongMonth = Convert.ToString(data.Rows[i][6]).Trim(),
                    Born = Convert.ToString(data.Rows[i][7]) != "" ? Convert.ToString(data.Rows[i][7]) == "国产" ? "0" : "1" : "",
                    Assort = Convert.ToString(data.Rows[i][8]).Trim(),
                    Model = Convert.ToString(data.Rows[i][9]).Trim(),
                    Specs = Convert.ToString(data.Rows[i][10]).Trim(),
                    LoadIndex = Convert.ToString(data.Rows[i][11]).Trim(),
                    SpeedLevel = Convert.ToString(data.Rows[i][12]).Trim().Length > 1 ? Convert.ToString(data.Rows[i][12]).Trim().Substring(0, 1) : Convert.ToString(data.Rows[i][12]).Trim(),
                    Figure = Convert.ToString(data.Rows[i][13]).Trim(),
                    GoodsCode = GoodsCode,
                    Batch = Convert.ToString(data.Rows[i][15]).Trim(),
                    CostPrice = Math.Round(Convert.ToDouble(data.Rows[i][16]), 2),
                    TaxCostPrice = Math.Round(Convert.ToDouble(data.Rows[i][17]), 2),
                    NoTaxCostPrice = Math.Round(Convert.ToDouble(data.Rows[i][18]), 2),
                    WhetherTax = Convert.ToString(data.Rows[i][19]) == "含税" ? 1 : 0
                });
            }

            String json = JSON.Encode(ent);

            if (abnormalCount > 0)
            {
                import.Type = 1;
                import.Message = msg;
            }
            import.Result = true;
            import.Data = json;
            json = JSON.Encode(import);

            Response.Clear();
            Response.Write(json);
            Response.End();

        }
        /// <summary>
        /// 保存导入的数据
        /// </summary>
        public void SaveImportPriceData()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoFactoryOrderEntity> list = new List<CargoFactoryOrderEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "工厂订单成本价导入";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            CargoHouseEntity entity = new CargoHouseEntity();
            CargoHouseBus house = new CargoHouseBus();

            try
            {
                foreach (Hashtable row in rows)
                {
                    entity.HouseID = Convert.ToInt32(row["HouseID"]);
                    list.Add(new CargoFactoryOrderEntity
                    {
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        FacOrderNo = Convert.ToString(row["FacOrderNo"]).Trim(),
                        Source = Convert.ToInt32(row["Source"]),
                        //SourceName = Convert.ToString(row["SourceName"]).Trim(),
                        //ProductName = Convert.ToString(row["ProductName"]).Trim(),
                        TypeID = Convert.ToInt32(row["TypeID"]),
                        //TypeName = Convert.ToString(row["TypeName"]).Trim(),
                        OrderType = Convert.ToInt32(row["OrderType"]),
                        Model = Convert.ToString(row["Model"]).Trim(),
                        BelongMonth = Convert.ToString(row["BelongMonth"]).Trim(),
                        Born = Convert.ToString(row["Born"]),
                        Assort = Convert.ToString(row["Assort"]).Trim(),
                        Specs = Convert.ToString(row["Specs"]).Trim(),
                        LoadIndex = Convert.ToString(row["LoadIndex"]).Trim(),
                        SpeedLevel = Convert.ToString(row["SpeedLevel"]).Trim(),
                        Figure = Convert.ToString(row["Figure"]).Trim(),
                        GoodsCode = Convert.ToString(row["GoodsCode"]).Trim(),
                        Batch = Convert.ToString(row["Batch"]).Trim(),
                        //OrderNum = Convert.ToInt32(row["OrderNum"]),
                        //ReplyNumber = Convert.ToInt32(row["ReplyNumber"]),
                        //InPiece = 0,
                        //InCargoStatus = 0,
                        //SalePrice = Convert.ToDouble(row["SalePrice"]),
                        //UnitPrice = Convert.ToDouble(row["UnitPrice"]),
                        CostPrice = Convert.ToDouble(row["CostPrice"]),
                        TaxCostPrice = Convert.ToDouble(row["TaxCostPrice"]),
                        NoTaxCostPrice = Convert.ToDouble(row["NoTaxCostPrice"]),
                        //TradePrice = Convert.ToDouble(row["SalePrice"]),//门店价等于销售价
                        WhetherTax = Convert.ToInt32(row["WhetherTax"]) == 0 ? 0 : 1,
                        //SaleMoney = Convert.ToDouble(Convert.ToDouble(row["SalePrice"]) * Convert.ToInt32(row["ReplyNumber"])),//销售价*回告数量
                        //ReceiveName = Convert.ToString(row["ReceiveName"]).Trim(),
                        //ReceiveCity = Convert.ToString(row["ReceiveCity"]).Trim(),
                        //ReceiveMobile = Convert.ToString(row["ReceiveMobile"]).Trim(),
                        OP_Name = UserInfor.UserName.Trim(),
                        //SourceHouse = Convert.ToString(row["SourceHouse"]),
                        //CargoDepart = (house.QueryCargoHouse(entity)).CargoDepart
                    });
                }
                if (msg.Result)
                {
                    bus.SavePriceData(list, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 保存数据
        /// </summary>
        public void SaveData()
        {
            //获取json文件中的来源数据
            //Dictionary<int, string> dicScource = new Dictionary<int, string>();
            //var fileName = Server.MapPath("../Data/ProductSource.json");
            //using (StreamReader r = new StreamReader(fileName))
            //{
            //    string scourceJson = r.ReadToEnd();
            //    List<Scource> items = JsonConvert.DeserializeObject<List<Scource>>(scourceJson);
            //    foreach (var item in items)
            //    {
            //        if (!dicScource.ContainsKey(item.id))
            //        {
            //            dicScource.Add(item.id, item.text);
            //        }
            //    }
            //}
            CargoProductBus productBus = new CargoProductBus();
            Dictionary<int, string> dicScource = new Dictionary<int, string>();
            List<CargoProductSourceEntity> allProductSourcelist = new List<CargoProductSourceEntity>();
            allProductSourcelist = productBus.QueryAllProductSource();
            foreach (var item in allProductSourcelist)
            {
                if (!dicScource.ContainsKey(item.Source))
                {
                    dicScource.Add(item.Source, item.SourceName);
                }
            }

            CargoFactoryOrderEntity ent = new CargoFactoryOrderEntity();
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            string GoodsCode = Convert.ToString(Request["GoodsCode"].Trim());
            int OrderType = Convert.ToInt32(Request["OrderType"].Trim());
            int HouseID = Convert.ToInt32(Request["HouseID"].Trim());
            string BelongMonth = Convert.ToString(Request["Date"].Trim());
            string Born = Convert.ToString(Request["Born"].Trim());
            string Assort = Convert.ToString(Request["Assort"].Trim());
            string Specs = Convert.ToString(Request["Specs"].Trim());
            string Figure = Convert.ToString(Request["Figure"].Trim());
            string LoadIndex = Convert.ToString(Request["LoadIndex"].Trim());
            string SpeedLevel = Convert.ToString(Request["SpeedLevel"].Trim());
            string year = BelongMonth.Substring(0, 4);
            string month = BelongMonth.Substring(4, 2);
            string FacOrderNo = Convert.ToString(Request["FacOrderNo"].Trim());
            string TypeName = Convert.ToString(Request["TypeName"].Trim());
            string TypeID = Convert.ToString(Request["TypeID"].Trim());
            string ProductCode = Convert.ToString(Request["ProductCode"].Trim());

            #region 数据验证
            //马牌产品验证货品代码
            if (TypeName == "马牌")
            {
                if (GoodsCode.Length == 10)
                {
                    if (GoodsCode.Substring(0, 1) != "0")
                    {
                        GoodsCode = "0" + GoodsCode;
                    }
                    else
                    {
                        msg.Result = false;
                        msg.Message = "货品代码有误";
                    }
                }
                else if (GoodsCode.Length < 10)
                {
                    msg.Result = false;
                    msg.Message = "货品代码有误";
                }
                else if (GoodsCode.Length > 11)
                {
                    msg.Result = false;
                    msg.Message = "货品代码有误";
                }
                if (!msg.Result)
                {
                    Response.Write(JSON.Encode(msg));
                    return;
                }
            }
            //验证数据是否已有基础价格
            if (TypeName == "优科豪马")
            {
                //外部订单与外采订单不限制匹配价格
                if (OrderType != 3 && OrderType != 1)
                {
                    DataTable ProductBasicDt = new DataTable();
                    List<int> HouseIDList = new List<int>();
                    HouseIDList.Add(HouseID);
                    List<int> BelongMonthList = new List<int>();
                    BelongMonthList.Add(Convert.ToInt32(BelongMonth));
                    if (HouseIDList.Count > 0)
                    {
                        CargoProductBasicPriceBus basicPriceBus = new CargoProductBasicPriceBus();
                        ProductBasicDt = basicPriceBus.QueryProductSpecDate(new CargoProductEntity { });
                    }

                    DataRow[] rows = ProductBasicDt.Select("TypeID =" + Convert.ToInt32(Request["TypeID"].Trim()) + " and GoodsCode='" + GoodsCode + "' and Specs='" + Specs + "' and Figure='" + Figure + "' and LoadIndex='" + LoadIndex + "' and SpeedLevel='" + SpeedLevel + "'");

                    if (rows.Count() <= 0)
                    {
                        msg.Result = false;
                        msg.Message = "基础规格不存在";
                    }
                }
            }
            #endregion
            if (msg.Result)
            {
                LogEntity log = new LogEntity();
                log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                log.Moudle = "订单管理";
                log.NvgPage = "工厂订单导入";
                log.Status = "0";
                log.UserID = UserInfor.LoginName.Trim();
                String id = Request["ID"].ToString();
                try
                {
                    CargoOrderBus orderBus = new CargoOrderBus();
                    CargoHouseBus house = new CargoHouseBus();
                    string ProductName = Convert.ToString(Request["ProductName"].Trim());
                    if (string.IsNullOrEmpty(ProductName))
                    {
                        string CargoDepart = (house.QueryCargoHouse(new CargoHouseEntity { HouseID = HouseID })).CargoDepart;
                        if (!string.IsNullOrEmpty(CargoDepart))
                        {
                            ProductName = CargoDepart;
                        }
                        else
                        {
                            msg.Result = false;
                            msg.Message = "无仓库部门请联系IT";
                            Response.Write(JSON.Encode(msg));
                            return;
                        }
                    }
                    if ((TypeID.Equals("34") || TypeID.Equals("345")) && orderBus.IsExistBarcodeData(FacOrderNo) <= 0)
                    {
                        TimeSpan ts = DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0);
                        string tms = Convert.ToInt64(ts.TotalSeconds).ToString();
                        string sign = string.Empty;
                        string appKey = Common.GetContiappKey();
                        string noise = Common.GetContinoise();
                        string appSecret = Common.GetContiappSecret();
                        string ss = "appKey=" + appKey + "&noise=" + noise + "&timestamp=" + tms + "&vehicleNo=" + FacOrderNo + "&appSecret=" + appSecret;
                        //MD5加密
                        using (MD5 md5Hash = MD5.Create())
                        {
                            sign = Common.GetMd5Hash(md5Hash, ss);
                        }
                        NameValueCollection nvc = new NameValueCollection();
                        nvc.Add("appKey", appKey);
                        nvc.Add("noise", noise);
                        nvc.Add("timestamp", tms);
                        nvc.Add("sign", sign);
                        nvc.Add("vehicleNo", FacOrderNo);

                        string returnJson = wxHttpUtility.PostForm("https://contiid.continental-tires.cn/api/2.0/TTP/getRDCout", nvc, null);

                        JavaScriptSerializer js = new JavaScriptSerializer();
                        if (returnJson.IndexOf("1000") >= 0)
                        {
                            RetunBarcodeJson returnList = js.Deserialize<RetunBarcodeJson>(returnJson);

                            string code = returnList.code;
                            switch (code)
                            {
                                case "1000":
                                    if (returnList.data.Count() <= 0)
                                    {
                                        msg.Message += FacOrderNo + " 未获取到轮胎条码";
                                        break;
                                    }
                                    List<data> checkindata = returnList.data;
                                    msg.Result = true;
                                    List<CargoFactoryOrderBarcodeEntity> entityList = new List<CargoFactoryOrderBarcodeEntity>();
                                    log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                                    log.Moudle = "订单管理";
                                    log.Status = "0";
                                    log.NvgPage = "来货订单导入";
                                    log.UserID = UserInfor.LoginName.Trim();
                                    log.Operate = "A";

                                    foreach (var item in checkindata)
                                    {
                                        string[] description = item.Description.Split(' ');
                                        string figure = string.Empty;
                                        for (int i = 2; i < description.Length; i++)
                                        {
                                            figure += description[i];
                                        }
                                        string goodsCode = string.Empty;
                                        if (item.material.Length > 6)
                                        {
                                            goodsCode = item.material + "0000";
                                        }
                                        else if (item.material.Length == 5)
                                        {
                                            goodsCode = "0" + item.material + "0000";
                                        }
                                        string loadSpeed = description[1].Replace("(", "").Replace(")", "");
                                        entityList.Add(new CargoFactoryOrderBarcodeEntity
                                        {
                                            VehicleNo = FacOrderNo,
                                            Barcode = item.barcode,
                                            RDC = item.RDC,
                                            GoodsCode = goodsCode,
                                            Batch = item.DOT,
                                            Description = item.Description,
                                            OutTime = Convert.ToDateTime(item.outtime),
                                            Specs = description[0],
                                            Figure = figure,
                                            LoadIndex = loadSpeed.Substring(0, loadSpeed.Length - 1),
                                            SpeedLevel = loadSpeed.Substring(loadSpeed.Length - 1)
                                        });
                                    }
                                    orderBus.InsertBarcodeData(entityList, log);
                                    break;
                            }
                        }
                    }
                    ent.FacOrderNo = FacOrderNo;
                    //ent.FacName = Convert.ToString(Request["FacName"]);
                    ent.OrderType = OrderType;
                    ent.HouseID = HouseID;
                    ent.Source = Convert.ToInt32(Request["Source"].Trim());
                    ent.SourceName = dicScource[Convert.ToInt32(Request["Source"].Trim())].Trim();
                    ent.ProductName = ProductName;
                    ent.BelongMonth = BelongMonth;
                    ent.Born = Born;
                    ent.Assort = Assort;
                    ent.TypeID = Convert.ToInt32(Request["TypeID"].Trim());
                    ent.TypeName = TypeName;
                    ent.Model = Convert.ToString(Request["Model"].Trim());
                    ent.Specs = Specs;
                    ent.LoadIndex = LoadIndex;
                    ent.SpeedLevel = SpeedLevel;
                    ent.Figure = Figure;
                    ent.GoodsCode = GoodsCode;
                    ent.ProductCode = ProductCode;
                    ent.Batch = Convert.ToString(Request["Batch"].Trim());
                    ent.OrderNum = Convert.ToInt32(Request["OrderNum"].Trim());
                    ent.ReplyNumber = Convert.ToInt32(Request["ReplyNumber"].Trim());
                    //ent.InPiece = Convert.ToInt32(Request["InPiece"].Trim());
                    //ent.InCargoStatus = Convert.ToInt32(Request["OrderType"]) == 0 ? 0 : 1;
                    ent.UnitPrice = Convert.ToDouble(Request["UnitPrice"].Trim());
                    //ent.SalePrice = Convert.ToDouble(Request["SalePrice"].Trim());
                    ent.TradePrice = Convert.ToDouble(Request["TradePrice"].Trim());//门店价
                    ent.InHousePrice = Convert.ToDouble(Request["InHousePrice"].Trim());//进仓价
                    ent.SalePrice = Convert.ToDouble(Math.Ceiling(ent.InHousePrice * 1.009));//小程序价
                    //ent.CostPrice = Convert.ToDouble(Request["CostPrice"]);
                    // ent.TradePrice = Convert.ToDouble(Request["SalePrice"].Trim());
                    ent.WhetherTax = Convert.ToInt32(Request["WhetherTax"].Trim());
                    ent.SaleMoney = ent.SalePrice * Convert.ToInt32(Request["ReplyNumber"].Trim());
                    ent.ReceiveName = Convert.ToString(Request["ReceiveName"].Trim());
                    ent.ReceiveCity = Convert.ToString(Request["ReceiveCity"].Trim());
                    ent.ReceiveMobile = Convert.ToString(Request["ReceiveMobile"].Trim());
                    ent.SourceHouse = Convert.ToString(Request["SourceHouse"].Trim());
                    ent.HLYReturnID = Convert.ToString(Request["HLYReturnID"].Trim());
                    ent.BelongDepart = Convert.ToString(Request["BelongDepart"].Trim());
                    ent.SpecsType = Convert.ToString(Request["SpecsType"].Trim());
                    ent.BusinessID = Convert.ToString(Request["BusinessID"].Trim());
                    //ent.ReceiveCity = Convert.ToString(Request["ReceiveCity"].Trim());

                    ent.Supplier = Convert.ToString(Request["Supplier"].Trim());//供应商信息

                    CargoClientBus client = new CargoClientBus();
                    CargoClientEntity clientData = client.QueryCargoClientList(new CargoClientEntity() { ClientName = ent.Supplier, ClientType = "4" }).FirstOrDefault();
                    if (clientData == null || ent.Supplier != clientData.ClientName)
                    {
                        msg.Result = false;
                        msg.Message = "无供应商信息";
                        Response.Write(JSON.Encode(msg));
                        return;
                    }
                    ent.Supplier = clientData.ClientName;
                    ent.SuppClientNum = clientData.ClientNum.ToString();
                    ent.SupplierAddress = clientData.Address;

                    string Company = "";
                    if (!string.IsNullOrEmpty(UserInfor.DepCode))
                    {
                        if (UserInfor.DepCode.Length > 1)
                        {
                            if (UserInfor.DepCode.Substring(0, 2) == "B1")
                            {
                                Company = "0";
                            }
                            else if (UserInfor.DepCode.Substring(0, 2) == "B2")
                            {
                                Company = "2";
                            }
                            else
                            {
                                Company = "1";
                            }
                        }
                        else
                        {
                            Company = "1";
                        }
                    }
                    else
                    {
                        Company = "1";
                    }
                    //if (UserInfor.DepCode.Substring(0, 2) == "B1")
                    //{
                    //    Company = "0";
                    //}
                    //else if (UserInfor.DepCode.Substring(0, 2) == "B2")
                    //{
                    //    Company = "2";
                    //}
                    //else
                    //{
                    //    Company = "1";
                    //}
                    ent.Company = Company;
                    ent.OP_Name = UserInfor.UserName.Trim();
                    CargoHouseEntity houseEntity = house.QueryCargoHouse(new CargoHouseEntity { HouseID = HouseID });
                    List<HLYAddReceiptDetails> HLYAddReceiptDetailsList = new List<HLYAddReceiptDetails>();
                    HLYAddReceiptDetailsList.Add(new HLYAddReceiptDetails
                    {
                        Specs = Specs,
                        Figure = Figure,
                        Model = Convert.ToString(Request["Model"].Trim()),
                        GoodsCode = GoodsCode,
                        LoadIndex = LoadIndex,
                        SpeedLevel = SpeedLevel,
                        Born = Born,
                        Assort = Assort,
                        Brand = TypeName,
                        SupplierCode = "狄乐汽服",
                        ProductName = TypeName + "轮胎",
                        QtyInUint = 1,
                        BoxType = "S01",
                        Unit = "条",
                        QtyDelivery = Convert.ToInt32(Request["ReplyNumber"].Trim()),
                        CargoTypeID = Convert.ToInt32(TypeID),
                        CargoTypeName = TypeName,
                        SpecsType = ent.SpecsType
                    });
                    HLYAddReceipt addReceipt = new HLYAddReceipt();
                    addReceipt.DepartmentID = "B0002";
                    addReceipt.BusinessID = "151";
                    addReceipt.CustomerCode = "狄乐汽服";
                    addReceipt.CargoHouseID = HouseID;
                    //addReceipt.FactoryID = "";
                    addReceipt.HouseCode = houseEntity.HouseCode;
                    addReceipt.HouseName = houseEntity.Name;
                    addReceipt.SupplierDeliveryNo = FacOrderNo;
                    addReceipt.SupplierCode = "DLQF";
                    //addReceipt.SupplierContact = "";
                    //addReceipt.SupplierPhone = "";
                    //addReceipt.CarNumber = "";
                    //addReceipt.DriverName = "";
                    //addReceipt.DriverPhone = "";
                    //addReceipt.Remark = "";
                    addReceipt.BelongMonth = BelongMonth;
                    addReceipt.BelongDepart = Convert.ToString(Request["BelongDepart"].Trim()).Equals("0") ? "RE" : "OE";
                    addReceipt.Status = 1;
                    addReceipt.CreateBy = UserInfor.UserName;
                    addReceipt.ReceiptDatePlan = DateTime.Now.ToString("yyyy-MM-dd");
                    addReceipt.CreateBy = UserInfor.UserName;
                    if (!string.IsNullOrEmpty(id))
                    {
                        addReceipt.IsSupCode = true;
                    }
                    addReceipt.details = HLYAddReceiptDetailsList;
                    string jsonString = JsonConvert.SerializeObject(addReceipt);
                    if (!string.IsNullOrEmpty(id))
                    {
                        //东平城配仓、广州仓库
                        //if (ent.HouseID.Equals(9))
                        //{
                        //    ent.HLYReturnID = Convert.ToString(Request["HLYReturnID"]);
                        //    if (OrderType.Equals(0) || OrderType.Equals(2))
                        //    {
                        //        JavaScriptSerializer js = new JavaScriptSerializer();
                        //        string hlyres = wxHttpUtility.SendHttpRequest(Common.GetHLYAPI() + "/api/CargoInterface/DeleteDetails", "{\"ID\": \"" + ent.HLYReturnID + "\"}", "application/json");
                        //        HLYAddReceiptReturn HLYDelReturn = js.Deserialize<HLYAddReceiptReturn>(hlyres);
                        //        if (!HLYDelReturn.State)
                        //        {
                        //            msg.Result = false;
                        //            msg.Message += $"写入好来运接口失败{HLYDelReturn.Errmsg}\r\n";
                        //            goto Error;
                        //        }
                        //        hlyres = wxHttpUtility.SendHttpRequest(Common.GetHLYAPI() + "/api/CargoInterface/AddReceipt", jsonString, "application/json");
                        //        HLYAddReceiptReturn HLYReturn = js.Deserialize<HLYAddReceiptReturn>(hlyres);
                        //        if (!HLYReturn.State)
                        //        {
                        //            msg.Result = false;
                        //            msg.Message += $"写入好来运接口失败{HLYReturn.Errmsg}\r\n";
                        //            goto Error;
                        //        }
                        //        var returnList = HLYReturn.data.details.Where(x => x.Specs.Equals(HLYAddReceiptDetailsList[0].Specs) && x.Figure.Equals(HLYAddReceiptDetailsList[0].Figure) && x.Model.Equals(HLYAddReceiptDetailsList[0].Model) && x.GoodsCode.Equals(HLYAddReceiptDetailsList[0].GoodsCode) && x.Born.Equals(HLYAddReceiptDetailsList[0].Born) && x.BelongDepart.Equals(addReceipt.BelongDepart) && x.BelongMonth.Equals(addReceipt.BelongMonth) && x.SpecsType.Equals(HLYAddReceiptDetailsList[0].SpecsType)).ToList();
                        //        if (returnList.Count() > 0)
                        //        {
                        //            ent.HLYReturnID = returnList[0].ID;
                        //        }
                        //    }
                        //}
                        //else { ent.HLYReturnID = Convert.ToString(Request["HLYReturnID"]); }

                        log.Operate = "U";
                        ent.ID = Convert.ToInt32(id);
                        bus.UpdateFactoryOrderData(ent, log);
                        msg.Result = true;
                        if (string.IsNullOrEmpty(msg.Message))
                        {
                            msg.Message = "成功";
                        }
                    }
                    else
                    {
                        //东平城配仓、广州仓库
                        //if (ent.HouseID.Equals(9))
                        //{
                        //    if (OrderType.Equals(0) || OrderType.Equals(2))
                        //    {
                        //        Common.WriteTextLog("插入新系统数据01");
                        //        JavaScriptSerializer js = new JavaScriptSerializer();
                        //        string hlyres = wxHttpUtility.SendHttpRequest(Common.GetHLYAPI() + "/api/CargoInterface/AddReceipt", jsonString, "application/json");
                        //        Common.WriteTextLog("插入新系统数据02"+ hlyres);
                        //        HLYAddReceiptReturn HLYReturn = js.Deserialize<HLYAddReceiptReturn>(hlyres);
                        //        if (!HLYReturn.State)
                        //        {
                        //            msg.Result = false;
                        //            msg.Message += $"写入好来运接口失败{HLYReturn.Errmsg}\r\n";
                        //            goto Error;
                        //        }
                        //        ent.HLYReturnID = HLYReturn.data.details[0].ID;
                        //    }
                        //}
                        log.Operate = "A";
                        bus.InsertFactoryOrderData(ent, log);
                        //string result = wxHttpUtility.SendHttpRequest(Common.GetHLYAPI() + "/api/cargo/sync/ReceiptFromCargo?SupplierDeliveryNo=" + FacOrderNo, "");
                        //Hashtable hlyResult = (Hashtable)JSON.Decode(result);
                        //if (hlyResult["State"].ToString().ToUpper().Equals("FALSE"))
                        //{
                        //    msg.Message = "同步到好来运失败：" + hlyResult["Errcode"] + hlyResult["Errmsg"];
                        //}
                        msg.Result = true;
                        if (string.IsNullOrEmpty(msg.Message))
                        {
                            msg.Message = "成功";
                        }
                    }
                }
                catch (ApplicationException ex)
                {
                    msg.Message = ex.Message;
                    msg.Result = false;
                }

            }
        Error:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }

        /// <summary>
        /// 删除数据
        /// </summary>
        public void DeleteData()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoFactoryOrderEntity> list = new List<CargoFactoryOrderEntity>();
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "价格管理";
            log.Status = "0";
            log.NvgPage = "基础价格导入";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoFactoryOrderEntity
                    {
                        ID = Convert.ToInt32(row["ID"]),
                        FacOrderNo = Convert.ToString(row["FacOrderNo"]),
                        OrderType = Convert.ToInt32(row["OrderType"]),
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        TypeID = Convert.ToInt32(row["TypeID"]),
                        HLYReturnID = Convert.ToString(row["HLYReturnID"])
                    });
                }
                bus.DeleteFactoryOrderData(list, log);

                //foreach (var item in list)
                //{
                //    if (string.IsNullOrEmpty(item.HLYReturnID))
                //    {
                //        continue;
                //    }
                //    if (item.HouseID.Equals(9) || item.HouseID.Equals(93))
                //    {

                //        JavaScriptSerializer js = new JavaScriptSerializer();
                //        string hlyres = wxHttpUtility.SendHttpRequest(Common.GetHLYAPI() + "/api/CargoInterface/DeleteDetails", "{\"ID\": \"" + item.HLYReturnID + "\"}", "application/json");
                //        HLYAddReceiptReturn HLYDelReturn = js.Deserialize<HLYAddReceiptReturn>(hlyres);
                //        if (!HLYDelReturn.State)
                //        {
                //            msg.Result = false;
                //            msg.Message += $"写入好来运接口失败{HLYDelReturn.Errmsg}\r\n";
                //            goto Error;
                //        }
                //    }
                //}
                //var FacOrderNoList = list.GroupBy(x => x.FacOrderNo).ToList();
                //foreach (var item in FacOrderNoList)
                //{
                //    string result = wxHttpUtility.SendHttpRequest(Common.GetHLYAPI() + "/api/cargo/sync/DeleteFromCargo?SupplierDeliveryNo=" + item.Key, "");
                //    Hashtable hlyResult = (Hashtable)JSON.Decode(result);
                //    if (hlyResult["State"].ToString().ToUpper().Equals("FALSE"))
                //    {
                //        msg.Message += item.Key + "同步到好来运失败：" + hlyResult["Errcode"] + hlyResult["Errmsg"] + "\r\n";
                //    }
                //}
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
        Error:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 保存批量入库
        /// </summary>
        public void saveLotInCargo()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            string json = Request["data"];
            string ContainerID = Convert.ToString(Request["LOTContainer"]);
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有入库数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            CargoHouseBus bus = new CargoHouseBus();
            CargoProductEntity ent = new CargoProductEntity();
            CargoProductBus pbus = new CargoProductBus();
            CargoFactoryOrderBus fbus = new CargoFactoryOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "工厂订单导入";
            log.Operate = "U";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();

            try
            {
                foreach (Hashtable row in GridRows)
                {
                    List<CargoContainerGoodsEntity> entDest = new List<CargoContainerGoodsEntity>();
                    ent.ProductName = Convert.ToString(row["ProductName"]);
                    ent.TypeID = Convert.ToInt32(row["TypeID"]);
                    ent.Model = Convert.ToString(row["Model"]);
                    ent.GoodsCode = Convert.ToString(row["GoodsCode"]);
                    ent.Figure = Convert.ToString(row["Figure"]);
                    ent.Specs = Convert.ToString(row["Specs"]);
                    string str = ent.Specs.Substring(ent.Specs.IndexOf("/") + 1, ent.Specs.Length - ent.Specs.IndexOf("/") - 1);
                    char[] strCharArr = str.ToCharArray();
                    bool type = false;
                    string meridian = null;
                    for (int i = 0; i < strCharArr.Length; i++)
                    {
                        if (Common.IsUpperLetter(strCharArr[i].ToString()))
                        {
                            type = true;
                            meridian += strCharArr[i].ToString();
                        }
                        else
                        {
                            if (type)
                            {
                                break;
                            }
                        }
                    }
                    ent.Meridian = "R";
                    if (ent.Specs.Contains("/"))
                    {

                        // 使用正则表达式匹配所有数字
                        MatchCollection matches = Regex.Matches(ent.Specs, @"\d+");

                        // 存储提取的数字
                        if (matches.Count >= 3)
                        {
                            ent.TreadWidth = Convert.ToInt32(matches[0].Value);
                            ent.FlatRatio = Convert.ToInt32(matches[1].Value);
                            ent.HubDiameter = Convert.ToInt32(matches[2].Value);

                        }
                        else if (matches.Count == 2)
                        {
                            ent.TreadWidth = Convert.ToInt32(matches[0].Value);
                            ent.FlatRatio = 0;
                            ent.HubDiameter = Convert.ToInt32(matches[1].Value);
                        }


                        //ent.TreadWidth = Convert.ToInt32(ent.Specs.Substring(ent.Specs.IndexOf("/") - 3, 3));
                        //ent.FlatRatio = Convert.ToInt32(ent.Specs.Substring(ent.Specs.IndexOf("/") + 1, ent.Specs.IndexOf(meridian) - ent.Specs.IndexOf("/") - 1));
                        //ent.HubDiameter = Convert.ToInt32(ent.Specs.Substring(ent.Specs.IndexOf(meridian) + meridian.Length, ent.Specs.Length - ent.Specs.IndexOf(meridian) - meridian.Length));
                        //ent.HubDiameter = Convert.ToInt32(Regex.Replace(ent.Specs.Substring(ent.Specs.IndexOf(meridian) + meridian.Length, ent.Specs.Length - ent.Specs.IndexOf(meridian) - meridian.Length), "[a-z]", "", RegexOptions.IgnoreCase));
                    }
                    ent.ProductCode = Convert.ToString(row["ProductCode"]);
                    //查询基础规格获取产品名称
                    ent.GoodsName = pbus.GetProductSpecEntity(new CargoProductSpecEntity { ProductCode = ent.ProductCode }).ProductName;

                    ent.LoadIndex = Convert.ToString(row["LoadIndex"]);
                    ent.SpeedLevel = Convert.ToString(row["SpeedLevel"]);
                    ent.SpeedMax = Common.ReturnTyreSpeed(Server.MapPath("~/Data/TyreSpeedLevelExtend.json"), ent.SpeedLevel);
                    ent.Size = "";
                    ent.UnitPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDecimal(row["UnitPrice"]);
                    ent.Numbers = string.IsNullOrEmpty(Convert.ToString(row["ReplyNumber"])) ? 0 : Convert.ToInt32(row["ReplyNumber"]);
                    //ent.Numbers = string.IsNullOrEmpty(Convert.ToString(row["InPiece"])) ? 0 : Convert.ToInt32(row["InPiece"]);
                    ent.CostPrice = string.IsNullOrEmpty(Convert.ToString(row["CostPrice"])) ? 0 : Convert.ToDecimal(row["CostPrice"]);
                    ent.SalePrice = string.IsNullOrEmpty(Convert.ToString(row["SalePrice"])) ? 0 : Convert.ToDecimal(row["SalePrice"]);
                    ent.TradePrice = string.IsNullOrEmpty(Convert.ToString(row["TradePrice"])) ? 0 : Convert.ToDecimal(row["TradePrice"]);
                    ent.Source = Convert.ToString(row["Source"]);
                    ent.Born = Convert.ToString(row["Born"]);
                    ent.Assort = Convert.ToString(row["Assort"]);
                    ent.SourceOrderNo = Convert.ToString(row["FacOrderNo"]);
                    ent.BelongMonth = Convert.ToString(row["BelongMonth"]);
                    ent.HouseID = UserInfor.HouseID;//用户所属仓库ID
                    ent.Batch = Convert.ToString(row["Batch"]);
                    //周期处理
                    ent.BatchYear = 0;
                    ent.BatchWeek = 0;
                    if (!string.IsNullOrEmpty(ent.Batch) && ent.Batch.Length == 4)
                    {
                        ent.BatchYear = Convert.ToInt32(ent.Batch.Substring(2, 2));
                        if (Convert.ToInt32(ent.Batch.Substring(0, 1)) != 0)
                        {
                            ent.BatchWeek = Convert.ToInt32(ent.Batch.Substring(0, 2));
                        }
                        else
                        {
                            ent.BatchWeek = Convert.ToInt32(ent.Batch.Substring(1, 1));
                        }
                    }
                    ent.BelongDepart = Convert.ToString(row["BelongDepart"]);
                    ent.SpecsType = Convert.ToString(row["SpecsType"]);
                    ent.SuppClientNum = string.IsNullOrEmpty(Convert.ToString(row["SuppClientNum"])) ? 0 : int.TryParse(Convert.ToString(row["SuppClientNum"]), out _) ? Convert.ToInt64(row["SuppClientNum"]) : 0;
                    ent.Company = "0";
                    ent.Supplier = Convert.ToString(row["Supplier"]);
                    ent.SupplierAddress = Convert.ToString(row["SupplierAddress"]);

                    if (ent.BelongMonth.Length.Equals(6))
                    {
                        string proYear, proMonth;
                        proYear = ent.BelongMonth.Substring(0, 4);
                        proMonth = ent.BelongMonth.Substring(4, 2);
                        CargoProductBasicPriceEntity basicPriceEntity = new CargoProductBasicPriceEntity();
                        basicPriceEntity.HouseID = ent.HouseID;
                        basicPriceEntity.TypeID = ent.TypeID;
                        basicPriceEntity.Born = string.IsNullOrEmpty(ent.Born) ? -1 : Convert.ToInt32(ent.Born);
                        basicPriceEntity.Assort = ent.Assort;
                        basicPriceEntity.GoodsCode = ent.GoodsCode;
                        basicPriceEntity.Specs = ent.Specs;
                        basicPriceEntity.Figure = ent.Figure;
                        basicPriceEntity.LoadIndex = ent.LoadIndex.ToString();
                        basicPriceEntity.SpeedLevel = ent.SpeedLevel;
                        basicPriceEntity.ProYear = proYear;
                        basicPriceEntity.ProMonth = proMonth;

                        //CargoProductBasicPriceEntity basicPrice = bus.QueryProductBasicPrice(basicPriceEntity);
                        //if (basicPrice != null && basicPrice.PID != 0)
                        //{
                        //    ent.FinalCostPrice = Convert.ToDecimal(basicPrice.FinalCostPrice);
                        //    ent.CostPrice = Convert.ToDecimal(basicPrice.CostPrice);
                        //    ent.TaxCostPrice = Convert.ToDecimal(basicPrice.TaxCostPrice);
                        //    ent.NoTaxCostPrice = Convert.ToDecimal(basicPrice.NoTaxCostPrice);
                        //    if (!basicPrice.TradePrice.Equals(0))
                        //    {
                        //        ent.TradePrice = Convert.ToDecimal(basicPrice.TradePrice);
                        //        ent.SalePrice = Convert.ToDecimal(basicPrice.TradePrice);
                        //    }
                        //}
                        //else
                        //{
                        ent.FinalCostPrice = 0.00M;
                        //ent.CostPrice = 0.00M;
                        ent.TaxCostPrice = 0.00M;
                        ent.NoTaxCostPrice = 0.00M;
                        //ent.UnitPrice = 0.00M;
                        //}
                    }

                    log.Operate = "A";
                    long pid = fbus.AddCargoProduct(ent, log);
                    if (pid != 0)
                    {
                        CargoFactoryOrderEntity frent = new CargoFactoryOrderEntity();
                        frent.ProductID = pid.ToString();
                        frent.ID = Convert.ToInt32(row["ID"]);
                        frent.InPiece = ent.Numbers;
                        log.Operate = "U";
                        fbus.UpdateProductID(frent, log);

                        if (Convert.ToString(row["InCargoStatus"]).Equals("1")) { continue; }
                        //CargoContainerGoodsEntity good = bus.IsExistCargoContainerGoods(new CargoContainerGoodsEntity { ProductID = Convert.ToInt64(row["TypeID"]) });
                        //if (!good.ID.Equals(0))
                        //{
                        //    continue;
                        //}
                        entDest.Add(new CargoContainerGoodsEntity
                        {
                            TypeID = Convert.ToInt32(row["TypeID"]),
                            ContainerID = Convert.ToInt32(ContainerID),//目标货位ID
                            ProductID = pid,
                            Model = Convert.ToString(row["Model"]),
                            Specs = Convert.ToString(row["Specs"]),
                            Figure = Convert.ToString(row["Figure"]),
                            Batch = Convert.ToString(row["Batch"]),
                            InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString(),//入库单号
                            InHouseType = Convert.ToString(row["Source"]).Equals("18") ? "4" : Convert.ToString(row["OrderType"]).Equals("2") ? "1" : "0",
                            Piece = Convert.ToInt32(row["ReplyNumber"])
                        });

                        //仓库同步缓存(缓存的旧的仓库信息)
                        CargoProductEntity syncProduct = bus.SyncTypeProduct(pid.ToString());
                        //34 马牌  1 同步马牌  2 同步全部品牌
                        if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                        }
                        bus.SaveProductInCargo(entDest, log);
                    }
                }
                msg.Message = "成功";
                msg.Result = true;
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }

            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 保存来货订单照片
        /// </summary>
        public void SaveFactoryPic()
        {
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "来货导入";
            log.UserID = UserInfor.LoginName.Trim();
            log.Status = "0";
            log.Operate = "A";
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            List<CargoFactoryFileEntity> result = new List<CargoFactoryFileEntity>();
            for (int i = 0; i < Request.Files.Count; i++)
            {
                string FileType = string.Empty;
                if (Request.Files.AllKeys[i].Equals("InsurePic")) { FileType = "0"; }
                string imgName = string.Empty;
                string imgPath = string.Empty;
                HttpPostedFile imgFile = Request.Files[i];
                if (string.IsNullOrEmpty(imgFile.FileName)) { continue; }
                Common.SaveUserPic(Request.Files[i], ref imgName, ref imgPath);
                CargoFactoryFileEntity f = new CargoFactoryFileEntity();
                f.FacOrderNo = Convert.ToString(Request["FacOrderNo"]);
                f.FileName = imgName;
                f.FilePath = imgPath;
                f.FileType = FileType;
                f.HouseID = string.IsNullOrEmpty(Convert.ToString(Request["HouseID"])) ? UserInfor.HouseID : Convert.ToInt32(Request["HouseID"]);
                result.Add(f);
            }
            try
            {
                if (result.Count > 0)
                {
                    CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
                    bus.AddCargoFactoryFile(result, log);
                    var ID = string.IsNullOrEmpty(Convert.ToString(Request["ID"])) ? 0 : Convert.ToInt64(Request["ID"]);
                    bus.UpdateFacActualArrivalTime(new CargoFactoryOrderEntity { ID = ID });
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        public void QueryCargoFactoryFile()
        {
            CargoFactoryFileEntity queryEntity = new CargoFactoryFileEntity();
            queryEntity.FacOrderNo = Convert.ToString(Request["FacOrderNo"]);
            queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            List<CargoFactoryFileEntity> list = bus.QueryCargoFactoryFile(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 移库方法集合
        /// <summary>
        /// 保存移库订单
        /// </summary>
        public void AddMoveOrderData()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }

            CargoFactoryOrderBus cargoFactory = new CargoFactoryOrderBus();
            CargoHouseBus house = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "移库订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            log.Status = "0";
            CargoOrderBus bus = new CargoOrderBus(log.UserID, UserInfor.UserName, log.IPAddress);
            CargoMoveOrderEntity ent = new CargoMoveOrderEntity();
            List<CargoMoveOrderGoodsEntity> entDest = new List<CargoMoveOrderGoodsEntity>();
            List<CargoFactoryOrderEntity> factoryList = new List<CargoFactoryOrderEntity>();
            #region 赋值
            ent.MoveNo = "T" + DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumInt().ToString(); //生成最新顺序订单号
            ent.MoveNum = Convert.ToInt32(Request["MoveNum"]);
            ent.MoveStatus = "0";
            ent.OldHouseID = UserInfor.HouseID.ToString();
            ent.OldHouseName = UserInfor.HouseName;//原仓库
            ent.NewHouseID = Convert.ToInt32(Request["HouseID"]);
            ent.NewHouseName = Convert.ToString(Request["HouseName"]);
            ent.NewAreaID = Convert.ToInt32(Request["NewAreaID"]);
            ent.Memo = Convert.ToString(Request["Memo"]);
            ent.OPID = UserInfor.LoginName;
            ent.IsSaveIncomming = string.IsNullOrEmpty(Convert.ToString(Request["IsSaveIncomming"])) ? "0" : Convert.ToString(Request["IsSaveIncomming"]);
            ent.LogisID = string.IsNullOrEmpty(Convert.ToString(Request["LogisID"])) ? 0 : Convert.ToInt32(Request["LogisID"]);
            if (ent.OldHouseName == "东莞仓库" || ent.OldHouseName == "揭阳主仓库" || ent.OldHouseName == "梅州主仓库")
            {
                ent.LogisID = 62;
            }
            if (ent.LogisID == 0)
            {
                ent.LogisID = 34;
            }
            int pieceSum = 0;
            foreach (Hashtable row in GridRows)
            {
                CargoContainerGoodsEntity cont = house.QueryCargoContainerGoods(new CargoContainerGoodsEntity { ID = Convert.ToInt64(row["ID"]) });
                int mP = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);
                if (mP > cont.Piece)//表示全部出库
                {
                    msg.Message = "产品ID：" + Convert.ToString(row["ProductID"]) + "库存不足，库存：" + cont.Piece.ToString() + "条";
                    msg.Result = false;
                    break;
                }
                #region 订单详情
                entDest.Add(new CargoMoveOrderGoodsEntity
                {
                    MoveNo = ent.MoveNo,
                    ProductID = Convert.ToInt64(row["ProductID"]),
                    ContainerGoodsID = Convert.ToInt64(row["ID"]),
                    ContainerID = Convert.ToInt32(row["ContainerID"]),
                    Piece = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]),
                    ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
                    OPID = UserInfor.LoginName.Trim()
                });
                pieceSum += mP;

                //仓库同步缓存
                CargoProductEntity syncProduct = house.SyncTypeProduct(Convert.ToString(row["ProductID"]));
                //34 马牌  1 同步马牌  2 同步全部品牌
                if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                {
                    RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                }
                //主仓缓存更改
                if (house.IsAddCaching(Convert.ToInt32(ent.OldHouseID), syncProduct.TypeID))
                {
                    RedisHelper.HashSet("HCYCHouseStockSyc", ent.OldHouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                }

                #endregion
                //判断处理是否自动生成来货单
                if (ent.IsSaveIncomming.Equals("1"))
                {
                    factoryList.Add(new CargoFactoryOrderEntity
                    {
                        HouseID = UserInfor.HouseID,
                        FacOrderNo = ent.MoveNo,//来货单号以移库单号
                        Source = 82,
                        SourceName = "移库入库",
                        ProductName = "广通慧采业务部",
                        TypeID = Convert.ToInt32(row["TypeID"]),
                        TypeName = Convert.ToString(row["TypeName"]).Trim(),
                        OrderType = 0,
                        Model = Convert.ToString(row["Model"]).Trim(),
                        BelongMonth = DateTime.Now.ToString("yyyyMM"),
                        Born = Convert.ToString(row["Born"]).Trim(),
                        Assort = "",
                        Specs = Convert.ToString(row["Specs"]).Trim(),
                        LoadIndex = string.IsNullOrEmpty(Convert.ToString(row["LoadIndex"])) ? "0" : Convert.ToString(row["LoadIndex"]).Trim(),
                        SpeedLevel = Convert.ToString(row["SpeedLevel"]).Trim(),
                        Figure = Convert.ToString(row["Figure"]).Trim(),
                        GoodsCode = Convert.ToString(row["GoodsCode"]).Trim(),
                        Batch = Convert.ToString(row["Batch"]),
                        BatchWeek = Convert.ToInt32(row["BatchWeek"]),
                        BatchYear = Convert.ToInt32(row["BatchYear"]),
                        OrderNum = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]),
                        ReplyNumber = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]),
                        InPiece = 0,
                        InCargoStatus = 0,
                        SalePrice = string.IsNullOrEmpty(Convert.ToString(row["SalePrice"])) ? 0 : Convert.ToDouble(row["SalePrice"]),
                        UnitPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDouble(row["UnitPrice"]),
                        CostPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDouble(row["UnitPrice"]),
                        TaxCostPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDouble(row["UnitPrice"]),
                        NoTaxCostPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDouble(row["UnitPrice"]),
                        TradePrice = string.IsNullOrEmpty(Convert.ToString(row["TradePrice"])) ? 0 : Convert.ToDouble(row["TradePrice"]),
                        WhetherTax = Convert.ToInt32(row["WhetherTax"]) == 0 ? 0 : 1,
                        SaleMoney = string.IsNullOrEmpty(Convert.ToString(row["ReplyNumber"])) ? 0 : Convert.ToDouble(Convert.ToDouble(row["SalePrice"]) * Convert.ToInt32(row["ReplyNumber"])),
                        ReceiveName = UserInfor.UserName,
                        ReceiveCity = UserInfor.DepCity,
                        ReceiveMobile = "",
                        SourceHouse = "",
                        SpecsType = "",
                        OP_Name = UserInfor.UserName.Trim(),
                        BelongDepart = "",
                        Company = "0",
                        //ContainerID = containerEntity.ContainerID,
                        InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString(),
                        Supplier = Convert.ToString(row["Supplier"]).Trim()
                    });
                }
            }
            if (!ent.MoveNum.Equals(pieceSum))
            {
                msg.Message = "出库数量与明细不一致，请核对";
                msg.Result = false;
            }
            #endregion
            if (msg.Result)
            {
                ent.MoveGoodsList = entDest;
                bus.AddMoveOrderData(ent, log);
                if (ent.IsSaveIncomming.Equals("1"))
                {
                    cargoFactory.SaveFactoryOrderData(factoryList, log);
                }


                CargoHouseEntity houseData = house.QueryCargoHouseByID(ent.NewHouseID);//查询仓库代码
                //添加推送信息
                bus.InsertCargoOrderPush(new CargoOrderPushEntity
                {
                    OrderNo = ent.MoveNo,//订单号
                    Dep = ent.OldHouseName,//出发站
                    Dest = ent.NewHouseName,//到达站
                    Piece = ent.MoveNum,//总件数
                    TransportFee = 0,//总收入
                    ClientNum = "",//客户编码
                    AcceptAddress = houseData.Address,//客户详细地址
                    AcceptCellphone = houseData.Cellphone,//客户手机
                    AcceptTelephone = houseData.Cellphone,//客户联系电话
                    AcceptPeople = houseData.Person,//客户联系人
                    AcceptUnit = ent.NewHouseName,//客户名称
                    HouseID = ent.OldHouseID.ToString(),
                    HouseName = ent.OldHouseName,
                    OP_ID = UserInfor.UserName,
                    PushType = "0",
                    PushStatus = "0",
                    LogisID = ent.LogisID,
                    Type = 2
                }, log);
            } 

            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 查询移库单
        /// </summary>
        public void QueryMoveOrder()
        {
            CargoMoveOrderEntity queryEntity = new CargoMoveOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            queryEntity.MoveNo = Convert.ToString(Request["MoveNo"]);
            queryEntity.Specs = Convert.ToString(Request["Specs"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["OldHouseID"])))
            {
                queryEntity.OldHouseID = Convert.ToString(Request["OldHouseID"]);
            }
            //else
            //{
            //    queryEntity.OldHouseID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            //}
            if (!string.IsNullOrEmpty(Convert.ToString(Request["NewHouseID"])))
            {
                queryEntity.NewHouseID = Convert.ToInt32(Request["NewHouseID"]);
            }
            if (Convert.ToString(Request["MoveStatus"]) != "-1")
            {
                queryEntity.MoveStatus = Convert.ToString(Request["MoveStatus"]);
            }
            if (UserInfor.IsHeadHouse == "1")
            {
                queryEntity.NewHouseName = UserInfor.HeadHouseName;
            }
            //负责人
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AUserName"])))
            {
                queryEntity.UserName = Convert.ToString(Request["AUserName"]);
            }
            //品牌
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ASID"])))
            {
                queryEntity.TypeID = Convert.ToInt32(Request["ASID"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["APID"])))
            {
                queryEntity.ParentID = Convert.ToInt32(Request["APID"]);
            }


            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryMoveOrder(pageIndex, pageSize, queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        /// <summary>
        /// 查询移库单明细
        /// </summary>
        public void QueryMoveOrderInfo()
        {
            if (String.IsNullOrEmpty(Request["MoveNo"]))
            {
                return;
            }
            CargoMoveOrderGoodsEntity queryEntity = new CargoMoveOrderGoodsEntity();
            queryEntity.MoveNo = Request["MoveNo"].ToString();
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoMoveOrderGoodsEntity> list = bus.QueryMoveOrderGoodsList(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 
        /// </summary>
        public void QueryMoveOrderForExport()
        {
            String MoveNoStr = Request["data"];
            if (String.IsNullOrEmpty(MoveNoStr)) return;
            string[] MoveNo = MoveNoStr.Split(',');
            CargoOrderBus bus = new CargoOrderBus();
            CargoMoveOrderGoodsEntity queryEntity = new CargoMoveOrderGoodsEntity();
            List<CargoMoveOrderGoodsEntity> list = new List<CargoMoveOrderGoodsEntity>();
            foreach (var item in MoveNo)
            {
                if (!string.IsNullOrEmpty(item))
                {
                    queryEntity.MoveNo = Convert.ToString(item);
                    list.AddRange(bus.QueryMoveOrderGoodsList(queryEntity));
                }
            }

            string err = "OK";
            if (list.Count > 0) { MoveOrderExport = list; }
            else { err = "没有数据可以进行导出，请重新查询！"; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 导出实体
        /// </summary>
        public List<CargoMoveOrderGoodsEntity> MoveOrderExport
        {
            get
            {
                if (Session["MoveOrderExport"] == null)
                {
                    Session["MoveOrderExport"] = new List<CargoMoveOrderGoodsEntity>();
                }
                return (List<CargoMoveOrderGoodsEntity>)(Session["MoveOrderExport"]);
            }
            set
            {
                Session["MoveOrderExport"] = value;
            }
        }
        public void UpdateMoveOrderPiece()
        {
            string json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "移库管理";
            log.Status = "0";
            log.NvgPage = "修改数量";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            CargoOrderBus bus = new CargoOrderBus();
            CargoHouseBus house = new CargoHouseBus();
            CargoMoveOrderEntity moveOrderEntity = new CargoMoveOrderEntity();
            List<CargoMoveOrderGoodsEntity> moveOrderGoodsEntities = new List<CargoMoveOrderGoodsEntity>();
            foreach (Hashtable row in rows)
            {
                List<CargoContainerShowEntity> orderContainerList = bus.QueryMoveOrderByMoveOrderNo(new CargoMoveOrderGoodsEntity { MoveNo = Convert.ToString(row["MoveNo"]), ProductID = Convert.ToInt64(row["ProductID"]), ContainerGoodsID = Convert.ToInt64(row["ContainerGoodsID"]), ContainerID = Convert.ToInt32(row["ContainerID"]) });
                if (orderContainerList.Count <= 0)
                {
                    msg.Result = false;
                    msg.Message = "未查询到此移库明细";
                    break;
                }
                else if (!orderContainerList[0].InCargoStatus.Equals("0"))
                {
                    int ScanPiece = bus.QueryMoveOrderScanPiece(new CargoMoveOrderGoodsEntity { MoveNo = Convert.ToString(row["MoveNo"]), ProductID = Convert.ToInt64(row["ProductID"]) });
                    if (ScanPiece > Convert.ToInt32(row["Piece"]))
                    {
                        msg.Result = false;
                        msg.Message = "当前产品已出库" + ScanPiece + "条";
                        break;
                    }
                    else if (ScanPiece.Equals(Convert.ToInt32(row["Piece"])))
                    {
                        int OrderScanPiece = bus.QueryMoveOrderScanPiece(new CargoMoveOrderGoodsEntity { MoveNo = Convert.ToString(row["MoveNo"]) });
                        int MoveNum = bus.QueryMoveOrderMoveNum(new CargoMoveOrderEntity { MoveNo = Convert.ToString(row["MoveNo"]) });
                        if ((MoveNum + (Convert.ToInt32(row["Piece"]) - Convert.ToInt32(row["oldPiece"]))).Equals(OrderScanPiece))
                        {
                            moveOrderEntity.MoveStatus = "1";
                        }
                        else
                        {
                            moveOrderEntity.MoveStatus = "3";
                        }
                    }
                    else
                    {
                        moveOrderEntity.MoveStatus = "3";
                    }
                }
                moveOrderEntity.ID = Convert.ToInt64(row["MoveID"]);
                moveOrderEntity.MoveNo = Convert.ToString(row["MoveNo"]);
                moveOrderEntity.MoveNum = Convert.ToInt32(row["Piece"]) - Convert.ToInt32(row["oldPiece"]);
                if (Convert.ToInt32(row["Piece"]) > Convert.ToInt32(row["oldPiece"]))
                {
                    CargoContainerGoodsEntity cont = house.QueryCargoContainerGoods(new CargoContainerGoodsEntity { ID = Convert.ToInt64(row["ContainerGoodsID"]) });
                    int mP = Convert.ToInt32(row["Piece"]) - Convert.ToInt32(row["oldPiece"]);
                    if (mP > cont.Piece)
                    {
                        msg.Message = "产品ID：" + Convert.ToString(row["ProductID"]) + "库存不足，库存：" + cont.Piece.ToString() + "条";
                        msg.Result = false;
                        break;
                    }
                    moveOrderGoodsEntities.Add(new CargoMoveOrderGoodsEntity
                    {
                        ProductID = Convert.ToInt64(row["ProductID"]),
                        ContainerID = Convert.ToInt32(row["ContainerID"]),
                        ContainerGoodsID = Convert.ToInt64(row["ContainerGoodsID"]),
                        NewPiece = Convert.ToInt32(row["Piece"]) - Convert.ToInt32(row["oldPiece"]),
                        OldPiece = Convert.ToInt32(row["oldPiece"])
                    });
                    moveOrderEntity.MoveGoodsList = moveOrderGoodsEntities;
                }
                else
                {
                    if (Convert.ToInt32(row["Piece"]).Equals(0))
                    {
                        moveOrderEntity.MoveNum = 0 - Convert.ToInt32(row["oldPiece"]);
                        moveOrderGoodsEntities.Add(new CargoMoveOrderGoodsEntity
                        {
                            ProductID = Convert.ToInt64(row["ProductID"]),
                            ContainerID = Convert.ToInt32(row["ContainerID"]),
                            ContainerGoodsID = Convert.ToInt64(row["ContainerGoodsID"]),
                            NewPiece = 0,
                            OldPiece = Convert.ToInt32(row["oldPiece"])
                        });
                        moveOrderEntity.MoveGoodsList = moveOrderGoodsEntities;
                    }
                    else
                    {
                        moveOrderGoodsEntities.Add(new CargoMoveOrderGoodsEntity
                        {
                            ProductID = Convert.ToInt64(row["ProductID"]),
                            ContainerID = Convert.ToInt32(row["ContainerID"]),
                            ContainerGoodsID = Convert.ToInt64(row["ContainerGoodsID"]),
                            NewPiece = Convert.ToInt32(row["Piece"]) - Convert.ToInt32(row["oldPiece"]),
                            OldPiece = Convert.ToInt32(row["oldPiece"])
                        });
                        moveOrderEntity.MoveGoodsList = moveOrderGoodsEntities;
                    }
                }
                bus.UpdateMoveOrderData(moveOrderEntity, log);

            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }
        /// <summary>
        /// 删除移库单
        /// </summary>
        public void DelMoveOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoMoveOrderEntity> list = new List<CargoMoveOrderEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "移库管理";
            log.Status = "0";
            log.NvgPage = "移库管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";

            try
            {
                foreach (Hashtable row in rows)
                {
                    List<CargoMoveOrderEntity> ord = bus.QueryMoveOrderList(new CargoMoveOrderEntity { MoveNo = Convert.ToString(row["MoveNo"]) });
                    if (ord.Count > 0)
                    {
                        if (!ord[0].MoveStatus.Equals("0"))
                        {
                            msg.Message = "非下单状态，不允许删除";
                            msg.Result = false;
                            break;
                        }
                    }

                    list.Add(new CargoMoveOrderEntity
                    {
                        ID = Convert.ToInt64(row["ID"]),
                        MoveNo = Convert.ToString(row["MoveNo"]),
                        OldHouseName = Convert.ToString(row["OldHouseName"]),
                        NewHouseName = Convert.ToString(row["NewHouseName"]),
                        OldHouseID = Convert.ToString(row["OldHouseID"]),
                        NewHouseID = Convert.ToInt32(row["NewHouseID"]),
                        MoveNum = Convert.ToInt32(row["MoveNum"]),
                        MoveStatus = Convert.ToString(row["MoveStatus"]),
                        Memo = Convert.ToString(row["Memo"])
                    });

                    //仓库同步缓存
                    CargoHouseBus house = new CargoHouseBus();
                    List<CargoProductEntity> syncProduct = house.SyncTypeMoveNo(Convert.ToString(row["MoveNo"]));
                    foreach (CargoProductEntity product in syncProduct)
                    {

                        if (product.SyncType == "2" || (product.SyncType == "1" && product.TypeID == 34))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + product.HouseID + "_" + product.TypeID + "_" + product.ProductCode + "", product.GoodsCode);
                        }
                    }
                }
                if (msg.Result)
                {

                    bus.DelMoveOrder(list, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 查询移库明细
        /// </summary>
        public void QueryMoveOrderGoodsList()
        {
            CargoMoveOrderGoodsEntity queryEntity = new CargoMoveOrderGoodsEntity();
            queryEntity.MoveNo = Convert.ToString(Request["MoveNo"]);

            CargoOrderBus bus = new CargoOrderBus();
            List<CargoMoveOrderGoodsEntity> list = bus.QueryMoveOrderGoodsList(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        public void QueryMoveOrderDataExport()
        {
            CargoMoveOrderEntity queryEntity = new CargoMoveOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            queryEntity.MoveNo = Convert.ToString(Request["MoveNo"]);
            queryEntity.Specs = Convert.ToString(Request["Specs"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["OldHouseID"])))
            {
                queryEntity.OldHouseID = Convert.ToString(Request["OldHouseID"]);
            }
            //else
            //{
            //    queryEntity.OldHouseID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            //}
            if (!string.IsNullOrEmpty(Convert.ToString(Request["NewHouseID"])))
            {
                queryEntity.NewHouseID = Convert.ToInt32(Request["NewHouseID"]);
            }
            if (Convert.ToString(Request["MoveStatus"]) != "-1")
            {
                queryEntity.MoveStatus = Convert.ToString(Request["MoveStatus"]);
            }
            if (UserInfor.IsHeadHouse == "1")
            {
                queryEntity.NewHouseName = UserInfor.HeadHouseName;
            }
            //负责人
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AUserName"])))
            {
                queryEntity.UserName = Convert.ToString(Request["AUserName"]);
            }
            //品牌
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ASID"])))
            {
                queryEntity.TypeID = Convert.ToInt32(Request["ASID"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["APID"])))
            {
                queryEntity.ParentID = Convert.ToInt32(Request["APID"]);
            }


            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryMoveOrder(1, 10000, queryEntity);

            if (list != null) { QueryMoveOrderDataList = list; }

            //JSON
            String json = JSON.Encode("OK");
            Response.Clear();
            Response.Write(json);
        }
        public Hashtable QueryMoveOrderDataList
        {
            get
            {
                if (Session["QueryMoveOrderDataList"] == null)
                {
                    Session["QueryMoveOrderDataList"] = new Hashtable();
                }
                return (Hashtable)(Session["QueryMoveOrderDataList"]);
            }
            set
            {
                Session["QueryMoveOrderDataList"] = value;
            }
        }
        #endregion
        #region 作废订单管理
        public void QueryOrderTempInfo()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Piece"]))) { queryEntity.Piece = Convert.ToInt32(Request["Piece"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
            queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            //if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])))
            //{
            //    queryEntity.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
            //}
            queryEntity.PayClientName = Convert.ToString(Request["PayClientName"]);
            queryEntity.Dep = Convert.ToString(Request["Dep"]);
            queryEntity.Dest = Convert.ToString(Request["Dest"]);
            queryEntity.CreateAwb = Convert.ToString(Request["CreateAwb"]);
            queryEntity.OutHouseName = Convert.ToString(Request["OutHouseName"]);
            if (Convert.ToString(Request["OrderType"]) != "-1")
            {
                queryEntity.OrderType = Convert.ToString(Request["OrderType"]);
            }
            if (Convert.ToString(Request["AwbStatus"]) != "-1")
            {
                queryEntity.AwbStatus = Convert.ToString(Request["AwbStatus"]);
            }
            if (Convert.ToString(Request["FinanceSecondCheck"]) != "-1")
            {
                queryEntity.FinanceSecondCheck = Convert.ToString(Request["FinanceSecondCheck"]);
            }
            //ueryEntity.CheckOutType = Convert.ToString(Request["CheckOutType"]);
            //queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            queryEntity.SaleManID = Convert.ToString(Request["SaleManID"]);
            if (Convert.ToString(Request["OrderModel"]) != "-1")
            {
                queryEntity.OrderModel = Convert.ToString(Request["OrderModel"]);
            }
            if (Convert.ToString(Request["ThrowGood"]) != "-1")
            {
                queryEntity.ThrowGood = Convert.ToString(Request["ThrowGood"]);
            }
            //2021-01-21 添加公司类型查询条件
            if (Convert.ToString(Request["BelongHouse"]) != "-1")
            {
                queryEntity.BelongHouse = Convert.ToString(Request["BelongHouse"]);
            }
            //2021-01-30 添加客户名称查询条件
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            //if (!string.IsNullOrEmpty(Request["FirstID"]))//一级仓库
            //{
            //    queryEntity.FirstAreaID = Convert.ToInt32(Request["FirstID"]);
            //}
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryOrderTempInfo(pageIndex, pageSize, queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        public void QueryOrderTempInfoExport()
        {
            string err = "OK";
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Piece"]))) { queryEntity.Piece = Convert.ToInt32(Request["Piece"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
            queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            //if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])))
            //{
            //    queryEntity.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
            //}
            queryEntity.PayClientName = Convert.ToString(Request["PayClientName"]);
            queryEntity.Dep = Convert.ToString(Request["Dep"]);
            queryEntity.Dest = Convert.ToString(Request["Dest"]);
            queryEntity.CreateAwb = Convert.ToString(Request["CreateAwb"]);
            queryEntity.OutHouseName = Convert.ToString(Request["OutHouseName"]);
            if (Convert.ToString(Request["OrderType"]) != "-1")
            {
                queryEntity.OrderType = Convert.ToString(Request["OrderType"]);
            }
            if (Convert.ToString(Request["AwbStatus"]) != "-1")
            {
                queryEntity.AwbStatus = Convert.ToString(Request["AwbStatus"]);
            }
            if (Convert.ToString(Request["FinanceSecondCheck"]) != "-1")
            {
                queryEntity.FinanceSecondCheck = Convert.ToString(Request["FinanceSecondCheck"]);
            }
            //ueryEntity.CheckOutType = Convert.ToString(Request["CheckOutType"]);
            //queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]).Replace("undefined", "");//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            queryEntity.SaleManID = Convert.ToString(Request["SaleManID"]);
            if (Convert.ToString(Request["OrderModel"]) != "-1")
            {
                queryEntity.OrderModel = Convert.ToString(Request["OrderModel"]);
            }
            if (Convert.ToString(Request["ThrowGood"]) != "-1")
            {
                queryEntity.ThrowGood = Convert.ToString(Request["ThrowGood"]);
            }
            //2021-01-21 添加公司类型查询条件
            if (Convert.ToString(Request["BelongHouse"]) != "-1")
            {
                queryEntity.BelongHouse = Convert.ToString(Request["BelongHouse"]);
            }
            //2021-01-30 添加客户名称查询条件
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            //if (!string.IsNullOrEmpty(Request["FirstID"]))//一级仓库
            //{
            //    queryEntity.FirstAreaID = Convert.ToInt32(Request["FirstID"]);
            //}
            //分页
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryOrderTempInfo(1, 10000, queryEntity);
            if (list != null) { OrderTempList = list["rows"] as List<CargoOrderEntity>; }

            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        public List<CargoOrderEntity> OrderTempList
        {
            get
            {
                if (Session["OrderTempList"] == null)
                {
                    Session["OrderTempList"] = new List<CargoOrderEntity>();
                }
                return (List<CargoOrderEntity>)(Session["OrderTempList"]);
            }
            set
            {
                Session["OrderTempList"] = value;
            }
        }
        /// <summary>
        /// 通过订单号查询订单数据
        /// </summary>
        public void QueryOrderTempByOrderNo()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            //查询条件
            string key = Request["OrderNo"];
            if (string.IsNullOrEmpty(key)) { Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return; }
            queryEntity.OrderNo = key.Trim();
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoContainerShowEntity> list = bus.QueryOrderTempByOrderNo(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        #endregion
        #region 预订单方法
        /// <summary>
        /// 查询所有的产品
        /// </summary>
        public void PreQueryALLProduct()
        {
            CargoContainerShowEntity queryEntity = new CargoContainerShowEntity();
            if (!string.IsNullOrEmpty(Request["PID"]))//一级分类
            {
                queryEntity.TypeParentID = Convert.ToInt32(Request["PID"]);
            }
            if (!string.IsNullOrEmpty(Request["SID"]))//二级分类
            {
                queryEntity.TypeID = Convert.ToInt32(Request["SID"]);
            }
            if (!string.IsNullOrEmpty(Request["GoodsCode"]))//富添盛编码
            {
                queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            }
            if (!string.IsNullOrEmpty(Request["ProductName"]))//产品名称
            {
                queryEntity.ProductName = Convert.ToString(Request["ProductName"]);
            }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//所属仓库
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            //一级仓库
            if (!string.IsNullOrEmpty(Request["HAID"]))
            {
                queryEntity.FirstAreaID = Convert.ToInt32(Request["HAID"]);
            }
            //一级区域
            if (!string.IsNullOrEmpty(Request["HSID"]))
            {
                queryEntity.ParentAreaID = Convert.ToInt32(Request["HSID"]);
            }
            if (!string.IsNullOrEmpty(Request["ProductID"]))//产品ID
            {
                queryEntity.ProductID = Convert.ToInt64(Request["ProductID"]);
            }
            //价格类型
            if (!string.IsNullOrEmpty(Request["PriceType"]))
            {
                queryEntity.PriceType = Convert.ToInt32(Request["PriceType"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoHouseBus bus = new CargoHouseBus();
            List<CargoContainerShowEntity> list = bus.PreQueryALLProduct(queryEntity);
            //List<CargoContainerShowEntity> footlist = new List<CargoContainerShowEntity>();
            //footlist.Add(new CargoContainerShowEntity
            //{
            //    HouseName = "汇总：",
            //    Piece = list.Sum(c => c.Piece),
            //    InCargoStatus = ""
            //});
            //Hashtable resHT = new Hashtable();
            //resHT["rows"] = list;
            //resHT["total"] = list.Count();
            //resHT["footer"] = footlist;
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 预订单保存
        /// </summary>
        public void PreSaveOrderData()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            CargoHouseBus house = new CargoHouseBus();
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            //是否预订单
            bool preType = false;
            Dictionary<int, ArrayList> rows = new Dictionary<int, ArrayList>();
            int HouseID = 0;
            string HouseCode = "";
            string HouseName = "";

            foreach (Hashtable item in GridRows)
            {
                if (Convert.ToInt32(item["Piece"]) < 0)
                {
                    preType = true;
                }
                HouseID = Convert.ToInt32(item["HouseID"]);
                HouseCode = Convert.ToString(item["HouseCode"]);
                HouseName = Convert.ToString(item["HouseName"]);
            }

            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "预订单管理";
            log.NvgPage = "新增预订单";

            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            log.Status = "0";
            string source = string.Empty;
            List<string> HouseStr = new List<string>();

            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            List<QyOrderUpdateGoodsEntity> goods = new List<QyOrderUpdateGoodsEntity>();
            bool NoPromise = Convert.ToString(Request["ClientType"]).Equals("3") ? true : false;
            try
            {
                if (msg.Result)
                {
                    #region 赋值
                    ent.HAwbNo = Convert.ToString(Request["HAwbNo"]);

                    CargoHouseEntity houseEnt = house.QueryCargoHouseByID(HouseID);
                    ent.Dep = Convert.ToString(houseEnt.DepCity);
                    if (string.IsNullOrEmpty(Convert.ToString(Request["Dest"])))
                    {
                        ent.Dest = Convert.ToString(Request["ADest"]);
                    }
                    else
                    {
                        ent.Dest = Convert.ToString(Request["Dest"]);
                    }
                    ent.InsuranceFee = string.IsNullOrEmpty(Convert.ToString(Request["InsuranceFee"])) ? 0 : Convert.ToDecimal(Request["Coupon"]);//保险费用
                    ent.TransitFee = string.IsNullOrEmpty(Convert.ToString(Request["TransitFee"])) ? 0 : Convert.ToDecimal(Request["TransitFee"]);
                    ent.DeliveryFee = string.IsNullOrEmpty(Convert.ToString(Request["DeliveryFee"])) ? 0 : Convert.ToDecimal(Request["DeliveryFee"]);
                    ent.OtherFee = string.IsNullOrEmpty(Convert.ToString(Request["OtherFee"])) ? 0 : Convert.ToDecimal(Request["OtherFee"]);
                    ent.Rebate = string.IsNullOrEmpty(Convert.ToString(Request["Rebate"])) ? 0 : Convert.ToDecimal(Request["Rebate"]);
                    ent.HouseID = HouseID;
                    ent.CheckOutType = Convert.ToString(Request["CheckOutType"]);
                    ent.DeliveryType = "0";//Convert.ToString(Request["DeliveryType"]);
                    ent.AcceptAddress = Convert.ToString(Request["AcceptAddress"]);
                    if (string.IsNullOrEmpty(Convert.ToString(Request["AcceptPeople"])))
                    {
                        ent.AcceptPeople = Convert.ToString(Request["AAcceptPeople"]);
                    }
                    else
                    {
                        ent.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
                    }
                    ent.AcceptPeople = ent.AcceptPeople.Split(',')[0];
                    ent.AcceptUnit = string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"])) ? ent.AcceptPeople : Convert.ToString(Request["AcceptUnit"]);
                    ent.AcceptTelephone = Convert.ToString(Request["AcceptTelephone"]);
                    ent.AcceptCellphone = Convert.ToString(Request["AcceptCellphone"]);
                    ent.CreateAwb = Convert.ToString(Request["CreateAwb"]);
                    ent.CreateAwbID = UserInfor.LoginName;
                    ent.CreateDate = DateTime.Now;// Convert.ToDateTime(Request["CreateDate"]);
                    ent.OP_ID = UserInfor.LoginName.Trim();
                    ent.SaleManID = Convert.ToString(Request["SaleManID"]);
                    ent.SaleManName = Convert.ToString(Request["SaleManName"]);
                    ent.Remark = Convert.ToString(Request["Remark"]);
                    ent.ThrowGood = string.IsNullOrEmpty(Convert.ToString(Request["ThrowGood"])) ? "0" : Convert.ToString(Request["ThrowGood"]);
                    ent.TranHouse = ent.ThrowGood.Equals("0") ? "" : Convert.ToString(Request["TranHouse"]);
                    if (!string.IsNullOrEmpty(Convert.ToString(Request["LogisID"])))
                    {
                        ent.LogisID = Convert.ToInt32(Request["LogisID"]);
                    }
                    if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientNum"])) && !Convert.ToString(Request["ClientNum"]).Equals("0"))
                    {
                        ent.ClientNum = Convert.ToInt32(Request["ClientNum"]);
                    }

                    if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])) && !Convert.ToString(Request["PayClientNum"]).Equals("0"))
                    {
                        ent.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
                        ent.PayClientName = Convert.ToString(Request["PayClientName"]);//付款人客户姓名
                    }
                    else
                    {
                        ent.PayClientNum = ent.ClientNum;
                        ent.PayClientName = ent.AcceptPeople;
                    }

                    #endregion
                    decimal trFee = 0.00M;
                    int pieceN = 0;
                    int pieceSum = 0;
                    string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号


                    int OrderNum = 0;
                    string result = string.Empty;
                    int oNum = bus.GetMaxPreOrderNumByCurrentDate(new CargoOrderEntity { HouseID = HouseID, StartDate = DateTime.Now, EndDate = DateTime.Now });
                    string oStr = string.Empty;
                    switch ((oNum + 1).ToString().Length)
                    {
                        case 1:
                            oStr = "00" + (oNum + 1).ToString();
                            break;
                        case 2:
                            oStr = "0" + (oNum + 1).ToString();
                            break;
                        default:
                            oStr = (oNum + 1).ToString();
                            break;
                    }
                    result = HouseCode.Trim() + DateTime.Now.ToString("yyMMdd") + oStr;
                    OrderNum = oNum + 1;

                    ent.OrderNo = result;
                    ent.OrderNum = OrderNum;//最新订单顺序号
                    foreach (Hashtable row in GridRows)
                    {
                        if (preType)
                        {

                            #region 订单详情
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = Convert.ToInt64(row["ProductID"]),
                                HouseID = HouseID,
                                AreaID = Convert.ToInt32(row["AreaID"]),
                                Piece = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]),
                                ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
                                ContainerCode = Convert.ToString(row["ContainerCode"]),
                                GoodsCode = Convert.ToString(row["GoodsCode"]),
                                ProductName = Convert.ToString(row["ProductName"]),
                                OutCargoID = outID,
                                RuleTitle = Convert.ToString(row["RuleTitle"]),
                                OP_ID = UserInfor.LoginName.Trim()
                            });
                            pieceN = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);
                            trFee += pieceN * Convert.ToDecimal(row["ActSalePrice"]);
                            CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                            cargo.OrderNo = ent.OrderNo;//订单号
                            cargo.OutCargoID = outID;
                            cargo.ContainerID = Convert.ToInt32(row["ContainerID"]);
                            cargo.TypeID = Convert.ToInt32(row["TypeID"]);
                            cargo.ProductID = Convert.ToInt64(row["ProductID"]);
                            cargo.Piece = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);//出库件数
                            cargo.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                            cargo.InPiece = Convert.ToInt32(row["InPiece"]);
                            cargo.ID = Convert.ToInt64(row["ID"]);

                            cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                            cargo.HouseName = HouseName;
                            cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                            cargo.ProductName = Convert.ToString(row["ProductName"]).Trim();
                            cargo.Model = Convert.ToString(row["Model"]).Trim();
                            cargo.Specs = Convert.ToString(row["Specs"]).Trim();
                            cargo.Figure = Convert.ToString(row["Figure"]).Trim();
                            cargo.GoodsCode = Convert.ToString(row["GoodsCode"]).Trim();
                            cargo.Batch = Convert.ToString(row["Batch"]).Trim();
                            outHouseList.Add(cargo);
                            pieceSum += cargo.Piece;
                            #endregion
                        }
                        else
                        {
                            #region 订单详情
                            int num = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);
                            List<CargoProductEntity> productList = bus.QueryPreOrderProductInfo(new CargoProductEntity { GoodsCode = Convert.ToString(row["GoodsCode"]).Trim() });
                            foreach (var pro in productList)
                            {
                                CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                                cargo.OutCargoID = outID;
                                cargo.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                                cargo.HouseName = HouseName;
                                cargo.OrderNo = ent.OrderNo;//订单号
                                if (pro.Numbers >= num)
                                {
                                    entDest.Add(new CargoOrderGoodsEntity
                                    {
                                        OrderNo = ent.OrderNo,
                                        ProductID = pro.ProductID,
                                        GoodsCode = pro.GoodsCode,
                                        ProductName = pro.ProductName,
                                        HouseID = HouseID,
                                        Piece = num,
                                        ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
                                        AreaID = pro.AreaID,
                                        ContainerCode = pro.ContainerCode,
                                        OutCargoID = outID,
                                        RuleTitle = Convert.ToString(row["RuleTitle"]),
                                        OP_ID = UserInfor.LoginName.Trim(),
                                    });
                                    cargo.ContainerID = pro.ContainerID;
                                    cargo.TypeID = pro.TypeID;
                                    cargo.ProductID = pro.ProductID;
                                    cargo.Piece = num;//出库件数
                                    cargo.InPiece = pro.InPiece;
                                    cargo.ID = pro.ContainerGoodsID;

                                    cargo.TypeName = pro.TypeName;
                                    cargo.AreaName = pro.AreaName;
                                    cargo.ProductName = pro.ProductName;
                                    cargo.Model = pro.Model;
                                    cargo.Figure = pro.Figure;
                                    cargo.GoodsCode = pro.GoodsCode;
                                    cargo.Batch = pro.Batch;
                                    outHouseList.Add(cargo);
                                    pieceSum += cargo.Piece;
                                    break;
                                }
                                else
                                {
                                    entDest.Add(new CargoOrderGoodsEntity
                                    {
                                        OrderNo = ent.OrderNo,
                                        ProductID = pro.ProductID,
                                        GoodsCode = pro.GoodsCode,
                                        ProductName = pro.ProductName,
                                        HouseID = HouseID,
                                        Piece = pro.Numbers,
                                        ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
                                        AreaID = pro.AreaID,
                                        ContainerCode = pro.ContainerCode,
                                        OutCargoID = outID,
                                        RuleTitle = Convert.ToString(row["RuleTitle"]),
                                        OP_ID = UserInfor.LoginName.Trim(),
                                    });
                                    cargo.ContainerID = pro.ContainerID;
                                    cargo.TypeID = pro.TypeID;
                                    cargo.ProductID = pro.ProductID;
                                    cargo.Piece = pro.Numbers;//出库件数
                                    cargo.InPiece = pro.InPiece;
                                    cargo.ID = pro.ContainerGoodsID;

                                    cargo.TypeName = pro.TypeName;
                                    cargo.AreaName = pro.AreaName;
                                    cargo.ProductName = pro.ProductName;
                                    cargo.Model = pro.Model;
                                    cargo.Figure = pro.Figure;
                                    cargo.GoodsCode = pro.GoodsCode;
                                    cargo.Batch = pro.Batch;
                                    outHouseList.Add(cargo);
                                    pieceSum += cargo.Piece;
                                    num -= pro.Numbers;
                                }
                            }

                            pieceN = Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);
                            trFee += pieceN * Convert.ToDecimal(row["ActSalePrice"]);

                            #endregion
                        }
                    }
                    ent.Piece = pieceSum;
                    ent.OutHouseName = HouseName;
                    if (ent.ThrowGood != "9")
                    {
                        ent.TransportFee = trFee;
                        ent.TotalCharge = ent.TransportFee + ent.TransitFee + ent.OtherFee - ent.InsuranceFee;
                    }
                    else
                    {
                        ent.TransportFee = 0;
                        ent.TotalCharge = 0;
                    }
                    if (preType)
                    {
                        ent.IsMakeSure = 0;
                    }
                    else
                    {
                        ent.IsMakeSure = 1;
                    }
                    ent.AwbStatus = "0";
                    ent.OrderType = "0";
                    ent.HouseID = HouseID;
                    if (HouseID.Equals(47))
                    {
                        ent.BelongHouse = "2";
                    }
                    ent.HouseName = HouseName;
                    ent.goodsList = entDest;
                    ent.ModifyPriceStatus = "0";
                    if (msg.Result)
                    {
                        //仓库同步缓存
                        foreach (CargoContainerShowEntity time in outHouseList)
                        {
                            CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                            //34 马牌  1 同步马牌  2 同步全部品牌
                            if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                            {
                                RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                            }
                        }
                        bus.AddPreOrderInfo(ent, outHouseList, log);
                        msg.Message = ent.OrderNo + "/" + outID + "/" + ent.ModifyPriceStatus + "/" + (preType == true ? 1 : 0);//订单号和出库单号
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }

            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }

        /// <summary>
        /// 修改订单中的产品数量
        /// </summary>
        public void UpdatePreOrderPiece()
        {
            string OrderNo = Convert.ToString(Request["OrderNo"]);
            string GoodsCode = Convert.ToString(Request["GoodsCode"]);
            if (String.IsNullOrEmpty(OrderNo) || String.IsNullOrEmpty(GoodsCode) || String.IsNullOrEmpty(Convert.ToString(Request["OldPiece"])) || String.IsNullOrEmpty(Convert.ToString(Request["NewPiece"]))) return;
            int OldPiece = Convert.ToInt32(Request["OldPiece"]);
            int NewPiece = Convert.ToInt32(Request["NewPiece"]);

            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "预订单管理";
            log.Status = "0";
            log.NvgPage = "预订单管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            try
            {
                if (NewPiece.Equals(OldPiece))
                {
                    msg.Result = false;
                    msg.Message = "未修改数量";
                }
                CargoOrderBus bus = new CargoOrderBus();

                if (msg.Result)
                {
                    bus.UpdatePreOrderPiece(OrderNo, GoodsCode, OldPiece, NewPiece, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        /// <summary>
        /// 修改订单中产品价格
        /// </summary>
        public void UpdatePreOrderSalePrice()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "预订单管理";
            log.Status = "0";
            log.NvgPage = "预订单管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            try
            {
                CargoContainerShowEntity entity = new CargoContainerShowEntity();
                CargoOrderBus bus = new CargoOrderBus();
                foreach (Hashtable row in rows)
                {
                    entity.Specs = Convert.ToString(row["Specs"]);
                    entity.GoodsCode = Convert.ToString(row["GoodsCode"]);
                    entity.ContainerID = Convert.ToInt32(row["ContainerID"]);
                    entity.TypeID = Convert.ToInt32(row["TypeID"]);
                    entity.OrderNo = Convert.ToString(row["OrderNo"]);
                    entity.AreaID = Convert.ToInt32(row["AreaID"]);
                    entity.ContainerCode = Convert.ToString(row["ContainerCode"]);
                    entity.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);//新价格
                    entity.SalePrice = Convert.ToDecimal(row["SalePrice"]);//旧价格
                    entity.OutCargoID = Convert.ToString(row["OutCargoID"]);

                    entity.Batch = Convert.ToString(row["Batch"]);
                }
                if (msg.Result)
                {
                    bus.UpdatePreOrderSalePrice(entity, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 查询预订单数据
        /// </summary>
        public void QueryPreOrderInfo()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Piece"]))) { queryEntity.Piece = Convert.ToInt32(Request["Piece"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
            queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            queryEntity.PayClientName = Convert.ToString(Request["PayClientName"]);
            queryEntity.Dep = Convert.ToString(Request["Dep"]);
            queryEntity.Dest = Convert.ToString(Request["Dest"]);
            queryEntity.CreateAwb = Convert.ToString(Request["CreateAwb"]);
            queryEntity.OutHouseName = Convert.ToString(Request["OutHouseName"]);
            if (Convert.ToString(Request["OrderType"]) != "-1")
            {
                queryEntity.OrderType = Convert.ToString(Request["OrderType"]);
            }
            if (Convert.ToString(Request["AwbStatus"]) != "-1")
            {
                queryEntity.AwbStatus = Convert.ToString(Request["AwbStatus"]);
            }
            if (Convert.ToString(Request["FinanceSecondCheck"]) != "-1")
            {
                queryEntity.FinanceSecondCheck = Convert.ToString(Request["FinanceSecondCheck"]);
            }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            queryEntity.SaleManID = Convert.ToString(Request["SaleManID"]);
            if (Convert.ToString(Request["OrderModel"]) != "-1")
            {
                queryEntity.OrderModel = Convert.ToString(Request["OrderModel"]);
            }
            if (Convert.ToString(Request["ThrowGood"]) != "-1")
            {
                queryEntity.ThrowGood = Convert.ToString(Request["ThrowGood"]);
            }
            //2021-01-30 添加客户名称查询条件
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryPreOrderInfo(pageIndex, pageSize, queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 通过订单号查询预订单数据
        /// </summary>
        public void QueryPreOrderByOrderNo()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            //查询条件
            string key = Request["OrderNo"];
            if (string.IsNullOrEmpty(key)) { Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return; }
            queryEntity.OrderNo = key.Trim();
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoContainerShowEntity> list = bus.QueryPreOrderByOrderNo(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        /// <summary>
        /// 预订单删除
        /// </summary>
        public void DelPreOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoOrderEntity> list = new List<CargoOrderEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "预订单管理";
            log.Status = "0";
            log.NvgPage = "删除预订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            int HouseID = 0;
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoOrderEntity
                    {
                        OrderID = Convert.ToInt64(row["OrderID"]),
                        OrderNo = Convert.ToString(row["OrderNo"]),
                        Dep = Convert.ToString(row["Dep"]),
                        Dest = Convert.ToString(row["Dest"]),
                        Piece = Convert.ToInt32(row["Piece"]),
                        TransportFee = Convert.ToDecimal(row["TransportFee"]),
                        TransitFee = Convert.ToDecimal(row["TransitFee"]),
                        DeliveryFee = Convert.ToDecimal(row["DeliveryFee"]),
                        InsuranceFee = Convert.ToDecimal(row["InsuranceFee"]),
                        OtherFee = Convert.ToDecimal(row["OtherFee"]),
                        TotalCharge = Convert.ToDecimal(row["TotalCharge"]),
                        AcceptUnit = Convert.ToString(row["AcceptUnit"]),
                        AcceptPeople = Convert.ToString(row["AcceptPeople"]),
                        AcceptTelephone = Convert.ToString(row["AcceptTelephone"]),
                        AcceptCellphone = Convert.ToString(row["AcceptCellphone"]),
                        AcceptAddress = Convert.ToString(row["AcceptAddress"]),
                        SaleManName = Convert.ToString(row["SaleManName"]),
                        CreateAwb = Convert.ToString(row["CreateAwb"]),
                        CreateAwbID = UserInfor.LoginName,
                        CreateDate = Convert.ToDateTime(row["CreateDate"]),
                        LogisAwbNo = Convert.ToString(row["LogisAwbNo"]),
                        LogisticName = Convert.ToString(row["LogisticName"]),
                        WXOrderNo = Convert.ToString(row["WXOrderNo"]),
                        DeleteID = UserInfor.LoginName,
                        DeleteName = UserInfor.UserName,
                        LogisID = Convert.ToInt32(row["LogisID"])
                    });
                }
                if (msg.Result)
                {
                    bus.DeletePreOrderInfo(list, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
                foreach (var it in list)
                {
                    bus.UpdateCargoOrderPush(new CargoOrderPushEntity { OrderNo = it.OrderNo, PushType = "2", PushStatus = "0", LogisID = it.LogisID }, log);
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 预订单确认
        /// </summary>
        public void PreOrderConfirm()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoOrderEntity> list = new List<CargoOrderEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "预订单管理";
            log.Operate = "U";
            log.Status = "0";
            log.NvgPage = "预订单确认";
            log.UserID = UserInfor.LoginName.Trim();
            string returnMsg = "";
            try
            {
                foreach (Hashtable row in rows)
                {
                    string OrderNo = Convert.ToString(row["OrderNo"]);
                    List<CargoOrderGoodsEntity> goodsList = bus.QueryPreOrderGoodsInfo(Convert.ToString(row["OrderNo"]));
                    bool type = true;
                    foreach (var good in goodsList)
                    {
                        if (bus.QueryPreOrderProductNum(new CargoOrderGoodsEntity { GoodsCode = good.GoodsCode }) < good.Piece)
                        {
                            type = false;
                            returnMsg += "预订单" + OrderNo + "中[" + good.ProductName + "]库存数量不足\r\n";
                            break;
                        }
                    }
                    if (type)
                    {
                        list.Add(new CargoOrderEntity
                        {
                            OrderNo = Convert.ToString(row["OrderNo"])
                        });
                    }
                }
                if (list.Count > 0)
                {
                    bus.PreOrderConfirm(list, log);
                    msg.Result = true;
                }
                else
                {
                    msg.Result = false;
                }
                msg.Message = returnMsg;
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        /// <summary>
        /// 修改订单
        /// </summary>
        public void updatePreOrderData()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            CargoOrderBus bus = new CargoOrderBus();
            CargoHouseBus house = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "预订单管理";
            log.NvgPage = "修改预订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            string source = string.Empty;
            CargoOrderEntity hlyOrder = new CargoOrderEntity();
            CargoOrderEntity oldOrder = new CargoOrderEntity();
            CargoOrderEntity ord = new CargoOrderEntity();
            try
            {
                ent.OrderID = Convert.ToInt64(Request["OrderID"]);
                ent.OrderNo = Convert.ToString(Request["OrderNo"]);
                ord = bus.QueryOrderInfoByOrderID(ent.OrderID);

                if (msg.Result)
                {
                    #region 赋值
                    ent.HAwbNo = Convert.ToString(Request["HAwbNo"]);
                    ent.Dep = Convert.ToString(Request["Dep"]);
                    ent.Dest = Convert.ToString(Request["Dest"]);
                    ent.Piece = string.IsNullOrEmpty(Convert.ToString(Request["Piece"])) ? 0 : Convert.ToInt32(Request["Piece"]);
                    ent.Weight = string.IsNullOrEmpty(Convert.ToString(Request["Weight"])) ? 0 : Convert.ToDecimal(Request["Weight"]);
                    ent.Volume = string.IsNullOrEmpty(Convert.ToString(Request["Volume"])) ? 0 : Convert.ToDecimal(Request["Volume"]);
                    ent.InsuranceFee = string.IsNullOrEmpty(Convert.ToString(Request["InsuranceFee"])) ? 0 : Convert.ToDecimal(Request["InsuranceFee"]);
                    ent.TransitFee = string.IsNullOrEmpty(Convert.ToString(Request["TransitFee"])) ? 0 : Convert.ToDecimal(Request["TransitFee"]);
                    ent.TransportFee = string.IsNullOrEmpty(Convert.ToString(Request["TransportFee"])) ? 0 : Convert.ToDecimal(Request["TransportFee"]);
                    ent.DeliveryFee = string.IsNullOrEmpty(Convert.ToString(Request["DeliveryFee"])) ? 0 : Convert.ToDecimal(Request["DeliveryFee"]);
                    ent.OtherFee = string.IsNullOrEmpty(Convert.ToString(Request["OtherFee"])) ? 0 : Convert.ToDecimal(Request["OtherFee"]);
                    ent.TotalCharge = string.IsNullOrEmpty(Convert.ToString(Request["TotalCharge"])) ? 0 : Convert.ToDecimal(Request["TotalCharge"]);
                    ent.Rebate = string.IsNullOrEmpty(Convert.ToString(Request["Rebate"])) ? 0 : Convert.ToDecimal(Request["Rebate"]);

                    ent.CheckOutType = Convert.ToString(Request["CheckOutType"]);
                    //ent.ReturnAwb = string.IsNullOrEmpty(Convert.ToString(Request["ReturnAwb"])) ? 0 : Convert.ToInt32(Request["ReturnAwb"]);
                    ent.TrafficType = Convert.ToString(Request["TrafficType"]);
                    ent.DeliveryType = "0";//Convert.ToString(Request["DeliveryType"]);
                    ent.IsPrintPrice = string.IsNullOrEmpty(Convert.ToString(Request["IsPrintPrice"])) ? 0 : 1;
                    ent.AcceptUnit = Convert.ToString(Request["AcceptUnit"]);
                    ent.AcceptAddress = Convert.ToString(Request["AcceptAddress"]);
                    ent.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
                    ent.AcceptPeople = ent.AcceptPeople.Split(',')[0];
                    ent.AcceptTelephone = Convert.ToString(Request["AcceptTelephone"]);
                    ent.AcceptCellphone = Convert.ToString(Request["AcceptCellphone"]);
                    ent.CreateAwb = Convert.ToString(Request["CreateAwb"]);
                    ent.CreateDate = Convert.ToDateTime(Request["CreateDate"]);
                    ent.OP_ID = UserInfor.LoginName.Trim();
                    ent.SaleManID = Convert.ToString(Request["SaleManID"]);
                    ent.SaleManName = Convert.ToString(Request["SaleManName"]);
                    ent.Remark = Convert.ToString(Request["Remark"]);
                    ent.LogisID = Convert.ToInt32(Request["LogisID"]);
                    ent.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
                    ent.ClientNum = Convert.ToInt32(Request["ClientNum"]);
                    ent.ThrowGood = string.IsNullOrEmpty(Convert.ToString(Request["ThrowGood"])) ? "0" : Convert.ToString(Request["ThrowGood"]);
                    ent.IsPrintPrice = string.IsNullOrEmpty(Convert.ToString(Request["IsPrintPrice"])) ? 0 : 1;
                    //ent.TranHouse = Convert.ToString(Request["TranHouse"]);
                    ent.TranHouse = ent.ThrowGood.Equals("0") ? "" : Convert.ToString(Request["TranHouse"]);


                    #endregion
                    decimal trFee = 0.00M;
                    int pieceN = 0, pieceTotal = 0;
                    string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                                                                                                     //新的订单产品数据
                    foreach (Hashtable row in GridRows)
                    {
                        source = Convert.ToString(row["Source"]);
                        if (Convert.ToInt32(row["InPiece"]).Equals(0) && Convert.ToInt32(row["Piece"]).Equals(0))
                        {
                            continue;
                        }
                        entDest.Add(new CargoOrderGoodsEntity
                        {
                            OrderNo = ent.OrderNo,
                            ProductID = Convert.ToInt64(row["ProductID"]),
                            HouseID = Convert.ToInt32(row["HouseID"]),
                            AreaID = Convert.ToInt32(row["AreaID"]),
                            GoodsCode = Convert.ToString(row["GoodsCode"]),
                            ProductName = Convert.ToString(row["ProductName"]),
                            Piece = Convert.ToInt32(row["InPiece"]) == 0 ? Convert.ToInt32(row["Piece"]) : Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]),
                            ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
                            ContainerCode = Convert.ToString(row["ContainerCode"]),
                            OutCargoID = string.IsNullOrEmpty(Convert.ToString(row["OutCargoID"])) ? outID : Convert.ToString(row["OutCargoID"]),
                            ID = Convert.ToInt64(row["ID"]),
                            RuleType = Convert.ToString(row["RuleType"]).Trim(),
                            RuleID = Convert.ToString(row["RuleID"]).Trim(),
                            RuleTitle = Convert.ToString(row["RuleTitle"]).Trim(),
                            OP_ID = UserInfor.LoginName.Trim()
                        });

                        pieceN = Convert.ToInt32(row["InPiece"]) == 0 ? Convert.ToInt32(row["Piece"]) : Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);
                        pieceTotal += pieceN;
                        trFee += pieceN * Convert.ToDecimal(row["ActSalePrice"]);
                        CargoContainerShowEntity cargo = new CargoContainerShowEntity();

                        cargo.OutCargoID = string.IsNullOrEmpty(Convert.ToString(row["OutCargoID"])) ? outID : Convert.ToString(row["OutCargoID"]);
                        cargo.ContainerID = Convert.ToInt32(row["ContainerID"]);
                        cargo.TypeID = Convert.ToInt32(row["TypeID"]);
                        cargo.ProductID = Convert.ToInt64(row["ProductID"]);
                        cargo.Piece = Convert.ToInt32(row["InPiece"]) == 0 ? Convert.ToInt32(row["Piece"]) : Convert.ToInt32(row["InPiece"]) - Convert.ToInt32(row["Piece"]);//出库件数
                        cargo.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                        cargo.InPiece = Convert.ToInt32(row["InPiece"]);
                        cargo.ID = Convert.ToInt64(row["ID"]);

                        cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                        cargo.HouseName = Convert.ToString(row["HouseName"]).Trim();
                        cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                        cargo.ProductName = Convert.ToString(row["ProductName"]).Trim();
                        cargo.Model = Convert.ToString(row["Model"]).Trim();
                        cargo.Specs = Convert.ToString(row["Specs"]).Trim();
                        cargo.Figure = Convert.ToString(row["Figure"]).Trim();
                        cargo.Batch = Convert.ToString(row["Batch"]).Trim();
                        cargo.GoodsCode = Convert.ToString(row["GoodsCode"]).Trim();
                        cargo.OrderNo = ent.OrderNo;
                        outHouseList.Add(cargo);
                    }
                    if (ent.ThrowGood != "9")
                    {
                        ent.TransportFee = trFee;
                        ent.TotalCharge = ent.TransportFee + ent.TransitFee + ent.OtherFee - ent.InsuranceFee;
                    }
                    else
                    {
                        ent.TransportFee = 0;
                        ent.TotalCharge = 0;
                    }
                    //ent.TransportFee = trFee;
                    ent.Piece = pieceTotal;
                    //ent.TotalCharge = ent.TransportFee + ent.TransitFee + ent.DeliveryFee + ent.OtherFee + ent.InsuranceFee;
                    if (entDest.Count <= 0)
                    {
                        msg.Message = "没有出库数量数据";
                        msg.Result = false;
                        //返回处理结果
                        string res = JSON.Encode(msg);
                        Response.Write(res);
                        return;
                    }
                    ent.HouseID = entDest[0].HouseID;
                    ent.goodsList = entDest;

                    if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])) && !Convert.ToString(Request["PayClientNum"]).Equals("0"))
                    {
                        ent.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
                        if (ent.PayClientNum.Equals(ent.ClientNum))
                        {
                            ent.PayClientName = ent.AcceptPeople;
                        }
                        else
                        {
                            ent.PayClientName = Convert.ToString(Request["PayClientName"]);//付款人客户姓名
                        }
                    }
                    else
                    {
                        ent.PayClientNum = ent.ClientNum;
                        ent.PayClientName = ent.AcceptPeople;
                    }
                    if (msg.Result)
                    {
                        bus.UpdatePreOrderInfo(ent, outHouseList, log);
                        msg.Result = true;
                        msg.Message = ent.OrderNo + "/" + outID;//订单号和出库单号
                                                                //house.saveOutCargoData(outHouseList, log);
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }


            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 拉上预订单
        /// </summary>
        public void DrawUpPreOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "预订单管理";
            log.Status = "0";
            log.NvgPage = "预订单管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            try
            {
                CargoContainerShowEntity entity = new CargoContainerShowEntity();

                foreach (Hashtable row in rows)
                {
                    entity.ID = Convert.ToInt64(row["ID"]);
                    entity.ProductID = Convert.ToInt64(row["ProductID"]);
                    entity.ContainerID = Convert.ToInt32(row["ContainerID"]);
                    entity.ContainerCode = Convert.ToString(row["ContainerCode"]);
                    entity.AreaID = Convert.ToInt32(row["AreaID"]);
                    entity.TypeID = Convert.ToInt32(row["TypeID"]);
                    entity.Piece = Convert.ToInt32(row["Piece"]);//新数量
                    entity.InPiece = Convert.ToInt32(row["InPiece"]);//旧数量
                    entity.HouseID = Convert.ToInt32(row["HouseID"]);
                    entity.HouseName = Convert.ToString(row["HouseName"]);
                    entity.OrderNo = Convert.ToString(row["OrderNo"]);
                    entity.GoodsCode = Convert.ToString(row["GoodsCode"]).Trim();
                    entity.Specs = Convert.ToString(row["Specs"]);
                    entity.Model = Convert.ToString(row["Model"]);
                    entity.GoodsCode = Convert.ToString(row["GoodsCode"]);
                    entity.Figure = Convert.ToString(row["Figure"]);
                    entity.OutCargoID = Convert.ToString(row["OutCargoID"]);
                    entity.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                }
                if (msg.Result)
                {
                    CargoOrderBus bus = new CargoOrderBus();
                    bus.DrawUpPreOrder(entity, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
        #region 来货订单条码
        /// <summary>
        /// 查询来货订单条码
        /// </summary>
        public void QueryBarcodeData()
        {
            CargoFactoryOrderBarcodeEntity queryEntity = new CargoFactoryOrderBarcodeEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["VehicleNo"]))) { queryEntity.VehicleNo = Convert.ToString(Request["VehicleNo"]); }
            string spe = Convert.ToString(Request["Specs"]).ToUpper();
            if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
            {
                queryEntity.Specs = spe;
            }
            else
            {
                if (spe.Length <= 3)
                {
                    queryEntity.Specs = spe;
                }
                if (spe.Length > 3 && spe.Length <= 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                }
                if (spe.Length > 5)
                {
                    queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                }
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Figure"]))) { queryEntity.Figure = Convert.ToString(Request["Figure"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Batch"]))) { queryEntity.Batch = Convert.ToString(Request["Batch"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["GoodsCode"]))) { queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]); }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]).Equals(0) ? 1 : Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]).Equals(0) ? 1000 : Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryBarcodeData(pageIndex, pageSize, queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void QueryBarcodeDataExport()
        {
            string spe = Convert.ToString(Request["Specs"]).ToUpper();
            string err = "OK";
            if (spe == "查询条码" && !string.IsNullOrEmpty(Convert.ToString(Request["VehicleNo"])))
            {
                string QRcode = Convert.ToString(Request["VehicleNo"]);

                //调用马牌接口查询轮胎数据
                TimeSpan ts = DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0);
                string tms = Convert.ToInt64(ts.TotalSeconds).ToString();
                string sign = string.Empty;
                //二维码转条码 通过扫描轮胎上二维码查询该条轮胎具体信息

                string ss = "QRcode=" + QRcode + "&appKey=" + Common.GetContiappKey() + "&noise=" + Common.GetContinoise() + "&timestamp=" + tms + "&appSecret=" + Common.GetContiappSecret();
                if (!QRcode.ToUpper().Contains("R"))
                {
                    ss = "appKey=" + Common.GetContiappKey() + "&barcodes=%5B" + QRcode + "%5D" + "&noise=" + Common.GetContinoise() + "&timestamp=" + tms + "&appSecret=" + Common.GetContiappSecret();
                }
                //MD5加密
                using (MD5 md5Hash = MD5.Create())
                {
                    sign = Common.GetMd5Hash(md5Hash, ss);
                }
                NameValueCollection nvc = new NameValueCollection();
                nvc.Add("appKey", Common.GetContiappKey());
                nvc.Add("noise", Common.GetContinoise());
                nvc.Add("timestamp", tms);
                nvc.Add("sign", sign);
                nvc.Add("QRcode", QRcode);
                //二维码转条码 接口
                err = wxHttpUtility.PostForm("https://contiid.continental-tires.cn/api/2.0/TTP/QRgetBarcode", nvc, null);
            }
            else if (spe == "查询内侧码" && !string.IsNullOrEmpty(Convert.ToString(Request["VehicleNo"])))
            {
                string QRcode = Convert.ToString(Request["VehicleNo"]);

                //调用马牌接口查询轮胎数据
                TimeSpan ts = DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0);
                string tms = Convert.ToInt64(ts.TotalSeconds).ToString();
                string sign = string.Empty;
                //二维码转条码 通过扫描轮胎上二维码查询该条轮胎具体信息

                string ss = "QRcode=" + QRcode + "&appKey=" + Common.GetContiappKey() + "&noise=" + Common.GetContinoise() + "&timestamp=" + tms + "&appSecret=" + Common.GetContiappSecret();
                if (!QRcode.ToUpper().Contains("R"))
                {
                    ss = "appKey=" + Common.GetContiappKey() + "&barcodes=%5B" + QRcode + "%5D" + "&noise=" + Common.GetContinoise() + "&timestamp=" + tms + "&appSecret=" + Common.GetContiappSecret();
                }
                //MD5加密
                using (MD5 md5Hash = MD5.Create())
                {
                    sign = Common.GetMd5Hash(md5Hash, ss);
                }
                NameValueCollection nvc = new NameValueCollection();
                nvc.Add("appKey", Common.GetContiappKey());
                nvc.Add("noise", Common.GetContinoise());
                nvc.Add("timestamp", tms);
                nvc.Add("sign", sign);
                nvc.Add("barcodes", "%5B" + QRcode + "%5D");
                err = wxHttpUtility.PostForm("https://contiid.continental-tires.cn/api/2.0/TTP/getBarcodeInfo", nvc, null);
            }
            else
            {
                CargoFactoryOrderBarcodeEntity queryEntity = new CargoFactoryOrderBarcodeEntity();
                if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
                if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
                if (!string.IsNullOrEmpty(Convert.ToString(Request["VehicleNo"]))) { queryEntity.VehicleNo = Convert.ToString(Request["VehicleNo"]); }
                if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
                {
                    queryEntity.Specs = spe;
                }
                else
                {
                    if (spe.Length <= 3)
                    {
                        queryEntity.Specs = spe;
                    }
                    if (spe.Length > 3 && spe.Length <= 5)
                    {
                        queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                    }
                    if (spe.Length > 5)
                    {
                        queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                    }
                }
                if (!string.IsNullOrEmpty(Convert.ToString(Request["Figure"]))) { queryEntity.Figure = Convert.ToString(Request["Figure"]); }
                if (!string.IsNullOrEmpty(Convert.ToString(Request["Batch"]))) { queryEntity.Batch = Convert.ToString(Request["Batch"]); }
                if (!string.IsNullOrEmpty(Convert.ToString(Request["GoodsCode"]))) { queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]); }
                //分页
                int pageIndex = Convert.ToInt32(Request["page"]).Equals(0) ? 1 : Convert.ToInt32(Request["page"]);
                int pageSize = Convert.ToInt32(Request["rows"]).Equals(0) ? 1000 : Convert.ToInt32(Request["rows"]);
                CargoOrderBus bus = new CargoOrderBus();
                Hashtable list = bus.QueryBarcodeData(1, 10000, queryEntity);
                if (Convert.ToInt32(list["total"]) > 0) { QueryBarcodeDataList = list; } else { err = "无数据导出"; }
            }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        public Hashtable QueryBarcodeDataList
        {
            get
            {
                if (Session["QueryBarcodeDataList"] == null)
                {
                    Session["QueryBarcodeDataList"] = new Hashtable();
                }
                return (Hashtable)(Session["QueryBarcodeDataList"]);
            }
            set
            {
                Session["QueryBarcodeDataList"] = value;
            }
        }
        /// <summary>
        /// 导入来货订单轮胎码
        /// </summary>
        public void ImportBarcode()
        {
            string VehicleNo = Request["VehicleNo"];
            CargoOrderBus bus = new CargoOrderBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            if (!string.IsNullOrEmpty(VehicleNo))
            {
                try
                {
                    if (bus.IsExistBarcodeData(VehicleNo) > 0)
                    {
                        msg.Result = false;
                        msg.Message = "此船运单号已导入";
                    }
                    else
                    {
                        TimeSpan ts = DateTime.UtcNow - new DateTime(1970, 1, 1, 0, 0, 0, 0);
                        string tms = Convert.ToInt64(ts.TotalSeconds).ToString();
                        string sign = string.Empty;
                        string appKey = Common.GetContiappKey();
                        string noise = Common.GetContinoise();
                        string appSecret = Common.GetContiappSecret();
                        string ss = "appKey=" + appKey + "&noise=" + noise + "&timestamp=" + tms + "&vehicleNo=" + VehicleNo + "&appSecret=" + appSecret;
                        //MD5加密
                        using (MD5 md5Hash = MD5.Create())
                        {
                            sign = Common.GetMd5Hash(md5Hash, ss);
                        }
                        NameValueCollection nvc = new NameValueCollection();
                        nvc.Add("appKey", appKey);
                        nvc.Add("noise", noise);
                        nvc.Add("timestamp", tms);
                        nvc.Add("sign", sign);
                        nvc.Add("vehicleNo", VehicleNo);

                        string returnJson = wxHttpUtility.PostForm("https://contiid.continental-tires.cn/api/2.0/TTP/getRDCout", nvc, null);

                        JavaScriptSerializer js = new JavaScriptSerializer();
                        RetunBarcodeJson list = js.Deserialize<RetunBarcodeJson>(returnJson);

                        string code = list.code;
                        switch (code)
                        {
                            case "1000":
                                if (list.data.Count() <= 0)
                                {
                                    msg.Result = false;
                                    msg.Message = "此船运号无数据";
                                    break;
                                }
                                List<data> checkindata = list.data;
                                msg.Result = true;
                                List<CargoFactoryOrderBarcodeEntity> entityList = new List<CargoFactoryOrderBarcodeEntity>();
                                LogEntity log = new LogEntity();
                                log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                                log.Moudle = "订单管理";
                                log.Status = "0";
                                log.NvgPage = "船运单号导入";
                                log.UserID = UserInfor.LoginName.Trim();
                                log.Operate = "A";

                                foreach (var item in checkindata)
                                {
                                    string[] description = item.Description.Split(' ');
                                    string figure = string.Empty;
                                    for (int i = 2; i < description.Length; i++)
                                    {
                                        figure += description[i];
                                    }
                                    string goodsCode = string.Empty;
                                    if (item.material.Length > 6)
                                    {
                                        goodsCode = item.material + "0000";
                                    }
                                    else if (item.material.Length == 5)
                                    {
                                        goodsCode = "0" + item.material + "0000";
                                    }
                                    string loadSpeed = description[1].Replace("(", "").Replace(")", "");
                                    entityList.Add(new CargoFactoryOrderBarcodeEntity
                                    {
                                        VehicleNo = VehicleNo,
                                        Barcode = item.barcode,
                                        RDC = item.RDC,
                                        GoodsCode = goodsCode,
                                        Batch = item.DOT,
                                        Description = item.Description,
                                        OutTime = Convert.ToDateTime(item.outtime),
                                        Specs = description[0],
                                        Figure = figure,
                                        LoadIndex = loadSpeed.Substring(0, loadSpeed.Length - 1),
                                        SpeedLevel = loadSpeed.Substring(loadSpeed.Length - 1)
                                    });
                                }
                                bus.InsertBarcodeData(entityList, log);
                                break;
                            case "1004":
                                msg.Result = false;
                                msg.Message = "船运号格式错误";
                                break;
                            case "1102":
                                msg.Result = false;
                                msg.Message = "非法的appKey";
                                break;
                            case "1103":
                                msg.Result = false;
                                msg.Message = "你所在的机构被冻结";
                                break;
                            case "1104":
                                msg.Result = false;
                                msg.Message = "签名验证失败";
                                break;
                            case "1105":
                                msg.Result = false;
                                msg.Message = "你没有访问该接口权限";
                                break;
                            default:
                                msg.Result = false;
                                msg.Message = "未定义错误";
                                break;
                        }
                    }
                }
                catch (ApplicationException ex)
                {
                    msg.Result = false;
                    msg.Message = ex.Message;
                }
            }
            else
            {
                msg.Result = false;
                msg.Message = "未获取到船运单号";
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
        #region GTMC工厂订单导入 
        /// <summary>
        /// 查询数据
        /// </summary>
        public void QueryGtmcImportData()
        {
            CargoGtmcProOrderEntity queryEntity = new CargoGtmcProOrderEntity();

            queryEntity.TakeNo = Convert.ToString(Request["TakeNo"]);
            queryEntity.GtmcNo = Convert.ToString(Request["GtmcNo"]);
            queryEntity.SourceCode = Convert.ToString(Request["SourceCode"]);
            queryEntity.SourceName = Convert.ToString(Request["SourceName"]);
            queryEntity.Route = Convert.ToString(Request["Route"]);
            queryEntity.FrequentNo = Convert.ToString(Request["FrequentNo"]);
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            if (Convert.ToString(Request["AwbStatus"]) != "-1")
            {
                queryEntity.AwbStatus = Convert.ToString(Request["AwbStatus"]);
            }
            if (Convert.ToString(Request["OrderStatus"]) != "-1")
            {
                queryEntity.OrderStatus = Convert.ToString(Request["OrderStatus"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"])))
            {
                queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"])))
            {
                queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]);
            }
            queryEntity.HouseID = UserInfor.HouseID;
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]).Equals(0) ? 1 : Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]).Equals(0) ? 1000 : Convert.ToInt32(Request["rows"]);
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            Hashtable list = bus.QueryGtmcImportData(pageIndex, pageSize, queryEntity);
            var rows = list["rows"];

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 批量导入订单文件
        /// </summary>
        public void savePLPDFFile()
        {
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "批量订单导入";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            System.Web.HttpFileCollection files = this.Request.Files;
            if (files == null || files.Count == 0) return;
            CargoImportEntity import = new CargoImportEntity();
            import.Result = true;
            import.Data = "";
            import.Message = "";
            import.Type = 0;
            import.ExistCount = 0;
            string filePath = string.Empty;
            CargoInterfaceBus inter = new CargoInterfaceBus();
            List<CargoGtmcProOrderEntity> GtmcList = new List<CargoGtmcProOrderEntity>();
            List<CargoGtmcProOrderEntity> SaveGtmcList = new List<CargoGtmcProOrderEntity>();
            CargoFactoryOrderBus factbus = new CargoFactoryOrderBus();
            Dictionary<string, int> dicScource = new Dictionary<string, int>();
            CargoProductBus productBus = new CargoProductBus();
            for (int k = 0; k < files.Count; k++)
            {
                List<CargoGtmcProOrderDetailEntity> orderDetail = new List<CargoGtmcProOrderDetailEntity>();
                CargoGtmcProOrderEntity cargoGtmcProOrderEntity = new CargoGtmcProOrderEntity();
                cargoGtmcProOrderEntity.OPID = UserInfor.LoginName;
                cargoGtmcProOrderEntity.OPName = UserInfor.UserName;
                cargoGtmcProOrderEntity.HouseID = UserInfor.HouseID;
                HttpPostedFile file = files[k];
                cargoGtmcProOrderEntity.OrderFileName = file.FileName;
                if (factbus.IsExistGtmcOrder(cargoGtmcProOrderEntity))
                {
                    //判断是否已经存在GTMC广丰订单，存在就跳过界面提示
                    import.Type = 1;
                    cargoGtmcProOrderEntity.Info = "该订单已存在";
                    GtmcList.Add(cargoGtmcProOrderEntity);
                    continue;
                }
                string savePath = System.Web.HttpContext.Current.Server.MapPath("../upload/GTMC/" + file.FileName);
                file.SaveAs(savePath);
                filePath = Common.GetGTMCFile() + file.FileName;
                using (PdfReader reader = new PdfReader(filePath))
                {
                    using (PdfDocument pdfDocument = new PdfDocument(reader))
                    {
                        for (int i = 1; i <= pdfDocument.GetNumberOfPages(); i++)
                        {
                            string pdfContentString = iText.Kernel.Pdf.Canvas.Parser.PdfTextExtractor.GetTextFromPage(pdfDocument.GetPage(i));
                            string[] ssd = pdfContentString.Split('\n');
                            if (ssd.Length <= 33)
                            {
                                cargoGtmcProOrderEntity.Info = "该订单数据有误";
                                GtmcList.Add(cargoGtmcProOrderEntity);
                                import.Result = false;
                                import.Message = "订单数据有误";
                                continue;
                            }
                            List<string> resu = new List<string>();
                            bool PNO = false;
                            bool Fs = false;
                            string FsStr = string.Empty;
                            string IsEmptyOrder = Convert.ToString(ssd[4]);
                            if (!IsEmptyOrder.Contains("*"))
                            {
                                //说明是空单
                                continue;
                            }
                            string ThreeO = Convert.ToString(ssd[13]);
                            if (ThreeO.ToUpper().Contains("E"))
                            {
                                //包含字母E是紧急订单
                                cargoGtmcProOrderEntity.OrderType = "1";
                                for (int j = 0; j < ssd.Length; j++)
                                {
                                    if (j == 3)
                                    {
                                        cargoGtmcProOrderEntity.IncomeNo = Convert.ToString(ssd[j]);//受入号
                                    }
                                    if (j == 5)
                                    {
                                        cargoGtmcProOrderEntity.TakeNo = Convert.ToString(ssd[j]); //纳入番号
                                    }
                                    if (j == 10)
                                    {
                                        cargoGtmcProOrderEntity.SourceName = Convert.ToString(ssd[j]); //供应商名称
                                    }
                                    if (j == 13)
                                    {
                                        cargoGtmcProOrderEntity.GtmcNo = Convert.ToString(ssd[j]); //广丰订单号
                                    }
                                    if (j == 14)
                                    {
                                        cargoGtmcProOrderEntity.SourceCode = Convert.ToString(ssd[j]).Replace("-", ""); //供应商代码
                                    }
                                    if (j == 11)
                                    {
                                        cargoGtmcProOrderEntity.Piece = string.IsNullOrEmpty(Convert.ToString(ssd[j])) ? 0 : Convert.ToInt32(ssd[j]); //看板张数订单数量 
                                    }

                                    if (j > 27)
                                    {
                                        if (PNO && !Fs)
                                        {
                                            string ono = ssd[j];
                                            string[] onoStr = ssd[j].Split(' ');

                                            if (onoStr.Length > 2)
                                            {
                                                resu.Add(ssd[j].Replace("-", "")); PNO = false; Fs = false;
                                            }
                                            else
                                            {
                                                Fs = true; FsStr = ssd[j]; continue;
                                            }
                                        }
                                        if (PNO && Fs)
                                        {
                                            string ol = FsStr + " " + ssd[j];
                                            resu.Add(ol.Replace("-", ""));
                                            PNO = false; Fs = false; FsStr = string.Empty;
                                        }
                                        if (Common.IsInt(ssd[j])) { PNO = true; }
                                    }
                                }
                                //处理明细
                                if (resu.Count <= 0)
                                {
                                    cargoGtmcProOrderEntity.Info = "该订单明细有误";
                                    GtmcList.Add(cargoGtmcProOrderEntity);
                                    import.Result = false;
                                    import.Message = "订单明细有误";
                                    continue;
                                }
                                cargoGtmcProOrderEntity.TakeTime = DateTime.Now;
                                cargoGtmcProOrderEntity.DepartTime = DateTime.Now;
                                foreach (var re in resu)
                                {
                                    int typeID = 0;
                                    string[] reS = re.Split(' ');
                                    if (!dicScource.ContainsKey(Convert.ToString(reS[0])))
                                    {
                                        CargoProductEntity productEntity = productBus.QueryTopOneProduct(new CargoProductEntity { GoodsCode = Convert.ToString(reS[0]) });
                                        dicScource.Add(Convert.ToString(reS[0]), productEntity.TypeID);
                                    }
                                    dicScource.TryGetValue(Convert.ToString(reS[0]), out typeID);
                                    orderDetail.Add(new CargoGtmcProOrderDetailEntity
                                    {
                                        GoodsCode = Convert.ToString(reS[0]),
                                        Specs = Convert.ToString(reS[1]),
                                        Cage = Convert.ToString(reS[2]),
                                        PackNum = Convert.ToInt32(reS[3]),
                                        TotalNum = Convert.ToInt32(reS[4]),
                                        Piece = Convert.ToInt32(reS[5]),
                                        TypeID = typeID,
                                        GtmcNo = cargoGtmcProOrderEntity.GtmcNo,
                                        SourceCode = cargoGtmcProOrderEntity.SourceCode
                                    });
                                }
                            }
                            else
                            {
                                cargoGtmcProOrderEntity.OrderType = "0";
                                for (int j = 0; j < ssd.Length; j++)
                                {
                                    if (j == 3)
                                    {
                                        //纳入时间日期
                                        string[] dts = ssd[j].Split(' ');
                                        if (dts.Length > 2)
                                        {
                                            cargoGtmcProOrderEntity.TakeTime = Convert.ToDateTime(dts[0] + " " + dts[1]);
                                            cargoGtmcProOrderEntity.IncomeNo = Convert.ToString(dts[2]);//受入号
                                        }
                                    }
                                    if (j == 5)
                                    {
                                        cargoGtmcProOrderEntity.TakeNo = Convert.ToString(ssd[j]); //纳入番号
                                    }
                                    if (j == 11)
                                    {
                                        cargoGtmcProOrderEntity.SourceName = Convert.ToString(ssd[j]); //供应商名称
                                    }
                                    if (j == 14)
                                    {
                                        cargoGtmcProOrderEntity.GtmcNo = Convert.ToString(ssd[j]); //广丰订单号
                                    }
                                    if (j == 15)
                                    {
                                        cargoGtmcProOrderEntity.SourceCode = Convert.ToString(ssd[j]).Replace("-", ""); //供应商代码
                                    }
                                    if (j == 8)
                                    {
                                        string[] dts = ssd[j].Split(' ');
                                        if (dts.Length > 1)
                                        {
                                            cargoGtmcProOrderEntity.MainRoute = Convert.ToString(dts[0]);//主路线
                                            cargoGtmcProOrderEntity.SplitLine = Convert.ToString(dts[1]);//分割链
                                        }
                                    }
                                    if (j == 12)
                                    {
                                        cargoGtmcProOrderEntity.Piece = string.IsNullOrEmpty(Convert.ToString(ssd[j])) ? 0 : Convert.ToInt32(ssd[j]); //看板张数订单数量 
                                    }
                                    if (j == 20)
                                    {
                                        string[] dts = ssd[j].Split(' ');
                                        if (dts.Length > 0)
                                        {
                                            cargoGtmcProOrderEntity.DepartDate = Convert.ToString(dts[0]);//发车时间年月日
                                        }
                                    }
                                    if (j == 22)
                                    {
                                        string[] dts = ssd[j].Split(' ');
                                        if (dts.Length > 0)
                                        {
                                            cargoGtmcProOrderEntity.DepartHour = Convert.ToString(dts[0]);//发车时间时分秒
                                            cargoGtmcProOrderEntity.DepartTime = Convert.ToDateTime(cargoGtmcProOrderEntity.DepartDate + " " + cargoGtmcProOrderEntity.DepartHour);
                                        }
                                    }
                                    if (j == 21)
                                    {
                                        string[] dts = ssd[j].Split(' ');
                                        if (dts.Length > 0)
                                        {
                                            cargoGtmcProOrderEntity.Route = Convert.ToString(dts[0]);//路线名
                                        }
                                    }
                                    if (j == 23)
                                    {
                                        string[] dts = ssd[j].Split(' ');
                                        if (dts.Length > 0)
                                        {
                                            cargoGtmcProOrderEntity.FrequentNo = Convert.ToString(dts[0]);//便次
                                        }
                                    }

                                    if (j > 30)
                                    {
                                        if (PNO && !Fs)
                                        {
                                            string ono = ssd[j];
                                            string[] onoStr = ssd[j].Split(' ');

                                            if (onoStr.Length > 2)
                                            {
                                                resu.Add(ssd[j].Replace("-", "")); PNO = false; Fs = false;
                                            }
                                            else
                                            {
                                                Fs = true; FsStr = ssd[j]; continue;
                                            }
                                        }
                                        if (PNO && Fs)
                                        {
                                            string ol = FsStr + " " + ssd[j];
                                            resu.Add(ol.Replace("-", ""));
                                            PNO = false; Fs = false; FsStr = string.Empty;
                                        }
                                        if (Common.IsInt(ssd[j])) { PNO = true; }
                                    }
                                }
                                //处理明细
                                if (resu.Count <= 0)
                                {
                                    cargoGtmcProOrderEntity.Info = "该订单明细有误";
                                    GtmcList.Add(cargoGtmcProOrderEntity);
                                    import.Result = false;
                                    import.Message = "订单明细有误";
                                    continue;
                                }
                                foreach (var re in resu)
                                {
                                    int typeID = 0;
                                    string[] reS = re.Split(' ');
                                    if (!dicScource.ContainsKey(Convert.ToString(reS[0])))
                                    {
                                        CargoProductEntity productEntity = productBus.QueryTopOneProduct(new CargoProductEntity { GoodsCode = Convert.ToString(reS[0]) });
                                        dicScource.Add(Convert.ToString(reS[0]), productEntity.TypeID);
                                    }
                                    dicScource.TryGetValue(Convert.ToString(reS[0]), out typeID);
                                    orderDetail.Add(new CargoGtmcProOrderDetailEntity
                                    {
                                        GoodsCode = Convert.ToString(reS[0]),
                                        Specs = Convert.ToString(reS[1]),
                                        Cage = Convert.ToString(reS[2]),
                                        PackNum = Convert.ToInt32(reS[3]),
                                        TotalNum = Convert.ToInt32(reS[4]),
                                        Piece = Convert.ToInt32(reS[5]),
                                        TypeID = typeID,
                                        GtmcNo = cargoGtmcProOrderEntity.GtmcNo,
                                        SourceCode = cargoGtmcProOrderEntity.SourceCode
                                    });
                                }
                            }


                            cargoGtmcProOrderEntity.orderDetail = orderDetail;
                            cargoGtmcProOrderEntity.Info = "导入成功";
                            cargoGtmcProOrderEntity.OrderStatus = "0";
                            GtmcList.Add(cargoGtmcProOrderEntity);
                            SaveGtmcList.Add(cargoGtmcProOrderEntity);
                        }
                    }
                }

            }

            if (SaveGtmcList.Count > 0)
            {
                factbus.SaveGTMCImportData(SaveGtmcList, log);
            }
            //if (import.Result)
            //{
            //cargoGtmcProOrderEntity.orderDetail = orderDetail;
            String json = JSON.Encode(GtmcList);
            import.Data = json;
            //import.TempData = JSON.Encode(cargoGtmcProOrderEntity);

            //}
            String abnormalJson = JSON.Encode(import);
            Response.Clear();
            Response.Write(abnormalJson);
            Response.End();
        }
        /// <summary>
        /// 上传文件
        /// </summary>
        public void savePDFFile()
        {
            System.Web.HttpFileCollection files = this.Request.Files;
            if (files == null || files.Count == 0) return;
            CargoImportEntity import = new CargoImportEntity();
            import.Result = true;
            import.Data = "";
            import.Message = "";
            import.Type = 0;
            import.ExistCount = 0;
            string filePath = string.Empty;
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoGtmcProOrderEntity cargoGtmcProOrderEntity = new CargoGtmcProOrderEntity();
            List<CargoGtmcProOrderDetailEntity> orderDetail = new List<CargoGtmcProOrderDetailEntity>();
            for (int i = 0; i < files.Count; i++)
            {
                HttpPostedFile file = files[i];
                string savePath = System.Web.HttpContext.Current.Server.MapPath("../upload/GTMC/" + file.FileName);
                file.SaveAs(savePath);
                filePath = Common.GetGTMCFile() + file.FileName;
            }

            using (PdfReader reader = new PdfReader(filePath))
            {
                using (PdfDocument pdfDocument = new PdfDocument(reader))
                {
                    for (int i = 1; i <= pdfDocument.GetNumberOfPages(); i++)
                    {
                        string pdfContentString = iText.Kernel.Pdf.Canvas.Parser.PdfTextExtractor.GetTextFromPage(pdfDocument.GetPage(i));
                        string[] ssd = pdfContentString.Split('\n');
                        if (ssd.Length <= 33)
                        {
                            import.Result = false;
                            import.Message = "订单数据有误";
                            break;
                        }
                        List<string> resu = new List<string>();
                        bool PNO = false;
                        bool Fs = false;
                        string FsStr = string.Empty;
                        for (int j = 0; j < ssd.Length; j++)
                        {
                            if (j == 3)
                            {
                                //纳入时间日期
                                string[] dts = ssd[j].Split(' ');
                                if (dts.Length > 2)
                                {
                                    cargoGtmcProOrderEntity.TakeTime = Convert.ToDateTime(dts[0] + " " + dts[1]);
                                    cargoGtmcProOrderEntity.IncomeNo = Convert.ToString(dts[2]);//受入号
                                }
                            }
                            if (j == 8)
                            {
                                string[] dts = ssd[j].Split(' ');
                                if (dts.Length > 1)
                                {
                                    cargoGtmcProOrderEntity.MainRoute = Convert.ToString(dts[0]);//主路线
                                    cargoGtmcProOrderEntity.SplitLine = Convert.ToString(dts[1]);//分割链
                                }
                            }
                            if (j == 21)
                            {
                                string[] dts = ssd[j].Split(' ');
                                if (dts.Length > 0)
                                {
                                    cargoGtmcProOrderEntity.Route = Convert.ToString(dts[0]);//路线名
                                }
                            }
                            if (j == 23)
                            {
                                string[] dts = ssd[j].Split(' ');
                                if (dts.Length > 0)
                                {
                                    cargoGtmcProOrderEntity.FrequentNo = Convert.ToString(dts[0]);//便次
                                }
                            }
                            if (j == 5)
                            {
                                cargoGtmcProOrderEntity.TakeNo = Convert.ToString(ssd[j]); //纳入番号
                            }
                            if (j == 11)
                            {
                                cargoGtmcProOrderEntity.SourceName = Convert.ToString(ssd[j]); //供应商名称
                            }
                            if (j == 14)
                            {
                                cargoGtmcProOrderEntity.GtmcNo = Convert.ToString(ssd[j]); //广丰订单号
                            }
                            if (j == 15)
                            {
                                cargoGtmcProOrderEntity.SourceCode = Convert.ToString(ssd[j]).Replace("-", ""); //供应商代码
                            }
                            if (j > 30)
                            {
                                if (PNO && !Fs)
                                {
                                    string ono = ssd[j];
                                    string[] onoStr = ssd[j].Split(' ');

                                    if (onoStr.Length > 2)
                                    {
                                        resu.Add(ssd[j].Replace("-", "")); PNO = false; Fs = false;
                                    }
                                    else
                                    {
                                        Fs = true; FsStr = ssd[j]; continue;
                                    }
                                }
                                if (PNO && Fs)
                                {
                                    string ol = FsStr + " " + ssd[j];
                                    resu.Add(ol.Replace("-", ""));
                                    PNO = false; Fs = false; FsStr = string.Empty;
                                }
                                if (Common.IsInt(ssd[j])) { PNO = true; }
                            }
                        }
                        //处理明细
                        if (resu.Count <= 0)
                        {
                            import.Result = false;
                            import.Message = "订单明细有误";
                            break;
                        }
                        foreach (var re in resu)
                        {
                            string[] reS = re.Split(' ');
                            orderDetail.Add(new CargoGtmcProOrderDetailEntity
                            {
                                GoodsCode = Convert.ToString(reS[0]),
                                Specs = Convert.ToString(reS[1]),
                                Cage = Convert.ToString(reS[2]),
                                PackNum = Convert.ToInt32(reS[3]),
                                TotalNum = Convert.ToInt32(reS[4]),
                                Piece = Convert.ToInt32(reS[5]),
                                GtmcNo = cargoGtmcProOrderEntity.GtmcNo,
                                SourceCode = cargoGtmcProOrderEntity.SourceCode
                            });
                        }
                    }
                }
            }
            if (import.Result)
            {
                //查询库存
                foreach (var o in orderDetail)
                {
                    CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                    {
                        ProductName = "",
                        HouseID = UserInfor.HouseID,
                        GoodsCode = o.GoodsCode,
                        //TypeID = 355,
                        Model = "",
                        Specs = o.Specs,
                        Batch = "",
                        BatckWeek = 0,
                        ParentID = 354,
                        Figure = ""
                    };
                    int tn = inter.queryCargoStock(queryEntity).Sum(c => c.StockNum);
                    o.Stock = inter.queryCargoStock(queryEntity).Where(c => c.IsAddOrder.Equals("0")).Sum(c => c.StockNum);
                    o.NoStock = tn - o.Stock;
                    if (o.Piece > o.Stock)
                    {
                        o.status = "1";
                    }
                }
                //cargoGtmcProOrderEntity.orderDetail = orderDetail;
                String json = JSON.Encode(orderDetail);
                import.Data = json;
                import.TempData = JSON.Encode(cargoGtmcProOrderEntity);
                CargoFactoryOrderBus factbus = new CargoFactoryOrderBus();
                if (factbus.IsExistGtmcOrder(cargoGtmcProOrderEntity))
                {
                    //判断是否已经存在GTMC广丰订单，存在就界面提示
                    import.Type = 1;
                }
            }
            String abnormalJson = JSON.Encode(import);
            Response.Clear();
            Response.Write(abnormalJson);
            Response.End();
        }
        /// <summary>
        /// 保存开单
        /// </summary>
        public void SaveGTMCImportData()
        {
            String json = Request["data"];
            string GTMCOrder = Request["GTMCOrder"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            CargoFactoryOrderBus factbus = new CargoFactoryOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "广丰订单导入";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            CargoInterfaceBus inter = new CargoInterfaceBus();

            List<CargoGtmcProOrderDetailEntity> list = new List<CargoGtmcProOrderDetailEntity>();
            CargoGtmcProOrderEntity cargoGtmcProOrderEntity = new CargoGtmcProOrderEntity();
            ArrayList pe = (ArrayList)JSON.Decode("[" + GTMCOrder + "]");
            foreach (Hashtable ro in pe)
            {
                cargoGtmcProOrderEntity.TakeNo = Convert.ToString(ro["TakeNo"]);
                cargoGtmcProOrderEntity.GtmcNo = Convert.ToString(ro["GtmcNo"]);
                cargoGtmcProOrderEntity.SourceCode = Convert.ToString(ro["SourceCode"]);
                cargoGtmcProOrderEntity.SourceName = Convert.ToString(ro["SourceName"]);
                cargoGtmcProOrderEntity.TakeTime = Convert.ToDateTime(ro["TakeTime"]);
                cargoGtmcProOrderEntity.Route = Convert.ToString(ro["Route"]);
                cargoGtmcProOrderEntity.FrequentNo = Convert.ToString(ro["FrequentNo"]);
                cargoGtmcProOrderEntity.IncomeNo = Convert.ToString(ro["IncomeNo"]);
                cargoGtmcProOrderEntity.MainRoute = Convert.ToString(ro["MainRoute"]);
                cargoGtmcProOrderEntity.SplitLine = Convert.ToString(ro["SplitLine"]);
                cargoGtmcProOrderEntity.OPID = UserInfor.LoginName;
                cargoGtmcProOrderEntity.OPName = UserInfor.UserName;
                cargoGtmcProOrderEntity.HouseID = UserInfor.HouseID;

            }
            foreach (Hashtable row in rows)
            {
                list.Add(new CargoGtmcProOrderDetailEntity
                {
                    GoodsCode = Convert.ToString(row["GoodsCode"]),
                    Specs = Convert.ToString(row["Specs"]),
                    GoodsName = Convert.ToString(row["GoodsName"]),
                    Cage = Convert.ToString(row["Cage"]),
                    PackNum = Convert.ToInt32(row["PackNum"]),
                    TotalNum = Convert.ToInt32(row["TotalNum"]),
                    status = Convert.ToString(row["status"]),
                    Piece = Convert.ToInt32(row["Piece"])
                });
            }
            cargoGtmcProOrderEntity.orderDetail = list;
            //生成系统订单
            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            List<QyOrderUpdateGoodsEntity> goods = new List<QyOrderUpdateGoodsEntity>();
            int HouseID = UserInfor.HouseID;
            try
            {
                if (msg.Result)
                {
                    #region 赋值
                    ent.HAwbNo = cargoGtmcProOrderEntity.GtmcNo;//关联订单号
                    ent.LogisAwbNo = cargoGtmcProOrderEntity.TakeNo;
                    if (HouseID.Equals(62))
                    {
                        //太石仓库特殊处理
                        ent.Dest = ent.Dep = "南沙";
                    }
                    ent.Piece = string.IsNullOrEmpty(Convert.ToString(Request["Piece"])) ? 0 : Convert.ToInt32(Request["Piece"]);
                    ent.Weight = ent.Volume = ent.InsuranceFee = ent.TransitFee = ent.TransportFee = ent.DeliveryFee = ent.OtherFee = ent.TotalCharge = ent.Rebate = 0;
                    ent.HouseID = HouseID;
                    ent.CheckOutType = "";
                    ent.TrafficType = "0";// 内部订单
                    ent.DeliveryType = "0";//Convert.ToString(Request["DeliveryType"]);
                    ent.AcceptAddress = "广丰生产公司";
                    ent.AcceptPeople = "丰通物流";

                    ent.AcceptUnit = "丰通物流";
                    ent.AcceptTelephone = "";
                    ent.AcceptCellphone = "";
                    ent.ShopCode = "";
                    ent.CreateAwb = UserInfor.UserName;
                    ent.CreateAwbID = UserInfor.LoginName;
                    ent.CreateDate = DateTime.Now;// Convert.ToDateTime(Request["CreateDate"]);
                    ent.OP_ID = UserInfor.LoginName.Trim();
                    ent.ThrowGood = "0";
                    ent.IsPrintPrice = 0;
                    ent.TranHouse = "";
                    ent.PostponeShip = "0";
                    ent.LogisID = 0;
                    ent.ClientNum = ent.PayClientNum = 783644;
                    ent.PayClientName = "丰通物流";
                    ent.DeliverySettlement = null;
                    int OrderNum = 0;
                    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, "GF", out OrderNum); // Convert.ToString(Request["OrderNo"]);//生成最新顺序订单号
                                                                                                   //int RetryCount = 0;
                                                                                                   //while (OrderNoList.Contains(ent.OrderNo))
                                                                                                   //{
                                                                                                   //    RetryCount++;
                                                                                                   //    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, "GF", out OrderNum, RetryCount);
                                                                                                   //}
                                                                                                   //OrderNoList.Add(ent.OrderNo);
                    ent.OrderNum = OrderNum;//最新订单顺序号

                    #endregion
                    int pieceSum = 0;
                    string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                    string oS = "1";
                    int ProOrderPiece = 0;
                    foreach (var o in list)
                    {
                        ProOrderPiece += o.Piece;
                        int piece = o.Piece;
                        CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                        {
                            ProductName = "",
                            HouseID = UserInfor.HouseID,
                            GoodsCode = o.GoodsCode,
                            //TypeID = 355,
                            Model = "",
                            Specs = o.Specs,
                            Batch = "",
                            BatckWeek = 0,
                            ParentID = 354,
                            Figure = ""
                        };
                        List<CargoInterfaceEntity> stockList = inter.queryCargoStock(queryEntity).Where(c => c.IsAddOrder.Equals("0")).ToList();
                        List<CargoInterfaceEntity> NostockList = inter.queryCargoStock(queryEntity).Where(c => c.IsAddOrder != "0").ToList();


                        if (stockList.Count <= 0)
                        {
                            oS = "2";
                            continue;
                            msg.Result = false;
                            msg.Message = "公司代码：" + o.SourceCode + "，品番：" + o.GoodsCode + "，背番：" + o.Specs + "出库仓库存为空";
                            goto ErrEND;
                        }
                        if (stockList.Sum(c => c.StockNum) < piece)
                        {
                            oS = "2";
                            continue;
                            msg.Result = false;
                            msg.Message = "公司代码：" + o.SourceCode + "，品番：" + o.GoodsCode + "，背番：" + o.Specs + "出库仓库存为：" + stockList.Sum(c => c.StockNum).ToString();
                            goto ErrEND;
                        }
                        //减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                        foreach (var it in stockList)
                        {
                            if (it.StockNum <= 0) { continue; }
                            if (NostockList.Exists(c => Convert.ToInt32(c.Batch) < Convert.ToInt32(it.Batch)))
                            {
                                msg.Result = false;
                                msg.Message = "存储区有更早周期产品，请优先出库";
                                break;
                            }
                            CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                            cargo.OrderNo = ent.OrderNo;//订单号
                            cargo.OutCargoID = outID;
                            cargo.ContainerID = it.ContainerID;
                            cargo.TypeID = it.TypeID;
                            cargo.ProductID = it.ProductID;

                            cargo.ID = it.ContainerGoodsID;//库存表ID

                            cargo.HouseName = "生产物流仓库";
                            cargo.ProductName = it.ProductName;
                            cargo.Model = it.Model;
                            cargo.Specs = it.Specs;
                            cargo.Figure = it.Figure;
                            #region 减库存逻辑
                            if (piece < it.StockNum)
                            {
                                //部分出
                                entDest.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    ProductID = it.ProductID,
                                    HouseID = ent.HouseID,
                                    AreaID = it.AreaID,
                                    Piece = piece,
                                    ActSalePrice = 0,
                                    ContainerCode = it.ContainerCode,
                                    OutCargoID = outID,
                                    OP_ID = log.UserID
                                });
                                cargo.Piece = piece;
                                cargo.InPiece = it.StockNum;

                                outHouseList.Add(cargo);
                                pieceSum += cargo.Piece;
                                break;
                            }
                            if (piece.Equals(it.StockNum))
                            {
                                //要出库件数和第一条库存件数刚刚好，则就全部出
                                entDest.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    ProductID = it.ProductID,
                                    HouseID = ent.HouseID,
                                    AreaID = it.AreaID,
                                    Piece = piece,
                                    ActSalePrice = 0,
                                    ContainerCode = it.ContainerCode,
                                    OutCargoID = outID,
                                    OP_ID = log.UserID
                                });
                                cargo.Piece = piece;
                                cargo.InPiece = it.StockNum;

                                outHouseList.Add(cargo);
                                pieceSum += cargo.Piece;
                                break;
                            }
                            if (piece > it.StockNum)
                            {
                                //全部出
                                entDest.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    ProductID = it.ProductID,
                                    HouseID = ent.HouseID,
                                    AreaID = it.AreaID,
                                    Piece = it.StockNum,
                                    ActSalePrice = 0,
                                    ContainerCode = it.ContainerCode,
                                    OutCargoID = outID,
                                    OP_ID = log.UserID
                                });
                                cargo.Piece = it.StockNum;
                                cargo.InPiece = it.StockNum;

                                outHouseList.Add(cargo);
                                pieceSum += cargo.Piece;
                                piece = piece - it.StockNum;
                                continue;
                            }
                            #endregion
                        }
                    }
                    ent.Piece = pieceSum;
                    ent.OutHouseName = "生产物流仓库";
                    ent.TransportFee = 0;
                    ent.TotalCharge = 0;
                    ent.AwbStatus = "0";
                    ent.OrderType = "0";
                    ent.HouseID = HouseID;
                    ent.HouseName = "生产物流仓库";
                    ent.goodsList = entDest;
                    ent.ModifyPriceStatus = "0";
                    if (pieceSum <= 0) { oS = "0"; }
                    if (msg.Result)
                    {
                        if (pieceSum > 0)
                        {
                            cargoGtmcProOrderEntity.OrderNo = ent.OrderNo;

                        }
                        cargoGtmcProOrderEntity.OrderStatus = oS;
                        cargoGtmcProOrderEntity.Piece = ProOrderPiece;
                        factbus.SaveGTMCImportData(cargoGtmcProOrderEntity, log);
                        if (pieceSum > 0)
                        {

                            //仓库同步缓存
                            CargoHouseBus house = new CargoHouseBus();
                            foreach (CargoContainerShowEntity time in outHouseList)
                            {
                                CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                                //34 马牌  1 同步马牌  2 同步全部品牌
                                if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                                {
                                    RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                                }
                            }

                            bus.AddOrderInfo(ent, outHouseList, log);
                            //推送好来运系统
                            bus.InsertCargoOrderPush(new CargoOrderPushEntity
                            {
                                OrderNo = ent.OrderNo,
                                Dep = ent.Dep,
                                Dest = ent.Dest,
                                Piece = ent.Piece,
                                TransportFee = ent.TransportFee,
                                ClientNum = ent.ClientNum.ToString(),
                                AcceptAddress = ent.AcceptAddress,
                                AcceptCellphone = ent.AcceptCellphone,
                                AcceptTelephone = ent.AcceptTelephone,
                                AcceptPeople = ent.AcceptPeople,
                                AcceptUnit = ent.AcceptUnit,
                                HouseID = ent.HouseID.ToString(),
                                HouseName = ent.OutHouseName,
                                OP_ID = UserInfor.UserName,
                                PushType = "0",
                                PushStatus = "0",
                                LogisID = ent.LogisID
                            }, log);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }

        ErrEND:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }
        /// <summary>
        /// 重新保存订单
        /// </summary>
        public void ReSaveGTMCImportData()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            CargoFactoryOrderBus factbus = new CargoFactoryOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "生成系统订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            string TID = Convert.ToString(Request["TID"]);
            if (String.IsNullOrEmpty(TID)) return;
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoGtmcProOrderEntity gtmcOrder = factbus.QueryGtmcProOrderEntity(new CargoGtmcProOrderEntity { TID = Convert.ToInt32(TID) });
            if (!string.IsNullOrEmpty(gtmcOrder.OrderNo))
            {
                msg.Result = false;
                msg.Message = "该订单已开单，请刷新后保存";
                goto ErrEND;
            }
            List<CargoGtmcProOrderDetailEntity> list = gtmcOrder.orderDetail;

            //生成系统订单
            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            List<QyOrderUpdateGoodsEntity> goods = new List<QyOrderUpdateGoodsEntity>();
            int HouseID = UserInfor.HouseID;
            try
            {
                if (msg.Result)
                {
                    #region 赋值
                    ent.HAwbNo = gtmcOrder.GtmcNo;//关联订单号
                    ent.LogisAwbNo = gtmcOrder.TakeNo;
                    if (HouseID.Equals(62))
                    {
                        //太石仓库特殊处理
                        ent.Dest = ent.Dep = "南沙";
                    }
                    ent.Piece = 0;
                    ent.Weight = ent.Volume = ent.InsuranceFee = ent.TransitFee = ent.TransportFee = ent.DeliveryFee = ent.OtherFee = ent.TotalCharge = ent.Rebate = 0;
                    ent.HouseID = HouseID;
                    ent.CheckOutType = "";
                    ent.TrafficType = "0";// 内部订单
                    ent.DeliveryType = "0";//Convert.ToString(Request["DeliveryType"]);
                    ent.AcceptAddress = "广丰生产公司";
                    ent.AcceptPeople = "丰通物流";
                    ent.AcceptUnit = "丰通物流";
                    ent.AcceptTelephone = "";
                    ent.AcceptCellphone = "";
                    ent.ShopCode = "";
                    ent.CreateAwb = UserInfor.UserName;
                    ent.CreateAwbID = UserInfor.LoginName;
                    ent.CreateDate = DateTime.Now;// Convert.ToDateTime(Request["CreateDate"]);
                    ent.OP_ID = UserInfor.LoginName.Trim();
                    ent.ThrowGood = "0";
                    ent.IsPrintPrice = 0;
                    ent.TranHouse = "";
                    ent.PostponeShip = "0";
                    ent.LogisID = 0;
                    ent.ClientNum = ent.PayClientNum = 783644;
                    ent.PayClientName = "丰通物流";
                    ent.DeliverySettlement = null;
                    int OrderNum = 0;
                    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, "GF", out OrderNum); // Convert.ToString(Request["OrderNo"]);//生成最新顺序订单号
                                                                                                   //int RetryCount = 0;
                                                                                                   //while (OrderNoList.Contains(ent.OrderNo))
                                                                                                   //{
                                                                                                   //    RetryCount++;
                                                                                                   //    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, "GF", out OrderNum, RetryCount);
                                                                                                   //}
                                                                                                   //OrderNoList.Add(ent.OrderNo);
                    ent.OrderNum = OrderNum;//最新订单顺序号

                    #endregion
                    int pieceSum = 0;
                    string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                    string oS = "1";
                    foreach (var o in list)
                    {
                        int piece = o.Piece;
                        CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                        {
                            ProductName = "",
                            HouseID = UserInfor.HouseID,
                            GoodsCode = o.GoodsCode,
                            TypeID = o.TypeID,
                            Model = "",
                            Specs = "",//o.Specs,
                            Batch = "",
                            BatckWeek = 0,
                            ParentID = 354,
                            Figure = ""
                        };
                        List<CargoInterfaceEntity> stockList = inter.queryCargoStock(queryEntity).Where(c => c.IsAddOrder.Equals("0")).ToList();
                        List<CargoInterfaceEntity> NostockList = inter.queryCargoStock(queryEntity).Where(c => c.IsAddOrder != "0").ToList();
                        if (stockList.Count <= 0)
                        {
                            oS = "2";
                            continue;
                            msg.Result = false;
                            msg.Message = "公司代码：" + o.SourceCode + "，品番：" + o.GoodsCode + "，背番：" + o.Specs + "出库仓库存为空";
                            goto ErrEND;
                        }
                        if (stockList.Sum(c => c.StockNum) < piece)
                        {
                            oS = "2";
                            //continue;
                            //msg.Result = false;
                            //msg.Message = "公司代码：" + o.SourceCode + "，品番：" + o.GoodsCode + "，背番：" + o.Specs + "出库仓库存为：" + stockList.Sum(c => c.StockNum).ToString();
                            //goto ErrEND;
                        }
                        //减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                        foreach (var it in stockList)
                        {
                            if (it.StockNum <= 0) { continue; }
                            if (NostockList.Exists(c => Convert.ToInt32(c.Batch) < Convert.ToInt32(it.Batch)))
                            {
                                msg.Result = false;
                                msg.Message = "存储区有更早周期产品，请优先出库";
                                break;
                            }
                            CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                            cargo.OrderNo = ent.OrderNo;//订单号
                            cargo.OutCargoID = outID;
                            cargo.ContainerID = it.ContainerID;
                            cargo.TypeID = it.TypeID;
                            cargo.ProductID = it.ProductID;

                            cargo.ID = it.ContainerGoodsID;//库存表ID

                            cargo.HouseName = "生产物流仓库";
                            cargo.ProductName = it.ProductName;
                            cargo.Model = it.Model;
                            cargo.Specs = it.Specs;
                            cargo.Figure = it.Figure;
                            #region 减库存逻辑
                            if (piece < it.StockNum)
                            {
                                //部分出
                                entDest.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    ProductID = it.ProductID,
                                    HouseID = ent.HouseID,
                                    AreaID = it.AreaID,
                                    Piece = piece,
                                    ActSalePrice = 0,
                                    ContainerCode = it.ContainerCode,
                                    OutCargoID = outID,
                                    OP_ID = log.UserID
                                });
                                cargo.Piece = piece;
                                cargo.InPiece = it.StockNum;

                                outHouseList.Add(cargo);
                                pieceSum += cargo.Piece;
                                break;
                            }
                            if (piece.Equals(it.StockNum))
                            {
                                //要出库件数和第一条库存件数刚刚好，则就全部出
                                entDest.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    ProductID = it.ProductID,
                                    HouseID = ent.HouseID,
                                    AreaID = it.AreaID,
                                    Piece = piece,
                                    ActSalePrice = 0,
                                    ContainerCode = it.ContainerCode,
                                    OutCargoID = outID,
                                    OP_ID = log.UserID
                                });
                                cargo.Piece = piece;
                                cargo.InPiece = it.StockNum;

                                outHouseList.Add(cargo);
                                pieceSum += cargo.Piece;
                                break;
                            }
                            if (piece > it.StockNum)
                            {
                                //全部出
                                entDest.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    ProductID = it.ProductID,
                                    HouseID = ent.HouseID,
                                    AreaID = it.AreaID,
                                    Piece = it.StockNum,
                                    ActSalePrice = 0,
                                    ContainerCode = it.ContainerCode,
                                    OutCargoID = outID,
                                    OP_ID = log.UserID
                                });
                                cargo.Piece = it.StockNum;
                                cargo.InPiece = it.StockNum;

                                outHouseList.Add(cargo);
                                pieceSum += cargo.Piece;
                                piece = piece - it.StockNum;
                                continue;
                            }
                            #endregion
                        }
                    }
                    ent.Piece = pieceSum;
                    ent.OutHouseName = "生产物流仓库";
                    ent.TransportFee = 0;
                    ent.TotalCharge = 0;
                    ent.AwbStatus = "0";
                    ent.OrderType = "0";
                    ent.HouseID = HouseID;
                    ent.HouseName = "生产物流仓库";
                    ent.goodsList = entDest;
                    ent.ModifyPriceStatus = "0";
                    if (outHouseList.Count <= 0)
                    {
                        msg.Message = "订单库存不足"; msg.Result = false;
                    }
                    if (msg.Result)
                    {
                        //仓库同步缓存
                        CargoHouseBus house = new CargoHouseBus();
                        foreach (CargoContainerShowEntity time in outHouseList)
                        {
                            CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                            //34 马牌  1 同步马牌  2 同步全部品牌
                            if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                            {
                                RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                            }
                        }

                        bus.AddOrderInfo(ent, outHouseList, log);
                        if (pieceSum < gtmcOrder.Piece)
                        {
                            oS = "2";
                            if (UserInfor.SpecialCreateAwb.Equals("0"))
                            {
                                msg.Result = false;
                                msg.Message = "缺货订单，请让仓库查找库存";
                                goto ErrEND;
                            }
                        }
                        gtmcOrder.OrderNo = ent.OrderNo;
                        gtmcOrder.OrderStatus = oS;
                        factbus.UpdateGtmcProOrderStatus(gtmcOrder);
                        //推送好来运系统
                        bus.InsertCargoOrderPush(new CargoOrderPushEntity
                        {
                            OrderNo = ent.OrderNo,
                            Dep = ent.Dep,
                            Dest = ent.Dest,
                            Piece = ent.Piece,
                            TransportFee = ent.TransportFee,
                            ClientNum = ent.ClientNum.ToString(),
                            AcceptAddress = ent.AcceptAddress,
                            AcceptCellphone = ent.AcceptCellphone,
                            AcceptTelephone = ent.AcceptTelephone,
                            AcceptPeople = ent.AcceptPeople,
                            AcceptUnit = ent.AcceptUnit,
                            HouseID = ent.HouseID.ToString(),
                            HouseName = ent.OutHouseName,
                            OP_ID = UserInfor.UserName,
                            PushType = "0",
                            PushStatus = "0",
                            LogisID = ent.LogisID
                        }, log);
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }

        ErrEND:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }
        /// <summary>
        /// 查询广丰订单数据
        /// </summary>
        public void QueryGTMCOrderByID()
        {
            CargoGtmcProOrderDetailEntity queryEntity = new CargoGtmcProOrderDetailEntity();
            //查询条件
            string key = Request["TID"];
            if (string.IsNullOrEmpty(key)) { Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return; }
            queryEntity.TID = Convert.ToInt32(key);
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            List<CargoGtmcProOrderDetailEntity> list = bus.QueryGTMCOrderByID(queryEntity);
            //查询库存
            foreach (var o in list)
            {
                CargoInterfaceEntity qEntity = new CargoInterfaceEntity
                {
                    ProductName = "",
                    HouseID = UserInfor.HouseID,
                    GoodsCode = o.GoodsCode,
                    TypeID = o.TypeID,
                    Model = "",
                    Specs = "",// o.Specs,
                    Batch = "",
                    BatckWeek = 0,
                    ParentID = 354,
                    Figure = ""
                };
                int tn = inter.queryCargoStock(qEntity).Sum(c => c.StockNum);
                o.Stock = inter.queryCargoStock(qEntity).Where(c => c.IsAddOrder.Equals("0")).Sum(c => c.StockNum);
                o.NoStock = tn - o.Stock;
                //if (o.Piece > o.Stock)
                //{
                //    o.status = "1";
                //}
            }
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 
        /// <summary>
        /// 查询采购订单信息
        /// </summary>
        public void QueryOesPreOrderInfo()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Piece"]))) { queryEntity.Piece = Convert.ToInt32(Request["Piece"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
            queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            queryEntity.PayClientName = Convert.ToString(Request["PayClientName"]);
            queryEntity.Dep = Convert.ToString(Request["Dep"]);
            queryEntity.Dest = Convert.ToString(Request["Dest"]);
            queryEntity.CreateAwb = Convert.ToString(Request["CreateAwb"]);
            queryEntity.OutHouseName = Convert.ToString(Request["OutHouseName"]);
            if (Convert.ToString(Request["OrderType"]) != "-1")
            {
                queryEntity.OrderType = Convert.ToString(Request["OrderType"]);
            }
            if (Convert.ToString(Request["AwbStatus"]) != "-1")
            {
                queryEntity.AwbStatus = Convert.ToString(Request["AwbStatus"]);
            }
            if (Convert.ToString(Request["FinanceSecondCheck"]) != "-1")
            {
                queryEntity.FinanceSecondCheck = Convert.ToString(Request["FinanceSecondCheck"]);
            }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                if (Convert.ToString(Request["type"]) == "confirm")
                {
                    queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
                }
                else
                {
                    queryEntity.PurchaserID = Convert.ToString(Request["HouseID"]);//所属仓库ID
                }
            }
            else
            {
                if (Convert.ToString(Request["type"]) == "confirm")
                {
                    queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                }
                else
                {
                    queryEntity.PurchaserID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                }
            }
            queryEntity.SaleManID = Convert.ToString(Request["SaleManID"]);
            if (Convert.ToString(Request["OrderModel"]) != "-1")
            {
                queryEntity.OrderModel = Convert.ToString(Request["OrderModel"]);
            }
            if (Convert.ToString(Request["ThrowGood"]) != "-1")
            {
                queryEntity.ThrowGood = Convert.ToString(Request["ThrowGood"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Purchaser"])))
            {
                queryEntity.PurchaserID = Convert.ToString(Request["Purchaser"]);
            }
            queryEntity.IsMakeSure = Convert.ToInt32(Request["IsMakeSure"]);

            //2021-01-30 添加客户名称查询条件
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryOesPreOrderInfo(pageIndex, pageSize, queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 采购订单保存
        /// </summary>
        public void SavePurchaserOrderData()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            CargoHouseBus house = new CargoHouseBus();
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            Dictionary<int, ArrayList> rows = new Dictionary<int, ArrayList>();
            int HouseID = Convert.ToInt32(Request["PurchaseHouseID"]);
            CargoHouseEntity houseEntity = house.QueryCargoHouse(new CargoHouseEntity { HouseID = HouseID });
            string HouseCode = houseEntity.HouseCode;
            string HouseName = houseEntity.Name;

            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "新增OES采购订单";

            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            log.Status = "0";
            string source = string.Empty;
            List<string> HouseStr = new List<string>();

            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            List<QyOrderUpdateGoodsEntity> goods = new List<QyOrderUpdateGoodsEntity>();
            bool NoPromise = Convert.ToString(Request["ClientType"]).Equals("3") ? true : false;
            string PurchaserBoss = string.Empty;
            string PurchaserCellphone = string.Empty;
            string PurchaserAddress = string.Empty;

            try
            {
                CargoClientBus clientBus = new CargoClientBus();
                string BelongDepart = "1";
                //List<CargoUpClientEntity> UpClientlist = clientBus.QueryAllUpClientDep(new CargoUpClientEntity { HouseID = houseEntity.HouseID.ToString(), DepName = "OE渠道销售部" });
                //if (UpClientlist.Count > 0)
                //{
                //    BelongDepart = UpClientlist[0].ID.ToString();
                //}
                if (msg.Result)
                {
                    #region 赋值
                    ent.HAwbNo = Convert.ToString(Request["HAwbNo"]);
                    ent.BusinessID = Convert.ToString(Request["BusinessID"]);
                    if (!string.IsNullOrEmpty(ent.BusinessID))
                    {
                        ent.MarketType = clientBus.QueryBusinessIDDefault(new CargoUpClientEntity() { ID = Convert.ToInt32(ent.BusinessID) }).FirstOrDefault().MarketType;
                    }
                    CargoHouseEntity houseEnt = house.QueryCargoHouseByID(HouseID);
                    ent.Dep = Convert.ToString(houseEnt.DepCity);
                    if (string.IsNullOrEmpty(Convert.ToString(Request["Dest"])))
                    {
                        ent.Dest = Convert.ToString(Request["ADest"]);
                    }
                    else
                    {
                        ent.Dest = Convert.ToString(Request["Dest"]);
                    }
                    ent.InsuranceFee = string.IsNullOrEmpty(Convert.ToString(Request["InsuranceFee"])) ? 0 : Convert.ToDecimal(Request["Coupon"]);//保险费用
                    ent.TransitFee = string.IsNullOrEmpty(Convert.ToString(Request["TransitFee"])) ? 0 : Convert.ToDecimal(Request["TransitFee"]);
                    ent.DeliveryFee = string.IsNullOrEmpty(Convert.ToString(Request["DeliveryFee"])) ? 0 : Convert.ToDecimal(Request["DeliveryFee"]);
                    ent.OtherFee = string.IsNullOrEmpty(Convert.ToString(Request["OtherFee"])) ? 0 : Convert.ToDecimal(Request["OtherFee"]);
                    ent.Rebate = string.IsNullOrEmpty(Convert.ToString(Request["Rebate"])) ? 0 : Convert.ToDecimal(Request["Rebate"]);
                    ent.HouseID = HouseID;
                    ent.CheckOutType = Convert.ToString(Request["CheckOutType"]);
                    ent.DeliveryType = "0";//Convert.ToString(Request["DeliveryType"]);
                    ent.AcceptAddress = Convert.ToString(Request["AcceptAddress"]);
                    if (string.IsNullOrEmpty(Convert.ToString(Request["AcceptPeople"])))
                    {
                        ent.AcceptPeople = Convert.ToString(Request["AAcceptPeople"]);
                    }
                    else
                    {
                        ent.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
                    }
                    ent.AcceptPeople = ent.AcceptPeople.Split(',')[0];
                    ent.IsPrintPrice = string.IsNullOrEmpty(Convert.ToString(Request["IsPrintPrice"])) ? 0 : 1;
                    ent.AcceptUnit = string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"])) ? ent.AcceptPeople : Convert.ToString(Request["AcceptUnit"]);
                    ent.AcceptTelephone = Convert.ToString(Request["AcceptTelephone"]);
                    ent.AcceptCellphone = Convert.ToString(Request["AcceptCellphone"]);
                    ent.CreateAwb = UserInfor.UserName;
                    ent.CreateAwbID = UserInfor.LoginName;
                    ent.CreateDate = DateTime.Now;// Convert.ToDateTime(Request["CreateDate"]);
                    ent.OP_ID = UserInfor.LoginName.Trim();
                    ent.SaleManID = Convert.ToString(Request["SaleManID"]);
                    ent.SaleManName = Convert.ToString(Request["SaleManName"]);
                    ent.SaleCellPhone = Convert.ToString(Request["SaleCellPhone"]);
                    ent.Remark = Convert.ToString(Request["Remark"]);
                    ent.ThrowGood = "12";
                    ent.TranHouse = ent.ThrowGood.Equals("0") ? "" : Convert.ToString(Request["TranHouse"]);
                    ent.LogisID = 34;

                    if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientNum"])) && !Convert.ToString(Request["ClientNum"]).Equals("0"))
                    {
                        ent.ClientNum = Convert.ToInt32(Request["ClientNum"]);
                    }

                    if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])) && !Convert.ToString(Request["PayClientNum"]).Equals("0"))
                    {
                        ent.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
                        ent.PayClientName = Convert.ToString(Request["PayClientName"]);//付款人客户姓名
                    }
                    else
                    {
                        ent.PayClientNum = ent.ClientNum;
                        ent.PayClientName = ent.AcceptPeople;
                    }
                    if (string.IsNullOrEmpty(Convert.ToString(Request["PurchaseHouseID"])))
                    {
                        ent.PurchaseHouseID = ent.HouseID;
                    }
                    else
                    {
                        ent.PurchaseHouseID = Convert.ToInt32(Request["PurchaseHouseID"]);
                    }
                    ent.PurchaserID = Convert.ToString(Request["PurchaserID"]);
                    ent.PurchaserName = Convert.ToString(Request["PurchaserName"]);
                    #endregion
                    decimal trFee = 0.00M;
                    int pieceSum = 0;
                    string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号

                    int OrderNum = 0;
                    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, HouseCode, out OrderNum);
                    ent.OrderNum = OrderNum;//最新订单顺序号

                    CargoHouseBus houseBus = new CargoHouseBus();
                    CargoProductBus productBus = new CargoProductBus();
                    int oldPurchaserID = 0;
                    List<CargoProductEntity> productList = new List<CargoProductEntity>();
                    foreach (Hashtable row in GridRows)
                    {
                        List<CargoProductTypeEntity> pType = productBus.QueryProductType(new CargoProductTypeEntity { TypeID = Convert.ToInt32(row["TypeID"]), ParentID = -1 });
                        if (pType.Count > 0)
                        {
                            CargoContainerEntity containerEntity = houseBus.QueryTopOneContainer(new CargoContainerEntity { HouseID = HouseID });
                            CargoProductEntity entProduct = new CargoProductEntity();
                            entProduct.ParentID = pType[0].ParentID;
                            entProduct.ProductName = houseBus.QueryCargoHouse(new CargoHouseEntity { HouseID = HouseID }).CargoDepart;
                            entProduct.TypeID = pType[0].TypeID;
                            entProduct.TypeName = pType[0].TypeName;
                            entProduct.Model = Convert.ToString(row["Model"]);
                            entProduct.GoodsCode = Convert.ToString(row["GoodsCode"]);
                            entProduct.Figure = Convert.ToString(row["Figure"]);
                            entProduct.Specs = Convert.ToString(row["Specs"]);
                            entProduct.Batch = Convert.ToString(row["Batch"]);
                            entProduct.TreadWidth = 0;
                            entProduct.FlatRatio = 0;
                            entProduct.Meridian = "R";
                            entProduct.HubDiameter = 0; ent.LoadIndex = Convert.ToString(row["LoadIndex"]);
                            entProduct.SpeedLevel = Convert.ToString(row["SpeedLevel"]);
                            if (!string.IsNullOrEmpty(Convert.ToString(row["SpeedLevel"])))
                            {
                                entProduct.SpeedMax = Common.ReturnTyreSpeed(Server.MapPath("~/Data/TyreSpeedLevelExtend.json"), Convert.ToString(row["SpeedLevel"]));
                            }
                            entProduct.LoadIndex = Convert.ToString(row["LoadIndex"]);
                            entProduct.UnitPrice = Convert.ToDecimal(row["CostPrice"]);
                            entProduct.CostPrice = Convert.ToDecimal(row["CostPrice"]);
                            entProduct.TaxCostPrice = Convert.ToDecimal(row["CostPrice"]);
                            entProduct.NoTaxCostPrice = Convert.ToDecimal(row["CostPrice"]);
                            entProduct.Numbers = Convert.ToInt32(row["Piece"]);
                            entProduct.SalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                            entProduct.TradePrice = Convert.ToDecimal(row["ActSalePrice"]);
                            entProduct.PackageNum = 0;
                            entProduct.PackageWeight = 0;
                            entProduct.Source = "9";
                            entProduct.Born = Convert.ToString(row["Born"]);
                            entProduct.BelongDepart = BelongDepart;
                            entProduct.HouseID = HouseID;
                            entProduct.Company = "1";
                            entProduct.AreaID = containerEntity.AreaID;
                            entProduct.ContainerID = containerEntity.ContainerID;
                            entProduct.ContainerCode = containerEntity.ContainerCode;
                            entProduct.InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//入库单号
                            entProduct.BelongMonth = DateTime.Now.ToString("yyyyMM");
                            entProduct.SourceOrderNo = DateTime.Now.ToString("yyyyMMddHHmmss");
                            entProduct.Assort = "OER";
                            entProduct.InHouseType = "0";
                            entProduct.OrderNo = Convert.ToString(Request["OrderNo"]);
                            entProduct.OPID = UserInfor.LoginName;
                            entProduct.Supplier = ent.PurchaserName;
                            entProduct.ProductCode = Convert.ToString(row["ProductCode"]);

                            if (oldPurchaserID == 0)
                            {
                                oldPurchaserID = Convert.ToInt32(Request["PurchaserID"]);
                            }
                            else if (oldPurchaserID != Convert.ToInt32(Request["PurchaserID"]))
                            {
                                msg.Message = "采购单中拥有多个采购商\r\n";
                                msg.Result = false;
                                //返回处理结果
                                string res = JSON.Encode(msg);
                                Response.Write(res);
                                return;
                            }
                            entProduct.PurchaserID = Convert.ToInt32(Request["PurchaserID"]);
                            entProduct.PurchaserName = Convert.ToString(Request["PurchaserName"]);
                            entProduct.DeliveryBoss = Convert.ToString(Request["DeliveryBoss"]);
                            entProduct.DeliveryAddress = Convert.ToString(Request["DeliveryAddress"]);
                            PurchaserBoss = Convert.ToString(Request["PurchaserBoss"]);
                            PurchaserCellphone = Convert.ToString(Request["PurchaserCellphone"]);
                            PurchaserAddress = Convert.ToString(Request["PurchaserAddress"]);
                            ent.PurchaserBoss = Convert.ToString(Request["DeliveryBoss"]); ;
                            ent.PurchaserAddress = Convert.ToString(Request["DeliveryAddress"]); ;
                            ent.PurchaserCellphone = Convert.ToString(Request["DeliveryCellphone"]);
                            productList.Add(entProduct);
                        }

                        #region 订单详情
                        entDest.Add(new CargoOrderGoodsEntity
                        {
                            OrderNo = ent.OrderNo,
                            HouseID = HouseID,
                            TypeID = Convert.ToInt32(row["TypeID"]),
                            Piece = Convert.ToInt32(row["Piece"]),
                            ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
                            Specs = Convert.ToString(row["Specs"]),
                            Figure = Convert.ToString(row["Figure"]),
                            GoodsCode = Convert.ToString(row["GoodsCode"]),
                            Batch = Convert.ToString(row["Batch"]),
                            LoadIndex = Convert.ToString(row["LoadIndex"]),
                            SpeedLevel = Convert.ToString(row["SpeedLevel"]),
                            Model = Convert.ToString(row["Model"]),
                            Born = Convert.ToString(row["Born"]),
                            CostPrice = Convert.ToDecimal(row["CostPrice"]),
                            PurchaserID = Convert.ToInt32(Request["PurchaserID"]),
                            PurchaserName = Convert.ToString(Request["PurchaserName"]),
                            DeliveryBoss = Convert.ToString(Request["DeliveryBoss"]),
                            DeliveryAddress = Convert.ToString(Request["DeliveryAddress"]),
                            DeliveryCellphone = Convert.ToString(Request["DeliveryCellphone"]),
                            OP_ID = UserInfor.LoginName.Trim()
                        });
                        pieceSum += Convert.ToInt32(row["Piece"]);
                        trFee += Convert.ToInt32(row["Piece"]) * Convert.ToDecimal(row["ActSalePrice"]);
                        #endregion
                    }
                    ent.Piece = pieceSum;
                    ent.OutHouseName = HouseName;
                    ent.TransportFee = trFee;
                    ent.TotalCharge = ent.TransportFee + ent.TransitFee + ent.OtherFee - ent.InsuranceFee;

                    ent.IsMakeSure = 0;
                    ent.PostponeShip = "1";
                    ent.AwbStatus = "0";
                    ent.OrderType = "0";
                    ent.HouseID = HouseID;
                    ent.HouseName = HouseName;
                    ent.goodsList = entDest;
                    ent.productsList = productList;
                    ent.ModifyPriceStatus = "0";
                    ent.OutCargoID = outID;
                    if (msg.Result)
                    {
                        //仓库同步缓存
                        foreach (CargoContainerShowEntity time in outHouseList)
                        {
                            CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                            //34 马牌  1 同步马牌  2 同步全部品牌
                            if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                            {
                                RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                            }
                        }
                        bus.AddPreOrderInfo(ent, outHouseList, log);
                        msg.Message = ent.OrderNo + "/" + outID + "/" + ent.ModifyPriceStatus + "/" + 0;//订单号和出库单号
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 查询采购订单详细信息
        /// </summary>
        public void QueryOesPreOrderByOrderNo()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            //查询条件
            string key = Request["OrderNo"];
            if (string.IsNullOrEmpty(key)) { Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return; }
            queryEntity.OrderNo = key.Trim();
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoContainerShowEntity> list = bus.QueryOesPreOrderByOrderNo(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        /// <summary>
        /// 拉上预订单
        /// </summary>
        public void DrawUpOesPreOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "预订单管理";
            log.Status = "0";
            log.NvgPage = "预订单管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            try
            {
                CargoContainerShowEntity entity = new CargoContainerShowEntity();

                foreach (Hashtable row in rows)
                {
                    entity.ID = Convert.ToInt64(row["ID"]);
                    entity.TypeID = Convert.ToInt32(row["TypeID"]);
                    entity.Piece = Convert.ToInt32(row["Piece"]);//新数量
                    entity.InPiece = Convert.ToInt32(row["InPiece"]);//旧数量
                    entity.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);
                    entity.OrderNo = Convert.ToString(row["OrderNo"]);
                    entity.Specs = Convert.ToString(row["Specs"]);
                    entity.Figure = Convert.ToString(row["Figure"]);
                    entity.Model = Convert.ToString(row["Model"]);
                    entity.GoodsCode = Convert.ToString(row["GoodsCode"]).Trim();
                    entity.LoadIndex = Convert.ToString(row["LoadIndex"]);
                    entity.SpeedLevel = Convert.ToString(row["SpeedLevel"]);
                    entity.Born = Convert.ToString(row["Born"]);
                    entity.Batch = Convert.ToString(row["Batch"]);
                    entity.HouseID = Convert.ToInt32(row["HouseID"]);
                }
                if (msg.Result)
                {
                    CargoOrderBus bus = new CargoOrderBus();
                    bus.DrawUpPreOrder(entity, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        public void updateOesPreOrderData()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            CargoOrderBus bus = new CargoOrderBus();
            CargoHouseBus house = new CargoHouseBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "采购订单管理";
            log.NvgPage = "修改采购订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            int HouseID = Convert.ToInt32(Request["HouseID"]);
            try
            {
                ent.OrderID = Convert.ToInt64(Request["OrderID"]);
                ent.OrderNo = Convert.ToString(Request["OrderNo"]);
                ent.HouseID = Convert.ToInt32(Request["HouseID"]);
                if (Convert.ToString(Request["IsMakeSure"]) == "4")
                {
                    ent.IsMakeSure = 4;
                }
                else
                {
                    ent.IsMakeSure = 2;
                }

                if (msg.Result)
                {
                    decimal trFee = 0.00M;
                    int pieceN = 0;
                    string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                    int oldPurchaserID = 0;
                    //新的订单产品数据
                    foreach (Hashtable row in GridRows)
                    {
                        if (Convert.ToInt32(row["InPiece"]).Equals(0) && Convert.ToInt32(row["Piece"]).Equals(0))
                        {
                            continue;
                        }
                        if (oldPurchaserID == 0)
                        {
                            oldPurchaserID = Convert.ToInt32(row["PurchaserID"]);
                        }
                        else if (oldPurchaserID != Convert.ToInt32(row["PurchaserID"]))
                        {
                            msg.Message = "采购单只可报价同一家采购商";
                            msg.Result = false;
                            //返回处理结果
                            string res = JSON.Encode(msg);
                            Response.Write(res);
                            return;
                        }
                        entDest.Add(new CargoOrderGoodsEntity
                        {
                            OrderNo = ent.OrderNo,
                            HouseID = Convert.ToInt32(Request["HouseID"]),
                            Specs = Convert.ToString(row["Specs"]),
                            Figure = Convert.ToString(row["Figure"]),
                            Model = Convert.ToString(row["Model"]),
                            GoodsCode = Convert.ToString(row["GoodsCode"]),
                            Born = Convert.ToString(row["Born"]),
                            Batch = Convert.ToString(row["Batch"]),
                            LoadIndex = Convert.ToString(row["LoadIndex"]),
                            SpeedLevel = Convert.ToString(row["SpeedLevel"]),
                            Piece = Convert.ToInt32(row["Piece"]),
                            ActSalePrice = Convert.ToDecimal(row["UnitPrice"]),
                            TypeID = Convert.ToInt32(row["TypeID"]),
                            PurchaserID = Convert.ToInt32(row["PurchaserID"]),
                            PurchaserName = Convert.ToString(row["PurchaserName"]),
                            OP_ID = UserInfor.LoginName.Trim()
                        });

                        pieceN += Convert.ToInt32(row["Piece"]);
                        trFee += Convert.ToInt32(row["Piece"]) * Convert.ToDecimal(row["ActSalePrice"]);
                        CargoContainerShowEntity cargo = new CargoContainerShowEntity();

                        cargo.OutCargoID = string.IsNullOrEmpty(Convert.ToString(row["OutCargoID"])) ? outID : Convert.ToString(row["OutCargoID"]);
                        cargo.TypeID = Convert.ToInt32(row["TypeID"]);
                        cargo.Piece = Convert.ToInt32(row["Piece"]);//出库件数
                        cargo.ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]);

                        cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                        cargo.Model = Convert.ToString(row["Model"]).Trim();
                        cargo.Specs = Convert.ToString(row["Specs"]).Trim();
                        cargo.Figure = Convert.ToString(row["Figure"]).Trim();
                        cargo.Batch = Convert.ToString(row["Batch"]).Trim();
                        cargo.GoodsCode = Convert.ToString(row["GoodsCode"]).Trim();
                        cargo.OrderNo = ent.OrderNo;
                        cargo.HouseID = ent.HouseID;
                        outHouseList.Add(cargo);
                    }
                    if (entDest.Count <= 0)
                    {
                        msg.Message = "没有出库数量数据";
                        msg.Result = false;
                        //返回处理结果
                        string res = JSON.Encode(msg);
                        Response.Write(res);
                        return;
                    }
                    ent.TransportFee = trFee;
                    decimal TransitFee = string.IsNullOrEmpty(Convert.ToString(Request["TransitFee"])) ? 0 : Convert.ToDecimal(Request["TransitFee"]);
                    ent.TotalCharge = trFee + TransitFee;
                    ent.goodsList = entDest;

                    if (msg.Result)
                    {
                        bus.UpdatePurchaserOrderInfo(ent, outHouseList, log);
                        msg.Result = true;
                        msg.Message = ent.OrderNo + "/" + outID;
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }


            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        public void OesPreOrderConfirm()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            List<CargoOrderEntity> list = new List<CargoOrderEntity>();
            CargoProductBus productBus = new CargoProductBus();
            CargoOrderBus bus = new CargoOrderBus();
            CargoHouseBus houseBus = new CargoHouseBus();
            List<CargoProductEntity> productList = new List<CargoProductEntity>();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "采购订单管理";
            log.NvgPage = "采购订单确认";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            int HouseID = Convert.ToInt32(Request["HouseID"]);
            bool type = true;
            int oldPurchaserID = 0;
            string returnMsg = String.Empty;
            string PurchaserBoss = string.Empty;
            string PurchaserCellphone = string.Empty;
            string PurchaserAddress = string.Empty;
            try
            {
                //CargoClientBus clientBus = new CargoClientBus();
                //List<CargoUpClientEntity> UpClientlist = clientBus.QueryAllUpClientDep(new CargoUpClientEntity { });
                if (msg.Result)
                {
                    foreach (Hashtable row in GridRows)
                    {
                        List<CargoProductTypeEntity> pType = productBus.QueryProductType(new CargoProductTypeEntity { TypeID = Convert.ToInt32(row["TypeID"]), ParentID = -1 });
                        if (pType.Count > 0)
                        {
                            CargoContainerEntity containerEntity = houseBus.QueryTopOneContainer(new CargoContainerEntity { HouseID = Convert.ToInt32(row["HouseID"]) });
                            CargoProductEntity ent = new CargoProductEntity();
                            ent.ParentID = pType[0].ParentID;
                            CargoHouseEntity houseEntity = houseBus.QueryCargoHouse(new CargoHouseEntity { HouseID = Convert.ToInt32(row["HouseID"]) });
                            ent.ProductName = houseEntity.CargoDepart;
                            ent.TypeID = pType[0].TypeID;
                            ent.TypeName = pType[0].TypeName;
                            ent.Model = Convert.ToString(row["Model"]);
                            ent.GoodsCode = Convert.ToString(row["GoodsCode"]);
                            ent.Figure = Convert.ToString(row["Figure"]);
                            ent.Specs = Convert.ToString(row["Specs"]);
                            ent.Batch = Convert.ToString(row["Batch"]);
                            ent.TreadWidth = 0;
                            ent.FlatRatio = 0;
                            ent.Meridian = "R";
                            ent.HubDiameter = 0;
                            ent.LoadIndex = Convert.ToString(row["LoadIndex"]);
                            ent.SpeedLevel = Convert.ToString(row["SpeedLevel"]);
                            if (!string.IsNullOrEmpty(Convert.ToString(row["SpeedLevel"])))
                            {
                                ent.SpeedMax = Common.ReturnTyreSpeed(Server.MapPath("~/Data/TyreSpeedLevelExtend.json"), Convert.ToString(row["SpeedLevel"]));
                            }
                            ent.UnitPrice = Convert.ToDecimal(row["UnitPrice"]);
                            ent.CostPrice = Convert.ToDecimal(row["UnitPrice"]);
                            ent.TaxCostPrice = Convert.ToDecimal(row["UnitPrice"]);
                            ent.NoTaxCostPrice = Convert.ToDecimal(row["UnitPrice"]);
                            ent.Numbers = Convert.ToInt32(row["Piece"]);
                            ent.SalePrice = Convert.ToDecimal(row["ConfirmSalePrice"]);
                            ent.TradePrice = Convert.ToDecimal(row["ConfirmSalePrice"]);
                            ent.PackageNum = 0;
                            ent.PackageWeight = 0;
                            ent.Source = "9";
                            ent.Born = Convert.ToString(row["Born"]);
                            //ent.BelongDepart = UpClientlist.Where(x => x.HouseID == Convert.ToString(row["HouseID"]) && x.DepName == "OE渠道销售部").ToList().Count > 0 ? UpClientlist.Where(x => x.HouseID == Convert.ToString(row["HouseID"]) && x.DepName == "OE渠道销售部").ToList()[0].ID.ToString() : null;
                            ent.BelongDepart = "1";
                            ent.HouseID = Convert.ToInt32(row["HouseID"]);
                            ent.Company = "1";

                            ent.ContainerID = containerEntity.ContainerID;
                            ent.InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//入库单号
                            ent.InHouseType = "0";
                            ent.OrderNo = Convert.ToString(Request["OrderNo"]);
                            ent.OPID = UserInfor.LoginName;
                            if (oldPurchaserID == 0)
                            {
                                oldPurchaserID = Convert.ToInt32(row["PurchaserID"]);
                            }
                            else if (oldPurchaserID != Convert.ToInt32(row["PurchaserID"]))
                            {
                                type = false;
                                returnMsg += "采购单中拥有多个采购商\r\n";
                                break;
                            }
                            ent.PurchaserID = Convert.ToInt32(row["PurchaserID"]);
                            ent.PurchaserName = Convert.ToString(row["PurchaserName"]);
                            PurchaserBoss = Convert.ToString(row["PurchaserBoss"]);
                            PurchaserCellphone = Convert.ToString(row["PurchaserCellphone"]);
                            PurchaserAddress = Convert.ToString(row["PurchaserAddress"]);
                            productList.Add(ent);
                        }
                        else
                        {
                            type = false;
                            returnMsg += "[" + Convert.ToString(row["TypeName"]) + "]未找到父类型\r\n";
                            break;
                        }
                    }
                    if (type)
                    {
                        list.Add(new CargoOrderEntity
                        {
                            OrderNo = Convert.ToString(Request["OrderNo"]),
                            ThrowGood = "12",
                            //BelongDepart = UpClientlist.Where(x => x.HouseID == Convert.ToString(Request["HouseID"]) && x.DepName == "OE渠道销售部").ToList().Count > 0 ? UpClientlist.Where(x => x.HouseID == Convert.ToString(Request["HouseID"]) && x.DepName == "OE渠道销售部").ToList()[0].ID.ToString() : null,
                            BelongDepart = "1",
                            Piece = Convert.ToInt32(Request["Piece"]),
                            productsList = productList,
                            HouseID = Convert.ToInt32(Request["HouseID"]),
                            HouseName = Convert.ToString(Request["OutHouseName"]),
                            HouseCode = (houseBus.QueryCargoHouse(new CargoHouseEntity { HouseID = Convert.ToInt32(Request["HouseID"]) })).HouseCode,
                            OutCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString()
                        });
                    }
                }
                if (list.Count > 0)
                {
                    foreach (CargoOrderEntity order in list)
                    {
                        foreach (var item in order.productsList)
                        {
                            if (item.PurchaserID == 11 || item.PurchaserID == 12)
                            {
                                CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                                {
                                    //BelongDepart = UpClientlist.Where(x => x.HouseID == item.HouseID.ToString() && x.DepName == "OE渠道销售部").ToList().Count > 0 ? UpClientlist.Where(x => x.HouseID == item.HouseID.ToString() && x.DepName == "OE渠道销售部").ToList()[0].ID.ToString() : null,
                                    BelongDepart = "1",
                                    HouseID = item.HouseID,
                                    GoodsCode = item.GoodsCode,
                                    TypeID = item.TypeID,
                                    Model = item.Model,
                                    Specs = item.Specs,
                                    Batch = item.Batch,
                                    BatckWeek = item.Batch.Length >= 4 ? Convert.ToInt32(item.Batch.Substring(0, 2)) : 0,
                                    ParentID = item.ParentID,
                                    Figure = item.Figure
                                };
                                CargoInterfaceBus interBus = new CargoInterfaceBus();
                                List<CargoInterfaceEntity> stockList = interBus.queryCargoStock(queryEntity);
                                if (stockList.Count <= 0)
                                {
                                    msg.Result = false;
                                    returnMsg += "产品规格：" + queryEntity.Specs + "，货品代码：" + queryEntity.GoodsCode + "库存为空\r\n";
                                    break;
                                }
                                if (stockList.Sum(c => c.StockNum) < item.Numbers)
                                {
                                    msg.Result = false;
                                    returnMsg += "产品规格：" + queryEntity.Specs + "，货品代码：" + queryEntity.GoodsCode + "库存不足，库存只剩：" + stockList.Sum(c => c.StockNum).ToString();
                                    break;
                                }
                            }
                        }
                    }
                    if (msg.Result)
                    {
                        //CargoProductEntity syncProduct = house.SyncTypeProduct(parentID.ToString());
                        ////34 马牌  1 同步马牌  2 同步全部品牌
                        //if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                        //{
                        //    RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                        //}


                        bus.OesPreOrderConfirm(list, log);
                        msg.Result = true;
                    }
                }
                else
                {
                    msg.Result = false;
                }
                msg.Message = returnMsg;
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            try
            {
                //向好来运企业微信推送提货通知
                if (msg.Result)
                {
                    foreach (CargoOrderEntity order in list)
                    {
                        string good = string.Empty;
                        foreach (var it in productList)
                        {
                            good += "品牌：" + it.TypeName + "，规格：" + it.Specs + "，" + it.Figure + "，" + it.LoadIndex + it.SpeedLevel + "，数量：" + it.Numbers.ToString() + " |";
                        }
                        //微信企业号推送
                        QySendInfoEntity send = new QySendInfoEntity();
                        send.title = "提货通知";
                        send.msgType = msgType.textcard;
                        //send.toUser = "1000";
                        send.toTag = "2";
                        send.content = "<div>订单号：" + order.OrderNo + "</div><div>提货联系人：" + PurchaserBoss + " " + PurchaserCellphone + "</div><div>提货地址：" + PurchaserAddress + "</div><div>提货数量：" + order.Piece.ToString() + " 条</div><div>物品明细：" + good + "</div><div>备注说明：" + order.Remark + "</div>";
                        send.url = "http://oa.hlyex.com/HLYQY/OESDelivery/DeliverySure.aspx?OrderNo=" + order.OrderNo + "&AgentID=1000021";
                        QyConfigEntity agentEnt = new QyConfigEntity();
                        agentEnt.AgentID = "1000021";
                        agentEnt.AgentSecret = "0iV_tGVHzE6-kJsrdWADQZOG5U-vz939_gIMSRnQXc0";
                        WxQYSendHelper.HLYQYPushInfo(agentEnt, send);
                    }
                }
            }
            catch (Exception)
            {

            }

            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 取消采购订单
        /// </summary>
        public void OesPreOrderCancel()
        {
            string json = Request["submitData"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoOrderEntity> list = new List<CargoOrderEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            bool type = true;
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "预订单管理";
            log.Operate = "U";
            log.Status = "0";
            log.NvgPage = "预订单确认";
            log.UserID = UserInfor.LoginName.Trim();
            string returnMsg = "";
            try
            {
                string PurchaseRemark = Convert.ToString(Request["PurchaseRemark"]);
                foreach (Hashtable row in rows)
                {
                    long OrderID = Convert.ToInt64(row["OrderID"]);
                    string OrderNo = Convert.ToString(row["OrderNo"]);
                    list.Add(new CargoOrderEntity { OrderID = OrderID, OrderNo = OrderNo, IsMakeSure = 3, PurchaseRemark = PurchaseRemark });
                }
                bus.CancelPurchaserOrder(list, log);
                msg.Result = true;
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
        #region 进货单
        /// <summary>
        /// 修改来货单
        /// </summary>
        public void UpdateArrivalOrderData()
        {

            ErrMessage msg = new ErrMessage(); msg.Message = "";
            CargoHouseBus house = new CargoHouseBus();
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            Dictionary<int, ArrayList> rows = new Dictionary<int, ArrayList>();

            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "修改来货单";

            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            log.Status = "0";
            try
            {
                if (msg.Result)
                {
                    CargoOrderEntity ent = new CargoOrderEntity();

                    List<CargoProductEntity> productList = new List<CargoProductEntity>();
                    int pieceSum = 0;
                    decimal trFee = 0.00M;
                    decimal difference = 0.00M;

                    ent.OrderID = Convert.ToInt64(Request["OrderID"]);
                    ent.ClientNum = Convert.ToInt32(Request["ClientNum"]);
                    ent.AcceptAddress = Convert.ToString(Request["AcceptAddress"]);
                    ent.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
                    ent.AcceptUnit = Convert.ToString(Request["AAcceptUnit"]);
                    ent.AcceptTelephone = Convert.ToString(Request["AcceptTelephone"]);
                    ent.AcceptCellphone = Convert.ToString(Request["AcceptCellphone"]);

                    foreach (Hashtable row in GridRows)
                    {
                        productList.Add(new CargoProductEntity
                        {
                            TypeID = Convert.ToInt32(row["TypeID"]),
                            InPiece = Convert.ToInt32(row["InPiece"]),
                            Specs = Convert.ToString(row["Specs"]).Trim(),
                            Figure = Convert.ToString(row["Figure"]).Trim(),
                            Model = Convert.ToString(row["Model"]).Trim(),
                            GoodsCode = Convert.ToString(row["GoodsCode"]).Trim(),
                            LoadIndex = string.IsNullOrEmpty(Convert.ToString(row["LoadIndex"])) ? "0" : Convert.ToString(row["LoadIndex"]).Trim(),
                            SpeedLevel = Convert.ToString(row["SpeedLevel"]).Trim(),
                            ProductCode = Convert.ToString(row["ProductCode"]),
                            Born = Convert.ToString(row["Born"]).Trim(),
                            Batch = Convert.ToString(row["Batch"]).Trim(),
                            UnitPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDecimal(row["UnitPrice"]),
                            CostPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDecimal(row["UnitPrice"]) + difference,
                            TradePrice = string.IsNullOrEmpty(Convert.ToString(row["TradePrice"])) ? 0 : Convert.ToDecimal(row["TradePrice"]),
                            SalePrice = string.IsNullOrEmpty(Convert.ToString(row["SalePrice"])) ? 0 : Convert.ToDecimal(Convert.ToDouble(row["SalePrice"])),
                            OPID = UserInfor.LoginName.ToString(),
                            GoodsID = Convert.ToInt64(row["GoodsID"]),
                            FacID = Convert.ToInt64(row["FacID"]),
                            HouseID = Convert.ToInt32(row["HouseID"]),
                            SourceOrderNo = Convert.ToString(row["SourceOrderNo"]),
                        });
                        pieceSum += Convert.ToInt32(row["InPiece"]);
                        trFee += (string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDecimal(row["UnitPrice"])) * Convert.ToInt32(row["InPiece"]);
                    }
                    ent.Piece = pieceSum;
                    ent.TransportFee = trFee;
                    ent.TotalCharge = ent.TransportFee;

                    if (msg.Result)
                    {
                        bus.UpdateArrivalOrderData(ent, productList, log);

                        msg.Result = true;
                        if (string.IsNullOrEmpty(msg.Message))
                        {
                            msg.Message = "成功";
                        }
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }

            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }

        /// <summary>
        /// 进货单保存
        /// </summary>
        public void SaveArrivalOrderData()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            CargoHouseBus house = new CargoHouseBus();
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            Dictionary<int, ArrayList> rows = new Dictionary<int, ArrayList>();

            CargoOrderBus bus = new CargoOrderBus();
            CargoHouseBus houseBus = new CargoHouseBus();
            CargoProductBus productBus = new CargoProductBus();
            List<CargoFactoryOrderEntity> factoryList = new List<CargoFactoryOrderEntity>();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "新增来货单";

            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            log.Status = "0";
            try
            {
                if (msg.Result)
                {
                    int LOTPID = string.IsNullOrEmpty(Convert.ToString(Request["LOTPID"])) ? 0 : Convert.ToInt32(Request["LOTPID"]);
                    CargoContainerEntity containerEntity = houseBus.QueryTopOneContainer(new CargoContainerEntity { HouseID = UserInfor.HouseID, FirstAreaID = LOTPID });
                    //CargoContainerEntity containerEntity = houseBus.QueryTopOneContainer(new CargoContainerEntity { HouseID = UserInfor.HouseID });
                    CargoOrderEntity ent = new CargoOrderEntity();
                    CargoHouseEntity houseEntity = house.QueryCargoHouse(new CargoHouseEntity { HouseID = UserInfor.HouseID });
                    ent.Dest = String.IsNullOrEmpty(houseEntity.DepCity) ? "广州" : houseEntity.DepCity;
                    List<CargoProductEntity> productList = new List<CargoProductEntity>();
                    int pieceSum = 0;
                    decimal trFee = 0.00M;
                    decimal difference = 0.00M;

                    ent.HandFee = string.IsNullOrEmpty(Convert.ToString(Request["HandFee"])) ? 0 : Convert.ToDecimal(Request["HandFee"]);
                    ent.TrafficType = Convert.ToString(Request["OrderType"]);
                    ent.ClientNum = Convert.ToInt32(Request["ClientNum"]);
                    ent.AcceptAddress = Convert.ToString(Request["AAcceptAddress"]);
                    ent.AcceptPeople = Convert.ToString(Request["AAcceptPeople"]);
                    ent.AcceptUnit = string.IsNullOrEmpty(Convert.ToString(Request["AAcceptUnit"])) ? ent.AcceptPeople : Convert.ToString(Request["AAcceptUnit"]);
                    ent.AcceptTelephone = Convert.ToString(Request["AAcceptTelephone"]);
                    ent.AcceptCellphone = Convert.ToString(Request["AAcceptCellphone"]);
                    ent.CheckOutType = Convert.ToString(Request["ACheckOutType"]);
                    ent.CreateAwbID = UserInfor.LoginName.ToString();
                    ent.CreateAwb = UserInfor.UserName;
                    ent.CheckStatus = "0";
                    ent.HouseID = UserInfor.HouseID;
                    ent.TransitFee = string.IsNullOrEmpty(Convert.ToString(Request["TransitFee"])) ? 0 : Convert.ToDecimal(Request["TransitFee"]);

                    difference = Math.Round((ent.HandFee + ent.TransitFee) / (string.IsNullOrEmpty(Convert.ToString(Request["DisplayPiece"])) ? 0 : Convert.ToInt32(Request["DisplayPiece"])), 2, MidpointRounding.AwayFromZero);
                    string FacOrderNo = string.IsNullOrEmpty(Convert.ToString(Request["FacOrderNo"])) ? DateTime.Now.ToString("yyyyMMddHHmmss") : Convert.ToString(Request["FacOrderNo"]);
                    ent.FacOrderNo = FacOrderNo;
                    foreach (Hashtable row in GridRows)
                    {
                        string batch = Convert.ToString(row["Batch"]).Trim();
                        int bYear = 0, bWeek = 0;
                        if (batch.Length == 4)
                        {
                            bWeek = Convert.ToInt32(batch.Substring(0, 2));
                            bYear = Convert.ToInt32(batch.Substring(2, 2));
                        }
                        else if (batch.Length == 3)
                        {
                            bWeek = Convert.ToInt32(batch.Substring(0, 1));
                            bYear = Convert.ToInt32(batch.Substring(1, 2));
                        }
                        factoryList.Add(new CargoFactoryOrderEntity
                        {
                            HouseID = UserInfor.HouseID,
                            FacOrderNo = FacOrderNo,
                            Source = UserInfor.HouseID.Equals(82) ? 73 : UserInfor.HouseID.Equals(10) ? 78 : 9,
                            SourceName = UserInfor.HouseID.Equals(82) ? "锦湖轮胎厂家" : UserInfor.HouseID.Equals(10) ? "安泰路斯轮胎厂家" : "市场采购",
                            ProductName = UserInfor.HouseID.Equals(82) ? "华南配件仓业务部" : UserInfor.HouseID.Equals(10) ? "好来运安泰路斯轮胎西安仓业务部" : houseEntity.CargoDepart,
                            TypeID = Convert.ToInt32(row["TypeID"]),
                            TypeName = Convert.ToString(row["TypeName"]).Trim(),
                            OrderType = Convert.ToInt32(Request["OrderType"]),
                            Model = Convert.ToString(row["Model"]).Trim(),
                            BelongMonth = DateTime.Now.ToString("yyyyMM"),
                            Born = Convert.ToString(row["Born"]).Trim(),
                            Assort = "",
                            Specs = Convert.ToString(row["Specs"]).Trim(),
                            LoadIndex = Convert.ToString(row["LoadIndex"]).Trim(),
                            SpeedLevel = Convert.ToString(row["SpeedLevel"]).Trim(),
                            Figure = Convert.ToString(row["Figure"]).Trim(),
                            GoodsCode = Convert.ToString(row["GoodsCode"]).Trim(),
                            ProductCode = Convert.ToString(row["ProductCode"]).Trim(),
                            ProductUnit = string.IsNullOrEmpty(Convert.ToString(row["ProductUnit"])) ? "条" : Convert.ToString(row["ProductUnit"]),
                            BundleNum = Convert.ToInt32(row["BundleNum"]),
                            HubDiameter = Convert.ToInt32(row["HubDiameter"]),
                            Batch = batch,
                            BatchWeek = bWeek,
                            BatchYear = bYear,
                            OrderNum = Convert.ToInt32(row["Piece"]),
                            ReplyNumber = Convert.ToInt32(row["Piece"]),
                            InPiece = 0,
                            InCargoStatus = 0,
                            SalePrice = string.IsNullOrEmpty(Convert.ToString(row["SalePrice"])) ? 0 : Convert.ToDouble(row["SalePrice"]),
                            UnitPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDouble(row["UnitPrice"]),
                            CostPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDouble(row["UnitPrice"]) + Convert.ToDouble(difference),
                            TaxCostPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDouble(row["UnitPrice"]) + Convert.ToDouble(difference),
                            NoTaxCostPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDouble(row["UnitPrice"]) + Convert.ToDouble(difference),
                            TradePrice = string.IsNullOrEmpty(Convert.ToString(row["TradePrice"])) ? 0 : Convert.ToDouble(row["TradePrice"]),
                            WhetherTax = Convert.ToInt32(row["WhetherTax"]) == 0 ? 0 : 1,
                            SaleMoney = string.IsNullOrEmpty(Convert.ToString(row["ReplyNumber"])) ? 0 : Convert.ToDouble(Convert.ToDouble(row["SalePrice"]) * Convert.ToInt32(row["ReplyNumber"])),
                            ReceiveName = UserInfor.UserName,
                            ReceiveCity = UserInfor.DepCity,
                            ReceiveMobile = "",
                            SourceHouse = "",
                            SpecsType = "",
                            OP_Name = UserInfor.UserName.Trim(),
                            BelongDepart = "",
                            Company = "0",
                            ContainerID = containerEntity.ContainerID,
                            InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString(),
                            Supplier = ent.AcceptPeople
                        });

                        productList.Add(new CargoProductEntity
                        {
                            TypeID = Convert.ToInt32(row["TypeID"]),
                            InPiece = Convert.ToInt32(row["Piece"]),
                            Specs = Convert.ToString(row["Specs"]).Trim(),
                            Figure = Convert.ToString(row["Figure"]).Trim(),
                            Model = Convert.ToString(row["Model"]).Trim(),
                            GoodsCode = Convert.ToString(row["GoodsCode"]).Trim(),
                            ProductCode = Convert.ToString(row["ProductCode"]).Trim(),
                            LoadIndex = string.IsNullOrEmpty(Convert.ToString(row["LoadIndex"])) ? "0" : Convert.ToString(row["LoadIndex"]).Trim(),
                            SpeedLevel = Convert.ToString(row["SpeedLevel"]).Trim(),
                            Born = Convert.ToString(row["Born"]).Trim(),
                            Batch = Convert.ToString(row["Batch"]).Trim(),
                            UnitPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDecimal(row["UnitPrice"]),
                            CostPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDecimal(row["UnitPrice"]) + difference,
                            TaxCostPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDecimal(row["UnitPrice"]) + difference,
                            NoTaxCostPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDecimal(row["UnitPrice"]) + difference,
                            TradePrice = string.IsNullOrEmpty(Convert.ToString(row["TradePrice"])) ? 0 : Convert.ToDecimal(row["TradePrice"]),
                            SalePrice = string.IsNullOrEmpty(Convert.ToString(row["SalePrice"])) ? 0 : Convert.ToDecimal(Convert.ToDouble(row["SalePrice"])),
                            OPID = UserInfor.LoginName.ToString(),
                            PackageNum = Convert.ToInt32(row["BundleNum"]),
                            Package = string.IsNullOrEmpty(Convert.ToString(row["ProductUnit"])) ? "条" : Convert.ToString(row["ProductUnit"])
                        });
                        pieceSum += Convert.ToInt32(row["Piece"]);
                        trFee += (string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDecimal(row["UnitPrice"])) * Convert.ToInt32(row["Piece"]);
                    }
                    ent.Piece = pieceSum;
                    ent.TransportFee = trFee;
                    ent.TotalCharge = ent.TransportFee;

                    factoryList = factoryList.OrderBy(e => e.Specs).ToList();
                    if (msg.Result)
                    {

                        bus.AddPurchaseOrderInfo(ent, productList, factoryList, log);

                        msg.Result = true;
                        if (string.IsNullOrEmpty(msg.Message))
                        {
                            msg.Message = "成功";
                        }
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }

            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 查询进货单数据
        /// </summary>
        public void QueryPurchaseOrderInfo()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["OrderID"])))
            {
                queryEntity.OrderID = Convert.ToInt64(Request["OrderID"]);

            }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            //queryEntity.OutHouseName = Convert.ToString(Request["OutHouseName"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryPurchaseOrderInfo(pageIndex, pageSize, queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
            Response.End();
        }

        public void QueryPurchaseOrderInfoExport()
        {
            string err = "OK";
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["OrderID"])))
            {
                queryEntity.OrderID = Convert.ToInt64(Request["OrderID"]);

            }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            //queryEntity.OutHouseName = Convert.ToString(Request["OutHouseName"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            //分页
            int pageIndex = 1;
            int pageSize = 10000;
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryPurchaseOrderInfo(pageIndex, pageSize, queryEntity);
            List<CargoOrderEntity> awbList = list["rows"] as List<CargoOrderEntity>;
            if (awbList.Count > 0) { CargoPurchaseOrderEntityList = awbList; } else { err = "没有数据可以进行导出，请重新查询！"; }
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
            Response.End();
        }
        public List<CargoOrderEntity> CargoPurchaseOrderEntityList
        {
            get
            {
                if (Session["CargoPurchaseOrderEntityList"] == null)
                {
                    Session["CargoPurchaseOrderEntityList"] = new List<CargoOrderEntity>();
                }
                return (List<CargoOrderEntity>)(Session["CargoPurchaseOrderEntityList"]);
            }
            set
            {
                Session["CargoPurchaseOrderEntityList"] = value;
            }
        }
        public void QueryPurchaseOrderByOrderID()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            //查询条件
            string key = Request["OrderID"];
            if (string.IsNullOrEmpty(key)) { Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return; }
            queryEntity.OrderID = Convert.ToInt64(key);
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoProductEntity> list = bus.QueryPurchaseOrderByOrderID(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }

        public void UpdatePurchaseOrderFee()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Operate = "U";
            log.Status = "0";
            log.NvgPage = "进货单管理";
            log.UserID = UserInfor.LoginName.Trim();
            string returnMsg = "";
            try
            {
                string OrderID = Convert.ToString(Request["OrderID"]);
                Decimal HandFee = Convert.ToDecimal(Request["HandFee"]);
                Decimal TransitFee = Convert.ToDecimal(Request["TransitFee"]);


                if (!string.IsNullOrEmpty(OrderID))
                {
                    bus.UpdatePurchaseOrderFee(new CargoOrderEntity { OrderID = Convert.ToInt64(OrderID), HandFee = HandFee, TransitFee = TransitFee, OP_ID = UserInfor.LoginName.Trim(), OP_Name = UserInfor.UserName }, log);
                    msg.Result = true;
                }
                else
                {
                    msg.Result = false;
                }
                msg.Message = returnMsg;
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        public void QueryOesOrderInfoForReturn()
        {
            CargoOrderReturnOrderEntity queryEntity = new CargoOrderReturnOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Piece"]))) { queryEntity.Piece = Convert.ToInt32(Request["Piece"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            queryEntity.Dep = Convert.ToString(Request["Dep"]);
            queryEntity.Dest = Convert.ToString(Request["Dest"]);
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            queryEntity.SaleManID = Convert.ToString(Request["SaleManID"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["OrderModel"])))
            {
                queryEntity.OrderModel = Convert.ToString(Request["OrderModel"]);
            }
            if (Request["BelongDepart"] != "-1") { queryEntity.BelongDepart = Convert.ToString(Request["BelongDepart"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Specs"])))
            {
                string spe = Convert.ToString(Request["Specs"]);

                if (spe.Contains("/") || spe.Contains("R") || spe.Contains("."))
                {
                    queryEntity.Specs = spe;
                }
                else
                {
                    if (spe.Length <= 3)
                    {
                        queryEntity.Specs = spe;
                    }
                    if (spe.Length > 3 && spe.Length <= 5)
                    {
                        queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, spe.Length - 3);
                    }
                    if (spe.Length > 5)
                    {
                        queryEntity.Specs = spe.Substring(0, 3) + "/" + spe.Substring(3, 2) + "R" + spe.Substring(5, spe.Length - 5);
                    }
                }
            }
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoOrderReturnOrderEntity> list = bus.QueryOesOrderInfoForReturn(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void saveOesReturn()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoProductEntity> productList = new List<CargoProductEntity>();
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            CargoHouseBus house = new CargoHouseBus();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "新增进货退货单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            log.Status = "0";

            try
            {
                #region 赋值
                ent.Dest = String.IsNullOrEmpty((house.QueryCargoHouse(new CargoHouseEntity { HouseID = UserInfor.HouseID })).DepCity) ? "广州" : (house.QueryCargoHouse(new CargoHouseEntity { HouseID = UserInfor.HouseID })).DepCity;
                ent.Piece = string.IsNullOrEmpty(Convert.ToString(Request["Piece"])) ? 0 : Convert.ToInt32(Request["Piece"]);
                ent.TransportFee = string.IsNullOrEmpty(Convert.ToString(Request["TransportFee"])) ? 0 : Convert.ToDecimal(Request["TransportFee"]);
                ent.TotalCharge = ent.TransportFee;
                ent.CheckOutType = "0";
                ent.TrafficType = "3";
                ent.DeliveryType = "0";
                ent.ClientNum = Convert.ToInt32(Request["ClientNum"]);

                CargoOrderEntity order = bus.QueryOesOrderInfoByOrderID(Convert.ToInt64(Request["OrderID"]));

                ent.AcceptUnit = order.AcceptUnit;
                ent.AcceptAddress = order.AcceptAddress;
                ent.AcceptPeople = order.AcceptPeople;
                ent.AcceptTelephone = order.AcceptTelephone;
                ent.AcceptCellphone = order.AcceptCellphone;
                ent.CreateAwbID = UserInfor.LoginName;
                ent.CreateAwb = UserInfor.UserName;
                ent.CreateDate = DateTime.Now;
                ent.HouseID = order.HouseID;
                ent.OP_ID = UserInfor.LoginName.Trim();
                ent.Remark = Convert.ToString(Request["Remark"]);
                ent.FacOrderNo = order.OrderID.ToString();


                #endregion
                List<CargoProductEntity> goodsList = new List<CargoProductEntity>();
                foreach (Hashtable row in GridRows)
                {
                    CargoContainerGoodsEntity goods = new CargoContainerGoodsEntity();
                    if (order.TrafficType == "3")
                    {
                        goods = bus.SelectOesrderProductPiece(new CargoProductEntity { SourceOrderNo = order.FacOrderNo, Specs = Convert.ToString(row["Specs"]), Figure = Convert.ToString(row["Figure"]), Model = Convert.ToString(row["Model"]), GoodsCode = Convert.ToString(row["GoodsCode"]), Batch = Convert.ToString(row["Batch"]), Born = Convert.ToString(row["Born"]), TypeID = Convert.ToInt32(row["TypeID"]), LoadIndex = Convert.ToString(row["LoadIndex"]), SpeedLevel = Convert.ToString(row["SpeedLevel"]) });
                        if (goods.Piece < Convert.ToInt32(row["Piece"]))
                        {
                            msg.Message = Convert.ToString(row["Specs"]) + "在库数量不足";
                            msg.Result = false;
                            //返回处理结果
                            string res = JSON.Encode(msg);
                            Response.Write(res);
                            return;
                        }
                        else
                        {
                            goodsList.Add(new CargoProductEntity
                            {
                                SourceOrderNo = ent.FacOrderNo,
                                Specs = goods.Specs,
                                Figure = goods.Figure,
                                Model = goods.Model,
                                GoodsCode = Convert.ToString(row["GoodsCode"]),
                                Batch = Convert.ToString(row["Batch"]),
                                Born = Convert.ToString(row["Born"]),
                                TypeID = goods.TypeID,
                                SpeedLevel = Convert.ToString(row["LoadIndex"]),
                                LoadIndex = Convert.ToString(row["LoadIndex"]),
                                InPiece = Convert.ToInt32(row["Piece"]),
                                ContainerGoodsID = goods.ID,
                                ContainerID = goods.ContainerID,
                                ProductID = goods.ProductID
                            });
                        }
                    }
                    else if (order.TrafficType == "0")
                    {
                        CargoFactoryOrderBus busFac = new CargoFactoryOrderBus();
                        CargoFactoryOrderEntity facEnt = busFac.QueryFactoryOrderData(new CargoFactoryOrderEntity { FacOrderNo = order.FacOrderNo, HouseID = order.HouseID, TypeID = Convert.ToInt32(row["TypeID"]), Specs = Convert.ToString(row["Specs"]), GoodsCode = Convert.ToString(row["GoodsCode"]), Model = Convert.ToString(row["Model"]), Figure = Convert.ToString(row["Figure"]), LoadIndex = Convert.ToString(row["LoadIndex"]), SpeedLevel = Convert.ToString(row["SpeedLevel"]), Born = Convert.ToString(row["Born"]), Batch = Convert.ToString(row["Batch"]) });
                        if (!facEnt.ID.Equals(0) && ent.Piece > facEnt.InPiece)
                        {
                            busFac.UpdateFactoryInPiece(new CargoFactoryOrderEntity { FacOrderNo = facEnt.FacOrderNo, HouseID = facEnt.HouseID, ID = facEnt.ID, InPiece = ent.Piece }, log);
                        }
                    }

                    productList.Add(new CargoProductEntity
                    {
                        TypeID = Convert.ToInt32(row["TypeID"]),
                        InPiece = Convert.ToInt32(row["Piece"]),
                        Specs = Convert.ToString(row["Specs"]),
                        Figure = Convert.ToString(row["Figure"]),
                        Model = Convert.ToString(row["Model"]),
                        GoodsCode = Convert.ToString(row["GoodsCode"]),
                        LoadIndex = Convert.ToString(row["LoadIndex"]),
                        SpeedLevel = Convert.ToString(row["SpeedLevel"]),
                        Born = Convert.ToString(row["Born"]),
                        Batch = Convert.ToString(row["Batch"]),
                        UnitPrice = Convert.ToDecimal(row["UnitPrice"]),
                        CostPrice = Convert.ToDecimal(row["CostPrice"]),
                        TradePrice = Convert.ToDecimal(row["TradePrice"]),
                        SalePrice = Convert.ToDecimal(row["SalePrice"]),
                        OPID = UserInfor.LoginName.Trim()
                    });
                }

                if (msg.Result)
                {
                    bus.AddReturnOesOrderInfo(ent, productList, goodsList, log);
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 删除来货单
        /// </summary>
        public void DelArrivalOrderData()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoOrderEntity> list = new List<CargoOrderEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "来货管理";
            log.Status = "0";
            log.NvgPage = "来货管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            try
            {
                if (!UserInfor.IsDelOrder.Equals("1"))
                {
                    msg.Message = "您没有删除订单权限";
                    msg.Result = false;
                }
                if (msg.Result)
                {
                    foreach (Hashtable row in rows)
                    {
                        if (Convert.ToString(row["AwbStatus"]).Equals("2"))
                        {
                            msg.Message = Convert.ToString(row["OrderID"]) + "入库中，不允许删除";
                            msg.Result = false;
                            break;
                        }
                        if (Convert.ToString(row["AwbStatus"]).Equals("1"))
                        {
                            msg.Message = Convert.ToString(row["OrderID"]) + "已入库，不允许删除";
                            msg.Result = false;
                            break;
                        }
                        CargoOrderEntity ord = bus.QueryOesOrderInfoByOrderID(Convert.ToInt64(row["OrderID"]));
                        //if (ord.FinanceSecondCheck.Equals("1"))
                        //{
                        //    msg.Message = "财务已审核，不允许删除";
                        //    msg.Result = false;
                        //    break;
                        //}
                        if (ord.CheckStatus.Equals("1"))
                        {
                            msg.Message = Convert.ToString(row["OrderID"]) + "已结清，不允许删除";
                            msg.Result = false;
                            break;
                        }
                        if (ord.CheckStatus.Equals("2"))
                        {
                            msg.Message = Convert.ToString(row["OrderID"]) + "结算中，不允许删除";
                            msg.Result = false;
                            break;
                        }

                        list.Add(new CargoOrderEntity
                        {
                            OrderID = Convert.ToInt64(row["OrderID"]),
                            AcceptUnit = Convert.ToString(row["AcceptUnit"]),
                            AcceptPeople = Convert.ToString(row["AcceptPeople"]),
                            Piece = Convert.ToInt32(row["Piece"]),
                            FacOrderNo = Convert.ToString(row["FacOrderNo"]),
                            HouseID = ord.HouseID
                        });
                    }
                    if (msg.Result)
                    {
                        bus.DelArrivalOrderData(list, log);

                        msg.Result = true;
                        msg.Message = "成功";
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();

        }
        #endregion
        #region

        public void QueryShortageListInfo()
        {
            ShortageListEntity queryEntity = new ShortageListEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Specs"])))
            {
                queryEntity.Specs = Convert.ToString(Request["Specs"]);
            }
            if (!string.IsNullOrEmpty(Request["Figure"]))
            {
                queryEntity.Figure = Convert.ToString(Request["Figure"]);
            }
            if (!string.IsNullOrEmpty(Request["GoodsCode"]))
            {
                queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryShortageListInfo(pageIndex, pageSize, queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
            Response.End();

        }
        public void QueryShortageListInfoExport()
        {
            string err = "OK";
            ShortageListEntity queryEntity = new ShortageListEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Specs"])))
            {
                queryEntity.Specs = Convert.ToString(Request["Specs"]);
            }
            if (!string.IsNullOrEmpty(Request["Figure"]))
            {
                queryEntity.Figure = Convert.ToString(Request["Figure"]);
            }
            if (!string.IsNullOrEmpty(Request["GoodsCode"]))
            {
                queryEntity.GoodsCode = Convert.ToString(Request["GoodsCode"]);
            }
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryShortageListInfo(1, 10000, queryEntity);
            if (list != null) { QueryShortageListInfoList = list; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
            Response.End();

        }
        public Hashtable QueryShortageListInfoList
        {
            get
            {
                if (Session["QueryShortageListInfoList"] == null)
                {
                    Session["QueryShortageListInfoList"] = new Hashtable();
                }
                return (Hashtable)(Session["QueryShortageListInfoList"]);
            }
            set
            {
                Session["QueryShortageListInfoList"] = value;
            }
        }
        #endregion
        #region 工厂进货 
        /// <summary>
        /// 新增工厂进货单
        /// </summary>
        public void AddFactoryPurchaseOrderInfo()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            CargoHouseBus house = new CargoHouseBus();
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            Dictionary<int, ArrayList> rows = new Dictionary<int, ArrayList>();

            CargoOrderBus bus = new CargoOrderBus();
            CargoHouseBus houseBus = new CargoHouseBus();
            List<CargoFactoryOrderEntity> factoryList = new List<CargoFactoryOrderEntity>();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "新增工厂进货";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            log.Status = "0";
            List<CargoFactoryPurchaseOrderGoodsEntity> productList = new List<CargoFactoryPurchaseOrderGoodsEntity>();
            CargoFactoryPurchaseOrderEntity ent = new CargoFactoryPurchaseOrderEntity();
            ent.CheckStatus = "0";
            ent.HouseID = UserInfor.HouseID;
            ent.OP_ID = UserInfor.LoginName;
            ent.Remark = Convert.ToString(Request["Remark"]);
            ent.OrderNo = DateTime.Now.ToString("yyyyMMddHHmmss");
            int pieceSum = 0;
            double trFee = 0;
            foreach (Hashtable row in GridRows)
            {
                productList.Add(new CargoFactoryPurchaseOrderGoodsEntity
                {
                    TypeID = Convert.ToInt32(row["TypeID"]),
                    Specs = Convert.ToString(row["Specs"]).Trim(),
                    Figure = Convert.ToString(row["Figure"]).Trim(),
                    Model = Convert.ToString(row["Model"]).Trim(),
                    GoodsCode = Convert.ToString(row["GoodsCode"]).Trim(),
                    LoadIndex = string.IsNullOrEmpty(Convert.ToString(row["LoadIndex"])) ? "0" : Convert.ToString(row["LoadIndex"]).Trim(),
                    SpeedLevel = Convert.ToString(row["SpeedLevel"]).Trim(),
                    Born = Convert.ToString(row["Born"]).Trim(),
                    Piece = Convert.ToInt32(row["Piece"]),
                    UnitPrice = string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDouble(row["UnitPrice"]),
                    WhetherTax = Convert.ToInt32(row["WhetherTax"]) == 0 ? 0 : 1
                });
                pieceSum += Convert.ToInt32(row["Piece"]);
                trFee += (string.IsNullOrEmpty(Convert.ToString(row["UnitPrice"])) ? 0 : Convert.ToDouble(row["UnitPrice"])) * Convert.ToInt32(row["Piece"]);
            }
            ent.Piece = pieceSum;
            ent.TotalCharge = trFee;
            if (msg.Result)
            {
                bus.AddFactoryPurchaseOrderInfo(ent, productList, log);
                msg.Result = true;
                msg.Message = "成功";
            }
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        /// <summary>
        /// 查询工厂进货单
        /// </summary>
        public void QueryFactoryPurchaseOrderListInfo()
        {
            CargoFactoryPurchaseOrderEntity queryEntity = new CargoFactoryPurchaseOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            queryEntity.HouseID = UserInfor.HouseID;
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryFactoryPurchaseOrderListInfo(pageIndex, pageSize, queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
            Response.End();

        }
        /// <summary>
        /// 查询工厂进货单导出
        /// </summary>
        public void QueryFactoryPurchaseOrderListInfoExport()
        {
            string err = "OK";
            CargoFactoryPurchaseOrderEntity queryEntity = new CargoFactoryPurchaseOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            queryEntity.HouseID = UserInfor.HouseID;
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryFactoryPurchaseOrderListInfo(1, 10000, queryEntity);
            if (list != null) { QueryFactoryPurchaseOrderList = list; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
            Response.End();

        }
        public Hashtable QueryFactoryPurchaseOrderList
        {
            get
            {
                if (Session["QueryFactoryPurchaseOrderList"] == null)
                {
                    Session["QueryFactoryPurchaseOrderList"] = new Hashtable();
                }
                return (Hashtable)(Session["QueryFactoryPurchaseOrderList"]);
            }
            set
            {
                Session["QueryFactoryPurchaseOrderList"] = value;
            }
        }
        /// <summary>
        /// 查询公司进货单明细
        /// </summary>
        public void QueryFactoryPurchaseOrderGoodsInfo()
        {
            CargoFactoryPurchaseOrderEntity queryEntity = new CargoFactoryPurchaseOrderEntity();
            //查询条件
            string key = Request["OrderID"];
            if (string.IsNullOrEmpty(key)) { Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return; }
            queryEntity.OrderID = Convert.ToInt64(key.Trim());
            CargoOrderBus bus = new CargoOrderBus();
            List<CargoFactoryPurchaseOrderGoodsEntity> list = bus.QueryFactoryPurchaseOrderGoods(queryEntity);
            if (list != null) { QueryFactoryPurchaseOrderGoodsList = list; }
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public List<CargoFactoryPurchaseOrderGoodsEntity> QueryFactoryPurchaseOrderGoodsList
        {
            get
            {
                if (Session["QueryFactoryPurchaseOrderGoodsList"] == null)
                {
                    Session["QueryFactoryPurchaseOrderGoodsList"] = new List<CargoFactoryPurchaseOrderGoodsEntity>();
                }
                return (List<CargoFactoryPurchaseOrderGoodsEntity>)(Session["QueryFactoryPurchaseOrderGoodsList"]);
            }
            set
            {
                Session["QueryFactoryPurchaseOrderGoodsList"] = value;
            }
        }
        /// <summary>
        /// 删除工厂进货单
        /// </summary>
        public void DelFactoryPurchaseOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoFactoryPurchaseOrderEntity> list = new List<CargoFactoryPurchaseOrderEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "工厂进货管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            int HouseID = 0;

            try
            {
                foreach (Hashtable row in rows)
                {
                    CargoFactoryPurchaseOrderEntity ord = bus.QueryFactoryPurchaseOrderInfo(new CargoFactoryPurchaseOrderEntity { OrderID = Convert.ToInt64(row["OrderID"]) });
                    HouseID = ord.HouseID;
                    if (HouseID != 0)
                    {
                        if (ord.CheckStatus.Equals("1") && ord.ApplyStatus.Equals("3"))
                        {
                            msg.Message = Convert.ToString(row["OrderNo"]) + "已审批，无法删除";
                            msg.Result = false;
                            break;
                        }
                        if (ord.CheckStatus.Equals("2"))
                        {
                            msg.Message = Convert.ToString(row["OrderNo"]) + "审批中，无法删除";
                            msg.Result = false;
                            break;
                        }
                    }
                    else
                    {
                        msg.Message = Convert.ToString(row["OrderNo"]) + "未查询到订单数据";
                        msg.Result = false;
                        break;
                    }
                    list.Add(new CargoFactoryPurchaseOrderEntity
                    {
                        OrderID = Convert.ToInt64(row["OrderID"]),
                        OrderNo = Convert.ToString(row["OrderNo"])
                    });
                }
                if (msg.Result)
                {
                    bus.DeleteFactoryPurchaseOrderInfo(list, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
        ERROR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }
        /// <summary>
        /// 更新工厂进货单数量
        /// </summary>
        public void UpdateFactoryPurchaseOrderPiece()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "工厂进货管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            try
            {
                CargoFactoryPurchaseOrderGoodsEntity entity = new CargoFactoryPurchaseOrderGoodsEntity();
                CargoOrderBus bus = new CargoOrderBus();

                foreach (Hashtable row in rows)
                {
                    CargoFactoryPurchaseOrderEntity ord = bus.QueryFactoryPurchaseOrderInfo(new CargoFactoryPurchaseOrderEntity { OrderNo = Convert.ToString(row["OrderNo"]) });
                    if (ord.CheckStatus.Equals("1") && ord.ApplyStatus.Equals("3"))
                    {
                        msg.Message = Convert.ToString(row["OrderNo"]) + "已审批，无法修改";
                        msg.Result = false;
                        break;
                    }
                    if (ord.CheckStatus.Equals("2"))
                    {
                        msg.Message = Convert.ToString(row["OrderNo"]) + "审批中，无法修改";
                        msg.Result = false;
                        break;
                    }
                    entity.ID = Convert.ToInt32(row["ID"]);
                    entity.Specs = Convert.ToString(row["Specs"]);
                    entity.Figure = Convert.ToString(row["Figure"]);
                    entity.SpeedLevel = Convert.ToString(row["SpeedLevel"]);
                    entity.LoadIndex = Convert.ToString(row["LoadIndex"]);
                    entity.GoodsCode = Convert.ToString(row["GoodsCode"]);
                    entity.Born = Convert.ToString(row["Born"]);

                    entity.Piece = Convert.ToInt32(row["Piece"]);//新数量
                    entity.OldPiece = Convert.ToInt32(row["oldPiece"]);//旧数量

                    entity.OrderID = ord.OrderID;
                    entity.OrderNo = ord.OrderNo;
                    entity.TypeID = Convert.ToInt32(row["TypeID"]);
                    entity.TypeName = Convert.ToString(row["TypeName"]);
                    entity.UnitPrice = Convert.ToDouble(row["UnitPrice"]);

                    if (entity.Piece.Equals(entity.OldPiece))
                    {
                        msg.Result = false;
                        msg.Message = "未修改数量";
                        break;
                    }
                }
                if (msg.Result)
                {
                    if (entity.Piece == 0)
                    {
                        bus.DeleteFactoryPurchaseOrderGoods(entity, log);
                    }
                    else
                    {
                        bus.UpdateFactoryPurchaseOrderGoodsPiece(entity, log);
                    }
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }
        /// <summary>
        /// 添加工厂进货单产品
        /// </summary>
        public void AddFactoryPurchaseOrderGoods()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            List<CargoContainerShowEntity> entityList = new List<CargoContainerShowEntity>();
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "工厂进货管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            try
            {
                CargoFactoryPurchaseOrderGoodsEntity entity = new CargoFactoryPurchaseOrderGoodsEntity();
                foreach (Hashtable row in rows)
                {
                    CargoFactoryPurchaseOrderEntity ord = bus.QueryFactoryPurchaseOrderInfo(new CargoFactoryPurchaseOrderEntity { OrderID = Convert.ToInt64(row["OrderID"]) });
                    if (ord.CheckStatus.Equals("1") && ord.ApplyStatus.Equals("3"))
                    {
                        msg.Message = Convert.ToString(row["OrderNo"]) + "已审批，无法修改";
                        msg.Result = false;
                        break;
                    }
                    if (ord.CheckStatus.Equals("2"))
                    {
                        msg.Message = Convert.ToString(row["OrderNo"]) + "审批中，无法修改";
                        msg.Result = false;
                        break;
                    }
                    entity.OrderID = ord.OrderID;
                    entity.OrderNo = ord.OrderNo;
                    entity.Specs = Convert.ToString(row["Specs"]);
                    entity.Figure = Convert.ToString(row["Figure"]);
                    entity.Model = Convert.ToString(row["Model"]);
                    entity.SpeedLevel = Convert.ToString(row["SpeedLevel"]);
                    entity.LoadIndex = Convert.ToString(row["LoadIndex"]);
                    entity.GoodsCode = Convert.ToString(row["GoodsCode"]);
                    entity.TypeID = Convert.ToInt32(row["TypeID"]);
                    entity.Born = Convert.ToString(row["Born"]);
                    entity.Piece = Convert.ToInt32(row["Piece"]);
                    entity.UnitPrice = Convert.ToDouble(row["UnitPrice"]);
                    entity.WhetherTax = Convert.ToInt32(row["WhetherTax"]) == 0 ? 0 : 1;
                }
                if (msg.Result)
                {
                    bus.AddFactoryPurchaseOrderGoods(entity, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }

        public void UpdateFactoryPurchaseOrderInfo()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoFactoryPurchaseOrderEntity ent = new CargoFactoryPurchaseOrderEntity();
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "工厂进货管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            CargoFactoryPurchaseOrderEntity ord = new CargoFactoryPurchaseOrderEntity();
            try
            {
                ent.OrderID = Convert.ToInt64(Request["OrderID"]);
                ord = bus.QueryFactoryPurchaseOrderInfo(new CargoFactoryPurchaseOrderEntity { OrderID = Convert.ToInt32(Request["OrderID"]) });
                if (ord.CheckStatus.Equals("1") && ord.ApplyStatus.Equals("3"))
                {
                    msg.Message = ent.OrderNo + "已审批，无法修改";
                    msg.Result = false;
                    goto ERROR;
                }
                if (ord.CheckStatus.Equals("2"))
                {
                    msg.Message = ent.OrderNo + "审批中，无法修改";
                    msg.Result = false;
                    goto ERROR;
                }

                if (msg.Result)
                {
                    #region 赋值
                    ent.OP_ID = UserInfor.LoginName.Trim();
                    ent.OrderNo = ord.OrderNo;
                    ent.Remark = Convert.ToString(Request["Remark"]);
                    #endregion

                    if (msg.Result)
                    {
                        bus.UpdateFactoryPurchaseOrder(ent, log);
                        msg.Result = true;
                        msg.Message = ent.OrderNo;//订单号和出库单号
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }

        ERROR:
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
            Response.End();
        }
        public void SubmitFactoryPurchaseOrderReview()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoFactoryPurchaseOrderEntity result = new CargoFactoryPurchaseOrderEntity();
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "工厂进货管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            CargoFactoryPurchaseOrderEntity ord = new CargoFactoryPurchaseOrderEntity();
            try
            {
                result.OrderID = Convert.ToInt64(Request["OrderID"]);
                result.OrderNo = Convert.ToString(Request["OrderNo"]);
                ord = bus.QueryFactoryPurchaseOrderInfo(new CargoFactoryPurchaseOrderEntity { OrderID = Convert.ToInt32(Request["OrderID"]) });
                result.Remark = ord.Remark;
                if (ord.CheckStatus.Equals("1") && ord.ApplyStatus.Equals("3"))
                {
                    msg.Message = result.OrderNo + "已审批，无法提交";
                    msg.Result = false;
                    goto ERROR;
                }
                if (ord.CheckStatus.Equals("2"))
                {
                    msg.Message = result.OrderNo + "审批中，无法提交";
                    msg.Result = false;
                    goto ERROR;
                }
                if (msg.Result)
                {
                    #region 赋值
                    result.OP_ID = UserInfor.LoginName.Trim();
                    result.CheckStatus = "2";
                    result.ApplyID = UserInfor.LoginName.ToString();
                    result.ApplyName = UserInfor.UserName;
                    result.ApplyStatus = "0";
                    #endregion

                    string ApproveType = "14";
                    //1.查询审批设置表获得审批流程
                    QiyeBus qiye = new QiyeBus();
                    CargoFinanceBus f = new CargoFinanceBus();
                    //CargoApproveSetEntity AppSet = f.QueryApproveSetByID(33);
                    CargoApproveSetEntity AppSet = new CargoApproveSetEntity();
                    List<CargoApproveSetEntity> aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = ApproveType, DelFlag = "0", HouseID = ord.HouseID });
                    if (aset.Count > 0) { AppSet = aset[0]; }
                    else
                    {
                        msg.Message = "未配置审批流程，无法提交";
                        msg.Result = false;
                        goto ERROR;
                    }
                    List<QyUserEntity> qyUser = new List<QyUserEntity>();
                    //2.审批流程的每一级和当前人的审批角色相匹配
                    if (AppSet.OneCheckID.Equals("3"))
                    {
                        SystemUserEntity entity = new SystemUserEntity();
                        entity.LoginName = UserInfor.LoginName;
                        SystemUserEntity bossLeader = bus.QueryBossLeaderByLoginName(entity);
                        if (bossLeader != null)
                        {
                            //申请人有部门负责人
                            if (!string.IsNullOrEmpty(bossLeader.LoginName))
                            {
                                if (bossLeader.LoginName != UserInfor.LoginName)
                                {
                                    qyUser.Add(new QyUserEntity { UserID = bossLeader.LoginName, WxName = bossLeader.UserName });
                                    result.NextCheckID = AppSet.OneCheckID;
                                    result.NextCheckName = AppSet.OneCheckName;
                                }
                                //申请人部门负责人是自己，推送给下一级
                                else
                                {
                                    qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID, CheckHouseID = ord.HouseID.ToString() });
                                    result.NextCheckID = AppSet.TwoCheckID;
                                    result.NextCheckName = AppSet.TwoCheckName;
                                }
                            }
                            //申请人没有部门负责人，推送给下一级
                            else
                            {
                                qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = AppSet.TwoCheckID, CheckHouseID = ord.HouseID.ToString() });
                                result.NextCheckID = AppSet.TwoCheckID;
                                result.NextCheckName = AppSet.TwoCheckName;
                            }
                        }
                        //申请人信息跳过操作记录错误
                        else
                        {
                            Common.WriteTextLog("推送失败：申请人未查询到数据");
                            msg.Result = true;
                            goto ERROR;
                        }
                    }
                    else
                    {
                        qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = AppSet.OneCheckID, CheckHouseID = ord.HouseID.ToString() });
                        result.NextCheckID = AppSet.OneCheckID;
                        result.NextCheckName = AppSet.OneCheckName;
                    }

                    bus.SubmitFactoryPurchaseOrderReview(result, log);
                    msg.Result = true;
                    msg.Message = result.OrderNo;//订单号和出库单号

                    CargoFinanceBus financeBus = new CargoFinanceBus();
                    CargoExpenseApproveRoutEntity approveRoute = new CargoExpenseApproveRoutEntity();
                    approveRoute.ExID = ord.OrderID;
                    approveRoute.UserID = UserInfor.LoginName;
                    approveRoute.UserName = UserInfor.UserName;
                    approveRoute.Opera = "3";
                    approveRoute.Result = ord.Remark;
                    approveRoute.ApproveType = "5";
                    financeBus.AddExpenseApproveRout(approveRoute);
                    try
                    {
                        QySendInfoEntity send = new QySendInfoEntity();
                        send.title = "锦湖工厂进货申请";
                        send.msgType = msgType.textcard;
                        send.content = "<div></div><div>订单号：" + ord.OrderNo + "</div><div>数量：" + ord.Piece + "</div><div>总价：" + ord.TotalCharge + "</div><div>申请人：" + UserInfor.UserName + "</div><div>申请时间：" + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>申请原因：" + ord.Remark + "</div><div></div><div class=\"highlight\">请点击本通知进行审批！</div>";
                        send.url = "http://dlt.neway5.com/QY/qyFactoryPurchaseCheck.aspx?OrderNo=" + ord.OrderNo + "&OrderID=" + ord.OrderID;
                        foreach (var it in qyUser)
                        {
                            send.toUser = it.UserID;
#if !DEBUG
                            WxQYSendHelper.PushInfo("0", "2", send);
#endif
                            Common.WriteTextLog("推送成功：" + it.WxName + ord.OrderNo);
                        }

                    }
                    catch (ApplicationException ex)
                    {
                        Common.WriteTextLog("推送失败：" + ord.OrderNo);
                        msg.Result = true;
                        goto ERROR;
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
        ERROR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }
        public void UpdateFactoryPurchaseFacOrderNo()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoFactoryPurchaseOrderEntity ent = new CargoFactoryPurchaseOrderEntity();
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "工厂进货管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            CargoFactoryPurchaseOrderEntity ord = new CargoFactoryPurchaseOrderEntity();
            try
            {
                ent.OrderID = Convert.ToInt64(Request["faOrderID"]);
                ent.OrderNo = Convert.ToString(Request["faOrderNo"]);
                ent.FacOrderNo = Convert.ToString(Request["FacOrderNo"]); ;
                ord = bus.QueryFactoryPurchaseOrderInfo(new CargoFactoryPurchaseOrderEntity { OrderID = Convert.ToInt32(Request["faOrderID"]) });
                if (ord.CheckStatus.Equals("1") && ord.ApplyStatus.Equals("3"))
                {
                    #region 赋值
                    ent.OP_ID = UserInfor.LoginName.Trim();
                    ent.Remark = Convert.ToString(Request["Remark"]);
                    #endregion

                    if (msg.Result)
                    {
                        bus.UpdateFactoryPurchaseOrder(ent, log);
                        msg.Result = true;
                        msg.Message = ent.OrderNo;//订单号和出库单号
                    }
                }
                else
                {
                    msg.Message = ent.OrderNo + "审批未完成无法操作";
                    msg.Result = false;
                    goto ERROR;
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }

        ERROR:
            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
            Response.End();
        }
        public void QueryFactoryPurchaseExpenseRout()
        {
            string res = "<div style='text-align: center'>该订单没有审批流程</div>";

            string applyID = Request["ApplyID"];
            string applyName = Request["ApplyName"];
            int HouseID = Convert.ToInt32(Request["HouseID"]);
            QiyeBus qiye = new QiyeBus();

            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoExpenseApproveRoutEntity> result = bus.QueryExpenseRoutAtExID(new CargoExpenseApproveRoutEntity { ApproveType = "5", ExID = Convert.ToInt64(Request["OrderID"]) });

            ArrayList checklist = new ArrayList();

            bool operaType = false;
            if (result.Count > 0)
            {
                res = "<table class='commTblStyle_8' border='0' width='100%' style='border-spacing:0;border-collapse:collapse;font-size:14px;'><tbody><tr><th>处理人</th><th>操作</th><th>处理时间</th><th>结果</th></tr>";
                foreach (var it in result)
                {
                    checklist.Add(it.UserName);
                    string op = "通过";
                    if (it.Opera.Equals("1")) { op = "拒审"; }
                    else if (it.Opera.Equals("2")) { op = "结束"; operaType = true; }
                    else if (it.Opera.Equals("3")) { op = "提交申请"; }
                    res += "<tr><td>" + it.UserName + "</td><td>" + op + "</td><td>" + it.OperaDate.ToString("yyyy-MM-dd HH:mm:ss") + "</td><td>" + it.Result + "</td></tr>";
                }
                res += "</tbody><table>";

                #region 步骤图
                string str = "<div class='content' style='margin: -3% 5%;'><div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'><span class='poetry'>" + applyName + "</span></div><div class='bar b-select'><div class='c-step c-select'></div></div><div class='text' style='margin: 10px -25px;'><span class='poetry'>发起申请</span></div></div>";
                //string str = "";
                CargoFinanceBus f = new CargoFinanceBus();
                List<QyUserEntity> qyUser = new List<QyUserEntity>();
                CargoApproveSetEntity AppSet = new CargoApproveSetEntity();
                List<CargoApproveSetEntity> aset = f.QueryApproveSet(new CargoApproveSetEntity { ApproveType = "14", DelFlag = "0", HouseID = HouseID });
                if (aset.Count > 0) { AppSet = aset[0]; }
                else
                {
                    res = "未配置审批流程";
                    goto ERROR;
                }
                CargoOrderBus orderBus = new CargoOrderBus();

                if (!string.IsNullOrEmpty(AppSet.OneCheckID))
                {
                    string CheckID = AppSet.OneCheckID;
                    string CheckName = AppSet.OneCheckName;
                    qyUser.Clear();
                    string userStr = "", name = "";
                    if (CheckID == "3")
                    {
                        SystemUserEntity entity = new SystemUserEntity();
                        entity.LoginName = applyID;
                        List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                        if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                        {
                            userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                            name = Bosslist[0].UserName;
                        }
                    }
                    else
                    {
                        qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                        //foreach (var user in qyUser)
                        if (!string.IsNullOrEmpty(qyUser[0].WxName))
                        {
                            userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                            name = qyUser[0].WxName;
                        }
                    }
                    if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                    str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                    if (checklist.Contains(name))
                    {
                        str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                    }
                    else
                    {
                        str += "<div class='bar'><div class='c-step'></div></div>";
                    }
                    str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                    if (!string.IsNullOrEmpty(AppSet.TwoCheckID))
                    {
                        CheckID = AppSet.TwoCheckID;
                        CheckName = AppSet.TwoCheckName;
                        qyUser.Clear();
                        userStr = "";
                        if (CheckID == "3")
                        {
                            SystemUserEntity entity = new SystemUserEntity();
                            entity.LoginName = applyID;
                            List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                            if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                            {
                                userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                name = Bosslist[0].UserName;
                            }
                        }
                        else
                        {
                            qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                            if (!string.IsNullOrEmpty(qyUser[0].WxName))
                            {
                                userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                name = qyUser[0].WxName;
                            }
                        }
                        if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                        str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                        if (checklist.Contains(name))
                        {
                            str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                        }
                        else
                        {
                            str += "<div class='bar'><div class='c-step'></div></div>";
                        }
                        str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                        if (!string.IsNullOrEmpty(AppSet.ThreeCheckID))
                        {
                            CheckID = AppSet.ThreeCheckID;
                            CheckName = AppSet.ThreeCheckName;
                            qyUser.Clear();
                            userStr = "";
                            if (CheckID == "3")
                            {
                                SystemUserEntity entity = new SystemUserEntity();
                                entity.LoginName = applyID;
                                List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                {
                                    userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                    name = Bosslist[0].UserName;
                                }
                            }
                            else
                            {
                                qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                if (qyUser.Count > 0)
                                {
                                    if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                    {
                                        userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                        name = qyUser[0].WxName;
                                    }
                                }
                            }
                            if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                            str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                            if (checklist.Contains(name))
                            {
                                str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                            }
                            else
                            {
                                str += "<div class='bar'><div class='c-step'></div></div>";
                            }
                            str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                            if (!string.IsNullOrEmpty(AppSet.FourCheckID))
                            {
                                CheckID = AppSet.FourCheckID;
                                CheckName = AppSet.FourCheckName;
                                qyUser.Clear();
                                userStr = "";
                                if (CheckID == "3")
                                {
                                    SystemUserEntity entity = new SystemUserEntity();
                                    entity.LoginName = applyID;
                                    List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                    if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                    {
                                        userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                        name = Bosslist[0].UserName;
                                    }
                                }
                                else
                                {
                                    qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                    if (qyUser.Count > 0)
                                    {
                                        if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                        {
                                            userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                            name = qyUser[0].WxName;
                                        }
                                    }
                                }
                                if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                if (checklist.Contains(name))
                                {
                                    str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                }
                                else
                                {
                                    str += "<div class='bar'><div class='c-step'></div></div>";
                                }
                                str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                if (!string.IsNullOrEmpty(AppSet.FiveCheckID))
                                {
                                    CheckID = AppSet.FiveCheckID;
                                    CheckName = AppSet.FiveCheckName;
                                    qyUser.Clear();
                                    userStr = "";
                                    if (CheckID == "3")
                                    {
                                        SystemUserEntity entity = new SystemUserEntity();
                                        entity.LoginName = applyID;
                                        List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                        if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                        {
                                            userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                            name = Bosslist[0].UserName;
                                        }
                                    }
                                    else
                                    {
                                        qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                        if (qyUser.Count > 0)
                                        {
                                            if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                            {
                                                userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                                name = qyUser[0].WxName;
                                            }
                                        }
                                    }
                                    if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                    str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                    if (checklist.Contains(name))
                                    {
                                        str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                    }
                                    else
                                    {
                                        str += "<div class='bar'><div class='c-step'></div></div>";
                                    }
                                    str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                    if (!string.IsNullOrEmpty(AppSet.SixCheckID))
                                    {
                                        CheckID = AppSet.SixCheckID;
                                        CheckName = AppSet.SixCheckName;
                                        qyUser.Clear();
                                        userStr = "";
                                        if (CheckID == "3")
                                        {
                                            SystemUserEntity entity = new SystemUserEntity();
                                            entity.LoginName = applyID;
                                            List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                            if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                            {
                                                userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                                name = Bosslist[0].UserName;
                                            }
                                        }
                                        else
                                        {
                                            qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                            if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                            {
                                                userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                                name = qyUser[0].WxName;
                                            }
                                        }
                                        if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                        str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                        if (checklist.Contains(name))
                                        {
                                            str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                        }
                                        else
                                        {
                                            str += "<div class='bar'><div class='c-step'></div></div>";
                                        }
                                        str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                        if (!string.IsNullOrEmpty(AppSet.SevenCheckID))
                                        {
                                            CheckID = AppSet.SevenCheckID;
                                            CheckName = AppSet.SevenCheckName;
                                            qyUser.Clear();
                                            userStr = "";
                                            if (CheckID == "3")
                                            {
                                                SystemUserEntity entity = new SystemUserEntity();
                                                entity.LoginName = applyID;
                                                List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                                if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                                {
                                                    userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                                    name = Bosslist[0].UserName;
                                                }
                                            }
                                            else
                                            {
                                                qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                                if (qyUser.Count > 0)
                                                {
                                                    if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                                    {
                                                        userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                                        name = qyUser[0].WxName;
                                                    }
                                                }
                                            }
                                            if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                            str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                            if (checklist.Contains(name))
                                            {
                                                str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                            }
                                            else
                                            {
                                                str += "<div class='bar'><div class='c-step'></div></div>";
                                            }
                                            str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                            if (!string.IsNullOrEmpty(AppSet.EightCheckID))
                                            {
                                                CheckID = AppSet.EightCheckID;
                                                CheckName = AppSet.EightCheckName;
                                                qyUser.Clear();
                                                userStr = "";
                                                if (CheckID == "3")
                                                {
                                                    SystemUserEntity entity = new SystemUserEntity();
                                                    entity.LoginName = applyID;
                                                    List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                                    if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                                    {
                                                        userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                                        name = Bosslist[0].UserName;
                                                    }
                                                }
                                                else
                                                {
                                                    qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                                    if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                                    {
                                                        userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                                        name = qyUser[0].WxName;
                                                    }
                                                }
                                                if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                                str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                                if (checklist.Contains(name))
                                                {
                                                    str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                                }
                                                else
                                                {
                                                    str += "<div class='bar'><div class='c-step'></div></div>";
                                                }
                                                str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                if (operaType)
                {
                    str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'><span class='poetry'>&nbsp;</span></div><div class='bar b-select' style='width: 0;'><div class='c-step c-select'></div></div><div class='text' style='margin: 10px -15px;'><span class='poetry'>结束</span></div></div></div>";
                }
                else
                {
                    str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'><span class='poetry'>&nbsp;</span></div><div class='bar' style='width: 0;'><div class='c-step'></div></div><div class='text' style='margin: 10px -15px;'><span class='poetry'>结束</span></div></div></div>";
                }
                #endregion
                res = str + res;
            }

        ERROR:
            String json = JSON.Encode(res);
            Response.Write(json);
        }
        #endregion
        #region 仓库到货订单管理
        public void QueryHouseArrivalOrderInfo()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Piece"]))) { queryEntity.Piece = Convert.ToInt32(Request["Piece"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
            queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])))
            {
                queryEntity.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
            }
            queryEntity.PayClientName = Convert.ToString(Request["PayClientName"]);
            queryEntity.Dep = Convert.ToString(Request["Dep"]);
            queryEntity.Dest = Convert.ToString(Request["Dest"]);
            queryEntity.CreateAwb = Convert.ToString(Request["CreateAwb"]);
            queryEntity.OutHouseName = Convert.ToString(Request["OutHouseName"]);
            if (Convert.ToString(Request["OrderType"]) != "-1")
            {
                queryEntity.OrderType = Convert.ToString(Request["OrderType"]);
            }
            if (Convert.ToString(Request["AwbStatus"]) != "-1")
            {
                queryEntity.AwbStatus = Convert.ToString(Request["AwbStatus"]);
            }
            if (Convert.ToString(Request["FinanceSecondCheck"]) != "-1")
            {
                queryEntity.FinanceSecondCheck = Convert.ToString(Request["FinanceSecondCheck"]);
            }
            queryEntity.SaleManID = Convert.ToString(Request["SaleManID"]);
            if (Convert.ToString(Request["OrderModel"]) != "-1")
            {
                queryEntity.OrderModel = Convert.ToString(Request["OrderModel"]);
            }
            if (Convert.ToString(Request["ThrowGood"]) != "-1")
            {
                queryEntity.ThrowGood = Convert.ToString(Request["ThrowGood"]);
            }
            //2021-01-21 添加公司类型查询条件
            if (Convert.ToString(Request["BelongHouse"]) != "-1")
            {
                queryEntity.BelongHouse = Convert.ToString(Request["BelongHouse"]);
            }
            //2021-01-30 添加客户名称查询条件
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            //2021-10-20 添加出库类型查询条件
            if (Convert.ToString(Request["OutCargoType"]) != "-1")
            {
                queryEntity.OutCargoType = Convert.ToString(Request["OutCargoType"]);
            }
            //2021-10-25 添加推送类型查询条件
            if (Convert.ToString(Request["PostponeShip"]) != "-1")
            {
                queryEntity.PostponeShip = Convert.ToString(Request["PostponeShip"]);
            }
            if (Convert.ToString(Request["TrafficType"]) != "-1")
            {
                queryEntity.TrafficType = Convert.ToString(Request["TrafficType"]);
            }
            queryEntity.TranHouse = UserInfor.HouseName;
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryOrderInfo(pageIndex, pageSize, queryEntity);
            //if (list != null) { QueryOrderInfoList = list; }
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void ConfirmReceipt()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "到货订单管理";
            log.NvgPage = "确认到货";
            log.UserID = UserInfor.UserID.ToString();
            log.Status = "0";
            log.Operate = "U";
            try
            {
                CargoHouseBus houseBus = new CargoHouseBus();
                CargoProductBus productBus = new CargoProductBus();
                CargoContainerEntity containerEntity = houseBus.QueryTopOneContainer(new CargoContainerEntity { HouseID = UserInfor.HouseID });
                List<CargoFactoryOrderEntity> factoryList = new List<CargoFactoryOrderEntity>();
                List<CargoOrderEntity> orderList = new List<CargoOrderEntity>();
                CargoHouseEntity houseEntity = houseBus.QueryCargoHouseByID(UserInfor.HouseID);
                foreach (Hashtable row in rows)
                {
                    if (string.IsNullOrEmpty(Convert.ToString(row["OrderNo"])))
                    {
                        msg.Message = "未获取到订单号";
                        msg.Result = false;
                        goto Error;
                    }
                    CargoOrderEntity ord = bus.QueryOrderInfo(new CargoOrderEntity { OrderNo = Convert.ToString(row["OrderNo"]) });
                    if (ord.AwbStatus.Equals("8"))
                    {
                        msg.Message = "订单" + ord.OrderNo + "已到货";
                        msg.Result = false;
                        goto Error;
                    }
                    List<CargoContainerShowEntity> orderContainerList = bus.QueryOrderByOrderNo(new CargoOrderEntity { OrderNo = Convert.ToString(row["OrderNo"]) });
                    orderList.Add(new CargoOrderEntity { OrderNo = Convert.ToString(row["OrderNo"]) });
                    foreach (var item in orderContainerList)
                    {
                        CargoProductEntity entity = productBus.QueryProductInfoByID(item.ProductID);
                        factoryList.Add(new CargoFactoryOrderEntity
                        {
                            ProductName = houseEntity.CargoDepart,
                            TypeID = item.TypeID,
                            Model = item.Model,
                            GoodsCode = item.GoodsCode,
                            Specs = item.Specs,
                            Figure = item.Figure,
                            LoadIndex = item.LoadIndex,
                            SpeedLevel = item.SpeedLevel,
                            UnitPrice = Convert.ToDouble(entity.SalePrice),
                            OrderNum = item.Piece,
                            CostPrice = Convert.ToDouble(entity.CostPrice),
                            TradePrice = Convert.ToDouble(entity.TradePrice),
                            SalePrice = Convert.ToDouble(entity.SalePrice),
                            Batch = item.Batch,
                            BatchYear = item.BatchYear,
                            BatchWeek = item.BatchWeek,
                            HouseID = UserInfor.HouseID,
                            Source = Convert.ToInt32(item.Source),
                            FacOrderNo = Convert.ToString(row["OrderNo"]),
                            BelongMonth = DateTime.Now.ToString("yyyyMM"),
                            Born = item.Born,
                            Assort = item.Assort,
                            BelongDepart = item.BelongDepart,
                            Company = item.Company,
                            SpecsType = item.SpecsType,
                            Supplier = item.Supplier,
                            ContainerID = containerEntity.ContainerID,
                            InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString()
                        });
                    }
                }
                factoryList = factoryList.OrderBy(e => e.Specs).ToList();
                if (msg.Result)
                {
                    bus.ConfirmReceipt(orderList, factoryList, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
        Error:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 手工一键入库
        /// </summary>
        public void MoveOrderHandInCargo()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            string NewHouseID = Convert.ToString(Request["NewHouseID"]);
            int NewAreaID = string.IsNullOrEmpty(Convert.ToString(Request["NewAreaID"])) ? 0 : Convert.ToInt32(Request["NewAreaID"]); ;
            if (String.IsNullOrEmpty(NewHouseID)) return;

            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "移库订单管理";
            log.NvgPage = "一键入库";
            log.UserID = UserInfor.UserID.ToString();
            log.Status = "0";
            log.Operate = "U";
            try
            {
                CargoHouseBus houseBus = new CargoHouseBus();
                CargoContainerEntity containerEntity = houseBus.QueryTopOneContainer(new CargoContainerEntity { HouseID = Convert.ToInt32(NewHouseID), FirstAreaID = NewAreaID });
                List<CargoFactoryOrderEntity> factoryList = new List<CargoFactoryOrderEntity>();
                List<CargoMoveOrderEntity> orderList = new List<CargoMoveOrderEntity>();
                //CargoHouseEntity houseEntity = houseBus.QueryCargoHouseByID(Convert.ToInt32(NewHouseID));
                foreach (Hashtable row in rows)
                {
                    if (string.IsNullOrEmpty(Convert.ToString(row["MoveNo"])))
                    {
                        msg.Message = "未获取到移库单号";
                        msg.Result = false;
                        goto Error;
                    }
                    List<CargoContainerShowEntity> orderContainerList = bus.QueryMoveOrderByMoveOrderNo(new CargoMoveOrderGoodsEntity { MoveNo = Convert.ToString(row["MoveNo"]) });
                    orderList.Add(new CargoMoveOrderEntity { MoveNo = Convert.ToString(row["MoveNo"]), MoveStatus = "2" });
                    foreach (var item in orderContainerList)
                    {
                        factoryList.Add(new CargoFactoryOrderEntity
                        {
                            ProductName = item.ProductName,
                            TypeID = item.TypeID,
                            Model = item.Model,
                            GoodsCode = item.GoodsCode,
                            Specs = item.Specs,
                            Figure = item.Figure,
                            LoadIndex = item.LoadIndex,
                            SpeedLevel = item.SpeedLevel,
                            UnitPrice = Convert.ToDouble(item.UnitPrice),
                            OrderNum = item.Piece,
                            CostPrice = Convert.ToDouble(item.CostPrice),
                            TradePrice = Convert.ToDouble(item.TradePrice),
                            SalePrice = Convert.ToDouble(item.SalePrice),
                            Batch = item.Batch,
                            BatchYear = item.BatchYear,
                            BatchWeek = item.BatchWeek,
                            HouseID = Convert.ToInt32(NewHouseID),
                            Source = Convert.ToInt32(item.Source),
                            FacOrderNo = Convert.ToString(row["MoveNo"]),
                            BelongMonth = DateTime.Now.ToString("yyyyMM"),
                            Born = item.Born,
                            Assort = item.Assort,
                            BelongDepart = item.BelongDepart,
                            Company = item.Company,
                            SpecsType = item.SpecsType,
                            Supplier = item.Supplier,
                            ContainerID = containerEntity.ContainerID,
                            InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString()
                        });
                    }
                }
                factoryList = factoryList.OrderBy(e => e.Specs).ToList();
                if (msg.Result)
                {
                    bus.MoveOrderHandInCargo(orderList, factoryList, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
        Error:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
        #region 批量开单
        /// <summary>
        /// 批量导入开单
        /// </summary>
        public void savePLOrderFile()
        {
            System.Web.HttpFileCollection files = this.Request.Files;
            if (files == null || files.Count == 0) return;
            string attachmentId = Guid.NewGuid().ToString();
            DataTable data = ToExcel.ImportExcelData(files);

            CargoImportEntity import = new CargoImportEntity();
            import.Result = true;
            import.Data = "";
            import.Message = "";
            import.Type = 0;
            import.ExistCount = 0;
            string msg = "";

            List<CargoContainerShowEntity> ent = new List<CargoContainerShowEntity>();
            CargoProductBasicPriceBus bus = new CargoProductBasicPriceBus();
            CargoPriceBus cargoPriceBus = new CargoPriceBus();
            //验证上传excel文件列数是否有效
            if (data.Columns.Count != 7)
            {
                import.Result = false;
                import.Type = 1;
                import.Message = "模板有误或缺少列，请重新下载模板";
                String abnormalJson = JSON.Encode(import);
                Response.Clear();
                Response.Write(abnormalJson);
                Response.End();
                return;
            }
            //清空table中的空行
            removeEmpty(data);
            if (data.Rows.Count <= 0)
            {
                import.Result = false;
                import.Type = 1;
                import.Message = "Excel无有效数据，请检查导入数据";
                String abnormalJson = JSON.Encode(import);
                Response.Clear();
                Response.Write(abnormalJson);
                Response.End();
                return;
            }
            CargoProductBus productBus = new CargoProductBus();
            CargoHouseBus house = new CargoHouseBus();
            CargoClientBus clientBus = new CargoClientBus();
            //获取所有仓库用于表格显示仓库
            Dictionary<string, int> dicHouse = new Dictionary<string, int>();
            foreach (var item in UserInfor.CargoList)
            {
                if (!dicHouse.ContainsKey(item.Name))
                {
                    dicHouse.Add(item.Name, item.ID);
                }
            }
            int abnormalCount = 0;

            DataTable newData = new DataTable();
            newData.Columns.Add("HouseID");
            newData.Columns.Add("HouseName");
            newData.Columns.Add("PayClientNum");//客户编码
            newData.Columns.Add("PayClientName");//客户名称
            newData.Columns.Add("TypeID");//产品分类ID
            newData.Columns.Add("TypeName");//产品分类名称
            newData.Columns.Add("TypeParentID");//产品分类父ID
            newData.Columns.Add("TypeParentName");//产品分类父名称
            newData.Columns.Add("GoodsCode");//产品编码
            newData.Columns.Add("ProductName");//产品名称
            newData.Columns.Add("Batch");//周期
            newData.Columns.Add("Piece");//入库数量
            newData.Columns.Add("SalePrice");//成本价
            int HouseID = 0;
            string CargoDepart = string.Empty;
            for (int i = 0; i < data.Rows.Count; i++)
            {
                //验证Excel表格指定列是否缺少数据
                bool isContinue = false;
                for (int j = 0; j < data.Columns.Count; j++)
                {
                    if (j == 6)
                    {

                    }
                    else if (string.IsNullOrEmpty((data.Rows[i][j]).ToString()))
                    {
                        isContinue = true;
                        break;
                    }
                }
                if (isContinue)
                {
                    abnormalCount++;
                    msg += "第" + (i + 2) + "行数据有空值\r\n";
                    continue;
                }
                int houseID = 0;
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][0]).Trim()))
                {
                    if (!dicHouse.ContainsKey(Convert.ToString(data.Rows[i][0]).Trim()))
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行所属仓库不存在\r\n";
                        continue;
                    }
                    else
                    {
                        dicHouse.TryGetValue(Convert.ToString(data.Rows[i][0]).Trim(), out houseID);

                        HouseID = houseID;

                    }
                }
                //验证导入品牌是否在数据库中有效，无效则跳过
                CargoProductTypeEntity typeEntity = new CargoProductTypeEntity();
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][3]).Trim()))
                {
                    List<CargoProductTypeEntity> allSpesc = productBus.QueryProductType(new CargoProductTypeEntity { TypeName = Convert.ToString(data.Rows[i][3]).Trim(), ParentID = -1 });
                    if (allSpesc.Count <= 0)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据产品分类不存在\r\n";
                        continue;
                    }
                    else
                    {
                        typeEntity = allSpesc.Find(c => c.ParentName == Convert.ToString(data.Rows[i][2]).Trim());
                    }
                }
                CargoProductPriceEntity priceEntity = new CargoProductPriceEntity();
                CargoClientEntity clientEntity = new CargoClientEntity();
                //产品编码
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][4])))
                {
                    List<CargoProductPriceEntity> priceList = cargoPriceBus.QueryCargoProductPrice(new CargoProductPriceEntity { ProductCode = Convert.ToString(data.Rows[i][4]) });
                    if (priceList.Count <= 0)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据产品编码不存在\r\n";
                        continue;
                    }
                    else
                    {
                        priceEntity = priceList[0];
                    }

                }
                //客户编码
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][1])))
                {
                    clientEntity = clientBus.QueryCargoClient(Convert.ToInt32(data.Rows[i][1]), HouseID);
                    if (clientEntity.ClientID <= 0)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据客户编码不存在\r\n";
                        continue;
                    }
                }
                string batch = string.IsNullOrEmpty(Convert.ToString(data.Rows[i][6])) ? DateTime.Now.ToString("yyyyMMdd") : Convert.ToString(data.Rows[i][6]);

                string SQL = "HouseID =" + HouseID + " and PayClientNum = '" + Convert.ToInt32(data.Rows[i][1]) + "' and GoodsCode='" + Convert.ToString(data.Rows[i][4]).Trim() + "' and TypeID=" + typeEntity.TypeID;
                DataRow[] NewRows = newData.Select(SQL);
                DataRow drNew = newData.NewRow();
                if (NewRows.Count() <= 0)
                {
                    object[] objs = { HouseID, Convert.ToString(data.Rows[i][0]).Trim(), Convert.ToString(data.Rows[i][1]).Trim(), clientEntity.ClientShortName, typeEntity.TypeID, typeEntity.TypeName, typeEntity.ParentID, typeEntity.ParentName, Convert.ToString(data.Rows[i][4]).Trim(), priceEntity.ProductName, batch, Convert.ToInt32(data.Rows[i][6]), clientEntity.Discount * priceEntity.CostPriceStore };
                    drNew.ItemArray = objs;
                    newData.Rows.Add(drNew);
                }
                else
                {
                    for (int j = 0; j < NewRows.Length; j++)
                    {
                        DataRow drEmployee = NewRows[j];
                        drEmployee.BeginEdit();
                        drEmployee["Piece"] = Convert.ToInt32(NewRows[0][11]) + Convert.ToInt32(data.Rows[i][6]);
                        drEmployee.EndEdit();
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据出现重复已自动合并\r\n";
                    }
                }
                //ent.Add(new CargoContainerShowEntity
                //{
                //    HouseID = HouseID,
                //    HouseName = Convert.ToString(data.Rows[i][0]).Trim(),
                //    PayClientNum = Convert.ToInt32(data.Rows[i][1]),
                //    PayClientName = clientEntity.ClientShortName,
                //    TypeID = typeEntity.TypeID,
                //    TypeName = typeEntity.TypeName,
                //    TypeParentID = typeEntity.ParentID,
                //    TypeParentName = typeEntity.ParentName,
                //    GoodsCode = Convert.ToString(data.Rows[i][4]).Trim(),//产品编码
                //    ProductName = priceEntity.ProductName,
                //    Batch = string.IsNullOrEmpty(Convert.ToString(data.Rows[i][6])) ? DateTime.Now.ToString("yyyyMMdd") : Convert.ToString(data.Rows[i][5]),
                //    Piece = Convert.ToInt32(data.Rows[i][6]),
                //    SalePrice = clientEntity.Discount * priceEntity.CostPriceStore
                //});

            }
            if (newData.Rows.Count > 0)
            {
                for (int i = 0; i < newData.Rows.Count; i++)
                {
                    ent.Add(new CargoContainerShowEntity
                    {
                        HouseID = Convert.ToInt32(newData.Rows[i][0]),
                        HouseName = Convert.ToString(newData.Rows[i][1]).Trim(),
                        PayClientNum = Convert.ToInt32(newData.Rows[i][2]),
                        PayClientName = Convert.ToString(newData.Rows[i][3]).Trim(),
                        TypeID = Convert.ToInt32(newData.Rows[i][4]),
                        TypeName = Convert.ToString(newData.Rows[i][5]).Trim(),
                        TypeParentID = Convert.ToInt32(newData.Rows[i][6]),
                        TypeParentName = Convert.ToString(newData.Rows[i][7]).Trim(),
                        GoodsCode = Convert.ToString(newData.Rows[i][8]).Trim(),//产品编码
                        ProductName = Convert.ToString(newData.Rows[i][9]).Trim(),
                        Batch = Convert.ToString(newData.Rows[i][10]),
                        Piece = Convert.ToInt32(newData.Rows[i][11]),
                        SalePrice = Convert.ToDecimal(newData.Rows[i][12])
                    });
                }
            }
            //ent = ent.OrderBy(e => e.Specs).ToList();
            String json = JSON.Encode(ent);

            if (abnormalCount > 0)
            {
                import.Type = 1;
                import.Message = msg;
            }
            import.Result = true;
            import.Data = json;
            json = JSON.Encode(import);
            Response.Clear();
            Response.Write(json);
            Response.End();
        }
        /// <summary>
        /// 保存批量导入的数据
        /// </summary>
        public void SavePLAutoImportData()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoGtmcProOrderEntity> list = new List<CargoGtmcProOrderEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "批量开单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            try
            {
                int TotalPiece = 0; string ClientNum = string.Empty; string ClientName = string.Empty;
                CargoGtmcProOrderEntity cargoGtmcProOrderEntity = new CargoGtmcProOrderEntity();
                cargoGtmcProOrderEntity.OPID = UserInfor.LoginName;
                cargoGtmcProOrderEntity.OPName = UserInfor.UserName;
                cargoGtmcProOrderEntity.HouseID = UserInfor.HouseID;
                cargoGtmcProOrderEntity.OrderType = "0";
                cargoGtmcProOrderEntity.DepartTime = DateTime.Now;
                cargoGtmcProOrderEntity.TakeTime = DateTime.Now;
                cargoGtmcProOrderEntity.TakeNo = cargoGtmcProOrderEntity.GtmcNo = DateTime.Now.ToString("yyyyMMdd") + Common.GetRandomFourNumInt().ToString();
                List<CargoGtmcProOrderDetailEntity> orderDetail = new List<CargoGtmcProOrderDetailEntity>();
                foreach (Hashtable row in rows)
                {
                    orderDetail.Add(new CargoGtmcProOrderDetailEntity
                    {
                        GoodsCode = Convert.ToString(row["GoodsCode"]),
                        GoodsName = Convert.ToString(row["ProductName"]),
                        TypeID = Convert.ToInt32(row["TypeID"]),
                        Specs = "",
                        Cage = "",
                        TotalNum = 0,
                        Piece = Convert.ToInt32(row["Piece"]),
                        GtmcNo = cargoGtmcProOrderEntity.GtmcNo,
                        SourceCode = cargoGtmcProOrderEntity.SourceCode
                    });
                    TotalPiece += Convert.ToInt32(row["Piece"]);
                    ClientNum = Convert.ToString(row["PayClientNum"]);
                    ClientName = Convert.ToString(row["PayClientName"]);
                }
                cargoGtmcProOrderEntity.OrderStatus = "0";
                cargoGtmcProOrderEntity.SourceCode = ClientNum;
                cargoGtmcProOrderEntity.SourceName = ClientName;
                cargoGtmcProOrderEntity.Piece = TotalPiece;

                cargoGtmcProOrderEntity.orderDetail = orderDetail;

                list.Add(cargoGtmcProOrderEntity);
                if (msg.Result)
                {
                    if (list.Count > 0)
                    {
                        bus.SaveGTMCImportData(list, log);
                    }
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        public void QueryAutoPartOrderByID()
        {
            CargoGtmcProOrderDetailEntity queryEntity = new CargoGtmcProOrderDetailEntity();
            //查询条件
            string key = Request["TID"];
            if (string.IsNullOrEmpty(key)) { Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return; }
            queryEntity.TID = Convert.ToInt32(key);
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            List<CargoGtmcProOrderDetailEntity> list = bus.QueryGTMCOrderByID(queryEntity);
            //查询库存
            foreach (var o in list)
            {
                CargoInterfaceEntity qEntity = new CargoInterfaceEntity
                {
                    ProductName = "",
                    HouseID = UserInfor.HouseID,
                    GoodsCode = o.GoodsCode,
                    TypeID = o.TypeID,
                    Model = "",
                    Specs = "",// o.Specs,
                    Batch = "",
                    BatckWeek = 0,
                    ParentID = 0,
                    Figure = ""
                };
                o.Stock = inter.queryCargoStock(qEntity).Sum(c => c.StockNum);
                //int tn = inter.queryCargoStock(qEntity).Sum(c => c.StockNum);
                //o.Stock = inter.queryCargoStock(qEntity).Where(c => c.IsAddOrder.Equals("0")).Sum(c => c.StockNum);
                //o.NoStock = tn - o.Stock;
                //if (o.Piece > o.Stock)
                //{
                //    o.status = "1";
                //}
            }
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 保存开单
        /// </summary>
        public void SaveAutoPartImportData()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoOrderBus bus = new CargoOrderBus();
            CargoFactoryOrderBus factbus = new CargoFactoryOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "批量导入开单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            string TID = Convert.ToString(Request["TID"]);
            if (String.IsNullOrEmpty(TID)) return;
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoGtmcProOrderEntity gtmcOrder = factbus.QueryGtmcProOrderEntity(new CargoGtmcProOrderEntity { TID = Convert.ToInt32(TID) });
            if (!string.IsNullOrEmpty(gtmcOrder.OrderNo))
            {
                msg.Result = false;
                msg.Message = "该订单已开单，请刷新后保存";
                goto ErrEND;
            }
            List<CargoGtmcProOrderDetailEntity> list = gtmcOrder.orderDetail;
            CargoClientBus clientBus = new CargoClientBus();
            CargoHouseBus house = new CargoHouseBus();
            CargoPriceBus cargoPriceBus = new CargoPriceBus();
            //生成系统订单
            CargoOrderEntity ent = new CargoOrderEntity();
            List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            List<QyOrderUpdateGoodsEntity> goods = new List<QyOrderUpdateGoodsEntity>();
            int HouseID = UserInfor.HouseID;
            try
            {
                if (msg.Result)
                {
                    CargoClientEntity clientEntity = clientBus.QueryCargoClient(Convert.ToInt32(gtmcOrder.SourceCode), HouseID);
                    CargoHouseEntity houseEnt = house.QueryCargoHouseByID(HouseID);
                    #region 赋值
                    ent.HAwbNo = gtmcOrder.GtmcNo;//关联订单号
                    ent.LogisAwbNo = gtmcOrder.TakeNo;
                    ent.Dest = ent.Dep = houseEnt.DepCity;
                    ent.Piece = gtmcOrder.Piece;
                    ent.Weight = ent.Volume = ent.InsuranceFee = ent.TransitFee = ent.TransportFee = ent.DeliveryFee = ent.OtherFee = ent.TotalCharge = ent.Rebate = 0;
                    ent.HouseID = HouseID;
                    ent.CheckOutType = "";
                    ent.TrafficType = "0";// 内部订单
                    ent.DeliveryType = "0";//Convert.ToString(Request["DeliveryType"]);
                    ent.AcceptAddress = clientEntity.Address;
                    ent.AcceptPeople = clientEntity.Boss;
                    ent.AcceptUnit = clientEntity.ClientShortName;
                    ent.AcceptTelephone = clientEntity.Telephone;
                    ent.AcceptCellphone = clientEntity.Cellphone;
                    ent.ShopCode = clientEntity.ShopCode;
                    ent.CreateAwb = UserInfor.UserName;
                    ent.CreateAwbID = UserInfor.LoginName;
                    ent.CreateDate = DateTime.Now;// Convert.ToDateTime(Request["CreateDate"]);
                    ent.OP_ID = UserInfor.LoginName.Trim();
                    ent.ThrowGood = "0";
                    ent.IsPrintPrice = 0;
                    ent.TranHouse = "";
                    ent.PostponeShip = "0";
                    ent.LogisID = 0;
                    ent.ClientNum = ent.PayClientNum = clientEntity.ClientNum;
                    ent.PayClientName = clientEntity.ClientShortName;
                    ent.DeliverySettlement = null;
                    int OrderNum = 0;
                    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, "GF", out OrderNum); // Convert.ToString(Request["OrderNo"]);//生成最新顺序订单号
                                                                                                   //int RetryCount = 0;
                                                                                                   //while (OrderNoList.Contains(ent.OrderNo))
                                                                                                   //{
                                                                                                   //    RetryCount++;
                                                                                                   //    ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, "GF", out OrderNum, RetryCount);
                                                                                                   //}
                                                                                                   //OrderNoList.Add(ent.OrderNo);
                    ent.OrderNum = OrderNum;//最新订单顺序号

                    #endregion
                    int pieceSum = 0;
                    decimal chargeSum = 0.00M;
                    string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                    string oS = "1";
                    foreach (var o in list)
                    {
                        int piece = o.Piece;
                        CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                        {
                            ProductName = "",
                            HouseID = UserInfor.HouseID,
                            GoodsCode = o.GoodsCode,
                            TypeID = o.TypeID,
                            Model = "",
                            Specs = "",//o.Specs,
                            Batch = "",
                            LastMonth = 9,
                            BatckWeek = 0,
                            ParentID = 0,
                            Figure = ""
                        };
                        List<CargoInterfaceEntity> stockList = inter.queryCargoStock(queryEntity);
                        if (stockList.Count <= 0) { oS = "2"; continue; }
                        if (stockList.Sum(c => c.StockNum) < piece)
                        {
                            oS = "2";
                            //continue;
                            //msg.Result = false;
                            //msg.Message = "公司代码：" + o.SourceCode + "，品番：" + o.GoodsCode + "，背番：" + o.Specs + "出库仓库存为：" + stockList.Sum(c => c.StockNum).ToString();
                            //goto ErrEND;
                        }
                        //减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                        foreach (var it in stockList)
                        {
                            if (it.StockNum <= 0) { continue; }
                            CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                            cargo.OrderNo = ent.OrderNo;//订单号
                            cargo.OutCargoID = outID;
                            cargo.ContainerID = it.ContainerID;
                            cargo.TypeID = it.TypeID;
                            cargo.ProductID = it.ProductID;

                            cargo.ID = it.ContainerGoodsID;//库存表ID

                            cargo.HouseName = houseEnt.Name;
                            cargo.ProductName = it.ProductName;
                            cargo.Model = it.Model;
                            cargo.Specs = it.Specs;
                            cargo.Figure = it.Figure;
                            List<CargoProductPriceEntity> priceList = cargoPriceBus.QueryCargoProductPrice(new CargoProductPriceEntity { ProductCode = it.GoodsCode });
                            #region 减库存逻辑
                            if (piece < it.StockNum)
                            {
                                //部分出
                                entDest.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    ProductID = it.ProductID,
                                    HouseID = ent.HouseID,
                                    AreaID = it.AreaID,
                                    Piece = piece,
                                    ActSalePrice = clientEntity.Discount * priceList[0].CostPriceStore,
                                    ContainerCode = it.ContainerCode,
                                    OutCargoID = outID,
                                    OP_ID = log.UserID
                                });
                                cargo.Piece = piece;
                                cargo.InPiece = it.StockNum;

                                outHouseList.Add(cargo);
                                pieceSum += cargo.Piece;
                                chargeSum += cargo.Piece * clientEntity.Discount * priceList[0].CostPriceStore;
                                break;
                            }
                            if (piece.Equals(it.StockNum))
                            {
                                //要出库件数和第一条库存件数刚刚好，则就全部出
                                entDest.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    ProductID = it.ProductID,
                                    HouseID = ent.HouseID,
                                    AreaID = it.AreaID,
                                    Piece = piece,
                                    ActSalePrice = clientEntity.Discount * priceList[0].CostPriceStore,
                                    ContainerCode = it.ContainerCode,
                                    OutCargoID = outID,
                                    OP_ID = log.UserID
                                });
                                cargo.Piece = piece;
                                cargo.InPiece = it.StockNum;

                                outHouseList.Add(cargo);
                                pieceSum += cargo.Piece;
                                chargeSum += cargo.Piece * clientEntity.Discount * priceList[0].CostPriceStore;
                                break;
                            }
                            if (piece > it.StockNum)
                            {
                                //全部出
                                entDest.Add(new CargoOrderGoodsEntity
                                {
                                    OrderNo = ent.OrderNo,
                                    ProductID = it.ProductID,
                                    HouseID = ent.HouseID,
                                    AreaID = it.AreaID,
                                    Piece = it.StockNum,
                                    ActSalePrice = clientEntity.Discount * priceList[0].CostPriceStore,
                                    ContainerCode = it.ContainerCode,
                                    OutCargoID = outID,
                                    OP_ID = log.UserID
                                });
                                cargo.Piece = it.StockNum;
                                cargo.InPiece = it.StockNum;

                                outHouseList.Add(cargo);
                                pieceSum += cargo.Piece;
                                chargeSum += cargo.Piece * clientEntity.Discount * priceList[0].CostPriceStore;
                                piece = piece - it.StockNum;
                                continue;
                            }
                            #endregion
                        }
                    }
                    ent.Piece = pieceSum;
                    ent.OutHouseName = houseEnt.Name;
                    ent.TransportFee = chargeSum;
                    ent.TotalCharge = chargeSum;
                    ent.AwbStatus = "0";
                    ent.OrderType = "0";
                    ent.HouseID = HouseID;
                    ent.HouseName = houseEnt.Name;
                    ent.goodsList = entDest;
                    ent.ModifyPriceStatus = "0";
                    if (outHouseList.Count <= 0)
                    {
                        msg.Message = "订单库存不足"; msg.Result = false;
                    }
                    if (msg.Result)
                    {
                        //仓库同步缓存
                        foreach (CargoContainerShowEntity time in outHouseList)
                        {
                            CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                            //34 马牌  1 同步马牌  2 同步全部品牌
                            if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                            {
                                RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                            }
                        }

                        bus.AddOrderInfo(ent, outHouseList, log);
                        if (pieceSum < gtmcOrder.Piece)
                        {
                            oS = "2";
                            if (UserInfor.SpecialCreateAwb.Equals("0"))
                            {
                                msg.Result = false;
                                msg.Message = "缺货订单，请让仓库查找库存";
                                goto ErrEND;
                            }
                        }
                        gtmcOrder.OrderNo = ent.OrderNo;
                        gtmcOrder.OrderStatus = oS;
                        factbus.UpdateGtmcProOrderStatus(gtmcOrder);

                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }

        ErrEND:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }
        #endregion
        #region 补货单方法合集
        public void QueryRplOrder()
        {
            var queryParam = new CargoRplOrderParams
            {
                StartDate = Request.GetDateTime("StartDate"),
                EndDate = Request.GetDateTime("EndDate"),
                RplNo = Request.GetTrimmedString("RplNo"),
                Specs = Request.GetTrimmedString("Specs"),
                FromHouse = Request.GetInt("FromHouse"),
                HouseID = Request.GetInt("HouseID"),
                Status = Request.GetByte("Status"),
                UserName = Request.GetTrimmedString("ReqByName"),
                TypeID = Request.GetInt("TypeID"),
                TypeCate = Request.GetInt("TypeCate")
            };

            //分页
            int? pageIndex = Request.GetInt("page");
            int? pageSize = Request.GetInt("rows");

            queryParam.SetPage(pageIndex, pageSize);
            CargoOrderBus bus = new CargoOrderBus();
            var result = bus.QueryRplOrder(queryParam);


            List<CargoRplOrderDto> footlist = new List<CargoRplOrderDto>(){new CargoRplOrderDto
            {
                RplNo = "汇总：",
                Piece = result.Data.Sum(c => c.Piece)
            } 
            };
            Hashtable resHT = new Hashtable();
            resHT["rows"] = result.Data;
            resHT["total"] = result.DataTotal;
            resHT["footer"] = footlist;

            string resultjson = JSON.Encode(resHT);//result.ToJSON();
            Response.Clear();
            Response.Write(resultjson);
            Response.Flush();
        }
        public void QueryRplOrderGoods()
        {
            var queryEntity = new CargoRplOrderGoodsDto
            {
                RplID = Request.GetInt("RplID"),
            };

            //分页
            int? pageIndex = Request.GetInt("page");
            int? pageSize = Request.GetInt("rows");
            CargoRplOrderGoodsListDto filter = new CargoRplOrderGoodsListDto();
            filter.SetPage(pageIndex, pageSize);
            filter.QueryEntity = queryEntity;
            CargoOrderBus bus = new CargoOrderBus();
            var result = bus.QueryRplOrderGoods(filter);

            string resultjson = result.ToJSON();
            Response.Clear();
            Response.Write(resultjson);
            Response.Flush();
        }
        public void GetRplOrderExcel()
        {
            var queryParam = new CargoRplOrderParams
            {
                StartDate = Request.GetDateTime("StartDate"),
                EndDate = Request.GetDateTime("EndDate"),
                RplNo = Request.GetTrimmedString("RplNo"),
                Specs = Request.GetTrimmedString("Specs"),
                FromHouse = Request.GetInt("FromHouse"),
                HouseID = Request.GetInt("HouseID"),
                Status = Request.GetByte("Status"),
                UserName = Request.GetTrimmedString("ReqByName"),
                TypeID = Request.GetInt("TypeID"),
                TypeCate = Request.GetInt("TypeCate")
            };

            //分页
            int? pageIndex = Request.GetInt("page");
            int? pageSize = Request.GetInt("rows");

            queryParam.SetPage(pageIndex, pageSize);
            CargoOrderBus bus = new CargoOrderBus();
            var excelData = bus.GetRplOrderExcel(queryParam);



            if (excelData.Count <= 0) { return; }

            string tname = string.Empty;
            DataTable table = new DataTable();
            table.Columns.AddRange(new DataColumn[]
            {
                new DataColumn ("序号", typeof(int)),
                new DataColumn("补货单号", typeof(string)),
                new DataColumn("缺货仓库", typeof(string)),
                new DataColumn("补货仓库", typeof(string)),

                new DataColumn("产品代码", typeof(string)),
                new DataColumn("产品名称", typeof(string)),
                new DataColumn("货品代码", typeof(string)),
                new DataColumn("品牌", typeof(string)),
                new DataColumn("规格", typeof(string)),
                new DataColumn("花纹", typeof(string)),
                new DataColumn("载速", typeof(string)),
                new DataColumn("缺货数量", typeof(int)),
                new DataColumn("完成数量", typeof(int)),

                new DataColumn("总单缺货数量", typeof(int)),
                new DataColumn("总单补货数量", typeof(int)),
                new DataColumn("开单人", typeof(string)),
                new DataColumn("补货单状态", typeof(string)),
                new DataColumn("备注", typeof(string)),
                new DataColumn("开单时间", typeof(string))
            });


            int i = 0;
            foreach (var it in excelData)
            {
                i++;
                DataRow newRows = table.NewRow();

                newRows["序号"] = i;
                newRows["补货单号"] = it.RplNo;
                newRows["缺货仓库"] = it.FromHouseName;
                newRows["补货仓库"] = it.HouseName;
                newRows["产品代码"] = it.ProductCode;
                newRows["产品名称"] = it.ProductName;
                newRows["货品代码"] = it.Figure;
                newRows["品牌"] = it.TypeName;
                newRows["规格"] = it.Specs;
                newRows["花纹"] = it.Figure;
                newRows["载速"] = it.LISS;
                newRows["缺货数量"] = it.Piece;
                newRows["移库数量"] = it.ShippedPiece;
                newRows["到货数量"] = it.ReceivedPiece;

                newRows["总单缺货数量"] = it.TotalPiece;
                newRows["总单移库数量"] = it.TotalShippedPiece;
                newRows["总单到货数量"] = it.TotalReceivedPiece;
                newRows["开单人"] = it.UserName;
                newRows["备注"] = it.Remark;
                newRows["开单时间"] = it.CreateDate.ToString("yyyy-MM-dd");


                switch (it.Status)
                {
                    case 0:
                        newRows["补货单状态"] = "已开单";
                        break;
                    case 1:
                        newRows["补货单状态"] = "补货中";
                        break;
                    case 2:
                        newRows["补货单状态"] = "已完成";
                        break;
                    default:
                        newRows["补货单状态"] = "";
                        break;
                }
                table.Rows.Add(newRows);
            }
            ToExcel.DataTableToExcel(table, "", "补货单数据表"+DateTime.Now.ToString("yyMMddHHmmss"));

        }


        public void GetOOSExcel()
        {
            var userid = UserInfor?.LoginName?.Trim();
            var username = UserInfor?.UserName;
            var ipaddress = Common.GetUserIP(Request);
            CargoOrderBus bus = new CargoOrderBus(userid, username, ipaddress);

            CargoOutOfStockParams oosParams = new CargoOutOfStockParams()
            {
                TypeID = Request.GetInt("TypeID"),
                TypeCate = Request.GetInt("TypeCate"),
                HouseID = Request.GetInt("HouseID"),
                AreaID = Request.GetInt("AreaID"),
                ParentHouse = Request.GetInt("ParentHouse"),
                Specs = Request.GetString("Specs"),
                Figure = Request.GetString("Figure"),
                OOSStatus = Request.GetByte("OOSStatus")
            };
            oosParams.PageSize = 0;
            oosParams.PageIndex = 0;
            var result = bus.QueryOutOfStocks(oosParams);
            if (result.Data.Count <= 0) { return; }


            string tname = string.Empty;
            DataTable table = new DataTable();
            table.Columns.AddRange(new DataColumn[]
            {
                new DataColumn("序号", typeof(int)),
                new DataColumn("产品代码", typeof(string)),
                new DataColumn("产品名称", typeof(string)),
                new DataColumn("品牌", typeof(string)),
                new DataColumn("规格", typeof(string)),
                new DataColumn("型号", typeof(string)),
                new DataColumn("花纹", typeof(string)),
                new DataColumn("载速", typeof(string)),
                new DataColumn("批次", typeof(string)),

                new DataColumn("月均销量", typeof(int)),
                new DataColumn("库存度天数", typeof(int)),
                new DataColumn("最小库存度天数", typeof(int)),
                new DataColumn("最大库存度天数", typeof(int)),
                new DataColumn("最小库存数", typeof(int)),
                new DataColumn("最大库存数", typeof(int)),
                new DataColumn("在库数量", typeof(int)),
                new DataColumn("在途数量", typeof(int)),
                new DataColumn("推荐补货数", typeof(int)),

                new DataColumn("清单状态", typeof(string)),
                new DataColumn("所在仓库", typeof(string)),
                new DataColumn("上级仓库", typeof(string)),
                new DataColumn("更新时间", typeof(string)),
                new DataColumn("补货时间", typeof(string))
            });


            int i = 0;
            foreach (var it in result.Data)
            {
                i++;
                DataRow newRows = table.NewRow();

                newRows["序号"] = i;
                newRows["产品代码"] = it.ProductCode;
                newRows["产品名称"] = it.ProductName;
                newRows["品牌"] = it.TypeName;
                newRows["规格"] = it.Specs;
                newRows["型号"] = it.Model;
                newRows["花纹"] = it.Figure;
                newRows["载速"] = it.LoadIndex;
                newRows["批次"] = it.Batch;

                newRows["月均销量"] = it.AvgSaleNum;
                newRows["库存度天数"] = it.DOI;
                newRows["最小库存度天数"] = it.MinStockDay;
                newRows["最大库存度天数"] = it.MaxStockDay;
                newRows["最小库存数"] = it.MinStock;
                newRows["最大库存数"] = it.MaxStock;
                newRows["在库数量"] = it.CurStock;
                newRows["在途数量"] = it.InTransitStock;
                newRows["推荐补货数"] = it.Piece;

                newRows["清单状态"] = it.OOSStatus;
                newRows["所在仓库"] = it.HouseName;
                newRows["上级仓库"] = it.ParentHouseName;
                newRows["更新时间"] = it.UpdateDate?.ToString("yyyy-MM-dd");
                newRows["补货时间"] = it.LatestRplDate?.ToString("yyyy-MM-dd");

                switch (it.OOSStatus)
                {
                    case 0:
                        newRows["清单状态"] = "未采购";
                        break;
                    case 1:
                        newRows["清单状态"] = "已采购";
                        break;
                    case 2:
                        newRows["清单状态"] = "不采购";
                        break;
                    default:
                        newRows["补货单状态"] = "";
                        break;
                }
                table.Rows.Add(newRows);
            }

            ToExcel.DataTableToExcel(table, "", "缺货清单数据表" + DateTime.Now.ToString("yyMMddHHmmss"));
        }
        

        public void AddRplOrder()
        {
            var head = new CargoRplOrderDtlDto
            {
                HouseID = Request.GetInt("HouseID"),
                Remark = Request.GetString("Remark"),
                LogisticID = Request.GetInt("LogisticID"),
                LogisticName = Request.GetString("LogisticName"),
            };
            var rows = Request.GetDataByJson<List<CargoRplOrderGoodsDto>>("Rows");
            head.Rows = rows;
            var userid = UserInfor?.LoginName?.Trim();
            var username = UserInfor?.UserName;
            var ipaddress = Common.GetUserIP(Request);
            CargoOrderBus bus = new CargoOrderBus(userid, username, ipaddress);
            var result = bus.AddRplOrder(head);
            string resultjson = JSON.Encode(result);

            Response.Clear();
            Response.Write(resultjson);
            Response.Flush();
        }
        public void CancelRplOrder()
        {
            int[] RplIDs = Array.Empty<int>();

            RplIDs = Request.GetDataByJson<int[]>("RplIDs");
            if (RplIDs == null || !RplIDs.Any())
            {
                Response.Clear();
                Response.Write("未传入数据");
                Response.Flush();
            }

            var userid = UserInfor?.LoginName?.Trim();
            var username = UserInfor?.UserName;
            var ipaddress = Common.GetUserIP(Request);
            CargoOrderBus bus = new CargoOrderBus(userid, username, ipaddress);
            bool isSucc = bus.CancelRplOrder(RplIDs);
            DataRespsBase<int[]> resps = new DataRespsBase<int[]>();
            resps.Success = isSucc;
            resps.Data = RplIDs;
            resps.Message = isSucc ? "作废成功" : "作废失败";
            var rsltJson = JSON.Encode(resps);
            Response.Clear();
            Response.Write(rsltJson);
            Response.Flush();
        }
        public void QueryOutOfStocks()
        {
            var userid = UserInfor?.LoginName?.Trim();
            var username = UserInfor?.UserName;
            var ipaddress = Common.GetUserIP(Request);
            CargoOrderBus bus = new CargoOrderBus(userid, username, ipaddress);

            CargoOutOfStockParams oosParams = new CargoOutOfStockParams()
            {
                TypeID = Request.GetInt("TypeID"),
                TypeCate = Request.GetInt("TypeCate"),
                HouseID = Request.GetInt("HouseID"),
                AreaID = Request.GetInt("AreaID"),
                ParentHouse = Request.GetInt("ParentHouse"),
                Specs = Request.GetString("Specs"),
                Figure = Request.GetString("Figure"),
                OOSStatus = Request.GetByte("OOSStatus")
            };

            oosParams.PageSize = Request.GetInt("rows").GetValueOrDefault();
            oosParams.PageIndex = Request.GetInt("page").GetValueOrDefault();
            var result =  bus.QueryOutOfStocks(oosParams);


            Hashtable resHT = new Hashtable();
            resHT["rows"] = result.Data;
            resHT["total"] = result.DataTotal;

            string resultjson = JSON.Encode(resHT);
            Response.Clear();
            Response.Write(resultjson);
            Response.Flush();
        }
        public void UpdtOOSByHouse()
        {
            int? HouseID = HouseID = Request.GetInt("HouseID");


            var userid = UserInfor?.LoginName?.Trim();
            var username = UserInfor?.UserName;
            var ipaddress = Common.GetUserIP(Request);
            CargoOrderBus bus = new CargoOrderBus(userid, username, ipaddress);
            var result = bus.UpdtOOSByHouse(HouseID);
            string resultjson = JSON.Encode(result);

            Response.Clear();
            Response.Write(resultjson);
            Response.Flush();
        }
        #endregion

        #region 
        public void QueryBatchImportOrderData()
        {
            CargoGtmcProOrderEntity queryEntity = new CargoGtmcProOrderEntity();

            queryEntity.GtmcNo = Convert.ToString(Request["GtmcNo"]);
            queryEntity.SourceCode = Convert.ToString(Request["SourceCode"]);
            queryEntity.SourceName = Convert.ToString(Request["SourceName"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"])))
            {
                queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"])))
            {
                queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]);
            }
            queryEntity.StockType = Convert.ToInt32(Request["StockType"]);
            queryEntity.OrderStatus = Convert.ToString(Request["OrderStatus"]);
            queryEntity.AwbStatus = Convert.ToString(Request["AwbStatus"]);
            queryEntity.OPName = Convert.ToString(Request["OPName"]);
            queryEntity.OrderType = "10";
            //queryEntity.HouseID = UserInfor.HouseID;
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            //else
            //{
            //    queryEntity.CargoPermisID = UserInfor.CargoPermisID;//所属仓库ID
            //}
            if (!string.IsNullOrEmpty(Convert.ToString(Request["LineID"])))
            {
                queryEntity.LineID = Convert.ToInt32(Request["LineID"]);
            }

            if (Convert.ToString(Request["OrderHandleType"]) != "-1")
            {
                queryEntity.OrderHandleType = Convert.ToString(Request["OrderHandleType"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["BusinessName"])))
            {
                queryEntity.BusinessName = Convert.ToString(Request["BusinessName"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["OrderAlloType"])))
            {
                queryEntity.OrderAlloType = Convert.ToString(Request["OrderAlloType"]);
            }            //分页
            int pageIndex = Convert.ToInt32(Request["page"]).Equals(0) ? 1 : Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]).Equals(0) ? 10000 : Convert.ToInt32(Request["rows"]);
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            Hashtable list = bus.QueryBatchImportOrderData(pageIndex, pageSize, queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void QueryBatchImportOrderDataExport()
        {
            CargoGtmcProOrderEntity queryEntity = new CargoGtmcProOrderEntity();

            queryEntity.GtmcNo = Convert.ToString(Request["GtmcNo"]);
            queryEntity.SourceCode = Convert.ToString(Request["SourceCode"]);
            queryEntity.SourceName = Convert.ToString(Request["SourceName"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"])))
            {
                queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"])))
            {
                queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]);
            }
            queryEntity.StockType = Convert.ToInt32(Request["StockType"]);
            queryEntity.OrderStatus = Convert.ToString(Request["OrderStatus"]);
            queryEntity.AwbStatus = Convert.ToString(Request["AwbStatus"]);
            queryEntity.OPName = Convert.ToString(Request["OPName"]);
            queryEntity.OrderType = "10";
            //queryEntity.HouseID = UserInfor.HouseID;
            if (!string.IsNullOrEmpty(Request["HouseID"]) && Request["HouseID"] != "undefined")//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//所属仓库ID
            }
            queryEntity.LastMonth = 9;
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            Hashtable list = bus.QueryBatchImportOrderData(1, 10000, queryEntity);
            if (list != null) { QueryBatchImportOrderDataList = list; }

            //JSON
            String json = JSON.Encode("OK");
            Response.Clear();
            Response.Write(json);
        }
        public Hashtable QueryBatchImportOrderDataList
        {
            get
            {
                if (Session["QueryBatchImportOrderDataList"] == null)
                {
                    Session["QueryBatchImportOrderDataList"] = new Hashtable();
                }
                return (Hashtable)(Session["QueryBatchImportOrderDataList"]);
            }
            set
            {
                Session["QueryBatchImportOrderDataList"] = value;
            }
        }
        public void batchImportOrder()
        {
            System.Web.HttpFileCollection files = this.Request.Files;
            if (files == null || files.Count == 0) return;
            string attachmentId = Guid.NewGuid().ToString();
            DataTable data = ToExcel.ImportExcelData(files);

            CargoImportEntity import = new CargoImportEntity();
            import.Result = true;
            import.Data = "";
            import.Message = "";
            import.Type = 0;
            import.ExistCount = 0;
            string msg = "";

            List<CargoGtmcProOrderDetailEntity> ent = new List<CargoGtmcProOrderDetailEntity>();
            CargoProductBasicPriceBus bus = new CargoProductBasicPriceBus();
            CargoPriceBus cargoPriceBus = new CargoPriceBus();
            //验证上传excel文件列数是否有效
            if (data.Columns.Count != 7)
            {
                import.Result = false;
                import.Type = 1;
                import.Message = "模板有误或缺少列，请重新下载模板";
                String abnormalJson = JSON.Encode(import);
                Response.Clear();
                Response.Write(abnormalJson);
                Response.End();
                return;
            }
            //清空table中的空行
            removeEmpty(data);
            if (data.Rows.Count <= 0)
            {
                import.Result = false;
                import.Type = 1;
                import.Message = "Excel无有效数据，请检查导入数据";
                String abnormalJson = JSON.Encode(import);
                Response.Clear();
                Response.Write(abnormalJson);
                Response.End();
                return;
            }
            CargoHouseBus house = new CargoHouseBus();
            CargoClientBus clientBus = new CargoClientBus();
            int abnormalCount = 0;

            DataTable newData = new DataTable();
            newData.Columns.Add("SourceCode");
            newData.Columns.Add("SourceName");
            newData.Columns.Add("GtmcNo");
            newData.Columns.Add("GoodsCode");
            newData.Columns.Add("Piece");
            newData.Columns.Add("Memo");
            newData.Columns.Add("BusinessName");
            for (int i = 0; i < data.Rows.Count; i++)
            {
                //验证Excel表格指定列是否缺少数据
                bool isContinue = false;
                for (int j = 0; j < data.Columns.Count; j++)
                {
                    if (j == 5)
                    {
                        continue;
                    }
                    if (string.IsNullOrEmpty((data.Rows[i][j]).ToString()))
                    {
                        isContinue = true;
                        break;
                    }
                }
                if (isContinue)
                {
                    abnormalCount++;
                    msg += "第" + (i + 2) + "行数据有空值\r\n";
                    continue;
                }
                CargoProductEntity priceEntity = new CargoProductEntity();
                CargoClientEntity clientEntity = new CargoClientEntity();

                //产品编码
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][3])))
                {
                    List<CargoProductEntity> priceList = house.QueryALLProductData(new CargoProductEntity { C_GoodsCode = Convert.ToString(data.Rows[i][3]) });
                    if (priceList.Count <= 0)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据产品编码不存在\r\n";
                        continue;
                    }
                    else
                    {
                        priceEntity = priceList[0];
                    }

                }
                //客户编码
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][0])))
                {
                    clientEntity = clientBus.QueryCargoClient(new CargoClientEntity { ShopCode = Convert.ToString(data.Rows[i][0]) });
                    if (clientEntity.ClientID <= 0)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据客户编码不存在\r\n";
                        continue;
                    }
                }

                //业务编码
                if (!string.IsNullOrEmpty(Convert.ToString(data.Rows[i][6])))
                {
                    List<CargoUpClientEntity> clientUpEntity = clientBus.QueryUpClientDep(new CargoUpClientEntity { DepName = Convert.ToString(data.Rows[i][6]) });
                    if (clientUpEntity.Count() <= 0)
                    {
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据业务名称不存在\r\n";
                        continue;
                    }
                }

                //店代码、货品代码、发票号码相同的情况下不可重复导入
                CargoFactoryOrderBus factbus = new CargoFactoryOrderBus();
                if (factbus.IsExistGtmcOrder(new CargoGtmcProOrderEntity { SourceCode = Convert.ToString(data.Rows[i][0]), GtmcNo = Convert.ToString(data.Rows[i][2]), GoodsCode = Convert.ToString(data.Rows[i][3]) }))
                {
                    abnormalCount++;
                    msg += "第" + (i + 2) + "行数据店代码、货品代码、发票号码数据重复，不可导入\r\n";
                    continue;
                }


                string SQL = " SourceCode = '" + Convert.ToString(data.Rows[i][0]) + "' and GoodsCode = '" + Convert.ToString(data.Rows[i][3]) + "'";
                DataRow[] NewRows = newData.Select(SQL);
                DataRow drNew = newData.NewRow();

                if (NewRows.Count() <= 0)
                {
                    object[] objs = {
                        Convert.ToString(data.Rows[i][0]).Trim(),
                        Convert.ToString(data.Rows[i][1]).Trim(),
                        Convert.ToString(data.Rows[i][2]).Trim(),
                        Convert.ToString(data.Rows[i][3]).Trim(),
                        Convert.ToString(data.Rows[i][4]).Trim(),
                        Convert.ToString(data.Rows[i][5]).Trim(),
                        Convert.ToString(data.Rows[i][6]).Trim(),
                    };
                    drNew.ItemArray = objs;
                    newData.Rows.Add(drNew);
                }
                else
                {
                    for (int j = 0; j < NewRows.Length; j++)
                    {
                        DataRow drEmployee = NewRows[j];
                        drEmployee.BeginEdit();
                        drEmployee["Piece"] = Convert.ToInt32(NewRows[0][4]) + Convert.ToInt32(data.Rows[i][4]);
                        drEmployee["GtmcNo"] = Convert.ToString(NewRows[0][2]) + "," + Convert.ToString(data.Rows[i][2]);
                        drEmployee.EndEdit();
                        abnormalCount++;
                        msg += "第" + (i + 2) + "行数据出现重复已自动合并\r\n";
                    }
                }

            }
            if (newData.Rows.Count > 0)
            {
                for (int i = 0; i < newData.Rows.Count; i++)
                {
                    ent.Add(new CargoGtmcProOrderDetailEntity
                    {
                        SourceCode = Convert.ToString(newData.Rows[i][0]).Trim(),
                        SourceName = Convert.ToString(newData.Rows[i][1]).Trim(),
                        GtmcNo = Convert.ToString(newData.Rows[i][2]).Trim(),
                        GoodsCode = Convert.ToString(newData.Rows[i][3]).Trim(),
                        Piece = Convert.ToInt32(newData.Rows[i][4]),
                        Memo = Convert.ToString(newData.Rows[i][5]),
                        BusinessName = Convert.ToString(newData.Rows[i][6]),
                    });
                }
            }
            //ent = ent.OrderBy(e => e.Specs).ToList();
            String json = JSON.Encode(ent);

            if (abnormalCount > 0)
            {
                import.Type = 1;
                import.Message = msg;
            }
            import.Result = true;
            import.Data = json;
            json = JSON.Encode(import);
            Response.Clear();
            Response.Write(json);
            Response.End();
        }

        /// <summary>
        /// 保存批量导入的数据
        /// </summary>
        public void SavebatchImportOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoGtmcProOrderEntity> list = new List<CargoGtmcProOrderEntity>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "批量开单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            CargoClientBus clientBus = new CargoClientBus();
            try
            {
                foreach (Hashtable row in rows)
                {
                    CargoGtmcProOrderEntity entity = new CargoGtmcProOrderEntity();
                    entity.GtmcNo = Convert.ToString(row["GtmcNo"]);
                    entity.SourceCode = Convert.ToString(row["SourceCode"]);
                    entity.SourceName = Convert.ToString(row["SourceName"]);
                    entity.Memo = Convert.ToString(row["Memo"]);
                    entity.DepartTime = DateTime.Now;
                    entity.TakeTime = DateTime.Now;
                    entity.OrderStatus = "0";
                    entity.HouseID = 65;//UserInfor.HouseID;
                    entity.OPID = UserInfor.LoginName;
                    entity.OPName = UserInfor.UserName;
                    entity.Piece = Convert.ToInt32(row["Piece"]);
                    entity.OrderType = "10";
                    entity.BusinessName = Convert.ToString(row["BusinessName"]);
                    entity.BusinessID = clientBus.QueryUpClientDep(new CargoUpClientEntity { DepName = Convert.ToString(row["BusinessName"]) }).FirstOrDefault().ID.ToString();
                    entity.orderDetail = new List<CargoGtmcProOrderDetailEntity>() { new CargoGtmcProOrderDetailEntity { GoodsCode = Convert.ToString(row["GoodsCode"]), Piece = Convert.ToInt32(row["Piece"]) } };
                    list.Add(entity);
                }
                if (msg.Result)
                {
                    if (list.Count > 0)
                    {
                        bus.SaveGTMCImportData(list, log);
                    }
                    msg.Message = "成功";
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        public void DelBatchImportOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoGtmcProOrderEntity> list = new List<CargoGtmcProOrderEntity>();
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "批量开单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoGtmcProOrderEntity
                    {
                        TID = Convert.ToInt32(row["TID"]),
                        SourceCode = Convert.ToString(row["SourceCode"]),
                        SourceName = Convert.ToString(row["SourceName"]),
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        ExterOrderAlloNum = Convert.ToInt32(row["ExterOrderAlloNum"]),
                    });
                }
                bus.DelBatchImportOrder(list, log);

                //修改清单数量
                CargoOrderBus orderBus = new CargoOrderBus();
                foreach (CargoGtmcProOrderEntity time in list)
                {
                    if (time.ExterOrderAlloNum > 0)
                    {
                        orderBus.UpdateExterOrderAllo(new CargoExterOrderAlloEntity
                        {
                            AlloPiece = -1,
                            OPLoginName = UserInfor.LoginName.Trim(),
                            OPName = UserInfor.UserName.Trim(),
                            ExterOrderAlloNum = time.ExterOrderAlloNum
                        });
                    }
                }

                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 保存开单
        /// </summary>
        public void SaveBatchImportOrderData()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "批量开单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            try
            {
                CargoOrderBus bus = new CargoOrderBus();
                CargoHouseBus house = new CargoHouseBus();
                CargoClientBus clientBus = new CargoClientBus();
                CargoInterfaceBus inter = new CargoInterfaceBus();
                CargoFactoryOrderBus factbus = new CargoFactoryOrderBus();
                CargoProductBus product = new CargoProductBus();
                Dictionary<string, List<CargoGtmcProOrderEntity>> listDic = new Dictionary<string, List<CargoGtmcProOrderEntity>>();

                //List<CargoUpClientEntity> clientUpEntityList = clientBus.QueryUpClientDep(new CargoUpClientEntity { });

                foreach (Hashtable row in rows)
                {
                    //SourceCode：店代码，GtmcNo：发票号，GoodsCode：货品代码 
                    if (factbus.QueryBatchImportOrderType(new CargoGtmcProOrderEntity { HouseID = Convert.ToInt32(row["HouseID"]), SourceCode = Convert.ToString(row["SourceCode"]), GtmcNo = Convert.ToString(row["GtmcNo"]), GoodsCode = Convert.ToString(row["GoodsCode"]) }))
                    {
                        msg.Result = false;
                        msg.Message = "选中数据中有已开单数据";
                        goto ErrEND;
                    }
                    //查询业务ID
                    // CargoUpClientEntity clientUpEntity = clientBus.QueryUpClientDep(new CargoUpClientEntity { DepName = Convert.ToString(row["BusinessName"]) }).FirstOrDefault();
                    string BusinessID = Convert.ToString(row["BusinessID"]);
                    if (listDic.ContainsKey(Convert.ToString(row["SourceCode"])))
                    {
                        listDic.TryGetValue(Convert.ToString(row["SourceCode"]), out List<CargoGtmcProOrderEntity> orderList);
                        listDic.Remove(Convert.ToString(row["SourceCode"]));
                        bool type = true;
                        foreach (CargoGtmcProOrderEntity item in orderList)
                        {
                            if (item.GoodsCode.Equals(Convert.ToString(row["GoodsCode"])))
                            {
                                type = false;
                                item.ID = item.ID + "," + Convert.ToString(row["TID"]);
                                item.GtmcNo = (item.GtmcNo + "," + Convert.ToString(row["GtmcNo"]).Replace(item.GtmcNo, "")).Replace(",,", ",");
                                item.Piece = item.Piece + Convert.ToInt32(row["Piece"]);
                            }
                        }
                        if (type)
                        {
                            CargoGtmcProOrderEntity orderEntity = new CargoGtmcProOrderEntity();
                            orderEntity.SourceCode = Convert.ToString(row["SourceCode"]);
                            orderEntity.GoodsCode = Convert.ToString(row["GoodsCode"]);
                            orderEntity.HouseID = Convert.ToInt32(row["HouseID"]);
                            orderEntity.TID = Convert.ToInt64(row["TID"]);
                            orderEntity.ID = Convert.ToString(row["TID"]);
                            orderEntity.GtmcNo = Convert.ToString(row["GtmcNo"]);
                            orderEntity.Piece = Convert.ToInt32(row["Piece"]);
                            orderEntity.ProductCode = Convert.ToString(row["ProductCode"]);
                            orderEntity.Memo = Convert.ToString(row["Memo"]);
                            orderEntity.BusinessID = BusinessID;
                            orderEntity.TypeName = Convert.ToString(row["TypeName"]);
                            orderList.Add(orderEntity);
                        }
                        listDic.Add(Convert.ToString(row["SourceCode"]), orderList);
                    }
                    else
                    {
                        CargoGtmcProOrderEntity orderEntity = new CargoGtmcProOrderEntity();
                        orderEntity.SourceCode = Convert.ToString(row["SourceCode"]);
                        orderEntity.GtmcNo = Convert.ToString(row["GtmcNo"]);
                        orderEntity.Piece = Convert.ToInt32(row["Piece"]);
                        orderEntity.GoodsCode = Convert.ToString(row["GoodsCode"]);
                        orderEntity.TID = Convert.ToInt64(row["TID"]);
                        orderEntity.ID = Convert.ToString(row["TID"]);
                        orderEntity.HouseID = Convert.ToInt32(row["HouseID"]);
                        orderEntity.ProductCode = Convert.ToString(row["ProductCode"]);
                        orderEntity.Memo = Convert.ToString(row["Memo"]);
                        orderEntity.BusinessID = BusinessID;
                        orderEntity.TypeName = Convert.ToString(row["TypeName"]);
                        listDic.Add(Convert.ToString(row["SourceCode"]), new List<CargoGtmcProOrderEntity> { orderEntity });
                    }
                }
                string message = string.Empty;
                string HAwbNo = string.Empty;

                foreach (var item in listDic)
                {
                    //1.循环每一个客户代码
                    CargoHouseEntity houseEnt = house.QueryCargoHouseByID(listDic[item.Key][0].HouseID);
                    string HouseIDStr = houseEnt.HouseID.ToString() + ",65";
                    CargoClientEntity clientEntity = clientBus.QueryCargoClient(new CargoClientEntity { ShopCode = item.Key, HouseIDStr = HouseIDStr });
                    if (clientEntity.LogisLineLogisID.Equals(0))
                    {
                        message += "客户" + item.Key + "未绑定线路\r\n";
                        continue;
                    }
                    //2024-05-23 根据客户编码查询该客户的出库顺序仓库
                    //CargoAreaEntity careaEnt = new CargoAreaEntity();
                    List<CargoAreaEntity> areaEntities = house.QueryOutHouseLevelList(new CargoAreaEntity { ClientNum = clientEntity.ClientNum });
                    //List<CargoAreaEntity> areaEntities = house.QueryOutHouseLevelList(new CargoAreaEntity { HouseID = houseEnt.HouseID, ClientNum = clientEntity.ClientNum });
                    if (areaEntities.Count <= 0)
                    {
                        CargoAreaEntity areaEntity = house.QueryHouseByDeliveryArea(new CargoAreaEntity { HouseID = houseEnt.HouseID, DeliveryArea = clientEntity.City });
                        if (areaEntity.AreaID.Equals(0))
                        {
                            message += "客户" + item.Key + "城市无配送区域\r\n";
                            continue;
                        }
                        CargoAreaEntity careaEnt = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = areaEntity.AreaID });
                        areaEntities.Add(careaEnt);
                    }
                    string HouseCode = houseEnt.HouseCode;
                    string OrderDep = houseEnt.DepCity;

                    //确定有库存的仓库，以仓库AreaID为键，货品列表为值
                    Dictionary<int, List<CargoGtmcProOrderEntity>> outHouseDic = new Dictionary<int, List<CargoGtmcProOrderEntity>>();
                    // 已处理的商品规格集合
                    HashSet<string> processedSpecifications = new HashSet<string>();
                    //20240525 轮询仓库判断每个商品的库存情况，找到同时满足每个商品都有库存的仓库
                    //20250123 修改为，先查询一级仓库是否满足库存，满足则开单，再查询二级仓库是否满足库存，满足则开单，否则异常
                    //先根据货品代码第一要素查询库存是否满足，库存不够，查询共享编码的库存
                    int tID = 0;
                    foreach (var houid in areaEntities)
                    {
                        string faultMessage = "";
                        foreach (var gds in item.Value)
                        {
                            tID = Convert.ToInt32(gds.TID);
                            if (processedSpecifications.Contains(gds.GoodsCode)) { continue; }
                            //先根据货品代码第一要素查询库存是否满足，满足则直接跳出
                            List<CargoInterfaceEntity> stockList = inter.queryCargoStock(new CargoInterfaceEntity { ParentID = 1, HouseID = houid.HouseID, GoodsCode = gds.GoodsCode, AreaID = houid.AreaID, BatckWeek = 0, LastMonth = 9, SuppClientNumStr = "551098,130453,891524,542207" });
                            if (stockList.Sum(c => c.StockNum) >= gds.Piece)
                            {
                                if (!outHouseDic.ContainsKey(houid.AreaID))
                                {
                                    List<CargoGtmcProOrderEntity> gdsList = new List<CargoGtmcProOrderEntity>();
                                    gdsList.Add(gds);
                                    outHouseDic.Add(houid.AreaID, gdsList);
                                }
                                else
                                {
                                    outHouseDic[houid.AreaID].Add(gds);
                                }
                                processedSpecifications.Add(gds.GoodsCode);
                                continue;
                            }
                            //第一要素库存不够，查询共享编码的库存，满足则直接跳出
                            string ProductCodeStr = string.Empty;
                            List<CargoProductMappingEntity> mappingEntities = product.QueryProductShareCode(new CargoProductMappingEntity { CassCode = gds.GoodsCode });
                            if (mappingEntities.Count <= 0)
                            {
                                //共享库存也没有库存
                                faultMessage = gds.GoodsCode + "库存不足\r\n"; continue;
                                //message += gds.GoodsCode + "库存不足\r\n"; break;
                            }

                            foreach (var map in mappingEntities)
                            {
                                if (map.CassCode.Equals(gds.GoodsCode))
                                {
                                    if (!ProductCodeStr.Contains(map.ProductCode))
                                    {
                                        ProductCodeStr += map.ShareCode + "','";
                                    }
                                    continue;
                                }
                                if (ProductCodeStr.Contains(map.ProductCode))
                                {
                                    ProductCodeStr += map.ShareCode + "','";
                                }
                                else
                                {
                                    ProductCodeStr += map.ProductCode + "','";
                                }
                            }

                            if (!string.IsNullOrEmpty(ProductCodeStr))
                            {
                                ProductCodeStr = ProductCodeStr.Substring(0, ProductCodeStr.Length - 3);
                            }
                            if (string.IsNullOrEmpty(ProductCodeStr))
                            {
                                faultMessage = gds.GoodsCode + houid.HouseName + "共享库存也不足\r\n";
                                continue;
                            }
                            //查询共享库存
                            stockList = inter.queryCargoStock(new CargoInterfaceEntity { ParentID = 1, HouseID = houid.HouseID, ProductCodeStr = ProductCodeStr, AreaID = houid.AreaID, BatckWeek = 0, LastMonth = 9, SuppClientNumStr = "551098,130453,891524,542207" });

                            if (stockList.Sum(c => c.StockNum) >= gds.Piece)
                            {
                                gds.ProductCodeStr = ProductCodeStr;
                                if (!outHouseDic.ContainsKey(houid.AreaID))
                                {
                                    List<CargoGtmcProOrderEntity> gdsList = new List<CargoGtmcProOrderEntity>();
                                    gdsList.Add(gds);
                                    outHouseDic.Add(houid.AreaID, gdsList);
                                }
                                else
                                {
                                    outHouseDic[houid.AreaID].Add(gds);
                                }
                                processedSpecifications.Add(gds.GoodsCode);
                                faultMessage = "";
                                continue;
                            }
                            else
                            {
                                faultMessage = gds.GoodsCode + houid.HouseName + "共享库存也不足\r\n";
                                //当所有库存都不足时更改分配订单类型为外采

                                continue;
                            }
                        }

                        message += faultMessage;
                    }
                    //无库存信息--更新广丰订单的智能系统订单号--直接更改分配联系为外采
                    if (outHouseDic.Count == 0)
                    {
                        factbus.UpdateGtmcProOrderStatus(new CargoGtmcProOrderEntity { TID = tID, OrderStatus = "0", OrderAlloType = "2", OrderNo = "" });
                    }
                    //处理开单
                    if (outHouseDic.Count > 0)
                    {
                        foreach (var orderItem in outHouseDic)
                        {
                            //依次对仓库进行开单  开单实体赋值
                            CargoOrderEntity orderEnt = new CargoOrderEntity();
                            orderEnt.EnSafe();
                            orderEnt.ClientID = clientEntity.ClientID;
                            orderEnt.ClientNum = clientEntity.ClientNum;
                            orderEnt.AcceptUnit = clientEntity.ClientName;
                            orderEnt.AcceptAddress = clientEntity.Address;
                            orderEnt.AcceptPeople = clientEntity.Boss;
                            orderEnt.AcceptTelephone = clientEntity.Telephone;
                            orderEnt.AcceptCellphone = clientEntity.Cellphone;
                            orderEnt.PayClientNum = clientEntity.ClientNum;
                            orderEnt.PayClientName = clientEntity.ClientName;

                            orderEnt.LogisAwbNo = "";
                            orderEnt.LogisID = clientEntity.LogisLineLogisID;
                            orderEnt.Dest = clientEntity.City;
                            orderEnt.Weight = orderEnt.Volume = orderEnt.InsuranceFee = orderEnt.TransitFee = orderEnt.TransportFee = orderEnt.DeliveryFee = orderEnt.OtherFee = orderEnt.TotalCharge = orderEnt.Rebate = 0;
                            orderEnt.CheckOutType = "";
                            orderEnt.TrafficType = "0";
                            orderEnt.DeliveryType = "2";
                            orderEnt.CreateAwbID = UserInfor.LoginName;
                            orderEnt.CreateAwb = UserInfor.UserName;
                            orderEnt.CreateDate = DateTime.Now;
                            orderEnt.CheckStatus = "0";
                            orderEnt.SaleManID = clientEntity.UserID;
                            orderEnt.SaleManName = clientEntity.UserName;
                            orderEnt.LineID = clientEntity.LineID;
                            orderEnt.LineName = clientEntity.LineName;
                            orderEnt.HouseID = houseEnt.HouseID;
                            orderEnt.OP_ID = UserInfor.LoginName.Trim();
                            orderEnt.OP_DATE = DateTime.Now;
                            orderEnt.AwbStatus = "0";
                            orderEnt.OrderType = "0";//电脑开单
                            orderEnt.OrderModel = "0";//销售单
                            orderEnt.ThrowGood = "12";//OES客户单
                            orderEnt.BelongHouse = "0";
                            orderEnt.IsPrintPrice = 0;
                            orderEnt.PostponeShip = "0";
                            orderEnt.ModifyPriceStatus = "0";
                            orderEnt.ShopCode = item.Key;//店代码 
                            orderEnt.Remark = item.Key + " ";
                            string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                            CargoPriceBus cargoPriceBus = new CargoPriceBus();
                            List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
                            List<CargoOrderGoodsEntity> orderGoods = new List<CargoOrderGoodsEntity>();
                            int pieceSum = 0;
                            decimal trFee = 0.00M;
                            ArrayList tidList = new ArrayList();
                            int AID = orderItem.Key;//确定出库仓库ID
                            string houseName = "";//确定出库仓库ID
                            string memo = string.Empty;
                            string OrderAlloType = "0"; //分配订单类型  0：正常 1：跨仓 2：外采
                            foreach (var goods in orderItem.Value)
                            {
                                //业务ID
                                orderEnt.BusinessID = goods.BusinessID;
                                if (!string.IsNullOrEmpty(orderEnt.BusinessID))
                                {
                                    orderEnt.MarketType = clientBus.QueryBusinessIDDefault(new CargoUpClientEntity() { ID = Convert.ToInt32(orderEnt.BusinessID) }).FirstOrDefault().MarketType;
                                }
                                tidList.Add(goods.ID);
                                if (!orderEnt.HAwbNo.Contains(goods.GtmcNo))
                                {
                                    orderEnt.HAwbNo += goods.GtmcNo + ",";
                                }
                                memo = goods.Memo;
                                // List<CargoInterfaceEntity> stockList = new List<CargoInterfaceEntity>();
                                CargoAreaEntity arit = areaEntities.Find(c => c.AreaID.Equals(AID));
                                List<CargoInterfaceEntity> stockList = inter.queryCargoStock(new CargoInterfaceEntity { ParentID = 1, HouseID = arit.HouseID, GoodsCode = goods.GoodsCode, AreaID = AID, BatckWeek = 0, LastMonth = 9, SuppClientNumStr = "551098,130453,891524,542207" });

                                if (stockList.Sum(c => c.StockNum) < goods.Piece)
                                {
                                    stockList = inter.queryCargoStock(new CargoInterfaceEntity { ParentID = 1, HouseID = arit.HouseID, ProductCodeStr = goods.ProductCodeStr, AreaID = AID, BatckWeek = 0, LastMonth = 9, SuppClientNumStr = "551098,130453,891524,542207" });
                                }

                                if (string.IsNullOrEmpty(orderEnt.OrderNo))
                                {
                                    //2024-05-23这里生成订单号

                                    if (string.IsNullOrEmpty(arit.OrderCode) || string.IsNullOrEmpty(arit.OrderDep))
                                    {
                                        break;
                                    }

                                    HouseCode = arit.OrderCode;
                                    OrderDep = arit.OrderDep;
                                    if (string.IsNullOrEmpty(arit.OrderCode) || string.IsNullOrEmpty(arit.OrderDep))
                                    {
                                        houseName = arit.Name;
                                        break;
                                    }
                                    CargoAreaEntity areaTop = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = AID });
                                    orderEnt.LogisID = areaTop.LogisID;
                                    orderEnt.LogisticName = areaTop.LogisticName;
                                    orderEnt.OrderNo = Common.GetMaxOrderNumByCurrentDate(areaTop.HouseID, HouseCode, out int OrderNum);
                                    orderEnt.OrderNum = OrderNum;
                                    orderEnt.OutHouseName = arit.Name;
                                    orderEnt.Dep = OrderDep;
                                    orderEnt.HouseID = areaTop.HouseID;
                                    orderEnt.OrderType = "0";//areaTop.HouseID.Equals(65) || areaTop.HouseID.Equals(84) ? "0" : "4";//小程序订单
                                }

                                int piece = goods.Piece;
                                foreach (var it in stockList)
                                {
                                    if (it.StockNum <= 0) { continue; }

                                    //查询基础信息
                                    string proYear, proMonth;
                                    proYear = DateTime.Now.ToString("yyyy");
                                    proMonth = DateTime.Now.ToString("MM");
                                    if (proMonth.Substring(0, 1) == "0")
                                    {
                                        proMonth = DateTime.Now.ToString("MM").Substring(1, 1);
                                    }
                                    //proMonth = "5";
                                    CargoProductBasicPriceEntity basicPriceEntity = new CargoProductBasicPriceEntity();
                                    CargoProductBasicPriceEntity basicPrice = new CargoProductBasicPriceEntity();
                                    basicPriceEntity.HouseID = it.HouseID;
                                    basicPriceEntity.TypeID = it.TypeID;
                                    basicPriceEntity.GoodsCode = goods.GoodsCode; ;
                                    basicPriceEntity.Born = -1;
                                    basicPriceEntity.ProYear = proYear;
                                    basicPriceEntity.ProMonth = proMonth;
                                    basicPrice = house.QueryProductBasicPrice(basicPriceEntity);
                                    if (basicPrice != null && basicPrice.PID != 0 && basicPrice.OESalePrice > 0)
                                    {
                                        it.TradePrice = Convert.ToDecimal(basicPrice.OESalePrice);
                                    }

                                    CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                                    cargo.OrderNo = orderEnt.OrderNo;//订单号
                                    cargo.OutCargoID = outID;
                                    cargo.ContainerID = it.ContainerID;
                                    cargo.TypeID = it.TypeID;
                                    cargo.ProductID = it.ProductID;

                                    cargo.ID = it.ContainerGoodsID;//库存表ID

                                    cargo.HouseName = houseEnt.Name;
                                    cargo.ProductName = it.ProductName;
                                    cargo.Model = it.Model;
                                    cargo.Specs = it.Specs;
                                    cargo.Figure = it.Figure;
                                    orderEnt.SuppClientNum = orderEnt.HouseID.Equals(65) ? 0 : Convert.ToInt32(it.SuppClientNum);

                                    #region 减库存逻辑
                                    if (piece < it.StockNum)
                                    {
                                        //部分出
                                        orderGoods.Add(new CargoOrderGoodsEntity
                                        {
                                            OrderNo = orderEnt.OrderNo,
                                            ProductID = it.ProductID,
                                            HouseID = orderEnt.HouseID,
                                            AreaID = it.AreaID,
                                            Piece = piece,
                                            ActSalePrice = it.TradePrice,//20241108修改为门店价it.SalePrice,
                                            ContainerCode = it.ContainerCode,
                                            OutCargoID = outID,
                                            OP_ID = log.UserID,
                                            ShowGoodsCode = goods.GoodsCode,
                                            ShowProductCode = goods.ProductCode,
                                            ShowTypeName = goods.TypeName,
                                        });
                                        cargo.Piece = piece;
                                        cargo.InPiece = it.StockNum;

                                        outHouseList.Add(cargo);
                                        pieceSum += cargo.Piece;
                                        trFee += cargo.Piece * it.TradePrice;
                                        break;
                                    }
                                    if (piece.Equals(it.StockNum))
                                    {
                                        //要出库件数和第一条库存件数刚刚好，则就全部出
                                        orderGoods.Add(new CargoOrderGoodsEntity
                                        {
                                            OrderNo = orderEnt.OrderNo,
                                            ProductID = it.ProductID,
                                            HouseID = orderEnt.HouseID,
                                            AreaID = it.AreaID,
                                            Piece = piece,
                                            ActSalePrice = it.TradePrice,//20241108修改为门店价it.SalePrice,
                                            ContainerCode = it.ContainerCode,
                                            ShowGoodsCode = goods.GoodsCode,
                                            ShowProductCode = goods.ProductCode,
                                            ShowTypeName = goods.TypeName,
                                            OutCargoID = outID,
                                            OP_ID = log.UserID
                                        });
                                        cargo.Piece = piece;
                                        cargo.InPiece = it.StockNum;

                                        outHouseList.Add(cargo);
                                        pieceSum += cargo.Piece;
                                        trFee += cargo.Piece * it.TradePrice;
                                        break;
                                    }
                                    if (piece > it.StockNum)
                                    {
                                        //全部出
                                        orderGoods.Add(new CargoOrderGoodsEntity
                                        {
                                            OrderNo = orderEnt.OrderNo,
                                            ProductID = it.ProductID,
                                            HouseID = orderEnt.HouseID,
                                            AreaID = it.AreaID,
                                            Piece = it.StockNum,
                                            ActSalePrice = it.TradePrice,//20241108修改为门店价it.SalePrice,
                                            ContainerCode = it.ContainerCode,
                                            ShowGoodsCode = goods.GoodsCode,
                                            ShowProductCode = goods.ProductCode,
                                            ShowTypeName = goods.TypeName,
                                            OutCargoID = outID,
                                            OP_ID = log.UserID
                                        });
                                        cargo.Piece = it.StockNum;
                                        cargo.InPiece = it.StockNum;

                                        outHouseList.Add(cargo);
                                        pieceSum += cargo.Piece;
                                        trFee += cargo.Piece * it.TradePrice;
                                        piece = piece - it.StockNum;
                                        continue;
                                    }
                                    #endregion
                                }
                            }
                            if (string.IsNullOrEmpty(orderEnt.OrderNo))
                            {
                                message += $"发票号：{orderEnt.HAwbNo}仓库：{houseName}无订单代码或出发城市，不可开单";
                                continue;
                            }
                            orderEnt.Remark += memo;
                            orderEnt.goodsList = orderGoods;
                            orderEnt.Piece = pieceSum;
                            orderEnt.TransportFee = trFee;
                            orderEnt.TotalCharge = trFee;
                            //orderEnt.BusinessID = "0";
                            orderEnt.HAwbNo = orderEnt.HAwbNo.TrimEnd(',');

                            //仓库同步缓存
                            foreach (CargoContainerShowEntity time in outHouseList)
                            {
                                CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                                //34 马牌  1 同步马牌  2 同步全部品牌
                                if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                                {
                                    RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                                }
                                //主仓缓存更改
                                if (house.IsAddCaching(syncProduct.HouseID, time.TypeID))
                                {

                                    RedisHelper.HashSet("HCYCHouseStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                                }

                            }

                            bus.AddOrderInfo(orderEnt, outHouseList, log);
                            foreach (string tids in tidList)
                            {
                                string[] IDStr = tids.Split(',');
                                foreach (var tid in IDStr)
                                {
                                    factbus.UpdateGtmcProOrderStatus(new CargoGtmcProOrderEntity { TID = Convert.ToInt64(tid), OrderNo = orderEnt.OrderNo, OrderStatus = "1", AutoOrderHandleStatus = "1", OrderHandleType = "0", AutoOrderHandleTime = DateTime.Now, OrderAlloType = OrderAlloType });
                                }
                            }
                            if (orderEnt.HouseID.Equals(9))
                            {
                                //内部订单
                                bus.SaveHlyOrderData(outHouseList, orderEnt);
                            }
                            else
                            {
                                bus.InsertCargoOrderPush(new CargoOrderPushEntity
                                {
                                    OrderNo = orderEnt.OrderNo,
                                    Dep = orderEnt.Dep,
                                    Dest = orderEnt.Dest,
                                    Piece = orderEnt.Piece,
                                    TransportFee = orderEnt.TransportFee,
                                    ClientNum = orderEnt.ClientNum.ToString(),
                                    AcceptAddress = orderEnt.AcceptAddress,
                                    AcceptCellphone = orderEnt.AcceptCellphone,
                                    AcceptTelephone = orderEnt.AcceptTelephone,
                                    AcceptPeople = orderEnt.AcceptPeople,
                                    AcceptUnit = orderEnt.AcceptUnit,
                                    HouseID = orderEnt.HouseID.ToString(),
                                    HouseName = house.QueryCargoHouseByID(orderEnt.HouseID).Name,// orderEnt.HouseID.Equals(65) || orderEnt.HouseID.Equals(84) ? houseEnt.Name : orderEnt.OutHouseName,
                                    OP_ID = UserInfor.UserName,
                                    HLYSendUnit = orderEnt.HouseID.Equals(65) ? outHouseList[0].ProductName : outHouseList[0].ProductName,
                                    PushType = "0",
                                    PushStatus = "0",
                                    LogisID = orderEnt.LogisID
                                }, log);
                                msg.Result = true;
                            }
                        }
                    }
                }
                if (msg.Result)
                {
                    msg.Result = true;
                    msg.Message = "开单成功\r\n" + message;
                }
                else
                {
                    msg.Result = false;
                    msg.Message = message;
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }

        ErrEND:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }

        /// <summary>
        /// 生成清单列表数据
        /// </summary>
        public void SaveExterOrderAlloData()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "批量生成清单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            try
            {
                //获取订单信息
                List<CargoGtmcProOrderEntity> proOrderEntityList = new List<CargoGtmcProOrderEntity>();
                foreach (Hashtable row in rows)
                {
                    CargoGtmcProOrderEntity proOrderEntity = new CargoGtmcProOrderEntity();
                    proOrderEntity.TID = Convert.ToInt32(row["TID"]);
                    proOrderEntity.OrderAlloType = Convert.ToString(row["OrderAlloType"]);
                    proOrderEntity.ExterOrderAlloNum = Convert.ToInt32(row["ExterOrderAlloNum"]);
                    proOrderEntityList.Add(proOrderEntity);
                }
                string message = "";
                //有清单的订单
                int generatedNum = proOrderEntityList.Where(w => w.ExterOrderAlloNum != 0).ToList().Count();
                if (generatedNum > 0)
                {
                    message += ",重复未处理：" + generatedNum;
                }

                CargoOrderBus bus = new CargoOrderBus();
                List<CargoExterOrderAlloEntity> entities = new List<CargoExterOrderAlloEntity>();
                proOrderEntityList = proOrderEntityList.Where(w => w.ExterOrderAlloNum == 0).ToList();
                //正常清单
                if (proOrderEntityList.Where(w => w.OrderAlloType == "0").ToList().Count() > 0)
                {

                    CargoExterOrderAlloEntity ent = new CargoExterOrderAlloEntity();
                    ent.TID = proOrderEntityList.Where(w => w.OrderAlloType == "0").Select(w => w.TID.ToString()).ToList();
                    ent.AlloPiece = proOrderEntityList.Where(w => w.OrderAlloType == "0").ToList().Count();
                    ent.OPLoginName = UserInfor.LoginName.Trim();
                    ent.OPName = UserInfor.UserName.Trim();
                    ent.OrderAlloType = "0";
                    bus.AddExterOrderAllo(ent, log);

                }
                //跨仓清单
                if (proOrderEntityList.Where(w => w.OrderAlloType == "1").ToList().Count() > 0)
                {
                    CargoExterOrderAlloEntity ent = new CargoExterOrderAlloEntity();
                    ent.TID = proOrderEntityList.Where(w => w.OrderAlloType == "1").Select(w => w.TID.ToString()).ToList();
                    ent.AlloPiece = proOrderEntityList.Where(w => w.OrderAlloType == "1").ToList().Count();
                    ent.OPLoginName = UserInfor.LoginName.Trim();
                    ent.OPName = UserInfor.UserName.Trim();
                    ent.OrderAlloType = "1";
                    bus.AddExterOrderAllo(ent, log);
                }
                //外采清单
                if (proOrderEntityList.Where(w => w.OrderAlloType != "0" && w.OrderAlloType != "1").ToList().Count() > 0)
                {
                    CargoExterOrderAlloEntity ent = new CargoExterOrderAlloEntity();
                    ent.TID = proOrderEntityList.Where(w => w.OrderAlloType != "0" && w.OrderAlloType != "1").Select(w => w.TID.ToString()).ToList();
                    ent.AlloPiece = proOrderEntityList.Where(w => w.OrderAlloType != "0" && w.OrderAlloType != "1").ToList().Count();
                    ent.OPLoginName = UserInfor.LoginName.Trim();
                    ent.OPName = UserInfor.UserName.Trim();
                    ent.OrderAlloType = "2";
                    bus.AddExterOrderAllo(ent, log);
                }
                msg.Result = true;
                msg.Message = "生成清单成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
        ErrEND:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }
        #endregion
        public void QueryGFOrderStatus()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            string keyword = Request["keyword"];
            if (string.IsNullOrEmpty(keyword))
            {
                msg.Result = false;
                msg.Message = "请输入发票号码";
                goto ErrEND;
            }
            CargoOrderBus bus = new CargoOrderBus();
            CargoOrderEntity order = bus.QueryOrderInfo(new CargoOrderEntity { HAwbNo = keyword });
            if (order.OrderID.Equals(0))
            {
                msg.Result = false;
                msg.Message = "未查询到此订单信息";
                goto ErrEND;
            }
            string shopCode = "【" + order.ShopCode + "】";
            List<CargoOrderStatusEntity> result = bus.QueryOrderStatus(new CargoOrderStatusEntity { OrderID = order.OrderID });
            string html = string.Empty;
            if (result.Count > 0)
            {
                html += "<ul>";
                int sum = 0;
                foreach (var item in result)
                {
                    string orderStatus = string.Empty;
                    switch (item.OrderStatus)
                    {
                        case "0":
                            orderStatus = "您的订单系统已处理";
                            break;
                        case "1":
                            orderStatus = "您的订单开始拣货";
                            shopCode = "【" + order.OutHouseName + "】";
                            break;
                        case "2":
                            orderStatus = "您的订单已出库，将分配物流运输";
                            shopCode = "【" + order.OutHouseName + "】";
                            break;
                        case "3":
                            orderStatus = $"您的订单已交付物流，即将发往【{order.Dest}】";
                            shopCode = "";
                            break;
                        case "4":
                            orderStatus = $"您的订单已到达【{order.Dest}】";
                            shopCode = "";
                            break;
                        case "5":
                            orderStatus = "您的订单已被签收";
                            break;
                        case "6":
                            orderStatus = "您的订单已拣货完成";
                            shopCode = "【" + order.OutHouseName + "】";
                            break;
                        case "7":
                            orderStatus = "您的订单正在配送途中，请您耐心等待";
                            shopCode = "";
                            break;
                        case "8":
                            orderStatus = "您的订单已进入仓库准备出库";
                            break;
                        case "9":
                            orderStatus = "已提货";
                            break;
                        default:
                            orderStatus = "";
                            break;
                    }
                    if (sum.Equals(0))
                    {
                        html += $"<li class=\"first\"><p>{item.OP_DATE}</p><p>{shopCode}{orderStatus}</p><span class=\"before\"></span><span class=\"after\"></span><i class=\"mh-icon mh-icon-new\"></i></li>";
                    }
                    else
                    {
                        html += $"<li class=\"\"><p>{item.OP_DATE}</p><p>{shopCode}{orderStatus}</p><span class=\"before\"></span><span class=\"after\"></span></li>";
                    }
                    sum++;
                }
                msg.Result = true;
                msg.Message = html;
            }
        ErrEND:
            string res = JSON.Encode(msg);
            Response.Clear();
            Response.Write(res);
            Response.End();
        }

        public void QueryBundle()
        {
            CargoOrderBundleEntity queryEntity = new CargoOrderBundleEntity();//HouseID
            if (!string.IsNullOrEmpty(Request["HouseID"]))
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["BundleNo"]))) { queryEntity.BundleNo = Convert.ToString(Request["BundleNo"]); }
            if (!Request["BundleStatus"].Equals("-1")) { queryEntity.BundleStatus = Convert.ToString(Request["BundleStatus"]); }
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);

            CargoOrderBus bus = new CargoOrderBus();
            Hashtable order = bus.QueryBundle(queryEntity, pageSize, pageIndex);
            string res = JSON.Encode(order);
            Response.Clear();
            Response.Write(res);
            Response.End();
        }

        public void QueryBundleGoods()
        {
            CargoOrderBundleEntity queryEntity = new CargoOrderBundleEntity();//HouseID
            if (!string.IsNullOrEmpty(Convert.ToString(Request["BundleNo"]))) { queryEntity.BundleNo = Convert.ToString(Request["BundleNo"]); }
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable order = bus.QueryBundleGoods(queryEntity);
            string res = JSON.Encode(order);
            Response.Clear();
            Response.Write(res);
            Response.End();
        }

        public void SaveBundleGoods()
        {
            CargoOrderBundleEntity queryEntity = new CargoOrderBundleEntity();//HouseID
            CargoOrderBus bus = new CargoOrderBus();
            ErrMessage msg = new ErrMessage();
            queryEntity.BunGoodsID = Request["BunGoodsID"];
            queryEntity.BundleNo = Request["BundleNo"];
            queryEntity.GoodsCode = Request["GoodsCode"];
            queryEntity.ProductName = Request["ProductName"];
            queryEntity.Piece = Convert.ToInt32(Request["Piece"]);
            queryEntity.OP_ID = Convert.ToString(UserInfor.LoginName);
            if (string.IsNullOrEmpty(queryEntity.BunGoodsID))
            {
                bus.AddBundleGoods(queryEntity);
                msg.Message = "保存成功";
                msg.Result = true;
            }
            else
            {
                bus.UpdataBundleGoods(queryEntity);
                msg.Message = "保存成功";
                msg.Result = true;
            }
            string res = JSON.Encode(msg);
            Response.Clear();
            Response.Write(res);
            Response.End();
        }

        public void DelBundleGoods()
        {
            List<CargoOrderBundleEntity> list = new List<CargoOrderBundleEntity>();

            string data = Request["data"];
            ArrayList rows = (ArrayList)JSON.Decode(data);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            CargoOrderBus bus = new CargoOrderBus();
            try
            {
                foreach (Hashtable item in rows)
                {
                    list.Add(new CargoOrderBundleEntity
                    {
                        BunGoodsID = Convert.ToString(item["BunGoodsID"]),
                    });
                }
                bus.DelBundleGoods(list);
                msg.Result = true;
                msg.Message = "成功";
                string res = JSON.Encode(msg);
                Response.Clear();
                Response.Write(res);
                Response.End();
            }
            catch (Exception)
            {

                throw;
            }
        }

        /// <summary>
        /// 查询全国仓库库存数据
        /// </summary>
        public void QueryAllBatchImportOrder()
        {

            CargoGtmcProOrderDetailEntity queryEntity = new CargoGtmcProOrderDetailEntity();

            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;

            //输入数据
            string ProductCode = Convert.ToString(Request["ProductCode"]);
            string GoodsCode = Convert.ToString(Request["GoodsCode"]);
            string HouseID = Convert.ToString(Request["HouseID"]);
            string SourceCode = Convert.ToString(Request["SourceCode"]);
            string GtmcNo = Convert.ToString(Request["GtmcNo"]);

            CargoHouseBus house = new CargoHouseBus();
            CargoClientBus clientBus = new CargoClientBus();
            CargoProductBus product = new CargoProductBus();

            //查询客户线路
            CargoHouseEntity houseEnt = house.QueryCargoHouseByID(Convert.ToInt32(HouseID));
            string HouseIDStr = houseEnt.HouseID.ToString() + ",65";
            CargoClientEntity clientEntity = clientBus.QueryCargoClient(new CargoClientEntity { ShopCode = SourceCode, HouseIDStr = HouseIDStr });
            //if (clientEntity.LogisLineLogisID.Equals(0))
            //{
            //    Response.Clear();
            //    Response.Write("客户未绑定线路");
            //    return;
            //}
            List<CargoAreaEntity> areaEntities = new List<CargoAreaEntity>();
            if (!clientEntity.LogisLineLogisID.Equals(0))
            {
                //查询区域仓库信息
                areaEntities = house.QueryOutHouseLevelList(new CargoAreaEntity { ClientNum = clientEntity.ClientNum });

                if (areaEntities.Count <= 0)
                {
                    CargoAreaEntity areaEntity = house.QueryHouseByDeliveryArea(new CargoAreaEntity { HouseID = houseEnt.HouseID, DeliveryArea = clientEntity.City });
                    if (!areaEntity.AreaID.Equals(0))
                    {
                        CargoAreaEntity careaEnt = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = areaEntity.AreaID });
                        areaEntities.Add(careaEnt);
                    }

                }
            }
            //queryEntity.AreaID = string.Join("','", areaEntities.Select(w => w.AreaID.ToString()));
            //queryEntity.HouseID = string.Join("','", areaEntities.Select(w => w.HouseID.ToString()));

            //查询共享产品编号
            queryEntity.ProductCode = ProductCode;
            List<CargoProductMappingEntity> mappingEntities = product.QueryProductShareCode(new CargoProductMappingEntity { CassCode = GoodsCode });
            if (mappingEntities.Count() > 0)
            {
                queryEntity.ProductCode = string.Join("','", mappingEntities
.Select(w => w.ProductCode.ToString())
.Union(mappingEntities.Select(w => w.ShareCode.ToString()))
.Distinct());
            }

            //查询共享库存信息
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            List<CargoGtmcProOrderDetailEntity> list = bus.QueryAllBatchImportOrder(queryEntity);
            list.ForEach(w =>
             {
                 w.IsNetwork = areaEntities.Any(x => x.HouseID == Convert.ToInt32(w.HouseID)) ? 1 : 0;
                 w.ProductCode = ProductCode;
                 w.GoodsCode = GoodsCode;
                 w.SourceCode = SourceCode;
                 w.GtmcNo = GtmcNo;

             });
            list = list.OrderByDescending(item => item.IsNetwork).ToList();
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 选中仓库库存开单
        /// </summary>
        public void SaveAllBatchImportOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "选择仓库开单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            try
            {
                CargoOrderBus bus = new CargoOrderBus();
                CargoHouseBus house = new CargoHouseBus();
                CargoClientBus clientBus = new CargoClientBus();
                CargoInterfaceBus inter = new CargoInterfaceBus();
                CargoFactoryOrderBus factbus = new CargoFactoryOrderBus();
                CargoProductBus product = new CargoProductBus();
                CargoAreaEntity areaEntity = new CargoAreaEntity();
                CargoClientEntity clientEntity = new CargoClientEntity();
                foreach (Hashtable row in rows)
                {



                    //查询客户信息
                    CargoHouseEntity houseEnt = house.QueryCargoHouseByID(Convert.ToInt32(row["HouseID"]));
                    string HouseIDStr = houseEnt.HouseID.ToString() + ",65";
                    clientEntity = clientBus.QueryCargoClient(new CargoClientEntity { ShopCode = Convert.ToString(row["SourceCode"]), HouseIDStr = HouseIDStr });

                    //SourceCode：店代码，GtmcNo：发票号，GoodsCode：货品代码 
                    if (factbus.QueryBatchImportOrderType(new CargoGtmcProOrderEntity { SourceCode = Convert.ToString(row["SourceCode"]), GtmcNo = Convert.ToString(row["GtmcNo"]), GoodsCode = Convert.ToString(row["GoodsCode"]), HouseID = clientEntity.HouseID }))
                    {
                        msg.Result = false;
                        msg.Message = "选中数据中有已开单数据";
                        goto ErrEND;
                    }

                    //查询区域ID
                    areaEntity = house.QueryOutHouseLevelList(new CargoAreaEntity { HouseID = Convert.ToInt32(row["HouseID"]) }).FirstOrDefault();
                    //查询订单信息
                    CargoGtmcProOrderEntity queryEntity = new CargoGtmcProOrderEntity();
                    queryEntity.GtmcNo = Convert.ToString(row["GtmcNo"]);
                    queryEntity.SourceCode = Convert.ToString(row["SourceCode"]);
                    queryEntity.GoodsCode = Convert.ToString(row["GoodsCode"]);
                    queryEntity.OrderStatus = "-1";
                    queryEntity.AwbStatus = "-1";
                    Hashtable list = factbus.QueryBatchImportOrderData(1, 1, queryEntity);
                    List<CargoGtmcProOrderEntity> proOrderList = list["rows"] as List<CargoGtmcProOrderEntity>;
                    CargoGtmcProOrderEntity proOrder = proOrderList.FirstOrDefault();
                    //0：正常 1：跨仓 2：外采
                    proOrder.OrderAlloType = "0";
                    //判断分配类型是否为跨仓
                    if (Convert.ToInt32(row["IsNetwork"]).Equals(0))
                    {
                        proOrder.OrderAlloType = "1";
                        proOrder.Memo = proOrder.Memo + "店代码：" + Convert.ToString(row["SourceCode"]);
                    }


                    //先根据货品代码第一要素查询库存是否满足，满足则直接跳出
                    List<CargoInterfaceEntity> stockList = inter.queryCargoStock(new CargoInterfaceEntity { ParentID = 1, HouseID = Convert.ToInt32(row["HouseID"]), GoodsCode = Convert.ToString(row["GoodsCode"]), AreaID = areaEntity.AreaID, BatckWeek = 0, LastMonth = 9, SuppClientNumStr = "551098,130453,891524,542207" });
                    List<CargoProductMappingEntity> mappingEntities = new List<CargoProductMappingEntity>();
                    string ProductCodeStr = string.Empty;

                    if (stockList.Sum(c => c.StockNum) < proOrder.Piece)
                    {
                        //第一要素库存不够，查询共享编码的库存，满足则直接跳出
                        mappingEntities = product.QueryProductShareCode(new CargoProductMappingEntity { CassCode = Convert.ToString(row["GoodsCode"]) });
                        if (mappingEntities.Count <= 0)
                        {
                            //共享库存也没有库存
                            msg.Result = false;
                            msg.Message = Convert.ToString(row["GoodsCode"]) + "库存不足";
                        }
                        //拼接共享库存
                        foreach (var map in mappingEntities)
                        {
                            if (map.CassCode.Equals(Convert.ToString(row["GoodsCode"])))
                            {
                                if (!ProductCodeStr.Contains(map.ProductCode))
                                {
                                    ProductCodeStr += map.ShareCode + "','";
                                }
                                continue;
                            }
                            if (ProductCodeStr.Contains(map.ProductCode))
                            {
                                ProductCodeStr += map.ShareCode + "','";
                            }
                            else
                            {
                                ProductCodeStr += map.ProductCode + "','";
                            }
                        }
                        if (!string.IsNullOrEmpty(ProductCodeStr))
                        {
                            ProductCodeStr = ProductCodeStr.Substring(0, ProductCodeStr.Length - 3);
                        }
                        if (!string.IsNullOrEmpty(ProductCodeStr))
                        {
                            //查询共享库存
                            stockList = inter.queryCargoStock(new CargoInterfaceEntity { ParentID = 1, HouseID = Convert.ToInt32(row["HouseID"]), ProductCodeStr = ProductCodeStr, AreaID = areaEntity.AreaID, BatckWeek = 0, LastMonth = 9, SuppClientNumStr = "551098,130453,891524,542207" });
                            if (stockList.Sum(c => c.StockNum) < proOrder.Piece)
                            {
                                msg.Result = false;
                                msg.Message = Convert.ToString(row["GoodsCode"]) + "库存不足与共享库存不足";
                            }
                        }

                    }

                    //处理开单
                    if (stockList.Sum(c => c.StockNum) >= proOrder.Piece)
                    {

                        //依次对仓库进行开单  开单实体赋值
                        CargoOrderEntity orderEnt = new CargoOrderEntity();
                        orderEnt.EnSafe();
                        orderEnt.ClientID = clientEntity.ClientID;
                        orderEnt.ClientNum = clientEntity.ClientNum;
                        orderEnt.AcceptUnit = clientEntity.ClientName;
                        orderEnt.AcceptAddress = clientEntity.Address;
                        orderEnt.AcceptPeople = clientEntity.Boss;
                        orderEnt.AcceptTelephone = clientEntity.Telephone;
                        orderEnt.AcceptCellphone = clientEntity.Cellphone;
                        orderEnt.PayClientNum = clientEntity.ClientNum;
                        orderEnt.PayClientName = clientEntity.ClientName;

                        orderEnt.LogisAwbNo = "";
                        orderEnt.LogisID = clientEntity.LogisLineLogisID;
                        orderEnt.Dest = clientEntity.City;
                        orderEnt.Weight = orderEnt.Volume = orderEnt.InsuranceFee = orderEnt.TransitFee = orderEnt.TransportFee = orderEnt.DeliveryFee = orderEnt.OtherFee = orderEnt.TotalCharge = orderEnt.Rebate = 0;
                        orderEnt.CheckOutType = "";
                        orderEnt.TrafficType = "0";
                        orderEnt.DeliveryType = "2";
                        orderEnt.CreateAwbID = UserInfor.LoginName;
                        orderEnt.CreateAwb = UserInfor.UserName;
                        orderEnt.CreateDate = DateTime.Now;
                        orderEnt.CheckStatus = "0";
                        orderEnt.SaleManID = clientEntity.UserID;
                        orderEnt.SaleManName = clientEntity.UserName;
                        orderEnt.LineID = clientEntity.LineID;
                        orderEnt.LineName = clientEntity.LineName;
                        orderEnt.HouseID = areaEntity.HouseID;
                        orderEnt.OP_ID = UserInfor.LoginName.Trim();
                        orderEnt.OP_DATE = DateTime.Now;
                        orderEnt.AwbStatus = "0";
                        orderEnt.OrderType = "0";//电脑开单
                        orderEnt.OrderModel = "0";//销售单
                        orderEnt.ThrowGood = "12";//OES客户单
                        orderEnt.BelongHouse = "0";
                        orderEnt.IsPrintPrice = 0;
                        orderEnt.PostponeShip = "0";
                        orderEnt.ModifyPriceStatus = "0";
                        orderEnt.ShopCode = proOrder.SourceCode;//店代码 
                        //orderEnt.Remark = proOrder.SourceCode + " ";
                        orderEnt.BusinessID = proOrder.BusinessID;//业务ID
                        if (!string.IsNullOrEmpty(orderEnt.BusinessID))
                        {
                            orderEnt.MarketType = clientBus.QueryBusinessIDDefault(new CargoUpClientEntity() { ID = Convert.ToInt32(orderEnt.BusinessID) }).FirstOrDefault().MarketType;
                        }
                        orderEnt.HAwbNo = proOrder.GtmcNo;
                        orderEnt.Remark = proOrder.Memo;

                        string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                        CargoPriceBus cargoPriceBus = new CargoPriceBus();
                        List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
                        List<CargoOrderGoodsEntity> orderGoods = new List<CargoOrderGoodsEntity>();
                        int pieceSum = 0;
                        decimal trFee = 0.00M;//总金额

                        //查询区域信息
                        CargoAreaEntity arit = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = areaEntity.AreaID });

                        if (string.IsNullOrEmpty(orderEnt.OrderNo))
                        {
                            //2024-05-23这里生成订单号
                            if (string.IsNullOrEmpty(arit.OrderCode) || string.IsNullOrEmpty(arit.OrderDep))
                            {
                                msg.Message = $"发票号：{orderEnt.HAwbNo}仓库：{arit.Name}无订单代码或出发城市，不可开单";
                                goto ErrEND;
                            }

                            orderEnt.LogisID = arit.LogisID;
                            orderEnt.LogisticName = arit.LogisticName;
                            orderEnt.OrderNo = Common.GetMaxOrderNumByCurrentDate(arit.HouseID, arit.OrderCode, out int OrderNum);
                            orderEnt.OrderNum = OrderNum;
                            orderEnt.OutHouseName = arit.Name;
                            orderEnt.Dep = arit.OrderDep;
                            orderEnt.HouseID = arit.HouseID;
                            orderEnt.OrderType = "0";//arit.HouseID.Equals(65) || arit.HouseID.Equals(84) ? "0" : "4";//小程序订单


                            int piece = proOrder.Piece;
                            foreach (var it in stockList)
                            {
                                //查询基础信息
                                string proYear, proMonth;
                                proYear = DateTime.Now.ToString("yyyy");
                                proMonth = DateTime.Now.ToString("MM");
                                if (proMonth.Substring(0, 1) == "0")
                                {
                                    proMonth = DateTime.Now.ToString("MM").Substring(1, 1);
                                }
                                //proMonth = "6";
                                CargoProductBasicPriceEntity basicPriceEntity = new CargoProductBasicPriceEntity();
                                CargoProductBasicPriceEntity basicPrice = new CargoProductBasicPriceEntity();
                                basicPriceEntity.HouseID = it.HouseID;
                                basicPriceEntity.TypeID = it.TypeID;
                                basicPriceEntity.GoodsCode = proOrder.GoodsCode;
                                basicPriceEntity.Born = -1;
                                basicPriceEntity.ProYear = proYear;
                                basicPriceEntity.ProMonth = proMonth;
                                basicPrice = house.QueryProductBasicPrice(basicPriceEntity);
                                if (basicPrice != null && basicPrice.PID != 0 && basicPrice.OESalePrice > 0)
                                {
                                    it.TradePrice = Convert.ToDecimal(basicPrice.OESalePrice);
                                }

                                if (it.StockNum <= 0) { continue; }
                                CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                                cargo.OrderNo = orderEnt.OrderNo;//订单号
                                cargo.OutCargoID = outID;
                                cargo.ContainerID = it.ContainerID;
                                cargo.TypeID = it.TypeID;
                                cargo.ProductID = it.ProductID;

                                cargo.ID = it.ContainerGoodsID;//库存表ID
                                cargo.HouseID = houseEnt.HouseID;
                                cargo.HouseName = houseEnt.Name;
                                cargo.ProductName = it.ProductName;
                                cargo.Model = it.Model;
                                cargo.Specs = it.Specs;
                                cargo.Figure = it.Figure;
                                orderEnt.SuppClientNum = orderEnt.HouseID.Equals(65) ? 0 : Convert.ToInt32(it.SuppClientNum);

                                #region 减库存逻辑
                                if (piece < it.StockNum)
                                {
                                    //部分出
                                    orderGoods.Add(new CargoOrderGoodsEntity
                                    {
                                        OrderNo = orderEnt.OrderNo,
                                        ProductID = it.ProductID,
                                        HouseID = orderEnt.HouseID,
                                        AreaID = it.AreaID,
                                        Piece = piece,
                                        ActSalePrice = it.TradePrice,//20241108修改为门店价it.SalePrice,
                                        ContainerCode = it.ContainerCode,
                                        OutCargoID = outID,
                                        OP_ID = log.UserID,
                                        ShowGoodsCode = proOrder.GoodsCode,
                                        ShowProductCode = proOrder.ProductCode,
                                        ShowTypeName = proOrder.TypeName,
                                    });
                                    cargo.Piece = piece;
                                    cargo.InPiece = it.StockNum;

                                    outHouseList.Add(cargo);
                                    pieceSum += cargo.Piece;
                                    trFee += cargo.Piece * it.TradePrice;
                                    break;
                                }
                                if (piece.Equals(it.StockNum))
                                {
                                    //要出库件数和第一条库存件数刚刚好，则就全部出
                                    orderGoods.Add(new CargoOrderGoodsEntity
                                    {
                                        OrderNo = orderEnt.OrderNo,
                                        ProductID = it.ProductID,
                                        HouseID = orderEnt.HouseID,
                                        AreaID = it.AreaID,
                                        Piece = piece,
                                        ActSalePrice = it.TradePrice,//20241108修改为门店价it.SalePrice,
                                        ContainerCode = it.ContainerCode,
                                        ShowGoodsCode = proOrder.GoodsCode,
                                        ShowProductCode = proOrder.ProductCode,
                                        ShowTypeName = proOrder.TypeName,
                                        OutCargoID = outID,
                                        OP_ID = log.UserID
                                    });
                                    cargo.Piece = piece;
                                    cargo.InPiece = it.StockNum;

                                    outHouseList.Add(cargo);
                                    pieceSum += cargo.Piece;
                                    trFee += cargo.Piece * it.TradePrice;
                                    break;
                                }
                                if (piece > it.StockNum)
                                {
                                    //全部出
                                    orderGoods.Add(new CargoOrderGoodsEntity
                                    {
                                        OrderNo = orderEnt.OrderNo,
                                        ProductID = it.ProductID,
                                        HouseID = orderEnt.HouseID,
                                        AreaID = it.AreaID,
                                        Piece = it.StockNum,
                                        ActSalePrice = it.TradePrice,//20241108修改为门店价it.SalePrice,
                                        ContainerCode = it.ContainerCode,
                                        ShowGoodsCode = proOrder.GoodsCode,
                                        ShowProductCode = proOrder.ProductCode,
                                        ShowTypeName = proOrder.TypeName,
                                        OutCargoID = outID,
                                        OP_ID = log.UserID
                                    });
                                    cargo.Piece = it.StockNum;
                                    cargo.InPiece = it.StockNum;

                                    outHouseList.Add(cargo);
                                    pieceSum += cargo.Piece;
                                    trFee += cargo.Piece * it.TradePrice;
                                    piece = piece - it.StockNum;
                                    continue;
                                }
                                #endregion
                            }
                        }

                        orderEnt.goodsList = orderGoods;
                        orderEnt.Piece = pieceSum;
                        orderEnt.TransportFee = trFee;
                        orderEnt.TotalCharge = trFee;
                        orderEnt.HAwbNo = orderEnt.HAwbNo.TrimEnd(',');

                        //仓库同步缓存
                        foreach (CargoContainerShowEntity time in outHouseList)
                        {
                            CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
                            //34 马牌  1 同步马牌  2 同步全部品牌
                            if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                            {
                                RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                            }
                            //主仓缓存更改
                            if (house.IsAddCaching(syncProduct.HouseID, time.TypeID))
                            {
                                RedisHelper.HashSet("HCYCHouseStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                            }
                        }
                        //新增订单信息
                        bus.AddOrderInfo(orderEnt, outHouseList, log);

                        //修改广丰订单数据
                        factbus.UpdateGtmcProOrderStatus(new CargoGtmcProOrderEntity { TID = proOrder.TID, OrderNo = orderEnt.OrderNo, OrderStatus = "1", AutoOrderHandleStatus = "1", OrderHandleType = "0", AutoOrderHandleTime = DateTime.Now, OrderAlloType = proOrder.OrderAlloType });

                        if (orderEnt.HouseID.Equals(9))
                        {
                            //内部订单
                            bus.SaveHlyOrderData(outHouseList, orderEnt);
                        }
                        else
                        {
                            bus.InsertCargoOrderPush(new CargoOrderPushEntity
                            {
                                OrderNo = orderEnt.OrderNo,
                                Dep = orderEnt.Dep,
                                Dest = orderEnt.Dest,
                                Piece = orderEnt.Piece,
                                TransportFee = orderEnt.TransportFee,
                                ClientNum = orderEnt.ClientNum.ToString(),
                                AcceptAddress = orderEnt.AcceptAddress,
                                AcceptCellphone = orderEnt.AcceptCellphone,
                                AcceptTelephone = orderEnt.AcceptTelephone,
                                AcceptPeople = orderEnt.AcceptPeople,
                                AcceptUnit = orderEnt.AcceptUnit,
                                HouseID = orderEnt.HouseID.ToString(),
                                HouseName = house.QueryCargoHouseByID(orderEnt.HouseID).Name,// orderEnt.HouseID.Equals(65) || orderEnt.HouseID.Equals(84) ? houseEnt.Name : orderEnt.OutHouseName,
                                OP_ID = UserInfor.UserName,
                                HLYSendUnit = orderEnt.HouseID.Equals(65) ? outHouseList[0].ProductName : outHouseList[0].ProductName,
                                PushType = "0",
                                PushStatus = "0",
                                LogisID = orderEnt.LogisID
                            }, log);
                        }

                        msg.Result = true;
                        msg.Message = "开单成功";
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }

        ErrEND:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
            Response.End();
        }
        #region 马牌订单导入
        /// <summary>
        /// 马牌订单数据查询
        /// </summary>
        public void QueryContiOrder()
        {
            saleOpenInfoResp queryEntity = new saleOpenInfoResp();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            queryEntity.orderCode = Convert.ToString(Request["orderCode"]);
            queryEntity.customerName = Convert.ToString(Request["customerName"]);
            queryEntity.consigneeName = Convert.ToString(Request["consigneeName"]);
            if (Convert.ToString(Request["orderType"]) != "-1")
            {
                queryEntity.orderType = Convert.ToString(Request["orderType"]);
            }
            if (Convert.ToString(Request["orderLabel"]) != "-1")
            {
                queryEntity.orderLabel = Convert.ToString(Request["orderLabel"]);
            }
            if (Convert.ToString(Request["InCreateStatus"]) != "-1")
            {
                queryEntity.InCreateStatus = Convert.ToString(Request["InCreateStatus"]);
            }
            if (Convert.ToString(Request["OrderHouse"]) != "-1")
            {
                queryEntity.OrderHouseWhere = Convert.ToString(Request["OrderHouse"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoInterfaceBus bus = new CargoInterfaceBus();
            Hashtable list = bus.QueryContiOrder(pageIndex, pageSize, queryEntity);
            //if (list != null) { QueryOrderInfoList = list; }
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 查询订单明细数据
        /// </summary>
        public void QueryContiOrderGoods()
        {
            string OrderID = Request["OrderID"];
            if (string.IsNullOrEmpty(OrderID)) { return; }
            saleSkuOpenInfoResp queryEntity = new saleSkuOpenInfoResp();
            queryEntity.OrderID = Convert.ToInt32(OrderID);
            CargoInterfaceBus bus = new CargoInterfaceBus();
            List<saleSkuOpenInfoResp> list = bus.QueryContiOrderGoods(queryEntity);
            List<saleSkuOpenInfoResp> footlist = new List<saleSkuOpenInfoResp>();
            footlist.Add(new saleSkuOpenInfoResp
            {
                skuCode = "汇总：",
                skuNum = list.Sum(c => c.skuNum),
                nowUnitPrice = list.Sum(c => c.nowUnitPrice),
                netUnitPrice = list.Sum(c => c.netUnitPrice),
                couponAmount = list.Sum(c => c.couponAmount),
                netAmount = list.Sum(c => c.netAmount)
            });
            Hashtable resHT = new Hashtable();
            resHT["rows"] = list;
            resHT["total"] = list.Count();
            resHT["footer"] = footlist;
            //if (list.Count > 0) { CargoDailyReportType = "出库"; }

            //JSON
            String json = JSON.Encode(resHT);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 保存马牌订单
        /// </summary>
        public void SaveContiOrder()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            string goods = Request["goods"];
            if (string.IsNullOrEmpty(goods))
            {
                msg.Result = false;
                msg.Message = "参数数据有误";
                goto ERROR;
            }
            List<saleOpenInfoResp> result = new List<saleOpenInfoResp>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ArrayList skuStr = (ArrayList)JSON.Decode(goods);


            string ClientNum = Convert.ToString(Request["ClientNum"]);
            string AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            if (string.IsNullOrEmpty(ClientNum))
            {
                msg.Result = false;
                msg.Message = "请选择客户数据";
                goto ERROR;
            }
            int HouseID = Convert.ToInt32(Request["HouseID"]);//传入区域大仓ID
            int AreaID = Convert.ToInt32(Request["AreaID"]);//传入仓库ID
            string BatchYearStr = Convert.ToString(Request["BatchYear"]);//周期年

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "生成仓库订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            CargoHouseBus bus = new CargoHouseBus();
            CargoClientBus clientBus = new CargoClientBus();
            CargoInterfaceBus interfaceBus = new CargoInterfaceBus();
            CargoOrderBus orderBus = new CargoOrderBus();
            foreach (Hashtable row in rows)
            {
                saleOpenInfoResp sale = interfaceBus.QueryContiOrderEntity(new saleOpenInfoResp { OrderID = Convert.ToInt64(row["OrderID"]) });
                if (sale.InCreateStatus.Equals("1"))
                {
                    msg.Result = false;
                    msg.Message = "订单：" + sale.orderCode + "已生成";
                    goto ERROR;
                }
                if (!Convert.ToString(row["orderType"]).Equals("1")
                    && !Convert.ToString(row["orderType"]).Equals("3")
                    && !Convert.ToString(row["orderType"]).Equals("6")
                    && !Convert.ToString(row["orderType"]).Equals("4"))
                {
                    // 1   普通订单 3   调拨订单 6   NA订单  4   加急配送订单 5   长尾订单 7   resell订单
                    continue;
                }
                //循环生成订单
                CargoOrderEntity ent = new CargoOrderEntity();
                List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
                List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();

                //1. 根据仓库代码查询该仓库的库存并生成该仓库订单
                //2. 根据客户编码查询客户数据是否存在，不存在新增。
                //saleorder.customerCode
                //saleorder.warehouseCode
                //if (string.IsNullOrEmpty(Convert.ToString(row["warehouseCode"])))
                //{
                //    //直接跳出 没有出库仓库。
                //    msg.Result = false;
                //    msg.Message = "无出库仓库";
                //    goto ERROR;
                //}

                //CargoAreaEntity areaEntity = bus.QueryHouseByDeliveryArea(new CargoAreaEntity { ContiHouseCode = Convert.ToString(row["warehouseCode"]) });
                CargoAreaEntity areaEntity = bus.QueryAreaByAreaID(new CargoAreaEntity { AreaID = AreaID });
                if (areaEntity.AreaID.Equals(0))
                {
                    //写日志 没有配置仓库
                    msg.Result = false;
                    msg.Message = "无出库仓库";
                    goto ERROR;
                }
                CargoClientEntity clientEntity = clientBus.QueryCargoClient(Convert.ToInt32(ClientNum), 0);

                ent.OpenOrderNo = Convert.ToString(row["orderCode"]);
                ent.OpenOrderSource = "0";//马牌订单

                ent.Dep = areaEntity.OrderDep;
                int OrderNum = 0;
                CargoHouseEntity houEnt = bus.QueryCargoHouseByID(areaEntity.HouseID);
                ent.HouseID = areaEntity.HouseID;
                var ThrowGood = "0";
                var DeliveryType = "0";
                switch (sale.orderType)
                {
                    case "6":
                        ThrowGood = "20";
                        break;
                    case "1":
                    case "4":
                        ThrowGood = "16";
                        DeliveryType = "2";
                        break;
                    default:
                        ThrowGood = "0";
                        break;
                }
                ent.ThrowGood = ThrowGood;
                ent.LogisID = areaEntity.LogisID;
                ent.Dest = Convert.ToString(Request["Dest"]);//clientEntity.City;
                ent.Weight = 0;
                ent.Volume = 0;
                ent.CheckOutType = clientEntity.CheckOutType;
                ent.TrafficType = "0";
                ent.DeliveryType = DeliveryType;
                ent.AcceptUnit = clientEntity.ClientName;
                ent.AcceptAddress = Convert.ToString(Request["AcceptAddress"]).Replace("?", "");
                //ent.AcceptAddress = Convert.ToString(row["consigneeAddress"]).Replace("?", "");
                ent.AcceptPeople = AcceptPeople;// Convert.ToString(row["consigneeName"]).Replace("?", "");
                ent.AcceptTelephone = Convert.ToString(row["consigneeMobile"]);
                ent.AcceptCellphone = Convert.ToString(row["consigneeMobile"]);
                ent.CreateAwb = UserInfor.UserName;//好来运系统
                ent.CreateAwbID = UserInfor.LoginName;
                ent.CreateDate = DateTime.Now;//Convert.ToDateTime(Convert.ToString(row["submitTime"]));//下单时间
                ent.OP_ID = UserInfor.LoginName;
                ent.SaleManID = Convert.ToString(Request["SaleManID"]); //clientEntity.UserID;// 业务员ID
                ent.SaleManName = Convert.ToString(Request["SaleManName"]); //clientEntity.UserName;// 业务员姓名
                ent.SaleCellPhone = Convert.ToString(Request["SaleCellPhone"]); // clientEntity.UserID;//业务员电话
                ent.Remark = Convert.ToString(Request["Remark"]);
                ent.BelongHouse = "0";//1：好来运订单
                ent.ClientNum = clientEntity.ClientNum;
                ent.PayClientNum = clientEntity.ClientNum;
                ent.PayClientName = clientEntity.Boss;
                string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                int pieceSum = 0;

                List<saleSkuOpenInfoResp> saleSkus = interfaceBus.QueryContiOrderGoods(new saleSkuOpenInfoResp { OrderID = sale.OrderID });
                if (saleSkus.Count <= 0)
                {
                    //写日志 没有配置仓库
                    msg.Result = false;
                    msg.Message = "订单明细数据有误";
                    goto ERROR;
                }
                foreach (var sku in saleSkus)
                {
                    pieceSum += sku.skuNum;
                    int piece = sku.skuNum;

                    //pieceSum += Convert.ToInt32(sku["skuNum"]);
                    //int piece = Convert.ToInt32(sku["skuNum"]);
                    //int BatckWeek = 0;
                    //if (sale.orderType.Equals("6"))
                    //{
                    //    //NA订单要求周期一年内的
                    //    BatckWeek = DateTime.Now.DayOfYear / 7 + 1;
                    //}
                    //znf 250916
                    int BatchYear = 0;
                    if (!string.IsNullOrEmpty(BatchYearStr))
                    {
                        BatchYear = Convert.ToInt32(BatchYearStr.Substring(1, 3));
                    }
                    //查找库存
                    CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                    {
                        HouseID = areaEntity.HouseID,
                        GoodsCode = sku.skuCode + "0000",
                        AreaID = areaEntity.AreaID,
                        BatchYear = BatchYear,
                        //TypeID = 34,
                        ParentID = 1,
                    };
                    List<CargoInterfaceEntity> stockList = interfaceBus.queryCargoStock(queryEntity);

                    if (stockList.Count <= 0)
                    {
                        msg.Result = false;
                        msg.Message = "商品名称：" + sku.skuName + "库存为空";
                        goto ERROR;
                    }
                    if (stockList.Sum(c => c.StockNum) < piece)
                    {
                        msg.Result = false;
                        msg.Message = "商品名称：" + sku.skuName + "库存不足，库存只剩：" + stockList.Sum(c => c.StockNum).ToString();
                        goto ERROR;
                    }
                    //减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                    foreach (var it in stockList)
                    {
                        if (it.StockNum <= 0) { continue; }
                        CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                        cargo.OrderNo = ent.OrderNo;//订单号
                        cargo.OutCargoID = outID;
                        cargo.ContainerID = it.ContainerID;
                        cargo.TypeID = it.TypeID;
                        cargo.ProductID = it.ProductID;
                        cargo.GoodsCode = it.GoodsCode;
                        cargo.ID = it.ContainerGoodsID;//库存表ID

                        //cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                        cargo.HouseName = houEnt.Name;
                        //cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                        cargo.ProductName = it.ProductName;
                        cargo.Model = it.Model;
                        cargo.Specs = it.Specs;
                        cargo.Figure = it.Figure;
                        #region 减库存逻辑
                        if (piece < it.StockNum)
                        {
                            //部分出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = piece,
                                //ActSalePrice = sku.nowUnitPrice,// Convert.ToDecimal(sku["nowUnitPrice"]),
                                ActSalePrice = sku.netUnitPrice,// Convert.ToDecimal(sku["nowUnitPrice"]),
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                OP_ID = log.UserID
                            });
                            cargo.Piece = piece;
                            cargo.InPiece = it.StockNum;

                            outHouseList.Add(cargo);
                            break;
                        }
                        if (piece.Equals(it.StockNum))
                        {
                            //要出库件数和第一条库存件数刚刚好，则就全部出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = piece,
                                //ActSalePrice = sku.nowUnitPrice,//Convert.ToDecimal(sku["nowUnitPrice"]),
                                ActSalePrice = sku.netUnitPrice,//Convert.ToDecimal(sku["nowUnitPrice"]),
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                OP_ID = log.UserID
                            });
                            cargo.Piece = piece;
                            cargo.InPiece = it.StockNum;

                            outHouseList.Add(cargo);
                            break;
                        }
                        if (piece > it.StockNum)
                        {
                            //全部出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = it.StockNum,
                                //ActSalePrice = sku.nowUnitPrice,//Convert.ToDecimal(sku["nowUnitPrice"]),
                                ActSalePrice = sku.netUnitPrice,//Convert.ToDecimal(sku["nowUnitPrice"]),
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                OP_ID = log.UserID
                            });
                            cargo.Piece = it.StockNum;
                            cargo.InPiece = it.StockNum;

                            outHouseList.Add(cargo);
                            piece = piece - it.StockNum;
                            continue;
                        }
                        #endregion
                    }
                }

                //优惠券
                //foreach (var coupon in saleorder.saleOpenPromotionAmountList)
                //{
                //    ent.InsuranceFee += coupon.couponAmount + coupon.cashPromotionAmount + coupon.deductionPromotionAmount;
                //}
                //优惠券
                ent.InsuranceFee = string.IsNullOrEmpty(Convert.ToString(row["couponAmount"])) ? 0 : Convert.ToDecimal(row["couponAmount"]);
                ent.TransitFee = 0;
                //现订单总价
                //现订单总价 = 订单所有商品现含税总价 + 运费 =额度 + 返利 + 优惠券 + 在线支付
                decimal netAmount = 0;
                foreach (Hashtable item in skuStr)
                {
                    netAmount += string.IsNullOrEmpty(Convert.ToString(item["netAmount"])) ? 0 : Convert.ToDecimal(item["netAmount"]);
                }
                ent.TransportFee = netAmount;// string.IsNullOrEmpty(Convert.ToString(row["nowTotalAmount"])) ? 0 : Convert.ToDecimal(row["nowTotalAmount"]);
                //返利
                ent.BateAmount = string.IsNullOrEmpty(Convert.ToString(row["rebateAmount"])) ? 0 : Convert.ToDecimal(row["rebateAmount"]);
                //运费
                ent.DeliveryFee = string.IsNullOrEmpty(Convert.ToString(row["freightAmount"])) ? 0 : Convert.ToDecimal(row["freightAmount"]);
                ent.OtherFee = 0;
                //总金额  在线支付金额
                var totalNum = string.IsNullOrEmpty(Convert.ToString(row["nowTotalAmount"])) ? 0 : Convert.ToDecimal(row["nowTotalAmount"]);
                ent.ContiOrderAmount = totalNum;
                ent.TotalCharge = totalNum + ent.DeliveryFee - ent.InsuranceFee - ent.BateAmount;
                // string.IsNullOrEmpty(Convert.ToString(row["onlinePaidAmount"])) ? 0 : Convert.ToDecimal(row["onlinePaidAmount"]);
                //if (ent.TotalCharge.Equals(0))
                //{
                //    ent.TotalCharge = ent.TransportFee;
                //}
                //
                ent.OnlinePaidAmount = string.IsNullOrEmpty(Convert.ToString(row["onlinePaidAmount"])) ? 0 : Convert.ToDecimal(row["onlinePaidAmount"]);
                ent.Rebate = 0;
                ent.AwbStatus = "0";
                ent.OrderType = "0";
                ent.BusinessID = "12";
                ent.MarketType = "1";
                ent.goodsList = entDest;
                string ordercode = string.IsNullOrEmpty(areaEntity.OrderCode) ? houEnt.HouseCode : areaEntity.OrderCode;
                ent.OutHouseName = string.IsNullOrEmpty(areaEntity.OrderCode) ? houEnt.Name : areaEntity.Name;
                ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(areaEntity.HouseID, ordercode, out OrderNum); // Convert.ToString(row["OrderNo"]);//生成最新顺序订单号
                ent.OrderNum = OrderNum;
                ent.Piece = pieceSum;
                foreach (var outH in outHouseList)
                {
                    outH.OrderNo = ent.OrderNo;
                }
                foreach (var gl in ent.goodsList)
                {
                    gl.OrderNo = ent.OrderNo;
                }
                //仓库同步缓存
                foreach (CargoContainerShowEntity time in outHouseList)
                {
                    CargoProductEntity syncProduct = bus.SyncTypeProduct(time.ProductID.ToString());
                    //34 马牌  1 同步马牌  2 同步全部品牌
                    if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                    {
                        RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                    }
                }
                orderBus.AddOrderInfo(ent, outHouseList, log);
                //修改马牌订单表状态
                interfaceBus.UpdateContiOrderCreateData(new saleOpenInfoResp
                {
                    orderCode = Convert.ToString(row["orderCode"]),
                    CargoOrderNo = ent.OrderNo,
                    OrderID = Convert.ToInt64(row["OrderID"]),
                    ClientNum = Convert.ToInt32(ClientNum),
                    InCreateStatus = "1",
                    CreateAwbID = UserInfor.LoginName,
                    CreateAwb = UserInfor.UserName,
                    CreateDate = DateTime.Now
                }, log);

                #region 推送好来运系统

                //判断必须选择好来运速递
                if ((ent.HouseID.Equals(9) || ent.HouseID.Equals(93)) && ent.LogisID.Equals(34))
                {
                    //内部订单
                    orderBus.SaveHlyOrderData(outHouseList, ent);
                }
                else
                {
                    orderBus.InsertCargoOrderPush(new CargoOrderPushEntity
                    {
                        OrderNo = ent.OrderNo,
                        Dep = ent.Dep,
                        Dest = ent.Dest,
                        Piece = ent.Piece,
                        TransportFee = ent.TransportFee,
                        ClientNum = ent.ClientNum.ToString(),
                        AcceptAddress = ent.AcceptAddress,
                        AcceptCellphone = ent.AcceptCellphone,
                        AcceptTelephone = ent.AcceptTelephone,
                        AcceptPeople = ent.AcceptPeople,
                        AcceptUnit = ent.AcceptUnit,
                        HouseID = ent.HouseID.ToString(),
                        HouseName = houEnt.Name,
                        OP_ID = UserInfor.UserName,
                        PushType = "0",
                        PushStatus = "0",
                        LogisID = ent.LogisID
                    }, log);
                }

                #endregion

            }

        ERROR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 马牌订单审核
        /// </summary>
        public void SaveContiOrderOK()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<saleOpenInfoResp> list = new List<saleOpenInfoResp>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "马牌订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            CargoInterfaceBus interfaceBus = new CargoInterfaceBus();
            try
            {
                //马牌订单审核接口地址
                string contiUrl = Common.GetContiUrl() + Common.GetContiOrderCheckSync();
                foreach (Hashtable row in rows)
                {
                    //判断是否待确认状态
                    if (!Convert.ToString(row["orderStatus"]).Equals("30"))
                    {
                        msg.Message = "非待确认状态";
                        msg.Result = false;
                        break;
                    }

                    string body = "{\"orderCode\": \"" + Convert.ToString(row["orderCode"]) + "\",	\"eventType\": 4,	\"changeReason\": \"审核\"}";
                    string returnStr = wxHttpUtility.ContiSendPostHttpRequest(contiUrl, "application/json", body);
                    ArrayList retur = (ArrayList)JSON.Decode("[" + returnStr + "]");
                    foreach (Hashtable ret in rows)
                    {
                        if (Convert.ToString(ret["code"]).Equals("10000"))
                        {
                            //操作成功 更新订单状态
                            list.Add(new saleOpenInfoResp
                            {
                                orderCode = Convert.ToString(row["orderCode"]),
                                OrderID = Convert.ToInt64(row["OrderID"]),
                                CreateAwb = UserInfor.UserName,
                                orderStatus = "40",
                            });
                        }
                    }
                }
                interfaceBus.UpdateContiOrderStatus(list, log);
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }
        /// <summary>
        /// 删除马牌同步下来的订单
        /// </summary>
        public void DelContiOrder()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<saleOpenInfoResp> list = new List<saleOpenInfoResp>();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "马牌订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            CargoInterfaceBus bus = new CargoInterfaceBus();
            try
            {
                foreach (Hashtable row in rows)
                {
                    saleOpenInfoResp sale = bus.QueryContiOrderEntity(new saleOpenInfoResp { OrderID = Convert.ToInt64(row["OrderID"]) });
                    if (sale.InCreateStatus.Equals("1"))
                    {
                        msg.Result = false;
                        msg.Message = "订单：" + sale.orderCode + "已生成";
                        goto ERROR;
                    }
                    list.Add(new saleOpenInfoResp
                    {
                        OrderID = Convert.ToInt64(row["OrderID"]),
                        orderCode = Convert.ToString(row["orderCode"]),
                        customerName = Convert.ToString(row["customerName"]),
                        OrderPiece = Convert.ToInt32(row["OrderPiece"])
                    });
                }
                bus.DelContiOrder(list, log);
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
        ERROR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }

        #endregion

        #region 外部订单分配清单操作方法
        /// <summary>
        /// 查询外部订单分配清单
        /// </summary>
        public void QueryExterOrderAlloList()
        {
            CargoExterOrderAlloEntity queryEntity = new CargoExterOrderAlloEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            queryEntity.AcceptName = Convert.ToString(Request["AcceptName"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ExterOrderAlloNum"])))
            {
                queryEntity.ExterOrderAlloNum = Convert.ToInt32(Request["ExterOrderAlloNum"]);
            }
            if (Convert.ToString(Request["OrderAlloType"]) != "-1")
            {
                queryEntity.OrderAlloType = Convert.ToString(Request["OrderAlloType"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            Hashtable list = bus.QueryExterOrderAlloList(pageIndex, pageSize, queryEntity);
            //if (list != null) { QueryOrderInfoList = list; }
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询外部订单分配清单明细
        /// </summary>
        public void QueryExterOrderAlloDetail()
        {
            CargoGtmcProOrderEntity queryEntity = new CargoGtmcProOrderEntity();
            CargoFactoryOrderBus bus = new CargoFactoryOrderBus();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ExterOrderAlloNum"])))
            {
                queryEntity.ExterOrderAlloNum = Convert.ToInt32(Request["ExterOrderAlloNum"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["OrderStatus"])))
            {
                queryEntity.OrderStatus = Convert.ToString(Request["OrderStatus"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["DayNum"])))
            {
                queryEntity.StartDate = DateTime.Now.AddDays(-Convert.ToInt32(Request["DayNum"]));
                queryEntity.EndDate = DateTime.Now;
            }
            List<CargoGtmcProOrderEntity> result = bus.QueryExterOrderDataList(queryEntity);
            String json = JSON.Encode(result);
            Response.Clear();
            Response.Write(json);
            Response.End();
        }
        /// <summary>
        /// 保存外部订单分配清单
        /// </summary>
        public void saveOutPurchaseOrder()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            CargoHouseBus house = new CargoHouseBus();
            msg.Result = true;
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有产品数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }

            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.NvgPage = "清单列表";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            log.Status = "0";

            CargoOrderBus bus = new CargoOrderBus();
            CargoClientBus clientBus = new CargoClientBus();
            CargoInterfaceBus inter = new CargoInterfaceBus();
            CargoFactoryOrderBus factbus = new CargoFactoryOrderBus();
            CargoProductBus productBus = new CargoProductBus();

            //处理店代码 同一店代码的数据合并
            Dictionary<string, List<CargoGtmcProOrderEntity>> listDic = new Dictionary<string, List<CargoGtmcProOrderEntity>>();

            foreach (Hashtable row in GridRows)
            {
                //SourceCode：店代码，GtmcNo：发票号，GoodsCode：货品代码 
                if (factbus.QueryBatchImportOrderType(new CargoGtmcProOrderEntity { HouseID = Convert.ToInt32(row["HouseID"]), SourceCode = Convert.ToString(row["SourceCode"]), GtmcNo = Convert.ToString(row["GtmcNo"]), GoodsCode = Convert.ToString(row["GoodsCode"]) }))
                {
                    continue;
                }

                string BusinessID = Convert.ToString(row["BusinessID"]);
                if (listDic.ContainsKey(Convert.ToString(row["SourceCode"])))
                {
                    listDic.TryGetValue(Convert.ToString(row["SourceCode"]), out List<CargoGtmcProOrderEntity> orderList);
                    listDic.Remove(Convert.ToString(row["SourceCode"]));
                    bool type = true;
                    foreach (CargoGtmcProOrderEntity item in orderList)
                    {
                        if (item.GoodsCode.Equals(Convert.ToString(row["GoodsCode"])))
                        {
                            type = false;
                            item.ID = item.ID + "," + Convert.ToString(row["TID"]);
                            item.GtmcNo = (item.GtmcNo + "," + Convert.ToString(row["GtmcNo"]).Replace(item.GtmcNo, "")).Replace(",,", ",");
                            item.Piece = item.Piece + Convert.ToInt32(row["Piece"]);
                        }
                    }
                    if (type)
                    {
                        CargoGtmcProOrderEntity orderEntity = new CargoGtmcProOrderEntity();
                        orderEntity.SourceCode = Convert.ToString(row["SourceCode"]);
                        orderEntity.GoodsCode = Convert.ToString(row["GoodsCode"]);
                        orderEntity.HouseID = Convert.ToInt32(row["HouseID"]);
                        orderEntity.TID = Convert.ToInt64(row["TID"]);
                        orderEntity.ID = Convert.ToString(row["TID"]);
                        orderEntity.GtmcNo = Convert.ToString(row["GtmcNo"]);
                        orderEntity.Piece = Convert.ToInt32(row["Piece"]);
                        orderEntity.ProductCode = Convert.ToString(row["ProductCode"]);
                        orderEntity.Memo = Convert.ToString(row["Memo"]);
                        orderEntity.BusinessID = BusinessID;
                        orderEntity.TypeName = Convert.ToString(row["TypeName"]);
                        orderEntity.TypeParentID = Convert.ToInt32(row["TypeParentID"]);
                        orderEntity.TypeID = Convert.ToInt32(row["TypeID"]);
                        orderEntity.FirstLevelHouseID = Convert.ToInt32(row["FirstLevelHouseID"]);
                        orderEntity.FirstLevelAreaID = Convert.ToInt32(row["FirstLevelAreaID"]);
                        orderList.Add(orderEntity);
                    }
                    listDic.Add(Convert.ToString(row["SourceCode"]), orderList);
                }
                else
                {
                    CargoGtmcProOrderEntity orderEntity = new CargoGtmcProOrderEntity();
                    orderEntity.SourceCode = Convert.ToString(row["SourceCode"]);
                    orderEntity.GtmcNo = Convert.ToString(row["GtmcNo"]);
                    orderEntity.Piece = Convert.ToInt32(row["Piece"]);
                    orderEntity.GoodsCode = Convert.ToString(row["GoodsCode"]);
                    orderEntity.TID = Convert.ToInt64(row["TID"]);
                    orderEntity.ID = Convert.ToString(row["TID"]);
                    orderEntity.HouseID = Convert.ToInt32(row["HouseID"]);
                    orderEntity.ProductCode = Convert.ToString(row["ProductCode"]);
                    orderEntity.Memo = Convert.ToString(row["Memo"]);
                    orderEntity.BusinessID = BusinessID;
                    orderEntity.TypeParentID = Convert.ToInt32(row["TypeParentID"]);
                    orderEntity.TypeID = Convert.ToInt32(row["TypeID"]);
                    orderEntity.TypeName = Convert.ToString(row["TypeName"]);
                    orderEntity.FirstLevelHouseID = Convert.ToInt32(row["FirstLevelHouseID"]);
                    listDic.Add(Convert.ToString(row["SourceCode"]), new List<CargoGtmcProOrderEntity> { orderEntity });
                }
            }


            string message = string.Empty;
            string HAwbNo = string.Empty;




            CargoHouseBus houseBus = new CargoHouseBus();

            string source = string.Empty;
            List<string> HouseStr = new List<string>();


            //foreach (var item in listDic)
            //{
            //    List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
            //    List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();
            //    List<QyOrderUpdateGoodsEntity> goods = new List<QyOrderUpdateGoodsEntity>();
            //    string PurchaserBoss = string.Empty;
            //    string PurchaserCellphone = string.Empty;
            //    string PurchaserAddress = string.Empty;

            //    CargoClientEntity clientEntity = clientBus.QueryCargoClient(new CargoClientEntity { ShopCode = item.Key, HouseID = 65 });
            //    //依次对仓库进行开单  开单实体赋值
            //    CargoOrderEntity orderEnt = new CargoOrderEntity();
            //    orderEnt.EnSafe();
            //    orderEnt.ClientID = clientEntity.ClientID;
            //    orderEnt.ClientNum = clientEntity.ClientNum;
            //    orderEnt.AcceptUnit = clientEntity.ClientName;
            //    orderEnt.AcceptAddress = clientEntity.Address;
            //    orderEnt.AcceptPeople = clientEntity.Boss;
            //    orderEnt.AcceptTelephone = clientEntity.Telephone;
            //    orderEnt.AcceptCellphone = clientEntity.Cellphone;
            //    orderEnt.PayClientNum = clientEntity.ClientNum;
            //    orderEnt.PayClientName = clientEntity.ClientName;

            //    orderEnt.LogisAwbNo = "";
            //    orderEnt.LogisID = clientEntity.LogisLineLogisID;
            //    orderEnt.Dest = clientEntity.City;
            //    orderEnt.Weight = orderEnt.Volume = orderEnt.InsuranceFee = orderEnt.TransitFee = orderEnt.TransportFee = orderEnt.DeliveryFee = orderEnt.OtherFee = orderEnt.TotalCharge = orderEnt.Rebate = 0;
            //    orderEnt.CheckOutType = "";
            //    orderEnt.TrafficType = "0";
            //    orderEnt.DeliveryType = "2";
            //    orderEnt.CreateAwbID = UserInfor.LoginName;
            //    orderEnt.CreateAwb = UserInfor.UserName;
            //    orderEnt.CreateDate = DateTime.Now;
            //    orderEnt.CheckStatus = "0";
            //    orderEnt.SaleManID = clientEntity.UserID;
            //    orderEnt.SaleManName = clientEntity.UserName;
            //    orderEnt.LineID = clientEntity.LineID;
            //    orderEnt.LineName = clientEntity.LineName;

            //    orderEnt.OP_ID = UserInfor.LoginName.Trim();
            //    orderEnt.OP_DATE = DateTime.Now;
            //    orderEnt.AwbStatus = "0";
            //    orderEnt.OrderType = "0";//电脑开单
            //    orderEnt.OrderModel = "0";//销售单
            //    orderEnt.ThrowGood = "12";//OES客户单
            //    orderEnt.BelongHouse = "0";
            //    orderEnt.IsPrintPrice = 0;
            //    orderEnt.PostponeShip = "0";
            //    orderEnt.ModifyPriceStatus = "0";
            //    orderEnt.ShopCode = item.Key;//店代码 
            //    orderEnt.Remark = item.Key + " ";
            //    int HouseID = item.Value[0].FirstLevelHouseID;
            //    CargoHouseEntity houseEnt = house.QueryCargoHouseByID(HouseID);
            //    orderEnt.Dep = Convert.ToString(houseEnt.DepCity);

            //    string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
            //    int OrderNum = 0;
            //    orderEnt.OrderNo = Common.GetMaxOrderNumByCurrentDate(HouseID, houseEnt.HouseCode, out OrderNum);
            //    orderEnt.OrderNum = OrderNum;//最新订单顺序号
            //    CargoContainerEntity containerEntity = houseBus.QueryTopOneContainer(new CargoContainerEntity { HouseID = HouseID, FirstAreaID = item.Value[0].FirstLevelAreaID });

            //    decimal trFee = 0.00M;
            //    int pieceSum = 0;
            //    List<CargoProductEntity> productList = new List<CargoProductEntity>();
            //    foreach (var gd in item.Value)
            //    {
            //        //通过产品编码ProductCode查询产品基础数据信息
            //        CargoProductSpecEntity cpse= productBus.GetProductSpecByProductCode(gd.ProductCode);
            //        orderEnt.BusinessID = gd.BusinessID;

            //        CargoProductEntity entProduct = new CargoProductEntity();
            //        entProduct.ParentID = gd.TypeParentID;
            //        entProduct.ProductName = houseBus.QueryCargoHouse(new CargoHouseEntity { HouseID = HouseID }).CargoDepart;
            //        entProduct.TypeID = gd.TypeID;
            //        entProduct.TypeName = gd.TypeName;
            //        entProduct.Model = cpse.Model;
            //        entProduct.GoodsCode = cpse.GoodsCode;
            //        entProduct.Figure = cpse.Figure;
            //        entProduct.Specs = cpse.Specs;
            //        entProduct.Batch = Convert.ToString(row["Batch"]);
            //        entProduct.TreadWidth = cpse.TreadWidth;
            //        entProduct.FlatRatio = cpse.FlatRatio;
            //        entProduct.Meridian = "R";
            //        entProduct.HubDiameter = cpse.HubDiameter;
            //        entProduct.SpeedLevel = cpse.SpeedLevel;

            //        entProduct.LoadIndex = cpse.LoadIndex;
            //        entProduct.UnitPrice = Convert.ToDecimal(row["CostPrice"]);
            //        entProduct.CostPrice = Convert.ToDecimal(row["CostPrice"]);
            //        entProduct.TaxCostPrice = Convert.ToDecimal(row["CostPrice"]);
            //        entProduct.NoTaxCostPrice = Convert.ToDecimal(row["CostPrice"]);
            //        entProduct.Numbers =gd.Piece;
            //        entProduct.SalePrice = Convert.ToDecimal(row["ActSalePrice"]);
            //        entProduct.TradePrice = Convert.ToDecimal(row["ActSalePrice"]);
            //        entProduct.PackageNum = 0;
            //        entProduct.PackageWeight = 0;
            //        entProduct.Source = "9";
            //        entProduct.Born = "0";
            //        entProduct.BelongDepart = "1";
            //        entProduct.HouseID = HouseID;
            //        entProduct.Company = "1";
            //        entProduct.AreaID = containerEntity.AreaID;
            //        entProduct.ContainerID = containerEntity.ContainerID;
            //        entProduct.ContainerCode = containerEntity.ContainerCode;
            //        entProduct.InCargoID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//入库单号
            //        entProduct.BelongMonth = DateTime.Now.ToString("yyyyMM");
            //        entProduct.SourceOrderNo = DateTime.Now.ToString("yyyyMMddHHmmss");
            //        entProduct.Assort = "OER";
            //        entProduct.InHouseType = "0";
            //        entProduct.OrderNo = Convert.ToString(Request["OrderNo"]);
            //        entProduct.OPID = UserInfor.LoginName;
            //        entProduct.Supplier = Convert.ToString(Request["PurchaserName"]);

            //        entProduct.PurchaserID = Convert.ToInt32(Request["PurchaserID"]);
            //        entProduct.PurchaserName = Convert.ToString(Request["PurchaserName"]);
            //        entProduct.DeliveryBoss = Convert.ToString(Request["DeliveryBoss"]);
            //        entProduct.DeliveryAddress = Convert.ToString(Request["DeliveryAddress"]);
            //        PurchaserBoss = Convert.ToString(Request["PurchaserBoss"]);
            //        PurchaserCellphone = Convert.ToString(Request["PurchaserCellphone"]);
            //        PurchaserAddress = Convert.ToString(Request["PurchaserAddress"]);
            //        orderEnt.PurchaserBoss = Convert.ToString(Request["DeliveryBoss"]); 
            //        orderEnt.PurchaserAddress = Convert.ToString(Request["DeliveryAddress"]); 
            //        orderEnt.PurchaserCellphone = Convert.ToString(Request["DeliveryCellphone"]);
            //        productList.Add(entProduct);


            //        #region 订单详情
            //        entDest.Add(new CargoOrderGoodsEntity
            //        {
            //            OrderNo = orderEnt.OrderNo,
            //            HouseID = HouseID,
            //            TypeID = cpse.TypeID,
            //            Piece = gd.Piece,
            //            ActSalePrice = Convert.ToDecimal(row["ActSalePrice"]),
            //            Specs = cpse.Specs,
            //            Figure = cpse.Figure,
            //            GoodsCode = cpse.GoodsCode,
            //            Batch = Convert.ToString(row["Batch"]),
            //            LoadIndex = cpse.LoadIndex,
            //            SpeedLevel = cpse.SpeedLevel,
            //            Model = cpse.Model,
            //            Born = "0",
            //            CostPrice = Convert.ToDecimal(row["CostPrice"]),
            //            PurchaserID = Convert.ToInt32(Request["PurchaserID"]),
            //            PurchaserName = Convert.ToString(Request["PurchaserName"]),
            //            DeliveryBoss = Convert.ToString(Request["DeliveryBoss"]),
            //            DeliveryAddress = Convert.ToString(Request["DeliveryAddress"]),
            //            DeliveryCellphone = Convert.ToString(Request["DeliveryCellphone"]),
            //            OP_ID = UserInfor.LoginName.Trim()
            //        });
            //        pieceSum += gd.Piece;
            //        trFee += gd.Piece * Convert.ToDecimal(row["ActSalePrice"]);
            //        #endregion

            //        orderEnt.OutCargoID = outID;

            //    }

            //    orderEnt.Piece = pieceSum;
            //    orderEnt.OutHouseName = containerEntity.AreaName;
            //    orderEnt.TransportFee = trFee;
            //    orderEnt.TotalCharge = orderEnt.TransportFee + orderEnt.TransitFee + orderEnt.OtherFee - orderEnt.InsuranceFee;

            //    orderEnt.IsMakeSure = 0;
            //    orderEnt.PostponeShip = "1";
            //    orderEnt.AwbStatus = "0";
            //    orderEnt.OrderType = "0";
            //    orderEnt.HouseID = HouseID;
            //    orderEnt.HouseName = houseEnt.Name;
            //    orderEnt.goodsList = entDest;
            //    orderEnt.productsList = productList;
            //    orderEnt.ModifyPriceStatus = "0";

            //    orderEnt.PurchaseHouseID = HouseID;

            //    orderEnt.PurchaserID = Convert.ToString(Request["PurchaserID"]);
            //    orderEnt.PurchaserName = Convert.ToString(Request["PurchaserName"]);

            //    if (msg.Result)
            //    {
            //        //仓库同步缓存
            //        foreach (CargoContainerShowEntity time in outHouseList)
            //        {
            //            CargoProductEntity syncProduct = house.SyncTypeProduct(time.ProductID.ToString());
            //            //34 马牌  1 同步马牌  2 同步全部品牌
            //            if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
            //            {
            //                RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
            //            }
            //        }
            //        bus.AddPreOrderInfo(orderEnt, outHouseList, log);
            //        //msg.Message = ent.OrderNo + "/" + outID + "/" + ent.ModifyPriceStatus + "/" + 0;//订单号和出库单号
            //    }
            //}


            //返回处理结果
            string ress = JSON.Encode(msg);
            Response.Write(ress);
        }
        #endregion

        #region 开思订单

        /// <summary>
        /// 开思订单数据查询
        /// </summary>
        public void QueryCassMallOrder()
        {
            OrderHeader queryEntity = new OrderHeader();
            queryEntity.Buyer = new Buyer();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            queryEntity.OrderId = Convert.ToString(Request["orderCode"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["customerName"]))) { queryEntity.Buyer.CompanyName = Convert.ToString(Request["customerName"]); }

            queryEntity.receiverName = Convert.ToString(Request["consigneeName"]);
            if (Convert.ToString(Request["orderType"]) != "-1")
            {
                queryEntity.OrderTypeId = Convert.ToString(Request["orderType"]);
            }
            if (Convert.ToString(Request["orderLabel"]) != "-1")
            {
                queryEntity.SalesChannelEnumId = Convert.ToString(Request["orderLabel"]);
            }
            if (Convert.ToString(Request["InCreateStatus"]) != "-1")
            {
                queryEntity.InCreateStatus = Convert.ToString(Request["InCreateStatus"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["HouseID"])) && Convert.ToInt32(Request["HouseID"]) != 0)
            {
                queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoInterfaceBus bus = new CargoInterfaceBus();
            Hashtable list = bus.QueryCassMallOrder(pageIndex, pageSize, queryEntity);
            //if (list != null) { QueryOrderInfoList = list; }
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 开思订单详情数据查询
        /// </summary>
        public void QueryCassMallOrderGoods()
        {
            OrderHeader queryEntity = new OrderHeader();
            queryEntity.Buyer = new Buyer();
            queryEntity.OrderId = Convert.ToString(Request["OrderID"]);
            CargoInterfaceBus bus = new CargoInterfaceBus();
            List<OrderItem> list = bus.QueryCassMallOrderGoods(queryEntity);
            //if (list != null) { QueryOrderInfoList = list; }
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 开思订单详情数据查询
        /// </summary>
        public void QueryCassMallItemAdjustments()
        {
            OrderHeader queryEntity = new OrderHeader();
            queryEntity.Buyer = new Buyer();
            queryEntity.OrderId = Convert.ToString(Request["OrderID"]);
            CargoInterfaceBus bus = new CargoInterfaceBus();
            List<OrderItemAdjustment> list = bus.QueryCassMallItemAdjustments(queryEntity);
            //if (list != null) { QueryOrderInfoList = list; }
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        /// <summary>
        /// 开思赠品订单详情数据查询
        /// </summary>
        public void QueryCassMallGiftItems()
        {
            OrderHeader queryEntity = new OrderHeader();
            queryEntity.Buyer = new Buyer();
            queryEntity.OrderId = Convert.ToString(Request["OrderID"]);
            CargoInterfaceBus bus = new CargoInterfaceBus();
            List<OrderGiftItem> list = bus.QueryCassMallGiftItems(queryEntity);
            //if (list != null) { QueryOrderInfoList = list; }
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        public void SaveCassMallOrder()
        {
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            //List<saleOpenInfoResp> result = new List<saleOpenInfoResp>();
            var rows = JsonConvert.DeserializeObject<List<OrderHeader>>(json);


            string ClientNum = Convert.ToString(Request["ClientNum"]);
            string AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            if (string.IsNullOrEmpty(ClientNum))
            {
                msg.Result = false;
                msg.Message = "请选择客户数据";
                goto ERROR;
            }
            int HouseID = Convert.ToInt32(Request["HouseID"]);//传入区域大仓ID
            int AreaID = Convert.ToInt32(Request["AreaID"]);//传入仓库ID

            string Dest = Convert.ToString(Request["Dest"]);//传入仓库ID
            string AcceptAddress = Convert.ToString(Request["AcceptAddress"]).Replace("?", "");//
            string SaleManID = Convert.ToString(Request["SaleManID"]);//
            string SaleManName = Convert.ToString(Request["SaleManName"]);//
            string SaleCellPhone = Convert.ToString(Request["SaleCellPhone"]);//
            int ABatch = string.IsNullOrEmpty(Convert.ToString(Request["ABatch"])) ? 0 : Convert.ToInt32(Request["ABatch"]);//
            string Remark = Convert.ToString(Request["Remark"]);//
                                                                //保存生成仓库订单
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "生成开思仓库订单";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";

            var result_ = CassCreateOrder(rows, new CargoOrderEntity
            {
                AreaID = AreaID,
                HouseID = HouseID,
                ClientNum = Convert.ToInt32(ClientNum),
                AcceptPeople = AcceptPeople
            ,
                Dest = Dest,
                AcceptAddress = AcceptAddress,
                SaleManID = SaleManID,
                SaleManName = SaleManName,
                SaleCellPhone = SaleCellPhone,
                BatchWeekFilter = ABatch,
                Remark = Remark
            }, msg, log);
            if (!result_.Result) goto ERROR;
            else
            {
                //string res_ = JSON.Encode(msg);
                //Response.Write(res_);
            }
        ERROR:
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        #region 开思

        public ErrMessage CassCreateOrder(List<OrderHeader> rows, CargoOrderEntity order_, ErrMessage msg, LogEntity log)
        {
            CargoHouseBus bus = new CargoHouseBus();
            CargoClientBus clientBus = new CargoClientBus();
            CargoInterfaceBus interfaceBus = new CargoInterfaceBus();
            CargoOrderBus orderBus = new CargoOrderBus();

            var UserByDepCode = orderBus.GetSysUsers();
            Dictionary<long, int> batchDic = new Dictionary<long, int>();

            //var ProductMappingList = interfaceBus.GetProductMapping(new OrderItem());
            decimal originalPrice = 0M;
            foreach (var row in rows)
            {
                if (row.InCreateStatus.Equals("1"))
                {
                    msg.Result = false;
                    msg.Message = "订单：" + row.OrderId + "已生成";
                    goto ERROR;
                }

                var goods = interfaceBus.QueryCassMallOrderGoods(new OrderHeader { OrderId = row.OrderId });
                var Adjustments = interfaceBus.QueryCassMallItemAdjustments(new OrderHeader { OrderId = row.OrderId });
                var GiftItems = interfaceBus.QueryCassMallGiftItems(new OrderHeader { OrderId = row.OrderId });

                CargoOrderEntity ent = new CargoOrderEntity();
                List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
                List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();

                CargoHouseEntity houseEnt = bus.QueryCargoHouseByID(row.HouseID);
                CargoAreaEntity areaEntity = bus.QueryAreaByAreaID(new CargoAreaEntity { AreaID = order_.AreaID });

                var userDep = UserByDepCode.FirstOrDefault(a => a.LoginName == order_.SaleManID);
                if (userDep == null)
                {
                    msg.Result = false; msg.Message = "未找到业务员"; goto ERROR;
                }
                ////test
                //areaEntity.HouseID = 98;

                CargoClientEntity clientEntity = clientBus.QueryCargoClient(Convert.ToInt32(order_.ClientNum), 0);

                decimal OverDayFee = 0.00M;//超期费用

                if (areaEntity.AreaID.Equals(0))
                {
                    //写日志 没有配置仓库
                    msg.Result = false;
                    msg.Message = "无出库仓库";
                    goto ERROR;
                }
                ent.OpenOrderNo = row.OrderId;
                ent.OpenOrderSource = "2";//开思订单
                ent.Dep = areaEntity.OrderDep;
                ent.Dest = order_.Dest;
                int OrderNum = 0;
                ent.HouseID = areaEntity.HouseID;
                ent.LogisID = areaEntity.LogisID;
                ent.Rebate = 0;
                ent.CheckOutType = clientEntity.CheckOutType;// "5";//Convert.ToString(row["CheckOutType"]);
                                                             //ent.ReturnAwb = string.IsNullOrEmpty(Convert.ToString(row["ReturnAwb"])) ? 0 : Convert.ToInt32(row["ReturnAwb"]);
                ent.TrafficType = "0";// Convert.ToString(row["TrafficType"]);
                ent.DeliveryType = "0";//Convert.ToString(row["DeliveryType"]);
                ent.AcceptUnit = clientEntity.ClientName;//Convert.ToString(row["AcceptUnit"]);取公司名称
                ent.AcceptAddress = order_.AcceptAddress;
                ent.AcceptPeople = order_.AcceptPeople;
                ent.AcceptTelephone = row.ContactNumber;
                ent.AcceptCellphone = row.ContactNumber;
                ent.CreateAwb = UserInfor.UserName;//好来运系统
                ent.CreateAwbID = UserInfor.LoginName;
                ent.CreateDate = DateTime.Now;
                ent.OP_ID = UserInfor.LoginName;
                ent.SaleManID = userDep?.LoginName; //clientEntity.UserID;// 业务员ID
                ent.SaleManName = userDep?.UserName; //clientEntity.UserName;// 业务员姓名
                ent.SaleCellPhone = order_.SaleCellPhone;
                ent.Remark = order_.Remark;
                //ent.CouponID = string.IsNullOrEmpty(CouponID) ? 0 : Convert.ToInt64(CouponID);
                //ent.CouponIDList = couponIDList;
                ent.ThrowGood = "22";
                ent.BusinessID = "22";
                ent.MarketType = "2";
                ent.IsPrintPrice = 1;
                ent.TranHouse = "";
                ent.PostponeShip = "1";
                ent.ClientNum = clientEntity.ClientNum;
                ent.PayClientNum = clientEntity.ClientNum;
                ent.PayClientName = clientEntity.Boss;//付款人客户姓名
                //ent.ClientID = wxUser.ClientID;
                string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(ent.HouseID, houseEnt.HouseCode, out OrderNum); // Convert.ToString(row["OrderNo"]);//生成最新顺序订单号
                ent.OutHouseName = houseEnt.Name;
                ent.OrderType = "4";
                ent.AwbStatus = "0";

                int pieceSum = 0;
                string proStr = string.Empty;
                var AdjustmentsSum = 0M;//优惠卷
                foreach (var itt in goods)
                {
                    pieceSum += Convert.ToInt32(itt.Quantity);
                    int piece = Convert.ToInt32(itt.Quantity);

                    var AdjustmentsCurrItemSum = 0M;
                    //优惠卷
                    var AdjustmentsItems = Adjustments.Where(a => a.OrderItemSeqId == itt.OrderItemSeqId).ToList();
                    if (AdjustmentsItems != null && AdjustmentsItems.Count > 0)
                    {
                        var AdjustmentsSums = AdjustmentsItems.Sum(a => a.AdjustmentAmount);
                        AdjustmentsSum += Convert.ToDecimal(AdjustmentsSums) * piece;
                        AdjustmentsCurrItemSum = Convert.ToDecimal(AdjustmentsSums);
                    }

                    //查找系统对应产品编码
                    List<CargoProductEntity> cargos = new List<CargoProductEntity>();

                    //var pmappings = ProductMappingList.Where(c => c.CassCode == itt.PartsNum).ToList();
                    if (itt.BrandName == "马牌" || itt.BrandName == "维京")
                    {
                        var data = bus.QueryProductDataBasic(new CargoProductEntity { GoodsCode = itt.PartsNum });
                        cargos = data;
                    }
                    else
                    {
                        var data = interfaceBus.GetProductMapping(new OrderItem() { PartsNum = itt.PartsNum });
                        cargos = data.Select(a => new CargoProductEntity { ProductCode = a.ProductCode, TypeID = a.TypeID, ParentID = a.ParentID }).ToList();
                    }
                    if (cargos.Count == 0) { msg.Result = false; msg.Message = "未获取到对应商品信息"; goto ERROR; }

                    List<CargoInterfaceEntity> stockList = new List<CargoInterfaceEntity>();
                    //List<CargoProductEntity> productBasic = bus.QueryProductDataBasic(new CargoProductEntity { ProductCodeStr = $@"'{string.Join("','", cargos.Select(a => a.ProductCode))}'" });
                    //if (productBasic.Count <= 0)
                    //{
                    //    msg.Result = false; msg.Message = "商品基础数据有误"; goto ERROR;
                    //}
                    //周期年 ItemDescription
                    var BatchYear = 0;
                    var BatchWeek = 0;
                    var YearArr = itt.ItemDescription.Split(' ');
                    if (YearArr.Length > 1)
                    {
                        var Year = ExtractYear(YearArr[YearArr.Length - 1]);
                        //判断Year是不是数值
                        if (IsNumber(Year))
                        {
                            if (Year.Length == 4)
                            {
                                BatchYear = Convert.ToInt32(Year.Substring(Year.Length - 2));
                            }
                            else if (Year.Length == 2)
                            {
                                BatchYear = Convert.ToInt32(Year);
                            }
                            else
                            {
                                msg.Result = false; msg.Message = $@"【订单名称】批次获取失败:【{YearArr[YearArr.Length - 1]}】"; goto ERROR;
                            }
                        }
                        //else
                        //{
                        //    msg.Result = false; msg.Message = $@"【订单名称】批次获取失败:【{YearArr[YearArr.Length - 1]}】"; goto ERROR;
                        //}
                    }
                    BatchWeek = order_.BatchWeekFilter;

                    CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                    {
                        //ProductCode = item.ProductCode,
                        ProductCodeStr = $@"{string.Join("','", cargos.Select(a => a.ProductCode).Distinct())}",
                        HouseID = areaEntity.HouseID,
                        TypeID = cargos[0].TypeID,
                        BatchYear = BatchYear,
                        ParentID = cargos[0].ParentID,
                        SpecsType = "4",
                        BatchWeekFilter = BatchWeek,
                        //Regular = PromotionType,
                        //SuppClientNum = SuppClientNum,
                    };
                    stockList.AddRange(interfaceBus.queryCargoStock(queryEntity));
                    //batchDic
                    if (batchDic.Count > 0)
                    {
                        foreach (var item in stockList)
                        {
                            if (batchDic.ContainsKey(item.ProductID))
                            {
                                var sku = batchDic[item.ProductID];
                                item.StockNum -= sku;
                            }
                        }
                    }
                    //排除库存小于等于0的
                    stockList = stockList.Where(a => a.StockNum > 0).OrderBy(a => a.Batch).ThenBy(p => Math.Abs(p.StockNum - piece)).ToList();
                    //多供应商 特殊处理
                    var SuitClientCount = stockList.GroupBy(a => a.SuppClientNum).Select(a => new CargoInterfaceEntity
                    {
                        SuppClientNum = a.Key,
                        StockNum = a.Sum(aa => aa.StockNum)
                    }).ToList();
                    if (SuitClientCount.Count > 1)
                    {
                        bool IsOk = false;
                        foreach (var item in SuitClientCount)
                        {
                            if (item.StockNum >= piece)
                            {
                                stockList = stockList.Where(a => a.SuppClientNum == item.SuppClientNum).OrderBy(a => a.Batch).ThenBy(p => Math.Abs(p.StockNum - piece)).ToList();
                                IsOk = true;
                                break;
                            }
                        }
                        if (!IsOk)
                        {
                            msg.Result = false; msg.Message = "商品库存不足"; goto ERROR;
                        }
                    }



                    if (stockList.Count <= 0)
                    {
                        msg.Result = false; msg.Message = "商品库存不足"; goto ERROR;
                    }
                    if (stockList.Sum(c => c.StockNum) < piece)
                    {
                        msg.Result = false; msg.Message = "库存不足"; goto ERROR;
                    }

                    //减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                    foreach (var it in stockList)
                    {
                        if (it.StockNum <= 0) { continue; }
                        if (!it.ShareHouseID.Equals(0))
                        {
                            ent.ShareHouseID = it.ShareHouseID;
                            ent.ShareHouseName = it.ShareHouseName;
                        }

                        CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                        cargo.OrderNo = ent.OrderNo;//订单号
                        cargo.OutCargoID = outID;
                        cargo.ContainerID = it.ContainerID;
                        cargo.TypeID = it.TypeID;
                        cargo.ProductID = it.ProductID;

                        cargo.ID = it.ContainerGoodsID;//库存表ID

                        //cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                        cargo.HouseName = houseEnt.Name;
                        //cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                        cargo.ProductName = it.ProductName;
                        cargo.Model = it.Model;
                        cargo.Specs = it.Specs;
                        cargo.Figure = it.Figure;
                        int inHouseDay = (int)(DateTime.Now - it.InHouseTime).TotalDays;
                        int OverDay = 0;
                        decimal OnlyOverDayFee = 0;
                        //decimal OverDayFee = 0.00M;//超期费用

                        ent.SuppClientNum = Convert.ToInt32(it.SuppClientNum);

                        #region 减库存逻辑
                        if (piece < it.StockNum)
                        {
                            if (inHouseDay > row.OverDayNum)
                            {
                                //如果在库天数大于了用户设置的天数，则按照超期天数计算超期费用
                                OverDay = inHouseDay - row.OverDayNum;
                                OnlyOverDayFee = OverDay * row.OverDueUnitPrice * piece;
                                OverDayFee += OnlyOverDayFee;
                            }
                            //部分出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = piece,
                                //ActSalePrice = it.SalePrice,
                                ActSalePrice = itt.ActualPrice + AdjustmentsCurrItemSum,
                                SupplySalePrice = it.InHousePrice,
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                RuleID = "0",
                                RuleTitle = "",
                                RuleType = "",
                                OP_ID = log.UserID,
                                OverDayNum = OverDay,
                                OverDueFee = OnlyOverDayFee,
                            });

                            cargo.Piece = piece;
                            cargo.InPiece = it.StockNum;
                            originalPrice += piece * it.InHousePrice;//计算成本价
                            outHouseList.Add(cargo);

                            if (batchDic.ContainsKey(it.ProductID))
                                batchDic[it.ProductID] = batchDic[it.ProductID] += piece;
                            else
                                batchDic[it.ProductID] = piece;

                            break;
                        }
                        if (piece.Equals(it.StockNum))
                        {
                            if (inHouseDay > row.OverDayNum)
                            {
                                //如果在库天数大于了用户设置的天数，则按照超期天数计算超期费用
                                OverDay = inHouseDay - row.OverDayNum;
                                OnlyOverDayFee = OverDay * row.OverDueUnitPrice * piece;
                                OverDayFee += OnlyOverDayFee;
                            }
                            //要出库件数和第一条库存件数刚刚好，则就全部出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = piece,
                                //ActSalePrice = it.SalePrice,
                                SupplySalePrice = it.InHousePrice,
                                ActSalePrice = itt.ActualPrice + AdjustmentsCurrItemSum,
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                RuleID = "0",
                                RuleTitle = "",
                                RuleType = "",
                                OP_ID = log.UserID,
                                OverDayNum = OverDay,
                                OverDueFee = OnlyOverDayFee,
                            });
                            cargo.Piece = piece;
                            cargo.InPiece = it.StockNum;
                            originalPrice += piece * it.InHousePrice;//计算成本价

                            outHouseList.Add(cargo);

                            if (batchDic.ContainsKey(it.ProductID))
                                batchDic[it.ProductID] = batchDic[it.ProductID] += piece;
                            else
                                batchDic[it.ProductID] = piece;

                            break;
                        }
                        if (piece > it.StockNum)
                        {
                            if (inHouseDay > row.OverDayNum)
                            {
                                //如果在库天数大于了用户设置的天数，则按照超期天数计算超期费用
                                OverDay = inHouseDay - row.OverDayNum;
                                OnlyOverDayFee = OverDay * row.OverDueUnitPrice * it.StockNum;
                                OverDayFee += OnlyOverDayFee;
                            }
                            //全部出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = it.StockNum,
                                //ActSalePrice = it.SalePrice,
                                SupplySalePrice = it.InHousePrice,
                                ActSalePrice = itt.ActualPrice + AdjustmentsCurrItemSum,
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                RuleID = "0",
                                RuleTitle = "",
                                RuleType = "",
                                OP_ID = log.UserID,
                                OverDayNum = OverDay,
                                OverDueFee = OnlyOverDayFee,
                            });
                            cargo.Piece = it.StockNum;
                            cargo.InPiece = it.StockNum;
                            originalPrice += it.StockNum * it.InHousePrice;//计算成本价
                            outHouseList.Add(cargo);
                            piece = piece - it.StockNum;
                            if (batchDic.ContainsKey(it.ProductID))
                                batchDic[it.ProductID] = batchDic[it.ProductID] += it.StockNum;
                            else
                                batchDic[it.ProductID] = it.StockNum;
                            continue;
                        }
                        #endregion
                    }
                }

                //订单总数量
                ent.Piece = Convert.ToInt32(pieceSum);
                ent.Weight = 0;
                ent.Volume = 0;
                ent.InsuranceFee = AdjustmentsSum;// coupon.Money;//优惠券金额 
                ent.TransitFee = Convert.ToDecimal(row.FeeAmount);//配送费
                ent.TransportFee = originalPrice;//销售收入
                ent.OverDueFee = OverDayFee;//超期费用
                                            //ent.TransportFee = Convert.ToDecimal(YPOrderMoney);//订单的费用
                ent.DeliveryFee = 0;
                ent.OtherFee = Convert.ToDecimal(row.Amount) - ent.TransitFee - ent.TransportFee + ent.InsuranceFee;//平台服服务费=总金额-配送费-销售金额+优惠券
                ent.TotalCharge = Convert.ToDecimal(row.Amount);

                //ent.CouponType = CouponType;
                ent.OrderNum = OrderNum;//最新订单顺序号
                ent.goodsList = entDest;
                ent.FinanceSecondCheck = "1";
                ent.FinanceSecondCheckName = clientEntity.ClientName;
                ent.FinanceSecondCheckDate = DateTime.Now;
                ent.CheckStatus = "1";
                ent.OutCargoTime = DateTime.Now;
                ent.CheckDate = DateTime.Now;
                ent.OrderModel = "0";
                //ent.SuppClientNum = Convert.ToInt32(SuppClientNum);
                //ent.WXOrderNo = orderno;//微信商城订单号

                //仓库同步缓存
                foreach (CargoContainerShowEntity time in outHouseList)
                {
                    CargoProductEntity syncProduct = bus.SyncTypeProduct(time.ProductID.ToString());
                    //34 马牌  1 同步马牌  2 同步全部品牌
                    if (syncProduct.SyncType == "2" || (syncProduct.SyncType == "1" && syncProduct.TypeID == 34))
                    {
                        RedisHelper.HashSet("OpenSystemStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.GoodsCode);
                    }

                    //主仓缓存更改
                    if (bus.IsAddCaching(syncProduct.HouseID, time.TypeID))
                    {
                        RedisHelper.HashSet("HCYCHouseStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                    }
                }

                //保存生成仓库出库订单
                orderBus.AddOrderInfo(ent, outHouseList, log);

                if (ent.CheckOutType != null)
                {
                    #region 推送好来运系统

                    if (ent.HouseID.Equals(93))
                    {
                        //内部订单 || ent.HouseID.Equals(98)
                        orderBus.SaveHlyOrderData(outHouseList, ent);
                    }
                    else
                    {
                        orderBus.InsertCargoOrderPush(new CargoOrderPushEntity
                        {
                            OrderNo = ent.OrderNo,
                            Dep = ent.Dep,
                            Dest = ent.Dest,
                            Piece = ent.Piece,
                            TransportFee = ent.TransportFee,
                            ClientNum = ent.ClientNum.ToString(),
                            AcceptAddress = ent.AcceptAddress,
                            AcceptCellphone = ent.AcceptCellphone,
                            AcceptTelephone = ent.AcceptTelephone,
                            AcceptPeople = ent.AcceptPeople,
                            AcceptUnit = ent.AcceptUnit,
                            HouseID = ent.HouseID.ToString(),
                            HouseName = ent.OutHouseName,
                            OP_ID = log.UserID,
                            PushType = "0",
                            PushStatus = "0",
                            LogisID = ent.LogisID
                        }, log);
                    }

                    #endregion

                    string fkfs = ent.CheckOutType.Equals("3") ? "货到付款" : ent.CheckOutType.Equals("10") ?"预付款": "现付";
                    string shf = ent.LogisID.Equals(46) ? "自提" : ent.DeliveryType.Equals("0") ? "急送" : "次日达";
                    string tit = ent.ThrowGood.Equals("22") ? ent.DeliveryType.Equals("2") ? "次日达" : "急速达" : "次日达";
                    string go = ent.ThrowGood.Equals("22") ? (ent.DeliveryType.Equals("2") ? "" : "") : "-不出库";
                    CargoNewOrderNoticeEntity cargoNewOrder = new CargoNewOrderNoticeEntity();
                    cargoNewOrder.HouseName = houseEnt.Name;
                    cargoNewOrder.OrderNo = ent.WXOrderNo;
                    cargoNewOrder.OrderNum = ent.Piece.ToString();
                    cargoNewOrder.ClientInfo = ent.AcceptPeople + " " + ent.AcceptCellphone + " " + ent.AcceptAddress;// "泰乐 华笙 广东省广州市白云区东平加油站左侧";
                    cargoNewOrder.ProductInfo = proStr;// "马牌 215/55R16 CC6 98V";
                    cargoNewOrder.DeliveryName = shf;// "自提";
                    cargoNewOrder.ReceivePeople = "";
                    string hcno = JSON.Encode(cargoNewOrder);
                    //Common.WriteTextLog(hcno);
                    List<CargoVoiceBroadEntity> voiceBroadList = bus.GetVoiceBroadList(new CargoVoiceBroadEntity { HouseID = houseEnt.HouseID });
                    foreach (var voice in voiceBroadList)
                    {
                        RedisHelper.SetString("NewOrderNotice_" + voice.LoginName, hcno);
                        //mc.Add("NewOrderNotice_" + voice.LoginName, hcno);
                    }

                    //mc.Add("NewOrderNotice_1000", hcno);
                    //mc.Add("NewOrderNotice_2215", hcno);
                    //mc.Add("NewOrderNotice_2856", hcno);

                    //RedisHelper.SetString("NewOrderNotice", hcno);
                    //货到付款
                    //try
                    //{
                    //    QySendInfoEntity send = new QySendInfoEntity();
                    //    send.title = tit + " 有新订单";
                    //    //推送给提交人
                    //    send.msgType = msgType.textcard;
                    //    send.agentID = "1000003";//消息通知的应用
                    //    send.AgentSecret = "VkkRCESh5hxT8FStrYa0jWjIg0ux--M670SoFFyuimM";
                    //    //send.toUser = qup.ApplyID;<div>订单金额：" + ord.TotalCharge.ToString("F2") + "</div>
                    //    //send.toTag = "19";
                    //    send.toTag = houseEnt.HCYCOrderPushTagID.ToString();
                    //    send.content = "<div></div><div>出库仓库：" + houseEnt.Name + go + "</div><div>商城订单号：" + ent.WXOrderNo + "</div><div>出库订单号：" + ent.OrderNo + "</div><div>订单数量：" + ent.Piece.ToString() + "</div><div>订单金额：" + ent.TotalCharge.ToString("F2") + "</div><div>货物信息：" + proStr + "</div><div>付款方式：" + fkfs + "</div><div>送货方式：" + shf + "</div><div>门店名称：" + ent.AcceptUnit + "</div><div>收货信息：" + ent.AcceptPeople + " " + ent.AcceptCellphone + "</div><div>收货地址：" + ent.AcceptAddress + "</div><div>请仓管人员留意尽快出库！</div>";
                    //    send.url = "http://dlt.neway5.com/QY/qyScanOrderSign.aspx?OrderNo=" + ent.OrderNo;
                    //    WxQYSendHelper.DLTQYPushInfo(send);

                    //}
                    //catch (ApplicationException ex)
                    //{

                    //}
                    //msg.Message = "提交成功，请收到货后在我的订单里支付货款";
                    msg.Message = "提交成功";
                }
                else if (ent.CheckOutType.Equals("6"))
                {
                    msg.Message = "提交成功";
                }
            }
            return msg;
        ERROR:
            //返回处理结果
            return msg;
        }
        public static int GetWeekOfYear(string dateStr)
        {
            var date = Convert.ToDateTime(dateStr);
            // 使用 ISO 8601 标准（周一为一周的第一天）
            var culture = CultureInfo.CurrentCulture;
            CalendarWeekRule weekRule = culture.DateTimeFormat.CalendarWeekRule;
            DayOfWeek firstDayOfWeek = culture.DateTimeFormat.FirstDayOfWeek;

            return culture.Calendar.GetWeekOfYear(date, weekRule, firstDayOfWeek);
        }

        public static string ExtractYear(string str)
        {
            if (string.IsNullOrWhiteSpace(str))
                return null;

            // 匹配连续的2位或4位年份数字，通常在字符串末尾
            var match = Regex.Match(str, @"(\d{2,4})\s*(年|上半年|下半年|年上半年|年下半年)?$");
            if (match.Success)
            {
                return match.Groups[1].Value;
            }

            return null;
        }

        public static int ContainsString(string sourceStr)
        {
            if (string.IsNullOrWhiteSpace(sourceStr))
                return 0;

            if (sourceStr.Contains("上半年"))
                return 1;

            if (sourceStr.Contains("下半年"))
                return 2;

            return 0;
        }

        #endregion
        #endregion

        public void QueryTypeData()
        {
            CargoOrderBus bus = new CargoOrderBus();
            var list = bus.QueryTypeData();

            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        public void QueryCassMallHouse()
        {
            CargoOrderBus bus = new CargoOrderBus();
            var list = bus.QueryCassMallHouse();

            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        #region 预订单

        public void QueryReserveOrder()
        {
            ReserveCargoOrderEntity queryEntity = new ReserveCargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["Piece"]))) { queryEntity.Piece = Convert.ToInt32(Request["Piece"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.LogisAwbNo = Convert.ToString(Request["LogisAwbNo"]);
            queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])))
            {
                queryEntity.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
            }
            queryEntity.PayClientName = Convert.ToString(Request["PayClientName"]);
            queryEntity.Dep = Convert.ToString(Request["Dep"]);
            queryEntity.Dest = Convert.ToString(Request["Dest"]);
            queryEntity.CreateAwb = Convert.ToString(Request["CreateAwb"]);
            queryEntity.HAwbNo = Convert.ToString(Request["HAwbNo"]);
            queryEntity.OutHouseName = Convert.ToString(Request["OutHouseName"]);
            if (Convert.ToString(Request["OpenOrderSource"]) != "-1")
            {
                queryEntity.OpenOrderSource = Convert.ToString(Request["OpenOrderSource"]);
            }
            if (Convert.ToString(Request["OrderType"]) != "-1")
            {
                queryEntity.OrderType = Convert.ToString(Request["OrderType"]);
            }
            if (Convert.ToString(Request["AwbStatus"]) != "-1")
            {
                queryEntity.AwbStatus = Convert.ToString(Request["AwbStatus"]);
            }
            if (Convert.ToString(Request["FinanceSecondCheck"]) != "-1")
            {
                queryEntity.FinanceSecondCheck = Convert.ToString(Request["FinanceSecondCheck"]);
            }
            if (Convert.ToString(Request["CheckStatus"]) != "-1")
            {
                queryEntity.CheckStatus = Convert.ToString(Request["CheckStatus"]);
            }
            //ueryEntity.CheckOutType = Convert.ToString(Request["CheckOutType"]);
            //queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            queryEntity.SaleManID = Convert.ToString(Request["SaleManID"]);
            if (Convert.ToString(Request["OrderModel"]) != "-1")
            {
                queryEntity.OrderModel = Convert.ToString(Request["OrderModel"]);
            }
            if (Convert.ToString(Request["ThrowGood"]) != "-1")
            {
                queryEntity.ThrowGood = Convert.ToString(Request["ThrowGood"]);
            }
            //2021-01-21 添加公司类型查询条件
            if (Convert.ToString(Request["BelongHouse"]) != "-1")
            {
                queryEntity.BelongHouse = Convert.ToString(Request["BelongHouse"]);
            }
            //2021-01-30 添加客户名称查询条件
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            //if (!string.IsNullOrEmpty(Request["FirstID"]))//一级仓库
            //{
            //    queryEntity.FirstAreaID = Convert.ToInt32(Request["FirstID"]);
            //}

            //2021-10-20 添加出库类型查询条件
            if (Convert.ToString(Request["OutCargoType"]) != "-1")
            {
                queryEntity.OutCargoType = Convert.ToString(Request["OutCargoType"]);
            }
            //2021-10-25 添加推送类型查询条件
            if (Convert.ToString(Request["PostponeShip"]) != "-1")
            {
                queryEntity.PostponeShip = Convert.ToString(Request["PostponeShip"]);
            }
            if (Convert.ToString(Request["TrafficType"]) != "-1")
            {
                queryEntity.TrafficType = Convert.ToString(Request["TrafficType"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["LineID"])))
            {
                queryEntity.LineID = Convert.ToInt32(Request["LineID"]);
            }
            queryEntity.ShopCode = Convert.ToString(Request["ShopCode"]);
            if (!string.IsNullOrEmpty(Request["SuppClientNum"]))//一级分类
            {
                queryEntity.SuppClientNum = Convert.ToInt32(Request["SuppClientNum"]);//所属仓库ID
            }
            if (!string.IsNullOrEmpty(Request["BusinessID"]))//业务名称
            {
                queryEntity.BusinessID = Convert.ToString(Request["BusinessID"]);//业务名称
            }

            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoOrderBus bus = new CargoOrderBus();
            var list = bus.QueryReserveOrder(pageIndex, pageSize, queryEntity);

            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }

        #endregion
    }
}