using System;
using System.Collections.Generic;
using System.Data;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace House.Manager.Common
{
    public static class Common
    {
        /// <summary>
        /// 遍历DataTable，null转换
        /// </summary>
        /// <param name="dataTable"></param>
        public static void ReplaceDBNullWithDefault(this DataTable dataTable)
        {
            // 遍历所有行
            foreach (DataRow row in dataTable.Rows)
            {
                // 遍历所有列 
                foreach (DataColumn column in dataTable.Columns)
                {
                    // 检查是否为 DBNull
                    if (row[column] == DBNull.Value)
                    {
                        // 根据列数据类型替换
                        switch (Type.GetTypeCode(column.DataType))
                        {
                            case TypeCode.String:
                                row[column] = string.Empty;  // 字符串替换为空
                                break;
                            case TypeCode.DateTime:
                                row[column] = DateTime.MinValue;  // 字符串替换为空
                                break;
                            case TypeCode.Int32:
                            case TypeCode.Int64:
                            case TypeCode.Double:
                            case TypeCode.Decimal:
                                row[column] = 0;  // 数值类型替换为0
                                break;
                            // 其他类型可扩展
                            default:
                                row[column] = string.Empty;  // 默认替换为空 
                                break;
                        }
                    }
                }
            }
        }

        public static void WriteTextLog(string strMessage)
        {
            string path = AppDomain.CurrentDomain.BaseDirectory + @"System\Log\";
            if (!Directory.Exists(path))
                Directory.CreateDirectory(path);

            string fileFullPath = path + DateTime.Now.ToString("yyyy-MM-dd") + ".System.txt";
            StringBuilder str = new StringBuilder();
            str.Append("Time:    " + DateTime.Now.ToString() + "\r\n");
            str.Append("Message: " + strMessage + "\r\n");
            str.Append("-----------------------------------------------------------\r\n\r\n");
            StreamWriter sw;
            if (!File.Exists(fileFullPath))
            {
                sw = File.CreateText(fileFullPath);
            }
            else
            {
                sw = File.AppendText(fileFullPath);
            }
            sw.WriteLine(str.ToString());
            sw.Close();
        }
    }
    /// <summary>
    /// 通用比较器（支持按多个属性去重）
    /// </summary>
    /// <typeparam name="T">要比较的类型</typeparam>
    public class GenericEqualityComparer<T> : IEqualityComparer<T>
    {
        private readonly Func<T, object>[] _keySelectors;

        /// <summary>
        /// 构造一个通用比较器
        /// </summary>
        /// <param name="keySelectors">指定用于比较的属性选择器（如 p => p.Id, p => p.Name）</param>
        public GenericEqualityComparer(params Func<T, object>[] keySelectors)
        {
            _keySelectors = keySelectors ?? throw new ArgumentNullException(nameof(keySelectors));
        }

        public bool Equals(T x, T y)
        {
            if (ReferenceEquals(x, y)) return true;
            if (x == null || y == null) return false;

            foreach (var selector in _keySelectors)
            {
                var keyX = selector(x);
                var keyY = selector(y);

                if (!Equals(keyX, keyY))
                    return false;
            }

            return true;
        }

        public int GetHashCode(T obj)
        {
            if (obj == null) return 0;

            unchecked // 防止溢出
            {
                int hash = 17;
                foreach (var selector in _keySelectors)
                {
                    var key = selector(obj);
                    hash = hash * 31 + (key?.GetHashCode() ?? 0);
                }
                return hash;
            }
        }
    }

}
