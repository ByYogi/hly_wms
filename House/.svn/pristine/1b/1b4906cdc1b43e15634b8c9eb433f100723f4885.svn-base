using House.Entity.Cargo;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using House.Business.Cargo;

namespace Cargo.House
{
    public partial class OuthouseManager : BasePage
    {
        /// <summary>
        /// 库存数据导出实体
        /// </summary>
        public List<CargoContainerShowEntity> StockData
        {
            get
            {
                if (Session["StockData"] == null)
                {
                    Session["StockData"] = new List<CargoContainerShowEntity>();
                }
                return (List<CargoContainerShowEntity>)(Session["StockData"]);
            }
            set
            {
                Session["StockData"] = value;
            }
        }
        /// <summary>
        /// 库存数据导出类型实体
        /// </summary>
        public string StockDataType
        {
            get
            {
                if (Session["StockDataType"] == null)
                {
                    Session["StockDataType"] = "";
                }
                return (string)(Session["StockDataType"]);
            }
            set
            {
                Session["StockDataType"] = value;
            }
        }
        protected void Page_Load(object sender, EventArgs e)
        {

        }

        /// <summary>
        /// 导出
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="e"></param>
        protected void btnDerived_Click(object sender, EventArgs e)
        {
            string RoleName = UserInfor.RoleCName;
            if (StockData.Count <= 0) { return; }
            //if (string.IsNullOrEmpty(StockDataType)) { return; }
            CargoProductBus bus = new CargoProductBus();
            List<CargoProductSourceEntity> list = bus.QueryAllProductSource();
            if (StockDataType == "47")
            {
                string tname = string.Empty;
                DataTable table = new DataTable();
                table.Columns.Add("序号", typeof(int));
                table.Columns.Add("产品名称", typeof(string));
                table.Columns.Add("规格", typeof(string));
                table.Columns.Add("产品类型", typeof(string));
                table.Columns.Add("富添盛编码", typeof(string));
                table.Columns.Add("祺航编码", typeof(string));
                table.Columns.Add("商贸编码", typeof(string));
                table.Columns.Add("长和编码", typeof(string));
                table.Columns.Add("批次", typeof(string));
                table.Columns.Add("库存数量", typeof(int));
                table.Columns.Add("门店价", typeof(string));
                table.Columns.Add("货位代码", typeof(string));
                table.Columns.Add("所在区域", typeof(string));
                table.Columns.Add("一级区域", typeof(string));
                table.Columns.Add("所在仓库", typeof(string));
                table.Columns.Add("产品来源", typeof(string));
                int i = 0;
                foreach (var it in StockData)
                {
                    i++;
                    DataRow newRows = table.NewRow();
                    newRows["序号"] = i;
                    newRows["产品名称"] = it.ProductName.Trim();
                    newRows["规格"] = it.Specs.Trim();
                    newRows["产品类型"] = it.TypeName.Trim();
                    newRows["富添盛编码"] = it.GoodsCode.Trim();
                    newRows["祺航编码"] = it.Size.Trim();
                    newRows["商贸编码"] = it.Model.Trim();
                    newRows["长和编码"] = it.Figure;
                    newRows["批次"] = it.Batch;
                    newRows["库存数量"] = it.Piece;
                    newRows["门店价"] = it.TradePrice;
                    newRows["货位代码"] = it.ContainerCode;
                    newRows["所在区域"] = it.AreaName;
                    newRows["一级区域"] = it.ParentAreaName;
                    newRows["所在仓库"] = it.FirstAreaName;
                    newRows["产品来源"] = GetSoureName(list, Convert.ToInt32(it.Source));
                    table.Rows.Add(newRows);
                }
                ToExcel.DataTableToExcel(table, "", "富添盛仓库库存表");
            }
            else if (StockDataType == "62")
            {
                string tname = string.Empty;
                DataTable table = new DataTable();
                table.Columns.Add("序号", typeof(int));
                table.Columns.Add("所在仓库", typeof(string));
                table.Columns.Add("一级区域", typeof(string));
                table.Columns.Add("所在区域", typeof(string));
                table.Columns.Add("货位代码", typeof(string));
                table.Columns.Add("库存数量", typeof(int));
                table.Columns.Add("产品名称", typeof(string));
                table.Columns.Add("产品类型", typeof(string));
                table.Columns.Add("品番", typeof(string));
                table.Columns.Add("背番", typeof(string));
                table.Columns.Add("批次", typeof(string));
                //table.Columns.Add("周期年", typeof(string));
                table.Columns.Add("产品来源", typeof(string));
                table.Columns.Add("产品ID", typeof(int));
                table.Columns.Add("入库时间", typeof(string));
                int i = 0;
                foreach (var it in StockData)
                {
                    i++;
                    DataRow newRows = table.NewRow();
                    newRows["序号"] = i;
                    newRows["所在仓库"] = it.FirstAreaName;
                    newRows["所在区域"] = it.AreaName;
                    newRows["一级区域"] = it.ParentAreaName;
                    newRows["货位代码"] = it.ContainerCode;
                    newRows["库存数量"] = it.Piece;
                    newRows["产品名称"] = it.ProductName;
                    newRows["产品类型"] = it.TypeName;
                    newRows["品番"] = it.GoodsCode;
                    newRows["背番"] = it.Specs.Trim();
                    newRows["批次"] = it.Batch;
                    //newRows["周期年"] = it.BatchYear == 0 ? it.OP_DATE.Year.ToString() : (it.OP_DATE.Year.ToString().Substring(0, 2) + it.BatchYear);
                    newRows["产品来源"] = GetSoureName(list, Convert.ToInt32(it.Source));
                    newRows["产品ID"] = it.ProductID;
                    newRows["入库时间"] = it.InHouseTime;
                    table.Rows.Add(newRows);
                }
                ToExcel.DataTableToExcel(table, "", "仓库库存数据表");
            }
            else if (StockDataType == "64")
            {
                string tname = string.Empty;
                DataTable table = new DataTable();
                table.Columns.Add("序号", typeof(int));
                table.Columns.Add("产品ID", typeof(int));
                table.Columns.Add("产品类型", typeof(string));
                table.Columns.Add("规格", typeof(string));
                table.Columns.Add("花纹", typeof(string));
                table.Columns.Add("型号", typeof(string));
                table.Columns.Add("货品代码", typeof(string));
                table.Columns.Add("载重指数", typeof(string));
                table.Columns.Add("速度级别", typeof(string));
                table.Columns.Add("批次", typeof(string));
                table.Columns.Add("周期年", typeof(int));
                table.Columns.Add("库存数量", typeof(int));
                table.Columns.Add("在库天数", typeof(int));
                //}
                //if (UserInfor.LoginName == "2421" || UserInfor.LoginName == "2422" || UserInfor.LoginName == "2076")
                //{
                if (UserInfor.IsCostPrice.Equals("1"))
                {
                    table.Columns.Add("进货价", typeof(string));
                    table.Columns.Add("成本价", typeof(string));
                }
                table.Columns.Add("销售价", typeof(string));
                table.Columns.Add("门店价", typeof(string));
                table.Columns.Add("货位代码", typeof(string));
                table.Columns.Add("所在区域", typeof(string));
                table.Columns.Add("一级区域", typeof(string));
                table.Columns.Add("所在仓库", typeof(string));
                table.Columns.Add("供应商", typeof(string));
                table.Columns.Add("产地", typeof(string));
                table.Columns.Add("入库时间", typeof(string));
                int i = 0;
                foreach (var it in StockData)
                {
                    i++;
                    DataRow newRows = table.NewRow();
                    newRows["序号"] = i;
                    newRows["产品ID"] = it.ProductID;
                    newRows["产品类型"] = it.TypeName;
                    newRows["规格"] = it.Specs.Trim();
                    newRows["花纹"] = it.Figure;
                    newRows["型号"] = it.Model.Trim();
                    newRows["货品代码"] = it.GoodsCode;
                    newRows["载重指数"] = it.LoadIndex;
                    newRows["速度级别"] = it.SpeedLevel;
                    newRows["批次"] = it.Batch;
                    newRows["周期年"] = it.BatchYear;
                    newRows["库存数量"] = it.Piece;
                    newRows["在库天数"] = it.InHouseDay;
                    if (UserInfor.IsCostPrice.Equals("1"))
                    {
                        newRows["进货价"] = it.UnitPrice;
                        newRows["成本价"] = it.CostPrice;
                    }
                    newRows["销售价"] = it.SalePrice;
                    newRows["门店价"] = it.TradePrice;
                    newRows["货位代码"] = it.ContainerCode;
                    newRows["所在区域"] = it.AreaName;
                    newRows["一级区域"] = it.ParentAreaName;
                    newRows["所在仓库"] = it.FirstAreaName;
                    newRows["供应商"] = it.Supplier;
                    newRows["产地"] = it.Born.Equals("1") ? "进口" : "国产";
                    newRows["入库时间"] = it.InHouseTime;
                    table.Rows.Add(newRows);
                }
                ToExcel.DataTableToExcel(table, "", "仓库库存数据表");
            }
            else if (StockDataType == "82")
            {
                string tname = string.Empty;
                DataTable table = new DataTable();
                table.Columns.Add("序号", typeof(int));
                table.Columns.Add("产品ID", typeof(int));
                table.Columns.Add("所在仓库", typeof(string));
                table.Columns.Add("货位代码", typeof(string));
                table.Columns.Add("库存数量", typeof(int));
                table.Columns.Add("在库天数", typeof(int));
                table.Columns.Add("品牌", typeof(string));
                table.Columns.Add("货品代码", typeof(string));
                table.Columns.Add("规格", typeof(string));
                table.Columns.Add("花纹", typeof(string));
                table.Columns.Add("型号", typeof(string));
                table.Columns.Add("载速", typeof(string));
                if (!UserInfor.RoleCName.Contains("锦湖"))
                {
                    table.Columns.Add("批次", typeof(string));
                    table.Columns.Add("周期年", typeof(int));
                }
                table.Columns.Add("销售价", typeof(decimal));
                if (UserInfor.RoleCName.IndexOf("管理员") > -1)
                {
                    table.Columns.Add("单价", typeof(decimal));
                }
                if (!UserInfor.RoleCName.Contains("仓管"))
                {
                    table.Columns.Add("入库时间", typeof(string));
                }
                int i = 0;
                foreach (var it in StockData)
                {
                    i++;
                    DataRow newRows = table.NewRow();
                    newRows["序号"] = i;
                    newRows["产品ID"] = it.ProductID;
                    newRows["所在仓库"] = it.FirstAreaName;
                    newRows["货位代码"] = it.ContainerCode;
                    newRows["库存数量"] = it.Piece;
                    newRows["在库天数"] = it.InHouseDay;
                    newRows["品牌"] = it.TypeName;
                    newRows["货品代码"] = it.GoodsCode;
                    newRows["规格"] = it.Specs.Trim();
                    newRows["花纹"] = it.Figure;
                    newRows["型号"] = it.Model;
                    newRows["载速"] = it.LoadIndex + it.SpeedLevel;
                    if (!UserInfor.RoleCName.Contains("锦湖"))
                    {
                        newRows["批次"] = it.Batch;
                        newRows["周期年"] = it.BatchYear;
                    }
                    if (!UserInfor.RoleCName.Contains("仓管"))
                    {
                        newRows["入库时间"] = it.InHouseTime;
                    }
                    newRows["销售价"] = it.SalePrice;
                    if (UserInfor.RoleCName.IndexOf("管理员") > -1)
                    {
                        newRows["单价"] = it.UnitPrice;
                    }
                    table.Rows.Add(newRows);
                }
                ToExcel.DataTableToExcel(table, "", "仓库库存数据表");
            }
            else
            {
                //if (UserInfor.HouseName.Contains("西安仓库"))
                //{
                //    string tname = string.Empty;
                //    DataTable table = new DataTable();
                //    table.Columns.Add("序号", typeof(int));
                //    table.Columns.Add("货品代码", typeof(string));
                //    table.Columns.Add("产品名称", typeof(string));
                //    table.Columns.Add("批次", typeof(string));
                //    table.Columns.Add("库存数量", typeof(int));
                //    table.Columns.Add("货位代码", typeof(string));
                //    table.Columns.Add("所在区域", typeof(string));
                //    table.Columns.Add("所在仓库", typeof(string));
                //    table.Columns.Add("产品来源", typeof(string));
                //    table.Columns.Add("入库时间", typeof(string));
                //    int i = 0;
                //    foreach (var it in StockData)
                //    {
                //        i++;
                //        DataRow newRows = table.NewRow();
                //        newRows["序号"] = i;
                //        newRows["货品代码"] = it.GoodsCode.Trim();
                //        newRows["产品名称"] = it.ProductName.Trim() + " " + it.Figure.Trim() + " " + it.Model.Trim();
                //        //newRows["开单日期"] = it.CreateDate.ToString("yyyy-MM-dd") == "0001-01-01" || it.CreateDate.ToString("yyyy-MM-dd") == "1900-01-01" ? "" : it.CreateDate.ToString("yyyy-MM-dd");
                //        //newRows["规格"] = it.Specs.Trim();
                //        //newRows["型号"] = it.Model.Trim();
                //        //newRows["花纹"] = it.Figure;
                //        //newRows["载重指数"] = it.LoadIndex;
                //        //newRows["速度级别"] = it.SpeedLevel;
                //        newRows["批次"] = it.Batch;
                //        newRows["库存数量"] = it.Piece;
                //        newRows["货位代码"] = it.ContainerCode;
                //        newRows["所在区域"] = it.AreaName;
                //        newRows["所在仓库"] = it.HouseName;
                //        newRows["产品来源"] = GetSoureName(list, Convert.ToInt32(it.Source));
                //        newRows["入库时间"] = it.InHouseTime;
                //        table.Rows.Add(newRows);
                //    }
                //    ToExcel.DataTableToExcel(table, "", "西安仓库库存表");
                //}
                //else
                //{
                string tname = string.Empty;
                DataTable table = new DataTable();
                table.Columns.Add("序号", typeof(int));
                table.Columns.Add("产品ID", typeof(int));
                if (!RoleName.Contains("汕头科矿"))
                {
                    table.Columns.Add("产品名称", typeof(string));
                    table.Columns.Add("品牌大类", typeof(string));
                    table.Columns.Add("品牌", typeof(string));
                    table.Columns.Add("产品编码", typeof(string));
                    table.Columns.Add("货品代码", typeof(string));
                    table.Columns.Add("规格", typeof(string));
                    table.Columns.Add("型号", typeof(string));
                    table.Columns.Add("花纹", typeof(string));
                    table.Columns.Add("载重指数", typeof(string));
                    table.Columns.Add("速度级别", typeof(string));
                    table.Columns.Add("批次", typeof(string));
                    table.Columns.Add("周期年", typeof(int));
                    table.Columns.Add("库存数量", typeof(int));
                    table.Columns.Add("在库天数", typeof(int));
                    table.Columns.Add("超期费用", typeof(decimal));
                    if (UserInfor.IsAdmin.Equals("1"))
                    {
                        table.Columns.Add("单价", typeof(decimal));
                    }
                    table.Columns.Add("门店价", typeof(decimal));
                    table.Columns.Add("小程序价", typeof(decimal));
                    table.Columns.Add("次日达价", typeof(decimal));
                    table.Columns.Add("批发价", typeof(decimal));
                    if (UserInfor.IsCostPrice.Equals("1"))
                    {
                        if (!UserInfor.IsAdmin.Equals("1"))
                        {
                            table.Columns.Add("单价", typeof(decimal));
                        }
                        table.Columns.Add("成本价", typeof(string));
                    }
                    table.Columns.Add("货位代码", typeof(string));
                    table.Columns.Add("所在区域", typeof(string));
                    table.Columns.Add("一级区域", typeof(string));
                    table.Columns.Add("所在仓库", typeof(string));
                    table.Columns.Add("归属部门", typeof(string));
                    table.Columns.Add("产品来源", typeof(string));
                    table.Columns.Add("物权方", typeof(string));
                    table.Columns.Add("业务类型(物权)", typeof(string));
                    table.Columns.Add("供应商", typeof(string));
                    table.Columns.Add("来货单号", typeof(string));
                    table.Columns.Add("产地", typeof(string));
                    table.Columns.Add("入库时间", typeof(string));
                }
                else
                {
                    table.Columns.Add("品牌", typeof(string));
                    table.Columns.Add("货品代码", typeof(string));
                    table.Columns.Add("规格", typeof(string));
                    table.Columns.Add("型号", typeof(string));
                    table.Columns.Add("花纹", typeof(string));
                    table.Columns.Add("尺寸", typeof(string));
                    table.Columns.Add("批次", typeof(string));
                    table.Columns.Add("周期年", typeof(int));
                    table.Columns.Add("库存数量", typeof(int));
                    table.Columns.Add("在库天数", typeof(int));
                    table.Columns.Add("销售价", typeof(string));
                    table.Columns.Add("货位代码", typeof(string));
                    table.Columns.Add("所在区域", typeof(string));
                    table.Columns.Add("一级区域", typeof(string));
                    table.Columns.Add("所在仓库", typeof(string));
                }
                int i = 0;
                foreach (var it in StockData)
                {
                    i++;
                    DataRow newRows = table.NewRow();
                    newRows["序号"] = i;
                    newRows["产品ID"] = it.ProductID;
                    if (!RoleName.Contains("汕头科矿"))
                    {
                        newRows["产品名称"] = it.ProductName;
                        newRows["品牌大类"] = it.TypeParentName;
                        newRows["品牌"] = it.TypeName;
                        newRows["产品编码"] = it.ProductCode;
                        newRows["货品代码"] = it.GoodsCode;
                        //newRows["开单日期"] = it.CreateDate.ToString("yyyy-MM-dd") == "0001-01-01" || it.CreateDate.ToString("yyyy-MM-dd") == "1900-01-01" ? "" : it.CreateDate.ToString("yyyy-MM-dd");
                        newRows["规格"] = it.Specs.Trim();
                        newRows["型号"] = it.Model.Trim();
                        newRows["花纹"] = it.Figure;
                        newRows["载重指数"] = it.LoadIndex;
                        newRows["速度级别"] = it.SpeedLevel;
                        newRows["批次"] = it.Batch;
                        newRows["周期年"] = it.BatchYear;
                        newRows["库存数量"] = it.Piece;
                        newRows["在库天数"] = it.InHouseDay;
                        newRows["超期费用"] = it.OverDueFee.ToString("F2");

                        if (UserInfor.IsAdmin.Equals("1"))
                        {
                            newRows["单价"] = it.UnitPrice;
                        }
                        newRows["门店价"] = it.TradePrice;
                        newRows["小程序价"] = it.SalePrice;
                        newRows["次日达价"] = it.NextDayPrice;
                        newRows["批发价"] = it.WholesalePrice;
                        if (UserInfor.IsCostPrice.Equals("1"))
                        {
                            if (!UserInfor.IsAdmin.Equals("1"))
                            {
                                newRows["单价"] = it.UnitPrice;
                            }
                            newRows["成本价"] = it.CostPrice;
                        }
                        newRows["货位代码"] = it.ContainerCode;
                        newRows["所在区域"] = it.AreaName;
                        newRows["一级区域"] = it.ParentAreaName;
                        newRows["所在仓库"] = it.FirstAreaName;
                        newRows["归属部门"] = it.BelongDepart;
                        newRows["产品来源"] = GetSoureName(list, Convert.ToInt32(it.Source));
                        newRows["物权方"] = GetText(it.OwnerShip, "OwnerShip");
                        newRows["业务类型(物权)"] = GetText(it.GoodsClass, "GoodsClass");
                        newRows["供应商"] = it.Supplier;
                        newRows["来货单号"] = it.SourceOrderNo;
                        newRows["产地"] = it.Born.Equals("1") ? "进口" : "国产";
                        newRows["入库时间"] = it.InHouseTime;
                    }
                    else
                    {
                        newRows["品牌"] = it.TypeName;
                        newRows["货品代码"] = it.GoodsCode;
                        newRows["规格"] = it.Specs.Trim();
                        newRows["型号"] = it.Model.Trim();
                        newRows["花纹"] = it.Figure;
                        newRows["尺寸"] = it.HubDiameter.ToString();
                        newRows["批次"] = it.Batch;
                        newRows["周期年"] = it.BatchYear;
                        newRows["库存数量"] = it.Piece;
                        newRows["在库天数"] = it.InHouseDay;

                        newRows["销售价"] = it.SalePrice;

                        newRows["货位代码"] = it.ContainerCode;
                        newRows["所在区域"] = it.AreaName;
                        newRows["一级区域"] = it.ParentAreaName;
                        newRows["所在仓库"] = it.FirstAreaName;

                    }
                    table.Rows.Add(newRows);
                }
                ToExcel.DataTableToExcel(table, "", "仓库库存数据表" + DateTime.Now.ToString("yyyyMMddHHmm"));
            }
            // }
        }

        private string GetText(string value, string id)
        {
            string retStr = "";
            if (id.Contains("GoodsClass"))
            {
                if (value.Trim() == "0") retStr = "自有";
                else if (value.Trim() == "1") retStr = "进驻";
                else if (value.Trim() == "2") retStr = "托管";
            }
            else if (id.Contains("OwnerShip"))
            {
                if (value.Trim() == "48") retStr = "湖南狄乐RE";
                else if (value.Trim() == "1") retStr = "昆明云仓";
                else if (value.Trim() == "2") retStr = "已出库";
                else if (value.Trim() == "3") retStr = "运输在途";
                else if (value.Trim() == "4") retStr = "已到达";
                else if (value.Trim() == "5") retStr = "已签收";
                else if (value.Trim() == "6") retStr = "已拣货";
            }

            return retStr;
        }
        public string GetSoureName(List<CargoProductSourceEntity> ProductSource, int Source)
        {
            string SourceName = "";
            for (var i = 0; i < ProductSource.Count; i++)
            {
                if (ProductSource[i].Source == Source)
                {
                    SourceName = ProductSource[i].SourceName;
                    break;
                }
            }
            return SourceName;
        }
    }
}