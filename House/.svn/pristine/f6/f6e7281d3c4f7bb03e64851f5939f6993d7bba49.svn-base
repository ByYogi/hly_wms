using House.DataAccess;
using House.Entity.Cargo;
using House.Entity.Cargo.House;
using House.Entity.Cargo.Order;
using House.Entity.Cargo.Report;
using House.Entity.House;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Data.Common;
using System.Diagnostics.Eventing.Reader;
using System.Linq;
using System.Reflection;
using System.Runtime.InteropServices;
using System.Text;
using System.Xml.XPath;

namespace House.Manager.Cargo
{
    /// <summary>
    /// 数据统计数据库操作类
    /// </summary>
    public class CargoReportManager
    {
        private SqlHelper conn = new SqlHelper();
        #region 访问备货明细
        /// <summary>
        /// 查询商品访问量与仓库备货信息数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        /// <exception cref="ApplicationException"></exception>
        public Hashtable QueryPageAccessingStockDetails(int pIndex, int pNum, CargoAccessingStockDetailsEntity entity)
        {
            List<CargoAccessingStockDetailsEntity> result = new List<CargoAccessingStockDetailsEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *   FROM ";
                strSQL += "(SELECT DISTINCT ROW_NUMBER()  OVER (order by  p.OP_DATE DESC ) AS RowNumber ,p.id, p.sid, p.productcode, p.houseid, p.supplierid, p.suppliernum, p.unitprice, p.delflag, p.op_date, p.clientshortname, h.Name AS HouseName,pr.ProductID,s.TypeID,s.Specs,s.Figure,s.LoadIndex,s.SpeedLevel,t.TypeName,t.TypeParentName,a.AccessCount,wx.OrderNum,g.Piece,pr.InHouseTime FROM Tbl_Cargo_SupplierProductPrice AS p INNER JOIN Tbl_Cargo_House AS h  ON p.HouseID = h.HouseID INNER  JOIN Tbl_Cargo_ProductSpec AS s ON p.SID = s.SID INNER  JOIN Tbl_Cargo_ProductType AS t ON s.TypeID = t.TypeID INNER  JOIN Tbl_Cargo_Product AS pr ON pr.ProductCode = p.ProductCode AND pr.SuppClientNum = p.SupplierNum AND pr.HouseID = p.HouseID  INNER  JOIN Tbl_Cargo_ProductAccessCount AS a ON p.HouseID = a.HouseID AND p.ProductCode = a.ProductCode AND p.SupplierNum = a.SuppClientNum INNER  JOIN Tbl_Cargo_ContainerGoods AS g ON s.TypeID = g.TypeID AND pr.ProductID = g.ProductID  INNER JOIN Tbl_WX_OrderProduct AS wx ON wx.ProductID = pr.ProductID WHERE (1=1) ";
                //硬性要求：供应商编码SuppClientNum=UserInfor.LoginName（ClientNum）
                if (!entity.SupplierNum.Equals(0))
                {
                    strSQL += " and p.SupplierNum = '" + entity.SupplierNum + "'";
                }
                //库存情况StockStatus低于4显示低库存[0]，否则高库存[1]
                if (!string.IsNullOrEmpty(entity.StockStatus))
                {
                    if (entity.StockStatus.Equals("0"))
                    {
                        strSQL += " and  g.Piece<" + 4;
                    }
                    if (entity.StockStatus.Equals("1"))
                    {
                        strSQL += " and  g.Piece>=" + 4;
                    }
                }
                //产品编码
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and p.ProductCode like '%" + entity.ProductCode + "%'"; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    strSQL += " and s.Specs like '%" + entity.Specs + "%'";
                }
                //产品分类编号 
                if (!entity.TypeID.Equals(0)) { strSQL += " and s.TypeID = " + entity.TypeID; }
                //入库日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and pr.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and pr.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and p.HouseID in (" + entity.CargoPermisID + ")"; }
                strSQL += " ) A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1)) order by A.RowNumber";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取产品库存数据
                            var HouseTime = DateTime.Now - Convert.ToDateTime(idr["InHouseTime"]);
                            result.Add(new CargoAccessingStockDetailsEntity
                            {
                                ID = Convert.ToInt64(idr["ID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                LoadSpeed = Convert.ToString(idr["LoadIndex"]) + Convert.ToString(idr["SpeedLevel"]),
                                AccessCount = string.IsNullOrEmpty(Convert.ToString(idr["AccessCount"])) ? 0 : Convert.ToInt32(idr["AccessCount"]),
                                SaleOrderNum = string.IsNullOrEmpty(Convert.ToString(idr["OrderNum"])) ? 0 : Convert.ToInt32(idr["OrderNum"]),
                                Piece = string.IsNullOrEmpty(Convert.ToString(idr["Piece"])) ? 0 : Convert.ToInt32(idr["Piece"]),
                                InHouseTimeStr = string.IsNullOrEmpty(Convert.ToString(idr["InHouseTime"])) ? string.Empty : Convert.ToDateTime(idr["InHouseTime"]).ToString("yyyy-MM-dd HH:mm:ss"),
                                StockStatus = Convert.ToInt32(idr["Piece"]) > 4 ? "高库存" : "低库存",
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"select count(*) as TotalCount from Tbl_Cargo_SupplierProductPrice AS p LEFT JOIN Tbl_Cargo_House AS h  ON p.HouseID = h.HouseID LEFT JOIN Tbl_Cargo_ProductSpec AS s ON p.SID = s.SID LEFT JOIN Tbl_Cargo_Product AS pr ON pr.ProductCode = p.ProductCode AND pr.SuppClientNum = p.SupplierNum AND pr.HouseID = p.HouseID LEFT JOIN Tbl_Cargo_ProductType AS t ON s.TypeID = t.TypeID LEFT JOIN Tbl_Cargo_ProductAccessCount AS a ON p.HouseID = a.HouseID AND p.ProductCode = a.ProductCode AND p.SupplierNum = a.SuppClientNum LEFT JOIN Tbl_Cargo_ContainerGoods AS g ON s.TypeID = g.TypeID AND pr.ProductID = g.ProductID LEFT JOIN Tbl_WX_OrderProduct AS wx ON wx.ProductID = pr.ProductID Where (1=1)";
                //硬性要求：供应商编码SuppClientNum=UserInfor.LoginName（ClientNum）
                if (!entity.SupplierNum.Equals(0))
                {
                    strCount += " and p.SupplierNum = '" + entity.SupplierNum + "'";
                }
                //库存情况StockStatus低于4显示低库存[0]，否则高库存[1]
                if (!string.IsNullOrEmpty(entity.StockStatus))
                {
                    if (entity.StockStatus.Equals("0"))
                    {
                        strCount += " and  g.Piece<" + 4;
                    }
                    if (entity.StockStatus.Equals("1"))
                    {
                        strCount += " and  g.Piece>=" + 4;
                    }
                }
                //产品编码
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strCount += " and p.ProductCode like '%" + entity.ProductCode + "%'"; }
                //规格
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    strSQL += " and s.Specs like '%" + entity.Specs + "%'";
                }
                //产品分类编号 
                if (!entity.TypeID.Equals(0)) { strCount += " and s.TypeID = " + entity.TypeID; }
                //入库日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and pr.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and pr.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and p.HouseID in (" + entity.CargoPermisID + ")"; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0) { resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]); }
                    }
                }
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        #endregion
        #region 销售日收入报表操作方法集合
        /// <summary>
        /// 查询销售日收入报表
        /// </summary>
        /// <param name=""></param>
        /// <returns></returns>
        public SaleDayReportEntity QuerySaleDayReportInfo(SaleDayReportEntity entity)
        {
            SaleDayReportEntity result = new SaleDayReportEntity();
            List<SaleDayReportEntity> list = new List<SaleDayReportEntity>();
            try
            {
                #region 组装Sql查询语句
                string strSQL = @"SELECT ThrowGood,OrderType,OrderModel,DeliveryType,SUM(TransportFee) as TransportFee,SUM(Piece) as Piece FROM (
	SELECT ThrowGood,OrderType,TransportFee,Piece,OrderModel,DeliveryType FROM Tbl_Cargo_Order 
	WHERE";
                if (!entity.SuppClientNum.Equals(0))
                {
                    strSQL += " SuppClientNum=" + entity.SuppClientNum;
                }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID))
                {
                    strSQL += " and HouseID in (" + entity.CargoPermisID + ")";
                }
                //开单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += "GROUP BY ThrowGood,OrderType,TransportFee,Piece,OrderModel,DeliveryType ) C WHERE";

                //订单类型
                if (!string.IsNullOrEmpty(entity.OrderType))
                {
                    strSQL += " OrderType in (" + entity.OrderType + ")";
                }
                //订单类型
                if (!string.IsNullOrEmpty(entity.ThrowGood))
                {
                    strSQL += " and ThrowGood in (" + entity.ThrowGood + ")";
                }
                strSQL += "GROUP BY ThrowGood,OrderType,OrderModel,DeliveryType";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    #region 获取数据
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            list.Add(new SaleDayReportEntity()
                            {
                                ThrowGood = string.IsNullOrEmpty(Convert.ToString(idr["ThrowGood"])) ? string.Empty : Convert.ToString(idr["ThrowGood"]),
                                OrderType = string.IsNullOrEmpty(Convert.ToString(idr["OrderType"])) ? string.Empty : Convert.ToString(idr["OrderType"]),
                                OrderModel = string.IsNullOrEmpty(Convert.ToString(idr["OrderModel"])) ? string.Empty : Convert.ToString(idr["OrderModel"]),
                                DeliveryType = string.IsNullOrEmpty(Convert.ToString(idr["DeliveryType"])) ? string.Empty : Convert.ToString(idr["DeliveryType"]),
                                TransportFee = string.IsNullOrEmpty(Convert.ToString(idr["TransportFee"])) ? decimal.Zero : Convert.ToDecimal(idr["TransportFee"]),
                                Piece = string.IsNullOrEmpty(Convert.ToString(idr["Piece"])) ? 0 : Convert.ToInt32(idr["Piece"]),
                            });
                        }
                    }
                    #endregion
                }
                #region 统计返回数据
                if (list.Count > 0)
                {
                    var delivery = list.Where(s => s.DeliveryType.Equals("0"));//配送
                    var selft = list.Where(s => s.DeliveryType.Equals("1"));//自提
                    var orderTypeWx = list.Where(s => s.OrderType.Equals("4"));//微信小程序下单

                    result.SelfPiece = selft.Sum(s => s.Piece);
                    result.SelfMoney = selft.Sum(s => s.TransportFee);
                    result.DeliveryPiece = delivery.Sum(s => s.Piece);
                    result.DeliveryMoney = delivery.Sum(s => s.TransportFee);
                    result.Total = list.Sum(s => s.TransportFee);
                    result.ToDayTotal = orderTypeWx.Where(s => s.ThrowGood.Equals("22")).Sum(s => s.TransportFee);
                    result.NextDayTotal = orderTypeWx.Where(s => s.ThrowGood.Equals("23")).Sum(s => s.TransportFee);
                    result.ChannelTotal = list.Where(s => s.ThrowGood.Equals("24") && s.OrderType.Equals("0")).Sum(s => s.TransportFee);
                    result.ToDayReturnTotal = orderTypeWx.Where(s => s.OrderModel.Equals("1") && s.ThrowGood.Equals("22")).Sum(s => s.TransportFee);
                    result.NextDayReturnTotal = orderTypeWx.Where(s => s.OrderModel.Equals("1") && s.ThrowGood.Equals("23")).Sum(s => s.TransportFee);
                }
                return result;
                #endregion
            }
            catch (Exception ex)
            {
                throw new ApplicationException(ex.Message);
            }
        }
        #endregion
        #region 销售备货明细操作方法集合
        public Hashtable QueryPageSaleStockUpDetails(int pIndex, int pNum, CargoOrderGoodsEntity entity)
        {
            List<CargoOrderGoodsEntity> result = new List<CargoOrderGoodsEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                #region 获取订单明细
                string strSQL = @" SELECT TOP " + pNum + "* FROM(SELECT DISTINCT ROW_NUMBER() OVER(ORDER BY a.OP_DATE DESC) AS RowNumber, h.Name AS HouseName , g.Piece AS InHousePiece, p.ProductCode, p.SpecsType, p.Specs, p.Figure, p.LoadIndex, p.SpeedLevel,p.Born, p.Batch, p.CostPrice, p.SalePrice,p.InHousePrice, p.InHouseTime, t.TypeName, t.TypeID, o.PayClientNum, o.AcceptUnit, o.ThrowGood, o.OrderModel , o.SuppClientNum, a.* FROM Tbl_Cargo_OrderGoods AS a LEFT JOIN Tbl_Cargo_Order AS o ON a.OrderNo = o.OrderNo LEFT JOIN Tbl_Cargo_House AS h ON a.HouseID = h.HouseID LEFT JOIN Tbl_Cargo_Product AS p ON a.ProductID = p.ProductID LEFT JOIN Tbl_Cargo_ProductType AS t ON t.TypeID= p.TypeID LEFT JOIN Tbl_Cargo_ContainerGoods g ON g.ProductID = p.ProductID and g.TypeID = p.TypeID WHERE(1=1)";

                if (!entity.PayClientNum.Equals(0)) { strSQL += " and o.SuppClientNum =" + entity.PayClientNum; }
                //查询订单类型
                if (!string.IsNullOrEmpty(entity.ThrowGood))
                {
                    strSQL += " and o.ThrowGood in (" + entity.ThrowGood + ")";
                }

                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and t.TypeID =" + entity.TypeID; }//品牌ID
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strSQL += " and p.ProductCode like '%" + entity.ProductCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.OrderNo)) { strSQL += " and o.OrderNo like '%" + entity.OrderNo + "%'"; }

                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and p.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and p.Batch like '%" + entity.Batch + "%'"; }
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and p.Specs like '%" + entity.Specs + "%'"; }

                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.OP_DATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += ") as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))  order by RowNumber";
                #endregion

                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    #region 获取数据
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                ActSalePrice = Convert.ToDecimal(idr["ActSalePrice"]),
                                AvgSalePrice = decimal.Round(Convert.ToDecimal(idr["ActSalePrice"]) / Convert.ToDecimal(idr["Piece"]), 2),
                                InHouseTime = string.IsNullOrEmpty(Convert.ToString(idr["InHouseTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["InHouseTime"]),
                                InHousePiece = Convert.ToInt32(idr["InHousePiece"]),
                                InHouseTotalPrice = Convert.ToInt32(idr["InHousePiece"]) * Convert.ToDecimal(idr["SalePrice"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                Specs = Convert.ToString(idr["Specs"]),
                                Figure = Convert.ToString(idr["Figure"]),
                                Batch = Convert.ToString(idr["Batch"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                Born = Convert.ToString(idr["Born"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                LoadSpeed = Convert.ToString(idr["LoadIndex"]) + Convert.ToString(idr["SpeedLevel"]),
                                OP_ID = Convert.ToString(idr["OP_ID"]),
                                OP_DATE = Convert.ToDateTime(idr["OP_DATE"]),
                                CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                InHousePrice = Convert.ToDecimal(idr["InHousePrice"]),
                                TotalCostPrice = Convert.ToInt32(idr["Piece"]) * Convert.ToDecimal(idr["InHousePrice"]),
                                //AcceptUnit = Convert.ToString(idr["AcceptUnit"]),
                            });
                        }
                    }
                    #endregion
                }
                resHT["rows"] = result;
                #region 获取总数
                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_OrderGoods as a LEFT JOIN Tbl_Cargo_Order AS o ON a.OrderNo = o.OrderNo LEFT JOIN  Tbl_Cargo_Product AS p  ON  a.ProductID = p.ProductID  LEFT JOIN  Tbl_Cargo_ProductType AS t ON t.TypeID= p.TypeID  Where (1=1)";

                if (!entity.PayClientNum.Equals(0)) { strCount += " and o.SuppClientNum =" + entity.PayClientNum; }
                //查询订单类型【即日达订单22】
                if (!string.IsNullOrEmpty(entity.ThrowGood))
                {
                    strCount += " and o.ThrowGood in (" + entity.ThrowGood + ")";
                }
                if (!string.IsNullOrEmpty(entity.ProductCode)) { strCount += " and p.ProductCode like '%" + entity.ProductCode + "%'"; }
                if (!string.IsNullOrEmpty(entity.OrderNo)) { strCount += " and o.OrderNo like '%" + entity.OrderNo + "%'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and p.Figure like '%" + entity.Figure + "%'"; }
                if (!string.IsNullOrEmpty(entity.Batch)) { strCount += " and p.Batch like '%" + entity.Batch + "%'"; }
                if (!string.IsNullOrEmpty(entity.Specs)) { strCount += " and p.Specs like '%" + entity.Specs + "%'"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                if (!entity.TypeID.Equals(0)) { strCount += " and t.TypeID =" + entity.TypeID; } //品牌ID
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and a.OP_DATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
                #endregion
            }
            catch (Exception ex)
            {
                throw new ApplicationException(ex.Message);
            }
            return resHT;
        }
        #endregion
        #region 仓库盘点操作方法集合
        /// <summary>
        /// 仓库盘点数据查询
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoStocktakingEntity> QueryHouseStocktaking(CargoStocktakingEntity entity)
        {
            List<CargoStocktakingEntity> result = new List<CargoStocktakingEntity>();
            string strSQL = @"select SUM( e.Piece) as InCargoPiece,b.AreaID,b.ParentID,g.TypeName,b.Name,c.Name as ParentName from Tbl_Cargo_Container as a left join Tbl_Cargo_ContainerGoods as e on a.ContainerID=e.ContainerID left join Tbl_Cargo_ProductType as f on e.TypeID=f.TypeID left join Tbl_Cargo_ProductType as g on f.ParentID=g.TypeID left join Tbl_Cargo_Area as b on a.AreaID=b.AreaID  left join Tbl_Cargo_Area as c on b.ParentID=c.AreaID  left join Tbl_Cargo_House as d on c.HouseID=d.HouseID where  e.TypeID is not null  ";
            if (!entity.CargoPermisID.Equals(0))
            {
                //strSQL += " and d.HouseID = " + entity.HouseID + "";
                strSQL += " and d.HouseID in (" + entity.CargoPermisID + ")";
            }
            strSQL += " group by b.Name,c.Name,g.TypeName,b.AreaID,b.ParentID";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoStocktakingEntity
                            {
                                InCargoPiece = Convert.ToInt32(idrCount["InCargoPiece"]),
                                AreaID = Convert.ToInt32(idrCount["AreaID"]),
                                ParentName = Convert.ToString(idrCount["ParentName"]).Trim(),
                                AreaName = Convert.ToString(idrCount["Name"]).Trim(),
                                HouseID = entity.HouseID,
                                TypeName = Convert.ToString(idrCount["TypeName"]).Trim(),
                                ParentID = Convert.ToInt32(idrCount["ParentID"])
                            });
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 按产品分类统计盘点仓库数量
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoStocktakingEntity> QueryHouseStockByType(CargoStocktakingEntity entity)
        {
            List<CargoStocktakingEntity> result = new List<CargoStocktakingEntity>();
            string strSQL = @"select SUM( e.Piece) as InCargoPiece,f.TypeID,f.ParentID,f.TypeName,g.TypeName as ParentName from Tbl_Cargo_Container as a left join Tbl_Cargo_ContainerGoods as e on a.ContainerID=e.ContainerID left join Tbl_Cargo_ProductType as f on e.TypeID=f.TypeID left join Tbl_Cargo_ProductType as g on f.ParentID=g.TypeID left join Tbl_Cargo_Area as b on a.AreaID=b.AreaID left join Tbl_Cargo_House as d on b.HouseID=d.HouseID where  e.TypeID is not null ";
            if (!entity.CargoPermisID.Equals(0))
            {
                //strSQL += " and d.HouseID = " + entity.HouseID + "";
                strSQL += " and d.HouseID in (" + entity.CargoPermisID + ")";
            }
            strSQL += " group by f.TypeID,f.ParentID,f.TypeName,g.TypeName  ";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoStocktakingEntity
                            {
                                InCargoPiece = Convert.ToInt32(idrCount["InCargoPiece"]),
                                TypeID = Convert.ToInt32(idrCount["TypeID"]),
                                ParentName = Convert.ToString(idrCount["ParentName"]).Trim(),//父类型
                                TypeName = Convert.ToString(idrCount["TypeName"]).Trim(),
                                HouseID = entity.HouseID,
                                ParentID = Convert.ToInt32(idrCount["ParentID"])
                            });
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        #endregion
        #region 每日进出库报表查询
        public List<CargoDailyReportEntity> QueryStockDailyReport(CargoDailyReportEntity entity)
        {
            List<CargoDailyReportEntity> result = new List<CargoDailyReportEntity>();
            string strSQL = "select * from (select a.HouseID,a.Name as FirstAreaName,a.TypeName,a.ProductCode,a.Piece,b.Stock,ISNULL(c.StockNum,0) as StockNum,c.Specs,c.Figure,c.GoodsCode,c.LoadIndex,c.SpeedLevel,c.TypeID from(select a.HouseID,c.ProductCode,e.ParentID as AreaID,f.Name,g.TypeName,SUM(a.Piece) as Piece from Tbl_Cargo_OrderGoods as a inner join Tbl_Cargo_Order as b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID and b.OrderModel=0 ";
            //出库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID = " + entity.HouseID; }
            strSQL += " inner join Tbl_Cargo_Product as c on a.ProductID=c.ProductID and a.HouseID=c.HouseID inner join Tbl_Cargo_Area as d on a.AreaID=d.AreaID inner join Tbl_Cargo_Area as e on d.ParentID=e.AreaID inner join Tbl_Cargo_Area as f on e.ParentID=f.AreaID inner join Tbl_Cargo_ProductType as g on c.TypeID=g.TypeID ";

            if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and c.Specs like '%" + entity.Specs + "%'"; }
            //花纹
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and c.Figure like '%" + entity.Figure + "%'"; }
            //二级类型ID
            if (!entity.TypeID.Equals(0)) { strSQL += " and c.TypeID=" + entity.TypeID; }
            if (!entity.FirstAreaID.Equals(0)) { strSQL += " and f.ParentID = " + entity.FirstAreaID; }
            if (!string.IsNullOrEmpty(entity.SpecsType) && entity.SpecsType != "-1") { strSQL += " where SpecsType = " + entity.SpecsType; }
            strSQL += " group by a.HouseID,c.ProductCode,e.ParentID,f.Name,g.TypeName)as a  ";

            strSQL += " left join(select a.ProductCode,SUM(c.Piece) as Stock from (select a.HouseID,c.ProductCode,e.ParentID as AreaID,f.Name,g.TypeName,SUM(a.Piece) as Piece from Tbl_Cargo_OrderGoods as a inner join Tbl_Cargo_Order as b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID and b.OrderModel=0 ";
            //出库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID = " + entity.HouseID; }
            strSQL += " inner join Tbl_Cargo_Product as c on a.ProductID=c.ProductID and a.HouseID=c.HouseID inner join Tbl_Cargo_Area as d on a.AreaID=d.AreaID inner join Tbl_Cargo_Area as e on d.ParentID=e.AreaID inner join Tbl_Cargo_Area as f on e.ParentID=f.AreaID inner join Tbl_Cargo_ProductType as g on c.TypeID=g.TypeID ";

            if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and c.Specs like '%" + entity.Specs + "%'"; }
            //花纹
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and c.Figure like '%" + entity.Figure + "%'"; }
            //二级类型ID
            if (!entity.TypeID.Equals(0)) { strSQL += " and c.TypeID=" + entity.TypeID; }
            if (!entity.FirstAreaID.Equals(0)) { strSQL += " and f.ParentID = " + entity.FirstAreaID; }
            if (!string.IsNullOrEmpty(entity.SpecsType) && entity.SpecsType != "-1") { strSQL += " where SpecsType = " + entity.SpecsType; }
            strSQL += " group by a.HouseID,c.ProductCode,e.ParentID,f.Name,g.TypeName) as a  ";

            strSQL += " inner join Tbl_Cargo_Product as b on a.ProductCode=b.ProductCode inner join Tbl_Cargo_ContainerGoods as c on b.ProductID=c.ProductID group by a.ProductCode) as b on a.ProductCode=b.ProductCode left join Tbl_Cargo_SafeStock as c on a.HouseID=c.HouseID and a.AreaID=c.AreaID and a.ProductCode=c.ProductCode";

            strSQL += ") as a where (1=1)";
            if (entity.Meridian.Equals("1"))
            {
                strSQL += " and a.Stock<a.StockNum";
            }
            strSQL += " order by a.FirstAreaName asc,a.TypeName, a.Piece desc";
            //inner join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID inner join Tbl_Cargo_Area as d on c.AreaID=d.AreaID inner join Tbl_Cargo_Area as e on d.ParentID=e.AreaID inner join Tbl_Cargo_Area as f on e.ParentID=f.AreaID and ab.Name=f.Name
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDailyReportEntity
                        {
                            FirstAreaName = Convert.ToString(idrCount["FirstAreaName"]),//分仓仓库名称
                            TypeID = Convert.ToInt32(idrCount["TypeID"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            GoodsCode = Convert.ToString(idrCount["GoodsCode"]),
                            Figure = Convert.ToString(idrCount["Figure"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                            Piece = Convert.ToInt32(idrCount["Piece"]),//订单销售数量
                            //MoveNum = Convert.ToInt32(idrCount["MovePiece"]),//移库单移库数量
                            Numbers = Convert.ToInt32(idrCount["StockNum"]),//预警库存数
                            FlatRatio = Convert.ToInt32(idrCount["Stock"]),//当前实时库存数
                            TreadWidth = Convert.ToInt32(idrCount["StockNum"]) - Convert.ToInt32(idrCount["Stock"])
                        });
                    }
                }
            }
            return result;
        }


        /// <summary>
        /// 查询每日的入库报表
        /// </summary>
        public List<CargoDailyReportEntity> QueryInDailyReport(CargoDailyReportEntity entity)
        {
            CargoHouseManager house = new CargoHouseManager();
            List<CargoDailyReportEntity> result = new List<CargoDailyReportEntity>();
            //string strSQL = @"select sum(a.Piece) as Piece,b.TypeName,b.TypeID from Tbl_Cargo_ContainerGoods as a left join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID where (1=1) ";
            ////入库时间
            //if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            //{
            //    strSQL += " and a.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            //    strSQL += " and a.InHouseTime<'" + entity.StartDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            //}
            //strSQL += " group by b.TypeName,b.TypeID ";

            string strSQL = @"select a.ID,a.ContainerID,a.Piece,a.InHouseTime,a.IsPrintInCargo,a.InHouseType,a.OP_DATE,a.InCargoID,f.TypeName,ps.SourceName,e.*,b.ContainerCode,b.ContainerType,b.AreaID,c.Name as AreaName,c.ParentID,d.Name as HouseName,h.Name as FirstAreaName,h.AreaID as FirstAreaID,g.Name as ParentAreaName,g.AreaID as ParentAreaID,e.ProductCode from Tbl_Cargo_InContainerGoods as a left join Tbl_Cargo_Container as b on a.ContainerID=b.ContainerID left join Tbl_Cargo_Area as c on b.AreaID=c.AreaID left join Tbl_Cargo_House as d on c.HouseID=d.HouseID inner join Tbl_Cargo_Product as e on a.ProductID=e.ProductID left join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID left join Tbl_Cargo_ProductSource ps on e.Source=ps.Source ";
            //if (!entity.FirstAreaID.Equals(0))
            //{
            strSQL += " left join Tbl_Cargo_Area as g on c.ParentID=g.AreaID left join Tbl_Cargo_Area as h on g.ParentID=h.AreaID ";
            //}
            strSQL += " where (1=1) ";
            //if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and e.Specs like '%" + entity.Specs + "%'"; }
            string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
            if (res.Length <= 3)
            {
                if (!string.IsNullOrEmpty(res)) { strSQL += " and e.Specs like '%" + res + "%'"; }
            }
            if (res.Length > 3 && res.Length <= 5)
            {
                strSQL += " and (e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or e.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
            }
            if (res.Length > 5)
            {
                strSQL += " and (e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
            }

            //花纹
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and e.Figure like '%" + entity.Figure + "%'"; }
            if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and e.GoodsCode like '%" + entity.GoodsCode + "%'"; }
            if (!string.IsNullOrEmpty(entity.SourceOrderNo)) { strSQL += " and e.SourceOrderNo like '%" + entity.SourceOrderNo + "%'"; }
            //二级类型ID
            if (!entity.TypeID.Equals(0)) { strSQL += " and e.TypeID=" + entity.TypeID; }
            //以一级类型ID为查询条件
            if (!entity.TypeParentID.Equals(0)) { strSQL += " and f.ParentID=" + entity.TypeParentID; }
            if (!entity.FirstAreaID.Equals(0)) { strSQL += " and h.AreaID = " + entity.FirstAreaID + ""; }
            //入库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.CargoPermisID))
            {
                strSQL += " and d.HouseID in (" + entity.CargoPermisID + ")";
            }
            if (!string.IsNullOrEmpty(entity.InHouseType))
            {
                strSQL += " and a.InHouseType ='" + entity.InHouseType + "'";
            }
            if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and e.ProductName like '%" + entity.ProductName + "%'"; }
            if (!string.IsNullOrEmpty(entity.BelongDepart)) { strSQL += " and e.BelongDepart=" + entity.BelongDepart; }
            if (!string.IsNullOrEmpty(entity.SpecsType) && entity.SpecsType != "-1") { strSQL += " and SpecsType=" + entity.SpecsType; }
            strSQL += " order by a.InHouseTime";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            //CargoAreaEntity cargoArea = new CargoAreaEntity();
                            //CargoAreaEntity hArea = new CargoAreaEntity();
                            //if (entity.CargoPermisID.IndexOf('3') > -1)
                            //{
                            //    //如果父ID不为0，则查询父ID的区域名称
                            //    if (!Convert.ToInt32(idrCount["ParentID"]).Equals(0))
                            //    {
                            //        cargoArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idrCount["ParentID"]) });
                            //        if (!cargoArea.ParentID.Equals(0))
                            //        {
                            //            hArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                            //        }
                            //    }
                            //}
                            result.Add(new CargoDailyReportEntity
                            {
                                ID = Convert.ToInt64(idrCount["ID"]),
                                ContainerID = Convert.ToInt32(idrCount["ContainerID"]),
                                Piece = Convert.ToInt32(idrCount["Piece"]),
                                InHouseTime = Convert.ToDateTime(idrCount["InHouseTime"]),
                                IsPrintInCargo = Convert.ToString(idrCount["IsPrintInCargo"]).Equals("0") ? false : true,
                                InCargoID = Convert.ToString(idrCount["InCargoID"]).Trim(),
                                TypeName = Convert.ToString(idrCount["TypeName"]).Trim(),
                                ProductID = Convert.ToInt64(idrCount["ProductID"]),
                                ProductCode = Convert.ToString(idrCount["ProductCode"]).Trim(),
                                ProductName = Convert.ToString(idrCount["ProductName"]).Trim(),
                                TypeID = Convert.ToInt32(idrCount["TypeID"]),
                                Model = Convert.ToString(idrCount["Model"]).Trim(),
                                GoodsCode = Convert.ToString(idrCount["GoodsCode"]).Trim(),
                                Figure = Convert.ToString(idrCount["Figure"]).Trim(),
                                Specs = Convert.ToString(idrCount["Specs"]).Trim(),
                                TreadWidth = Convert.ToInt32(idrCount["TreadWidth"]),
                                FlatRatio = Convert.ToInt32(idrCount["FlatRatio"]),
                                Meridian = Convert.ToString(idrCount["Meridian"]).Trim(),
                                HubDiameter = Convert.ToInt32(idrCount["HubDiameter"]),
                                LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                                SpeedMax = Convert.ToInt32(idrCount["SpeedMax"]),
                                Size = Convert.ToString(idrCount["Size"]),
                                Weight = Convert.ToDecimal(idrCount["Weight"]),
                                UnitPrice = Convert.ToDecimal(idrCount["UnitPrice"]),
                                Numbers = Convert.ToInt32(idrCount["Numbers"]),
                                CostPrice = Convert.ToDecimal(idrCount["CostPrice"]),
                                TradePrice = Convert.ToDecimal(idrCount["TradePrice"]),
                                SalePrice = Convert.ToDecimal(idrCount["SalePrice"]),
                                ContainerCode = Convert.ToString(idrCount["ContainerCode"]).Trim(),
                                ContainerType = Convert.ToString(idrCount["ContainerType"]).Trim(),
                                AreaID = Convert.ToInt32(idrCount["AreaID"]),
                                AreaName = Convert.ToString(idrCount["AreaName"]).Trim(),
                                Batch = Convert.ToString(idrCount["Batch"]),
                                BatchYear = Convert.ToInt32(idrCount["BatchYear"]),
                                BatchWeek = Convert.ToInt32(idrCount["BatchWeek"]),
                                InHouseType = Convert.ToString(idrCount["InHouseType"]),
                                Source = Convert.ToString(idrCount["SourceName"]),
                                StartDate = entity.StartDate,
                                EndDate = entity.EndDate,
                                FirstAreaID = Convert.ToInt32(idrCount["FirstAreaID"]),
                                FirstAreaName = Convert.ToString(idrCount["FirstAreaName"]),
                                ParentAreaID = Convert.ToInt32(idrCount["ParentAreaID"]),
                                ParentAreaName = Convert.ToString(idrCount["ParentAreaName"]),
                                SourceOrderNo = Convert.ToString(idrCount["SourceOrderNo"]),
                                HouseName = Convert.ToString(idrCount["HouseName"]).Trim(),
                                BelongDepart = Convert.ToString(idrCount["BelongDepart"]).Trim(),
                                SpecsType = Convert.ToString(idrCount["SpecsType"]),
                                Supplier = Convert.ToString(idrCount["Supplier"])
                            });
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询每日的出库报表
        /// </summary>
        public List<CargoDailyReportEntity> QueryOutDailyReport(CargoDailyReportEntity entity)
        {
            List<CargoDailyReportEntity> result = new List<CargoDailyReportEntity>();
            //string strSQL = @"select a.ID,a.ContainerID,a.Piece,a.OutHouseTime,a.IsPrintOutCargo,a.OutCargoID,f.TypeName,e.*,b.ContainerCode,b.ContainerType,b.AreaID,c.Name as AreaName,d.Name as HouseName,ISNULL(g.ActSalePrice,0) as ActSalePrice,g.OrderNo,h.AwbStatus,c.ParentID,h.LogisAwbNo,h.Remark from Tbl_Cargo_OutContainerGoods as a left join Tbl_Cargo_Container as b on a.ContainerID=b.ContainerID left join Tbl_Cargo_Area as c on b.AreaID=c.AreaID left join Tbl_Cargo_House as d on c.HouseID=d.HouseID left join Tbl_Cargo_Product as e on a.ProductID=e.ProductID left join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID left join Tbl_Cargo_OrderGoods as g on a.OutCargoID=g.OutCargoID and a.ProductID=g.ProductID and b.ContainerCode=g.ContainerCode left join Tbl_Cargo_Order as h on g.OrderNo=h.OrderNo ";

            string strSQL = @"select b.ThrowGood,b.CreateDate,a.AreaID,a.OutCargoID,case when b.OrderModel=1 then -a.Piece else a.Piece end as Piece,a.OrderNo,a.ActSalePrice,a.ContainerCode,a.ShowGoodsCode,a.ShowTypeName,b.AwbStatus,b.LogisAwbNo,b.BelongHouse,b.Remark,b.OrderModel,c.Name AS AreaName,c.ParentID,d.Name as HouseName,b.AcceptUnit,b.OrderType,b.HAwbNo,b.ShopCode,b.OutCargoTime,b.SignTime,f.TypeName,ps.SourceName ,e.*,k.Name as FirstAreaName,k.AreaID as FirstAreaID,j.Name as ParentAreaName,j.AreaiD as ParentAreaID,STUFF((select ',' + pt.TyreCode from Tbl_Cargo_ProductTag pt where pt.OrderNo = a.OrderNo and pt.ProductID=a.ProductID and OutCargoStatus=1 for xml path('')),1,1,'') as TyreCode,e.ProductCode";
            if (entity.CargoPermisID == "47")
            {
                strSQL += " ,isnull( g.SalePriceClient,0) as SalePriceClient,isnull(g.CostPriceStore,0) as CostPriceStore ";
            }
            strSQL += @" From Tbl_Cargo_OrderGoods as a inner join Tbl_Cargo_Order as b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID left join Tbl_Cargo_Area as c on a.AreaID=c.AreaID inner join Tbl_Cargo_House as d on a.HouseID=d.HouseID inner join Tbl_Cargo_Product as e on a.ProductID=e.ProductID inner join Tbl_Cargo_ProductType as f on e.TypeID=f.TypeID left join Tbl_Cargo_ProductSource ps on e.Source=ps.Source ";
            //if (!entity.FirstAreaID.Equals(0))
            //{
            strSQL += " left join Tbl_Cargo_Area as j on c.ParentID=j.AreaID left join Tbl_Cargo_Area as k on j.ParentID=k.AreaID ";
            //}
            if (entity.CargoPermisID == "47")
            {
                strSQL += " LEFT join Tbl_Cargo_ProductPrice g on e.GoodsCode=g.ProductCode ";
            }
            strSQL += " where (1=1) ";
            //if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and e.Specs like '%" + entity.Specs + "%'"; }
            string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
            if (res.Length <= 3)
            {
                if (!string.IsNullOrEmpty(res)) { strSQL += " and e.Specs like '%" + res + "%'"; }
            }
            if (res.Length > 3 && res.Length <= 5)
            {
                strSQL += " and (e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or e.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
            }
            if (res.Length > 5)
            {
                strSQL += " and (e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
            }
            if (!entity.ClientNum.Equals(0)) { strSQL += " and b.PayClientNum=" + entity.ClientNum; }
            //花纹
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and e.Figure like '%" + entity.Figure + "%'"; }
            if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and e.GoodsCode like '%" + entity.GoodsCode + "%'"; }
            //二级类型ID
            if (!entity.TypeID.Equals(0)) { strSQL += " and e.TypeID=" + entity.TypeID; }
            //以一级类型ID为查询条件
            if (!entity.TypeParentID.Equals(0)) { strSQL += " and f.ParentID=" + entity.TypeParentID; }
            if (!entity.FirstAreaID.Equals(0)) { strSQL += " and k.AreaID = " + entity.FirstAreaID + ""; }
            //出库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.AwbStatus))
            {
                strSQL += " and b.AwbStatus='" + entity.AwbStatus + "'";
            }
            if (!string.IsNullOrEmpty(entity.CargoPermisID))
            {
                strSQL += " and d.HouseID in (" + entity.CargoPermisID + ")";
            }
            //公司类型
            if (!string.IsNullOrEmpty(entity.BelongHouse)) { strSQL += " and b.BelongHouse = " + entity.BelongHouse; }
            if (!string.IsNullOrEmpty(entity.ProductName)) { strSQL += " and e.ProductName like '%" + entity.ProductName + "%'"; }
            //if (!string.IsNullOrEmpty(entity.BelongDepart)) { strSQL += " and e.BelongDepart = '" + entity.BelongDepart + "'"; }
            if (!string.IsNullOrEmpty(entity.BelongDepart)) { strSQL += " and b.BusinessID = " + entity.BelongDepart; }
            if (!string.IsNullOrEmpty(entity.TrafficType)) { strSQL += " and b.TrafficType='" + entity.TrafficType + "'"; }
            if (!string.IsNullOrEmpty(entity.OrderType)) { strSQL += " and b.OrderType='" + entity.OrderType + "'"; }
            if (!string.IsNullOrEmpty(entity.BusinessID)) { strSQL += " and b.BusinessID=" + Convert.ToInt32(entity.BusinessID); }
            if (!string.IsNullOrEmpty(entity.SpecsType) && entity.SpecsType != "-1") { strSQL += " and SpecsType=" + (entity.SpecsType); }
            if (entity.CargoPermisID == "47")
            {
                strSQL += " and g.PriceType=b.ThrowGood ";
            }
            strSQL += " order by b.CreateDate";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            //CargoAreaEntity cargoArea = new CargoAreaEntity();
                            //CargoAreaEntity hArea = new CargoAreaEntity();
                            //if (entity.CargoPermisID.IndexOf('3') > -1)
                            //{
                            //    //如果父ID不为0，则查询父ID的区域名称
                            //    if (!Convert.ToInt32(idrCount["ParentID"]).Equals(0))
                            //    {
                            //        cargoArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idrCount["ParentID"]) });
                            //        if (!cargoArea.ParentID.Equals(0))
                            //        {
                            //            hArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                            //        }
                            //    }
                            //}
                            //string tag = string.Empty;
                            //if (entity.Size == "导出")
                            //{
                            //    if (!result.Exists(c => c.OrderNo.Equals(Convert.ToString(idrCount["OrderNo"]))))
                            //    {
                            //        if (!string.IsNullOrEmpty(Convert.ToString(idrCount["OrderNo"])))
                            //        {
                            //            List<CargoProductTagEntity> prodTag = product.QueryProductTagList(new CargoProductTagEntity { OrderNo = Convert.ToString(idrCount["OrderNo"]) });
                            //            foreach (var p in prodTag) { tag += p.TyreCode + ","; }
                            //        }
                            //    }
                            //}
                            if (entity.CargoPermisID == "47")
                            {
                                result.Add(new CargoDailyReportEntity
                                {
                                    //ID = Convert.ToInt64(idrCount["ID"]),
                                    //ContainerID = Convert.ToInt32(idrCount["ContainerID"]),
                                    Piece = Convert.ToInt32(idrCount["Piece"]),
                                    OutHouseTime = Convert.ToDateTime(idrCount["CreateDate"]),
                                    //IsPrintOutCargo = Convert.ToString(idrCount["IsPrintOutCargo"]).Equals("0") ? false : true,
                                    OutCargoID = Convert.ToString(idrCount["OutCargoID"]),
                                    TypeName = Convert.ToString(idrCount["TypeName"]),
                                    ProductID = Convert.ToInt64(idrCount["ProductID"]),
                                    ProductCode = Convert.ToString(idrCount["ProductCode"]),
                                    ProductName = Convert.ToString(idrCount["ProductName"]),
                                    TypeID = Convert.ToInt32(idrCount["TypeID"]),
                                    Model = Convert.ToString(idrCount["Model"]),
                                    GoodsCode = Convert.ToString(idrCount["GoodsCode"]),
                                    Figure = Convert.ToString(idrCount["Figure"]),
                                    Specs = Convert.ToString(idrCount["Specs"]),
                                    TreadWidth = Convert.ToInt32(idrCount["TreadWidth"]),
                                    FlatRatio = Convert.ToInt32(idrCount["FlatRatio"]),
                                    Meridian = Convert.ToString(idrCount["Meridian"]),
                                    HubDiameter = Convert.ToInt32(idrCount["HubDiameter"]),
                                    LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                                    SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                                    SpeedMax = Convert.ToInt32(idrCount["SpeedMax"]),
                                    Size = Convert.ToString(idrCount["Size"]),
                                    Weight = Convert.ToDecimal(idrCount["Weight"]),
                                    UnitPrice = Convert.ToDecimal(idrCount["UnitPrice"]),
                                    Numbers = Convert.ToInt32(idrCount["Numbers"]),
                                    CostPrice = Convert.ToDecimal(idrCount["CostPrice"]),
                                    TradePrice = Convert.ToDecimal(idrCount["TradePrice"]),
                                    SalePrice = Convert.ToDecimal(idrCount["ActSalePrice"]),
                                    ContainerCode = Convert.ToString(idrCount["ContainerCode"]),
                                    //ContainerType = Convert.ToString(idrCount["ContainerType"]),
                                    AreaID = Convert.ToInt32(idrCount["AreaID"]),
                                    Batch = Convert.ToString(idrCount["Batch"]),
                                    BatchWeek = Convert.ToInt32(idrCount["BatchWeek"]),
                                    BatchYear = Convert.ToInt32(idrCount["BatchYear"]),
                                    AwbStatus = Convert.ToString(idrCount["AwbStatus"]),
                                    AreaName = Convert.ToString(idrCount["AreaName"]),
                                    StartDate = entity.StartDate,
                                    EndDate = entity.EndDate,
                                    OrderNo = Convert.ToString(idrCount["OrderNo"]),
                                    FirstAreaID = Convert.ToInt32(idrCount["FirstAreaID"]),
                                    FirstAreaName = Convert.ToString(idrCount["FirstAreaName"]),
                                    ParentAreaID = Convert.ToInt32(idrCount["ParentAreaID"]),
                                    ParentAreaName = Convert.ToString(idrCount["ParentAreaName"]),
                                    Remark = Convert.ToString(idrCount["Remark"]),
                                    LogisAwbNo = Convert.ToString(idrCount["LogisAwbNo"]),
                                    HouseName = Convert.ToString(idrCount["HouseName"]),
                                    OrderModel = Convert.ToInt32(idrCount["OrderModel"]),
                                    TyreCode = Convert.ToString(idrCount["TyreCode"]),
                                    AcceptUnit = Convert.ToString(idrCount["AcceptUnit"]),
                                    SalePriceClient = Convert.ToDecimal(idrCount["SalePriceClient"]),
                                    CostPriceStore = Convert.ToDecimal(idrCount["CostPriceStore"])
                                });
                            }
                            else
                            {
                                result.Add(new CargoDailyReportEntity
                                {
                                    //ID = Convert.ToInt64(idrCount["ID"]),
                                    //ContainerID = Convert.ToInt32(idrCount["ContainerID"]),
                                    Piece = Convert.ToString(idrCount["ThrowGood"]).Equals("25") ? -Convert.ToInt32(idrCount["Piece"]) : Convert.ToInt32(idrCount["Piece"]),
                                    CreateDate = Convert.ToDateTime(idrCount["CreateDate"]),
                                    OutHouseTime = string.IsNullOrEmpty(Convert.ToString(idrCount["OutCargoTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idrCount["OutCargoTime"]),
                                    SignDate = string.IsNullOrEmpty(Convert.ToString(idrCount["SignTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idrCount["SignTime"]),
                                    HAwbNo = Convert.ToString(idrCount["HAwbNo"]),
                                    ShopCode = Convert.ToString(idrCount["ShopCode"]),
                                    //IsPrintOutCargo = Convert.ToString(idrCount["IsPrintOutCargo"]).Equals("0") ? false : true,
                                    OutCargoID = Convert.ToString(idrCount["OutCargoID"]),
                                    TypeName = Convert.ToString(idrCount["TypeName"]),
                                    ProductID = Convert.ToInt64(idrCount["ProductID"]),
                                    ProductCode = Convert.ToString(idrCount["ProductCode"]),
                                    ProductName = Convert.ToString(idrCount["ProductName"]),
                                    TypeID = Convert.ToInt32(idrCount["TypeID"]),
                                    Model = Convert.ToString(idrCount["Model"]),
                                    GoodsCode = Convert.ToString(idrCount["GoodsCode"]),
                                    ShowGoodsCode = Convert.ToString(idrCount["ShowGoodsCode"]),
                                    ShowTypeName = Convert.ToString(idrCount["ShowTypeName"]),
                                    Figure = Convert.ToString(idrCount["Figure"]),
                                    Specs = Convert.ToString(idrCount["Specs"]),
                                    TreadWidth = Convert.ToInt32(idrCount["TreadWidth"]),
                                    FlatRatio = Convert.ToInt32(idrCount["FlatRatio"]),
                                    Meridian = Convert.ToString(idrCount["Meridian"]),
                                    HubDiameter = Convert.ToInt32(idrCount["HubDiameter"]),
                                    LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                                    SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                                    SpeedMax = Convert.ToInt32(idrCount["SpeedMax"]),
                                    Size = Convert.ToString(idrCount["Size"]),
                                    Weight = Convert.ToDecimal(idrCount["Weight"]),
                                    UnitPrice = Convert.ToDecimal(idrCount["UnitPrice"]),
                                    Numbers = Convert.ToInt32(idrCount["Numbers"]),
                                    CostPrice = Convert.ToDecimal(idrCount["CostPrice"]),
                                    TradePrice = Convert.ToDecimal(idrCount["TradePrice"]),
                                    SalePrice = Convert.ToDecimal(idrCount["ActSalePrice"]),
                                    ContainerCode = Convert.ToString(idrCount["ContainerCode"]),
                                    //ContainerType = Convert.ToString(idrCount["ContainerType"]),
                                    Source = Convert.ToString(idrCount["SourceName"]),
                                    AreaID = Convert.ToInt32(idrCount["AreaID"]),
                                    Batch = Convert.ToString(idrCount["Batch"]),
                                    BatchWeek = Convert.ToInt32(idrCount["BatchWeek"]),
                                    BatchYear = Convert.ToInt32(idrCount["BatchYear"]),
                                    AwbStatus = Convert.ToString(idrCount["AwbStatus"]),
                                    AreaName = Convert.ToString(idrCount["AreaName"]),
                                    StartDate = entity.StartDate,
                                    EndDate = entity.EndDate,
                                    OrderNo = Convert.ToString(idrCount["OrderNo"]),
                                    FirstAreaID = Convert.ToInt32(idrCount["FirstAreaID"]),
                                    FirstAreaName = Convert.ToString(idrCount["FirstAreaName"]),
                                    ParentAreaID = Convert.ToInt32(idrCount["ParentAreaID"]),
                                    ParentAreaName = Convert.ToString(idrCount["ParentAreaName"]),
                                    AcceptUnit = Convert.ToString(idrCount["AcceptUnit"]),
                                    Remark = Convert.ToString(idrCount["Remark"]),
                                    LogisAwbNo = Convert.ToString(idrCount["LogisAwbNo"]),

                                    HouseName = Convert.ToString(idrCount["HouseName"]),
                                    OrderModel = Convert.ToInt32(idrCount["OrderModel"]),
                                    ThrowGood = Convert.ToString(idrCount["ThrowGood"]),
                                    TyreCode = Convert.ToString(idrCount["TyreCode"]),
                                    OrderType = Convert.ToString(idrCount["OrderType"]),
                                    BelongDepart = Convert.ToString(idrCount["BelongDepart"]),
                                    SpecsType = Convert.ToString(idrCount["SpecsType"]),
                                    Supplier = Convert.ToString(idrCount["Supplier"])
                                });
                            }
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询业务员报日报表 
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QuerySaleManDailyReport(int pIndex, int pNum, SaleManReportEntity entity)
        {
            List<SaleManReportEntity> result = new List<SaleManReportEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select DISTINCT ROW_NUMBER() OVER (ORDER BY b.CreateDate DESC,a.OP_DATE asc) AS RowNumber, a.OrderNo,a.ProductID,a.HouseID,a.AreaID,a.ContainerCode,ISNULL(a.ActSalePrice,0) as ActSalePrice,a.Piece,ISNULL(a.Piece*a.ActSalePrice,0) as OnlyCharge,ISNULL(a.OutCargoID,'') as OutCargoID,a.ShowGoodsCode,a.ShowTypeName,b.OrderID,b.Dep,b.Dest,b.OrderType,b.InsuranceFee,b.TransportFee,b.DeliveryFee,b.TotalCharge,b.AcceptUnit,b.AcceptPeople,b.AcceptCellphone,b.AcceptAddress,b.CreateAwb,b.CreateDate,b.SaleManID,b.SaleManName,b.OrderModel,b.Remark,b.DeliverySettlement,b.ModifyPriceStatus,c.Name as HouseName,d.Name as AreaName,e.ProductName,e.Figure,e.Specs,e.Model,ISNULL(e.Batch,'') as Batch,e.LoadIndex,e.SpeedLevel,ISNULL(e.BatchYear,0) as BatchYear,ISNULL(e.BatchWeek,0) as BatchWeek,ISNULL(f.LogisticName,'') as LogisticName,e.InHouseTime,e.BelongMonth,ISNULL(b.LogisAwbNo,'') as LogisAwbNo,ISNULL(b.TransitFee,0) as TransitFee,ISNULL(e.UnitPrice,0) as UnitPrice,ISNULL(e.CostPrice,0) as CostPrice,ISNULL(e.TaxCostPrice,0) as TaxCostPrice,ISNULL(e.NoTaxCostPrice,0) as NoTaxCostPrice,ISNULL(d.ParentID,0) as ParentID,e.GoodsCode,ISNULL(b.ClientNum,0) as ClientNum,m.Boss as ClientName,k.TypeName,ISNULL(m.TryeClientCode,'') as TryeClientCode,m.TryeClientType,b.ThrowGood,b.TranHouse,(a.ActSalePrice-e.CostPrice)*a.Piece as Gross,ISNULL(e.FinalCostPrice,0) as FinalCostPrice,e.Source,b.PayClientName,h.Name as FirstAreaName,h.AreaID as FirstAreaID,g.Name as ParentAreaName,g.AreaID as ParentAreaID,m.BusUserName,m.ShopCode,e.Supplier,b.HAwbNo,m.Province,m.City,b.OpenOrderNo,e.ProductCode,b.BateAmount,b.OnlinePaidAmount from Tbl_Cargo_OrderGoods as a inner join Tbl_Cargo_Order as b on a.OrderNo=b.OrderNo inner join Tbl_Cargo_House as c on a.HouseID=c.HouseID left join Tbl_Cargo_Area as d on a.AreaID=d.AreaID left join Tbl_Cargo_Product as e on a.ProductID=e.ProductID and a.HouseID=e.HouseID left join Tbl_Cargo_ProductType as k on e.TypeID=k.TypeID left join Tbl_Cargo_Logistic as f on b.LogisID=f.ID left join Tbl_Cargo_Client as m on b.ClientNum=m.ClientNum";
                //if (!entity.FirstAreaID.Equals(0))
                //{
                strSQL += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID left join Tbl_Cargo_Area as h on g.ParentID=h.AreaID ";
                //}
                strSQL += " where (1=1)";
                if (!entity.FirstAreaID.Equals(0)) { strSQL += " and h.AreaID = " + entity.FirstAreaID; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strSQL += " and e.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strSQL += " and (e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or e.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strSQL += " and (e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                if (!entity.ParentTypeID.Equals(0))
                {
                    strSQL += " and k.ParentID=" + entity.ParentTypeID;
                }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and e.TypeID=" + entity.TypeID; }
                else if (!string.IsNullOrEmpty(entity.TypeIDs)) { strSQL += " and e.TypeID in (" + entity.TypeIDs + ")"; }
                if (!entity.ProductID.Equals(0)) { strSQL += " and e.ProductID ='" + entity.ProductID + "'"; }
                //以业务员为查询条件
                if (!string.IsNullOrEmpty(entity.SaleManID)) { strSQL += " and b.SaleManID ='" + entity.SaleManID + "'"; }
                //下单方式
                if (!string.IsNullOrEmpty(entity.OrderType)) { strSQL += " and b.OrderType ='" + entity.OrderType + "'"; }
                if (!string.IsNullOrEmpty(entity.ThrowGood))
                {
                    if (entity.ThrowGood.IndexOf(',') > -1)
                    {
                        string[] ThrowGood = entity.ThrowGood.Split(',');
                        strSQL += " and (";
                        for (int i = 0; i < ThrowGood.Length; i++)
                        {
                            strSQL += " b.ThrowGood ='" + ThrowGood[i] + "'";
                            if (i < ThrowGood.Length - 1)
                            {
                                strSQL += " or ";
                            }
                        }
                        strSQL += " )";
                    }
                    else
                    {
                        strSQL += " and b.ThrowGood ='" + entity.ThrowGood + "'";
                    }
                }
                if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and b.OrderModel ='" + entity.OrderModel + "'"; }
                //收货单位,人
                //if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strSQL += " and b.AcceptPeople like '%" + entity.AcceptPeople + "%'"; }
                if (!string.IsNullOrEmpty(entity.ClientName)) { strSQL += " and m.Boss like '%" + entity.ClientName + "%'"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and b.HouseID in (" + entity.CargoPermisID + ")"; }
                //公司类型
                if (!string.IsNullOrEmpty(entity.BelongHouse)) { strSQL += " and b.BelongHouse = " + entity.BelongHouse; }
                if (!string.IsNullOrEmpty(entity.TrafficType)) { strSQL += " and b.TrafficType = " + entity.TrafficType; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and e.Figure like '%" + entity.Figure + "%'"; }

                if (!string.IsNullOrEmpty(entity.Source))
                {
                    if (entity.Source.IndexOf(',') > -1)
                    {
                        string[] Source = entity.Source.Split(',');
                        strSQL += " and (";
                        for (int i = 0; i < Source.Length; i++)
                        {
                            strSQL += " e.Source ='" + Source[i] + "'";
                            if (i < Source.Length - 1)
                            {
                                strSQL += " or ";
                            }
                        }
                        strSQL += " )";
                    }
                    else
                    {
                        strSQL += " and e.Source ='" + entity.Source + "'";
                    }
                }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and b.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and b.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.AcceptPeople))
                {
                    if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strSQL += " and b.AcceptPeople like '%" + entity.AcceptPeople + "%'"; }
                }
                if (!string.IsNullOrEmpty(entity.CreateAwb))
                {
                    strSQL += " and b.CreateAwb like '%" + entity.CreateAwb + "%'";
                }
                if (!entity.BusinessID.Equals(0)) { strSQL += " and b.BusinessID = " + entity.BusinessID; }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1)) order by A.RowNumber";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        #region 取值
                        foreach (DataRow idr in dd.Rows)
                        {
                            result.Add(new SaleManReportEntity
                            {
                                RowNumber = Convert.ToInt32(idr["RowNumber"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductCode = Convert.ToString(idr["ProductCode"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                OrderID = Convert.ToInt64(idr["OrderID"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]).Trim(),
                                ModifyPriceStatus = Convert.ToInt32(idr["ModifyPriceStatus"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                Model = Convert.ToString(idr["Model"]).Trim(),
                                Figure = Convert.ToString(idr["Figure"]).Trim(),
                                Specs = Convert.ToString(idr["Specs"]).Trim(),
                                Batch = Convert.ToString(idr["Batch"]).Trim(),
                                BatchWeek = !string.IsNullOrEmpty(Convert.ToString(idr["BatchWeek"])) ? Convert.ToInt32(idr["BatchWeek"]) : 0,
                                BatchYear = !string.IsNullOrEmpty(Convert.ToString(idr["BatchYear"])) ? Convert.ToInt32(idr["BatchYear"]) : 0,
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]).Trim(),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]).Trim(),
                                ShowGoodsCode = Convert.ToString(idr["ShowGoodsCode"]),
                                ShowTypeName = Convert.ToString(idr["ShowTypeName"]),
                                ActSalePrice = Convert.ToDecimal(idr["ActSalePrice"]),
                                UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                                CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                TaxCostPrice = Convert.ToDecimal(idr["TaxCostPrice"]),
                                NoTaxCostPrice = Convert.ToDecimal(idr["NoTaxCostPrice"]),
                                FinalCostPrice = Convert.ToDecimal(idr["FinalCostPrice"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                OutCargoID = Convert.ToString(idr["OutCargoID"]),
                                Dep = Convert.ToString(idr["Dep"]),
                                Dest = Convert.ToString(idr["Dest"]),
                                OrderType = Convert.ToString(idr["OrderType"]),
                                TransportFee = Convert.ToDecimal(idr["OnlyCharge"]),
                                InsuranceFee = Convert.ToDecimal(idr["InsuranceFee"]),
                                DeliveryFee = Convert.ToDecimal(idr["DeliveryFee"]),
                                Gross = !string.IsNullOrEmpty(Convert.ToString(idr["Gross"])) ? Convert.ToDecimal(idr["Gross"]) : 0,
                                TotalCharge = Convert.ToDecimal(idr["TotalCharge"]),
                                AcceptUnit = Convert.ToString(idr["AcceptUnit"]),
                                AcceptAddress = Convert.ToString(idr["AcceptAddress"]),
                                AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                                AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                SaleManID = Convert.ToString(idr["SaleManID"]),
                                SaleManName = Convert.ToString(idr["SaleManName"]),
                                BusUserName = Convert.ToString(idr["BusUserName"]),
                                ShopCode = Convert.ToString(idr["ShopCode"]),
                                CreateAwb = Convert.ToString(idr["CreateAwb"]),
                                Source = Convert.ToString(idr["Source"]),
                                StartDate = entity.StartDate,
                                EndDate = entity.EndDate,
                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                LogisAwbNo = Convert.ToString(idr["LogisAwbNo"]),
                                LogisticName = Convert.ToString(idr["LogisticName"]),
                                TransitFee = Convert.ToDecimal(idr["TransitFee"]),
                                BateAmount = string.IsNullOrEmpty(Convert.ToString(idr["BateAmount"])) ? 0 : Convert.ToDecimal(idr["BateAmount"]),
                                OnlinePaidAmount =string.IsNullOrEmpty(Convert.ToString(idr["OnlinePaidAmount"]))?0: Convert.ToDecimal(idr["OnlinePaidAmount"]),
                                FirstAreaID = Convert.ToInt32(idr["FirstAreaID"]),
                                FirstAreaName = Convert.ToString(idr["FirstAreaName"]),
                                ParentAreaID = Convert.ToInt32(idr["ParentAreaID"]),
                                ParentAreaName = Convert.ToString(idr["ParentAreaName"]),
                                ThrowGood = Convert.ToString(idr["ThrowGood"]),
                                TranHouse = Convert.ToString(idr["TranHouse"]),
                                TryeClientCode = Convert.ToString(idr["TryeClientCode"]),
                                TryeClientType = Convert.ToString(idr["TryeClientType"]),
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                ClientName = Convert.ToString(idr["ClientName"]),
                                InHouseTime = string.IsNullOrEmpty(Convert.ToString(idr["InHouseTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["InHouseTime"]),
                                BelongMonth = Convert.ToString(idr["BelongMonth"]),
                                Remark = Convert.ToString(idr["Remark"]),
                                PayClientName = Convert.ToString(idr["PayClientName"]),
                                Supplier = Convert.ToString(idr["Supplier"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                HAwbNo = Convert.ToString(idr["HAwbNo"]),
                                Province = Convert.ToString(idr["Province"]),
                                City = Convert.ToString(idr["City"]),
                                OpenOrderNo = Convert.ToString(idr["OpenOrderNo"]),
                                //ShowGoodsCode = Convert.ToString(idr["ShowGoodsCode"]),
                                DeliverySettlement = Convert.ToString(idr["DeliverySettlement"])
                            });
                        }
                        #endregion
                    }
                }

                resHT["rows"] = result;

                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_OrderGoods as a inner join Tbl_Cargo_Order as b on a.OrderNo=b.OrderNo INNER JOIN Tbl_Cargo_House AS c ON a.HouseID=c.HouseID LEFT JOIN Tbl_Cargo_Area AS d ON a.AreaID=d.AreaID LEFT JOIN Tbl_Cargo_Product AS e ON a.ProductID=e.ProductID AND a.HouseID=e.HouseID LEFT JOIN Tbl_Cargo_ProductType AS k ON e.TypeID=k.TypeID LEFT JOIN Tbl_Cargo_Logistic AS f ON b.LogisID=f.ID LEFT JOIN Tbl_Cargo_Client AS m ON b.ClientNum=m.ClientNum ";
                //if (!entity.FirstAreaID.Equals(0))
                //{
                strCount += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID left join Tbl_Cargo_Area as h on g.ParentID=h.AreaID ";
                //}
                strCount += " where (1=1)";
                if (!entity.FirstAreaID.Equals(0)) { strCount += " and h.AreaID = " + entity.FirstAreaID + ""; }
                //规格
                if (!string.IsNullOrEmpty(entity.Specs))
                {
                    string res = entity.Specs.ToUpper().Replace("/", "").Replace("R", "").Replace("C", "").Replace("F", "").Replace("Z", "");
                    if (res.Length <= 3)
                    {
                        if (!string.IsNullOrEmpty(res)) { strCount += " and e.Specs like '%" + res + "%'"; }
                    }
                    if (res.Length > 3 && res.Length <= 5)
                    {
                        strCount += " and (e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, res.Length - 3) + "%' or e.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                    if (res.Length > 5)
                    {
                        strCount += " and (e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "R" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "RF" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZR" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "/" + res.Substring(3, 2) + "ZRF" + res.Substring(5, res.Length - 5) + "%' or e.Specs like '%" + res.Substring(0, 3) + "R" + res.Substring(3, res.Length - 3) + "%')";
                    }
                }
                if (!entity.ParentTypeID.Equals(0))
                {
                    strCount += " and k.ParentID=" + entity.ParentTypeID;
                }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strCount += " and e.TypeID=" + entity.TypeID; }
                else if (!string.IsNullOrEmpty(entity.TypeIDs)) { strCount += " and e.TypeID in (" + entity.TypeIDs + ")"; }
                //以业务员为查询条件
                if (!string.IsNullOrEmpty(entity.SaleManID)) { strCount += " and b.SaleManID ='" + entity.SaleManID + "'"; }
                //下单方式
                if (!string.IsNullOrEmpty(entity.OrderType)) { strCount += " and b.OrderType ='" + entity.OrderType + "'"; }
                if (!string.IsNullOrEmpty(entity.ThrowGood))
                {
                    if (entity.ThrowGood.IndexOf(',') > -1)
                    {
                        string[] ThrowGood = entity.ThrowGood.Split(',');
                        strCount += " and (";
                        for (int i = 0; i < ThrowGood.Length; i++)
                        {
                            strCount += " b.ThrowGood ='" + ThrowGood[i] + "'";
                            if (i < ThrowGood.Length - 1)
                            {
                                strCount += " or ";
                            }
                        }
                        strCount += " )";
                    }
                    else
                    {
                        strCount += " and b.ThrowGood ='" + entity.ThrowGood + "'";
                    }
                }
                if (!string.IsNullOrEmpty(entity.OrderModel)) { strCount += " and b.OrderModel ='" + entity.OrderModel + "'"; }
                //收货单位,人
                //if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strCount += " and b.AcceptPeople like '%" + entity.AcceptPeople + "%'"; }
                if (!string.IsNullOrEmpty(entity.ClientName)) { strCount += " and m.Boss like '%" + entity.ClientName + "%'"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and b.HouseID in (" + entity.CargoPermisID + ")"; }
                //公司类型
                if (!string.IsNullOrEmpty(entity.BelongHouse)) { strCount += " and b.BelongHouse = " + entity.BelongHouse; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and e.Figure like '%" + entity.Figure + "%'"; }

                if (!string.IsNullOrEmpty(entity.Source))
                {
                    if (entity.Source.IndexOf(',') > -1)
                    {
                        string[] Source = entity.Source.Split(',');
                        strCount += " and (";
                        for (int i = 0; i < Source.Length; i++)
                        {
                            strCount += " e.Source ='" + Source[i] + "'";
                            if (i < Source.Length - 1)
                            {
                                strCount += " or ";
                            }
                        }
                        strCount += " )";
                    }
                    else
                    {
                        strCount += " and e.Source ='" + entity.Source + "'";
                    }
                }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and b.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and b.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.AcceptPeople))
                {
                    if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strCount += " and b.AcceptPeople like '%" + entity.AcceptPeople + "%'"; }
                }
                if (!entity.BusinessID.Equals(0)) { strCount += " and b.BusinessID = " + entity.BusinessID; }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        public List<SaleManReportEntity> QueryGrossReport(SaleManReportEntity entity)
        {
            CargoHouseManager house = new CargoHouseManager();
            List<SaleManReportEntity> result = new List<SaleManReportEntity>();

            string strSQL = @" SELECT ROW_NUMBER() OVER (ORDER BY b.CreateDate DESC) AS RowNumber,a.OrderNo,a.ProductID,a.HouseID,a.AreaID,a.ContainerCode,ISNULL(a.ActSalePrice,0) as ActSalePrice,a.Piece,ISNULL(a.Piece*a.ActSalePrice,0) as OnlyCharge,ISNULL(a.OutCargoID,'') as OutCargoID,b.OrderID,b.Dep,b.Dest,b.OrderType,b.TransportFee,b.TotalCharge,b.AcceptUnit,b.AcceptPeople,b.AcceptCellphone,b.AcceptAddress,b.CreateAwb,b.CreateDate,b.SaleManID,b.SaleManName,b.OrderModel,c.Name as HouseName,d.Name as AreaName,e.ProductName,e.Figure,e.Specs,e.Model,ISNULL(e.Batch,'') as Batch,e.LoadIndex,e.SpeedLevel,ISNULL(e.BatchYear,0) as BatchYear,ISNULL(e.BatchWeek,0) as BatchWeek,e.InHouseTime,e.BelongMonth,ISNULL(b.LogisAwbNo,'') as LogisAwbNo,ISNULL(b.TransitFee,0) as TransitFee,ISNULL(e.UnitPrice,0) as UnitPrice,ISNULL(e.CostPrice,0) as CostPrice,ISNULL(d.ParentID,0) as ParentID,e.GoodsCode,ISNULL(b.ClientNum,0) as ClientNum,cl.Boss as ClientName,k.TypeName,b.ThrowGood,b.TranHouse,a.ActSalePrice-e.CostPrice as Gross,h.Name as FirstAreaName,h.AreaID as FirstAreaID,g.Name as ParentAreaName,g.AreaID as ParentAreaID from Tbl_Cargo_OrderGoods as a inner join Tbl_Cargo_Order as b on a.OrderNo=b.OrderNo inner join Tbl_Cargo_Client cl on cl.ClientNum=b.ClientNum inner join Tbl_Cargo_House as c on a.HouseID=c.HouseID left join Tbl_Cargo_Area as d on a.AreaID=d.AreaID inner join Tbl_Cargo_Product as e on a.ProductID=e.ProductID and a.HouseID=e.HouseID left join Tbl_Cargo_ProductType as k on e.TypeID=k.TypeID ";
            //if (!entity.FirstAreaID.Equals(0))
            //{
            strSQL += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID left join Tbl_Cargo_Area as h on g.ParentID=h.AreaID ";
            //}
            strSQL += " where (1=1)";
            if (!entity.FirstAreaID.Equals(0)) { strSQL += " and h.AreaID = " + entity.FirstAreaID + ""; }
            //规格
            if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and e.Specs like '%" + entity.Specs + "%'"; }
            //二级类型ID
            if (!entity.TypeID.Equals(0)) { strSQL += " and e.TypeID=" + entity.TypeID; }
            //以业务员为查询条件
            if (!string.IsNullOrEmpty(entity.SaleManID)) { strSQL += " and b.SaleManID ='" + entity.SaleManID + "'"; }
            //下单方式
            if (!string.IsNullOrEmpty(entity.OrderType)) { strSQL += " and b.OrderType ='" + entity.OrderType + "'"; }
            if (!string.IsNullOrEmpty(entity.ThrowGood)) { strSQL += " and b.ThrowGood ='" + entity.ThrowGood + "'"; }
            if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and b.OrderModel ='" + entity.OrderModel + "'"; }
            //收货单位,人
            if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strSQL += " and cl.Boss like '%" + entity.AcceptPeople + "%'"; }
            //所属仓库ID
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and b.HouseID in (" + entity.CargoPermisID + ")"; }
            //制单日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    #region 取值
                    foreach (DataRow idr in dd.Rows)
                    {
                        //CargoAreaEntity cargoArea = new CargoAreaEntity();
                        //CargoAreaEntity hArea = new CargoAreaEntity();
                        ////如果父ID不为0，则查询父ID的区域名称
                        //if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                        //{
                        //    cargoArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                        //    if (!cargoArea.ParentID.Equals(0))
                        //    {
                        //        hArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                        //    }
                        //}
                        result.Add(new SaleManReportEntity
                        {
                            RowNumber = Convert.ToInt32(idr["RowNumber"]),
                            ProductID = Convert.ToInt64(idr["ProductID"]),
                            ProductName = Convert.ToString(idr["ProductName"]),
                            TypeName = Convert.ToString(idr["TypeName"]),
                            OrderID = Convert.ToInt64(idr["OrderID"]),
                            OrderNo = Convert.ToString(idr["OrderNo"]).Trim(),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            AreaID = Convert.ToInt32(idr["AreaID"]),
                            Model = Convert.ToString(idr["Model"]).Trim(),
                            Figure = Convert.ToString(idr["Figure"]).Trim(),
                            Specs = Convert.ToString(idr["Specs"]).Trim(),
                            Batch = Convert.ToString(idr["Batch"]).Trim(),
                            BatchWeek = Convert.ToInt32(idr["BatchWeek"]),
                            BatchYear = Convert.ToInt32(idr["BatchYear"]),
                            LoadIndex = Convert.ToString(idr["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                            ContainerCode = Convert.ToString(idr["ContainerCode"]).Trim(),
                            GoodsCode = Convert.ToString(idr["GoodsCode"]).Trim(),
                            ActSalePrice = Convert.ToDecimal(idr["ActSalePrice"]),
                            UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                            CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                            Piece = Convert.ToInt32(idr["Piece"]),
                            OutCargoID = Convert.ToString(idr["OutCargoID"]),
                            Dep = Convert.ToString(idr["Dep"]),
                            Dest = Convert.ToString(idr["Dest"]),
                            OrderType = Convert.ToString(idr["OrderType"]),
                            TransportFee = Convert.ToDecimal(idr["OnlyCharge"]),
                            Gross = Convert.ToDecimal(idr["Gross"]),
                            TotalGross = Convert.ToDecimal(idr["Gross"]) * Convert.ToInt32(idr["Piece"]),
                            TotalCharge = Convert.ToDecimal(idr["TotalCharge"]),
                            AcceptUnit = Convert.ToString(idr["AcceptUnit"]).Trim(),
                            AcceptAddress = Convert.ToString(idr["AcceptAddress"]).Trim(),
                            AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]).Trim(),
                            AcceptPeople = Convert.ToString(idr["AcceptPeople"]).Trim(),
                            AreaName = Convert.ToString(idr["AreaName"]).Trim(),
                            HouseName = Convert.ToString(idr["HouseName"]).Trim(),
                            SaleManID = Convert.ToString(idr["SaleManID"]).Trim(),
                            SaleManName = Convert.ToString(idr["SaleManName"]).Trim(),
                            CreateAwb = Convert.ToString(idr["CreateAwb"]).Trim(),
                            StartDate = entity.StartDate,
                            EndDate = entity.EndDate,
                            OrderModel = Convert.ToString(idr["OrderModel"]),
                            LogisAwbNo = Convert.ToString(idr["LogisAwbNo"]),
                            TransitFee = Convert.ToDecimal(idr["TransitFee"]),
                            FirstAreaID = Convert.ToInt32(idr["FirstAreaID"]),
                            FirstAreaName = Convert.ToString(idr["FirstAreaName"]),
                            ParentAreaID = Convert.ToInt32(idr["ParentAreaID"]),
                            ParentAreaName = Convert.ToString(idr["ParentAreaName"]),
                            ThrowGood = Convert.ToString(idr["ThrowGood"]),
                            TranHouse = Convert.ToString(idr["TranHouse"]),
                            ClientNum = Convert.ToInt32(idr["ClientNum"]),
                            ClientName = Convert.ToString(idr["ClientName"]),
                            InHouseTime = string.IsNullOrEmpty(Convert.ToString(idr["InHouseTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["InHouseTime"]),
                            BelongMonth = Convert.ToString(idr["BelongMonth"]),
                            CreateDate = Convert.ToDateTime(idr["CreateDate"])
                        });
                    }
                    #endregion
                }
            }
            return result;
        }
        /// <summary>
        /// 查询每日移库报表数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoReportMoveContainerEntity> QueryMoveContainerReport(CargoReportMoveContainerEntity entity)
        {
            CargoHouseManager house = new CargoHouseManager();
            List<CargoReportMoveContainerEntity> result = new List<CargoReportMoveContainerEntity>();
            string strSQL = "select a.*,c.Name as OldAreaName,c.ParentID as OldParentID,d.Specs,d.Figure,d.Model,d.Batch,d.BatchYear,d.BatchWeek,d.GoodsCode,d.ProductName,d.CostPrice,d.TradePrice,d.SalePrice,f.Name as NewAreaName,f.ParentID as NewParentID,g.UserName,d.ProductCode From Tbl_Cargo_MoveContainer as a left join Tbl_Cargo_Container as b on a.OldCID=b.ContainerID left join Tbl_Cargo_Area as c on b.AreaID=c.AreaID ";
            if (!entity.FirstAreaID.Equals(0))
            {
                strSQL += " left join Tbl_Cargo_Area as h on c.ParentID=h.AreaID left join Tbl_Cargo_Area as k on h.ParentID=k.AreaID ";
            }
            strSQL += " left join Tbl_Cargo_Product as d on a.ProductID=d.ProductID left join Tbl_Cargo_Container as e on a.NewCID=e.ContainerID left join Tbl_Cargo_Area as f on e.AreaID=f.AreaID left join Tbl_SysUser as g on a.OPID=g.LoginName where (1=1) ";
            if (!entity.FirstAreaID.Equals(0)) { strSQL += " and k.AreaID = " + entity.FirstAreaID + ""; }
            if (!entity.ParentID.Equals(0)) { strSQL += " and h.AreaID = " + entity.ParentID + ""; }
            //移库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.OP_DATE<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.CargoPermisID))
            {
                strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")";
            }
            //if (!entity.ParentID.Equals(0))
            //{
            //    strSQL += " and c.ParentID = " + entity.ParentID + "";
            //}
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            CargoAreaEntity hArea = new CargoAreaEntity();
                            CargoAreaEntity newArea = new CargoAreaEntity();
                            //如果父ID不为0，则查询父ID的区域名称
                            if (!Convert.ToInt32(idrCount["OldParentID"]).Equals(0))
                            {
                                CargoAreaEntity cargoArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idrCount["OldParentID"]) });
                                if (!cargoArea.ParentID.Equals(0))
                                {
                                    hArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                                }
                            }
                            if (!Convert.ToInt32(idrCount["NewParentID"]).Equals(0))
                            {
                                CargoAreaEntity cargoArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idrCount["NewParentID"]) });
                                if (!cargoArea.ParentID.Equals(0))
                                {
                                    newArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                                }
                            }
                            result.Add(new CargoReportMoveContainerEntity
                            {
                                ID = Convert.ToInt64(idrCount["ID"]),
                                OldCID = Convert.ToInt32(idrCount["OldCID"]),
                                OldCCode = Convert.ToString(idrCount["OldCCode"]).Trim(),
                                OldAreaName = Convert.ToString(idrCount["OldAreaName"]).Trim(),
                                OldHouseName = hArea.Name,
                                NewHouseName = newArea.Name,
                                CostPrice = Convert.ToDecimal(idrCount["CostPrice"]),
                                SalePrice = Convert.ToDecimal(idrCount["SalePrice"]),
                                TradePrice = Convert.ToDecimal(idrCount["TradePrice"]),
                                MoveNum = Convert.ToInt32(idrCount["MoveNum"]),
                                NewCID = Convert.ToInt32(idrCount["NewCID"]),
                                NewCCode = Convert.ToString(idrCount["NewCCode"]).Trim(),
                                NewAreaName = Convert.ToString(idrCount["NewAreaName"]).Trim(),
                                MoveStatus = Convert.ToString(idrCount["MoveStatus"]).Trim(),
                                Specs = Convert.ToString(idrCount["Specs"]).Trim(),
                                Figure = Convert.ToString(idrCount["Figure"]).Trim(),
                                GoodsCode = Convert.ToString(idrCount["GoodsCode"]).Trim(),
                                Batch = Convert.ToString(idrCount["Batch"]).Trim(),
                                BatchWeek = Convert.ToInt32(idrCount["BatchWeek"]),
                                BatchYear = Convert.ToInt32(idrCount["BatchYear"]),
                                ProductID = Convert.ToInt64(idrCount["ProductID"]),
                                ProductName = Convert.ToString(idrCount["ProductName"]).Trim(),
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                OPID = Convert.ToString(idrCount["OPID"]).Trim(),
                                OP_DATE = Convert.ToDateTime(idrCount["OP_DATE"]),
                                UserName = Convert.ToString(idrCount["UserName"]).Trim(),
                                Model = Convert.ToString(idrCount["Model"]).Trim(),
                                ProductCode = Convert.ToString(idrCount["ProductCode"]).Trim()
                            });
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 查询销售轮胎平均尺寸
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDailyReportEntity> QueryAveraHub(CargoDailyReportEntity entity)
        {
            List<CargoDailyReportEntity> result = new List<CargoDailyReportEntity>();
            string strSQL = "select c.HubDiameter,SUM(b.Piece) as SaleNum,c.HubDiameter*SUM(b.Piece) as TotalSaleNum,d.Name  From Tbl_Cargo_Order as a inner join Tbl_Cargo_OrderGoods as b on a.OrderNo=b.OrderNo inner join Tbl_Cargo_Product as c on b.ProductID=c.ProductID and a.HouseID=c.HouseID inner join Tbl_Cargo_House as d on c.HouseID=d.HouseID where (1=1) ";
            //二级类型ID
            if (!entity.TypeID.Equals(0)) { strSQL += " and c.TypeID=" + entity.TypeID; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " group by c.HubDiameter,d.Name";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDailyReportEntity
                        {
                            StartDate = entity.StartDate,
                            EndDate = entity.EndDate,
                            HouseName = Convert.ToString(idrCount["Name"]),
                            Specs = Convert.ToString(idrCount["HubDiameter"]),//尺寸
                            Model = Convert.ToString(idrCount["SaleNum"]),//数量
                            Figure = Convert.ToString(idrCount["TotalSaleNum"]),//总数量
                            Piece = Convert.ToInt32(idrCount["SaleNum"]),
                            Numbers = Convert.ToInt32(idrCount["TotalSaleNum"])
                        });
                    }
                }
            }
            return result;
        }
        #endregion
        #region 领导驾驶舱
        /// <summary>
        /// 根据产品类型分类查询统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoLeaderCookpitEntity> QueryByProductType(CargoLeaderCookpitEntity entity)
        {
            List<CargoLeaderCookpitEntity> result = new List<CargoLeaderCookpitEntity>();
            string strSQL = @"select e.Name as HouseName,e.HouseID,d.TypeName,d.ParentID,Sum(b.Piece) as Piece,SUM(b.Piece*b.ActSalePrice) as TotalCharge from Tbl_Cargo_Order as a left join Tbl_Cargo_OrderGoods as b on a.OrderNo=b.OrderNo left join Tbl_Cargo_Product as c on b.ProductID=c.ProductID left join Tbl_Cargo_ProductType as d on c.TypeID=d.TypeID left join Tbl_Cargo_House as e on a.HouseID=e.HouseID where a.OrderModel='0' and d.ParentID=1 and a.CreateDate>='" + entity.StartDate.AddDays(1 - entity.StartDate.Day).ToString("yyyy-MM-dd") + "'";
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.CargoPermisID))
            {
                strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")";
            }
            strSQL += " group by d.TypeName,e.Name,e.HouseID,d.ParentID order by SUM(b.Piece) desc ";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, entity.StartDate.AddDays(1 - entity.StartDate.Day));
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoLeaderCookpitEntity
                            {
                                HouseName = Convert.ToString(idrCount["HouseName"]),
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                ParentID = Convert.ToInt32(idrCount["ParentID"]),
                                TypeName = Convert.ToString(idrCount["TypeName"]),
                                Piece = Convert.ToInt32(idrCount["Piece"]),
                                TotalCharge = Convert.ToDecimal(idrCount["TotalCharge"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 按销售业务员查询统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoLeaderCookpitEntity> QueryBySaleMan(CargoLeaderCookpitEntity entity)
        {
            List<CargoLeaderCookpitEntity> result = new List<CargoLeaderCookpitEntity>();
            string strSQL = @"select b.Name as HouseName,b.HouseID,a.SaleManName,SUM(a.Piece) as Piece,SUM(a.TotalCharge) as TotalCharge from Tbl_Cargo_Order as a left join Tbl_Cargo_House as b on a.HouseID=b.HouseID where a.OrderModel='0' and a.CreateDate>='" + entity.StartDate.AddDays(1 - entity.StartDate.Day).ToString("yyyy-MM-dd") + "' ";
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.CargoPermisID))
            {
                strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")";
            }
            strSQL += " group by b.Name,b.HouseID,a.SaleManName order by SUM(a.TotalCharge) desc";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, entity.StartDate.AddDays(1 - entity.StartDate.Day));
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoLeaderCookpitEntity
                            {
                                HouseName = Convert.ToString(idrCount["HouseName"]),
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                SaleManName = Convert.ToString(idrCount["SaleManName"]),
                                Piece = Convert.ToInt32(idrCount["Piece"]),
                                TotalCharge = Convert.ToDecimal(idrCount["TotalCharge"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 按客户数据统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoLeaderCookpitEntity> QueryByClient(CargoLeaderCookpitEntity entity)
        {
            List<CargoLeaderCookpitEntity> result = new List<CargoLeaderCookpitEntity>();
            string strSQL = @"select * from (select ROW_NUMBER() over(partition by b.HouseID order by sum(a.Piece) desc) as RNum,b.Name as HouseName,b.HouseID,a.AcceptPeople,SUM(a.Piece) as Piece,SUM(a.TotalCharge) as TotalCharge from Tbl_Cargo_Order as a left join Tbl_Cargo_House as b on a.HouseID=b.HouseID  where a.OrderModel='0' and a.CreateDate>='" + entity.StartDate.AddDays(1 - entity.StartDate.Day).ToString("yyyy-MM-dd") + "' ";
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.CargoPermisID))
            {
                strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")";
            }
            strSQL += " group by b.Name,b.HouseID,a.AcceptPeople ) as a where a.RNum<=30";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    //conn.AddInParameter(cmd, "@CreateDate", DbType.DateTime, entity.StartDate.AddDays(1 - entity.StartDate.Day));
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoLeaderCookpitEntity
                            {
                                HouseName = Convert.ToString(idrCount["HouseName"]),
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                AcceptPeople = Convert.ToString(idrCount["AcceptPeople"]),
                                Piece = Convert.ToInt32(idrCount["Piece"]),
                                TotalCharge = Convert.ToDecimal(idrCount["TotalCharge"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }
        /// <summary>
        /// 按月统计所有仓库营业数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoLeaderCookpitEntity> QueryByMonthStatis(CargoLeaderCookpitEntity entity)
        {
            List<CargoLeaderCookpitEntity> result = new List<CargoLeaderCookpitEntity>();
            string strSQL = @"select a.HouseID,a.SaleNum,a.SaleIncome,a.Year,a.Month,b.Name as HouseName,a.Title from Tbl_Cargo_MonthStatis as a left join Tbl_Cargo_House as b on a.HouseID=b.HouseID  where a.StatisType=@StatisType";
            if (!entity.HouseID.Equals(0))
            {
                strSQL += " and a.HouseID=@HouseID";
            }
            if (!entity.Year.Equals(0))
            {
                strSQL += " and a.Year=@Year";
            }
            strSQL += " Order by a.YEAR desc,a.Month desc,b.Name asc,a.SaleIncome desc";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    if (!entity.HouseID.Equals(0))
                    {
                        conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    }
                    if (!entity.Year.Equals(0))
                    {
                        conn.AddInParameter(cmd, "@Year", DbType.Int32, entity.Year);
                    }
                    conn.AddInParameter(cmd, "@StatisType", DbType.String, entity.StatisType);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoLeaderCookpitEntity
                            {
                                HouseName = Convert.ToString(idrCount["HouseName"]),
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                Title = Convert.ToString(idrCount["Title"]),
                                Month = Convert.ToInt32(idrCount["Month"]),
                                Year = Convert.ToInt32(idrCount["Year"]),
                                DisplayTime = Convert.ToString(idrCount["Year"]) + "-" + Convert.ToString(idrCount["Month"]),
                                Piece = Convert.ToInt32(idrCount["SaleNum"]),
                                TotalCharge = Convert.ToDecimal(idrCount["SaleIncome"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;

        }
        /// <summary>
        /// 查询每月的订单数
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoLeaderCookpitEntity> QueryMonthOrderNum(CargoLeaderCookpitEntity entity)
        {
            List<CargoLeaderCookpitEntity> result = new List<CargoLeaderCookpitEntity>();
            string strSQL = @"select YEAR,MONTH,HouseID,COUNT(*) as OrderNum from (select Piece,TotalCharge,HouseID,DATENAME(Year,CreateDate) as Year,DATENAME(MONTH,CreateDate) as Month from Tbl_Cargo_Order where  OrderModel=0 and HouseID=@HouseID ";
            strSQL += "";
            //制单日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            //if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            //{
            //    strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            //}
            strSQL += " ) as a group by a.Year,a.Month,a.HouseID order by YEAR,MONTH";
            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            result.Add(new CargoLeaderCookpitEntity
                            {
                                Month = Convert.ToInt32(idrCount["MONTH"]),
                                Year = Convert.ToInt32(idrCount["YEAR"]),
                                HouseID = Convert.ToInt32(idrCount["HouseID"]),
                                DisplayTime = Convert.ToString(idrCount["YEAR"]) + "-" + Convert.ToString(idrCount["MONTH"]),
                                OrderNum = Convert.ToInt32(idrCount["OrderNum"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;

        }
        /// <summary>
        /// 保存每月统计数据 每月的2和5号统计上个月的数据
        /// </summary>
        /// <param name="entity"></param>
        public void saveMonthStatis(List<CargoMonthStatisEntity> statisList)
        {
            foreach (var entity in statisList)
            {
                string strSQL = @"INSERT INTO Tbl_Cargo_MonthStatis(Title,SaleNum,SaleIncome,Year,Month,HouseID,StatisType,OP_DATE) VALUES (@Title,@SaleNum,@SaleIncome,@Year,@Month,@HouseID,@StatisType,@OP_DATE)";
                try
                {
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@Title", DbType.String, entity.Title);
                        conn.AddInParameter(cmd, "@SaleNum", DbType.Int32, entity.SaleNum);
                        conn.AddInParameter(cmd, "@SaleIncome", DbType.Decimal, entity.SaleIncome);
                        conn.AddInParameter(cmd, "@Year", DbType.Int32, entity.Year);
                        conn.AddInParameter(cmd, "@Month", DbType.Int32, entity.Month);
                        conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                        conn.AddInParameter(cmd, "@StatisType", DbType.String, entity.StatisType);
                        conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
                catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            }
        }
        /// <summary>
        /// 修改统计数据
        /// </summary>
        /// <param name="statisList"></param>
        public void updateMonthStatis(List<CargoMonthStatisEntity> statisList)
        {
            foreach (var entity in statisList)
            {
                string strSQL = @"update Tbl_Cargo_MonthStatis set SaleNum=@SaleNum,SaleIncome=@SaleIncome,OP_DATE=@OP_DATE where YEAR=@YEAR and MONTH=@MONTH and HouseID=@HouseID and StatisType=@StatisType and Title=@Title";
                try
                {
                    using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                    {
                        conn.AddInParameter(cmd, "@Title", DbType.String, entity.Title);
                        conn.AddInParameter(cmd, "@SaleNum", DbType.Int32, entity.SaleNum);
                        conn.AddInParameter(cmd, "@SaleIncome", DbType.Decimal, entity.SaleIncome);
                        conn.AddInParameter(cmd, "@Year", DbType.Int32, DateTime.Now.AddMonths(-3).Year);
                        conn.AddInParameter(cmd, "@Month", DbType.Int32, DateTime.Now.AddMonths(-3).Month);
                        conn.AddInParameter(cmd, "@HouseID", DbType.Int32, entity.HouseID);
                        conn.AddInParameter(cmd, "@StatisType", DbType.String, entity.StatisType);
                        conn.AddInParameter(cmd, "@OP_DATE", DbType.DateTime, DateTime.Now);
                        conn.ExecuteNonQuery(cmd);
                    }
                }
                catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            }
        }
        #endregion
        #region 销售库存表查询集合
        /// <summary>
        /// 查询销售库存 表
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoSaleStockStatisEntity> QuerySaleStockData(CargoSaleStockStatisEntity entity)
        {
            List<CargoSaleStockStatisEntity> result = new List<CargoSaleStockStatisEntity>();
            string sD = entity.StartDate.ToString("yyyyMM");
            string eD = entity.EndDate.ToString("yyyyMM");
            DateTime sDT = entity.StartDate;
            DateTime eDT = entity.EndDate;
            int Month = (eDT.Year - sDT.Year) * 12 + (eDT.Month - sDT.Month);
            string col = "";
            string strSQL = string.Empty;
            //优科豪马轮胎特殊处理
            if (entity.TypeID.Equals(9))
            {

                strSQL = "select G.*,R.Piece as CurrentNum,R.Specs as ASpecs,R.Figure as AFigure,R.GoodsCode as AGoodsCode from (select ISNULL(M.Specs,N.Specs) as Specs,ISNULL(M.Figure,N.Figure) as Figure,ISNULL(M.GoodsCode,N.GoodsCode) as GoodsCode, ";
                string outStr = " T.Specs,T.Figure,T.GoodsCode,";
                string inStr = " T.Specs,T.Figure,T.GoodsCode,";
                for (int i = 1; i <= Month + 1; i++)
                {
                    strSQL += " ISNULL(M.In" + i.ToString() + ",0) as In" + i.ToString() + ",";
                    strSQL += " ISNULL(N.Out" + i.ToString() + ",0) as Out" + i.ToString() + ",";
                    if (sDT.Month == eDT.Month)
                    {
                        col += "[" + eDT.ToString("yyyyMM") + "]";
                        inStr += " T.[" + sDT.ToString("yyyyMM") + "] as In" + i.ToString();
                        outStr += " T.[" + sDT.ToString("yyyyMM") + "] as Out" + i.ToString();
                    }
                    else
                    {
                        inStr += " T.[" + sDT.ToString("yyyyMM") + "] as In" + i.ToString() + ",";
                        outStr += " T.[" + sDT.ToString("yyyyMM") + "] as Out" + i.ToString() + ",";
                        col += "[" + sDT.ToString("yyyyMM") + "],";
                        sDT = sDT.AddMonths(1);
                    }
                }
                strSQL = strSQL.Substring(0, strSQL.Length - 1);
                strSQL += " from (select " + inStr + " from (select distinct f.Specs,f.Figure,f.GoodsCode,f.InDate,SUM(f.InHouseNum) over (partition by f.Specs,f.Figure,f.GoodsCode,f.InDate) as InMonthNum from (select a.Specs,a.Figure,a.GoodsCode,c.Piece as InHouseNum,SUBSTRING( Convert(varchar(100),c.InHouseTime,112),1,6) as InDate from Tbl_Cargo_Product as a inner join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID inner join Tbl_Cargo_InContainerGoods as c on a.ProductID=c.ProductID where c.InHouseType=0 ";
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID + ""; }
                if (!entity.ParentID.Equals(0)) { strSQL += " and b.ParentID=" + entity.ParentID + ""; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID + ""; }
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                strSQL += " and SUBSTRING( Convert(varchar(100),c.InHouseTime,112),1,6)>='" + sD + "' and SUBSTRING( Convert(varchar(100),c.InHouseTime,112),1,6)<='" + eD + "') as f ) as P PIVOT (SUM(InMonthNum) FOR P.InDate IN (" + col + ")) AS T ) as M full join (select " + outStr + " from (select distinct f.Specs,f.Figure,f.GoodsCode,f.InDate,SUM(f.InHouseNum) over (partition by f.Specs,f.Figure,f.GoodsCode,f.InDate) as OutMonthNum from (select a.Specs,a.Figure,a.GoodsCode,c.Piece as InHouseNum,SUBSTRING( Convert(varchar(100),c.OP_DATE,112),1,6) as InDate from Tbl_Cargo_Product as a inner join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID inner join Tbl_Cargo_OrderGoods as c on a.ProductID=c.ProductID and a.HouseID=c.HouseID where (1=1) ";
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID + ""; }
                if (!entity.ParentID.Equals(0)) { strSQL += " and b.ParentID=" + entity.ParentID + ""; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID + ""; }
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                strSQL += " and SUBSTRING( Convert(varchar(100),c.OP_DATE,112),1,6)>='" + sD + "' and SUBSTRING( Convert(varchar(100),c.OP_DATE,112),1,6)<='" + eD + "') as f ) P PIVOT (SUM(OutMonthNum) FOR P.InDate IN (" + col + ")) AS T ) as N on M.Specs=N.Specs and M.Figure=N.Figure and M.GoodsCode=N.GoodsCode) as G ";
                strSQL += " right join (select a.Specs,a.Figure,a.GoodsCode,SUM(ISNULL(c.Piece,0)) as Piece From Tbl_Cargo_Product as a inner join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID left join Tbl_Cargo_ContainerGoods as c on a.ProductID=c.ProductID where (1=1) ";
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID + ""; }
                if (!entity.ParentID.Equals(0)) { strSQL += " and b.ParentID=" + entity.ParentID + ""; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID + ""; }
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                strSQL += " group by a.Specs,a.GoodsCode,a.Figure ) as R on G.Specs=R.Specs and G.Figure=R.Figure and G.GoodsCode=R.GoodsCode";
                strSQL += " order by G.Specs asc,G.Figure asc";
            }
            else
            {
                #region 组装SQL

                strSQL = "select G.*,R.Piece as CurrentNum,R.Specs as ASpecs,R.Figure as AFigure,'' as AGoodsCode from (select ISNULL(M.Specs,N.Specs) as Specs,ISNULL(M.Figure,N.Figure) as Figure, ";
                string outStr = " T.Specs,T.Figure,";
                string inStr = " T.Specs,T.Figure,";
                for (int i = 1; i <= Month + 1; i++)
                {
                    strSQL += " ISNULL(M.In" + i.ToString() + ",0) as In" + i.ToString() + ",";
                    strSQL += " ISNULL(N.Out" + i.ToString() + ",0) as Out" + i.ToString() + ",";
                    if (sDT.Month == eDT.Month)
                    {
                        col += "[" + eDT.ToString("yyyyMM") + "]";
                        inStr += " T.[" + sDT.ToString("yyyyMM") + "] as In" + i.ToString();
                        outStr += " T.[" + sDT.ToString("yyyyMM") + "] as Out" + i.ToString();
                    }
                    else
                    {
                        inStr += " T.[" + sDT.ToString("yyyyMM") + "] as In" + i.ToString() + ",";
                        outStr += " T.[" + sDT.ToString("yyyyMM") + "] as Out" + i.ToString() + ",";
                        col += "[" + sDT.ToString("yyyyMM") + "],";
                        sDT = sDT.AddMonths(1);
                    }
                }
                strSQL = strSQL.Substring(0, strSQL.Length - 1);
                strSQL += " from (select " + inStr + " from (select distinct f.Specs,f.Figure,f.InDate,SUM(f.InHouseNum) over (partition by f.Specs,f.Figure,f.InDate) as InMonthNum from (select a.Specs,a.Figure,c.Piece as InHouseNum,SUBSTRING( Convert(varchar(100),c.InHouseTime,112),1,6) as InDate from Tbl_Cargo_Product as a inner join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID inner join Tbl_Cargo_InContainerGoods as c on a.ProductID=c.ProductID where c.InHouseType=0 ";
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID + ""; }
                if (!entity.ParentID.Equals(0)) { strSQL += " and b.ParentID=" + entity.ParentID + ""; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID + ""; }
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                strSQL += " and SUBSTRING( Convert(varchar(100),c.InHouseTime,112),1,6)>='" + sD + "' and SUBSTRING( Convert(varchar(100),c.InHouseTime,112),1,6)<='" + eD + "') as f ) as P PIVOT (SUM(InMonthNum) FOR P.InDate IN (" + col + ")) AS T ) as M full join (select " + outStr + " from (select distinct f.Specs,f.Figure,f.InDate,SUM(f.InHouseNum) over (partition by f.Specs,f.Figure,f.InDate) as OutMonthNum from (select a.Specs,a.Figure,c.Piece as InHouseNum,SUBSTRING( Convert(varchar(100),c.OP_DATE,112),1,6) as InDate from Tbl_Cargo_Product as a inner join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID inner join Tbl_Cargo_OrderGoods as c on a.ProductID=c.ProductID and a.HouseID=c.HouseID where (1=1) ";
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID + ""; }
                if (!entity.ParentID.Equals(0)) { strSQL += " and b.ParentID=" + entity.ParentID + ""; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID + ""; }
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                strSQL += " and SUBSTRING( Convert(varchar(100),c.OP_DATE,112),1,6)>='" + sD + "' and SUBSTRING( Convert(varchar(100),c.OP_DATE,112),1,6)<='" + eD + "') as f ) P PIVOT (SUM(OutMonthNum) FOR P.InDate IN (" + col + ")) AS T ) as N on M.Specs=N.Specs and M.Figure=N.Figure) as G ";

                strSQL += " right join (select a.Specs,a.Figure,SUM(ISNULL(c.Piece,0)) as Piece From Tbl_Cargo_Product as a left join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID left join Tbl_Cargo_ContainerGoods as c on a.ProductID=c.ProductID where (1=1) ";
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID + ""; }
                if (!entity.ParentID.Equals(0)) { strSQL += " and b.ParentID=" + entity.ParentID + ""; }
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID + ""; }
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure like '%" + entity.Figure + "%'"; }
                strSQL += " group by a.Specs,a.Figure ) as R on G.Specs=R.Specs and G.Figure=R.Figure";
                strSQL += " order by G.Specs asc,G.Figure asc";
                #endregion
            }

            try
            {
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow idrCount in dt.Rows)
                        {
                            if (string.IsNullOrEmpty(Convert.ToString(idrCount["Specs"])) && string.IsNullOrEmpty(Convert.ToString(idrCount["Figure"])) && Convert.ToInt32(idrCount["CurrentNum"]) <= 0)
                            {
                                continue;
                            }
                            CargoSaleStockStatisEntity stock = new CargoSaleStockStatisEntity();
                            stock.StartDate = entity.StartDate;
                            stock.EndDate = entity.EndDate;
                            stock.Specs = Convert.ToString(idrCount["ASpecs"]);
                            stock.Figure = Convert.ToString(idrCount["AFigure"]);
                            stock.GoodsCode = Convert.ToString(idrCount["AGoodsCode"]);
                            stock.CurrentNum = Convert.ToInt32(idrCount["CurrentNum"]);
                            for (int i = 1; i <= Month + 1; i++)
                            {
                                switch (i)
                                {
                                    case 1:
                                        stock.In1 = string.IsNullOrEmpty(Convert.ToString(idrCount["In1"])) ? 0 : Convert.ToInt32(idrCount["In1"]);
                                        stock.Out1 = string.IsNullOrEmpty(Convert.ToString(idrCount["Out1"])) ? 0 : Convert.ToInt32(idrCount["Out1"]);
                                        break;
                                    case 2:
                                        stock.In2 = string.IsNullOrEmpty(Convert.ToString(idrCount["In2"])) ? 0 : Convert.ToInt32(idrCount["In2"]);
                                        stock.Out2 = string.IsNullOrEmpty(Convert.ToString(idrCount["Out2"])) ? 0 : Convert.ToInt32(idrCount["Out2"]);
                                        break;
                                    case 3:
                                        stock.In3 = string.IsNullOrEmpty(Convert.ToString(idrCount["In3"])) ? 0 : Convert.ToInt32(idrCount["In3"]);
                                        stock.Out3 = string.IsNullOrEmpty(Convert.ToString(idrCount["Out3"])) ? 0 : Convert.ToInt32(idrCount["Out3"]);
                                        break;
                                    case 4:
                                        stock.In4 = string.IsNullOrEmpty(Convert.ToString(idrCount["In4"])) ? 0 : Convert.ToInt32(idrCount["In4"]);
                                        stock.Out4 = string.IsNullOrEmpty(Convert.ToString(idrCount["Out4"])) ? 0 : Convert.ToInt32(idrCount["Out4"]);
                                        break;
                                    case 5:
                                        stock.In5 = string.IsNullOrEmpty(Convert.ToString(idrCount["In5"])) ? 0 : Convert.ToInt32(idrCount["In5"]);
                                        stock.Out5 = string.IsNullOrEmpty(Convert.ToString(idrCount["Out5"])) ? 0 : Convert.ToInt32(idrCount["Out5"]);
                                        break;
                                    case 6:
                                        stock.In6 = string.IsNullOrEmpty(Convert.ToString(idrCount["In6"])) ? 0 : Convert.ToInt32(idrCount["In6"]);
                                        stock.Out6 = string.IsNullOrEmpty(Convert.ToString(idrCount["Out6"])) ? 0 : Convert.ToInt32(idrCount["Out6"]);
                                        break;
                                    case 7:
                                        stock.In7 = string.IsNullOrEmpty(Convert.ToString(idrCount["In7"])) ? 0 : Convert.ToInt32(idrCount["In7"]);
                                        stock.Out7 = string.IsNullOrEmpty(Convert.ToString(idrCount["Out7"])) ? 0 : Convert.ToInt32(idrCount["Out7"]);
                                        break;
                                    case 8:
                                        stock.In8 = string.IsNullOrEmpty(Convert.ToString(idrCount["In8"])) ? 0 : Convert.ToInt32(idrCount["In8"]);
                                        stock.Out8 = string.IsNullOrEmpty(Convert.ToString(idrCount["Out8"])) ? 0 : Convert.ToInt32(idrCount["Out8"]);
                                        break;
                                    default:
                                        break;
                                }
                            }
                            stock.InTotalNum = stock.In1 + stock.In2 + stock.In3 + stock.In4 + stock.In5 + stock.In6 + stock.In7 + stock.In8;
                            stock.OutTotalNum = stock.Out1 + stock.Out2 + stock.Out3 + stock.Out4 + stock.Out5 + stock.Out6 + stock.Out7 + stock.Out8;
                            // Math.Round((Convert.ToDouble(t) / Convert.ToDouble((it.Delay + t + n))) * 100, 2) + "%"
                            if (stock.InTotalNum.Equals(0)) { stock.OutInRate = "100%"; }
                            if (stock.OutTotalNum.Equals(0)) { stock.OutInRate = "0%"; }
                            if (!stock.OutTotalNum.Equals(0) && !stock.InTotalNum.Equals(0))
                            {
                                stock.OutInRate = Math.Round((Convert.ToDouble(stock.OutTotalNum) / Convert.ToDouble(stock.InTotalNum)) * 100, 2) + "%";
                            }

                            result.Add(stock);
                        }
                    }

                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            //var ss = from items in result orderby items.Specs, items.Figure select items;
            return result;
            //return ss.ToList();
        }

        #endregion
        #region 仓库库存快照操作方法集合
        /// <summary>
        /// 保存仓库库存快照
        /// </summary>
        /// <param name="CargoPermisID"></param>
        public void SaveStockSnapData(string CargoPermisID)
        {
            string strSQL = @"insert into tbl_Cargo_stockSnap(StockID,ContainerID,TypeID,ProductID,Piece,InHouseTime,IsPrintInCargo,StockOPDATE,InCargoID,HouseID) select a.ID as StockID,a.ContainerID,a.TypeID,a.ProductID,a.Piece,a.InHouseTime,a.IsPrintInCargo,a.OP_DATE as StockOPDATE,a.InCargoID,b.HouseID from Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID ";
            //where b.HouseID in (" + CargoPermisID + ")
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 查询快照库存 数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryStockSnapData(int pIndex, int pNum, CargoContainerShowEntity entity)
        {
            Hashtable resHT = new Hashtable();
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            CargoHouseManager house = new CargoHouseManager();
            CargoProductManager pro = new CargoProductManager();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY b.InHouseTime DESC) AS RowNumber, b.StockID,b.InHouseTime as InTime,b.OP_DATE as OPDATE,c.ContainerID,c.ContainerCode,c.ContainerType,b.Piece,d.AreaID,d.Name as AreaName,d.ParentID,e.Name as HouseName,e.HouseCode,f.TypeName,f.ParentID as TypeParentID,f.TypeParentName as TypeParentName, a.*,h.Name as FirstAreaName,h.AreaID as FirstAreaID,g.Name as ParentAreaName,g.AreaID as ParentAreaID from Tbl_Cargo_Product as a inner join tbl_Cargo_stockSnap as b on a.ProductID=b.ProductID left join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID left join Tbl_Cargo_House as e on d.HouseID=e.HouseID left join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID ";
                strSQL += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID left join Tbl_Cargo_Area as h on g.ParentID=h.AreaID ";
                strSQL += " where (1=1)";
                if (!entity.FirstAreaID.Equals(0)) { strSQL += " and h.AreaID = " + entity.FirstAreaID + ""; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strSQL += " and f.ParentID=" + entity.TypeParentID; }
                if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }

                if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch = '" + entity.Batch + "'"; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure = '" + entity.Figure + "'"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //入库日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and b.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and b.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //入库日期范围
                if ((entity.SnapStartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.SnapStartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and b.OP_DATE>='" + entity.SnapStartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.SnapEndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.SnapEndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and b.OP_DATE<'" + entity.SnapEndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            //CargoAreaEntity cargoArea = new CargoAreaEntity();
                            //CargoAreaEntity hArea = new CargoAreaEntity();
                            ////如果父ID不为0，则查询父ID的区域名称
                            //if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                            //{
                            //    cargoArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                            //    if (!cargoArea.ParentID.Equals(0))
                            //    {
                            //        hArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                            //    }
                            //}
                            // List<CargoProductTypeEntity> proTypeList = pro.QueryProductType(new CargoProductTypeEntity { TypeID = Convert.ToInt32(idr["TypeParentID"]) });
                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["StockID"]),
                                ContainerID = Convert.ToInt32(idr["ContainerID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                Piece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InPiece = Convert.ToInt32(idr["Piece"]),//货位上件数
                                InHouseTime = Convert.ToDateTime(idr["InTime"]),//入库时间
                                AreaID = Convert.ToInt32(idr["AreaID"]),
                                AreaName = Convert.ToString(idr["AreaName"]),
                                FirstAreaName = Convert.ToString(idr["FirstAreaName"]),
                                ParentAreaName = Convert.ToString(idr["ParentAreaName"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseCode = Convert.ToString(idr["HouseCode"]),
                                ProductID = Convert.ToInt64(idr["ProductID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                TypeParentID = Convert.ToInt32(idr["TypeParentID"]),
                                //TypeParentName = proTypeList.Count > 0 ? proTypeList[0].TypeName : "",
                                TypeParentName = Convert.ToString(idr["TypeParentName"]),
                                Model = Convert.ToString(idr["Model"]).Trim(),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]).Trim(),
                                Figure = Convert.ToString(idr["Figure"]).Trim(),
                                Specs = Convert.ToString(idr["Specs"]).Trim(),
                                TreadWidth = Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = Convert.ToInt32(idr["FlatRatio"]),
                                Meridian = Convert.ToString(idr["Meridian"]).Trim(),
                                HubDiameter = Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = Convert.ToInt32(idr["SpeedMax"]),
                                Size = Convert.ToString(idr["Size"]),
                                Weight = Convert.ToDecimal(idr["Weight"]),
                                UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                                Numbers = Convert.ToInt32(idr["Numbers"]),
                                CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                Package = Convert.ToString(idr["Package"]).Trim(),
                                PackageNum = Convert.ToInt32(idr["PackageNum"]),
                                PackageWeight = Convert.ToDecimal(idr["PackageWeight"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]).Trim(),
                                Batch = Convert.ToString(idr["Batch"]),
                                Supplier = Convert.ToString(idr["Supplier"]),
                                SourceOrderNo = Convert.ToString(idr["SourceOrderNo"]),
                                BelongDepart = Convert.ToString(idr["BelongDepart"]),
                                OP_DATE = Convert.ToDateTime(idr["OPDATE"])//快照时间
                            });
                        }
                    }
                }

                resHT["rows"] = result;

                string strCount = @"Select Count(a.ProductID) as TotalCount from Tbl_Cargo_Product as a inner join tbl_Cargo_stockSnap as b on a.ProductID=b.ProductID left join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID left join Tbl_Cargo_House as e on d.HouseID=e.HouseID left join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID ";
                strCount += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID left join Tbl_Cargo_Area as h on g.ParentID=h.AreaID ";
                strCount += " Where (1=1)";
                if (!entity.FirstAreaID.Equals(0)) { strCount += " and h.AreaID = " + entity.FirstAreaID + ""; }
                //以产品名称为查询条件
                if (!string.IsNullOrEmpty(entity.Specs)) { strCount += " and a.Specs like '%" + entity.Specs + "%'"; }
                //型号
                if (!string.IsNullOrEmpty(entity.Model)) { strCount += " and a.Model like '%" + entity.Model + "%'"; }
                //货品代码
                if (!string.IsNullOrEmpty(entity.GoodsCode)) { strCount += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
                //以一级类型ID为查询条件
                if (!entity.TypeParentID.Equals(0)) { strCount += " and f.ParentID=" + entity.TypeParentID; }
                if (!entity.HouseID.Equals(0)) { strCount += " and a.HouseID=" + entity.HouseID; }
                //二级类型ID
                if (!entity.TypeID.Equals(0)) { strCount += " and a.TypeID=" + entity.TypeID; }

                if (!string.IsNullOrEmpty(entity.Batch)) { strCount += " and a.Batch = '" + entity.Batch + "'"; }
                //花纹
                if (!string.IsNullOrEmpty(entity.Figure)) { strCount += " and a.Figure = '" + entity.Figure + "'"; }
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                //入库日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and b.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and b.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                //入库日期范围
                if ((entity.SnapStartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.SnapStartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and b.OP_DATE>='" + entity.SnapStartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.SnapEndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.SnapEndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and b.OP_DATE<'" + entity.SnapEndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        /// <summary>
        /// 导出快照数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoContainerShowEntity> QueryStockSnapDataForExport(CargoContainerShowEntity entity)
        {
            List<CargoContainerShowEntity> result = new List<CargoContainerShowEntity>();
            CargoHouseManager house = new CargoHouseManager();
            //CargoProductManager pro = new CargoProductManager();

            string strSQL = @"SELECT b.StockID,b.InHouseTime as InTime,b.OP_DATE as OPDATE,c.ContainerID,c.ContainerCode,c.ContainerType,b.Piece,d.AreaID,d.Name as AreaName,d.ParentID,e.Name as HouseName,e.HouseCode,f.TypeName,f.ParentID as TypeParentID, a.*,h.Name as FirstAreaName,h.AreaID as FirstAreaID,g.Name as ParentAreaName,g.AreaID as ParentAreaID from Tbl_Cargo_Product as a inner join tbl_Cargo_stockSnap as b on a.ProductID=b.ProductID left join Tbl_Cargo_Container as c on b.ContainerID=c.ContainerID left join Tbl_Cargo_Area as d on c.AreaID=d.AreaID left join Tbl_Cargo_House as e on d.HouseID=e.HouseID left join Tbl_Cargo_ProductType as f on a.TypeID=f.TypeID ";
            strSQL += " left join Tbl_Cargo_Area as g on d.ParentID=g.AreaID left join Tbl_Cargo_Area as h on g.ParentID=h.AreaID ";
            strSQL += " where b.Piece>0 ";
            if (!entity.FirstAreaID.Equals(0)) { strSQL += " and h.AreaID = " + entity.FirstAreaID + ""; }
            //以产品名称为查询条件
            if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and a.Specs like '%" + entity.Specs + "%'"; }
            //型号
            if (!string.IsNullOrEmpty(entity.Model)) { strSQL += " and a.Model like '%" + entity.Model + "%'"; }
            //货品代码
            if (!string.IsNullOrEmpty(entity.GoodsCode)) { strSQL += " and a.GoodsCode like '%" + entity.GoodsCode + "%'"; }
            //以一级类型ID为查询条件
            if (!entity.TypeParentID.Equals(0)) { strSQL += " and f.ParentID=" + entity.TypeParentID; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID=" + entity.HouseID; }
            //二级类型ID
            if (!entity.TypeID.Equals(0)) { strSQL += " and a.TypeID=" + entity.TypeID; }

            if (!string.IsNullOrEmpty(entity.Batch)) { strSQL += " and a.Batch = '" + entity.Batch + "'"; }
            //花纹
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and a.Figure = '" + entity.Figure + "'"; }
            //所属仓库ID
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            //入库日期范围
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.InHouseTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.InHouseTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            //入库日期范围
            if ((entity.SnapStartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.SnapStartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.OP_DATE>='" + entity.SnapStartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.SnapEndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.SnapEndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.OP_DATE<'" + entity.SnapEndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " ORDER BY  b.InHouseTime desc";
            using (DbCommand cmdAdd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmdAdd))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        //CargoAreaEntity cargoArea = new CargoAreaEntity();
                        //CargoAreaEntity hArea = new CargoAreaEntity();
                        ////如果父ID不为0，则查询父ID的区域名称
                        //if (!Convert.ToInt32(idr["ParentID"]).Equals(0))
                        //{
                        //    cargoArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = Convert.ToInt32(idr["ParentID"]) });
                        //    if (!cargoArea.ParentID.Equals(0))
                        //    {
                        //        hArea = house.QueryAreaByAreaID(new CargoAreaEntity { AreaID = cargoArea.ParentID });
                        //    }
                        //}
                        //List<CargoProductTypeEntity> proTypeList = pro.QueryProductType(new CargoProductTypeEntity { TypeID = Convert.ToInt32(idr["TypeParentID"]) });
                        try
                        {

                            result.Add(new CargoContainerShowEntity
                            {
                                ID = Convert.ToInt64(idr["StockID"]),
                                ContainerID = string.IsNullOrEmpty(idr["ContainerID"].ToString()) ? 0 : Convert.ToInt32(idr["ContainerID"]),
                                ContainerCode = Convert.ToString(idr["ContainerCode"]),
                                ContainerType = Convert.ToString(idr["ContainerType"]),
                                Piece = string.IsNullOrEmpty(idr["Piece"].ToString()) ? 0 : Convert.ToInt32(idr["Piece"]),//货位上件数
                                InPiece = string.IsNullOrEmpty(idr["Piece"].ToString()) ? 0 : Convert.ToInt32(idr["Piece"]),//货位上件数
                                InHouseTime = Convert.ToDateTime(idr["InTime"]),//入库时间
                                AreaID = string.IsNullOrEmpty(idr["AreaID"].ToString()) ? 0 : Convert.ToInt32(idr["AreaID"]),
                                AreaName = Convert.ToString(idr["AreaName"]).Trim(),
                                FirstAreaName = Convert.ToString(idr["FirstAreaName"]),
                                ParentAreaName = Convert.ToString(idr["ParentAreaName"]),
                                HouseID = string.IsNullOrEmpty(idr["HouseID"].ToString()) ? 0 : Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                HouseCode = Convert.ToString(idr["HouseCode"]),
                                ProductID = string.IsNullOrEmpty(idr["ProductID"].ToString()) ? 0 : Convert.ToInt64(idr["ProductID"]),
                                ProductName = Convert.ToString(idr["ProductName"]),
                                TypeID = string.IsNullOrEmpty(idr["TypeID"].ToString()) ? 0 : Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                TypeParentID = string.IsNullOrEmpty(idr["TypeParentID"].ToString()) ? 0 : Convert.ToInt32(idr["TypeParentID"]),
                                //TypeParentName = proTypeList.Count > 0 ? proTypeList[0].TypeName : "",
                                Model = Convert.ToString(idr["Model"]).Trim(),
                                GoodsCode = Convert.ToString(idr["GoodsCode"]).Trim(),
                                Figure = Convert.ToString(idr["Figure"]).Trim(),
                                Specs = Convert.ToString(idr["Specs"]).Trim(),
                                TreadWidth = string.IsNullOrEmpty(idr["TreadWidth"].ToString()) ? 0 : Convert.ToInt32(idr["TreadWidth"]),
                                FlatRatio = string.IsNullOrEmpty(idr["FlatRatio"].ToString()) ? 0 : Convert.ToInt32(idr["FlatRatio"]),
                                Meridian = Convert.ToString(idr["Meridian"]).Trim(),
                                HubDiameter = string.IsNullOrEmpty(idr["HubDiameter"].ToString()) ? 0 : Convert.ToInt32(idr["HubDiameter"]),
                                LoadIndex = Convert.ToString(idr["LoadIndex"]),
                                SpeedLevel = Convert.ToString(idr["SpeedLevel"]),
                                SpeedMax = string.IsNullOrEmpty(idr["SpeedMax"].ToString()) ? 0 : Convert.ToInt32(idr["SpeedMax"]),
                                Size = Convert.ToString(idr["Size"]),
                                Weight = Convert.ToDecimal(idr["Weight"]),
                                UnitPrice = Convert.ToDecimal(idr["UnitPrice"]),
                                Numbers = string.IsNullOrEmpty(idr["Numbers"].ToString()) ? 0 : Convert.ToInt32(idr["Numbers"]),
                                CostPrice = Convert.ToDecimal(idr["CostPrice"]),
                                TradePrice = Convert.ToDecimal(idr["TradePrice"]),
                                SalePrice = Convert.ToDecimal(idr["SalePrice"]),
                                Package = Convert.ToString(idr["Package"]).Trim(),
                                PackageNum = string.IsNullOrEmpty(idr["PackageNum"].ToString()) ? 0 : Convert.ToInt32(idr["PackageNum"]),
                                PackageWeight = Convert.ToDecimal(idr["PackageWeight"]),
                                InCargoStatus = Convert.ToString(idr["InCargoStatus"]).Trim(),
                                Batch = Convert.ToString(idr["Batch"]),
                                Supplier = Convert.ToString(idr["Supplier"]),
                                SourceOrderNo = Convert.ToString(idr["SourceOrderNo"]),
                                OP_DATE = Convert.ToDateTime(idr["OPDATE"])//快照时间
                            });
                        }
                        catch (Exception)
                        {

                        }
                    }
                }
            }

            return result;

        }

        #endregion
        #region 微信商城数据统计集合
        /// <summary>
        /// 各仓库轮胎微信商城销售数据统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoWeixinMallReportEntity> QueryWeixinMalReportData(CargoWeixinMallReportEntity entity)
        {
            List<CargoWeixinMallReportEntity> result = new List<CargoWeixinMallReportEntity>();
            string strSQL = "select CONVERT(varchar(100), a.CreateDate, 23) as ReportDate,COUNT(case b.Name when '湖南仓库' then a.CreateDate end) as HNOrderNum,COUNT(distinct case b.Name when '湖南仓库' then  a.WXID end) as HNOrderClientNum,SUM(case b.Name when '湖南仓库' then a.Piece else 0 end) as HNSaleTyreNum,SUM(case b.Name when '湖南仓库' then a.TotalCharge else 0 end) as HNSaleTotalCharge,COUNT(case b.Name when '湖北仓库' then a.CreateDate end) as HBOrderNum,COUNT(distinct case b.Name when '湖北仓库' then  a.WXID end) as HBOrderClientNum,SUM(case b.Name when '湖北仓库' then a.Piece else 0 end) as HBSaleTyreNum,SUM(case b.Name when '湖北仓库' then a.TotalCharge else 0 end) as HBSaleTotalCharge,COUNT(case b.Name when '海南仓库' then a.CreateDate end) as HAOrderNum,COUNT(distinct case b.Name when '海南仓库' then  a.WXID end) as HAOrderClientNum,SUM(case b.Name when '海南仓库' then a.Piece else 0 end) as HASaleTyreNum,SUM(case b.Name when '海南仓库' then a.TotalCharge else 0 end) as HASaleTotalCharge,COUNT(case b.Name when '西安迪乐泰' then a.CreateDate end) as XBOrderNum,COUNT(distinct case b.Name when '西安迪乐泰' then  a.WXID end) as XBOrderClientNum,SUM(case b.Name when '西安迪乐泰' then a.Piece else 0 end) as XBSaleTyreNum,SUM(case b.Name when '西安迪乐泰' then a.TotalCharge else 0 end) as XBSaleTotalCharge,COUNT(case b.Name when '梅州仓库' then a.CreateDate end) as MZOrderNum,COUNT(distinct case b.Name when '梅州仓库' then  a.WXID end) as MZOrderClientNum,SUM(case b.Name when '梅州仓库' then a.Piece else 0 end) as MZSaleTyreNum,SUM(case b.Name when '梅州仓库' then a.TotalCharge else 0 end) as MZSaleTotalCharge,COUNT(case b.Name when '广州仓库' then a.CreateDate end) as GZOrderNum,COUNT(distinct case b.Name when '广州仓库' then  a.WXID end) as GZOrderClientNum,SUM(case b.Name when '广州仓库' then a.Piece else 0 end) as GZSaleTyreNum,SUM(case b.Name when '广州仓库' then a.TotalCharge else 0 end) as GZSaleTotalCharge,COUNT(case b.Name when '揭阳仓库' then a.CreateDate end) as JYOrderNum,COUNT(distinct case b.Name when '揭阳仓库' then  a.WXID end) as JYOrderClientNum,SUM(case b.Name when '揭阳仓库' then a.Piece else 0 end) as JYSaleTyreNum,SUM(case b.Name when '揭阳仓库' then a.TotalCharge else 0 end) as JYSaleTotalCharge,COUNT(a.CreateDate) as DayOrderNum,SUM(a.Piece) as DaySaleTyreNum,SUM(a.TotalCharge) as DaySaleTotalCharge,COUNT(distinct a.WXID) as DayOrderClientNum From Tbl_WX_Order as a left join Tbl_Cargo_House as b on a.HouseID=b.HouseID where (1=1) ";
            //入库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " group by CONVERT(varchar(100), a.CreateDate, 23)";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoWeixinMallReportEntity
                        {
                            ReportDate = Convert.ToString(idrCount["ReportDate"]),
                            HNOrderNum = Convert.ToInt32(idrCount["HNOrderNum"]),
                            HNSaleTyreNum = Convert.ToInt32(idrCount["HNSaleTyreNum"]),
                            HNSaleTotalCharge = Convert.ToDecimal(idrCount["HNSaleTotalCharge"]),
                            HNOrderClientNum = Convert.ToInt32(idrCount["HNOrderClientNum"]),
                            HBOrderNum = Convert.ToInt32(idrCount["HBOrderNum"]),
                            HBSaleTyreNum = Convert.ToInt32(idrCount["HBSaleTyreNum"]),
                            HBSaleTotalCharge = Convert.ToDecimal(idrCount["HBSaleTotalCharge"]),
                            HBOrderClientNum = Convert.ToInt32(idrCount["HBOrderClientNum"]),
                            XBOrderNum = Convert.ToInt32(idrCount["XBOrderNum"]),
                            XBSaleTyreNum = Convert.ToInt32(idrCount["XBSaleTyreNum"]),
                            XBSaleTotalCharge = Convert.ToDecimal(idrCount["XBSaleTotalCharge"]),
                            XBOrderClientNum = Convert.ToInt32(idrCount["XBOrderClientNum"]),
                            MZOrderNum = Convert.ToInt32(idrCount["MZOrderNum"]),
                            MZSaleTyreNum = Convert.ToInt32(idrCount["MZSaleTyreNum"]),
                            MZSaleTotalCharge = Convert.ToDecimal(idrCount["MZSaleTotalCharge"]),
                            MZOrderClientNum = Convert.ToInt32(idrCount["MZOrderClientNum"]),
                            HAOrderNum = Convert.ToInt32(idrCount["HAOrderNum"]),
                            HAOrderClientNum = Convert.ToInt32(idrCount["HAOrderClientNum"]),
                            HASaleTotalCharge = Convert.ToDecimal(idrCount["HASaleTotalCharge"]),
                            HASaleTyreNum = Convert.ToInt32(idrCount["HASaleTyreNum"]),
                            GZOrderNum = Convert.ToInt32(idrCount["GZOrderNum"]),
                            GZSaleTyreNum = Convert.ToInt32(idrCount["GZSaleTyreNum"]),
                            GZSaleTotalCharge = Convert.ToDecimal(idrCount["GZSaleTotalCharge"]),
                            GZOrderClientNum = Convert.ToInt32(idrCount["GZOrderClientNum"]),
                            JYOrderClientNum = Convert.ToInt32(idrCount["JYOrderClientNum"]),
                            JYOrderNum = Convert.ToInt32(idrCount["JYOrderNum"]),
                            JYSaleTotalCharge = Convert.ToDecimal(idrCount["JYSaleTotalCharge"]),
                            JYSaleTyreNum = Convert.ToInt32(idrCount["JYSaleTyreNum"]),
                            DayOrderNum = Convert.ToInt32(idrCount["DayOrderNum"]),
                            DaySaleTyreNum = Convert.ToInt32(idrCount["DaySaleTyreNum"]),
                            DayOrderClientNum = Convert.ToInt32(idrCount["DayOrderClientNum"]),
                            DaySaleTotalCharge = Convert.ToDecimal(idrCount["DaySaleTotalCharge"])
                        });
                    }
                }
            }

            return result;
        }
        /// <summary>
        /// 处理微信 商城 昨天 的数据统计
        /// </summary>
        /// <param name="entity"></param>
        public void HandleWxMallStatis(CargoWeixinMallReportEntity entity)
        {
            string strSQL = "insert into Tbl_Cargo_WxMallStatis(StatisDate,ClientNum,OrderNum,SaleNum,SaleIncome,HouseID) select CONVERT(varchar(100), a.CreateDate, 23) as StatisDate,COUNT(distinct a.WXID) as ClientNum,COUNT(a.CreateDate) as OrderNum,SUM(a.Piece) as SaleNum,SUM(a.TotalCharge) as SaleIncome,a.HouseID From Tbl_WX_Order as a left join Tbl_Cargo_House as b on a.HouseID=b.HouseID where (1=1) ";
            //入库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " group by CONVERT(varchar(100), a.CreateDate, 23),a.HouseID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.ExecuteNonQuery(cmd);
            }
        }
        /// <summary>
        /// 查询微信商城数据统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoWeixinMallReportEntity> QueryWeixinMallStatisData(CargoWeixinMallReportEntity entity)
        {
            List<CargoWeixinMallReportEntity> result = new List<CargoWeixinMallReportEntity>();
            string strSQL = "";
            if (entity.StatisType.Equals("1"))
            {
                //月统计
                strSQL += "select HouseID,CONVERT(varchar(7),StatisDate, 120) as ReportDate,SUM(ClientNum) as ClientNum,SUM(OrderNum) as OrderNum,SUM(SaleNum) as SaleNum,SUM(SaleIncome) as SaleIncome  From Tbl_Cargo_WxMallStatis Where (1=1)";
                if (!entity.HouseID.Equals(0)) { strSQL += " and HouseID=" + entity.HouseID + ""; }
                strSQL += " group by CONVERT(varchar(7),StatisDate, 120),HouseID";
            }
            else if (entity.StatisType.Equals("2"))
            {
                //周统计
                strSQL += " set datefirst 1;select HouseID,DATEPART(week,StatisDate) as ReportDate,SUM(ClientNum) as ClientNum,SUM(OrderNum) as OrderNum,SUM(SaleNum) as SaleNum,SUM(SaleIncome) as SaleIncome From Tbl_Cargo_WxMallStatis Where (1=1)";
                if (!entity.HouseID.Equals(0)) { strSQL += " and HouseID=" + entity.HouseID + ""; }
                strSQL += " group by DATEPART(WEEK,StatisDate),HouseID";
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoWeixinMallReportEntity
                        {
                            HouseID = Convert.ToInt32(idrCount["HouseID"]),
                            ReportDate = Convert.ToString(idrCount["ReportDate"]),
                            DayOrderClientNum = Convert.ToInt32(idrCount["ClientNum"]),
                            DayOrderNum = Convert.ToInt32(idrCount["OrderNum"]),
                            DaySaleTyreNum = Convert.ToInt32(idrCount["SaleNum"]),
                            DaySaleTotalCharge = Convert.ToDecimal(idrCount["SaleIncome"])
                        });
                    }
                }
            }

            return result;
        }
        #endregion
        #region 仓储系统总统计
        /// <summary>
        /// 按订单统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryOrderStatis(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select b.Name as HouseName,a.OrderType,ISNULL(COUNT(*),0) as OrderNum,SUM(a.Piece) as OrderPiece,SUM(a.TotalCharge) as OrderCharge,SUBSTRING( Convert(varchar(100),a.CreateDate,112),1,6) as ReportDate From Tbl_Cargo_Order as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID where (1=1) ";
            if (string.IsNullOrEmpty(entity.ThrowGood)) { strSQL += " and a.ThrowGood!='2' "; }
            if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and a.OrderModel = '" + entity.OrderModel + "'"; }
            //所属仓库ID
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            //入库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += "group by b.Name,a.OrderType ,SUBSTRING( Convert(varchar(100),a.CreateDate,112),1,6) order by SUBSTRING( Convert(varchar(100),a.CreateDate,112),1,6),a.OrderType";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            HouseName = Convert.ToString(idrCount["HouseName"]),
                            OrderType = Convert.ToString(idrCount["OrderType"]),
                            ReportDate = Convert.ToString(idrCount["ReportDate"]),
                            OrderNum = Convert.ToInt32(idrCount["OrderNum"]),
                            OrderPiece = Convert.ToInt32(idrCount["OrderPiece"]),
                            OrderCharge = Convert.ToDecimal(idrCount["OrderCharge"])
                        });
                    }
                }
            }

            return result;
        }
        public List<CargoDLTDataStatisEntity> StatisticalChart(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            DateTime date = DateTime.Now;
            // 指定年份和月份
            int year = date.Year;
            int month = date.Month;

            // 获取本月的第一天和最后一天
            DateTime firstDayOfMonth = new DateTime(year, month, 1);
            DateTime lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

            string strSQL = "SELECT Convert(varchar(10),a.CreateDate,120) as ReportDate,sum(Piece) as OrderPiece From Tbl_Cargo_Order as a inner join Tbl_Cargo_House as b on a.HouseID=b.HouseID where (1=1)  and a.ThrowGood!='2'  and a.OrderModel = '0' ";
            //所属仓库ID
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            //入库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            else
            {
                strSQL += " and a.CreateDate>='" + firstDayOfMonth.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            else
            {
                strSQL += " and a.CreateDate<'" + lastDayOfMonth.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }

            strSQL += " group by Convert(varchar(10),a.CreateDate,120) order by Convert(varchar(10),a.CreateDate,120)";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            ReportDate = Convert.ToDateTime(idrCount["ReportDate"]).ToString("MM-dd"),
                            OrderPiece = Convert.ToInt32(idrCount["OrderPiece"]),
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 按品牌销售统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryBrandStatis(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select e.Name as HouseName,d.TypeName,SUBSTRING( Convert(varchar(100),a.CreateDate,112),1,6) as ReportDate,c.Specs,c.Figure,SUM(b.Piece) as OrderPiece,SUM(b.Piece*b.ActSalePrice) as OrderCharge From Tbl_Cargo_Order as a inner join Tbl_Cargo_OrderGoods as b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID inner join Tbl_Cargo_Product as c on b.ProductID=c.ProductID and b.HouseID=c.HouseID left join Tbl_Cargo_ProductType as d on c.TypeID=d.TypeID left join Tbl_Cargo_House as e on a.HouseID=e.HouseID where (1=1) ";
            if (string.IsNullOrEmpty(entity.ThrowGood)) { strSQL += " and a.ThrowGood!='2' "; }
            if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and a.OrderModel = '" + entity.OrderModel + "'"; }
            //所属仓库ID
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            //入库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.Figure)) { strSQL += " and c.Figure = '" + entity.Figure + "'"; }
            //规格
            if (!string.IsNullOrEmpty(entity.Specs)) { strSQL += " and c.Specs like '%" + entity.Specs + "%'"; }
            //以一级类型ID为查询条件
            if (!entity.ParentID.Equals(0)) { strSQL += " and d.ParentID=" + entity.ParentID; }
            //二级类型ID
            if (!entity.TypeID.Equals(0)) { strSQL += " and c.TypeID=" + entity.TypeID; }
            strSQL += "group by e.Name,d.TypeName,SUBSTRING( Convert(varchar(100),a.CreateDate,112),1,6),c.Specs,c.Figure order by d.TypeName desc ,ReportDate desc, SUM(b.Piece) desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            HouseName = Convert.ToString(idrCount["HouseName"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            ReportDate = Convert.ToString(idrCount["ReportDate"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            Figure = Convert.ToString(idrCount["Figure"]),
                            OrderPiece = Convert.ToInt32(idrCount["OrderPiece"]),
                            OrderCharge = Convert.ToDecimal(idrCount["OrderCharge"])
                        });
                    }
                }
            }

            return result;
        }

        public List<CargoDLTDataStatisEntity> QueryRegionStatistics(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select d.TypeName,SUM(b.Piece) as OrderPiece  From Tbl_Cargo_Order as a inner join Tbl_Cargo_OrderGoods as b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID inner join Tbl_Cargo_Product as c on b.ProductID=c.ProductID and b.HouseID=c.HouseID left join Tbl_Cargo_ProductType as d on c.TypeID=d.TypeID left join Tbl_Cargo_House as e on a.HouseID=e.HouseID  where (1=1)";
            if (string.IsNullOrEmpty(entity.ThrowGood)) { strSQL += " and a.ThrowGood!='2' "; }
            if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and a.OrderModel = '" + entity.OrderModel + "'"; }
            //所属仓库ID
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            //入库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += "group by d.TypeName order by   SUM(b.Piece) desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            OrderPiece = Convert.ToInt32(idrCount["OrderPiece"]),
                        });
                    }
                }
            }
            return result;
        }
        public List<CargoDLTDataStatisEntity> QuerySalesVolume(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select  sum(c.Piece) Piece,a.ShopCode,ClientName From Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum and a.HouseID=b.HouseID inner join Tbl_Cargo_OrderGoods as c on a.OrderNo=c.OrderNo and a.HouseID=c.HouseID where (1=1) and a.OrderModel = '0'";
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            //入库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<='" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " group by a.ShopCode,ClientName ORDER BY sum(c.Piece) DESC";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            OrderPiece = Convert.ToInt32(idrCount["Piece"]),
                            ShopCode = Convert.ToString(idrCount["ShopCode"]),
                            ClientName = Convert.ToString(idrCount["ClientName"]),
                        });
                    }
                }
            }
            return result;
        }

        public CargoDLTDataStatisEntity Statisticalheader(CargoDLTDataStatisEntity entity)
        {
            CargoDLTDataStatisEntity result = new CargoDLTDataStatisEntity();
            try
            {
                string strSQL = "select count(*) as OrderNum,sum(a.Piece) OrderPiece From Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum and a.HouseID=b.HouseID   where (1=1) and a.OrderModel = '0' ";
                string strSQL2 = "SELECT count(*) as ClientNum FROM Tbl_Cargo_Client WHERE 1=1 ";
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; strSQL2 += " and HouseID in (" + entity.CargoPermisID + ")"; }
                //入库时间
                int len = strSQL.Length;
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow item in dt.Rows)
                        {
                            result.OrderPiece = Convert.ToInt32(item["OrderPiece"]);
                            result.OrderNum = Convert.ToInt32(item["OrderNum"]);
                        }
                    }
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL2))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow item in dt.Rows)
                        {
                            result.ClientNum = Convert.ToInt32(item["ClientNum"]);
                        }
                    }
                }
                strSQL = strSQL.Substring(0, len);
                DateTime currentDate = DateTime.Now;

                // 获取当前年份和月份
                int currentYear = entity.StartDate.Year;
                int currentMonth = entity.StartDate.Month;
                DateTime currentYearMonth = new DateTime(currentYear, currentMonth, 1);
                DateTime lastDayOfMonth = new DateTime(currentYear, currentMonth, 1).AddMonths(1);
                strSQL += " and a.CreateDate>='" + currentYearMonth.ToString("yyyy-MM-dd") + "'";
                strSQL += " and a.CreateDate<'" + lastDayOfMonth.ToString("yyyy-MM-dd") + "'";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow item in dt.Rows)
                        {
                            result.DNOrderPiece = Convert.ToInt32(item["OrderPiece"]);
                            result.DNOrderNum = Convert.ToInt32(item["OrderNum"]);
                        }
                    }
                }

            }
            catch (Exception)
            {

                throw;
            }
            return result;
        }

        public List<CargoDLTDataStatisEntity> QueryAgeing(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = " select a.CreateDate,a.SignTime,DeadTime,ApartDay,b.ShopCode,b.Product,b.ClientShortName,b.Province  From Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum and a.HouseID=b.HouseID inner join Tbl_Cargo_OrderGoods as c on a.OrderNo=c.OrderNo and a.HouseID=c.HouseID join Tbl_Cargo_Ageing d on b.ClientID=d.ClientID and d.HouseID=a.HouseID where (1=1) and a.OrderModel = '0'  and a.SignTime is not null";
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            CreateDate = Convert.ToDateTime(idrCount["CreateDate"]),
                            SignTime = Convert.ToDateTime(idrCount["SignTime"]),
                            DeadTime = Convert.ToString(idrCount["DeadTime"]),
                            ApartDay = Convert.ToInt32(idrCount["ApartDay"]),
                            ShopCode = Convert.ToString(idrCount["ShopCode"]),
                            Specs = Convert.ToString(idrCount["Product"]),
                            ShopName = Convert.ToString(idrCount["ClientShortName"]),
                            Province = Convert.ToString(idrCount["Province"]),
                        });
                    }
                }
            }


            return result;
        }
        public List<CargoDLTDataStatisEntity> Statistics(List<CargoDLTDataStatisEntity> entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            foreach (var item in entity)
            {
                string strSQL = "select count(*) as OrderNum,sum(c.Piece) OrderPiece From Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum and a.HouseID=b.HouseID inner join Tbl_Cargo_OrderGoods as c on a.OrderNo=c.OrderNo and a.HouseID=c.HouseID where (1=1) and a.OrderModel = '0' ";
                if (!string.IsNullOrEmpty(item.CargoPermisID)) { strSQL += " and a.HouseID in (" + item.CargoPermisID + ")"; }
                //入库时间
                if ((item.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && item.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + item.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((item.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && item.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + item.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(cmd))
                    {
                        foreach (DataRow items in dt.Rows)
                        {
                            result.Add(new CargoDLTDataStatisEntity
                            {
                                OrderPiece = Convert.ToString(items["OrderPiece"]) == "" ? 0 : Convert.ToInt32(items["OrderPiece"]),
                                OrderNum = Convert.ToInt32(items["OrderNum"]) == 0 ? 0 : Convert.ToInt32(items["OrderNum"]),
                                ReportDate = item.ReportDate,
                                EndDate = Convert.ToDateTime(item.EndDate),
                            });

                        }
                    }
                }
            }


            return result;
        }
        public List<CargoDLTDataStatisEntity> QueryRegionStatisMoM(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = " SELECT * FROM (select b.Product as AreaMoM,SUM(c.Piece) as SumPieceMoM From Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum and a.HouseID=b.HouseID inner join Tbl_Cargo_OrderGoods as c on a.OrderNo=c.OrderNo and a.HouseID=c.HouseID where (1=1) and a.ThrowGood!='2' ";
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += "group by b.Product ) AY  right join  (select b.Product as Area,SUM(c.Piece) as SumPiece  From Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum and a.HouseID=b.HouseID inner join Tbl_Cargo_OrderGoods as c on a.OrderNo=c.OrderNo and a.HouseID=c.HouseID where (1=1)  and a.ThrowGood!='2'";
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.AddMonths(1).ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddMonths(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " group by b.Product ) AZ on AY.AreaMoM=AZ.Area";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow items in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            OrderPiece = Convert.ToString(items["SumPiece"]) == "" ? 0 : Convert.ToInt32(items["SumPiece"]),
                            DNOrderPiece = Convert.ToString(items["SumPieceMoM"]) == "" ? 0 : Convert.ToInt32(items["SumPieceMoM"]),
                            Area = Convert.ToString(items["Area"])
                        });

                    }
                }
            }
            return result;
        }

        public List<CargoDLTDataStatisEntity> QuryTyreType(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "SELECT d.TyreType,sum(a.Piece)OrderPiece FROM Tbl_Cargo_OrderGoods as a inner join Tbl_Cargo_Order AS B on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID inner join Tbl_Cargo_Product as c on a.ProductID=c.ProductID and a.HouseID=c.HouseID inner join Tbl_Cargo_ProductSpec as d on c.GoodsCode=d.GoodsCode where 1=1";
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and b.OrderModel = '" + entity.OrderModel + "'"; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and b.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " group by d.TyreType";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            OrderPiece = Convert.ToInt32(idrCount["OrderPiece"]),
                            TyreType = Convert.ToString(idrCount["TyreType"]),

                        });
                    }
                }
            }
            return result;
        }

        public List<CargoDLTDataStatisEntity> StatisticalAmountSalesvolume(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "Select sum(TotalCharge)TotalCharge,Sum(Piece) Piece,Date From (SELECT  TotalCharge,Sum(b.Piece) Piece ,CONVERT(varchar(7), a.OP_DATE, 120) Date  FROM Tbl_Cargo_Order a join Tbl_Cargo_OrderGoods b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID  where 1=1 and  a.OrderModel = '0' and a.ThrowGood!='2'";
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and CONVERT(varchar(7), a.CreateDate, 120)>='" + entity.StartDate.ToString("yyyy-MM") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and CONVERT(varchar(7), a.CreateDate, 120)<'" + entity.EndDate.AddMonths(1).ToString("yyyy-MM") + "'";
            }
            strSQL += "group by TotalCharge,CONVERT(varchar(7), a.OP_DATE, 120),a.OP_DATE) c group by Date order by Date";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            DeadTime = Convert.ToString(idrCount["Date"]),
                            OrderPiece = Convert.ToInt32(idrCount["Piece"]),
                            OrderCharge = Convert.ToDecimal(idrCount["TotalCharge"])

                        });
                    }
                }
            }

            return result;
        }

        /// <summary>
        /// 惠彩云仓用户统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> HCYC_User_Statistics(CargoDLTDataStatisEntity entity, int DataType = 1)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select a.wxOpenID,a.OP_DATE,a.ClientNum from Tbl_WX_Client as a inner join Tbl_Cargo_Client as b on a.ClientNum=b.ClientNum where 1=1";
            if (DataType == 2)
            {
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01") && (entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += $@" and a.OP_DATE>='{entity.StartDate.ToString("yyyy-MM-dd")}' and a.OP_DATE<='{entity.EndDate.ToString("yyyy-MM-dd")}' ";
                }
            }
            if (entity.HouseID != 0)
            {
                strSQL += " and b.HouseID =" + entity.HouseID;
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            WxOpenID = Convert.ToString(idrCount["wxOpenID"]),
                            CreateDate = Convert.ToDateTime(idrCount["OP_DATE"]),
                            ClientNum = Convert.ToInt32(idrCount["ClientNum"])
                        });
                    }
                }
            }
            return (result);

        }

        /// <summary>
        /// 惠彩云仓用户统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoDLTDataStatisEntity HCYC_User_StatisticsData(CargoDLTDataStatisEntity entity)
        {
            CargoDLTDataStatisEntity result = new CargoDLTDataStatisEntity();
            string strSQL = $@"
            SELECT
                COUNT(DISTINCT CASE WHEN a.OP_DATE BETWEEN  '{entity.StartDate.ToString("yyyy-MM-dd")}' AND '{entity.EndDate.AddDays(1).ToString("yyyy-MM-dd")}' THEN (a.ClientNum) END) AS ClientCount,
                COUNT(DISTINCT a.ClientNum) AS RegisterStoresCount,
                COUNT(DISTINCT CASE WHEN a.OP_DATE BETWEEN  '{entity.StartDate.ToString("yyyy-MM-dd")}' AND '{entity.EndDate.AddDays(1).ToString("yyyy-MM-dd")}' THEN (a.ID) END) AS UserCount,
                COUNT(DISTINCT a.ID) AS RegisterUserCount
           from Tbl_Cargo_Client as b
inner join Tbl_WX_Client as a on a.ClientNum=b.ClientNum;
            ";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result = (new CargoDLTDataStatisEntity
                        {
                            UserCount = Convert.ToInt32(idrCount["UserCount"]),
                            RegisterStoresCount = Convert.ToInt32(idrCount["RegisterStoresCount"]),
                            RegisterUserCount = Convert.ToInt32(idrCount["RegisterUserCount"]),
                            ClientCount = Convert.ToInt32(idrCount["ClientCount"]),
                        });
                    }
                }
            }
            return (result);

        }
        /// <summary>
        /// 查询慧采云仓访问请求数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> HCYC_Access_Statistics(CargoDLTDataStatisEntity entity, int DataType = 1)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select a.HouseID,a.wxOpenID,CONVERT(varchar(10),a.AccessTime,120) as AccessDate,b.ClientNum from Tbl_Cargo_ProductAccessDetails as a inner join Tbl_WX_Client as b on a.wxOpenID=b.wxOpenID where (1=1)";
            if (DataType == 1)
            {
                if (entity.HouseID != 0) { strSQL += " and a.HouseID=" + entity.HouseID; }
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.AccessTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
            }
            else if (DataType == 2)
            {
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01") && (entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and convert(varchar(10),a.AccessTime,23)>='" + entity.StartDate.ToString("yyyy-MM-dd") + $@"' and convert(varchar(10),a.AccessTime,23) <= '{entity.EndDate.ToString("yyyy-MM-dd")}' ";
                }
            }
            strSQL += " order by AccessTime desc";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            WxOpenID = Convert.ToString(idrCount["wxOpenID"]),
                            AccessDate = Convert.ToDateTime(idrCount["AccessDate"]),
                            ClientNum = Convert.ToInt32(idrCount["ClientNum"]),
                            HouseID = Convert.ToInt32(idrCount["HouseID"])
                        });
                    }
                }
            }
            return result;

        }


        /// <summary>
        /// 查询慧采云仓访问请求数据(供应商)
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> HCYC_Access_Statistics_Supplier(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select a.HouseID,a.wxOpenID,CONVERT(varchar(10),a.AccessTime,120) as AccessDate,b.ClientNum , T.TypeID,T.TypeName from Tbl_Cargo_ProductAccessDetails as a inner join Tbl_WX_Client as b on a.wxOpenID=b.wxOpenID join  Tbl_Cargo_Product d on a.ProductCode=d.ProductCode and a.HouseID=d.HouseID  LEFT JOIN Tbl_Cargo_ProductType T ON T.TypeID=d.TypeID where (1=1)";

            if (entity.HouseID != 0)
            {
                strSQL += " and a.HouseID=" + entity.HouseID;
            }

            if (!string.IsNullOrEmpty(entity.TypeName))
            {
                strSQL += " and T.TypeID in (" + entity.TypeName + ")";
            }

            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.AccessTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }

            strSQL += " order by AccessTime desc";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            WxOpenID = Convert.ToString(idrCount["wxOpenID"]),
                            AccessDate = Convert.ToDateTime(idrCount["AccessDate"]),
                            ClientNum = Convert.ToInt32(idrCount["ClientNum"]),
                            HouseID = Convert.ToInt32(idrCount["HouseID"])
                        });
                    }
                }
            }
            return result;

        }
        public List<CargoDLTDataStatisEntity> HCYC_Stores_Statistics(CargoDLTDataStatisEntity entity, int DataType = 1)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "SELECT OP_DATE FROM Tbl_Cargo_Client where 1=1";
            if (DataType == 2)
            {
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01") && (entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += $@" and OP_DATE>='{entity.StartDate.ToString("yyyy-MM-dd")}' and OP_DATE<='{entity.EndDate.ToString("yyyy-MM-dd")}' ";
                }
            }
            if (entity.HouseID != 0)
            {
                strSQL += " and HouseID =" + entity.HouseID;
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            //WxOpenID = Convert.ToString(idrCount["wxOpenID"]),
                            CreateDate = Convert.ToDateTime(idrCount["OP_DATE"]),
                        });
                    }
                }
            }
            return (result);

        }
        /// <summary>
        /// 订单统计数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> HCYC_Order_Statistics(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            //string strSQL = "SELECT HouseID,Piece,TotalCharge,* FROM Tbl_Cargo_Order WHERE OrderType=4 ";
            //if (entity.HouseID != 0)
            //{
            //    strSQL += " and HouseID in (" + entity.HouseID + ")";
            //}
            //if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            //{
            //    strSQL += " and CONVERT(varchar(7), a.CreateDate, 120)>='" + entity.StartDate.ToString("yyyy-MM") + "'";
            //}
            //if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            //{
            //    strSQL += " and CONVERT(varchar(7), a.CreateDate, 120)<'" + entity.EndDate.AddMonths(1).ToString("yyyy-MM") + "'";
            //}


            string strSQL = "select ISNULL(a.sale_total_num,0) as SaleOrderTotalNum,ISNULL(a.sale_total_quantity,0) as SaleOrderTotalPiece,ISNULL(a.sale_total_amount,0) as SaleOrderTotalCharge,ISNULL(b.sale_daily_num,0) as SaleOrderDayNum,ISNULL(b.sale_daily_quantity,0) as SaleOrderDayPiece,ISNULL(b.sale_daily_amount,0) as SaleOrderDayCharge,ISNULL(c.sale_monthly_num,0) as SaleOrderMonthNum,ISNULL(c.sale_monthly_quantity,0) as SaleOrderMonthPiece,ISNULL(c.sale_monthly_amount,0) as SaleOrderMonthCharge,ISNULL(d.retu_monthly_num,0) as ReturnOrderMonthNum,ISNULL(d.retu_monthly_quantity,0) as ReturnOrderMonthPiece,ISNULL(d.retu_monthly_amount,0) as ReturnOrderMonthCharge,ISNULL(e.retu_daily_num,0) as ReturnOrderDayNum,ISNULL(e.retu_daily_quantity,0) as ReturnOrderDayPiece,ISNULL(e.retu_daily_amount,0) as ReturnOrderDayCharge,ISNULL(f.OES_sale_daily_num,0) as OESSaleOrderDayNum,ISNULL(f.OES_sale_daily_quantity,0) as OESSaleOrderDayPiece,ISNULL(f.OES_sale_daily_amount,0) as OESSaleOrderDayCharge,ISNULL(g.OES_sale_monthly_num,0) as OESSaleOrderMonthNum,ISNULL(g.OES_sale_monthly_quantity,0) as OESSaleOrderMonthPiece,ISNULL(g.OES_sale_monthly_amount,0) as OESSaleOrderMonthCharge from";
            strSQL += " (SELECT HouseID,COUNT(*) as sale_total_num,SUM(Piece) AS sale_total_quantity,SUM(TotalCharge) AS sale_total_amount FROM Tbl_Cargo_Order WHERE OrderType=4  and HouseID=" + entity.HouseID + " and OrderModel=0 and ThrowGood=22 group by HouseID) as a left join  ";
            strSQL += " (SELECT HouseID,COUNT(*) as sale_daily_num,SUM(Piece) AS sale_daily_quantity,SUM(TotalCharge) AS sale_daily_amount FROM Tbl_Cargo_Order WHERE OrderType=4  and HouseID=" + entity.HouseID + " and OrderModel=0 and ThrowGood=22 and CreateDate>='" + DateTime.Now.ToString("yyyy-MM-dd") + "' group by HouseID) as b on a.HouseID=b.HouseID left join ";
            strSQL += " (SELECT HouseID,COUNT(*) as sale_monthly_num,SUM(Piece) AS sale_monthly_quantity,SUM(TotalCharge) AS sale_monthly_amount FROM Tbl_Cargo_Order WHERE OrderType=4  and HouseID=" + entity.HouseID + " and OrderModel=0 and ThrowGood=22 and CreateDate>='" + DateTime.Now.AddDays(1 - DateTime.Now.Day).ToString("yyyy-MM-dd") + "' and CreateDate<'" + DateTime.Now.AddDays(1).ToString("yyyy-MM-dd") + "' group by HouseID) as c on a.HouseID=c.HouseID left join ";
            strSQL += "(SELECT HouseID,COUNT(*) as retu_monthly_num,SUM(Piece) AS retu_monthly_quantity,SUM(TotalCharge) AS retu_monthly_amount FROM Tbl_Cargo_Order WHERE OrderType=4  and HouseID=" + entity.HouseID + " and OrderModel=1 and ThrowGood=5 and CreateDate>='" + DateTime.Now.AddDays(1 - DateTime.Now.Day).ToString("yyyy-MM-dd") + "' and CreateDate<'" + DateTime.Now.AddDays(1).ToString("yyyy-MM-dd") + "'group by HouseID) as d on a.HouseID=d.HouseID left join ";
            strSQL += "(SELECT HouseID,COUNT(*) as retu_daily_num,SUM(Piece) AS retu_daily_quantity,SUM(TotalCharge) AS retu_daily_amount FROM Tbl_Cargo_Order WHERE OrderType=4  and HouseID=" + entity.HouseID + " and OrderModel=1 and ThrowGood=5 and CreateDate>='" + DateTime.Now.ToString("yyyy-MM-dd") + "'group by HouseID) as e on a.HouseID=e.HouseID left join ";
            strSQL += "(SELECT HouseID,COUNT(*) as OES_sale_daily_num,SUM(Piece) AS OES_sale_daily_quantity,SUM(TotalCharge) AS OES_sale_daily_amount FROM Tbl_Cargo_Order WHERE OrderType=4  and HouseID=" + entity.HouseID + " and OrderModel=0 and ThrowGood=12 and CreateDate>='" + DateTime.Now.ToString("yyyy-MM-dd") + "' group by HouseID) as f on a.HouseID=f.HouseID left join ";
            strSQL += "(SELECT HouseID,COUNT(*) as OES_sale_monthly_num,SUM(Piece) AS OES_sale_monthly_quantity,SUM(TotalCharge) AS OES_sale_monthly_amount FROM Tbl_Cargo_Order WHERE OrderType=4  and HouseID=" + entity.HouseID + " and OrderModel=0 and ThrowGood=12 and CreateDate>='" + DateTime.Now.AddDays(1 - DateTime.Now.Day).ToString("yyyy-MM-dd") + "' and CreateDate<'" + DateTime.Now.AddDays(1).ToString("yyyy-MM-dd") + "' group by HouseID) as g on a.HouseID=g.HouseID";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            SaleOrderDayNum = Convert.ToInt32(idrCount["SaleOrderDayNum"]),
                            SaleOrderDayPiece = Convert.ToInt32(idrCount["SaleOrderDayPiece"]),
                            SaleOrderDayCharge = Convert.ToDecimal(idrCount["SaleOrderDayCharge"]),

                            SaleOrderMonthNum = Convert.ToInt32(idrCount["SaleOrderMonthNum"]),
                            SaleOrderMonthPiece = Convert.ToInt32(idrCount["SaleOrderMonthPiece"]),
                            SaleOrderMonthCharge = Convert.ToDecimal(idrCount["SaleOrderMonthCharge"]),

                            SaleOrderTotalNum = Convert.ToInt32(idrCount["SaleOrderTotalNum"]),
                            SaleOrderTotalPiece = Convert.ToInt32(idrCount["SaleOrderTotalPiece"]),
                            SaleOrderTotalCharge = Convert.ToDecimal(idrCount["SaleOrderTotalCharge"]),

                            OESSaleOrderDayNum = Convert.ToInt32(idrCount["OESSaleOrderDayNum"]),
                            OESSaleOrderDayPiece = Convert.ToInt32(idrCount["OESSaleOrderDayPiece"]),
                            OESSaleOrderDayCharge = Convert.ToDecimal(idrCount["OESSaleOrderDayCharge"]),

                            OESSaleOrderMonthNum = Convert.ToInt32(idrCount["OESSaleOrderMonthNum"]),
                            OESSaleOrderMonthPiece = Convert.ToInt32(idrCount["OESSaleOrderMonthPiece"]),
                            OESSaleOrderMonthCharge = Convert.ToDecimal(idrCount["OESSaleOrderMonthCharge"]),

                            ReturnOrderDayNum = Convert.ToInt32(idrCount["ReturnOrderDayNum"]),
                            ReturnOrderDayPiece = Convert.ToInt32(idrCount["ReturnOrderDayPiece"]),
                            ReturnOrderDayCharge = Convert.ToDecimal(idrCount["ReturnOrderDayCharge"]),

                            ReturnOrderMonthNum = Convert.ToInt32(idrCount["ReturnOrderMonthNum"]),
                            ReturnOrderMonthPiece = Convert.ToInt32(idrCount["ReturnOrderMonthPiece"]),
                            ReturnOrderMonthCharge = Convert.ToDecimal(idrCount["ReturnOrderMonthCharge"]),
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 订单统计明细
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> HCYC_Order_StatisticsDetail(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "SELECT Piece,TotalCharge,CreateDate FROM Tbl_Cargo_Order WHERE OrderType=4 and OrderModel=0 and ThrowGood=22 ";
            if (entity.HouseID != 0)
            {
                strSQL += " and HouseID =" + entity.HouseID;
            }
            strSQL += "and CreateDate>='" + DateTime.Now.AddDays(1 - DateTime.Now.Day).ToString("yyyy-MM-dd") + "' and CreateDate<'" + DateTime.Now.AddDays(1).ToString("yyyy-MM-dd") + "'";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            OrderPiece = Convert.ToInt32(idrCount["Piece"]),
                            OrderCharge = Convert.ToDecimal(idrCount["TotalCharge"]),
                            CreateDate = Convert.ToDateTime(idrCount["CreateDate"]),
                        });
                    }
                }
            }

            return result;
        }
        /// <summary>
        /// 订单统计数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> HCYC_Order_Statistics_Supplier(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "SELECT distinct a.OrderNo,a.HouseID,a.Piece,TotalCharge, T.TypeID,T.TypeName ,a.OP_DATE  FROM Tbl_Cargo_Order a join Tbl_Cargo_OrderGoods b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID join  Tbl_Cargo_Product d on b.ProductID=d.ProductID and b.HouseID=d.HouseID LEFT JOIN Tbl_Cargo_ProductType T ON T.TypeID=d.TypeID WHERE OrderType=4";
            if (entity.HouseID != 0)
            {
                strSQL += " and a.HouseID in (" + entity.HouseID + ")";
            }
            if (!string.IsNullOrEmpty(entity.TypeName))
            {
                strSQL += " and T.TypeID in (" + entity.TypeName + ")";
            }
            //if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            //{
            //    strSQL += " and CONVERT(varchar(7), a.OP_DATE, 120)>='" + entity.StartDate.ToString("yyyy-MM") + "'";
            //}
            //if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            //{
            //    strSQL += " and CONVERT(varchar(7), a.CreateDate, 120)<'" + entity.EndDate.AddMonths(1).ToString("yyyy-MM") + "'";
            //}
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            OrderPiece = Convert.ToInt32(idrCount["Piece"]),
                            OrderCharge = Convert.ToDecimal(idrCount["TotalCharge"]),
                            CreateDate = Convert.ToDateTime(idrCount["OP_DATE"]),
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 按照品牌查询销售数量
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryHCYC_BrandNum(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = " SELECT T.TypeID,T.TypeName,SUM(case when OrderModel = 1 then -b.Piece else b.Piece end) as TotalPiece,SUM((case when OrderModel = 1 then -b.Piece else b.Piece end)*b.ActSalePrice) as TotalCharge,CONVERT(DECIMAL(10,2), SUM((case when OrderModel = 1 then -b.Piece else b.Piece end)*b.ActSalePrice)/SUM((case when OrderModel = 1 then -b.Piece else b.Piece end))) as UnitCharge  FROM  Tbl_Cargo_Order a join Tbl_Cargo_OrderGoods b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID join  Tbl_Cargo_Product d on b.ProductID=d.ProductID and b.HouseID=d.HouseID LEFT JOIN Tbl_Cargo_ProductType T ON T.TypeID=d.TypeID where 1=1 and a.OrderType=4 ";
            if (entity.HouseID != 0)
            {
                strSQL += " and a.HouseID =" + entity.HouseID;
            }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " GROUP BY T.TypeID,T.TypeName ORDER BY TotalPiece DESC ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            OrderPiece = Convert.ToInt32(idrCount["TotalPiece"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            OrderCharge = Convert.ToDecimal(idrCount["TotalCharge"]),
                            UnitCharge = Convert.ToDecimal(idrCount["UnitCharge"]),
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 销售最好的前30个轮胎规格
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryHCYC_BrandSpecsNum(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "SELECT top 100 T.TypeID,T.TypeName,d.Specs,d.Figure,SUM((case when OrderModel = 1 then -b.Piece else b.Piece end)) as TotalPiece,CONVERT(DECIMAL(10,2), SUM((case when OrderModel = 1 then -b.Piece else b.Piece end)*b.ActSalePrice)/SUM((case when OrderModel = 1 then -b.Piece else b.Piece end))) as UnitCharge  FROM  Tbl_Cargo_Order a join Tbl_Cargo_OrderGoods b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID join  Tbl_Cargo_Product d on b.ProductID=d.ProductID and b.HouseID=d.HouseID LEFT JOIN Tbl_Cargo_ProductType T ON T.TypeID=d.TypeID where a.OrderType=4 ";
            if (entity.HouseID != 0)
            {
                strSQL += " and a.HouseID =" + entity.HouseID;
            }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.TypeName))
            {
                strSQL += " and T.TypeID in (" + entity.TypeName + ")";
            }
            strSQL += " GROUP BY T.TypeID,T.TypeName,d.Specs,d.Figure ORDER BY TotalPiece DESC ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            OrderPiece = Convert.ToInt32(idrCount["TotalPiece"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            Figure = Convert.ToString(idrCount["Figure"]),
                            // OrderCharge = Convert.ToDecimal(idrCount["TotalCharge"]),
                            UnitCharge = Convert.ToDecimal(idrCount["UnitCharge"]),
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询日浏览数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryHCYC_DayAccessNum(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select ROW_NUMBER() OVER (ORDER BY a.ID DESC) AS RowNumber,a.ID,a.HouseID,a.FeedBackStatus,c.TypeName,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,a.AccessTime,d.CompanyName,d.Name,d.Cellphone from Tbl_Cargo_ProductAccessDetails as a inner join Tbl_Cargo_ProductSpec as b on a.ProductCode=b.ProductCode inner join Tbl_Cargo_ProductType as c on b.TypeID=c.TypeID inner join Tbl_WX_Client as d on a.wxOpenID=d.wxOpenID where (1=1) ";
            if (entity.HouseID != 0) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.AccessTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.AccessTime<='" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.TypeName))
            {
                strSQL += " and c.TypeID in (" + entity.TypeName + ")";
            }
            strSQL += " order by a.AccessTime desc ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            RowNumber = Convert.ToInt32(idrCount["RowNumber"]),
                            id = Convert.ToInt32(idrCount["ID"]),
                            HouseID = Convert.ToInt32(idrCount["HouseID"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            Figure = Convert.ToString(idrCount["Figure"]),
                            SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                            LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                            CompanyName = Convert.ToString(idrCount["CompanyName"]),
                            Name = Convert.ToString(idrCount["Name"]),
                            Cellphone = Convert.ToString(idrCount["Cellphone"]),
                            AccessDate = Convert.ToDateTime(idrCount["AccessTime"]),
                            FeedBackStatus = Convert.ToString(idrCount["FeedBackStatus"]),
                        });
                    }
                }
            }
            return result;

        }
        /// <summary>
        /// 查询日浏览数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryHCYC_DayAccessNumV2(CargoDLTDataStatisEntity entity, int pageIndex, int pageSize)
        {
            Hashtable resHT = new Hashtable();
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select ROW_NUMBER() OVER (ORDER BY a.ID DESC) AS RowNumber,a.ID,a.HouseID,a.FeedBackStatus,c.TypeName,b.Specs,b.Figure,b.LoadIndex,b.SpeedLevel,a.AccessTime,d.CompanyName,d.Name,d.Cellphone from Tbl_Cargo_ProductAccessDetails as a inner join Tbl_Cargo_ProductSpec as b on a.ProductCode=b.ProductCode inner join Tbl_Cargo_ProductType as c on b.TypeID=c.TypeID inner join Tbl_WX_Client as d on a.wxOpenID=d.wxOpenID where (1=1) ";
            if (entity.HouseID != 0) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.AccessTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.AccessTime<='" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.TypeName))
            {
                strSQL += " and c.TypeID in (" + entity.TypeName + ")";
            }
            strSQL += " order by a.AccessTime desc ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            RowNumber = Convert.ToInt32(idrCount["RowNumber"]),
                            id = Convert.ToInt32(idrCount["ID"]),
                            HouseID = Convert.ToInt32(idrCount["HouseID"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            Figure = Convert.ToString(idrCount["Figure"]),
                            SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                            LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                            CompanyName = Convert.ToString(idrCount["CompanyName"]),
                            Name = Convert.ToString(idrCount["Name"]),
                            Cellphone = Convert.ToString(idrCount["Cellphone"]),
                            AccessDate = Convert.ToDateTime(idrCount["AccessTime"]),
                            FeedBackStatus = Convert.ToString(idrCount["FeedBackStatus"]),
                        });
                    }
                }
            }
            resHT["AllRows"] = result;
            result = result.Where(c => c.RowNumber > (pageSize * (pageIndex - 1)) && c.RowNumber < pageSize * pageIndex + 1).ToList();
            resHT["rows"] = result;

            string strCount = "select Count(1) as TotalCount from Tbl_Cargo_ProductAccessDetails as a inner join Tbl_Cargo_ProductSpec as b on a.ProductCode=b.ProductCode inner join Tbl_Cargo_ProductType as c on b.TypeID=c.TypeID inner join Tbl_WX_Client as d on a.wxOpenID=d.wxOpenID where (1=1) ";
            if (entity.HouseID != 0) { strCount += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strCount += " and a.AccessTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strCount += " and a.AccessTime<='" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.TypeName))
            {
                strCount += " and c.TypeID in (" + entity.TypeName + ")";
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
            {
                using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                {
                    if (idrCount.Rows.Count > 0)
                    {
                        resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                    }
                }
            }
            return resHT;

        }
        /// <summary>
        /// 查询品牌月销售转化率
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryHCYC_BrandConverRate(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select a.TypeName,a.BrowseNum,ISNULL(b.SalePiece,0) as SalePiece,ISNULL(b.SaleCount,0) as SaleCount from (select c.TypeName,COUNT(*) as BrowseNum from Tbl_Cargo_ProductAccessDetails as a inner join Tbl_Cargo_ProductSpec as b on a.ProductCode=b.ProductCode inner join Tbl_Cargo_ProductType as c on b.TypeID=c.TypeID inner join Tbl_WX_Client as d on a.wxOpenID=d.wxOpenID where (1=1) ";
            if (entity.HouseID != 0) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.AccessTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.AccessTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " group by c.TypeName ) as a left join ( SELECT T.TypeName,SUM(case when OrderModel = 1 then -b.Piece else b.Piece end) AS SalePiece,count(distinct case when OrderModel=0 then a.OrderID end) SaleCount FROM  Tbl_Cargo_Order a join Tbl_Cargo_OrderGoods b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID  join  Tbl_Cargo_Product d on b.ProductID=d.ProductID and b.HouseID=d.HouseID LEFT JOIN Tbl_Cargo_ProductType T ON T.TypeID=D.TypeID where a.OrderType=4";
            if (entity.HouseID != 0) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += "GROUP BY T.TypeName  ) as b on a.TypeName=b.TypeName order by b.SalePiece desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        var BrowseNum = Convert.ToDouble(idrCount["BrowseNum"]);
                        var SaleCount = Convert.ToDouble(idrCount["SaleCount"]);
                        double OrderNum = 0;
                        if (!SaleCount.Equals(0))
                        {
                            OrderNum = Math.Round(SaleCount / BrowseNum * 100, 2);
                        }
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            OrderPiece = Convert.ToInt32(idrCount["SalePiece"]),
                            OrderCount = Convert.ToInt32(idrCount["SaleCount"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            BrowseNum = Convert.ToInt32(idrCount["BrowseNum"]),
                            OrderNumRate = OrderNum,//转化率
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 客户浏览成交转化率
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryHCYC_ClientConverRate(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select a.ClientNum,c.ClientName,a.BrowseNum,ISNULL(b.SalePiece,0) as SalePiece, ISNULL(b.SaleCount, 0) as SaleCount from (select d.ClientNum,COUNT(*) as BrowseNum from Tbl_Cargo_ProductAccessDetails as a inner join Tbl_Cargo_ProductSpec as b on a.ProductCode=b.ProductCode inner join Tbl_Cargo_ProductType as c on b.TypeID=c.TypeID inner join Tbl_WX_Client as d on a.wxOpenID=d.wxOpenID where (1=1) ";
            if (entity.HouseID != 0) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.AccessTime>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.AccessTime<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " group by d.ClientNum ) as a left join ( SELECT a.ClientNum,SUM(case when OrderModel = 1 then -b.Piece else b.Piece end)AS SalePiece,count(distinct case when OrderModel = 0 then a.OrderID end) AS SaleCount FROM  Tbl_Cargo_Order a join Tbl_Cargo_OrderGoods b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID  join  Tbl_Cargo_Product d on b.ProductID=d.ProductID and b.HouseID=d.HouseID LEFT JOIN Tbl_Cargo_ProductType T ON T.TypeID=D.TypeID where a.OrderType=4";
            if (entity.HouseID != 0) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += "GROUP BY a.ClientNum  ) as b on a.ClientNum=b.ClientNum left join Tbl_Cargo_Client as c on a.ClientNum=c.ClientNum order by b.SalePiece desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        var BrowseNum = Convert.ToDouble(idrCount["BrowseNum"]);
                        var SaleCount = Convert.ToDouble(idrCount["SaleCount"]);
                        double OrderNum = 0;
                        if (!SaleCount.Equals(0))
                        {
                            OrderNum = Math.Round(SaleCount / BrowseNum * 100, 2);
                        }
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            OrderPiece = Convert.ToInt32(idrCount["SalePiece"]),
                            OrderCount = Convert.ToInt32(idrCount["SaleCount"]),
                            ClientName = Convert.ToString(idrCount["ClientName"]),
                            BrowseNum = Convert.ToInt32(idrCount["BrowseNum"]),
                            OrderNumRate = OrderNum,//转化率
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 近七日的订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryHCYC_SevenDayOrderInfo(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select ROW_NUMBER() OVER (ORDER BY a.OrderID DESC) AS RowNumber, a.OrderNo,b.Piece,e.TypeName,c.Specs,c.Figure,c.LoadIndex,c.SpeedLevel,d.ClientName,d.Cellphone,d.Boss,d.Address,a.CreateDate from Tbl_Cargo_Order as a inner join Tbl_Cargo_OrderGoods as b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID inner join Tbl_Cargo_Product  as c on b.ProductID=c.ProductID inner join Tbl_Cargo_Client as d on a.ClientNum=d.ClientNum inner join Tbl_Cargo_ProductType as e on c.TypeID=e.TypeID  where a.OrderType=4 and a.WXOrderNo!=''";
            if (entity.HouseID != 0) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.TypeName))
            {
                strSQL += " and e.TypeID in (" + entity.TypeName + ")";
            }
            strSQL += "order by a.CreateDate desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            RowNumber = Convert.ToInt32(idrCount["RowNumber"]),
                            OrderPiece = Convert.ToInt32(idrCount["Piece"]),
                            ClientName = Convert.ToString(idrCount["ClientName"]),
                            Cellphone = Convert.ToString(idrCount["Cellphone"]),
                            Name = Convert.ToString(idrCount["Boss"]),
                            Address = Convert.ToString(idrCount["Address"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            Figure = Convert.ToString(idrCount["Figure"]),
                            LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                            CreateDate = Convert.ToDateTime(idrCount["CreateDate"]),
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 近七日的订单数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryHCYC_SevenDayOrderInfoV2(CargoDLTDataStatisEntity entity, int pageIndex, int pageSize)
        {
            Hashtable resHT = new Hashtable();
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select ROW_NUMBER() OVER (ORDER BY a.OrderID DESC) AS RowNumber, a.OrderNo,(case when a.OrderModel=0 then b.Piece else -b.Piece end) as Piece,e.TypeName,c.Specs,c.Figure,c.LoadIndex,c.SpeedLevel,d.ClientName,d.Cellphone,d.Boss,d.Address,a.CreateDate from Tbl_Cargo_Order as a inner join Tbl_Cargo_OrderGoods as b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID inner join Tbl_Cargo_Product  as c on b.ProductID=c.ProductID inner join Tbl_Cargo_Client as d on a.ClientNum=d.ClientNum inner join Tbl_Cargo_ProductType as e on c.TypeID=e.TypeID  where a.OrderType=4 and a.WXOrderNo!=''";
            if (entity.HouseID != 0) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.TypeName))
            {
                strSQL += " and e.TypeID in (" + entity.TypeName + ")";
            }
            strSQL += "order by d.ClientName,c.TypeID,Specs desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            RowNumber = Convert.ToInt32(idrCount["RowNumber"]),
                            OrderPiece = Convert.ToInt32(idrCount["Piece"]),
                            ClientName = Convert.ToString(idrCount["ClientName"]),
                            Cellphone = Convert.ToString(idrCount["Cellphone"]),
                            Name = Convert.ToString(idrCount["Boss"]),
                            Address = Convert.ToString(idrCount["Address"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            Figure = Convert.ToString(idrCount["Figure"]),
                            LoadIndex = Convert.ToString(idrCount["LoadIndex"]),
                            SpeedLevel = Convert.ToString(idrCount["SpeedLevel"]),
                            CreateDate = Convert.ToDateTime(idrCount["CreateDate"]),
                        });
                    }
                }
            }
            resHT["AllRows"] = result;
            result = result.Where(c => c.RowNumber > (pageSize * (pageIndex - 1)) && c.RowNumber < pageSize * pageIndex + 1).ToList();
            resHT["rows"] = result;

            string strCount = "select Count(1) as TotalCount from Tbl_Cargo_Order as a inner join Tbl_Cargo_OrderGoods as b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID inner join Tbl_Cargo_Product  as c on b.ProductID=c.ProductID inner join Tbl_Cargo_Client as d on a.ClientNum=d.ClientNum inner join Tbl_Cargo_ProductType as e on c.TypeID=e.TypeID  where a.OrderType=4 and a.WXOrderNo!=''";
            if (entity.HouseID != 0) { strCount += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strCount += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strCount += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.TypeName))
            {
                strCount += " and e.TypeID in (" + entity.TypeName + ")";
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
            {
                using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                {
                    if (idrCount.Rows.Count > 0)
                    {
                        resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                    }
                }
            }
            return resHT;
        }
        /// <summary>
        /// 系统SKU数据统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryHCYC_BrandSKUData(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = " select a.TypeName, ISNULL(a.SKUTotalNum,0) as SKUTotalNum, ISNULL(b.SKUTotalNum,0) as InCargoSKUNum,ISNULL(c.SaledSKUNum,0) as SaledSKUNum,ISNULL(d.TotakStockNum,0) as TotakStockNum from ( select * from ( select a.TypeName,COUNT(a.ProductCode) over (partition by a.TypeName) as SKUTotalNum,ROW_NUMBER() over (partition by a.TypeName order by a.ProductCode) as RN from  ( select distinct b.ProductCode,a.TypeID,c.TypeName from Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID ";
            if (entity.HouseID != 0) { strSQL += " and b.HouseID =" + entity.HouseID; }
            strSQL += " inner join Tbl_Cargo_ProductType as c on b.TypeID=c.TypeID  where  SpecsType<>5 ) as a ) as a where a.RN=1  ) as a left join (  select * from ( select a.TypeName,COUNT(a.ProductCode) over (partition by a.TypeName) as SKUTotalNum,ROW_NUMBER() over (partition by a.TypeName order by a.ProductCode) as RN from  ( select distinct b.ProductCode,a.TypeID,c.TypeName from Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID ";
            if (entity.HouseID != 0) { strSQL += " and b.HouseID =" + entity.HouseID; }
            strSQL += "inner join Tbl_Cargo_ProductType as c on b.TypeID=c.TypeID  and a.Piece>0  and SpecsType<>5) as a ) as a where a.RN=1 ) as  b on a.TypeName=b.TypeName ";
            strSQL += "left join (select * from (select a.TypeName,sum(a.Piece) over (partition by a.TypeName) as TotakStockNum,ROW_NUMBER() over (partition by a.TypeName order by a.ProductCode)   as RN from (select  b.ProductCode,a.TypeID,c.TypeName,a.Piece,a.ContainerID from Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID ";
            if (entity.HouseID != 0) { strSQL += " and b.HouseID =" + entity.HouseID; }
            strSQL += " inner join Tbl_Cargo_ProductType as c on b.TypeID=c.TypeID  and a.Piece>0  and SpecsType<>5)as a ) as a where a.RN=1) as d on a.TypeName=d.TypeName";
            strSQL += " left join (select d.TypeName,COUNT(distinct case when OrderModel=0 then c.ProductCode end) as SaledSKUNum From Tbl_Cargo_Order as a inner join Tbl_Cargo_OrderGoods as b on a.OrderNo=b.OrderNo and a.HouseID=b.HouseID inner join Tbl_Cargo_Product as c on b.ProductID=c.ProductID and a.HouseID=c.HouseID inner join Tbl_Cargo_ProductType as d on c.TypeID=d.TypeID  ";
            if (!string.IsNullOrEmpty(entity.OrderType))
            {
                strSQL += " and a.OrderType='" + entity.OrderType + "'";
            }
            if (entity.HouseID != 0) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += "where SpecsType<>5 group by d.TypeName ) as c on a.TypeName=c.TypeName  order by a.SKUTotalNum desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        var SaledSKUNum = Convert.ToDouble(idrCount["SaledSKUNum"]);
                        var SKUTotalNum = Convert.ToDouble(idrCount["SKUTotalNum"]);
                        double SaledRatio = 0;
                        if (SaledSKUNum > 0)
                        {
                            SaledRatio = Math.Round(SaledSKUNum / SKUTotalNum * 100, 2);
                        }
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            SKUTotalNum = Convert.ToInt32(idrCount["SKUTotalNum"]),
                            InCargoSKUNum = Convert.ToInt32(idrCount["InCargoSKUNum"]),
                            SaledSKUNum = Convert.ToInt32(idrCount["SaledSKUNum"]),
                            SaledRatio = SaledRatio + "%",
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            SKUStockNum = Convert.ToInt32(idrCount["TotakStockNum"]),
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 客户关键字搜索统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryHCYC_KeyWordNum(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select a.KeyWord,a.TypeName,a.OPDATE,a.SearchResult,b.CompanyName,b.Name,b.Cellphone from Tbl_Cargo_Behavior as a inner join Tbl_WX_Client as b on a.wxOpenID=b.wxOpenID  where (1=1) ";
            if (entity.HouseID != 0) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.OPDATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.OPDATE<='" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.TyreType))
            {
                strSQL += " and a.BehaType='" + entity.TyreType + "'";
            }
            strSQL += " order by a.OPDATE desc ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            Specs = Convert.ToString(idrCount["KeyWord"]),//关键字
                            Figure = Convert.ToString(idrCount["SearchResult"]),//搜索结果
                            CompanyName = Convert.ToString(idrCount["CompanyName"]),
                            Name = Convert.ToString(idrCount["Name"]),
                            Cellphone = Convert.ToString(idrCount["Cellphone"]),
                            AccessDate = Convert.ToDateTime(idrCount["OPDATE"]),
                        });
                    }
                }
            }
            return result;

        }
        /// <summary>
        /// 客户关键字搜索统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryHCYC_KeyWordNumV2(CargoDLTDataStatisEntity entity, int pageIndex, int pageSize)
        {
            Hashtable resHT = new Hashtable();
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select ROW_NUMBER() OVER (ORDER BY a.BID DESC) AS RowNumber, a.KeyWord,a.TypeName,a.OPDATE,a.SearchResult,b.CompanyName,b.Name,b.Cellphone from Tbl_Cargo_Behavior as a inner join Tbl_WX_Client as b on a.wxOpenID=b.wxOpenID  where (1=1) ";
            if (entity.HouseID != 0) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.OPDATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.OPDATE<='" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.TyreType))
            {
                strSQL += " and a.BehaType='" + entity.TyreType + "'";
            }
            strSQL += " order by a.OPDATE desc ";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            Specs = Convert.ToString(idrCount["KeyWord"]),//关键字
                            Figure = Convert.ToString(idrCount["SearchResult"]),//搜索结果
                            CompanyName = Convert.ToString(idrCount["CompanyName"]),
                            Name = Convert.ToString(idrCount["Name"]),
                            Cellphone = Convert.ToString(idrCount["Cellphone"]),
                            AccessDate = Convert.ToDateTime(idrCount["OPDATE"]),
                            RowNumber = Convert.ToInt32(idrCount["RowNumber"]),
                        });
                    }
                }
            }
            resHT["AllRows"] = result;
            result = result.Where(c => c.RowNumber > (pageSize * (pageIndex - 1)) && c.RowNumber < pageSize * pageIndex + 1).ToList();
            resHT["rows"] = result;

            string strCount = "select Count(1) as TotalCount from Tbl_Cargo_Behavior as a inner join Tbl_WX_Client as b on a.wxOpenID=b.wxOpenID  where (1=1) ";
            if (entity.HouseID != 0) { strCount += " and a.HouseID =" + entity.HouseID; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strCount += " and a.OPDATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strCount += " and a.OPDATE<='" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.TyreType))
            {
                strCount += " and a.BehaType='" + entity.TyreType + "'";
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
            {
                using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                {
                    if (idrCount.Rows.Count > 0)
                    {
                        resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                    }
                }
            }
            return resHT;

        }
        /// <summary>
        /// 按客户查询统计
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryClientStatis(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select b.Product as Area,b.Province,b.City,b.ClientName,b.ClientNum,b.ShopCode,SUM(c.Piece) as SumPiece,SUM(c.Piece*c.ActSalePrice) as TotalCharge From Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum and a.HouseID=b.HouseID inner join Tbl_Cargo_OrderGoods as c on a.OrderNo=c.OrderNo and a.HouseID=c.HouseID where (1=1) ";
            if (string.IsNullOrEmpty(entity.ThrowGood)) { strSQL += " and a.ThrowGood!='2' "; }
            if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and a.OrderModel = '" + entity.OrderModel + "'"; }
            //所属仓库ID
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            //入库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!string.IsNullOrEmpty(entity.Area)) { strSQL += " and b.Product = '" + entity.Area + "'"; }
            if (!string.IsNullOrEmpty(entity.Province)) { strSQL += " and b.Province = '" + entity.Province + "'"; }
            if (!string.IsNullOrEmpty(entity.City)) { strSQL += " and b.City = '" + entity.City + "'"; }
            if (!string.IsNullOrEmpty(entity.ShopCode)) { strSQL += " and b.ShopCode = '" + entity.ShopCode + "'"; }
            if (!string.IsNullOrEmpty(entity.ClientName)) { strSQL += " and b.ClientName like '%" + entity.ClientName + "%'"; }
            strSQL += " group by b.ClientName,b.ShopCode,b.ClientNum,b.Product,b.Province,b.City order by SUM(c.Piece) desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            Area = Convert.ToString(idrCount["Area"]),
                            Province = Convert.ToString(idrCount["Province"]),
                            City = Convert.ToString(idrCount["City"]),
                            ClientName = Convert.ToString(idrCount["ClientName"]),
                            ClientNum = Convert.ToInt32(idrCount["ClientNum"]),
                            ShopCode = Convert.ToString(idrCount["ShopCode"]),
                            OrderPiece = Convert.ToInt32(idrCount["SumPiece"]),
                            OrderCharge = Convert.ToDecimal(idrCount["TotalCharge"])
                        });
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询某一客户的按品牌统计数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryClientStatisByBrand(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select e.TypeName,SUM(c.Piece) as SumPiece,Specs,Figure  From Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum and a.HouseID=b.HouseID inner join Tbl_Cargo_OrderGoods as c on a.OrderNo=c.OrderNo and a.HouseID=c.HouseID inner join Tbl_Cargo_Product as d on c.ProductID=d.ProductID and c.HouseID=d.HouseID inner join Tbl_Cargo_ProductType as e on d.TypeID=e.TypeID where (1=1) ";
            if (string.IsNullOrEmpty(entity.ThrowGood)) { strSQL += " and a.ThrowGood!='2' "; }
            if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and a.OrderModel = '" + entity.OrderModel + "'"; }
            //所属仓库ID
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            //入库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!entity.ClientNum.Equals(0)) { strSQL += " and a.PayClientNum=" + entity.ClientNum; }
            strSQL += " group by e.TypeName,Specs,Figure order by SUM(c.Piece) desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            OrderPiece = Convert.ToInt32(idrCount["SumPiece"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            Figure = Convert.ToString(idrCount["Figure"]),
                        });
                    }
                }
            }
            //List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            //string strSQL = "select SUBSTRING(d.Specs,1,3) as Specs,SUM(c.Piece) as SumPiece From Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum and a.HouseID=b.HouseID inner join Tbl_Cargo_OrderGoods as c on a.OrderNo=c.OrderNo and a.HouseID=c.HouseID inner join Tbl_Cargo_Product as d on c.ProductID=d.ProductID and c.HouseID=d.HouseID inner join Tbl_Cargo_ProductType as e on d.TypeID=e.TypeID where (1=1) ";
            //if (string.IsNullOrEmpty(entity.ThrowGood)) { strSQL += " and a.ThrowGood!='2' "; }
            //if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and a.OrderModel = '" + entity.OrderModel + "'"; }
            ////所属仓库ID
            //if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            ////入库时间
            //if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            //{
            //    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            //}
            //if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            //{
            //    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            //}
            //if (!entity.ClientNum.Equals(0)) { strSQL += " and a.PayClientNum=" + entity.ClientNum; }
            //strSQL += " group by SUBSTRING(d.Specs,1,3) order by SUM(c.Piece) desc";
            //using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            //{
            //    using (DataTable dt = conn.ExecuteDataTable(cmd))
            //    {
            //        foreach (DataRow idrCount in dt.Rows)
            //        {
            //            result.Add(new CargoDLTDataStatisEntity
            //            {
            //                Specs = Convert.ToString(idrCount["Specs"]),
            //                OrderPiece = Convert.ToInt32(idrCount["SumPiece"])
            //            });
            //        }
            //    }
            //}
            return result;
        }
        /// <summary>
        /// 查询某一客户的按尺寸统计数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryClientStatisByHubDiameter(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "select SUBSTRING(d.Specs,LEN(d.Specs)-1,2) as Specs,SUM(c.Piece) as SumPiece From Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum and a.HouseID=b.HouseID inner join Tbl_Cargo_OrderGoods as c on a.OrderNo=c.OrderNo and a.HouseID=c.HouseID inner join Tbl_Cargo_Product as d on c.ProductID=d.ProductID and c.HouseID=d.HouseID inner join Tbl_Cargo_ProductType as e on d.TypeID=e.TypeID where (1=1) ";
            if (string.IsNullOrEmpty(entity.ThrowGood)) { strSQL += " and a.ThrowGood!='2' "; }
            if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and a.OrderModel = '" + entity.OrderModel + "'"; }
            //所属仓库ID
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            //入库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!entity.ClientNum.Equals(0)) { strSQL += " and a.PayClientNum=" + entity.ClientNum; }
            strSQL += " group by SUBSTRING(d.Specs,LEN(d.Specs)-1,2) order by SUM(c.Piece) desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            Specs = Convert.ToString(idrCount["Specs"]),
                            OrderPiece = Convert.ToInt32(idrCount["SumPiece"])
                        });
                    }
                }
            }
            return result;
        }

        /// <summary>
        /// 查询某一客户的按车辆类型统计数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> QueryClientStatisCartype(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();
            string strSQL = "SELECT *FROM (select CarModel,SUM(c.Piece)Piece From Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum and a.HouseID=b.HouseID inner join Tbl_Cargo_OrderGoods as c on a.OrderNo=c.OrderNo and a.HouseID=c.HouseID inner join Tbl_Cargo_Product as d on c.ProductID=d.ProductID and c.HouseID=d.HouseID inner join Tbl_Cargo_ProductType as e on d.TypeID=e.TypeID LEFT JOIN Tbl_Cargo_ProductSpec I ON I.GoodsCode=D.GoodsCode where (1=1) ";
            if (string.IsNullOrEmpty(entity.ThrowGood)) { strSQL += " and a.ThrowGood!='2' "; }
            if (!string.IsNullOrEmpty(entity.OrderModel)) { strSQL += " and a.OrderModel = '" + entity.OrderModel + "'"; }
            //所属仓库ID
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            //入库时间
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            if (!entity.ClientNum.Equals(0)) { strSQL += " and a.PayClientNum=" + entity.ClientNum; }
            strSQL += " group by CarModel) S WHERE  CarModel IS NOT NULL AND ISNULL(CarModel,'')!='' order by Piece  desc";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            CarModel = Convert.ToString(idrCount["CarModel"]),
                            OrderPiece = Convert.ToInt32(idrCount["Piece"])
                        });
                    }
                }
            }
            return result;
        }
        #endregion

        #region 统计订单出库时长
        /// <summary>
        /// 统计订单出库时长
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderOutTimeEntity> QueryOrderOutTime(CargoOrderOutTimeEntity entity)
        {
            List<CargoOrderOutTimeEntity> result = new List<CargoOrderOutTimeEntity>();
            string sD = entity.StartDate.ToString("yyyyMM");
            string eD = entity.EndDate.ToString("yyyyMM");
            DateTime sDT = entity.StartDate;
            DateTime eDT = entity.EndDate;
            int Month = (eDT.Year - sDT.Year) * 12 + (eDT.Month - sDT.Month);
            try
            {
                string strSQL = @"select * from ";
                for (int i = 1; i <= Month + 1; i++)
                {
                    string data = "";
                    if (sDT.Month == eDT.Month)
                    {
                        data += eDT.ToString("yyyyMM");
                    }
                    else
                    {
                        data += sDT.ToString("yyyyMM");
                        sDT = sDT.AddMonths(1);
                    }
                    strSQL += "(SELECT d.HouseID as HouseID" + i + ",h.Name as HouseName" + i + ", OrderCount as OrderCount" + i + ", PieceCount as PieceCount" + i + ", StartInterval as StartInterval" + i + ", (StartInterval/OrderCount)as AverageStartInterval" + i + ", (EndInterval-StartInterval)as OutInterval" + i + ", Convert(decimal(18,2),(((EndInterval-StartInterval)*1.0)/OrderCount))as AverageEndInterval" + i + " FROM (SELECT DISTINCT OrderCount, HouseID, SUM(Piece)OVER (partition by HouseID) AS PieceCount, SUM(StartOutIntervalTime)OVER (partition by HouseID) AS StartInterval, SUM(EndOutIntervalTime)OVER (partition by HouseID) AS EndInterval from (SELECT COUNT(b.HouseID)over(partition by b.HouseID)as OrderCount, b.HouseID, c.Name AS HouseName, b.OrderNo, b.Piece, b.AwbStatus, b.CreateDate, a.StartOutTime, datediff( minute , b.CreateDate, a.StartOutTime) AS StartOutIntervalTime, a.EndOutTime, datediff( minute , b.CreateDate, a.EndOutTime ) AS EndOutIntervalTime FROM (SELECT min(OutCargoTime)as StartOutTime, max(OutCargoTime)as EndOutTime, OrderNo FROM Tbl_Cargo_ProductTag GROUP BY OrderNo) AS a, Tbl_Cargo_order AS b INNER JOIN Tbl_Cargo_House c ON b.HouseID=c.HouseID WHERE a.OrderNo=b.OrderNo AND SUBSTRING( Convert(varchar(100),b.CreateDate,112),1,6)='" + data + "' " + (entity.HouseID.Equals(0) ? "" : " and b.HouseID=" + entity.HouseID) + ")c )d inner join Tbl_Cargo_House h on d.HouseID=h.HouseID where h.DelFlag=0 and h.BelongHouse=0 )Time" + i;
                    if (i > 1) { strSQL += " on Time" + (i - 1) + ".HouseID" + (i - 1) + "=Time" + i + ".HouseID" + i + ""; }
                    if (i != Month + 1) { strSQL += " full JOIN "; }
                }


                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            CargoOrderOutTimeEntity stock = new CargoOrderOutTimeEntity();
                            //stock.HouseID = Convert.ToInt32(idr["HouseID1"]);
                            string HouseName = "";
                            if (!string.IsNullOrEmpty(Convert.ToString(idr["HouseName1"])))
                            {
                                HouseName = Convert.ToString(idr["HouseName1"]);
                            }
                            else if (!string.IsNullOrEmpty(Convert.ToString(idr["HouseName2"])))
                            {
                                HouseName = Convert.ToString(idr["HouseName2"]);
                            }
                            else if (!string.IsNullOrEmpty(Convert.ToString(idr["HouseName3"])))
                            {
                                HouseName = Convert.ToString(idr["HouseName3"]);
                            }
                            else if (!string.IsNullOrEmpty(Convert.ToString(idr["HouseName4"])))
                            {
                                HouseName = Convert.ToString(idr["HouseName4"]);
                            }
                            stock.HouseName = HouseName;
                            stock.StartDate = entity.StartDate;
                            stock.EndDate = entity.EndDate;
                            for (int i = 1; i <= Month + 1; i++)
                            {
                                #region
                                switch (i)
                                {
                                    case 1:
                                        stock.OrderCount1 = Convert.ToString(idr["OrderCount1"]);
                                        stock.PieceCount1 = Convert.ToString(idr["PieceCount1"]);
                                        stock.StartInterval1 = Convert.ToString(idr["StartInterval1"]);
                                        stock.AverageStartInterval1 = Convert.ToString(idr["AverageStartInterval1"]);
                                        stock.OutInterval1 = Convert.ToString(idr["OutInterval1"]);
                                        stock.AverageEndInterval1 = Convert.ToString(idr["AverageEndInterval1"]);
                                        break;
                                    case 2:
                                        stock.OrderCount2 = Convert.ToString(idr["OrderCount2"]);
                                        stock.PieceCount2 = Convert.ToString(idr["PieceCount2"]);
                                        stock.StartInterval2 = Convert.ToString(idr["StartInterval2"]);
                                        stock.AverageStartInterval2 = Convert.ToString(idr["AverageStartInterval2"]);
                                        stock.OutInterval2 = Convert.ToString(idr["OutInterval2"]);
                                        stock.AverageEndInterval2 = Convert.ToString(idr["AverageEndInterval2"]);
                                        break;
                                    case 3:
                                        stock.OrderCount3 = Convert.ToString(idr["OrderCount3"]);
                                        stock.PieceCount3 = Convert.ToString(idr["PieceCount3"]);
                                        stock.StartInterval3 = Convert.ToString(idr["StartInterval3"]);
                                        stock.AverageStartInterval3 = Convert.ToString(idr["AverageStartInterval3"]);
                                        stock.OutInterval3 = Convert.ToString(idr["OutInterval3"]);
                                        stock.AverageEndInterval3 = Convert.ToString(idr["AverageEndInterval3"]);
                                        break;
                                    case 4:
                                        stock.OrderCount4 = Convert.ToString(idr["OrderCount4"]);
                                        stock.PieceCount4 = Convert.ToString(idr["PieceCount4"]);
                                        stock.StartInterval4 = Convert.ToString(idr["StartInterval4"]);
                                        stock.AverageStartInterval4 = Convert.ToString(idr["AverageStartInterval4"]);
                                        stock.OutInterval4 = Convert.ToString(idr["OutInterval4"]);
                                        stock.AverageEndInterval4 = Convert.ToString(idr["AverageEndInterval4"]);
                                        break;
                                    default:
                                        break;
                                }
                                #endregion
                            }
                            result.Add(stock);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }


        public List<CargoOrderOutTimeEntity> QueryOrderDetailedTime(CargoOrderOutTimeEntity entity)
        {
            #region 不用的查询每个标签耗时
            //List<CargoOrderOutTimeEntity> result = new List<CargoOrderOutTimeEntity>();
            //try
            //{
            //    string strSQL = @"select a.TagCode,c.ContainerCode,OutCargoTime as StartOutTime,datediff( minute , b.CreateDate, a.OutCargoTime ) AS StartOutIntervalTime from Tbl_Cargo_ProductTag a inner join Tbl_Cargo_order b on a.OrderNo=b.OrderNo inner join Tbl_Cargo_Container c on a.ContainerID=c.ContainerID where 1=1";
            //    if (!string.IsNullOrEmpty(entity.OrderNo))
            //    {
            //        strSQL += " and  b.OrderNo='" + entity.OrderNo + "'";
            //    }
            //    strSQL += " order by a.OutCargoTime desc";
            //    using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            //    {
            //        using (DataTable dt = conn.ExecuteDataTable(command))
            //        {
            //            foreach (DataRow idr in dt.Rows)
            //            {
            //                #region 获取数据
            //                result.Add(new CargoOrderOutTimeEntity
            //                {
            //                    TagCode = Convert.ToString(idr["TagCode"]),
            //                    ContainerCode = Convert.ToString(idr["ContainerCode"]),
            //                    StartOutTime = Convert.ToDateTime(idr["StartOutTime"]),
            //                    StartOutIntervalTime = Convert.ToString(idr["StartOutIntervalTime"])
            //                });
            //                #endregion
            //            }
            //        }
            //    }
            //}
            //catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            //return result;
            #endregion

            List<CargoOrderOutTimeEntity> result = new List<CargoOrderOutTimeEntity>();
            try
            {
                #region 组装查询SQL语句
                string strSQL = @"select ROW_NUMBER() OVER (ORDER BY b.CreateDate DESC) AS RowNumber,b.HouseID,c.Name as HouseName,b.OrderNo,b.Piece,b.AwbStatus,b.CreateDate,a.StartOutTime,datediff( minute , b.CreateDate, a.StartOutTime ) as StartOutIntervalTime,a.EndOutTime,datediff( minute , b.CreateDate, a.EndOutTime ) as EndOutIntervalTime from (select min(OutCargoTime)as StartOutTime,max(OutCargoTime)as EndOutTime, OrderNo from Tbl_Cargo_ProductTag group by OrderNo) as a, Tbl_Cargo_order as b inner join Tbl_Cargo_House c on b.HouseID=c.HouseID where a.OrderNo=b.OrderNo";

                if (!entity.HouseID.Equals(0)) { strSQL += " and b.HouseID =" + entity.HouseID; }
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and b.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and b.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            result.Add(new CargoOrderOutTimeEntity
                            {
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                AwbStatus = Convert.ToString(idr["AwbStatus"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                StartOutTime = Convert.ToDateTime(idr["StartOutTime"]),
                                StartOutIntervalTime = Convert.ToString(idr["StartOutIntervalTime"]),
                                EndOutTime = Convert.ToDateTime(idr["EndOutTime"]),
                                EndOutIntervalTime = Convert.ToString(idr["EndOutIntervalTime"])
                            });
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;
        }

        /// <summary>
        /// 查询出库和签收时效
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoReportAgeingEntity> QueryReportAgeingList(CargoReportAgeingEntity entity)
        {
            List<CargoReportAgeingEntity> result = new List<CargoReportAgeingEntity>();
            #region 组装查询SQL语句
            string strSQL = @"select a.OrderNo,a.Piece,a.HAwbNo,a.LogisAwbNo,a.AcceptUnit,a.CreateAwb,a.CreateDate,a.OutCargoTime,a.SendCarTime,a.TakeOrderTime,a.AwbStatus,a.HouseID,a.OutHouseName,a.PayClientNum,a.PayClientName,a.LineID,a.LineName,a.ShopCode,b.Product,b.Province,b.City,a.OrderType,a.AbSignStatus,c.SignImage,c.Signer,c.SignTime From Tbl_Cargo_Order as a inner join Tbl_Cargo_Client as b on a.PayClientNum=b.ClientNum left join (select OrderID,OrderNo,Signer,SignTime,SignImage from Tbl_Cargo_OrderStatus where OrderStatus=5 ";
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and OP_DATE>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            strSQL += ") as c on a.OrderID=c.OrderID and a.OrderNo=c.OrderNo  Where (1=1) and a.OrderModel=0 ";
            if (!string.IsNullOrEmpty(entity.OrderType)) { strSQL += " and a.OrderType = '" + entity.OrderType + "'"; }
            if (!string.IsNullOrEmpty(entity.AbSignStatus)) { strSQL += " and a.AbSignStatus = '" + entity.AbSignStatus + "'"; }
            if (!entity.HouseID.Equals(0)) { strSQL += " and a.HouseID =" + entity.HouseID; }
            if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
            if (!string.IsNullOrEmpty(entity.Province)) { strSQL += " and b.Province = '" + entity.Province + "'"; }
            if (!string.IsNullOrEmpty(entity.City)) { strSQL += " and b.City = '" + entity.City + "'"; }
            if (!string.IsNullOrEmpty(entity.OutHouseName)) { strSQL += " and a.OutHouseName = '" + entity.OutHouseName + "'"; }
            if (!entity.LineID.Equals(0)) { strSQL += " and a.LineID=" + entity.LineID; }
            if (!string.IsNullOrEmpty(entity.ShopCode)) { strSQL += " and a.ShopCode ='" + entity.ShopCode + "'"; }
            if (!string.IsNullOrEmpty(entity.AwbStatus))
            {
                if (entity.AwbStatus.Equals("5"))
                {
                    strSQL += " and a.AwbStatus =5";
                }
                else
                {
                    strSQL += " and a.AwbStatus !=5";
                }
            }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            #endregion
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dt.Rows)
                    {
                        result.Add(new CargoReportAgeingEntity
                        {
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            OrderNo = Convert.ToString(idr["OrderNo"]),
                            OutHouseName = Convert.ToString(idr["OutHouseName"]),
                            Piece = Convert.ToInt32(idr["Piece"]),
                            AwbStatus = Convert.ToString(idr["AwbStatus"]),
                            HAwbNo = Convert.ToString(idr["HAwbNo"]),
                            LogisAwbNo = Convert.ToString(idr["LogisAwbNo"]),
                            AcceptUnit = Convert.ToString(idr["AcceptUnit"]),
                            CreateAwb = Convert.ToString(idr["CreateAwb"]),
                            CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                            PayClientName = Convert.ToString(idr["PayClientName"]),
                            LineName = Convert.ToString(idr["LineName"]),
                            ShopCode = Convert.ToString(idr["ShopCode"]),
                            Product = Convert.ToString(idr["Product"]),
                            Province = Convert.ToString(idr["Province"]),
                            City = Convert.ToString(idr["City"]),
                            Signer = Convert.ToString(idr["Signer"]),
                            SignImage = Convert.ToString(idr["SignImage"]),
                            AbSignStatus = Convert.ToString(idr["AbSignStatus"]),
                            OutCargoTime = string.IsNullOrEmpty(Convert.ToString(idr["OutCargoTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["OutCargoTime"]),
                            SignTime = string.IsNullOrEmpty(Convert.ToString(idr["SignTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["SignTime"]),
                            TakeOrderTime = string.IsNullOrEmpty(Convert.ToString(idr["TakeOrderTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["TakeOrderTime"]),
                            SendCarTime = string.IsNullOrEmpty(Convert.ToString(idr["SendCarTime"])) ? Convert.ToDateTime("0001-01-01") : Convert.ToDateTime(idr["SendCarTime"]),
                            OutCargoAgeing = string.IsNullOrEmpty(Convert.ToString(idr["OutCargoTime"])) ? "0" : (Convert.ToDateTime(idr["OutCargoTime"]) - Convert.ToDateTime(idr["CreateDate"])).TotalHours.ToString("F2"),
                            FromCreateToSignAgeing = string.IsNullOrEmpty(Convert.ToString(idr["SignTime"])) ? "0" : (Convert.ToDateTime(idr["SignTime"]) - Convert.ToDateTime(idr["CreateDate"])).TotalHours.ToString("F2"),
                            FromOutCargoToSignAgeing = string.IsNullOrEmpty(Convert.ToString(idr["SignTime"])) || string.IsNullOrEmpty(Convert.ToString(idr["OutCargoTime"])) ? "0" : (Convert.ToDateTime(idr["SignTime"]) - Convert.ToDateTime(idr["OutCargoTime"])).TotalHours.ToString("F2")
                        });
                    }
                }
            }

            return result;
        }

        #endregion
        #region 每天仓库库存统计
        /// <summary>
        /// 保存仓库每天的库存数据
        /// </summary>
        public void SaveDayCargoStock(List<CargoDayStockEntity> entity)
        {
            foreach (var it in entity)
            {
                it.EnSafe();
                string strSQL = "Insert Into Tbl_Cargo_DayCargoStock(StatisDate,HouseID,Name,TotalSum,TotalValue,MaPaiSum,MaPaiTotalValue,YKHMSum,YKHMTotalValue,HanTaiSum,HanTaiTotalValue,GuBoSum,GuBoTotalValue,MQLSum,MQLTotalValue,WKTSum,WKTTotalValue,QiTaSum,QiTaTotalValue,BigTyreSum,MidTyreSum,SmallTyreSum) Values (@StatisDate,@HouseID,@Name,@TotalSum,@TotalValue,@MaPaiSum,@MaPaiTotalValue,@YKHMSum,@YKHMTotalValue,@HanTaiSum,@HanTaiTotalValue,@GuBoSum,@GuBoTotalValue,@MQLSum,@MQLTotalValue,@WKTSum,@WKTTotalValue,@QiTaSum,@QiTaTotalValue,@BigTyreSum,@MidTyreSum,@SmallTyreSum)";
                using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
                {
                    conn.AddInParameter(cmd, "@StatisDate", DbType.Date, it.StatisDate);
                    conn.AddInParameter(cmd, "@HouseID", DbType.Int32, it.HouseID);
                    conn.AddInParameter(cmd, "@Name", DbType.String, it.Name);
                    conn.AddInParameter(cmd, "@TotalSum", DbType.Int32, it.TotalSum);
                    conn.AddInParameter(cmd, "@TotalValue", DbType.Double, it.TotalValue);
                    conn.AddInParameter(cmd, "@MaPaiSum", DbType.Int32, it.MaPaiSum);
                    conn.AddInParameter(cmd, "@MaPaiTotalValue", DbType.Double, it.MaPaiTotalValue);
                    conn.AddInParameter(cmd, "@YKHMSum", DbType.Int32, it.YKHMSum);
                    conn.AddInParameter(cmd, "@YKHMTotalValue", DbType.Double, it.YKHMTotalValue);
                    conn.AddInParameter(cmd, "@HanTaiSum", DbType.Int32, it.HanTaiSum);
                    conn.AddInParameter(cmd, "@HanTaiTotalValue", DbType.Double, it.HanTaiTotalValue);
                    conn.AddInParameter(cmd, "@GuBoSum", DbType.Int32, it.GuBoSum);
                    conn.AddInParameter(cmd, "@GuBoTotalValue", DbType.Double, it.GuBoTotalValue);
                    conn.AddInParameter(cmd, "@MQLSum", DbType.Int32, it.MQLSum);
                    conn.AddInParameter(cmd, "@MQLTotalValue", DbType.Double, it.MQLTotalValue);
                    conn.AddInParameter(cmd, "@WKTSum", DbType.Int32, it.WKTSum);
                    conn.AddInParameter(cmd, "@WKTTotalValue", DbType.Double, it.WKTTotalValue);
                    conn.AddInParameter(cmd, "@QiTaSum", DbType.Int32, it.QiTaSum);
                    conn.AddInParameter(cmd, "@QiTaTotalValue", DbType.Double, it.QiTaTotalValue);
                    conn.AddInParameter(cmd, "@BigTyreSum", DbType.Int32, it.BigTyreSum);
                    conn.AddInParameter(cmd, "@MidTyreSum", DbType.Int32, it.MidTyreSum);
                    conn.AddInParameter(cmd, "@SmallTyreSum", DbType.Int32, it.SmallTyreSum);
                    conn.ExecuteNonQuery(cmd);
                }
            }
        }
        /// <summary>
        /// 查询当前仓库库存 
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoDayStockEntity QueryDayCargoStockList(CargoDayStockEntity entity)
        {
            CargoDayStockEntity result = new CargoDayStockEntity();
            string strSQL = string.Empty;
            if (entity.HouseID.Equals(45))
            {
                //广东仓库特殊处理,因为东莞和深圳在一个区域大区下
                //strSQL = "select a.TypeID,c.TypeName,ISNULL(SUM(a.Piece),0) as Piece from Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID inner join Tbl_Cargo_Container as d on a.ContainerID=d.ContainerID inner join Tbl_Cargo_Area as e on d.AreaID=e.AreaID inner join Tbl_Cargo_Area as f on e.ParentID=f.AreaID where b.HouseID=" + entity.HouseID + " and c.ParentID=1 and a.Piece>0 and f.ParentID=" + entity.ParentID + " group by a.TypeID,c.TypeName";
                strSQL = "select a.TypeID,c.TypeName,ISNULL(SUM(a.Piece),0) as Piece, SUM(a.TotalValue) AS TotalValue from (select (a1.Piece*b1.UnitPrice) as TotalValue,b1.UnitPrice,a1.ContainerID,a1.TypeID,a1.Piece,a1.ProductID from Tbl_Cargo_ContainerGoods a1 inner join Tbl_Cargo_Product b1 on a1.ProductID=b1.ProductID) as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID inner join Tbl_Cargo_Container as d on a.ContainerID=d.ContainerID inner join Tbl_Cargo_Area as e on d.AreaID=e.AreaID inner join Tbl_Cargo_Area as f on e.ParentID=f.AreaID where b.HouseID=" + entity.HouseID + " and c.ParentID=1 and a.Piece>0 and f.ParentID=" + entity.ParentID + " group by a.TypeID,c.TypeName";
            }
            else if (entity.HouseID.Equals(44))
            {
                //揭阳仓库特殊处理,因为揭阳和梅州在一个区域大区下
                strSQL = "select a.TypeID,c.TypeName,ISNULL(SUM(a.Piece),0) as Piece, SUM(a.TotalValue) AS TotalValue from (select (a1.Piece*b1.UnitPrice) as TotalValue,b1.UnitPrice,a1.ContainerID,a1.TypeID,a1.Piece,a1.ProductID from Tbl_Cargo_ContainerGoods a1 inner join Tbl_Cargo_Product b1 on a1.ProductID=b1.ProductID) as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID inner join Tbl_Cargo_Container as d on a.ContainerID=d.ContainerID inner join Tbl_Cargo_Area as e on d.AreaID=e.AreaID inner join Tbl_Cargo_Area as f on e.ParentID=f.AreaID where b.HouseID=" + entity.HouseID + " and c.ParentID=1 and a.Piece>0 and f.ParentID=" + entity.ParentID + " group by a.TypeID,c.TypeName";
            }
            else if (entity.HouseID.Equals(84))
            {
                //华南枢纽仓特殊处理，新陆城配仓和汕头科矿仓
                strSQL = "select a.TypeID,c.TypeName,ISNULL(SUM(a.Piece),0) as Piece, SUM(a.TotalValue) AS TotalValue from (select (a1.Piece*b1.UnitPrice) as TotalValue,b1.UnitPrice,a1.ContainerID,a1.TypeID,a1.Piece,a1.ProductID from Tbl_Cargo_ContainerGoods a1 inner join Tbl_Cargo_Product b1 on a1.ProductID=b1.ProductID) as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID inner join Tbl_Cargo_Container as d on a.ContainerID=d.ContainerID inner join Tbl_Cargo_Area as e on d.AreaID=e.AreaID inner join Tbl_Cargo_Area as f on e.ParentID=f.AreaID where b.HouseID=" + entity.HouseID + " and c.ParentID=1 and a.Piece>0 and f.ParentID=" + entity.ParentID + " group by a.TypeID,c.TypeName";
            }
            else if (entity.HouseID.Equals(9))
            {
                //广州仓库特殊处理，因为和好来运的轮胎在一起，要按产品名称进行区分
                //strSQL = "select a.TypeID,c.TypeName,SUM(a.Piece) as Piece from Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID where b.HouseID=" + entity.HouseID + " and c.ParentID=1 and a.Piece>0 and b.ProductName like '%迪乐泰%' group by a.TypeID,c.TypeName";
                strSQL = "select a.TypeID,c.TypeName,SUM(a.Piece) as Piece,SUM(a.TotalValue) AS TotalValue from (select (a1.Piece*b1.UnitPrice) as TotalValue,b1.UnitPrice,a1.TypeID,a1.Piece,a1.ProductID from Tbl_Cargo_ContainerGoods a1 inner join Tbl_Cargo_Product b1 on a1.ProductID=b1.ProductID) as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID where b.HouseID=" + entity.HouseID + " and c.ParentID=1 and a.Piece>0 and b.ProductName like '%迪乐泰%' group by a.TypeID,c.TypeName";
            }
            else
            {
                //strSQL = "select a.TypeID,c.TypeName,ISNULL(SUM(a.Piece),0) as Piece from Tbl_Cargo_ContainerGoods as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID where b.HouseID=" + entity.HouseID + " and c.ParentID=1 and a.Piece>0 group by a.TypeID,c.TypeName";
                strSQL = "select a.TypeID,c.TypeName,ISNULL(SUM(a.Piece),0) as Piece, SUM(a.TotalValue) AS TotalValue from (select (a1.Piece*b1.UnitPrice) as TotalValue,b1.UnitPrice,a1.TypeID,a1.Piece,a1.ProductID from Tbl_Cargo_ContainerGoods a1 inner join Tbl_Cargo_Product b1 on a1.ProductID=b1.ProductID) as a inner join Tbl_Cargo_Product as b on a.ProductID=b.ProductID inner join Tbl_Cargo_ProductType as c on a.TypeID=c.TypeID where b.HouseID=" + entity.HouseID + " and c.ParentID=1 and a.Piece>0 group by a.TypeID,c.TypeName";
            }
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.TotalSum += Convert.ToInt32(idrCount["Piece"]);
                        result.TotalValue += Convert.ToDouble(idrCount["TotalValue"]);
                        switch (Convert.ToInt32(idrCount["TypeID"]))
                        {
                            case 106:
                                result.BigTyreSum += Convert.ToInt32(idrCount["Piece"]);
                                break;
                            case 278:
                                result.BigTyreSum += Convert.ToInt32(idrCount["Piece"]);
                                break;
                            case 279:
                                result.BigTyreSum += Convert.ToInt32(idrCount["Piece"]);
                                break;
                            case 280:
                                result.BigTyreSum += Convert.ToInt32(idrCount["Piece"]);
                                break;
                            case 290:
                                result.BigTyreSum += Convert.ToInt32(idrCount["Piece"]);
                                break;
                            case 291:
                                result.BigTyreSum += Convert.ToInt32(idrCount["Piece"]);
                                break;
                            case 295:
                                result.BigTyreSum += Convert.ToInt32(idrCount["Piece"]);
                                break;
                            case 296:
                                result.BigTyreSum += Convert.ToInt32(idrCount["Piece"]);
                                break;
                            case 9:
                                result.YKHMSum = Convert.ToInt32(idrCount["Piece"]);
                                result.YKHMTotalValue = Convert.ToDouble(idrCount["TotalValue"]);
                                break;
                            case 34:
                                result.MaPaiSum = Convert.ToInt32(idrCount["Piece"]);
                                result.MaPaiTotalValue = Convert.ToDouble(idrCount["TotalValue"]);
                                break;
                            case 31:
                                result.HanTaiSum = Convert.ToInt32(idrCount["Piece"]);
                                result.HanTaiTotalValue = Convert.ToDouble(idrCount["TotalValue"]);
                                break;
                            case 66:
                                result.GuBoSum = Convert.ToInt32(idrCount["Piece"]);
                                result.GuBoTotalValue = Convert.ToDouble(idrCount["TotalValue"]);
                                break;
                            case 180:
                                result.WKTSum = Convert.ToInt32(idrCount["Piece"]);
                                result.WKTTotalValue = Convert.ToDouble(idrCount["TotalValue"]);
                                break;
                            case 36:
                                result.MQLSum = Convert.ToInt32(idrCount["Piece"]);
                                result.MQLTotalValue = Convert.ToDouble(idrCount["TotalValue"]);
                                break;
                            default: break;
                        }
                    }
                }
            }
            result.QiTaSum = result.TotalSum - result.YKHMSum - result.MaPaiSum - result.HanTaiSum - result.GuBoSum - result.WKTSum - result.MQLSum - result.BigTyreSum;
            result.QiTaTotalValue = result.TotalValue - result.YKHMTotalValue - result.MaPaiTotalValue - result.HanTaiTotalValue - result.GuBoTotalValue - result.WKTTotalValue - result.MQLTotalValue;
            return result;
        }
        /// <summary>
        /// 查询每日库存数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryDayStockData(int pIndex, int pNum, CargoDayStockEntity entity)
        {
            List<CargoDayStockEntity> result = new List<CargoDayStockEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                string strSQL = @" SELECT TOP " + pNum + " * from (select ROW_NUMBER() OVER (ORDER BY SUBSTRING( Convert(varchar(100),StatisDate,112),1,6) desc,HouseID asc) AS RowNumber,SUBSTRING( Convert(varchar(100),StatisDate,112),1,6) as StatisDis,Name,HouseID,SUM(TotalSum) as TotalSum,COUNT(*) as TotalDay,cast(cast(sum(TotalSum) as decimal(18,2))/CAST(COUNT(*) as decimal(18,2)) as decimal(18,2))*3 as CurRentMoney from Tbl_Cargo_DayCargoStock WHERE (1=1)";
                if (!entity.HouseID.Equals(0)) { strSQL += " and HouseID = " + entity.HouseID; }
                if (!string.IsNullOrEmpty(entity.Name)) { strSQL += " and Name = '" + entity.Name + "'"; }
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and StatisDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and StatisDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += "group by SUBSTRING( Convert(varchar(100),StatisDate,112),1,6),Name,HouseID";
                strSQL += " ) as A where RowNumber > (" + pNum + "* (" + pIndex + "-1))";
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dd = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dd.Rows)
                        {
                            if (Convert.ToInt32(idr["HouseID"]).Equals(59))
                            {
                                DateTime dst = DateTime.ParseExact(Convert.ToString(idr["StatisDis"]) + "01", "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture);
                                CargoDayStockEntity ds = QueryDayStockSum(new CargoDayStockEntity { Name = Convert.ToString(idr["Name"]), StartDate = dst, EndDate = dst.AddMonths(1) });
                                //海口城配仓库特殊处理
                                result.Add(new CargoDayStockEntity
                                {
                                    StatisDis = Convert.ToString(idr["StatisDis"]),
                                    Name = Convert.ToString(idr["Name"]),
                                    HouseID = Convert.ToInt32(idr["HouseID"]),
                                    TotalSum = Convert.ToInt32(idr["TotalSum"]),
                                    CurRentMoney = Convert.ToDecimal((ds.BigTyreSum * 9 + ds.SmallTyreSum * 3) / Convert.ToInt32(idr["TotalDay"]))
                                });
                            }
                            else
                            {
                                result.Add(new CargoDayStockEntity
                                {
                                    StatisDis = Convert.ToString(idr["StatisDis"]),
                                    Name = Convert.ToString(idr["Name"]),
                                    HouseID = Convert.ToInt32(idr["HouseID"]),
                                    TotalSum = Convert.ToInt32(idr["TotalSum"]),
                                    CurRentMoney = Convert.ToDecimal(idr["CurRentMoney"])
                                });
                            }
                        }
                    }
                }
                resHT["rows"] = result;

                string strCount = @"select COUNT(*) as TotalCount From (select count(*) as TotalCount from Tbl_Cargo_DayCargoStock Where(1 = 1)";
                if (!entity.HouseID.Equals(0)) { strCount += " and HouseID = " + entity.HouseID; }
                if (!string.IsNullOrEmpty(entity.Name)) { strCount += " and Name = '" + entity.Name + "'"; }
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and StatisDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and StatisDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strCount += "group by SUBSTRING( Convert(varchar(100),StatisDate,112),1,6),Name,HouseID) as a";
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0)
                        {
                            resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]);
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        private CargoDayStockEntity QueryDayStockSum(CargoDayStockEntity entity)
        {
            CargoDayStockEntity result = new CargoDayStockEntity();
            string strSQL = "select SUM(BigTyreSum) as BigTyreSum,SUM(SmallTyreSum) as SmallTyreSum From Tbl_Cargo_DayCargoStock where (1=1)";
            if (!string.IsNullOrEmpty(entity.Name)) { strSQL += " and Name='" + entity.Name + "'"; }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and StatisDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and StatisDate<'" + entity.EndDate.ToString("yyyy-MM-dd") + "'";
            }
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.BigTyreSum = Convert.ToInt32(idr["BigTyreSum"]);
                        result.SmallTyreSum = Convert.ToInt32(idr["SmallTyreSum"]);
                    }
                }
            }
            return result;
        }
        /// <summary>
        /// 查询每日库存数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDayStockEntity> QueryDayStockListData(CargoDayStockEntity entity)
        {
            List<CargoDayStockEntity> result = new List<CargoDayStockEntity>();
            string strSQL = "select * From Tbl_Cargo_DayCargoStock where (1=1)";
            if (!string.IsNullOrEmpty(entity.Name))
            {
                strSQL += " and Name='" + entity.Name + "'";
            }
            if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and StatisDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
            }
            if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
            {
                strSQL += " and StatisDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
            }
            strSQL += " Order by StatisDate desc";
            using (DbCommand command = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dd = conn.ExecuteDataTable(command))
                {
                    foreach (DataRow idr in dd.Rows)
                    {
                        result.Add(new CargoDayStockEntity
                        {
                            ID = Convert.ToInt64(idr["ID"]),
                            StatisDate = Convert.ToDateTime(idr["StatisDate"]),
                            HouseID = Convert.ToInt32(idr["HouseID"]),
                            Name = Convert.ToString(idr["Name"]),
                            TotalSum = Convert.ToInt32(idr["TotalSum"]),
                            TotalValue = string.IsNullOrEmpty(Convert.ToString(idr["WKTTotalValue"])) ? 0 : Convert.ToDouble(idr["TotalValue"]),
                            MaPaiSum = Convert.ToInt32(idr["MaPaiSum"]),
                            MaPaiTotalValue = string.IsNullOrEmpty(Convert.ToString(idr["WKTTotalValue"])) ? 0 : Convert.ToDouble(idr["MaPaiTotalValue"]),
                            YKHMSum = Convert.ToInt32(idr["YKHMSum"]),
                            YKHMTotalValue = string.IsNullOrEmpty(Convert.ToString(idr["WKTTotalValue"])) ? 0 : Convert.ToDouble(idr["YKHMTotalValue"]),
                            HanTaiSum = Convert.ToInt32(idr["HanTaiSum"]),
                            HanTaiTotalValue = string.IsNullOrEmpty(Convert.ToString(idr["WKTTotalValue"])) ? 0 : Convert.ToDouble(idr["HanTaiTotalValue"]),
                            GuBoSum = Convert.ToInt32(idr["GuBoSum"]),
                            GuBoTotalValue = string.IsNullOrEmpty(Convert.ToString(idr["WKTTotalValue"])) ? 0 : Convert.ToDouble(idr["GuBoTotalValue"]),
                            MQLSum = Convert.ToInt32(idr["MQLSum"]),
                            MQLTotalValue = string.IsNullOrEmpty(Convert.ToString(idr["WKTTotalValue"])) ? 0 : Convert.ToDouble(idr["MQLTotalValue"]),
                            QiTaSum = Convert.ToInt32(idr["QiTaSum"]),
                            QiTaTotalValue = string.IsNullOrEmpty(Convert.ToString(idr["WKTTotalValue"])) ? 0 : Convert.ToDouble(idr["QiTaTotalValue"]),
                            WKTSum = Convert.ToInt32(idr["WKTSum"]),
                            BigTyreSum = Convert.ToInt32(idr["BigTyreSum"]),
                            SmallTyreSum = Convert.ToInt32(idr["SmallTyreSum"]),
                            MidTyreSum = Convert.ToInt32(idr["MidTyreSum"]),
                            WKTTotalValue = string.IsNullOrEmpty(Convert.ToString(idr["WKTTotalValue"])) ? 0 : Convert.ToDouble(idr["WKTTotalValue"])
                        });
                    }
                }
            }
            return result;
        }
        #endregion
        #region 订单数据统计

        /// <summary>
        /// 查询订单统计数据
        /// </summary>
        /// <param name="pIndex"></param>
        /// <param name="pNum"></param>
        /// <param name="entity"></param>
        /// <returns></returns>
        public Hashtable QueryOrderStatistics(int pIndex, int pNum, CargoOrderEntity entity)
        {
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select DISTINCT ROW_NUMBER() OVER (ORDER BY TotalPiece DESC) AS RowNumber,AcceptUnit,TotalOrders,TotalPiece,TotalTotalCharge from ( select DISTINCT AcceptUnit ,COUNT(*) as TotalOrders,sum(Piece) as TotalPiece,SUM(TotalCharge) as TotalTotalCharge from Tbl_Cargo_Order where (1=1) ";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and HouseID in (" + entity.CargoPermisID + ")"; }
                //订单类型
                if (!string.IsNullOrEmpty(entity.ThrowGood)) { strSQL += " and ThrowGood ='" + entity.ThrowGood + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " group by AcceptUnit) A)A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1)) order by RowNumber";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取运单数据

                            result.Add(new CargoOrderEntity
                            {
                                AcceptUnit = Convert.ToString(idr["AcceptUnit"]),
                                TotalOrders = Convert.ToInt32(idr["TotalOrders"]),
                                TotalPiece = Convert.ToInt32(idr["TotalPiece"]),
                                TotalTotalCharge = Convert.ToDecimal(idr["TotalTotalCharge"])
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"Select Count(*) as TotalCount from Tbl_Cargo_Order  Where (1=1)";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and HouseID in (" + entity.CargoPermisID + ")"; }
                //订单类型
                if (!string.IsNullOrEmpty(entity.ThrowGood)) { strCount += " and ThrowGood ='" + entity.ThrowGood + "'"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0) { resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]); }
                    }
                }
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        #endregion

        public Hashtable QueryClientArrearsStatistics(CargoOrderEntity entity)
        {
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @"select aa.*,client.ClientName,client.Boss,client.Address,client.Telephone,client.Cellphone,client.UserName,house.Name as HouseName,client.HouseID from Tbl_Cargo_Client client left join Tbl_Cargo_House as house on client.HouseID=house.HouseID inner join( select b.*,isnull( a.AffectTotal,0)AffectTotal from ( select sum(AffectCash+AffectCard+AffectWX+AffectAlipay) as AffectTotal,ClientNum from ( select fr.AffectCash,fr.AffectCard,fr.AffectWX,fr.AffectAlipay, ClientNum from Tbl_Cargo_FinanceRecord fr inner join ( select ra.*,o.ClientNum from Tbl_Cargo_RecordAwbID ra inner join ( SELECT OrderNo, sum(TotalCharge* CASE WHEN OrderModel=1 THEN -1 ELSE 1 end)as TotalCharge, count(*) AS OrderCount, min(CreateDate)as CreateDate, min(ClientNum) ClientNum FROM Tbl_Cargo_Order WHERE (1=1) ";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and HouseID in (" + entity.CargoPermisID + ")"; }
                //if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strSQL += " and AcceptPeople like '%" + entity.AcceptPeople + "%'"; }
                //客户名称
                if (!string.IsNullOrEmpty(entity.AcceptUnit)) { strSQL += " and AcceptUnit ='" + entity.AcceptUnit + "'"; }
                if (!entity.PayClientNum.Equals(0)) { strSQL += " and PayClientNum=" + entity.PayClientNum; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }

                strSQL += " AND CheckStatus!=1 GROUP BY OrderNo)o on ra.AffectNo=o.OrderNo) ora on fr.RecordID=ora.RecordID where fr.RevokeType=0 and fr.FromTO=0) a group by ClientNum)a right join( SELECT ClientNum, sum(TotalCharge* CASE WHEN OrderModel=1 THEN -1 ELSE 1 end)as TotalCharge, count(*) AS OrderCount, min(CreateDate)as CreateDate FROM Tbl_Cargo_Order WHERE (1=1) ";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and HouseID in (" + entity.CargoPermisID + ")"; }
                //if (!string.IsNullOrEmpty(entity.AcceptPeople)) { strSQL += " and AcceptPeople like '%" + entity.AcceptPeople + "%'"; }
                //客户名称
                if (!string.IsNullOrEmpty(entity.AcceptUnit)) { strSQL += " and AcceptUnit ='" + entity.AcceptUnit + "'"; }
                if (!entity.PayClientNum.Equals(0)) { strSQL += " and PayClientNum=" + entity.PayClientNum; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                strSQL += " AND CheckStatus!=1 GROUP BY ClientNum)b on a.ClientNum=b.ClientNum)aa on client.ClientNum=aa.ClientNum";
                //业务员
                if (!string.IsNullOrEmpty(entity.SaleManID)) { strSQL += " where UserID ='" + entity.SaleManID + "'"; }

                strSQL += $@" order by CreateDate";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取运单数据

                            result.Add(new CargoOrderEntity
                            {
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                AcceptUnit = Convert.ToString(idr["ClientName"]),
                                AcceptPeople = Convert.ToString(idr["Boss"]),
                                AcceptAddress = Convert.ToString(idr["Address"]),
                                AcceptTelephone = Convert.ToString(idr["Telephone"]),
                                AcceptCellphone = Convert.ToString(idr["Cellphone"]),
                                SaleManName = Convert.ToString(idr["UserName"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                TotalCharge = Convert.ToDecimal(idr["TotalCharge"]) - Convert.ToDecimal(idr["AffectTotal"]),
                                OrderCount = Convert.ToString(idr["OrderCount"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"])
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }
        public Hashtable QueryClientArrearsDetailed(int pIndex, int pNum, CargoOrderEntity entity)
        {
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();
            Hashtable resHT = new Hashtable();
            try
            {
                entity.EnSafe();
                #region 组装查询SQL语句
                string strSQL = @" SELECT TOP " + pNum + " *  FROM ";
                strSQL += "(select DISTINCT ROW_NUMBER() OVER (ORDER BY CreateDate DESC) AS RowNumber,* from Tbl_Cargo_Order  where (1=1) ";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and HouseID in (" + entity.CargoPermisID + ")"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!entity.ClientNum.Equals(0)) { strSQL += " and ClientNum=" + entity.ClientNum; }
                strSQL += "  and CheckStatus!=1  )A ";
                strSQL += " WHERE RowNumber > (" + pNum + "* (" + pIndex + "-1)) order by RowNumber";
                #endregion
                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取运单数据

                            result.Add(new CargoOrderEntity
                            {
                                OrderID = Convert.ToInt64(idr["OrderID"]),
                                OrderNo = Convert.ToString(idr["OrderNo"]),
                                Dep = Convert.ToString(idr["Dep"]),
                                Dest = Convert.ToString(idr["Dest"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                TransitFee = Convert.ToDecimal(idr["TransitFee"]),
                                TransportFee = Convert.ToDecimal(idr["TransportFee"]),
                                DeliveryFee = Convert.ToDecimal(idr["DeliveryFee"]),
                                OrderModel = Convert.ToString(idr["OrderModel"]),
                                OtherFee = Convert.ToDecimal(idr["OtherFee"]),
                                TotalCharge = Convert.ToDecimal(idr["TotalCharge"]),
                                CheckOutType = Convert.ToString(idr["CheckOutType"]),
                                TrafficType = Convert.ToString(idr["TrafficType"]),
                                DeliveryType = Convert.ToString(idr["DeliveryType"]),
                                AcceptUnit = Convert.ToString(idr["AcceptUnit"]),
                                CreateDate = Convert.ToDateTime(idr["CreateDate"]),
                                AcceptAddress = Convert.ToString(idr["AcceptAddress"]),
                                AcceptPeople = Convert.ToString(idr["AcceptPeople"]),
                                AcceptTelephone = Convert.ToString(idr["AcceptTelephone"]),
                                AcceptCellphone = Convert.ToString(idr["AcceptCellphone"]),
                                CheckStatus = Convert.ToString(idr["CheckStatus"]),
                                Remark = Convert.ToString(idr["Remark"])
                            });
                            #endregion
                        }
                    }
                }
                resHT["rows"] = result;
                #region 总数目
                string strCount = @"select  Count(*) as TotalCount from Tbl_Cargo_Order where (1=1)";
                //所属仓库ID
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strCount += " and HouseID in (" + entity.CargoPermisID + ")"; }
                //制单日期范围
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strCount += " and CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!entity.ClientNum.Equals(0)) { strCount += " and ClientNum=" + entity.ClientNum; }
                strCount += " and CheckStatus!=1 and OrderModel=0";
                using (DbCommand cmd = conn.GetSqlStringCommond(strCount))
                {
                    using (DataTable idrCount = conn.ExecuteDataTable(cmd))
                    {
                        if (idrCount.Rows.Count > 0) { resHT["total"] = Convert.ToInt32(idrCount.Rows[0]["TotalCount"]); }
                    }
                }
                #endregion
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return resHT;
        }

        public List<CargoOrderEntity> QuerySaleProfitData(CargoOrderEntity entity)
        {
            CargoHouseManager house = new CargoHouseManager();
            List<CargoOrderEntity> result = new List<CargoOrderEntity>();
            try
            {
                string strSQL = @"select '销售收入'as OrderType,c.TypeID,d.TypeName,sum(b.Piece * case when a.OrderModel=1 then -1 else 1 end) as Piece,SUM(b.Piece*b.ActSalePrice * case when a.OrderModel=1 then -1 else 1 end) as ActSalePrice from Tbl_Cargo_Order a inner join Tbl_Cargo_OrderGoods b on a.OrderNo=b.OrderNo inner join Tbl_Cargo_Product c on b.ProductID=c.ProductID inner join Tbl_Cargo_ProductType d on c.TypeID=d.TypeID where (1=1) and d.ParentID=1 ";
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                strSQL += " group by c.TypeID,d.TypeName union all ";
                strSQL += " select '销售成本'as OrderType,c.TypeID,d.TypeName,sum(b.Piece * case when a.OrderModel=1 then -1 else 1 end) as Piece,SUM(c.CostPrice*b.Piece * case when a.OrderModel=1 then -1 else 1 end) as CostPrice from Tbl_Cargo_Order a inner join Tbl_Cargo_OrderGoods b on a.OrderNo=b.OrderNo inner join Tbl_Cargo_Product c on b.ProductID=c.ProductID inner join Tbl_Cargo_ProductType d on c.TypeID=d.TypeID where (1=1) and d.ParentID=1 ";
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.CreateDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                strSQL += " group by c.TypeID,d.TypeName union all ";
                strSQL += " select '管理费用'as OrderType,b.SID as TypeID,c.SName as TypeName,COUNT(*) as Piece,SUM(b.DetailCharge) as DetailCharge from tbl_Cargo_Expense a inner join tbl_Cargo_ExpenseDetail b on a.ExID=b.ExID inner join Tbl_Cargo_SecondSubject c on b.SID=c.SID where (1=1) and b.FID =8 ";
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                strSQL += " group by b.SID,c.SName union all ";
                strSQL += " select '销售费用'as OrderType,b.SID as TypeID,c.SName as TypeName,COUNT(*) as Piece,SUM(b.DetailCharge) as DetailCharge from tbl_Cargo_Expense a inner join tbl_Cargo_ExpenseDetail b on a.ExID=b.ExID inner join Tbl_Cargo_SecondSubject c on b.SID=c.SID where (1=1) and b.FID =18 ";
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.ExDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                strSQL += " group by b.SID,c.SName union all select '其它收入'as OrderType,0 as TypeID,(case a.ProjectCategory when '0' then'租金'when '1'then'利息' end)as TypeName,COUNT(*) as Piece,SUM(a.AmountInvolved)as DetailCharge from tbl_cargo_OtherBusiness a where a.ProjectType='0' ";
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.HappenDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.HappenDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                strSQL += " group by a.ProjectCategory union all select '其它成本'as OrderType,0 as TypeID,(case a.ProjectCategory when '0' then'租金'when '1'then'利息' end)as TypeName,COUNT(*) as Piece,SUM(a.AmountInvolved)as DetailCharge from tbl_cargo_OtherBusiness a where a.ProjectType='1' ";
                if ((entity.StartDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.StartDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.HappenDate>='" + entity.StartDate.ToString("yyyy-MM-dd") + "'";
                }
                if ((entity.EndDate.ToString("yyyy-MM-dd") != "0001-01-01" && entity.EndDate.ToString("yyyy-MM-dd") != "1900-01-01"))
                {
                    strSQL += " and a.HappenDate<'" + entity.EndDate.AddDays(1).ToString("yyyy-MM-dd") + "'";
                }
                if (!string.IsNullOrEmpty(entity.CargoPermisID)) { strSQL += " and a.HouseID in (" + entity.CargoPermisID + ")"; }
                strSQL += " group by a.ProjectCategory union all select '合计利润'as OrderType,0,'利润合计',0,0 ";

                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取运单数据
                            result.Add(new CargoOrderEntity
                            {
                                OrderType = Convert.ToString(idr["OrderType"]),
                                TypeID = Convert.ToInt32(idr["TypeID"]),
                                TypeName = Convert.ToString(idr["TypeName"]),
                                Piece = Convert.ToInt32(idr["Piece"]),
                                ActSalePrice = Convert.ToDecimal(idr["ActSalePrice"])
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;

        }

        public List<CargoClientAcceptAddressEntity> QueryWxLongitudeAndLatitude()
        {
            CargoHouseManager house = new CargoHouseManager();
            List<CargoClientAcceptAddressEntity> result = new List<CargoClientAcceptAddressEntity>();
            try
            {
                string strSQL = @"select ClientNum, HouseID,HouseName,ClientShortName,Lng,Lat,AcceptCompany,Longitude,Latitude from (
                            select e.Name as HouseName,ClientShortName,e.Lng,e.Lat, d.* from Tbl_WX_Client as a
                            inner join Tbl_Cargo_Client as b on a.ClientNum=b.ClientNum
                            inner join Tbl_Cargo_AcceptAddress as d on d.ClientNum=b.ClientNum and d.HouseID=b.HouseID
                            inner join Tbl_Cargo_House as e on b.HouseID=e.HouseID
                            where  isnull(d.Longitude,'')<>'' and isnull(d.Latitude,'')<>'' and e.BelongHouse=6
                                          ) as a
                            group by ClientNum,a.HouseID,HouseName,ClientShortName,Lng,Lat,AcceptCompany,Longitude,Latitude ";

                using (DbCommand command = conn.GetSqlStringCommond(strSQL))
                {
                    using (DataTable dt = conn.ExecuteDataTable(command))
                    {
                        foreach (DataRow idr in dt.Rows)
                        {
                            #region 获取运单数据
                            result.Add(new CargoClientAcceptAddressEntity
                            {
                                ClientNum = Convert.ToInt32(idr["ClientNum"]),
                                HouseID = Convert.ToInt32(idr["HouseID"]),
                                HouseName = Convert.ToString(idr["HouseName"]),
                                ClientShortName = Convert.ToString(idr["ClientShortName"]),
                                AcceptCompany = Convert.ToString(idr["AcceptCompany"]),
                                Longitude = Convert.ToString(idr["Longitude"]),
                                Latitude = Convert.ToString(idr["Latitude"]),
                                Lng = Convert.ToString(idr["Lng"]),
                                Lat = Convert.ToString(idr["Lat"]),
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (ApplicationException ex) { throw new ApplicationException(ex.Message); }
            return result;

        }


        #region 


        /// <summary>
        /// 订单统计数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoDLTDataStatisEntity> HCYC_Order_StatisticsData(CargoDLTDataStatisEntity entity)
        {
            List<CargoDLTDataStatisEntity> result = new List<CargoDLTDataStatisEntity>();

            string strSQL = $@"select isnull(SalesPiece,0) as SalesPiece,isnull(ReturnPiece,0) as ReturnPiece,isnull(SalesTotalCharge,0) as SalesTotalCharge,isnull(ReturnTotalCharge,0) as ReturnTotalCharge
,isnull((select sum(Piece) from Tbl_Cargo_OrderDayStatistics ),0) TotalPiece,isnull((select sum(AimQuantity) from Tbl_Cargo_HouseAim as aim where aim.AimYear=datename(year ,'{entity.EndDate.ToString("yyyy-MM-dd")}') and AimMonth=datename(month ,'{entity.EndDate.ToString("yyyy-MM-dd")}')),0) MonthHouseTotalPiece
from (
    select
    sum(case when isnull(OrderModel,0)=0 then a.Piece else 0 end) as SalesPiece,sum(case when isnull(OrderModel,0)=1 then a.Piece else 0 end) as ReturnPiece
     ,sum(case when isnull(OrderModel,0)=0 then a.TotalCharge else 0 end) as SalesTotalCharge
     ,sum(case when isnull(OrderModel,0)=1 then a.TotalCharge else 0 end) as ReturnTotalCharge
    from Tbl_Cargo_OrderDayStatistics as a
where DayStatisticsTime>='{entity.StartDate.ToString("yyyy-MM-dd")}'
  and DayStatisticsTime<='{entity.EndDate.ToString("yyyy-MM-dd")}'
              ) as aa";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoDLTDataStatisEntity
                        {
                            SalesPiece = Convert.ToString(idrCount["SalesPiece"]) == null ? 0 : Convert.ToInt32(idrCount["SalesPiece"]),
                            ReturnPiece = Convert.ToString(idrCount["ReturnPiece"]) == null ? 0 : Convert.ToInt32(idrCount["ReturnPiece"]),
                            SalesTotalCharge = Convert.ToString(idrCount["SalesTotalCharge"]) == null ? 0 : Convert.ToDecimal(idrCount["SalesTotalCharge"]),
                            ReturnTotalCharge = Convert.ToString(idrCount["ReturnTotalCharge"]) == null ? 0 : Convert.ToInt32(idrCount["ReturnTotalCharge"]),
                            TotalPiece = Convert.ToString(idrCount["TotalPiece"]) == null ? 0 : Convert.ToInt32(idrCount["TotalPiece"]),
                            MonthHouseTotalPiece = Convert.ToString(idrCount["MonthHouseTotalPiece"]) == null ? 0 : Convert.ToInt32(idrCount["MonthHouseTotalPiece"]),
                        });
                    }
                }
            }
            return result;
        }

        /// <summary>
        /// 查询慧采云仓访问请求数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public CargoDLTDataStatisEntity HCYC_Access_StatisticsData(CargoDLTDataStatisEntity entity)
        {
            CargoDLTDataStatisEntity result = new CargoDLTDataStatisEntity();
            string strSQL = $@"
select a1.UserUniqueClientCount,a2.StoresUniqueClientCount from (
    SELECT 1 as id, COUNT(DISTINCT a.ID) AS UserUniqueClientCount
FROM Tbl_WX_Client AS a INNER JOIN Tbl_Cargo_Order AS c ON a.ClientNum = c.ClientNum WHERE convert(varchar(10),c.CreateDate,23) >= '{entity.StartDate.ToString("yyyy-MM-dd")}' AND c.CreateDate < '{entity.EndDate.AddDays(1).ToString("yyyy-MM-dd")}'
          and c.OrderType = '4'    ) as a1
    inner join (
SELECT 1 as id, COUNT(DISTINCT a.ClientNum) AS StoresUniqueClientCount
FROM Tbl_WX_Client AS a INNER JOIN Tbl_Cargo_Order AS c ON a.ClientNum = c.ClientNum WHERE convert(varchar(10),c.CreateDate,23) >= '{entity.StartDate.ToString("yyyy-MM-dd")}' AND c.CreateDate < '{entity.EndDate.AddDays(1).ToString("yyyy-MM-dd")}'
   and c.OrderType = '4' ) a2 on a1.id=a2.id
";
            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result = (new CargoDLTDataStatisEntity
                        {
                            UserUniqueClientCount = Convert.ToInt32(idrCount["UserUniqueClientCount"]),
                            StoresUniqueClientCount = Convert.ToInt32(idrCount["StoresUniqueClientCount"]),
                        });
                    }
                }
            }
            return result;

        }
        /// <summary>
        /// 查询慧采云仓访问请求数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoHouseAimEntity> QueryHCYC_House(CargoHouseAimEntity entity)
        {
            var PrevDays = DateTime.DaysInMonth(entity.StartDate.AddMonths(-1).Year, entity.StartDate.AddMonths(-1).Month);
            var CurrDay = (entity.EndDate - Convert.ToDateTime(entity.EndDate.ToString("yyyy-MM-01"))).Days + 1;
            if (CurrDay > PrevDays)
            {
                CurrDay = PrevDays;
            }
            var PrevMonthEnd = Convert.ToDateTime(entity.StartDate.AddMonths(-1).ToString($@"yyyy-MM-{(CurrDay < 10 ? ("0" + CurrDay) : CurrDay.ToString())}"));
            var PrevMonthStart = PrevMonthEnd.AddDays((entity.EndDate - entity.StartDate).Days * -1);
            List<CargoHouseAimEntity> result = new List<CargoHouseAimEntity>();
            string strSQL = $@"
            select a2.*,isnull(a3.AimQuantity,0) as AimQuantity,(case when isnull(AimQuantity,0)=0 then 0 else isnull(round((cast(Piece as numeric(12,2))/cast(AimQuantity as numeric(12,2)))*100,0),0) end) PercentComplete
            ,h.Name as  HouseName,isnull(a4.PrevPiece,0) as PrevPiece
            from (select HouseID,sum(case when OrderModel=0 then Piece else -Piece end) as Piece,Year,Month from Tbl_Cargo_OrderDayStatistics as a
            where DayStatisticsTime>='{entity.StartDate.ToString("yyyy-MM-dd")}'
              and DayStatisticsTime<='{entity.EndDate.ToString("yyyy-MM-dd")}'
            {(entity.OrderType == 0 ? "" : $@" and ThrowGood=" + entity.OrderType)}
            --and OrderModel=0
            group by HouseID ,Year,Month
                          ) as a2
             left join (
                select HouseID,sum(case when OrderModel=0 then Piece else -Piece end) as PrevPiece,Year,Month from Tbl_Cargo_OrderDayStatistics as a
            where DayStatisticsTime>='{PrevMonthStart.ToString("yyyy-MM-dd")}'
              and DayStatisticsTime<='{PrevMonthEnd.AddDays(1).AddMilliseconds(-1).ToString("yyyy-MM-dd HH:mm:ss")}'
            group by HouseID ,Year,Month
            ) as a4 on a2.HouseID=a4.HouseID and a2.Year = a4.Year
            left join Tbl_Cargo_HouseAim as a3 on a2.HouseID=a3.HouseID and a2.Year=a3.AimYear and a2.Month=a3.AimMonth
            inner join Tbl_Cargo_House as h on a2.HouseID=h.HouseID
            ";
            strSQL += "  order by Year desc,Month desc,a2.Piece desc";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoHouseAimEntity
                        {
                            HouseName = Convert.ToString(idrCount["HouseName"]),
                            Piece = Convert.ToInt32(idrCount["Piece"]),
                            AimQuantity = Convert.ToInt32(idrCount["AimQuantity"]),
                            PercentComplete = Convert.ToDouble(idrCount["PercentComplete"]),
                            HouseID = Convert.ToInt32(idrCount["HouseID"]),
                            AimMonth = Convert.ToInt32(idrCount["Month"]),
                            AimYear = Convert.ToInt32(idrCount["Year"]),
                            PrevPiece = Convert.ToInt32(idrCount["PrevPiece"]),
                        });
                    }
                }
            }
            return result;//.OrderByDescending(a => a.PercentComplete).ToList();

        }
        /// <summary>
        /// 品牌月销售排名统计数
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderDayStatisticsEntity> QueryHCYC_OrderDayStatistics(CargoHouseAimEntity entity)
        {
            List<CargoOrderDayStatisticsEntity> result = new List<CargoOrderDayStatisticsEntity>();
            string strSQL = $@"
            select a.TypeID,b.TypeName,a.HouseID,c.Name as HouseName,sum(Piece) as Piece
            from Tbl_Cargo_OrderDayStatistics as a
            inner join Tbl_Cargo_ProductType as b on a.TypeID=b.TypeID
            inner join Tbl_Cargo_House as c on a.HouseID=c.HouseID
            where  DayStatisticsTime>='{entity.StartDate.ToString("yyyy-MM-dd")}'
            and DayStatisticsTime<='{entity.EndDate.ToString("yyyy-MM-dd")}'
            and a.TypeID='{entity.TypeID}'
            group by a.TypeID,b.TypeName,a.HouseID,c.Name
            order by Piece desc
            ";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoOrderDayStatisticsEntity
                        {
                            HouseName = Convert.ToString(idrCount["HouseName"]),
                            HouseID = Convert.ToInt32(idrCount["HouseID"]),
                            TypeID = Convert.ToInt32(idrCount["TypeID"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            Piece = Convert.ToInt32(idrCount["Piece"]),
                        });
                    }
                }
            }
            return result;

        }
        /// <summary>
        /// 品牌月销售排名统计数
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderDayStatisticsEntity> QueryHCYC_BrandData(CargoHouseAimEntity entity)
        {
            List<CargoOrderDayStatisticsEntity> result = new List<CargoOrderDayStatisticsEntity>();

            var PrevDays = DateTime.DaysInMonth(entity.StartDate.AddMonths(-1).Year, entity.StartDate.AddMonths(-1).Month);
            var CurrDay = (entity.EndDate - Convert.ToDateTime(entity.EndDate.ToString("yyyy-MM-01"))).Days + 1;
            if (CurrDay > PrevDays)
            {
                CurrDay = PrevDays;
            }
            var PrevMonthEnd = Convert.ToDateTime(entity.StartDate.AddMonths(-1).ToString($@"yyyy-MM-{(CurrDay < 10 ? ("0" + CurrDay) : CurrDay.ToString())}"));
            var PrevMonthStart = PrevMonthEnd.AddDays((entity.EndDate - entity.StartDate).Days * -1);

            #region 废弃
            //            string strSQL = $@"
            //      select a2.*, isnull(d.StockNum, 0) as StockNum, isnull(ProCount, 0) AS ProCount, isnull(ProCountAll, 0) AS ProCountAll, isnull(ProPiece, 0) AS ProPiece,isnull(dd.UniqueClientCount,0) UniqueClientCount,isnull(dd.UniqueClientNum,0) UniqueClientNum
            //          ,isnull(clickCount,0) as clickCount,isnull(a4.Piece,0) as PrevMonthPiece,isnull(a4.Count,0) as PrevMonthCount,a5.SizeCount,isnull(a5.BigSizeCount,0) BigSizeCount
            //          from (select a.TypeID, a.HouseID, sum(case when OrderModel=0 then Piece else -Piece end) Piece, count(distinct case when OrderModel = 0 then ProductCode end) as Count, b.TypeName, c.Name HouseName
            //                from Tbl_Cargo_OrderDayStatistics as a
            //                         inner join Tbl_Cargo_ProductType as b on a.TypeID = b.TypeID
            //                         inner join Tbl_Cargo_House as c on a.HouseID = c.HouseID
            //                where 1=1 {(entity.TypeID == 0 ? "" : " and a.TypeID = @TypeID")} 
            //                        {(entity.HouseID == 0 ? "" : "and a.HouseID = @HouseID")} 
            //                        {(entity.SuppClientNum != 0 ? $@" and a.SuppID=@SuppID" : "")}
            //                        {(entity.OrderType != 0 ? $@" and ThrowGood=@OrderType" : "")} 
            //                  and DayStatisticsTime >= @StartDate and DayStatisticsTime<=@EndDate
            //                group by a.TypeID, a.HouseID, b.TypeName, c.Name) as a2
            //                   left join (select HouseID, TypeID, count(StockNum) as StockNum
            //                              from Tbl_Cargo_SafeStock as aa
            //                              group by HouseID, TypeID) as d on a2.TypeID = d.TypeID and a2.HouseID = d.HouseID
            //                  left join (select b.TypeID, e.HouseID, count(distinct case when b.Piece<>0 then ProductCode end) as ProCount
            //, count(distinct ProductCode) as ProCountAll
            //, sum(b.Piece) as ProPiece
            //                              from Tbl_Cargo_Product as a
            //                                       inner join Tbl_Cargo_ContainerGoods as b on a.ProductID = b.ProductID
            //                                       inner join Tbl_Cargo_Container as c on c.ContainerID = b.ContainerID
            //                                       inner join Tbl_Cargo_Area as d on c.AreaID = d.AreaID
            //                                       inner join Tbl_Cargo_House as e on d.HouseID = e.HouseID
            //                              where a.InCargoStatus in (1, 2)   and ProductCode is not null
            //                                AND A.SpecsType IN (4) 
            //                              group by b.TypeID, e.HouseID) as c on a2.TypeID = c.TypeID and a2.HouseID = c.HouseID
            //                  left join (
            //                  SELECT
            //              h.TypeID,d.HouseID,COUNT(DISTINCT d.OrderID) AS UniqueClientCount,sum(case when OrderModel=1 then -orderGoods.Piece else orderGoods.Piece end) UniqueClientNum
            //          FROM  Tbl_Cargo_Order as d 
            //              inner join Tbl_Cargo_OrderGoods orderGoods on d.OrderNo=orderGoods.OrderNo
            //              inner join Tbl_Cargo_Product as h on h.ProductID=orderGoods.ProductID
            //          WHERE
            //              d.CreateDate >= @StartDate
            //              AND  d.CreateDate <= @EndDate --and PayStatus=1 
            //{(entity.TypeID == 0 ? "" : " and h.TypeID = @TypeID")} 
            //{(entity.HouseID == 0 ? "" : "and d.HouseID = @HouseID")} 
            //            and  d.OrderType = 4
            //          group by h.TypeID, d.HouseID
            //          ) as dd  on a2.TypeID = dd.TypeID and a2.HouseID = dd.HouseID
            //          left join (
            //              select a.HouseID,c.TypeID,count(1) clickCount
            //          from Tbl_Cargo_ProductAccessDetails as a
            //                   inner join Tbl_WX_Client as b on a.wxOpenID = b.wxOpenID
            //                   inner join Tbl_Cargo_ProductSpec as c on a.ProductCode=c.ProductCode
            //          where (1 = 1)
            //            and  a.AccessTime >= @StartDate
            //            and a.AccessTime <= @EndDate 
            //{(entity.TypeID == 0 ? "" : " and c.TypeID = @TypeID")} 
            //{(entity.HouseID == 0 ? "" : "and a.HouseID = @HouseID")} 
            //          group by a.HouseID,c.TypeID
            //          ) as ee on a2.TypeID = ee.TypeID and a2.HouseID = ee.HouseID
            //            left join (
            //              select a.TypeID, a.HouseID, b.TypeName, c.Name HouseName, sum(case when OrderModel=0 then Piece else -Piece end) as Piece, count(distinct case when OrderModel = 0 then ProductCode end) as Count
            //                from Tbl_Cargo_OrderDayStatistics as a
            //                         inner join Tbl_Cargo_ProductType as b on a.TypeID = b.TypeID
            //                         inner join Tbl_Cargo_House as c on a.HouseID = c.HouseID
            //                where 1=1  
            //                    {(entity.TypeID == 0 ? "" : " and a.TypeID = @TypeID")} 
            //                    {(entity.HouseID == 0 ? "" : "and a.HouseID = @HouseID")} 
            //                  and DayStatisticsTime >= @PrevStartDate and DayStatisticsTime<= @PrevEndDate
            //                group by a.TypeID, a.HouseID, b.TypeName, c.Name
            //          ) as a4 on a2.TypeID=a4.TypeID and a2.HouseID=a4.HouseID
            //         left join (
            //                  SELECT a.HouseID,c.TypeID,count(Size) SizeCount,sum(case when ISNUMERIC(Size) = 1 and cast(Size as int)>=18 then (case when OrderModel=0 then orderGoods.Piece else -orderGoods.Piece end) end) BigSizeCount
            //                FROM  Tbl_Cargo_Order as a
            //              inner join Tbl_Cargo_OrderGoods orderGoods on a.OrderNo=orderGoods.OrderNo
            //                inner join Tbl_Cargo_Product as c on orderGoods.ProductID=c.ProductID
            //                where ISNUMERIC(Size) = 1 
            //                    {(entity.TypeID == 0 ? "" : " and c.TypeID = @TypeID")} 
            //                    {(entity.HouseID == 0 ? "" : "and a.HouseID = @HouseID")} 
            //                and a.CreateDate >= @StartDate AND  a.CreateDate <= @EndDate and CheckStatus=1 and a.FinanceSecondCheck=1 and a.OrderType = '4'
            //                group by a.HouseID, c.TypeID
            //          ) as a5 on a2.TypeID=a5.TypeID and a2.HouseID=a5.HouseID
            //          ORDER BY Piece DESC
            //      ";
            #endregion
            string strSQL =  $@"
SET ARITHABORT ON;
;with BaseOrders as (
    select
        o.HouseID,
        p.TypeID,
        o.CreateDate,
        o.OrderType,
        o.CheckStatus,
        o.FinanceSecondCheck,
        og.Piece,
        og.ProductID,
        HubDiameter,
        o.OrderModel,
        o.OrderID
    from Tbl_Cargo_Order o
    inner join Tbl_Cargo_OrderGoods og on o.OrderNo = og.OrderNo
    inner join Tbl_Cargo_Product p on og.ProductID = p.ProductID
    where  o.CreateDate >= '{entity.StartDate.ToString("yyyy-MM-dd")}'
      and o.CreateDate <= '{entity.EndDate.AddDays(1).AddMilliseconds(-1).ToString("yyyy-MM-dd HH:mm:ss")}'
         {(entity.TypeID == 0 ? "" : $@" and p.TypeID = {entity.TypeID}")} 
     {(entity.HouseID == 0 ? "" : $@"and o.HouseID = {entity.HouseID}")} 
)
, OrderStats as (
    select
        TypeID,
        HouseID,
        COUNT(distinct OrderID) as UniqueClientCount,
        SUM(case when OrderModel=1 then -Piece else Piece end) as UniqueClientNum
    from BaseOrders
    where OrderType = 4
    group by TypeID, HouseID
)
, BigSizeStats as (
    select
        HouseID,
        TypeID,
        COUNT(HubDiameter) as SizeCount,
        SUM(case when ISNUMERIC(HubDiameter) = 1 and cast(HubDiameter as int)>=18
                 then (case when OrderModel=0 then Piece else -Piece end) end) as BigSizeCount
    from BaseOrders
    where OrderType = 4 and CheckStatus=1 and FinanceSecondCheck=1
    group by HouseID, TypeID
)
, ClickStats as (
    select a.HouseID, c.TypeID, count(1) as ClickCount
    from Tbl_Cargo_ProductAccessDetails a
    inner join Tbl_WX_Client b on a.wxOpenID = b.wxOpenID
    inner join Tbl_Cargo_ProductSpec c on a.ProductCode = c.ProductCode
    where  a.AccessTime >= '{entity.StartDate.ToString("yyyy-MM-dd")}'
      and a.AccessTime <= '{entity.EndDate.AddDays(1).AddMilliseconds(-1).ToString("yyyy-MM-dd HH:mm:ss")}'
        {(entity.TypeID == 0 ? "" : $@" and c.TypeID = {entity.TypeID}")} 
     {(entity.HouseID == 0 ? "" : $@"and a.HouseID = {entity.HouseID}")} 
    group by a.HouseID, c.TypeID
)
select
    a2.*,
    isnull(d.StockNum, 0) as StockNum,
    isnull(c.ProCount, 0) as ProCount,
    isnull(c.ProCountAll, 0) as ProCountAll,
    isnull(c.ProPiece, 0) as ProPiece,
    isnull(dd.UniqueClientCount, 0) as UniqueClientCount,
    isnull(dd.UniqueClientNum, 0) as UniqueClientNum,
    isnull(ee.ClickCount, 0) as ClickCount,
    isnull(a4.Piece, 0) as PrevMonthPiece,
    isnull(a4.Count, 0) as PrevMonthCount,
    isnull(a5.SizeCount, 0) as SizeCount,
    isnull(a5.BigSizeCount, 0) as BigSizeCount
from (
    select a.TypeID, a.HouseID,
           sum(case when OrderModel=0 then Piece else -Piece end) as Piece,
           count(distinct case when OrderModel=0 then ProductCode end) as Count,
           b.TypeName, c.Name as HouseName
    from Tbl_Cargo_OrderDayStatistics a
    inner join Tbl_Cargo_ProductType b on a.TypeID = b.TypeID
    inner join Tbl_Cargo_House c on a.HouseID = c.HouseID
    where  a.DayStatisticsTime >= '{entity.StartDate.ToString("yyyy-MM-dd")}'
      and a.DayStatisticsTime <= '{entity.EndDate.AddDays(1).AddMilliseconds(-1).ToString("yyyy-MM-dd HH:mm:ss")}'
   {(entity.TypeID == 0 ? "" : $@" and a.TypeID =  {entity.TypeID}")} 
     {(entity.HouseID == 0 ? "" : $@"and a.HouseID = {entity.HouseID}")} 
    {(entity.SuppClientNum != 0 ? $@" and a.SuppID=@SuppID" : "")}
    {(entity.OrderType != 0 ? $@" and ThrowGood=@OrderType" : "")} 
    group by a.TypeID, a.HouseID, b.TypeName, c.Name
) a2
left join (
    select HouseID, TypeID, count(StockNum) as StockNum
    from Tbl_Cargo_SafeStock
    group by HouseID, TypeID
) d on a2.TypeID = d.TypeID and a2.HouseID = d.HouseID
left join (
    select b.TypeID, e.HouseID,
           count(distinct case when b.Piece<>0 then ProductCode end) as ProCount,
           count(distinct ProductCode) as ProCountAll,
           sum(b.Piece) as ProPiece
    from Tbl_Cargo_Product a
    inner join Tbl_Cargo_ContainerGoods b on a.ProductID = b.ProductID
    inner join Tbl_Cargo_Container c on c.ContainerID = b.ContainerID
    inner join Tbl_Cargo_Area d on c.AreaID = d.AreaID
    inner join Tbl_Cargo_House e on d.HouseID = e.HouseID
    where a.InCargoStatus in (1,2) and a.SpecsType=4
    group by b.TypeID, e.HouseID
) c on a2.TypeID = c.TypeID and a2.HouseID = c.HouseID
left join OrderStats dd on a2.TypeID=dd.TypeID and a2.HouseID=dd.HouseID
left join ClickStats ee on a2.TypeID=ee.TypeID and a2.HouseID=ee.HouseID
left join (
    select a.TypeID, a.HouseID,
           sum(case when OrderModel=0 then Piece else -Piece end) as Piece,
           count(distinct case when OrderModel=0 then ProductCode end) as Count
    from Tbl_Cargo_OrderDayStatistics a
    where  a.DayStatisticsTime >= '{PrevMonthStart.ToString("yyyy-MM-dd")}'
      and a.DayStatisticsTime <= '{PrevMonthEnd.AddDays(1).AddMilliseconds(-1).ToString("yyyy-MM-dd HH:mm:ss")}'
     {(entity.TypeID == 0 ? "" : $@" and a.TypeID = {entity.TypeID}")} 
     {(entity.HouseID == 0 ? "" : $@"and a.HouseID = {entity.HouseID}")} 
    {(entity.SuppClientNum != 0 ? $@" and a.SuppID=@SuppID" : "")}
    {(entity.OrderType != 0 ? $@" and ThrowGood=@OrderType" : "")} 
    group by a.TypeID, a.HouseID
) a4 on a2.TypeID=a4.TypeID and a2.HouseID=a4.HouseID
left join BigSizeStats a5 on a2.TypeID=a5.TypeID and a2.HouseID=a5.HouseID
order by a2.Piece desc;

";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                if (entity.SuppClientNum != 0)
                {
                    conn.AddInParameter(cmd, "@SuppID", DbType.Int32, Convert.ToInt32(entity.SuppClientNum));
                }
                if (entity.OrderType != 0)
                {
                    conn.AddInParameter(cmd, "@OrderType", DbType.Int32, Convert.ToInt32(entity.OrderType));
                }
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoOrderDayStatisticsEntity
                        {
                            HouseName = Convert.ToString(idrCount["HouseName"]),
                            HouseID = Convert.ToInt32(idrCount["HouseID"]),
                            TypeID = Convert.ToInt32(idrCount["TypeID"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            Piece = Convert.ToInt32(idrCount["Piece"]),
                            DayStatisticsCount = Convert.ToInt32(idrCount["Count"]),
                            StockNum = Convert.ToInt32(idrCount["StockNum"]),
                            ProCount = Convert.ToInt32(idrCount["ProCount"]),
                            ProCountAll = Convert.ToInt32(idrCount["ProCountAll"]),
                            ProPiece = Convert.ToInt32(idrCount["ProPiece"]),
                            UniqueClientCount = Convert.ToInt32(idrCount["UniqueClientCount"]),
                            UniqueClientNum = Convert.ToInt32(idrCount["UniqueClientNum"]),
                            clickCount = Convert.ToInt32(idrCount["clickCount"]),
                            PrevMonthPiece = Convert.ToInt32(idrCount["PrevMonthPiece"]),
                            PrevMonthCount = Convert.ToInt32(idrCount["PrevMonthCount"]),
                            SizeCount = Convert.ToInt32(idrCount["SizeCount"]),
                            BigSizeCount = Convert.ToInt32(idrCount["BigSizeCount"]),
                        });
                    }
                }
            }
            return result;


        }

        public List<CargoOrderDayStatisticsEntity> GetSalesRateDetail(CargoHouseAimEntity entity)
        {
            List<CargoOrderDayStatisticsEntity> result = new List<CargoOrderDayStatisticsEntity>();
            string strSQL = $@"
                  select a1.*,isnull(a2.ProPiece,0) as ProPiece,isnull(a2.ProCount,0) as ProCount from (
                select a.TypeID,
                         a.HouseID,
                         sum(case when OrderModel = 0 then Piece else -Piece end) Piece,
                         count(a.ProductCode) as                           Count,
                         b.TypeName,
                         c.Name                                                   HouseName
                        ,a.ProductCode,d.ProductName,d.Specs
                  from Tbl_Cargo_OrderDayStatistics as a
                           inner join Tbl_Cargo_ProductType as b on a.TypeID = b.TypeID
                           inner join Tbl_Cargo_ProductSpec as d on a.ProductCode = d.ProductCode
                           inner join Tbl_Cargo_House as c on a.HouseID = c.HouseID
                  where a.TypeID = @TypeID and a.HouseID=@HouseID {(entity.OrderType != 0 ? $@" and ThrowGood=@OrderType" : "")} {(entity.SuppClientNum != 0 ? $@" and a.SuppID=@SuppID" : "")}
                         and DayStatisticsTime >= @StartDate and DayStatisticsTime<=@EndDate
                  group by a.TypeID, a.HouseID, b.TypeName, c.Name,a.ProductCode,d.ProductName,d.Specs
                          ) as a1
            left join (
                select b.TypeID, e.HouseID, a.ProductCode,count(1) as ProCount , sum(b.Piece) as ProPiece
                                from Tbl_Cargo_Product as a
                                         inner join Tbl_Cargo_ContainerGoods as b on a.ProductID = b.ProductID
                                         inner join Tbl_Cargo_Container as c on c.ContainerID = b.ContainerID
                                         inner join Tbl_Cargo_Area as d on c.AreaID = d.AreaID
                                         inner join Tbl_Cargo_House as e on d.HouseID = e.HouseID
                                where a.InCargoStatus in (1, 2)
                                  and b.Piece <> 0
                                  and isnull(ProductCode,'')<>''
                                  AND A.SpecsType IN (4)
                                group by b.TypeID, e.HouseID,ProductCode
            ) as a2  on a1.TypeID = a2.TypeID and a1.HouseID = a2.HouseID and a1.ProductCode = a2.ProductCode
            order by Piece desc 
      ";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@StartDate", DbType.DateTime, (entity.StartDate));
                conn.AddInParameter(cmd, "@EndDate", DbType.DateTime, (entity.EndDate));
                conn.AddInParameter(cmd, "@TypeID", DbType.Int32, Convert.ToInt32(entity.TypeID));
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, Convert.ToInt32(entity.HouseID));
                if (entity.SuppClientNum != 0)
                {
                    conn.AddInParameter(cmd, "@SuppID", DbType.Int32, Convert.ToInt32(entity.SuppClientNum));
                }
                if (entity.OrderType != 0)
                {
                    conn.AddInParameter(cmd, "@OrderType", DbType.Int32, Convert.ToInt32(entity.OrderType));
                }
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoOrderDayStatisticsEntity
                        {
                            ProductCode = Convert.ToString(idrCount["ProductCode"]),
                            ProductName = Convert.ToString(idrCount["ProductName"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            HouseName = Convert.ToString(idrCount["HouseName"]),
                            HouseID = Convert.ToInt32(idrCount["HouseID"]),
                            TypeID = Convert.ToInt32(idrCount["TypeID"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            Piece = Convert.ToInt32(idrCount["Piece"]),
                            DayStatisticsCount = Convert.ToInt32(idrCount["Count"]),
                            ProCount = Convert.ToInt32(idrCount["ProCount"]),
                            ProPiece = Convert.ToInt32(idrCount["ProPiece"]),
                        });
                    }
                }
            }
            return result;


        }
        public List<CargoOrderDayStatisticsEntity> GetClickConversionRateDetail(CargoHouseAimEntity entity)
        {
            List<CargoOrderDayStatisticsEntity> result = new List<CargoOrderDayStatisticsEntity>();
            string strSQL = $@"
SET ARITHABORT ON;
                            with AccessStats AS
    (SELECT a.HouseID,
         c.TypeID,
         a.ProductCode,
         count(1) AS ClickCount
    FROM Tbl_Cargo_ProductAccessDetails a
    INNER JOIN Tbl_WX_Client b
        ON a.wxOpenID = b.wxOpenID
    INNER JOIN Tbl_Cargo_ProductSpec c
        ON a.ProductCode = c.ProductCode
    WHERE a.AccessTime >= '{entity.StartDate.ToString("yyyy-MM-dd")}'
            AND a.AccessTime < '{entity.EndDate.AddDays(1).ToString("yyyy-MM-dd")}'
            AND c.TypeID = {entity.TypeID}
            AND a.HouseID = {entity.HouseID}
    GROUP BY  a.HouseID, c.TypeID, a.ProductCode), OrderStats AS 
    (SELECT h.TypeID,
         c.HouseID,
         ProductCode,
         COUNT(DISTINCT c.ID) AS UniqueClientCount,
         sum(case
        WHEN OrderModel = 1 THEN
        -orderGoods.Piece
        ELSE orderGoods.Piece end) AS UniqueClientNum
    FROM Tbl_WX_Order c
    INNER JOIN Tbl_WX_Client a
        ON a.ID = c.WXID
    INNER JOIN Tbl_Cargo_Order d
        ON c.OrderNo = d.WXOrderNo
    INNER JOIN Tbl_Cargo_OrderGoods orderGoods
        ON d.OrderNo = orderGoods.OrderNo
    INNER JOIN Tbl_Cargo_Product h
        ON h.ProductID = orderGoods.ProductID
    WHERE c.CreateDate >= '{entity.StartDate.ToString("yyyy-MM-dd")}'
            AND c.CreateDate < '{entity.EndDate.AddDays(1).ToString("yyyy-MM-dd")}'
            AND h.TypeID = {entity.TypeID}
            AND c.HouseID = {entity.HouseID}
    GROUP BY  h.TypeID, c.HouseID, ProductCode )
SELECT a1.HouseID,
         a1.TypeID,
         a1.ProductCode,
         ps.ProductName,
         pt.TypeName,
         ps.Specs,
         h.Name AS HouseName,
         a1.ClickCount,
         isnull(a2.UniqueClientCount,
         0) AS UniqueClientCount,
         isnull(a2.UniqueClientNum,
         0) AS UniqueClientNum
FROM AccessStats a1
LEFT JOIN OrderStats a2
    ON a1.TypeID = a2.TypeID
        AND a1.HouseID = a2.HouseID
        AND a1.ProductCode = a2.ProductCode
INNER JOIN Tbl_Cargo_ProductSpec ps
    ON a1.ProductCode = ps.ProductCode
INNER JOIN Tbl_Cargo_ProductType pt
    ON ps.TypeID = pt.TypeID
INNER JOIN Tbl_Cargo_House h
    ON a1.HouseID = h.HouseID
ORDER BY  a2.UniqueClientCount desc, a1.ClickCount desc; 
      ";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoOrderDayStatisticsEntity
                        {
                            ProductCode = Convert.ToString(idrCount["ProductCode"]),
                            ProductName = Convert.ToString(idrCount["ProductName"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            HouseName = Convert.ToString(idrCount["HouseName"]),
                            HouseID = Convert.ToInt32(idrCount["HouseID"]),
                            TypeID = Convert.ToInt32(idrCount["TypeID"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            UniqueClientCount = Convert.ToInt32(idrCount["UniqueClientCount"]),
                            UniqueClientNum = Convert.ToInt32(idrCount["UniqueClientNum"]),
                            clickCount = Convert.ToInt32(idrCount["clickCount"]),
                        });
                    }
                }
            }
            return result;


        }
        public List<CargoOrderDayStatisticsEntity> GetLargeSpecRatioDetail(CargoHouseAimEntity entity)
        {
            List<CargoOrderDayStatisticsEntity> result = new List<CargoOrderDayStatisticsEntity>();
            string strSQL = $@"
                select * from (
                SELECT ProductCode,b.TypeID, a.HouseID, b.TypeName, cc.Name as HouseName,Specs
,sum(case when ISNUMERIC(HubDiameter) = 1 and cast(HubDiameter as int)>=18 then (case when OrderModel=0 then orderGoods.Piece else -orderGoods.Piece end) end) BigSizeCount
                FROM Tbl_Cargo_Order as a
                         inner join Tbl_Cargo_OrderGoods orderGoods on a.OrderNo = orderGoods.OrderNo and a.HouseID = orderGoods.HouseID
                         inner join Tbl_Cargo_Product as c on orderGoods.ProductID = c.ProductID
                         inner join Tbl_Cargo_ProductType as b on c.TypeID = b.TypeID
                         inner join Tbl_Cargo_House as cc on a.HouseID = cc.HouseID
                where  c.TypeID = @TypeID and a.HouseID = @HouseID and ISNUMERIC(HubDiameter) = 1
                  and a.CreateDate >= @StartDate
                  AND a.CreateDate <@EndDate  and CheckStatus=1 and a.FinanceSecondCheck=1 and a.OrderType = '4'
                group by ProductCode,b.TypeID, a.HouseID, b.TypeName, cc.Name,Specs
                  ) as a1 where BigSizeCount>0
                order by BigSizeCount desc
      ";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@StartDate", DbType.DateTime, (entity.StartDate));
                conn.AddInParameter(cmd, "@EndDate", DbType.DateTime, (entity.EndDate.AddDays(1)));
                conn.AddInParameter(cmd, "@TypeID", DbType.Int32, Convert.ToInt32(entity.TypeID));
                conn.AddInParameter(cmd, "@HouseID", DbType.Int32, Convert.ToInt32(entity.HouseID));
                if (entity.SuppClientNum != 0)
                {
                    conn.AddInParameter(cmd, "@SuppID", DbType.Int32, Convert.ToInt32(entity.SuppClientNum));
                }
                if (entity.OrderType != 0)
                {
                    conn.AddInParameter(cmd, "@OrderType", DbType.Int32, Convert.ToInt32(entity.OrderType));
                }
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoOrderDayStatisticsEntity
                        {
                            ProductCode = Convert.ToString(idrCount["ProductCode"]),
                            Specs = Convert.ToString(idrCount["Specs"]),
                            HouseName = Convert.ToString(idrCount["HouseName"]),
                            HouseID = Convert.ToInt32(idrCount["HouseID"]),
                            TypeID = Convert.ToInt32(idrCount["TypeID"]),
                            TypeName = Convert.ToString(idrCount["TypeName"]),
                            BigSizeCount = Convert.ToInt32(idrCount["BigSizeCount"]),
                        });
                    }
                }
            }
            return result;


        }
        /// <summary>
        /// 查询慧采云仓访问请求数据
        /// </summary>
        /// <param name="entity"></param>
        /// <returns></returns>
        public List<CargoOrderDayStatisticsEntity> QueryHCYC_TotalDays(CargoHouseAimEntity entity)
        {
            List<CargoOrderDayStatisticsEntity> result = new List<CargoOrderDayStatisticsEntity>();
            string strSQL = $@"
            select Year,Month,Day,sum(case when OrderModel=0 then Piece else -Piece end) as Piece, AimQuantity
            from Tbl_Cargo_OrderDayStatistics as a
            left join (
                select AimYear,AimMonth,sum(AimQuantity) as AimQuantity from Tbl_Cargo_HouseAim as aa
                         group by AimYear,AimMonth
            ) as b on a.Year=b.AimYear and a.Month=b.AimMonth
            where Year={entity.EndDate.Year} and Month={entity.EndDate.Month}
             {(entity.OrderType == 0 ? "" : $@" and ThrowGood=" + entity.OrderType)}
            group by Year,Month,Day, AimQuantity
            ";
            strSQL += " order by Year,Month,Day";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoOrderDayStatisticsEntity
                        {
                            Piece = Convert.ToInt32(idrCount["Piece"]),
                            MonthAimQuantity = Convert.ToInt32(idrCount["AimQuantity"]),
                            Year = Convert.ToInt32(idrCount["Year"]),
                            Month = Convert.ToInt32(idrCount["Month"]),
                            Day = Convert.ToInt32(idrCount["Day"]),
                        });
                    }
                }
            }
            return result;

        }
        public List<CargoOrderDayStatisticsEntity> QueryHCYC_TotalMonths(CargoHouseAimEntity entity)
        {
            List<CargoOrderDayStatisticsEntity> result = new List<CargoOrderDayStatisticsEntity>();
            string strSQL = $@"
            select Year,Month,sum(case when OrderModel=0 then Piece else -Piece end) as Piece, isnull(AimQuantity,0) as AimQuantity
            from Tbl_Cargo_OrderDayStatistics as a
            left join (
                select AimYear,AimMonth,sum(AimQuantity) as AimQuantity from Tbl_Cargo_HouseAim as aa
                         group by AimYear,AimMonth
            ) as b on a.Year=b.AimYear and a.Month=b.AimMonth
            where Year={entity.EndDate.Year}
            group by Year,Month, AimQuantity
            ";
            strSQL += " order by Year,Month";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoOrderDayStatisticsEntity
                        {
                            Piece = Convert.ToInt32(idrCount["Piece"]),
                            MonthAimQuantity = Convert.ToInt32(idrCount["AimQuantity"]),
                            Year = Convert.ToInt32(idrCount["Year"]),
                            Month = Convert.ToInt32(idrCount["Month"]),
                        });
                    }
                }
            }
            return result;

        }

        public List<HouseEntity> CargoPermisionHouse()
        {
            List<HouseEntity> result = new List<HouseEntity>();
            string strSQL = $@"select HouseID as ID,Name from Tbl_Cargo_House where BelongHouse=6";
            strSQL += " order by HouseID";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new HouseEntity
                        {
                            ID = Convert.ToInt32(idrCount["ID"]),
                            Name = Convert.ToString(idrCount["Name"]),
                        });
                    }
                }
            }
            return result;
        }

        public List<CargoOrderDayStatisticsEntity> QueryHCYC_UserData(CargoHouseAimEntity entity)
        {
            List<CargoOrderDayStatisticsEntity> result = new List<CargoOrderDayStatisticsEntity>();
            string strSQL = $@"
          --用户，门店数据
;with AllCount as (
   select a.HouseID
           , count(distinct case when b.ClientNum is not null and b.OP_DATE >= @StartDate and b.OP_DATE <= @EndDate  and b.OP_DATE BETWEEN @StartDate AND @EndDate then b.ClientNum end) ClientCount
          ,count(distinct case when b.ClientNum is not null then b.ClientNum end) AllClientCount
          , count(distinct case when b.OP_DATE >= @StartDate and b.OP_DATE <= @EndDate  and b.OP_DATE BETWEEN @StartDate AND @EndDate  then b.ID end) as UserCount
     , count(distinct b.ID) as AllUserCount
     from Tbl_Cargo_Client as a
inner join Tbl_WX_Client as b on a.ClientNum=b.ClientNum
group by a.HouseID
              )
   --销售数据
  , SaleData as (select a.HouseID,
                         sum(case when OrderModel = 0 then Piece else -Piece end) Piece,
                         count(distinct case when OrderModel = 0 then ProductCode end) as Count
                  from Tbl_Cargo_OrderDayStatistics as a
                           inner join Tbl_Cargo_ProductType as b on a.TypeID = b.TypeID
                           inner join Tbl_Cargo_House as c on a.HouseID = c.HouseID
                  where 1 = 1
                    and DayStatisticsTime >= @StartDate
                    and DayStatisticsTime <= @EndDate
                  group by a.HouseID)
    --在库数据
   , InventoryData as (select e.HouseID
                            , count(distinct case when b.Piece <> 0 then ProductCode end) as ProCount
                            , count(distinct ProductCode)                                 as ProCountAll
                            , sum(b.Piece)                                                as ProPiece
                       from Tbl_Cargo_Product as a
                                inner join Tbl_Cargo_ContainerGoods as b on a.ProductID = b.ProductID
                                inner join Tbl_Cargo_Container as c on c.ContainerID = b.ContainerID
                                inner join Tbl_Cargo_Area as d on c.AreaID = d.AreaID
                                inner join Tbl_Cargo_House as e on d.HouseID = e.HouseID
                       where a.InCargoStatus in (1, 2) and IsLockStock = '0' AND A.SpecsType IN (4)
                       group by e.HouseID)
          --用户交易数据
          ,UserTransaction as (
               select HouseID, COUNT(DISTINCT wxClients.ID) AS UserUniqueClientCount
             , COUNT(DISTINCT wxClients.ClientNum) AS StoresUniqueClientCount from Tbl_Cargo_Order as a
               inner join Tbl_WX_Client as wxClients on wxClients.ClientNum = a.ClientNum
                where  a.CreateDate >= @StartDate and a.CreateDate <= @EndDate  and a.OrderType = '4'
                group by HouseID
          )
        --数据汇总
  , ReusltData as (select orders.HouseID, count(distinct case when OrderModel = 0 then orders.OrderNo end) as OrderCount , count(distinct case when OrderModel = 0 then ProductCode end) as DayStatisticsCount
                    from Tbl_Cargo_Order as orders
                             inner join Tbl_Cargo_OrderGoods as orderGoods
                                        on orders.OrderNo = orderGoods.OrderNo and orders.HouseID = orderGoods.HouseID
                             inner join Tbl_Cargo_Product as ee on ee.ProductID = orderGoods.ProductID
                             left join Tbl_Cargo_Area as c on orderGoods.AreaID = c.AreaID
                    where orders.CreateDate >= @StartDate and orders.CreateDate <= @EndDate  and orders.OrderType = '4'
                    group by orders.HouseID)

        select ac.HouseID, house.Name HouseName, isnull(sum(orders.DayStatisticsCount),0) as DayStatisticsCount, isnull(sum(orders.OrderCount),0) as OrderCount,isnull(ac.ClientCount, 0) as ClientCount, isnull(ac.UserCount, 0) as UserCount
             , isnull(ut.UserUniqueClientCount,0) AS UserUniqueClientCount
             , isnull(ut.StoresUniqueClientCount,0)  AS StoresUniqueClientCount
             , isnull(sales.Count,0) as Count, isnull(sales.Piece,0) Piece, isnull(inventory.ProCount,0) as ProCount
             , isnull(inventory.ProCountAll,0) as ProCountAll, isnull(ac.AllClientCount,0) as AllClientCount
             , isnull(ac.AllUserCount,0) as AllUserCount
        from AllCount as ac
        inner join Tbl_Cargo_House house on ac.HouseID=house.HouseID
        left join ReusltData as orders on ac.HouseID=orders.HouseID
        left join SaleData as sales on sales.HouseID = orders.HouseID
        left join InventoryData as inventory on inventory.HouseID = orders.HouseID
        left join UserTransaction as ut on ut.HouseID = orders.HouseID
       group by ac.HouseID, house.Name, ac.ClientCount, ac.UserCount
       , sales.Count, sales.Piece, inventory.ProCount, inventory.ProCountAll
       , ac.AllUserCount, ac.AllClientCount,ut.UserUniqueClientCount,ut.StoresUniqueClientCount
                  ORDER BY HouseID DESC
      ";

            using (DbCommand cmd = conn.GetSqlStringCommond(strSQL))
            {
                conn.AddInParameter(cmd, "@StartDate", DbType.DateTime, (entity.StartDate.ToString("yyyy-MM-dd")));
                var EndDate = entity.EndDate.AddDays(1).AddMilliseconds(-1).ToString("yyyy-MM-dd HH:mm:ss");
                conn.AddInParameter(cmd, "@EndDate", DbType.DateTime, (EndDate));

                using (DataTable dt = conn.ExecuteDataTable(cmd))
                {
                    foreach (DataRow idrCount in dt.Rows)
                    {
                        result.Add(new CargoOrderDayStatisticsEntity
                        {
                            HouseName = Convert.ToString(idrCount["HouseName"]),
                            HouseID = Convert.ToInt32(idrCount["HouseID"]),
                            ClientCount = Convert.ToInt32(idrCount["ClientCount"]),
                            UserCount = Convert.ToInt32(idrCount["UserCount"]),
                            UserUniqueClientCount = Convert.ToInt32(idrCount["UserUniqueClientCount"]),
                            StoresUniqueClientCount = Convert.ToInt32(idrCount["StoresUniqueClientCount"]),
                            ProCount = Convert.ToInt32(idrCount["ProCount"]),
                            UniqueClientNum = Convert.ToInt32(idrCount["Piece"]),
                            UniqueClientCount = Convert.ToInt32(idrCount["OrderCount"]),
                            ProCountAll = Convert.ToInt32(idrCount["ProCountAll"]),
                            AllClientCount = Convert.ToInt32(idrCount["AllClientCount"]),
                            AllUserCount = Convert.ToInt32(idrCount["AllUserCount"]),
                            DayStatisticsCount = Convert.ToInt32(idrCount["DayStatisticsCount"]),
                        });
                    }
                }
            }
            return result;


        }
        #endregion
    }
}
