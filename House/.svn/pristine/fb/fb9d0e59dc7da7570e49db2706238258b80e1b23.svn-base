using Cargo.QY;
using Cargo.systempage;
using DocumentFormat.OpenXml.Spreadsheet;
using House.Business;
using House.Business.Cargo;
using House.Entity;
using House.Entity.Cargo;
using House.Entity.Cargo.Order;
using House.Entity.Dto;
using House.Manager;
using iText.Layout.Element;
using Newtonsoft.Json;
using NPOI.HSSF.Record.Formula.Functions;
using Senparc.Weixin.HttpUtility;
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net;
using System.Security.Cryptography;
using System.Security.Policy;
using System.ServiceModel;
using System.ServiceModel.Channels;
using System.Text;
using System.Text.RegularExpressions;
using System.Web;
using System.Windows.Interop;

namespace Cargo.Interface
{
    /// <summary>
    /// CassMallApi 的摘要说明
    /// </summary>
    public class CassMallApi : IHttpHandler
    {
        private Dictionary<string, string> sessionDic = new Dictionary<string, string>() {
                    {"4400000959","67d89f8d06ca4360ae0358279b7d283c" },//汕头狄乐汽配
                    {"4400004100","1f7bd12607104fd3a152daf7c1896bb0" },//深圳狄乐轮胎专营店
                    {"4500001699","2b2b36889e304645b28f94bfdd2ead9e" },//南宁狄乐轮胎专营店
                    {"4400018175","a027b23d19f941a59a361268fb94ab10" },//揭阳狄乐轮胎专营店
                    {"4400014726","43b87acafffe4919926ec17de7b6f930" },//东平狄乐轮胎专营店
                };
        private Dictionary<string, int> HouseDic = new Dictionary<string, int>() {
                    {"4400000959_WH033",101 },//汕头狄乐汽配
                    {"4400004100_WH034",91 },//深圳狄乐轮胎专营店
                    {"4500001699_CN_NNXXTC",136 },//南宁狄乐轮胎专营店
                    {"4400018175_CN_JYRCC",135 },//揭阳狄乐轮胎专营店
                    {"4400014726_CN_GZBYYPC",93 },//东平狄乐轮胎专营店
                    {"4400014726_CN_GZCHC",107 },//从化狄乐轮胎专营店
                };
#if DEBUG
        //private const string CassApi = "https://api-demo.casstime.com/api";
        //private const string CassSecret = "38476BFFE6274DBCAB38647884D467C6";

        private const string CassApi = "https://api.cassmall.com/api";
        private const string CassSecret = "38476BFFE6274DBCAB38647884D467C6";
#else
        private const string CassApi = "https://api.cassmall.com/api";
        private const string CassSecret = "38476BFFE6274DBCAB38647884D467C6";
#endif
        public void ProcessRequest(HttpContext context)
        {
            //context.Response.ContentType = "text/plain";
            //context.Response.Write("Hello World");
            CargoInterfaceBus nwBus = new CargoInterfaceBus();
            //string appKey = context.Request.Headers["appKey"];
            //string apiName = context.Request.Headers["apiName"];
            //string session = context.Request.Headers["session"];
            //string timestamp = context.Request.Headers["timestamp"];
            //string sign = context.Request.Headers["sign"];
            // 读取请求体
            using (var reader = new StreamReader(context.Request.InputStream, Encoding.UTF8))
            {
                var requestBody = reader.ReadToEnd();

                // 解析 JSON 数据
                var callbackData = JsonConvert.DeserializeObject<CassMallDTO>(requestBody);
                if (callbackData != null)
                {
                    callbackData.requestParam = new RequestParam
                    {
                        appKey = "gzshly60be866dbe52",
                        session = sessionDic[callbackData.pushTargetId],
                    };
                    //保存 推送记录
                    nwBus.AddCassMallData(new CargoCassMallEntity { SourceType = 0, SourceAction = "API", orderId = callbackData.data.orderId, ResJson = requestBody });

                    // TODO: 根据 callbackData 执行相应的业务逻辑
                    TaskExecution(callbackData);

                    // 返回 200 状态码
                    context.Response.StatusCode = 200;
                    context.Response.Write("{\"status\": \"success\"}");
                }
                else
                {
                    // 返回 -1 失败 状态码
                    context.Response.StatusCode = -1;
                    context.Response.Write("{\"status\": \"error\"}");
                }

            }

        }

        #region Notice处理映射
        private const string Notice_OrderPayed = "cassec.push.order.payed";
        private const string Notice_OrderModified = "cassec.push.order.modified";
        private const string Notice_OrderCancelled = "cassec.push.order.cancelled";

        private static readonly IDictionary<string, Action<CassMallApi, CassMallDTO>> _noticeHandlers =
            new Dictionary<string, Action<CassMallApi, CassMallDTO>>(StringComparer.OrdinalIgnoreCase)
            {
                { Notice_OrderPayed, (api, dto) => api.AddMassCallOrder(dto) },
                { Notice_OrderModified, (api, dto) => api.UpdateMassCallOrder(dto) },
                { Notice_OrderCancelled, (api, dto) => api.MassCallOrderCancelled(dto) }
            };
        #endregion

        public void TaskExecution(CassMallDTO notice)
        {
            if (notice == null)
            {
                Common.WriteTextLog("CassMall notice 为空");
                return;
            }
            if (string.IsNullOrWhiteSpace(notice.noticeName))
            {
                Common.WriteTextLog("CassMall noticeName 为空");
                return;
            }

            Action<CassMallApi, CassMallDTO> handler;
            if (_noticeHandlers.TryGetValue(notice.noticeName, out handler))
            {
                try
                {
                    handler(this, notice);
                }
                catch (Exception ex)
                {
                    Common.WriteTextLog("CassMall 处理通知失败:" + notice.noticeName + " => " + ex);
                }
            }
            else
            {
                Common.WriteTextLog("CassMall 未知通知类型:" + notice.noticeName);
            }
        }
        /// <summary>
        /// 创建订单
        /// </summary>
        /// <param name="notice"></param>
        public void AddMassCallOrder(CassMallDTO notice)
        {
            CargoInterfaceBus nwBus = new CargoInterfaceBus();
            CargoOrderBus Bus = new CargoOrderBus();
            try
            {

                //获取订单信息
                string url = CassApi + "?orderId=" + notice.data.orderId;
                var dataStr = PostHttpRequest(url, "", "cassec.order.detail.get"
                    , sessionDic[notice.pushTargetId]
                    , notice.requestParam.appKey);
                var dataString = JsonConvert.DeserializeObject<CassMallStr>(dataStr);
                var datas = dataString.result;
                //保存日志
                if (datas != null)
                {
                    nwBus.AddCassMallData(new CargoCassMallEntity { SourceType = 1, SourceAction = "AddMassCallOrder", orderId = notice.data.orderId, ResJson = dataStr });
                }
                //开思数据同步保存到系统
                foreach (var item in datas.OrderItems)
                {
                    item.ThirdPartySystemStr = JsonConvert.SerializeObject(item.ThirdPartySystem);
                }
                var cassHouseStr = datas.OrderPostalAddress.OrderWayDetails[0].FacilityId;
                datas.OrderHeader.OrderHouseID = HouseDic[$@"{notice.token.productStoreId}_{cassHouseStr}"];
                if (nwBus.AddCassMallDto(datas))
                {
                    Broadcast(datas);

                    //自动开单 定向单不开
                    if (datas.OrderHeader.OriginalSource != "DIRECTIONAL")
                    {
                        AutomaticCreateCassMallOrder(datas);
                    }
                    //开思订单审核
                    SendOrderAudit(new CassMallPushParam { orderId= notice.data.orderId }, notice);
                }

            }
            catch (Exception ex)
            {
                Common.WriteTextLog("CassMall Synchronization 订单数据失败：" + ex.ToString());
            }
        }


        public void AutomaticCreateCassMallOrder(OrderDto datas)
        {
            CargoInterfaceBus interfaceBus = new CargoInterfaceBus();
            CargoOrderBus Bus = new CargoOrderBus();
            CargoHouseBus HouseBus = new CargoHouseBus();
            CargoFinanceBus financeBus = new CargoFinanceBus();
            CargoClientBus clientBus = new CargoClientBus();
            LogWrite<CargoOrderEntity> lw = new LogWrite<CargoOrderEntity>();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "开思开单";
            log.UserID = "机器人";
            log.Operate = "A";
            Dictionary<long, int> batchDic = new Dictionary<long, int>();
            try
            {
                log.Memo = $@"[{datas.OrderHeader.OrderId}]开始自动开单";
                lw.WriteLog(log);

                decimal originalPrice = 0M;
                //获取产品映射，判断其是否符合
                var ProductMap = Bus.QueryPartNumberMap(new CargoProductEntity { ProductCodeStr = $@"'{string.Join("','", datas.OrderItems.Select(a => a.PartsNum).Distinct())}'" });
                //明细必须全部开单
                if (ProductMap.Count < datas.OrderItems.Count)
                {
                    log.Status = "1";
                    log.Memo = $@"[{datas.OrderHeader.OrderId}]未找到映射编码";
                    lw.WriteLog(log);
                    return;
                }
                //获取仓库
                var HouseID = datas.OrderHeader.OrderHouseID;
                var AreaData = financeBus.GetAreaData(HouseID);
                if (AreaData.IsCassAutoOrder == 0)
                {
                    log.Status = "1";
                    log.Memo = $@"[{datas.OrderHeader.OrderId}]该仓库未设置自动开单";
                    lw.WriteLog(log);
                    return;
                }
                var AreaID = AreaData.AreaID;
                var AcceptPeople = datas.OrderPostalAddress.ReceiverName;//收貨人
                var contactNumber = datas.OrderPostalAddress.ContactNumber;//
                var Dest = datas.OrderPostalAddress.CityGeoName.Replace("市", "");
                var AcceptAddress = datas.OrderPostalAddress.Address;
                var SaleManID = AreaData.LoginName;
                var SaleManName = AreaData.Person;
                var SaleCellPhone = AreaData.Cellphone;
                var ClientNum = 165462;

                var goods = interfaceBus.QueryCassMallOrderGoods(new OrderHeader { OrderId = datas.OrderHeader.OrderId });
                var Adjustments = interfaceBus.QueryCassMallItemAdjustments(new OrderHeader { OrderId = datas.OrderHeader.OrderId });
                var GiftItems = interfaceBus.QueryCassMallGiftItems(new OrderHeader { OrderId = datas.OrderHeader.OrderId });
                var WayDetails = interfaceBus.QueryCassMallWayDetails(new OrderHeader { OrderId = datas.OrderHeader.OrderId }).FirstOrDefault();

                CargoOrderEntity ent = new CargoOrderEntity();
                List<CargoOrderGoodsEntity> entDest = new List<CargoOrderGoodsEntity>();
                List<CargoContainerShowEntity> outHouseList = new List<CargoContainerShowEntity>();

                CargoHouseEntity houseEnt = HouseBus.QueryCargoHouseByID(HouseID);
                CargoAreaEntity areaEntity = HouseBus.QueryAreaByAreaID(new CargoAreaEntity { AreaID = AreaID });


                CargoClientEntity clientEntity = clientBus.QueryCargoClient(ClientNum, 0);

                decimal OverDayFee = 0.00M;//超期费用

                if (areaEntity.AreaID.Equals(0))
                {
                    log.Status = "1";
                    log.Memo = $@"[{datas.OrderHeader.OrderId}]无出库仓库";
                    lw.WriteLog(log);
                    return;
                }
                ent.OpenOrderNo = datas.OrderHeader.OrderId;
                ent.OpenOrderSource = "2";//开思订单
                ent.Dep = areaEntity.OrderDep;
                ent.Dest = Dest;
                int OrderNum = 0;
                ent.HouseID = areaEntity.HouseID;
                ent.LogisID = areaEntity.LogisID;
                ent.Rebate = 0;
                ent.CheckOutType = clientEntity.CheckOutType;// "5";//Convert.ToString(row["CheckOutType"]);
                var DeliveryType = "0";
                if (WayDetails != null)
                {
                    DeliveryType = WayDetails.CompanyId == "PICKED_INSTORE" ? "1" : "0";
                }
                ent.TrafficType = "0";// Convert.ToString(row["TrafficType"]);
                ent.DeliveryType = DeliveryType;//Convert.ToString(row["DeliveryType"]);
                ent.AcceptUnit = clientEntity.ClientName;//Convert.ToString(row["AcceptUnit"]);取公司名称
                ent.AcceptAddress = AcceptAddress;
                ent.AcceptPeople = AcceptPeople;
                ent.AcceptTelephone = contactNumber;
                ent.AcceptCellphone = contactNumber;
                ent.CreateAwb = "机器人";//好来运系统
                ent.CreateAwbID = "2019";
                ent.CreateDate = DateTime.Now;
                ent.OP_ID = "2019";
                ent.SaleManID = SaleManID; //clientEntity.UserID;// 业务员ID
                ent.SaleManName = SaleManName; //clientEntity.UserName;// 业务员姓名
                ent.SaleCellPhone = SaleCellPhone;
                ent.Remark = "";
                //ent.CouponID = string.IsNullOrEmpty(CouponID) ? 0 : Convert.ToInt64(CouponID);
                //ent.CouponIDList = couponIDList;
                ent.ThrowGood = "22";
                ent.BusinessID = "22";
                ent.MarketType = "2";
                ent.IsPrintPrice = 1;
                ent.TranHouse = "";
                ent.PostponeShip = "1";
                ent.ClientNum = clientEntity.ClientNum;
                ent.PayClientNum = clientEntity.ClientNum;
                ent.PayClientName = clientEntity.Boss;//付款人客户姓名
                                                      //ent.ClientID = wxUser.ClientID;
                string outID = DateTime.Now.ToString("yyMMdd") + Common.GetRandomFourNumString();//出库单号
                ent.OrderNo = Common.GetMaxOrderNumByCurrentDate(ent.HouseID, houseEnt.HouseCode, out OrderNum); // Convert.ToString(row["OrderNo"]);//生成最新顺序订单号
                ent.OutHouseName = houseEnt.Name;
                ent.OrderType = "4";
                ent.AwbStatus = "0";

                int pieceSum = 0;
                string proStr = string.Empty;
                var AdjustmentsSum = 0M;//优惠卷

                foreach (var itt in goods)
                {
                    pieceSum += Convert.ToInt32(itt.Quantity);
                    int piece = Convert.ToInt32(itt.Quantity);

                    var AdjustmentsCurrItemSum = 0M;
                    //优惠卷
                    var AdjustmentsItems = Adjustments.Where(a => a.OrderItemSeqId == itt.OrderItemSeqId).ToList();
                    if (AdjustmentsItems != null && AdjustmentsItems.Count > 0)
                    {
                        var AdjustmentsSums = AdjustmentsItems.Sum(a => a.AdjustmentAmount);
                        AdjustmentsSum += Convert.ToDecimal(AdjustmentsSums) * piece;
                        AdjustmentsCurrItemSum = Convert.ToDecimal(AdjustmentsSums);
                    }

                    //查找系统对应产品编码
                    List<CargoProductEntity> cargos = new List<CargoProductEntity>();

                    //var pmappings = ProductMappingList.Where(c => c.CassCode == itt.PartsNum).ToList();
                    //var data = interfaceBus.GetProductMapping(new OrderItem() { PartsNum = itt.PartsNum });
                    //cargos = data.Select(a => new CargoProductEntity { ProductCode = a.ProductCode, TypeID = a.TypeID, ParentID = a.ParentID }).ToList();
                    if (itt.BrandName == "马牌" || itt.BrandName == "维京")
                    {
                        var data = HouseBus.QueryProductDataBasic(new CargoProductEntity { GoodsCode = itt.PartsNum });
                        cargos = data;
                    }
                    else
                    {
                        var data = interfaceBus.GetProductMapping(new OrderItem() { PartsNum = itt.PartsNum });
                        cargos = data.Select(a => new CargoProductEntity { ProductCode = a.ProductCode, TypeID = a.TypeID, ParentID = a.ParentID }).ToList();
                    }
                    if (cargos.Count == 0)
                    {
                        log.Status = "1";
                        log.Memo = $@"[{datas.OrderHeader.OrderId}]未获取到对应商品信息";
                        lw.WriteLog(log);
                        return;
                    }

                    List<CargoInterfaceEntity> stockList = new List<CargoInterfaceEntity>();
                    //List<CargoProductEntity> productBasic = bus.QueryProductDataBasic(new CargoProductEntity { ProductCodeStr = $@"'{string.Join("','", cargos.Select(a => a.ProductCode))}'" });
                    //if (productBasic.Count <= 0)
                    //{
                    //    msg.Result = false; msg.Message = "商品基础数据有误"; goto ERROR;
                    //}
                    //周期年 ItemDescription
                    var BatchYear = 0;
                    var BatchWeek = 0;
                    var YearArr = itt.ItemDescription.Split(' ');
                    if (YearArr.Length > 1)
                    {
                        var Year = ExtractYear(YearArr[YearArr.Length - 1]);
                        //判断Year是不是数值
                        if (IsNumber(Year))
                        {
                            if (Year.Length == 4)
                            {
                                BatchYear = Convert.ToInt32(Year.Substring(Year.Length - 2));
                            }
                            else if (Year.Length == 2)
                            {
                                BatchYear = Convert.ToInt32(Year);
                            }
                            else if (Year == "0")
                            {
                                BatchYear = Convert.ToInt32(DateTime.Now.ToString("yy"));
                            }
                        }
                        //else
                        //{
                        //    msg.Result = false; msg.Message = $@"【订单名称】批次获取失败:【{YearArr[YearArr.Length - 1]}】"; goto ERROR;
                        //}
                        BatchWeek = ExtractWeek(YearArr[YearArr.Length - 1]);
                    }
                    
                    CargoInterfaceEntity queryEntity = new CargoInterfaceEntity
                    {
                        //ProductCode = item.ProductCode,
                        ProductCodeStr = $@"{string.Join("','", cargos.Select(a => a.ProductCode).Distinct())}",
                        HouseID = areaEntity.HouseID,
                        TypeID = cargos[0].TypeID,
                        BatchYear = BatchYear,
                        ParentID = cargos[0].ParentID,
                        SpecsType = "4",
                        BatchWeekFilter = BatchWeek,
                        //Regular = PromotionType,
                        //SuppClientNum = SuppClientNum,
                    };
                    stockList.AddRange(interfaceBus.queryCargoStock(queryEntity));
                    //batchDic
                    if (batchDic.Count > 0)
                    {
                        foreach (var item in stockList)
                        {
                            if (batchDic.ContainsKey(item.ProductID))
                            {
                                var sku = batchDic[item.ProductID];
                                item.StockNum -= sku;
                            }
                        }
                    }
                    //排除库存小于等于0的
                    stockList = stockList.Where(a => a.StockNum > 0).OrderBy(a => a.Batch).ThenBy(p => Math.Abs(p.StockNum - piece)).ToList();
                    //多供应商 特殊处理
                    var SuitClientCount = stockList.GroupBy(a => a.SuppClientNum).Select(a => new CargoInterfaceEntity
                    {
                        SuppClientNum = a.Key,
                        StockNum = a.Sum(aa => aa.StockNum)
                    }).ToList();
                    if (SuitClientCount.Count > 1)
                    {
                        bool IsOk = false;
                        foreach (var item in SuitClientCount)
                        {
                            if (item.StockNum >= piece)
                            {
                                stockList = stockList.Where(a => a.SuppClientNum == item.SuppClientNum).OrderBy(a => a.Batch).ThenBy(p => Math.Abs(p.StockNum - piece)).ToList();
                                IsOk = true;
                                break;
                            }
                        }
                        if (!IsOk)
                        {
                            log.Status = "1";
                            log.Memo = $@"[{datas.OrderHeader.OrderId}]商品库存不足";
                            lw.WriteLog(log);
                            return;
                        }
                    }



                    if (stockList.Count <= 0)
                    {
                        log.Status = "1";
                        log.Memo = $@"[{datas.OrderHeader.OrderId}]商品库存不足";
                        lw.WriteLog(log);
                        return;
                    }
                    if (stockList.Sum(c => c.StockNum) < piece)
                    {
                        log.Status = "1";
                        log.Memo = $@"[{datas.OrderHeader.OrderId}]库存不足";
                        lw.WriteLog(log);
                        return;
                    }

                    //减库存规则，一周期早的先出先进先出，二数量和库存数刚好一样的先出
                    foreach (var it in stockList)
                    {
                        if (it.StockNum <= 0) { continue; }
                        if (!it.ShareHouseID.Equals(0))
                        {
                            ent.ShareHouseID = it.ShareHouseID;
                            ent.ShareHouseName = it.ShareHouseName;
                        }

                        CargoContainerShowEntity cargo = new CargoContainerShowEntity();
                        cargo.OrderNo = ent.OrderNo;//订单号
                        cargo.OutCargoID = outID;
                        cargo.ContainerID = it.ContainerID;
                        cargo.TypeID = it.TypeID;
                        cargo.ProductID = it.ProductID;

                        cargo.ID = it.ContainerGoodsID;//库存表ID

                        //cargo.TypeName = Convert.ToString(row["TypeName"]).Trim();
                        cargo.HouseName = houseEnt.Name;
                        //cargo.AreaName = Convert.ToString(row["AreaName"]).Trim();
                        cargo.ProductName = it.ProductName;
                        cargo.Model = it.Model;
                        cargo.Specs = it.Specs;
                        cargo.Figure = it.Figure;
                        int inHouseDay = (int)(DateTime.Now - it.InHouseTime).TotalDays;
                        int OverDay = 0;
                        decimal OnlyOverDayFee = 0;
                        //decimal OverDayFee = 0.00M;//超期费用

                        ent.SuppClientNum = Convert.ToInt32(it.SuppClientNum);

                        #region 减库存逻辑
                        if (piece < it.StockNum)
                        {
                            if (inHouseDay > houseEnt.OverDayNum)
                            {
                                //如果在库天数大于了用户设置的天数，则按照超期天数计算超期费用
                                OverDay = inHouseDay - houseEnt.OverDayNum;
                                OnlyOverDayFee = OverDay * houseEnt.OverDueUnitPrice * piece;
                                OverDayFee += OnlyOverDayFee;
                            }
                            //部分出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = piece,
                                //ActSalePrice = it.SalePrice,
                                ActSalePrice = itt.ActualPrice + AdjustmentsCurrItemSum,
                                SupplySalePrice = it.InHousePrice,
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                RuleID = "0",
                                RuleTitle = "",
                                RuleType = "",
                                OP_ID = log.UserID,
                                OverDayNum = OverDay,
                                OverDueFee = OnlyOverDayFee,
                            });

                            cargo.Piece = piece;
                            cargo.InPiece = it.StockNum;
                            originalPrice += piece * it.InHousePrice;//计算成本价
                            outHouseList.Add(cargo);

                            if (batchDic.ContainsKey(it.ProductID))
                                batchDic[it.ProductID] = batchDic[it.ProductID] += piece;
                            else
                                batchDic[it.ProductID] = piece;

                            break;
                        }
                        if (piece.Equals(it.StockNum))
                        {
                            if (inHouseDay > houseEnt.OverDayNum)
                            {
                                //如果在库天数大于了用户设置的天数，则按照超期天数计算超期费用
                                OverDay = inHouseDay - houseEnt.OverDayNum;
                                OnlyOverDayFee = OverDay * houseEnt.OverDueUnitPrice * piece;
                                OverDayFee += OnlyOverDayFee;
                            }
                            //要出库件数和第一条库存件数刚刚好，则就全部出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = piece,
                                //ActSalePrice = it.SalePrice,
                                SupplySalePrice = it.InHousePrice,
                                ActSalePrice = itt.ActualPrice + AdjustmentsCurrItemSum,
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                RuleID = "0",
                                RuleTitle = "",
                                RuleType = "",
                                OP_ID = log.UserID,
                                OverDayNum = OverDay,
                                OverDueFee = OnlyOverDayFee,
                            });
                            cargo.Piece = piece;
                            cargo.InPiece = it.StockNum;
                            originalPrice += piece * it.InHousePrice;//计算成本价

                            outHouseList.Add(cargo);

                            if (batchDic.ContainsKey(it.ProductID))
                                batchDic[it.ProductID] = batchDic[it.ProductID] += piece;
                            else
                                batchDic[it.ProductID] = piece;

                            break;
                        }
                        if (piece > it.StockNum)
                        {
                            if (inHouseDay > houseEnt.OverDayNum)
                            {
                                //如果在库天数大于了用户设置的天数，则按照超期天数计算超期费用
                                OverDay = inHouseDay - houseEnt.OverDayNum;
                                OnlyOverDayFee = OverDay * houseEnt.OverDueUnitPrice * it.StockNum;
                                OverDayFee += OnlyOverDayFee;
                            }
                            //全部出
                            entDest.Add(new CargoOrderGoodsEntity
                            {
                                OrderNo = ent.OrderNo,
                                ProductID = it.ProductID,
                                HouseID = ent.HouseID,
                                AreaID = it.AreaID,
                                Piece = it.StockNum,
                                //ActSalePrice = it.SalePrice,
                                SupplySalePrice = it.InHousePrice,
                                ActSalePrice = itt.ActualPrice + AdjustmentsCurrItemSum,
                                ContainerCode = it.ContainerCode,
                                OutCargoID = outID,
                                RuleID = "0",
                                RuleTitle = "",
                                RuleType = "",
                                OP_ID = log.UserID,
                                OverDayNum = OverDay,
                                OverDueFee = OnlyOverDayFee,
                            });
                            cargo.Piece = it.StockNum;
                            cargo.InPiece = it.StockNum;
                            originalPrice += it.StockNum * it.InHousePrice;//计算成本价
                            outHouseList.Add(cargo);
                            piece = piece - it.StockNum;
                            if (batchDic.ContainsKey(it.ProductID))
                                batchDic[it.ProductID] = batchDic[it.ProductID] += it.StockNum;
                            else
                                batchDic[it.ProductID] = it.StockNum;
                            continue;
                        }
                        #endregion
                    }
                }

                //订单总数量
                ent.Piece = Convert.ToInt32(pieceSum);
                ent.Weight = 0;
                ent.Volume = 0;
                ent.InsuranceFee = AdjustmentsSum;// coupon.Money;//优惠券金额 
                ent.TransitFee = Convert.ToDecimal(datas.OrderPostalAddress.OrderWayDetails?.Sum(a => a.FeeAmount));//配送费
                ent.TransportFee = originalPrice;//销售收入
                ent.OverDueFee = OverDayFee;//超期费用
                                            //ent.TransportFee = Convert.ToDecimal(YPOrderMoney);//订单的费用
                ent.DeliveryFee = 0;
                ent.OtherFee = Convert.ToDecimal(datas.OrderHeader.Amount) - ent.TransitFee - ent.TransportFee + ent.InsuranceFee;//平台服服务费=总金额-配送费-销售金额+优惠券
                if (datas.OrderHeader.DiscountAmount != null)
                {
                    ent.OtherFee = ent.OtherFee - Convert.ToDecimal(datas.OrderHeader.DiscountAmount); //+折扣（折扣价开思传的值相反）
                }
                ent.TotalCharge = Convert.ToDecimal(datas.OrderHeader.Amount);

                //ent.CouponType = CouponType;
                ent.OrderNum = OrderNum;//最新订单顺序号
                ent.goodsList = entDest;
                ent.FinanceSecondCheck = "1";
                ent.FinanceSecondCheckName = clientEntity.ClientName;
                ent.FinanceSecondCheckDate = DateTime.Now;
                ent.CheckStatus = "1";
                ent.OutCargoTime = DateTime.Now;
                ent.CheckDate = DateTime.Now;
                ent.OrderModel = "0";
                //ent.SuppClientNum = Convert.ToInt32(SuppClientNum);
                //ent.WXOrderNo = orderno;//微信商城订单号

                //仓库同步缓存
                foreach (CargoContainerShowEntity time in outHouseList)
                {
                    CargoProductEntity syncProduct = HouseBus.SyncTypeProduct(time.ProductID.ToString());
                    if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "Cass"))
                    {
                        RedisHelper.HashSet("OpenSystemStockSyc", "" + syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode + "", syncProduct.GoodsCode);
                    }
                    if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "DILE"))
                    {
                        RedisHelper.HashSet("HCYCHouseStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                    }
                    if (Common.IsAllSyncStock(syncProduct.HouseID, syncProduct.TypeID, "Tuhu"))
                    {
                        RedisHelper.HashSet("TuhuStockSyc", syncProduct.HouseID + "_" + syncProduct.TypeID + "_" + syncProduct.ProductCode, syncProduct.ProductCode);
                    }

                }

                //保存生成仓库出库订单
                Bus.AddOrderInfoV2(ent, outHouseList, log);

                log.Memo = $@"[{datas.OrderHeader.OrderId}]开思生成系统订单完成";
                lw.WriteLog(log);

                if (ent.CheckOutType != null)
                {
                    #region 推送好来运系统

                    if (ent.HouseID.Equals(93))
                    {
                        //内部订单 || ent.HouseID.Equals(98)
                        Bus.SaveHlyOrderData(outHouseList, ent);
                    }
                    else
                    {
                        Bus.InsertCargoOrderPush(new CargoOrderPushEntity
                        {
                            OrderNo = ent.OrderNo,
                            Dep = ent.Dep,
                            Dest = ent.Dest,
                            Piece = ent.Piece,
                            TransportFee = ent.TransportFee,
                            ClientNum = ent.ClientNum.ToString(),
                            AcceptAddress = ent.AcceptAddress,
                            AcceptCellphone = ent.AcceptCellphone,
                            AcceptTelephone = ent.AcceptTelephone,
                            AcceptPeople = ent.AcceptPeople,
                            AcceptUnit = ent.AcceptUnit,
                            HouseID = ent.HouseID.ToString(),
                            HouseName = ent.OutHouseName,
                            OP_ID = log.UserID,
                            PushType = "0",
                            PushStatus = "0",
                            LogisID = ent.LogisID
                        }, log);
                    }

                    #endregion

                    string fkfs = ent.CheckOutType.Equals("3") ? "货到付款" : ent.CheckOutType.Equals("10") ? "预付款" : "现付";
                    string shf = ent.LogisID.Equals(46) ? "自提" : ent.DeliveryType.Equals("0") ? "急送" : "次日达";
                    string tit = ent.ThrowGood.Equals("23") ?  "次日达" : (ent.DeliveryType.Equals("2") ? "次日达" : "急速达" );
                    string go = ent.ThrowGood.Equals("23") ? "-不出库" : (ent.DeliveryType.Equals("2") ? "" : "") ;
                    CargoNewOrderNoticeEntity cargoNewOrder = new CargoNewOrderNoticeEntity();
                    cargoNewOrder.HouseName = houseEnt.Name;
                    cargoNewOrder.OrderNo = ent.WXOrderNo;
                    cargoNewOrder.OrderNum = ent.Piece.ToString();
                    cargoNewOrder.ClientInfo = ent.AcceptPeople + " " + ent.AcceptCellphone + " " + ent.AcceptAddress;// "泰乐 华笙 广东省广州市白云区东平加油站左侧";
                    cargoNewOrder.ProductInfo = proStr;// "马牌 215/55R16 CC6 98V";
                    cargoNewOrder.DeliveryName = shf;// "自提";
                    cargoNewOrder.ReceivePeople = "";
                    string hcno = JSON.Encode(cargoNewOrder);
                    //Common.WriteTextLog(hcno);
                    List<CargoVoiceBroadEntity> voiceBroadList = HouseBus.GetVoiceBroadList(new CargoVoiceBroadEntity { HouseID = houseEnt.HouseID });
                    foreach (var voice in voiceBroadList)
                    {
                        RedisHelper.SetString("NewOrderNotice_" + voice.LoginName, hcno);
                        //mc.Add("NewOrderNotice_" + voice.LoginName, hcno);
                    }

                    //mc.Add("NewOrderNotice_1000", hcno);
                    //mc.Add("NewOrderNotice_2215", hcno);
                    //mc.Add("NewOrderNotice_2856", hcno);

                    //RedisHelper.SetString("NewOrderNotice", hcno);
                    //货到付款
                    try
                    {
                        QySendInfoEntity send = new QySendInfoEntity();
                        send.title = tit + " 有新订单";
                        //推送给提交人
                        send.msgType = msgType.textcard;
                        send.agentID = "1000003";//消息通知的应用
                        send.AgentSecret = "VkkRCESh5hxT8FStrYa0jWjIg0ux--M670SoFFyuimM";
                        //send.toUser = qup.ApplyID;<div>订单金额：" + ord.TotalCharge.ToString("F2") + "</div>
                        //send.toTag = "19";
                        send.toTag = houseEnt.HCYCOrderPushTagID.ToString();
                        send.content = "<div></div><div>出库仓库：" + houseEnt.Name + go + "</div><div>商城订单号：" + ent.WXOrderNo + "</div><div>出库订单号：" + ent.OrderNo + "</div><div>订单数量：" + ent.Piece.ToString() + "</div><div>订单金额：" + ent.TotalCharge.ToString("F2") + "</div><div>货物信息：" + proStr + "</div><div>付款方式：" + fkfs + "</div><div>送货方式：" + shf + "</div><div>门店名称：" + ent.AcceptUnit + "</div><div>收货信息：" + ent.AcceptPeople + " " + ent.AcceptCellphone + "</div><div>收货地址：" + ent.AcceptAddress + "</div><div>请仓管人员留意尽快出库！</div>";
                        send.url = "http://dlt.neway5.com/QY/qyScanOrderSign.aspx?OrderNo=" + ent.OrderNo;
                        WxQYSendHelper.DLTQYPushInfo(send);


                    }
                    catch (ApplicationException ex)
                    {
                        log.Status = "1";
                        log.Memo = $@"[{datas.OrderHeader.OrderId}]" + ex.ToString() ;
                        lw.WriteLog(log);
                    }
                    //msg.Message = "提交成功，请收到货后在我的订单里支付货款";
                    log.Memo = $@"[{datas.OrderHeader.OrderId}]提交成功";
                    lw.WriteLog(log);
                }
                else if (ent.CheckOutType.Equals("6"))
                {
                    log.Memo = $@"[{datas.OrderHeader.OrderId}]提交成功";
                    lw.WriteLog(log);
                }
            }
            catch (Exception ex)
            {

                log.Status = "1";
                log.Memo = $@"[{datas.OrderHeader.OrderId}]" + ex.ToString();
                lw.WriteLog(log);
            }
            log.Status = "0";
            log.Memo = $@"[{datas.OrderHeader.OrderId}]结束自动开单";
            lw.WriteLog(log);
        }
        public static string ExtractYear(string str)
        {
            if (string.IsNullOrWhiteSpace(str))
                return null;

            // 匹配连续的2位或4位年份数字，通常在字符串末尾
            var match = Regex.Match(str, @"(\d{2,4})\s*(年|上半年|下半年|年上半年|年下半年)?$");
            if (match.Success)
            {
                return match.Groups[1].Value;
            }

            return null;
        }
        public static int ExtractWeek(string str)
        {
            if (string.IsNullOrWhiteSpace(str))
                return 0;

            // 匹配连续的2位或4位年份数字，通常在字符串末尾
            var match = Regex.Match(str, @"(\d{2,4})\s*(年|上半年|下半年|年上半年|年下半年)?$");
            if (match.Success)
            {
                //return match.Groups[1].Value;
                if (str.Contains("上"))
                {
                    return 1;
                }
                else if(str.Contains("下"))
                {
                    return 2;
                }
            }

            return 0;
        }
        public static bool IsNumber(string value)
        {
            if (value == null)
            {
                return false;
            }
            return Regex.IsMatch(value, @"^\d+$");
        }
        public void UpdateMassCallOrder(CassMallDTO notice)
        {
            CargoInterfaceBus nwBus = new CargoInterfaceBus();
            //获取订单信息
            string url = CassApi + "?orderId=" + notice.data.orderId;
            var dataStr = PostHttpRequest(url, "", "cassec.order.detail.get"
                     , sessionDic[notice.pushTargetId]
                     , (!string.IsNullOrEmpty(notice.requestParam.appKey) ? notice.requestParam.appKey : "gzshly60be866dbe52"));
            var dataString = JsonConvert.DeserializeObject<CassMallStr>(dataStr);
            var datas = dataString.result;
            //保存日志
            if (datas != null)
            {
                nwBus.AddCassMallData(new CargoCassMallEntity { SourceType = 2, SourceAction = "UpdateMassCallOrder", orderId = notice.data.orderId, ResJson = dataStr });
            }
        }
        /// <summary>
        /// 订单已取消
        /// </summary>
        /// <param name="notice"></param>
        public void MassCallOrderCancelled(CassMallDTO notice)
        {
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "订单管理";
            log.Status = "0";
            log.NvgPage = "开思订单取消";
            log.UserID = "";
            log.Operate = "D";
            CargoInterfaceBus nwBus = new CargoInterfaceBus();
            CargoOrderBus bus = new CargoOrderBus();

            //订单取消
            //1.更新开思表状态
            nwBus.MassCallOrderCancelled(notice, log);

        }
        public string PostHttpRequest(string url, string Data, string apiName, string APISession, string appKey)
        {
            string result = string.Empty;
            HttpWebRequest request = (HttpWebRequest)HttpWebRequest.Create(url);
            TimeSpan timeSpan = DateTime.UtcNow.AddMinutes(-5) - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc);
            DateTime dateTime = DateTime.Now;
            long timestamp = (long)(dateTime.Subtract(new DateTime(1970, 1, 1))).TotalMilliseconds;
            string sign = CassSecret
                + apiName
                + (!string.IsNullOrEmpty(appKey) ? appKey : "gzshly60be866dbe52")
                + APISession
                + timestamp;
            using (MD5 md5 = MD5.Create())
            {
                byte[] inputBytes = Encoding.UTF8.GetBytes(sign);
                byte[] hashBytes = md5.ComputeHash(inputBytes);
                StringBuilder sb = new StringBuilder();
                for (int i = 0; i < hashBytes.Length; i++)
                {
                    sb.Append(hashBytes[i].ToString("x2"));
                }
                sign = sb.ToString().ToUpper();
            }
            request.Headers.Add("apiName", apiName);
            request.Headers.Add("appKey", appKey);
            request.Headers.Add("sign", sign);
            request.Headers.Add("session", APISession);
            request.Headers.Add("timestamp", timestamp.ToString());
            request.Method = "GET";
            request.ContentType = "application/json";
            using (WebResponse response = request.GetResponse())
            {
                if (response != null)
                {
                    using (Stream stream = response.GetResponseStream())
                    {
                        using (StreamReader reader = new StreamReader(stream, Encoding.UTF8))
                        {
                            result = reader.ReadToEnd();
                        }
                    }

                }
            }
            return result;
        }
        /// <summary>
        /// 添加播报
        /// </summary>
        public void Broadcast(OrderDto dto)
        {
            CargoHouseBus house = new CargoHouseBus();
            var cassHouses = house.GetCassHouses();
            var cassProducts = house.GetCassProDucts();
            foreach (var item in dto.OrderItems)
            {
                //获取对应仓库
                var cHouses = item.ItemInventories.Select(a => a.FacilityId).Distinct();
                var cassHouse = cassHouses.FirstOrDefault(a => cHouses.Contains(a.CassHouseCode));
                var cassProduct = cassProducts.FirstOrDefault(a => item.PartsNum == a.CassCode);
                CargoHouseEntity houseEnt = house.QueryCargoHouseByID(cassHouse.HouseID);

                string proStr = cassProduct?.TypeName + " " + cassProduct?.Specs + " " + cassProduct?.Figure + " " + cassProduct?.LoadIndex + cassProduct?.SpeedLevel;

                //添加播报
                CargoNewOrderNoticeEntity cargoNewOrder = new CargoNewOrderNoticeEntity();
                cargoNewOrder.HouseName = "开思订单-" + houseEnt.Name;
                cargoNewOrder.OrderNo = dto.OrderHeader.OrderId;
                cargoNewOrder.OrderNum = item.Quantity.ToString();
                cargoNewOrder.ClientInfo = dto.OrderHeader.Buyer.CompanyDisplayName + " " + dto.OrderPostalAddress.ContactNumber + " " + (dto.OrderPostalAddress.ProvinceGeoName + " " + dto.OrderPostalAddress.CityGeoName + " " + dto.OrderPostalAddress.Address);// "泰乐 华笙 广东省广州市白云区东平加油站左侧";
                cargoNewOrder.ProductInfo = proStr;// "马牌 215/55R16 CC6 98V";
                cargoNewOrder.DeliveryName = "急送";// "自提";
                cargoNewOrder.ReceivePeople = "";
                string hcno = JSON.Encode(cargoNewOrder);
                //Common.WriteTextLog(hcno);
                List<CargoVoiceBroadEntity> voiceBroadList = house.GetVoiceBroadList(new CargoVoiceBroadEntity { HouseID = houseEnt.HouseID });
                foreach (var voice in voiceBroadList)
                {
                    RedisHelper.SetString("NewOrderNotice_" + voice.LoginName, hcno);
                    //mc.Add("NewOrderNotice_" + voice.LoginName, hcno);
                }
            }

        }
        public bool IsReusable
        {
            get
            {
                return false;
            }
        }

        private void SendOrderAudit(CassMallPushParam order, CassMallDTO callbackData)
        {
            LogEntity log=new LogEntity();
            LogBus logbus = new LogBus();
            try
            {
                log.NvgPage = "开思-审核推送";
                string url = CassApi;
                var dataStr = PostHttpRequest_Put(url + "?orderId=" + order.orderId, "", "cassec.order.approve"
                    , sessionDic[callbackData.pushTargetId]
                    , "gzshly60be866dbe52");
                var dataString = $@"订单号[{order.orderId}]返回参数：" + (dataStr);
                log.Memo = dataStr;
                logbus.InsertLog(log);
            }
            catch (Exception exx)
            {
                log.Status = "1";
                log.Memo = $@"订单号[{order.orderId}]报错：" + exx.ToString();
                logbus.InsertLog(log);
            }
        }
        public string PostHttpRequest_Put(string url, string Data, string apiName, string APISession, string appKey)
        {
            string result = string.Empty;
            // 处理 Data 为空的情况，避免空引用异常
            Data = Data ?? string.Empty;

            HttpWebRequest request = (HttpWebRequest)HttpWebRequest.Create(url);

            // 保留原有时间戳计算逻辑（注：建议统一使用 UtcNow 避免时区问题，此处保持原逻辑）
            TimeSpan timeSpan = DateTime.UtcNow.AddMinutes(-5) - new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc);
            DateTime dateTime = DateTime.Now;
            long timestamp = (long)(dateTime.Subtract(new DateTime(1970, 1, 1))).TotalMilliseconds;

            // 保留原有签名计算逻辑
            string sign = CassSecret
                + apiName
                + (!string.IsNullOrEmpty(appKey) ? appKey : "gzshly60be866dbe52")
                + APISession
                + timestamp;
            using (MD5 md5 = MD5.Create())
            {
                byte[] inputBytes = Encoding.UTF8.GetBytes(sign);
                byte[] hashBytes = md5.ComputeHash(inputBytes);
                StringBuilder sb = new StringBuilder();
                for (int i = 0; i < hashBytes.Length; i++)
                {
                    sb.Append(hashBytes[i].ToString("x2"));
                }
                sign = sb.ToString().ToUpper();
            }

            // 保留原有请求头配置
            request.Headers.Add("apiName", apiName);
            request.Headers.Add("appKey", appKey);
            request.Headers.Add("sign", sign);
            request.Headers.Add("session", APISession);
            request.Headers.Add("timestamp", timestamp.ToString());

            // 核心改造：改为 PUT 方法
            request.Method = "PUT";
            request.ContentType = "application/json"; // 保持 JSON 格式

            // 核心改造：将 Data 作为请求体写入
            byte[] postDataBytes = Encoding.UTF8.GetBytes(Data);
            request.ContentLength = postDataBytes.Length; // 必须设置内容长度，否则服务器可能无法解析
            using (Stream requestStream = request.GetRequestStream())
            {
                requestStream.Write(postDataBytes, 0, postDataBytes.Length);
                requestStream.Flush(); // 确保数据全部发送
            }

            // 保留原有响应读取逻辑
            using (WebResponse response = request.GetResponse())
            {
                if (response != null)
                {
                    using (Stream stream = response.GetResponseStream())
                    {
                        using (StreamReader reader = new StreamReader(stream, Encoding.UTF8))
                        {
                            result = reader.ReadToEnd();
                        }
                    }
                }
            }

            return result;
        }

    }
}