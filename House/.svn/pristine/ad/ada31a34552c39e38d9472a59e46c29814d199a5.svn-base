using House.Business;
using House.Business.Cargo;
using House.Business.House;
using House.Entity;
using House.Entity.Cargo;
using House.Entity.Cargo.Order;
using House.Entity.House;
using iText.Layout.Element;
using Newtonsoft.Json;
using NPOI.HSSF.Record.Formula.Functions;
using Org.BouncyCastle.Asn1.Cmp;
using Org.BouncyCastle.Asn1.Ocsp;
using Senparc.Weixin.MP.TenPayLibV3;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.Linq;
using System.Reflection;
using System.Runtime.Remoting.Contexts;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;

namespace Cargo.Finance
{
    public partial class financeApi : BasePage
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            string methodName = string.Empty;
            try
            {
                methodName = Request["method"];
                if (String.IsNullOrEmpty(methodName)) return;
                Type type = this.GetType();
                MethodInfo method = type.GetMethod(methodName);
                method.Invoke(this, null);
            }
            catch (Exception ex)
            {
                LogBus bus = new LogBus();
                LogEntity log = new LogEntity();
                log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                log.Operate = "";
                log.Moudle = "";
                log.Status = "1";
                log.NvgPage = "";
                log.UserID = "";
                log.Memo = methodName + " " + ex.Message + " " + ex.StackTrace;
                bus.InsertLog(log);
            }
        }
        #region 基础数据管理
        /// <summary>
        /// 保存账号分配权限
        /// </summary>
        public void saveCashManage()
        {
            CargoFinanceBus bus = new CargoFinanceBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "出纳资金管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            log.Memo = "资金账号管理";

            SystemUserEntity userEntity = new SystemUserEntity
            {
                LoginName = Convert.ToString(Request["LoginName"]),
                PermisCashName = string.IsNullOrEmpty(Convert.ToString(Request["PermisCashName"])) ? Convert.ToString(Request["PermisCashName"]) : Convert.ToString(Request["PermisCashName"]).Substring(0, Convert.ToString(Request["PermisCashName"]).Length - 1)
            };

            bus.saveCashManagePermis(userEntity, log);

            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        public void QueryBasicDataList()
        {
            CargoFinanceBasicDataEntity queryEntity = new CargoFinanceBasicDataEntity();
            if (Request["CardType"] != "-1") { queryEntity.CardType = Convert.ToString(Request["CardType"]); }
            if (Request["Status"] != "-1") { queryEntity.Status = Convert.ToString(Request["Status"]); }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            //分页
            int pageIndex = 1;
            int pageSize = 10000;
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryFinanceBasicData(pageIndex, pageSize, queryEntity);
            List<CargoFinanceBasicDataEntity> bd = (List<CargoFinanceBasicDataEntity>)list["rows"];
            //JSON
            String json = JSON.Encode(bd);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询财务基础数据
        /// </summary>
        public void QueryFinanceBasicData()
        {
            CargoFinanceBasicDataEntity queryEntity = new CargoFinanceBasicDataEntity();
            if (Request["CardType"] != "-1") { queryEntity.CardType = Convert.ToString(Request["CardType"]); }
            if (Request["Status"] != "-1") { queryEntity.Status = Convert.ToString(Request["Status"]); }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            if (!string.IsNullOrEmpty(UserInfor.PermisCashName))
            {
                queryEntity.PermisBasicID = UserInfor.PermisCashName;
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryFinanceBasicData(pageIndex, pageSize, queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 删除基础数据
        /// ty:0注销基础数据ty:1彻底删除基础数据ty:2恢复基础数据
        /// </summary>
        public void DelBasicData()
        {
            String idStr = Request["data"];
            int ty = Convert.ToInt32(Request["ty"]);
            if (String.IsNullOrEmpty(idStr)) return;
            ArrayList rows = (ArrayList)JSON.Decode(idStr);
            List<CargoFinanceBasicDataEntity> list = new List<CargoFinanceBasicDataEntity>();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "基础数据管理";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();
            switch (ty)
            {
                case 0:
                    log.Memo = "注销基础数据成功";
                    log.Operate = "U";
                    break;
                case 1:
                    log.Memo = "删除基础数据成功";
                    log.Operate = "D";
                    break;
                case 2:
                    log.Memo = "恢复基础数据成功";
                    log.Operate = "U";
                    break;
                default:
                    break;
            }
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoFinanceBasicDataEntity
                    {
                        BasicID = Convert.ToInt32(row["BasicID"]),
                        Bank = Convert.ToString(row["Bank"]),
                        CardName = Convert.ToString(row["CardName"]),
                        Aliases = Convert.ToString(row["Aliases"]),
                        CardNum = Convert.ToString(row["CardNum"]),
                        CardType = Convert.ToString(row["CardType"]),
                        OverMoney = Convert.ToDecimal(row["OverMoney"])
                    });
                }
                CargoFinanceBus bus = new CargoFinanceBus();
                bus.DelBasicData(list, ty, log);
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 保存或修改财务基础数据
        /// </summary>
        public void SaveFinanceBasicData()
        {
            CargoFinanceBasicDataEntity ent = new CargoFinanceBasicDataEntity();
            CargoFinanceBus bus = new CargoFinanceBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "基础数据管理";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();
            try
            {
                String id = Request["BasicID"] != null ? Request["BasicID"].ToString() : "";
                ent.HouseID = Convert.ToInt32(Request["HouseID"]);
                ent.ApplyHouseID = Convert.ToString(Request["ApplyHouseID"]);
                if (string.IsNullOrEmpty(ent.ApplyHouseID))
                {
                    ent.ApplyHouseID = ent.HouseID.ToString();
                }
                ent.Aliases = Convert.ToString(Request["Aliases"]);
                ent.Bank = Convert.ToString(Request["Bank"]);
                ent.CardType = Convert.ToString(Request["CardType"]);
                ent.CardName = Convert.ToString(Request["CardName"]);
                ent.CardNum = Convert.ToString(Request["CardNum"]);
                ent.Memo = Convert.ToString(Request["Memo"]);
                ent.OverMoney = Convert.ToDecimal(Request["OverMoney"]);
                ent.OP_ID = UserInfor.LoginName.Trim();

                if (id == "")
                {
                    log.Operate = "A";
                    ent.Status = "0";

                    if (ent.CardType == "0")
                    {
                        CargoFinanceBasicDataEntity cityEnt = bus.GetFinanceBasicDataByCityCode((new CargoFinanceBasicDataEntity { HouseID = ent.HouseID, CardType = ent.CardType }));
                        if (cityEnt.BasicID > 0) { msg.Message = "此仓库已经存在现金账户，请返回"; msg.Result = false; }
                    }
                    else if (ent.CardType == "1")
                    {
                        if (string.IsNullOrEmpty(ent.Bank)) { msg.Message = "开户行不能为空"; msg.Result = false; }
                        if (string.IsNullOrEmpty(ent.CardName)) { msg.Message = "开户名不能为空"; msg.Result = false; }
                        if (string.IsNullOrEmpty(ent.CardNum)) { msg.Message = "开户账号不能为空"; msg.Result = false; }
                    }
                    if (msg.Result)
                    {
                        bus.AddFinanceBasicData(ent, log);
                    }
                }
                else
                {
                    log.Operate = "U";
                    ent.BasicID = Convert.ToInt32(Request["BasicID"]);
                    ent.Status = Convert.ToString(Request["Status"]);
                    string oldCardType = Convert.ToString(Request["OldCardType"]);
                    string OldHouseID = Convert.ToString(Request["OldHouseID"]);

                    if (ent.CardType == "1")
                    {
                        if (string.IsNullOrEmpty(ent.Bank)) { msg.Message = "开户行不能为空"; msg.Result = false; }
                        if (string.IsNullOrEmpty(ent.CardName)) { msg.Message = "开户名不能为空"; msg.Result = false; }
                        if (string.IsNullOrEmpty(ent.CardNum)) { msg.Message = "开户账号不能为空"; msg.Result = false; }
                    }
                    if (msg.Result)
                    {
                        bus.UpdateFinanceBasicData(ent, log);
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 通过ID获取财务基础数据
        /// </summary>
        public void GetFinanceBasicDataByID()
        {
            int id = Convert.ToInt32(Request["id"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            CargoFinanceBasicDataEntity result = bus.GetFinanceBasicDataByID(id);
            String json = JSON.Encode(result);
            Response.Write(json);
        }
        /// <summary>
        /// 查询所有账户卡
        /// </summary>
        public void QueryCard()
        {
            //查询条件
            string id = Convert.ToString(Request["id"]);

            CargoFinanceBasicDataEntity queryEntity = new CargoFinanceBasicDataEntity();
            queryEntity.Status = "0";
            if (!id.Equals("-1"))
            {
                queryEntity.CardType = id;
            }
            //queryEntity.City = UserInfor.CityCode.Trim();
            //分页
            int pageIndex = 1;
            int pageSize = 1000;
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = new Hashtable();
            list = bus.QueryFinanceBasicData(pageIndex, pageSize, queryEntity);
            List<CargoFinanceBasicDataEntity> bd = (List<CargoFinanceBasicDataEntity>)list["rows"];
            if (bd.Count > 0)
            {
                foreach (var it in bd)
                {
                    if (it.CardType.Equals("0"))
                    {
                        it.CardNum = it.Aliases;
                    }
                }
            }
            //JSON
            String json = JSON.Encode(bd);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 应收账款管理

        /// <summary>
        /// 财务批量二审
        /// </summary>
        public void plSecondCheckOrder()
        {
            String json = Request["data"];
            ArrayList rows = (ArrayList)JSON.Decode(json);
            List<CargoOrderEntity> list = new List<CargoOrderEntity>();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "应收账款管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            log.Memo = "批量审核成功";
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            try
            {
                foreach (Hashtable row in rows)
                {
                    //审核过的跳过
                    if (Convert.ToString(row["FinanceSecondCheck"]).Trim().Equals("1")) { continue; }
                    //if (!string.IsNullOrEmpty(Convert.ToString(row["AccountID"])))
                    //{
                    //    msg.Message += Convert.ToString(row["AwbNo"]) + "已生成账单，不允许审核<br />";
                    //    msg.Result = false;
                    //    continue;
                    //}
                    if (Convert.ToString(row["CheckStatus"]).Equals("1"))
                    {
                        msg.Message += Convert.ToString(row["OrderNo"]) + " 已结清，不允许审核<br />";
                        msg.Result = false;
                        continue;
                    }
                    list.Add(new CargoOrderEntity
                    {
                        OrderID = Convert.ToInt64(row["OrderID"]),
                        OrderNo = Convert.ToString(row["OrderNo"]),
                        FinanceSecondCheck = "1",
                        FinanceSecondCheckName = UserInfor.UserName,
                        FinanceSecondCheckDate = DateTime.Now
                    });
                }
                CargoFinanceBus bus = new CargoFinanceBus();
                if (msg.Result)
                {
                    if (list.Count > 0)
                    {
                        bus.plSecondCheckOrder(list, log);
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 财务二审设置为未审
        /// </summary>
        public void plUnSecondCheckOrder()
        {
            String json = Request["data"];
            ArrayList rows = (ArrayList)JSON.Decode(json);
            List<CargoOrderEntity> list = new List<CargoOrderEntity>();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "应收账款管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            log.Memo = "批量未审成功";
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            try
            {
                foreach (Hashtable row in rows)
                {
                    //审核过的跳过
                    if (Convert.ToString(row["FinanceSecondCheck"]).Trim().Equals("0")) { continue; }
                    if (Convert.ToString(row["CheckStatus"]).Equals("1"))
                    {
                        msg.Message += Convert.ToString(row["OrderNo"]) + "已结清，不允许未审<br />";
                        msg.Result = false;
                        continue;
                    }
                    list.Add(new CargoOrderEntity
                    {
                        OrderID = Convert.ToInt64(row["OrderID"]),
                        OrderNo = Convert.ToString(row["OrderNo"]),
                        FinanceSecondCheck = "0",
                        FinanceSecondCheckName = UserInfor.UserName,
                        FinanceSecondCheckDate = DateTime.Now
                    });
                }
                CargoFinanceBus bus = new CargoFinanceBus();
                if (msg.Result)
                {
                    if (list.Count > 0)
                    {
                        bus.plSecondCheckOrder(list, log);
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 客户账单审批
        /// </summary>
        public void plCheckAccount()
        {
            String json = Request["data"];
            ArrayList rows = (ArrayList)JSON.Decode(json);
            List<CargoClientAccountEntity> list = new List<CargoClientAccountEntity>();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "客户账单审批";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            log.Memo = "批量审核成功";
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            try
            {
                foreach (Hashtable row in rows)
                {
                    //审核过的跳过
                    if (Convert.ToString(row["Status"]).Trim().Equals("1")) { continue; }
                    if (Convert.ToString(row["CheckStatus"]).Equals("1"))
                    {
                        msg.Message += Convert.ToString(row["AccountID"]) + " 已结清，不允许审核<br />";
                        msg.Result = false;
                        continue;
                    }
                    list.Add(new CargoClientAccountEntity
                    {
                        AccountID = Convert.ToString(row["AccountID"]),
                        Status = "1",
                        NextCheckID = UserInfor.LoginName,
                        NextCheckName = UserInfor.UserName,
                        NextCheckDate = DateTime.Now
                    });
                }
                CargoFinanceBus bus = new CargoFinanceBus();
                if (msg.Result)
                {
                    if (list.Count > 0)
                    {
                        bus.plCheckAccount(list, log);
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 客户账单未审
        /// </summary>
        public void plUnCheckAccount()
        {
            String json = Request["data"];
            ArrayList rows = (ArrayList)JSON.Decode(json);
            List<CargoClientAccountEntity> list = new List<CargoClientAccountEntity>();
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "客户账单审批";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            log.Memo = "批量未审成功";
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            try
            {
                foreach (Hashtable row in rows)
                {
                    //审核过的跳过
                    if (Convert.ToString(row["Status"]).Trim().Equals("0")) { continue; }
                    if (Convert.ToString(row["CheckStatus"]).Equals("1"))
                    {
                        msg.Message += Convert.ToString(row["AccountID"]) + "已结清，不允许未审<br />";
                        msg.Result = false;
                        continue;
                    }
                    list.Add(new CargoClientAccountEntity
                    {
                        AccountID = Convert.ToString(row["AccountID"]),
                        Status = "0",
                        NextCheckID = UserInfor.LoginName,
                        NextCheckName = UserInfor.UserName,
                        NextCheckDate = DateTime.Now
                    });
                }
                CargoFinanceBus bus = new CargoFinanceBus();
                if (msg.Result)
                {
                    if (list.Count > 0)
                    {
                        bus.plCheckAccount(list, log);
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
        #region 出纳收款操作
        /// <summary>
        /// 查询财务二审通过的订单数据用以出纳收款操作
        /// </summary>
        public void QueryOrderForCash()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
            queryEntity.Dest = Convert.ToString(Request["Dest"]);

            if (Request["CheckStatus"] != "-1") { queryEntity.CheckStatus = Convert.ToString(Request["CheckStatus"]); }
            if (Request["IsSupplierType"] != "-1") { queryEntity.IsSupplierType = Convert.ToInt32(Request["IsSupplierType"]); }
            if (Request["IsHouseType"] != "-1") { queryEntity.IsHouseType = Convert.ToInt32(Request["IsHouseType"]); }

            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            if (Convert.ToString(Request["OrderType"]) != "-1")
            {
                queryEntity.OrderType = Convert.ToString(Request["OrderType"]);
            }
            //2021-01-26注释付款人编码查询条件，添加付款人名称查询条件
            if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientNum"])))
            {
                queryEntity.PayClientNum = Convert.ToInt32(Request["PayClientNum"]);
            }
            if (Convert.ToString(Request["ThrowGood"]) != "-1")
            {
                queryEntity.ThrowGood = Convert.ToString(Request["ThrowGood"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientName"]))) { queryEntity.PayClientName = Convert.ToString(Request["PayClientName"]); }
            queryEntity.FinanceSecondCheck = "1";
            queryEntity.FromTO = "0";
            queryEntity.RType = "0";

            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoOrderEntity> list = bus.QueryOrderForCash(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void refund()
        {
            ErrMessage result = new ErrMessage();
            result.Result = true;
            string WXPayOrderNo = Request["WXPayOrderNo"];
            string ActRefMoney = Convert.ToString(Request["ActRefMoney"]);
            //string HouseID = Request["HouseID"].ToString();
            CargoOrderEntity entity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(WXPayOrderNo))
            {
                entity.WXPayOrderNo = WXPayOrderNo;
            }
            CargoFinanceBus bus = new CargoFinanceBus();
            CargoOrderEntity res = bus.QueryOrder(entity);
            entity.CreateAwb = UserInfor.UserName;
            entity.CreateAwbID = UserInfor.LoginName;
            entity.WXOrderNo = res.WXOrderNo;


            //判断是否已退款
            //if (!res.PayStatus.Equals(2))
            //{
            //    Response.Clear();
            //    Response.Write("FAIL");
            //    return;
            //}

            //entity.HouseID = 83;
            decimal refund = 0;
            if (res.RefundType.Equals("0"))
            {
                refund = string.IsNullOrEmpty(ActRefMoney) ? res.TotalCharge * 100 : Convert.ToDecimal(ActRefMoney) * 100;
            }
            else
            {
                refund = string.IsNullOrEmpty(ActRefMoney) ? (res.TotalCharge - res.TransitFee) * 100 : Convert.ToDecimal(ActRefMoney) * 100;
            }

            //通联支付退款流程
            SybWxPayService sybService = new SybWxPayService();
            //重新微信订单信息
            CargoWeiXinBus wxbus = new CargoWeiXinBus();
            WXOrderEntity wo = wxbus.QueryWeixinOrderByOrderNo(new WXOrderEntity() { OrderNo= res.WXOrderNo });
            Dictionary<String, String> rsp = sybService.refund(Convert.ToInt64(refund), DateTime.Now.ToFileTime().ToString(), wo.Trxid, wo.OrderNo);
            

            string jsonString = String.Join(",", rsp.Select(kvp => kvp.Key + "=" + kvp.Value));
            Common.WriteTextLog("慧采云仓小程序 通联支付回调信息：" + jsonString);
            //微信退款流程
            //string result = wxHttpUtility.WxHttpPost(res.WXPayOrderNo, res.WXOrderNo, refund, res.TotalCharge * 100);
            //int OrderNum = 0;
            //string OrderNo = Common.GetMaxOrderNumByCurrentDate(res.HouseID, "JC", out OrderNum);
            //entity.OrderNum = OrderNum;
            //entity.OrderNo = OrderNo;
            LogEntity logEntity = new LogEntity();
            logEntity.StartDate = DateTime.Now;
            logEntity.UserID = entity.CreateAwbID;
            logEntity.NvgPage = "用户退款";
            logEntity.Memo = jsonString;
            logEntity.Moudle = "";
            logEntity.Operate = "";
            logEntity.Status = "";
            logEntity.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            if (rsp["retcode"] == "SUCCESS")
            {
                bus.UpdatePayStatus(entity, logEntity);
            }
            
            Response.Write(rsp["retcode"]);
        }
        public void QueryWxOrder()
        {
            CargoOrderEntity entity = new CargoOrderEntity();
            string WXOrderNo = Request["OrderNo"].ToString();
            //string HouseID = Request["HouseID"].ToString();
            if (!string.IsNullOrWhiteSpace(WXOrderNo))
            {
                entity.WXOrderNo = WXOrderNo;
            }
            //if (!string.IsNullOrWhiteSpace(HouseID))
            //{
            //    entity.HouseID = Convert.ToInt32(HouseID);
            //}
            CargoFinanceBus bus = new CargoFinanceBus();
            CargoWeiXinBus weiXinBus = new CargoWeiXinBus();
            CargoOrderEntity res = bus.QueryOrder(entity);

            List<WXCouponEntity> wXCoupons = weiXinBus.QueryCouponData(new WXCouponEntity { FromOrderNO = WXOrderNo, UseStatus = "1" });

            res.InsuranceFee = wXCoupons.Sum(c => c.Money);
            ErrMessage result = new ErrMessage();
            result.Result = false;
            if (!res.PayStatus.Equals("2"))
            {
                result.Message = "未提交申请退款无法退款";
            }
            else if (!res.RefundCheckStatus.Equals("1"))
            {
                result.Message = "退款状态还未审核无法退款";
            }
            else if (res.PayStatus.Equals("2") && res.RefundCheckStatus.Equals("1"))
            {
                result.Result = true;
                result.Message = JSON.Encode(res);
            }
            String json = JSON.Encode(result);
            Response.Clear();
            Response.Write(json);

        }
        /// <summary>
        /// 按账单收款
        /// </summary>
        public void QueryAccountForCash()
        {
            CargoClientAccountEntity queryEntity = new CargoClientAccountEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            queryEntity.AccountID = Convert.ToString(Request["AccountID"]);

            if (Request["CheckStatus"] != "-1") { queryEntity.CheckStatus = Convert.ToString(Request["CheckStatus"]); }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);//所属仓库ID
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientID"]))) { queryEntity.ClientID = Convert.ToInt64(Request["ClientID"]); }
            queryEntity.Status = "1";
            queryEntity.FromTO = "5";//5账单收款
            queryEntity.RType = "0";//0收入1支出

            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoClientAccountEntity> list = bus.QueryAccountForCash(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询报销
        /// </summary>
        public void QueryExpenseForCash()
        {
            CargoExpenseEntity queryEntity = new CargoExpenseEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            //允许多个报销单号一起查询，用,逗号隔开
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ExID"]))) { queryEntity.ExpenseID = Convert.ToString(Request["ExID"]); }
            queryEntity.ExName = Convert.ToString(Request["ExName"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientID"])))
            {
                queryEntity.ClientID = Convert.ToInt32(Request["ClientID"]);
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientName"]))) { queryEntity.ClientName = Convert.ToString(Request["ClientName"]); }
            if (Request["CheckStatus"] != "-1") { queryEntity.CheckStatus = Convert.ToString(Request["CheckStatus"]); }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            queryEntity.Status = "3";
            queryEntity.FromTO = Convert.ToString(Request["FromTO"]);//"2";//按报销单收款
            queryEntity.RType = Convert.ToString(Request["RType"]);//"0";//收入
            queryEntity.ExType = Convert.ToString(Request["ExType"]);//"1";
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoExpenseEntity> list = bus.QueryExpenseForCash(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询来货单
        /// </summary>
        public void QueryPurchaseForCash()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            //允许多个报销单号一起查询，用,逗号隔开
            if (!string.IsNullOrEmpty(Convert.ToString(Request["OrderID"]))) { queryEntity.OrderNo = Convert.ToString(Request["OrderID"]); }
            queryEntity.CreateAwb = Convert.ToString(Request["CreateAwb"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientID"])))
            {
                queryEntity.ClientID = Convert.ToInt32(Request["ClientID"]);
            }
            if (Request["CheckStatus"] != "-1") { queryEntity.CheckStatus = Convert.ToString(Request["CheckStatus"]); }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            queryEntity.FromTO = Convert.ToString(Request["FromTO"]);
            queryEntity.RType = Convert.ToString(Request["RType"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoOrderEntity> list = bus.QueryPurchaseForCash(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询当前用户所在网点的银行卡信息
        /// </summary>
        public void AutoCompleteCard()
        {
            string tk = Request["tk"];
            CargoFinanceBasicDataEntity queryEntity = new CargoFinanceBasicDataEntity();
            queryEntity.Status = "0";
            queryEntity.CardType = tk;
            queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ApplyHouseID"])))
            {
                queryEntity.ApplyHouseID = Convert.ToString(Request["ApplyHouseID"]);
            }

            //分页
            int pageIndex = 1;
            int pageSize = 1000;
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = new Hashtable();
            list = bus.QueryFinanceBasicData(pageIndex, pageSize, queryEntity);
            //JSON
            String json = JSON.Encode(list["rows"]);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 客户返利款结款
        /// </summary>
        public void SaveRebateClientCash()
        {
            string json = Request["data"];
            string ty = Request["ty"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            CargoCashierEntity ent = new CargoCashierEntity();
            CargoFinanceBus bus = new CargoFinanceBus();
            List<string> entOrderNo = new List<string>();
            string awbidlist = string.Empty;

            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "出纳收款操作";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            try
            {
                decimal tot = 0.00M;
                #region 赋值
                ent.Memo = Convert.ToString(Request["Memo"]).Trim();
                ent.OP_ID = UserInfor.LoginName.Trim();
                ent.UserName = UserInfor.UserName.Trim();
                ent.RType = "0";//收支类型，0收入1支出
                ent.FromTO = ty;//按订单号收款
                tot = Convert.ToDecimal(Request["Total"]);//付款金额
                ent.CheckStatus = "1";
                ent.OP_DATE = DateTime.Now;
                ent.HouseName = Convert.ToString(Request["HouseName"]); //UserInfor.CityCode.Trim();//所属仓库
                #endregion

                #region 保存
                if (ty.Equals("0"))//按订单号结返利款
                {
                    string client = string.Empty;
                    log.Memo = "返利账户结款成功";
                    int cNum = 0; decimal shouJE = 0.00M; decimal PreReciveMoney = 0.00M; string boss = string.Empty;
                    foreach (Hashtable row in GridRows)
                    {
                        if (Convert.ToString(row["OrderModel"]).Equals("1"))
                        {
                            msg.Message = "不允许结退款订单"; msg.Result = false; break;
                        }
                        if (Convert.ToDecimal(row["RebateMoney"]) <= 0)
                        {
                            msg.Message = "返利款余额为0"; msg.Result = false; break;
                        }
                        if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                        if (cNum.Equals(0))
                        {
                            boss = Convert.ToString(row["AcceptPeople"]);
                            cNum = Convert.ToInt32(row["ClientNum"]);
                            shouJE = Convert.ToDecimal(row["TransportFee"]) - Convert.ToDecimal(row["ReceivedMoney"]);
                            PreReciveMoney = Convert.ToDecimal(row["RebateMoney"]);
                            if (PreReciveMoney < shouJE) { entOrderNo.Add(Convert.ToString(row["OrderNo"])); break; }
                        }
                        else
                        {
                            if (cNum.Equals(Convert.ToInt32(row["ClientNum"])))
                            {
                                shouJE += Convert.ToDecimal(row["TransportFee"]) - Convert.ToDecimal(row["ReceivedMoney"]);
                                if (PreReciveMoney < shouJE)
                                {
                                    //msg.Message = "客户：" + boss + "的返利账户金额不足以支付本次结款";
                                    //msg.Result = false;
                                    entOrderNo.Add(Convert.ToString(row["OrderNo"]));
                                    break;
                                }
                            }
                            else
                            {
                                if (PreReciveMoney < shouJE)
                                {
                                    //msg.Message = "客户：" + boss + "的返利账户金额不足以支付本次结款";
                                    //msg.Result = false;
                                    entOrderNo.Add(Convert.ToString(row["OrderNo"]));
                                    break;
                                }
                                cNum = Convert.ToInt32(row["ClientNum"]);
                                shouJE = Convert.ToDecimal(row["TransportFee"]) - Convert.ToDecimal(row["ReceivedMoney"]);
                                PreReciveMoney = Convert.ToDecimal(row["RebateMoney"]);
                                boss = Convert.ToString(row["AcceptPeople"]);
                            }
                        }
                        entOrderNo.Add(Convert.ToString(row["OrderNo"]));
                        client = Convert.ToString(row["AcceptPeople"]) + "/" + Convert.ToString(row["AcceptUnit"]);
                    }
                    ent.OrderNo = entOrderNo;
                    ent.AffectClient = client;
                }
                else if (ty.Equals("5"))//按账单结返利款
                {
                    string client = string.Empty;
                    log.Memo = "返利账户结款成功";
                    int cNum = 0; decimal shouJE = 0.00M; decimal PreReciveMoney = 0.00M; string boss = string.Empty;
                    foreach (Hashtable row in GridRows)
                    {
                        if (Convert.ToDecimal(row["RebateMoney"]) <= 0)
                        {
                            msg.Message = "返利款余额为0"; msg.Result = false; break;
                        }
                        if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                        if (cNum.Equals(0))
                        {
                            boss = Convert.ToString(row["ClientName"]);//客户名
                            cNum = Convert.ToInt32(row["ClientNum"]);
                            shouJE = Convert.ToDecimal(row["Total"]) - Convert.ToDecimal(row["ReceivedMoney"]);
                            PreReciveMoney = Convert.ToDecimal(row["RebateMoney"]);//返利款
                            if (PreReciveMoney < shouJE) { entOrderNo.Add(Convert.ToString(row["AccountID"])); break; }
                        }
                        else
                        {
                            if (cNum.Equals(Convert.ToInt32(row["ClientNum"])))
                            {
                                shouJE += Convert.ToDecimal(row["Total"]) - Convert.ToDecimal(row["ReceivedMoney"]);
                                if (PreReciveMoney < shouJE)
                                {
                                    //msg.Message = "客户：" + boss + "的返利账户金额不足以支付本次结款";
                                    //msg.Result = false;
                                    entOrderNo.Add(Convert.ToString(row["AccountID"]));
                                    break;
                                }
                            }
                            else
                            {
                                if (PreReciveMoney < shouJE)
                                {
                                    //msg.Message = "客户：" + boss + "的返利账户金额不足以支付本次结款";
                                    //msg.Result = false;
                                    entOrderNo.Add(Convert.ToString(row["AccountID"]));
                                    break;
                                }
                                cNum = Convert.ToInt32(row["ClientNum"]);
                                shouJE = Convert.ToDecimal(row["Total"]) - Convert.ToDecimal(row["ReceivedMoney"]);
                                PreReciveMoney = Convert.ToDecimal(row["RebateMoney"]);
                                boss = Convert.ToString(row["ClientName"]);
                            }
                        }
                        entOrderNo.Add(Convert.ToString(row["AccountID"]));
                        client = Convert.ToString(row["ClientName"]);
                    }
                    ent.OrderNo = entOrderNo;
                    ent.AffectClient = client;
                }
                #endregion
                if (msg.Result)
                {
                    bus.SaveRebateClientCash(ent, log);
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }
        /// <summary>
        /// 扣客户预收款
        /// </summary>
        public void SavePreClientCash()
        {
            string json = Request["data"];
            string ty = Request["ty"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            CargoCashierEntity ent = new CargoCashierEntity();
            CargoFinanceBus bus = new CargoFinanceBus();
            List<string> entOrderNo = new List<string>();
            string awbidlist = string.Empty;

            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "出纳收款操作";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            try
            {
                decimal tot = 0.00M;
                #region 赋值
                ent.Memo = Convert.ToString(Request["Memo"]).Trim();
                ent.OP_ID = UserInfor.LoginName;
                ent.UserName = UserInfor.UserName;
                ent.RType = "0";//收支类型，0收入1支出
                ent.FromTO = ty;//按订单号收款
                tot = Convert.ToDecimal(Request["Total"]);//付款金额
                ent.CheckStatus = "1";
                ent.HouseName = Convert.ToString(Request["HouseName"]); //UserInfor.CityCode.Trim();//所属仓库
                #endregion

                #region 保存
                if (ty.Equals("0"))//按订单号收款
                {
                    log.Memo = "预收款结款成功";
                    string client = string.Empty;
                    int cNum = 0; decimal shouJE = 0.00M; decimal PreReciveMoney = 0.00M; string boss = string.Empty;
                    foreach (Hashtable row in GridRows)
                    {
                        if (Convert.ToString(row["OrderModel"]).Equals("1"))
                        {
                            msg.Message = "不允许结退款订单";
                            msg.Result = false;
                            break;
                        }
                        if (Convert.ToDecimal(row["PreReceiveMoney"]) <= 0)
                        {
                            msg.Message = "预收款余额为0";
                            msg.Result = false;
                            break;
                        }
                        if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                        if (cNum.Equals(0))
                        {
                            cNum = Convert.ToInt32(row["ClientNum"]);
                            shouJE = Convert.ToDecimal(row["TransportFee"]) - Convert.ToDecimal(row["ReceivedMoney"]);
                            PreReciveMoney = Convert.ToDecimal(row["PreReceiveMoney"]);
                            if (PreReciveMoney < shouJE)
                            {
                                entOrderNo.Add(Convert.ToString(row["OrderNo"]));
                                //msg.Message = "客户：" + boss + "的预收款金额不足以支付本次结款";
                                //msg.Result = false;
                                break;
                            }
                            //boss = Convert.ToString(row["AcceptPeople"]);
                        }
                        else
                        {
                            if (cNum.Equals(Convert.ToInt32(row["ClientNum"])))
                            {
                                shouJE += Convert.ToDecimal(row["TransportFee"]) - Convert.ToDecimal(row["ReceivedMoney"]);
                                if (PreReciveMoney < shouJE)
                                {
                                    entOrderNo.Add(Convert.ToString(row["OrderNo"]));
                                    //msg.Message = "客户：" + boss + "的预收款金额不足以支付本次结款";
                                    //msg.Result = false;
                                    break;
                                }
                            }
                            else
                            {
                                if (PreReciveMoney < shouJE)
                                {
                                    //msg.Message = "客户：" + boss + "的预收款金额不足以支付本次结款";
                                    //msg.Result = false;
                                    entOrderNo.Add(Convert.ToString(row["OrderNo"]));
                                    break;
                                }
                                cNum = Convert.ToInt32(row["ClientNum"]);
                                shouJE = Convert.ToDecimal(row["TransportFee"]) - Convert.ToDecimal(row["ReceivedMoney"]);
                                PreReciveMoney = Convert.ToDecimal(row["PreReceiveMoney"]);
                                boss = Convert.ToString(row["AcceptPeople"]);
                            }
                        }
                        entOrderNo.Add(Convert.ToString(row["OrderNo"]));
                        client = Convert.ToString(row["AcceptPeople"]) + "/" + Convert.ToString(row["AcceptUnit"]);
                    }
                    ent.AffectClient = client;
                    ent.OrderNo = entOrderNo;
                }
                else if (ty.Equals("5"))
                {
                    log.Memo = "预收款结款成功";
                    string client = string.Empty;
                    int cNum = 0; decimal shouJE = 0.00M; decimal PreReciveMoney = 0.00M; string boss = string.Empty;
                    foreach (Hashtable row in GridRows)
                    {
                        if (Convert.ToDecimal(row["PreReceiveMoney"]) <= 0)
                        {
                            msg.Message = "预收款余额为0";
                            msg.Result = false;
                            break;
                        }
                        if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                        if (cNum.Equals(0))
                        {
                            cNum = Convert.ToInt32(row["ClientNum"]);
                            shouJE = Convert.ToDecimal(row["Total"]) - Convert.ToDecimal(row["ReceivedMoney"]);
                            PreReciveMoney = Convert.ToDecimal(row["PreReceiveMoney"]);
                            if (PreReciveMoney < shouJE)
                            {
                                entOrderNo.Add(Convert.ToString(row["AccountID"]));
                                //msg.Message = "客户：" + boss + "的预收款金额不足以支付本次结款";
                                //msg.Result = false;
                                break;
                            }
                            //boss = Convert.ToString(row["AcceptPeople"]);
                        }
                        else
                        {
                            if (cNum.Equals(Convert.ToInt32(row["ClientNum"])))
                            {
                                shouJE += Convert.ToDecimal(row["Total"]) - Convert.ToDecimal(row["ReceivedMoney"]);
                                if (PreReciveMoney < shouJE)
                                {
                                    entOrderNo.Add(Convert.ToString(row["AccountID"]));
                                    //msg.Message = "客户：" + boss + "的预收款金额不足以支付本次结款";
                                    //msg.Result = false;
                                    break;
                                }
                            }
                            else
                            {
                                if (PreReciveMoney < shouJE)
                                {
                                    //msg.Message = "客户：" + boss + "的预收款金额不足以支付本次结款";
                                    //msg.Result = false;
                                    entOrderNo.Add(Convert.ToString(row["AccountID"]));
                                    break;
                                }
                                cNum = Convert.ToInt32(row["ClientNum"]);
                                shouJE = Convert.ToDecimal(row["Total"]) - Convert.ToDecimal(row["ReceivedMoney"]);
                                PreReciveMoney = Convert.ToDecimal(row["PreReceiveMoney"]);
                                boss = Convert.ToString(row["ClientName"]);
                            }
                        }
                        entOrderNo.Add(Convert.ToString(row["AccountID"]));
                        client = Convert.ToString(row["ClientName"]);
                    }
                    ent.AffectClient = client;
                    ent.OrderNo = entOrderNo;
                }
                #endregion
                if (msg.Result)
                {
                    bus.SavePreClientCash(ent, log);
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }
        /// <summary>
        /// 结客户返利款
        /// </summary>
        public void SaveRebote()
        {
            string json = Request["data"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            CargoCashierEntity ent = new CargoCashierEntity();
            CargoFinanceBus bus = new CargoFinanceBus();

            List<CargoClientPreRecordEntity> preRecordList = new List<CargoClientPreRecordEntity>();
            List<string> entOrderNo = new List<string>();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "出纳收款操作";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            try
            {
                decimal tot = 0.00M;
                tot = Convert.ToDecimal(Request["Total"]);
                ent.CheckStatus = "1";
                bool ExYS = false; bool NoExYS = false;
                foreach (Hashtable row in GridRows)
                {
                    string[] ys = Convert.ToString(row["CostName"]).Split(',');
                    if (ys.Length <= 0) { continue; }
                    for (int i = 0; i < ys.Length; i++)
                    {
                        if (string.IsNullOrEmpty(ys[i])) { continue; }
                        if (ys[i].Equals("营业返利"))
                        {
                            ExYS = true;
                        }
                        else
                        {
                            NoExYS = true;
                        }
                    }
                }
                //即有预收款又有预收款
                if (ExYS && NoExYS)
                {
                    msg.Message = "返利报销不能和其它报销一起操作";
                    msg.Result = false;
                }
                //说明全部是返利
                if (ExYS && !NoExYS)
                {
                    int f = 1;
                    int cid = 0;
                    string exid = string.Empty;
                    foreach (Hashtable row in GridRows)
                    {
                        if (f.Equals(1))
                        {
                            cid = Convert.ToInt32(row["ClientID"]);
                        }
                        else
                        {
                            if (!cid.Equals(Convert.ToInt32(row["ClientID"])))
                            {
                                msg.Message = "返利报销客户名称不相同";
                                msg.Result = false;
                                break;
                            }
                        }
                        exid += Convert.ToString(row["ExID"]).Trim() + ",";
                        f++;
                    }
                    preRecordList.Add(new CargoClientPreRecordEntity
                    {
                        ClientID = Convert.ToInt64(cid),
                        ExID = exid,
                        Money = tot,
                        RecordType = "0",
                        OperaType = "1",
                        OP_ID = UserInfor.LoginName
                    });
                }

                if (msg.Result)
                {
                    #region 保存
                    log.Memo = "返利收款成功，客户ID：" + preRecordList[0].ClientID.ToString() + "，报销金额：" + tot.ToString();
                    foreach (Hashtable row in GridRows)
                    {
                        if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                        entOrderNo.Add(Convert.ToString(row["ExID"]));
                    }
                    ent.OrderNo = entOrderNo;

                    #endregion
                    ent.clientPreRecord = preRecordList;
                    bus.SaveRebote(ent, log);
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 出纳收款 
        /// </summary>
        public void SaveCash()
        {
            string json = Request["data"];
            string ty = Request["ty"];
            string cStarus = Request["cStarus"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            CargoCashierEntity ent = new CargoCashierEntity();
            CargoFinanceBus bus = new CargoFinanceBus();

            List<CargoClientPreRecordEntity> preRecordList = new List<CargoClientPreRecordEntity>();
            List<string> entOrderNo = new List<string>();
            string awbidlist = string.Empty;

            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "出纳收款操作";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "A";
            try
            {
                decimal tot = 0.00M;
                #region 赋值
                ent.BasicID = string.IsNullOrEmpty(Convert.ToString(Request["BasicID"])) ? 0 : Convert.ToInt32(Request["BasicID"]);//银行卡ID
                ent.CashID = string.IsNullOrEmpty(Convert.ToString(Request["CashID"])) ? 0 : Convert.ToInt32(Request["CashID"]);//现金账号ID
                ent.WxID = string.IsNullOrEmpty(Convert.ToString(Request["WX"])) ? 0 : Convert.ToInt32(Request["WX"]);//微信ID
                ent.AliID = string.IsNullOrEmpty(Convert.ToString(Request["ALIPAY"])) ? 0 : Convert.ToInt32(Request["ALIPAY"]);//支付宝ID
                ent.AffectCash = string.IsNullOrEmpty(Convert.ToString(Request["Cash"])) ? 0 : Convert.ToDecimal(Request["Cash"]);//现金
                ent.AffectCard = string.IsNullOrEmpty(Convert.ToString(Request["ReceiveMoney"])) ? 0 : Convert.ToDecimal(Request["ReceiveMoney"]);//银行卡
                ent.AffectWX = string.IsNullOrEmpty(Convert.ToString(Request["WxMoney"])) ? 0 : Convert.ToDecimal(Request["WxMoney"]);//微信金额
                ent.AffectAlipay = string.IsNullOrEmpty(Convert.ToString(Request["AliMoney"])) ? 0 : Convert.ToDecimal(Request["AliMoney"]);//支付宝金额
                ent.Memo = Convert.ToString(Request["Memo"]).Trim();
                ent.OP_ID = UserInfor.LoginName.Trim();
                ent.UserName = UserInfor.UserName.Trim();
                ent.RType = "0";//收支类型，0收入1支出
                ent.FromTO = ty;//按订单号收款
                tot = Convert.ToDecimal(Request["Total"]);
                ent.CheckStatus = "1";
                if (ent.AffectCard + ent.AffectCash + ent.AffectWX + ent.AffectAlipay < tot)//收取现金,卡金额总和小于应收货款，结算状态为未结清
                {
                    ent.CheckStatus = "2";
                }
                ent.ClientNum = string.IsNullOrEmpty(Convert.ToString(Request["ClientNum"])) ? 0 : Convert.ToInt32(Request["ClientNum"]);
                ent.HouseName = Convert.ToString(Request["HouseName"]); //UserInfor.CityCode.Trim();//所属仓库
                #endregion
                //如果有银行卡收款
                if (ent.AffectCard != 0)
                {
                    if (ent.BasicID.Equals(0))
                    {
                        msg.Message = "请选择收款银行卡账号";
                        msg.Result = false;
                    }
                }
                //现金收款
                if (ent.AffectCash != 0)
                {
                    if (ent.CashID.Equals(0))
                    {
                        msg.Message = "请选择收款现金账户";
                        msg.Result = false;
                    }
                    //FinanceBasicDataEntity fbd = bus.GetFinanceBasicDataByCityCode(ent.City, "0");
                    CargoFinanceBasicDataEntity fbd = bus.GetFinanceBasicDataByID(ent.CashID);
                    if (fbd.BasicID <= 0)
                    {
                        msg.Message = ent.HouseName + "没有现金账户，请创建现金账户";
                        msg.Result = false;
                    }
                }
                //如果有微信收款
                if (ent.AffectWX != 0)
                {
                    if (ent.WxID.Equals(0))
                    {
                        msg.Message = "请选择微信收款账号";
                        msg.Result = false;
                    }
                }
                //如果有微信收款
                if (ent.AffectAlipay != 0)
                {
                    if (ent.AliID.Equals(0))
                    {
                        msg.Message = "请选择支付宝收款账号";
                        msg.Result = false;
                    }
                }
                //如果是报销收款，则判断下是否全部是预收款
                if (ty.Equals("2"))
                {
                    bool ExYS = false; bool NoExYS = false;
                    foreach (Hashtable row in GridRows)
                    {
                        string[] ys = Convert.ToString(row["CostName"]).Split(',');
                        if (ys.Length <= 0) { continue; }
                        for (int i = 0; i < ys.Length; i++)
                        {
                            if (string.IsNullOrEmpty(ys[i])) { continue; }
                            if (ys[i].Equals("预收款"))
                            {
                                ExYS = true;
                            }
                            else
                            {
                                NoExYS = true;
                            }
                        }
                    }
                    //即有预收款又有预收款
                    if (ExYS && NoExYS)
                    {
                        msg.Message = "预收款报销不能和其它报销一起操作";
                        msg.Result = false;
                    }
                    //说明全部是预收款
                    if (ExYS && !NoExYS)
                    {
                        int f = 1;
                        int cid = 0;
                        string exid = string.Empty;
                        foreach (Hashtable row in GridRows)
                        {
                            if (f.Equals(1))
                            {
                                cid = Convert.ToInt32(row["ClientID"]);
                            }
                            else
                            {
                                if (!cid.Equals(Convert.ToInt32(row["ClientID"])))
                                {
                                    msg.Message = "预收款客户名称不相同";
                                    msg.Result = false;
                                    break;
                                }
                            }
                            exid += Convert.ToString(row["ExID"]).Trim() + ",";
                            f++;
                        }
                        preRecordList.Add(new CargoClientPreRecordEntity
                        {
                            ClientID = Convert.ToInt64(cid),
                            ExID = exid,
                            Money = tot,
                            RecordType = "0",
                            OperaType = "0",
                            OP_ID = UserInfor.LoginName
                        });
                    }
                }
                if (msg.Result)
                {
                    #region 保存
                    //string cn = string.Empty;
                    string client = string.Empty;
                    switch (ty)
                    {
                        case "0"://按订单号收款
                            log.Memo = "按订单收款成功";
                            foreach (Hashtable row in GridRows)
                            {
                                if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                                //cn = Convert.ToString(row["AwbNo"]).Trim();
                                entOrderNo.Add(Convert.ToString(row["OrderNo"]));
                                awbidlist += Convert.ToString(row["OrderNo"]).Trim() + ",";
                                client = Convert.ToString(row["PayClientName"]) + "/" + Convert.ToString(row["AcceptUnit"]);
                            }
                            if (GridRows.Count == 1)
                            {
                                //yishou = bus.QueryFinanceRecordByNo(cn, "0", "0");
                                if ((ent.AffectCash + ent.AffectCard + ent.AffectWX + ent.AffectAlipay) == tot)
                                {
                                    ent.CheckStatus = "1";
                                }
                            }
                            if (!cStarus.Equals("1"))
                            {
                                CargoOrderBus order = new CargoOrderBus();
                                decimal orderTot = 0.00M;
                                foreach (var item in entOrderNo)
                                {
                                    CargoOrderEntity ord = order.QueryOrderInfo(new CargoOrderEntity { OrderNo = Convert.ToString(item) });
                                    orderTot += ord.OrderModel.Equals("1") ? -ord.TotalCharge : ord.TotalCharge;
                                    if (ord.CheckStatus.ToString() != "0")
                                    {
                                        decimal record = bus.QueryFinanceRecordByNo(Convert.ToString(ord.OrderNo), "0", "0");
                                        orderTot -= record;
                                    }
                                }
                                if (ent.CheckStatus == "1" && orderTot != tot)
                                {
                                    msg.Message = "数据已更新请重新查询后操作";
                                    msg.Result = false;
                                    break;
                                }
                            }
                            ent.AffectClient = client;
                            ent.OrderNo = entOrderNo;
                            break;
                        case "5"://按账单号收款
                            log.Memo = "按账单收款成功";
                            foreach (Hashtable row in GridRows)
                            {
                                if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                                //cn = Convert.ToString(row["AccountID"]).Trim();
                                entOrderNo.Add(Convert.ToString(row["AccountID"]));
                                awbidlist += Convert.ToString(row["AccountID"]).Trim() + ",";
                                client = Convert.ToString(row["ClientName"]);
                            }
                            if (GridRows.Count == 1)
                            {
                                if ((ent.AffectCash + ent.AffectCard + ent.AffectWX + ent.AffectAlipay) == tot)
                                {
                                    ent.CheckStatus = "1";
                                }
                            }
                            ent.AffectClient = client;
                            ent.OrderNo = entOrderNo;
                            break;
                        case "2"://按报销单号收款
                            log.Memo = "按报销单收款成功";
                            foreach (Hashtable row in GridRows)
                            {
                                if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                                //cn = Convert.ToString(row["ExID"]).Trim();
                                entOrderNo.Add(Convert.ToString(row["ExID"]));
                                awbidlist += Convert.ToString(row["ExID"]).Trim() + ",";
                            }
                            if (GridRows.Count == 1)
                            {
                                //yishou = bus.QueryFinanceRecordByNo(cn, "0", "2");
                                if ((ent.AffectCash + ent.AffectCard + ent.AffectWX + ent.AffectAlipay) == tot)
                                {
                                    ent.CheckStatus = "1";
                                }
                            }
                            ent.OrderNo = entOrderNo;
                            break;
                        case "13"://其它业务收款
                            log.Memo = "其它业务收款成功";
                            foreach (Hashtable row in GridRows)
                            {
                                if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                                entOrderNo.Add(Convert.ToString(row["ID"]));
                                awbidlist += Convert.ToString(row["ID"]).Trim() + ",";
                            }
                            if (GridRows.Count == 1)
                            {
                                if ((ent.AffectCash + ent.AffectCard + ent.AffectWX + ent.AffectAlipay) == tot)
                                {
                                    ent.CheckStatus = "1";
                                }
                            }
                            ent.OrderNo = entOrderNo;
                            break;
                        //case "8"://代收款
                        //    log.Content = "代收款收款出纳收款成功";
                        //    foreach (Hashtable row in GridRows)
                        //    {
                        //        if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                        //        cn = Convert.ToString(row["AwbNo"]).Trim();
                        //        entAwbNo.Add(Convert.ToString(row["AwbNo"]));
                        //        entDest.Add(Convert.ToInt64(row["AwbID"]));
                        //        awbidlist += Convert.ToString(row["AwbNo"]).Trim() + ",";
                        //    }
                        //    if (GridRows.Count == 1)
                        //    {
                        //        yishou = bus.QueryFinanceRecordByNo(cn, "0", "8", UserInfor.BelongSystem);
                        //        if ((ent.AffectCash + ent.AffectMoney + ent.AffectOil + yishou) == tot)
                        //        {
                        //            ent.CheckStatus = "1";
                        //        }
                        //    }
                        //    ent.AwbID = entDest;
                        //    ent.AwbNo = entAwbNo;
                        //    break;
                        //case "9"://回扣
                        //    log.Content = "回扣收款出纳收款成功";
                        //    foreach (Hashtable row in GridRows)
                        //    {
                        //        if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                        //        cn = Convert.ToString(row["AwbNo"]).Trim();
                        //        entAwbNo.Add(Convert.ToString(row["AwbNo"]));
                        //        entDest.Add(Convert.ToInt64(row["AwbID"]));
                        //        awbidlist += Convert.ToString(row["AwbNo"]).Trim() + ",";
                        //    }
                        //    if (GridRows.Count == 1)
                        //    {
                        //        yishou = bus.QueryFinanceRecordByNo(cn, "0", "9", UserInfor.BelongSystem);
                        //        if ((ent.AffectCash + ent.AffectMoney + ent.AffectOil + yishou) == tot)
                        //        {
                        //            ent.CheckStatus = "1";
                        //        }
                        //    }
                        //    ent.AwbID = entDest;
                        //    ent.AwbNo = entAwbNo;
                        //    break;
                        default:
                            break;
                    }
                    #endregion
                    if (cStarus.Equals("1"))//强制结清
                    {
                        ent.CheckStatus = "1";
                    }
                    ent.clientPreRecord = preRecordList;
                    ent.AffectAwbNO = awbidlist;
                    if (msg.Result)
                    {
                        bus.SaveCash(ent, log);
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
#if !DEBUG
            try
            {
                if (msg.Result)
                {
                    CargoHouseBus house = new CargoHouseBus();
                    CargoOrderBus orderBus = new CargoOrderBus();
                    CargoHouseEntity houseEnt = house.QueryCargoHouseByID(82);
                    log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
                    log.Moudle = "订单修改";
                    log.NvgPage = "修改订单延迟发货状态";
                    log.UserID = UserInfor.UserID.ToString();
                    log.Status = "0";
                    log.Operate = "U";
                    foreach (var item in ent.OrderNo)
                    {
                        if (!string.IsNullOrEmpty(houseEnt.HouseCode) && item.Contains(houseEnt.HouseCode))
                        {
                            CargoOrderEntity orderEnt = orderBus.QueryOrderInfo(new CargoOrderEntity { OrderNo = item });
                            if (orderEnt.ThrowGood.Equals("21") && orderEnt.PostponeShip.Equals("1"))
                            {
                                orderBus.InsertCargoOrderPush(new CargoOrderPushEntity
                                {
                                    OrderNo = orderEnt.OrderNo,
                                    Dep = orderEnt.Dep,
                                    Dest = orderEnt.Dest,
                                    Piece = orderEnt.Piece,
                                    TransportFee = orderEnt.TransportFee,
                                    ClientNum = orderEnt.ClientNum.ToString(),
                                    AcceptAddress = orderEnt.AcceptAddress,
                                    AcceptCellphone = orderEnt.AcceptCellphone,
                                    AcceptTelephone = orderEnt.AcceptTelephone,
                                    AcceptPeople = orderEnt.AcceptPeople,
                                    AcceptUnit = orderEnt.AcceptUnit,
                                    HouseName = houseEnt.Name,
                                    OP_ID = UserInfor.UserName,
                                    PushType = "0",
                                    PushStatus = "0"
                                }, log);
                                orderBus.UpdateCargoOrderPostponeShipStatus(new CargoOrderEntity { OrderNo = orderEnt.OrderNo, CheckDate = DateTime.Now, PostponeShip = "2" }, log);

                                int tag = 35;
                                string good = string.Empty;
                                //foreach (var it in cargoShow)
                                //{
                                //    good += "品牌：" + it.TypeName + "，规格：" + it.Specs + "，" + it.Figure + "，" + it.LoadIndex + it.SpeedLevel + "，数量：" + it.Piece.ToString() + " |";
                                //    TPiece += it.Piece;
                                //}
                                //微信企业号推送
                                QySendInfoEntity send = new QySendInfoEntity();
                                send.title = "出库通知";
                                send.msgType = msgType.textcard;
                                //send.toUser = "1000";
                                send.toTag = Convert.ToString(tag);
                                send.content = "<div>出库仓库：" + houseEnt.Name + "</div><div>订单号码：" + orderEnt.OrderNo + "   " + orderEnt.Dest + "</div><div>订单数量：" + orderEnt.Piece.ToString() + " 条</div><div>公司名称：" + orderEnt.AcceptUnit + "</div><div>收货人：" + orderEnt.AcceptPeople + " " + orderEnt.AcceptCellphone + "</div><div>收货地址：" + orderEnt.AcceptAddress + "</div><div>业务员：" + orderEnt.SaleManName + "</div><div>订单已确认收款，请尽快扫描出库！！！</div>";
                                send.url = "http://dlt.neway5.com";
                                QyConfigEntity agentEnt = new QyConfigEntity();
                                agentEnt.AgentID = "1000022";
                                agentEnt.AgentSecret = "-ohxtwczR68LIyyo9wYILfV4UKtGcCaes3VZYqpsYyE";
                                WxQYSendHelper.HLYQYPushInfo(agentEnt, send);
                            }
                        }
                    }
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
#endif
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        /// <summary>
        /// 出纳付款
        /// </summary>
        public void SaveCashPay()
        {
            string json = Request["data"];
            string ty = Request["ty"];
            string cStarus = Request["cStarus"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            CargoCashierEntity ent = new CargoCashierEntity();
            CargoFinanceBus bus = new CargoFinanceBus();

            List<string> entOrderNo = new List<string>();
            string awbidlist = string.Empty;

            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "出纳付款操作";
            log.UserID = UserInfor.LoginName.Trim();
            log.Status = "0";
            log.Operate = "A";
            try
            {
                decimal tot = 0.00M;
                #region 赋值
                ent.BasicID = string.IsNullOrEmpty(Convert.ToString(Request["BasicID"])) ? 0 : Convert.ToInt32(Request["BasicID"]);//银行卡ID
                ent.CashID = string.IsNullOrEmpty(Convert.ToString(Request["CashID"])) ? 0 : Convert.ToInt32(Request["CashID"]);//现金账号ID
                ent.WxID = string.IsNullOrEmpty(Convert.ToString(Request["WX"])) ? 0 : Convert.ToInt32(Request["WX"]);//微信ID
                ent.AliID = string.IsNullOrEmpty(Convert.ToString(Request["ALIPAY"])) ? 0 : Convert.ToInt32(Request["ALIPAY"]);//支付宝ID
                ent.AffectCash = string.IsNullOrEmpty(Convert.ToString(Request["Cash"])) ? 0 : Convert.ToDecimal(Request["Cash"]);//现金
                ent.AffectCard = string.IsNullOrEmpty(Convert.ToString(Request["ReceiveMoney"])) ? 0 : Convert.ToDecimal(Request["ReceiveMoney"]);//银行卡
                ent.AffectWX = string.IsNullOrEmpty(Convert.ToString(Request["WxMoney"])) ? 0 : Convert.ToDecimal(Request["WxMoney"]);//微信金额
                ent.AffectAlipay = string.IsNullOrEmpty(Convert.ToString(Request["AliMoney"])) ? 0 : Convert.ToDecimal(Request["AliMoney"]);//支付宝金额
                ent.Memo = Convert.ToString(Request["Memo"]).Trim();
                ent.OP_ID = UserInfor.LoginName.Trim();
                ent.UserName = UserInfor.UserName.Trim();
                ent.RType = "1";//收支类型，0收入1支出
                ent.FromTO = ty;//按报销单号付款
                tot = Convert.ToDecimal(Request["Total"]);
                ent.CheckStatus = "1";
                if (ent.AffectCard + ent.AffectCash + ent.AffectWX + ent.AffectAlipay < tot)//收取现金,卡金额总和小于应收货款，结算状态为未结清
                {
                    ent.CheckStatus = "2";
                }
                //ent.ClientNum = string.IsNullOrEmpty(Convert.ToString(Request["ClientNum"])) ? 0 : Convert.ToInt32(Request["ClientNum"]);
                ent.HouseName = Convert.ToString(Request["HouseName"]); //UserInfor.CityCode.Trim();//所属仓库
                #endregion
                //如果有银行卡付款
                if (ent.AffectCard != 0)
                {
                    if (ent.BasicID.Equals(0))
                    {
                        msg.Message = "请选择付款银行卡账号";
                        msg.Result = false;
                    }
                }
                //现金付款
                if (ent.AffectCash != 0)
                {
                    if (ent.CashID.Equals(0))
                    {
                        msg.Message = "请选择付款现金账户";
                        msg.Result = false;
                    }
                    //FinanceBasicDataEntity fbd = bus.GetFinanceBasicDataByCityCode(ent.City, "0");
                    CargoFinanceBasicDataEntity fbd = bus.GetFinanceBasicDataByID(ent.CashID);
                    if (fbd.BasicID <= 0)
                    {
                        msg.Message = ent.HouseName + "没有现金账户，请创建现金账户";
                        msg.Result = false;
                    }
                }
                //如果有微信付款
                if (ent.AffectWX != 0)
                {
                    if (ent.WxID.Equals(0))
                    {
                        msg.Message = "请选择微信付款账号";
                        msg.Result = false;
                    }
                }
                //如果有支付宝付款
                if (ent.AffectAlipay != 0)
                {
                    if (ent.AliID.Equals(0))
                    {
                        msg.Message = "请选择支付宝付款账号";
                        msg.Result = false;
                    }
                }
                if (msg.Result)
                {
                    string cn = string.Empty;
                    switch (ty)
                    {
                        case "3"://报销付款
                            log.Memo = "按报销单付款成功";
                            foreach (Hashtable row in GridRows)
                            {
                                if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                                cn = Convert.ToString(row["ExID"]).Trim();
                                entOrderNo.Add(Convert.ToString(row["ExID"]));
                                awbidlist += Convert.ToString(row["ExID"]).Trim() + ",";
                            }
                            if (GridRows.Count == 1)
                            {
                                //yishou = bus.QueryFinanceRecordByNo(cn, "0", "2");
                                if ((ent.AffectCash + ent.AffectCard + ent.AffectWX + ent.AffectAlipay) == tot)
                                {
                                    ent.CheckStatus = "1";
                                }
                            }
                            ent.OrderNo = entOrderNo;
                            break;
                        case "4"://物流账单付款
                            log.Memo = "按物流账单付款成功";
                            foreach (Hashtable row in GridRows)
                            {
                                if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                                cn = Convert.ToString(row["AccountNo"]).Trim();
                                entOrderNo.Add(Convert.ToString(row["AccountNo"]));
                                awbidlist += Convert.ToString(row["AccountNo"]).Trim() + ",";
                            }
                            if (GridRows.Count == 1)
                            {
                                //yishou = bus.QueryFinanceRecordByNo(cn, "0", "2");
                                if ((ent.AffectCash + ent.AffectCard + ent.AffectWX + ent.AffectAlipay) == tot)
                                {
                                    ent.CheckStatus = "1";
                                }
                            }
                            ent.OrderNo = entOrderNo;
                            break;
                        case "6":
                            log.Memo = "按进货单付款成功";
                            foreach (Hashtable row in GridRows)
                            {
                                ent.AffectClient = Convert.ToString(row["ClientNum"]);
                                ent.ClientNum = Convert.ToInt32(row["ClientNum"]);
                                if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                                cn = Convert.ToString(row["OrderID"]).Trim();
                                entOrderNo.Add(Convert.ToString(row["OrderID"]));
                                awbidlist += Convert.ToString(row["OrderID"]).Trim() + ",";
                            }
                            if (GridRows.Count == 1)
                            {
                                //yishou = bus.QueryFinanceRecordByNo(cn, "0", "2");
                                if ((ent.AffectCash + ent.AffectCard + ent.AffectWX + ent.AffectAlipay) == tot)
                                {
                                    ent.CheckStatus = "1";
                                }
                            }
                            ent.OrderNo = entOrderNo;
                            break;
                        case "14":
                            log.Memo = "其他业务付款成功";
                            foreach (Hashtable row in GridRows)
                            {
                                if (Convert.ToString(row["CheckStatus"]).Equals("1")) { continue; }
                                entOrderNo.Add(Convert.ToString(row["ID"]));
                                awbidlist += Convert.ToString(row["ID"]).Trim() + ",";
                            }
                            if (GridRows.Count == 1)
                            {
                                //yishou = bus.QueryFinanceRecordByNo(cn, "0", "2");
                                if ((ent.AffectCash + ent.AffectCard + ent.AffectWX + ent.AffectAlipay) == tot)
                                {
                                    ent.CheckStatus = "1";
                                }
                            }
                            ent.OrderNo = entOrderNo;
                            break;
                        default:
                            break;
                    }
                    if (cStarus.Equals("1"))//强制结清
                    {
                        ent.CheckStatus = "1";
                    }
                    ent.AffectAwbNO = awbidlist;
                    bus.SaveCash(ent, log);
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
        #region 出纳资金管理
        /// <summary>
        /// 资金明细收支数据查询
        /// </summary>
        public void QueryIncomePayDetail()
        {
            CargoCashierEntity queryEntity = new CargoCashierEntity();
            //查询条件
            if (Request["CardType"] != "-1") { queryEntity.CardType = Convert.ToString(Request["CardType"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["CardNum"]))) { queryEntity.BasicID = Convert.ToInt32(Request["CardNum"]); }
            if (Request["RType"] != "-1") { queryEntity.RType = Convert.ToString(Request["RType"]); }
            if (Request["FromTO"] != "-1") { queryEntity.FromTO = Convert.ToString(Request["FromTO"]); }
            queryEntity.AffectAwbNO = Request["AffectAwbNO"];
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryIncomePayDetail(pageIndex, pageSize, queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 资金明细收支数据查询导出方法
        /// </summary>
        public void QueryIncomePayDetailForExport()
        {
            CargoCashierEntity queryEntity = new CargoCashierEntity();
            //查询条件
            string key = Request["key"];
            string[] arr = key.Split(',');
            #region 赋值
            for (int i = 0; i < arr.Length; i++)
            {
                switch (i)
                {
                    case 0:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.BasicID = Convert.ToInt32(arr[i].Trim()); }
                        break;
                    case 1:
                        if (!arr[i].Equals("-1")) { queryEntity.CardType = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 2:
                        if (!string.IsNullOrEmpty(arr[i]))//一级分类
                        {
                            queryEntity.CargoPermisID = Convert.ToString(arr[i]);//所属仓库ID
                        }
                        else
                        {
                            queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                        }
                        break;
                    case 3:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.StartDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 4:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.EndDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 5:
                        if (!arr[i].Equals("-1")) { queryEntity.RType = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 6:
                        if (!arr[i].Equals("-1")) { queryEntity.FromTO = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 7:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.AffectAwbNO = Convert.ToString(arr[i].Trim()); }
                        break;
                    default:
                        break;
                }
            }
            #endregion
            CargoFinanceBus bus = new CargoFinanceBus();
            string err = "OK";
            List<CargoCashierEntity> list = bus.QueryIncomePayDetailForExport(queryEntity);
            if (list.Count > 0) { incomePayList = list; } else { err = "没有数据可以进行导出，请重新查询！"; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 资金明细导出实体
        /// </summary>
        public List<CargoCashierEntity> incomePayList
        {
            get
            {
                if (Session["incomePayList"] == null)
                {
                    Session["incomePayList"] = new List<CargoCashierEntity>();
                }
                return (List<CargoCashierEntity>)(Session["incomePayList"]);
            }
            set
            {
                Session["incomePayList"] = value;
            }
        }
        /// <summary>
        /// 撤销
        /// </summary>
        public void RevokeIncomePayDetail()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            CargoCashierEntity ent = new CargoCashierEntity();
            CargoFinanceBus bus = new CargoFinanceBus();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.Status = "0";
            log.NvgPage = "出纳资金管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    decimal affectMoney = string.IsNullOrEmpty(Convert.ToString(row["AffectCash"])) ? 0 : Convert.ToDecimal(row["AffectCash"]);
                    switch (Convert.ToString(row["CardType"]))
                    {
                        case "0":
                            ent.CashID = string.IsNullOrEmpty(Convert.ToString(row["BasicID"])) ? 0 : Convert.ToInt32(row["BasicID"]);//现金账号ID
                            ent.AffectCash = affectMoney;//现金
                            break;
                        case "1":
                            ent.BasicID = string.IsNullOrEmpty(Convert.ToString(row["BasicID"])) ? 0 : Convert.ToInt32(row["BasicID"]);//银行卡ID
                            ent.AffectCard = affectMoney;//银行卡
                            break;
                        case "2":
                            ent.WxID = string.IsNullOrEmpty(Convert.ToString(row["BasicID"])) ? 0 : Convert.ToInt32(row["BasicID"]);//微信ID
                            ent.AffectWX = affectMoney;//微信金额
                            break;
                        case "3":
                            ent.AliID = string.IsNullOrEmpty(Convert.ToString(row["BasicID"])) ? 0 : Convert.ToInt32(row["BasicID"]);//支付宝ID
                            ent.AffectAlipay = affectMoney;//支付宝金额
                            break;
                        default:
                            msg.Message = "未定义扣款类型无法撤销";
                            msg.Result = false;
                            break;
                    }
                    ent.RecordID = Convert.ToInt32(row["RecordID"]);
                    if (Convert.ToString(row["RType"]) == "0")
                    {
                        ent.RType = "1";//收支类型，0收入1支出
                        ent.FromTO = "7";
                        ent.Memo = "撤销收入" + ent.RecordID + "金额" + affectMoney;
                    }
                    else
                    {
                        ent.RType = "0";//收支类型，0收入1支出
                        ent.FromTO = "8";
                        ent.Memo = "撤销支出" + ent.RecordID + "金额" + affectMoney;
                    }
                    //ent.Memo = Convert.ToString(row["Memo"]).Trim();
                    ent.AffectClient = Convert.ToString(row["AffectClient"]);
                    ent.OP_ID = UserInfor.LoginName.Trim();
                    ent.UserName = UserInfor.UserName.Trim();
                    ent.CheckStatus = "0";
                    decimal tot = 0.00M;
                    ent.OldFromTO = Convert.ToString(row["FromTO"]).Trim();
                    string AffectAwbNO = Convert.ToString(row["AffectAwbNO"]).Trim();
                    AffectAwbNO = AffectAwbNO.Trim(',');
                    switch (ent.OldFromTO)
                    {
                        case "0":
                            List<CargoOrderEntity> orderList = bus.QueryOrderForCash(new CargoOrderEntity { OrderNo = AffectAwbNO });
                            foreach (var order in orderList)
                            {
                                tot += order.TotalCharge + order.DeliveryFee;
                            }
                            break;
                        case "2":
                        case "3":
                            List<CargoExpenseEntity> expenseList = bus.QueryExpenseForCash(new CargoExpenseEntity { ExpenseID = AffectAwbNO });
                            foreach (var expense in expenseList)
                            {
                                tot += expense.ExCharge;
                            }
                            break;
                        case "5":
                            List<CargoClientAccountEntity> accountList = bus.QueryAccountForCash(new CargoClientAccountEntity { AccountID = AffectAwbNO });
                            foreach (var account in accountList)
                            {
                                tot += account.Total;
                            }
                            break;
                        case "6":
                            List<CargoOrderEntity> purchaseList = bus.QueryPurchaseForCash(new CargoOrderEntity { OrderNo = AffectAwbNO });
                            foreach (var purchase in purchaseList)
                            {
                                tot += purchase.TotalCharge;
                            }
                            break;
                        case "9":
                            break;
                        case "10":
                            break;
                        case "11":
                            break;
                        case "12":
                            break;
                        case "13":
                        case "14":
                            List<FinanceOtherEntity> ohterList = bus.QueryFinanceOtherDataForCash(new FinanceOtherEntity { IDs = AffectAwbNO });
                            foreach (var other in ohterList)
                            {
                                tot += other.AmountInvolved;
                            }
                            break;
                        case "15":
                            break;
                        case "16":
                            break;
                        case "17":
                            break;
                        case "18":
                            break;
                        case "19":
                            break;
                        default:
                            msg.Message = "未定义收支类型无法撤销";
                            msg.Result = false;
                            break;
                    }
                    if (affectMoney < tot)
                    {
                        ent.CheckStatus = "2";
                    }
                    ent.HouseName = Convert.ToString(row["HouseName"]).Trim();
                    ent.AffectAwbNO = Convert.ToString(row["AffectAwbNO"]).Trim();

                    List<string> entOrderNo = new List<string>();
                    string[] AffectAwbNOStr = ent.AffectAwbNO.Split(',');
                    foreach (var item in AffectAwbNOStr)
                    {
                        if (!string.IsNullOrEmpty(item))
                        {
                            entOrderNo.Add(item);
                        }
                    }
                    ent.OrderNo = entOrderNo;
                    if (msg.Result)
                    {
                        bus.SaveCash(ent, log);
                        msg.Result = true;
                        msg.Message = "成功";
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 内部转账
        /// </summary>
        public void MoveMoney()
        {
            CargoCashierEntity outEnt = new CargoCashierEntity();
            CargoCashierEntity intEnt = new CargoCashierEntity();
            CargoFinanceBus bus = new CargoFinanceBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "出纳资金管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            log.Memo = "内部转账成功";
            try
            {
                if (Convert.ToDecimal(Request["outMoney"]) > Convert.ToDecimal(Request["overMoney"]))
                {
                    msg.Message = "账户余额少于转出金额，不能转账"; msg.Result = false;
                }
                if (Convert.ToString(Request["outCardType"]).Equals("0"))
                {
                    if (string.IsNullOrEmpty(Convert.ToString(Request["outAccount"]))) { msg.Message = "请选择转出仓库账号"; msg.Result = false; }
                }
                if (Convert.ToString(Request["outCardType"]).Equals("1"))
                {
                    if (string.IsNullOrEmpty(Convert.ToString(Request["outAccount"]))) { msg.Message = "请选择转出银行账号"; msg.Result = false; }
                }
                if (Convert.ToString(Request["outCardType"]).Equals("2"))
                {
                    if (string.IsNullOrEmpty(Convert.ToString(Request["outAccount"]))) { msg.Message = "请选择转出微信账号"; msg.Result = false; }
                }
                if (Convert.ToString(Request["outCardType"]).Equals("3"))
                {
                    if (string.IsNullOrEmpty(Convert.ToString(Request["outAccount"]))) { msg.Message = "请选择转出支付宝账号"; msg.Result = false; }
                }
                if (Convert.ToString(Request["inCardType"]).Equals("0"))
                {
                    if (string.IsNullOrEmpty(Convert.ToString(Request["inAccount"]))) { msg.Message = "请选择转入仓库账号"; msg.Result = false; }
                }
                if (Convert.ToString(Request["inCardType"]).Equals("1"))
                {
                    if (string.IsNullOrEmpty(Convert.ToString(Request["inAccount"]))) { msg.Message = "请选择转入银行账号"; msg.Result = false; }
                }
                if (Convert.ToString(Request["inCardType"]).Equals("2"))
                {
                    if (string.IsNullOrEmpty(Convert.ToString(Request["inAccount"]))) { msg.Message = "请选择转入微信账号"; msg.Result = false; }
                }
                if (Convert.ToString(Request["inCardType"]).Equals("3"))
                {
                    if (string.IsNullOrEmpty(Convert.ToString(Request["inAccount"]))) { msg.Message = "请选择转入支付宝账号"; msg.Result = false; }
                }
                if (Convert.ToString(Request["outCardType"]).Equals(Convert.ToString(Request["inCardType"])))
                {
                    if (Convert.ToString(Request["outCardType"]).Equals("0"))
                    {
                        if (Convert.ToString(Request["outAccount"]).Equals(Convert.ToString(Request["outAccount"])))
                        {
                            msg.Message = "转出现金仓库账号与转入仓库账号不能相同"; msg.Result = false;
                        }
                    }
                    if (Convert.ToString(Request["outCardType"]).Equals("1"))
                    {
                        if (Convert.ToString(Request["outAccount"]).Equals(Convert.ToString(Request["inAccount"])))
                        {
                            msg.Message = "转出银行账号与转入银行账号不能相同"; msg.Result = false;
                        }
                    }
                    if (Convert.ToString(Request["outCardType"]).Equals("2"))
                    {
                        if (Convert.ToString(Request["outAccount"]).Equals(Convert.ToString(Request["inAccount"])))
                        {
                            msg.Message = "转出微信账号与转入微信账号不能相同"; msg.Result = false;
                        }
                    }
                    if (Convert.ToString(Request["outCardType"]).Equals("3"))
                    {
                        if (Convert.ToString(Request["outAccount"]).Equals(Convert.ToString(Request["inAccount"])))
                        {
                            msg.Message = "转出支付宝账号与转入支付宝账号不能相同"; msg.Result = false;
                        }
                    }
                }
                if (msg.Result)
                {
                    //out.TruckNum = Convert.ToString(row["TruckNum"]);
                    outEnt.CardType = Convert.ToString(Request["outCardType"]);
                    outEnt.AffectCash = Convert.ToDecimal(Request["outMoney"]);
                    outEnt.BasicID = Convert.ToInt32(Request["outAccount"]);
                    outEnt.RType = "1"; outEnt.FromTO = "1"; outEnt.OP_ID = UserInfor.LoginName.Trim();
                    outEnt.Memo = Convert.ToString(Request["Remark"]);
                    outEnt.UserName = UserInfor.UserName;
                    intEnt.AffectCash = Convert.ToDecimal(Request["outMoney"]);
                    intEnt.CardType = Convert.ToString(Request["inCardType"]);

                    intEnt.BasicID = Convert.ToInt32(Request["inAccount"]);
                    intEnt.RType = "0"; intEnt.FromTO = "1"; intEnt.OP_ID = UserInfor.LoginName.Trim();
                    intEnt.Memo = Convert.ToString(Request["Remark"]);
                    intEnt.UserName = UserInfor.UserName;
                    bus.MoveMoney(outEnt, intEnt, log);
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        public void AddMoney()
        {
            CargoFinanceBus bus = new CargoFinanceBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "出纳资金管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            log.Memo = "内部转账成功";
            CargoCashierEntity jointEnt = new CargoCashierEntity();
            try
            {
                if (msg.Result)
                {
                    //out.TruckNum = Convert.ToString(row["TruckNum"]);
                    jointEnt.CardType = Convert.ToString(Request["joinCardType"]);
                    string addType = Convert.ToString(Request["addType"]);
                    if (addType == "支出")
                    {
                        jointEnt.AffectCash = Convert.ToDecimal(Request["joinMoney"]);
                        jointEnt.RType = "1";
                    }
                    else
                    {
                        jointEnt.AffectCash = Convert.ToDecimal(Request["joinMoney"]);
                        jointEnt.RType = "0";
                    }
                    jointEnt.BasicID = Convert.ToInt32(Request["joinAccount"]);
                    jointEnt.FromTO = Convert.ToString(Request["joinSource"]);
                    jointEnt.OP_ID = UserInfor.LoginName.Trim();
                    jointEnt.Memo = Convert.ToString(Request["joinRemark"]);
                    jointEnt.UserName = UserInfor.UserName;
                    jointEnt.AffectClient = Convert.ToString(Request["AffectClient"]);
                    bus.JoinMoney(jointEnt, log);
                }
            }
            catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
        #region 应收应付监督
        /// <summary>
        /// 订单应收监督数据查询
        /// </summary>
        public void QueryOrderReciveMonitor()
        {
            CargoReceivePayMonitorEntity queryEntity = new CargoReceivePayMonitorEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["OrderNo"])))
            {
                queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            }
            else
            {
                if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
                if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
                queryEntity.AcceptPeople = Convert.ToString(Request["AcceptPeople"]);
                queryEntity.Dest = Convert.ToString(Request["Dest"]);
                //if (!string.IsNullOrEmpty(Request["ClientNum"]))
                //{
                //    queryEntity.ClientNum = Convert.ToInt32(Request["ClientNum"]);
                //}
                //if (!string.IsNullOrEmpty(Convert.ToString(Request["PayClientName"]))) { queryEntity.PayClientName = Convert.ToString(Request["PayClientName"]); }
                //2021-03-12 添加公司类型查询条件
                if (Convert.ToString(Request["BelongHouse"]) != "-1")
                {
                    queryEntity.BelongHouse = Convert.ToString(Request["BelongHouse"]);
                }
                if (Request["CheckStatus"] != "-1") { queryEntity.CheckStatus = Convert.ToString(Request["CheckStatus"]); }
                queryEntity.SaleManID = Convert.ToString(Request["SaleManID"]);
            }
            if (Convert.ToString(Request["OrderType"]) != "-1")
            {
                queryEntity.OrderType = Convert.ToString(Request["OrderType"]);
            }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            queryEntity.FromTO = "0";//按订单收款
            queryEntity.RType = "0";//收入
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryOrderReciveMonitor(1, 1000, queryEntity);
            List<CargoReceivePayMonitorEntity> footlist = new List<CargoReceivePayMonitorEntity>();
            List<CargoReceivePayMonitorEntity> datalist = (List<CargoReceivePayMonitorEntity>)list["rows"];
            List<CargoReceivePayMonitorEntity> curentPageList = new List<CargoReceivePayMonitorEntity>();
            curentPageList = datalist.Where(c => c.RowNumber > (pageSize * (pageIndex - 1)) && c.RowNumber < pageSize * pageIndex + 1).ToList();
            int curPiece = 0; decimal curTransportFee = 0.00M, curTotalCharge = 0.00M, curReceivedMoney = 0.00M, curUncollectMoney = 0.00M;
            foreach (var it in curentPageList)
            {
                if (it.OrderModel.Equals("1"))
                {
                    //退货单
                    curPiece -= it.Piece;
                    curTransportFee -= it.TotalCharge;
                    curTotalCharge -= it.TotalCharge;// it.TotalCharge;
                    curReceivedMoney -= it.ReceivedMoney;
                    curUncollectMoney -= it.UncollectMoney;
                }
                else
                {
                    curPiece += it.Piece;
                    curTransportFee += it.TotalCharge;
                    curTotalCharge += it.TotalCharge; //it.TotalCharge;
                    curReceivedMoney += it.ReceivedMoney;
                    curUncollectMoney += it.UncollectMoney;
                }
            }
            footlist.Add(new CargoReceivePayMonitorEntity
            {
                AcceptUnit = "当前页合计：",
                Piece = curPiece,
                TransportFee = curTransportFee,
                TotalCharge = curTotalCharge,
                ReceivedMoney = curReceivedMoney,
                UncollectMoney = curUncollectMoney
            });
            int allPiece = 0; decimal allTransportFee = 0.00M, allTotalCharge = 0.00M, allReceivedMoney = 0.00M, allUncollectMoney = 0.00M;
            foreach (var it in datalist)
            {
                if (it.OrderModel.Equals("1"))
                {
                    //退货单
                    allPiece -= it.Piece;
                    allTransportFee -= it.TotalCharge;
                    allTotalCharge -= it.TotalCharge;// it.TotalCharge;
                    allReceivedMoney -= it.ReceivedMoney;
                    allUncollectMoney -= it.UncollectMoney;
                }
                else
                {
                    allPiece += it.Piece;
                    allTransportFee += it.TotalCharge;
                    allTotalCharge += it.TotalCharge;// it.TotalCharge;
                    allReceivedMoney += it.ReceivedMoney;
                    allUncollectMoney += it.UncollectMoney;
                }
            }
            footlist.Add(new CargoReceivePayMonitorEntity
            {
                AcceptUnit = "总计：",
                Piece = allPiece,
                TransportFee = allTransportFee,
                TotalCharge = allTotalCharge,
                ReceivedMoney = allReceivedMoney,
                UncollectMoney = allUncollectMoney
            });
            list["footer"] = footlist;
            list["rows"] = curentPageList;
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 按订单收款监督数据查询导出
        /// </summary>
        public void QueryOrderReciveMonitorForExport()
        {
            CargoReceivePayMonitorEntity queryEntity = new CargoReceivePayMonitorEntity();
            //查询条件
            string key = Request["key"];
            if (string.IsNullOrEmpty(key))
            {
                Response.Clear();
                Response.Write(JSON.Encode(queryEntity));
                return;
            }
            string[] arr = key.Split(',');
            if (!string.IsNullOrEmpty(arr[0]))
            {
                queryEntity.OrderNo = arr[0].Trim();
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            else
            {
                for (int i = 0; i < arr.Length; i++)
                {
                    switch (i)
                    {
                        case 0:
                            if (!string.IsNullOrEmpty(arr[i])) { queryEntity.OrderNo = arr[i].Trim(); }
                            break;
                        case 1:
                            if (!string.IsNullOrEmpty(arr[i])) { queryEntity.AcceptPeople = arr[i].Trim(); }
                            break;
                        case 2:
                            if (!string.IsNullOrEmpty(arr[i])) { queryEntity.StartDate = Convert.ToDateTime(arr[i].Trim()); }
                            break;
                        case 3:
                            if (!string.IsNullOrEmpty(arr[i])) { queryEntity.EndDate = Convert.ToDateTime(arr[i].Trim()); }
                            break;
                        case 4:
                            if (!string.IsNullOrEmpty(arr[i]))
                            {
                                queryEntity.ClientNum = Convert.ToInt32(arr[i]);
                            }
                            break;
                        case 5:
                            if (!string.IsNullOrEmpty(arr[i]))//一级分类
                            {
                                queryEntity.CargoPermisID = Convert.ToString(arr[i]);//所属仓库ID
                            }
                            else
                            {
                                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                            }
                            break;
                        case 6:
                            if (!arr[i].Equals("-1")) { queryEntity.CheckStatus = Convert.ToString(arr[i]); }
                            break;
                        case 7:
                            if (!string.IsNullOrEmpty(arr[i])) { queryEntity.SaleManID = Convert.ToString(arr[i]); }
                            break;
                        case 8:
                            if (!arr[i].Equals("-1")) { queryEntity.OrderType = Convert.ToString(arr[i]); }
                            break;
                        case 9:
                            if (!arr[i].Equals("-1")) { queryEntity.BelongHouse = Convert.ToString(arr[i]); }
                            break;
                        default:
                            break;
                    }
                }
            }
            queryEntity.RType = "0";//收入
            queryEntity.FromTO = "0";//按运单收款
            //分页
            int pageIndex = 1;
            int pageSize = 1000;
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryOrderReciveMonitor(pageIndex, pageSize, queryEntity);

            string err = "OK";
            List<CargoReceivePayMonitorEntity> awbList = list["rows"] as List<CargoReceivePayMonitorEntity>;
            CargoClientBus client = new CargoClientBus();
            List<CargoClientIncomeEntity> Income = client.QueryClientIncome(new CargoClientIncomeEntity { ClientNum = queryEntity.PayClientNum, StartDate = queryEntity.StartDate, EndDate = queryEntity.EndDate, CargoPermisID = queryEntity.CargoPermisID });
            List<CargoReceivePayMonitorEntity> clientMonitor = new List<CargoReceivePayMonitorEntity>();
            foreach (var it in Income)
            {
                clientMonitor.Add(new CargoReceivePayMonitorEntity
                {
                    OrderModel = "2",
                    CreateDate = it.CreateDate,
                    AcceptPeople = it.Boss,
                    TransportFee = it.Money
                });
            }
            awbList.AddRange(clientMonitor);
            awbList = awbList.OrderByDescending(c => c.CreateDate).ToList<CargoReceivePayMonitorEntity>();
            if (awbList.Count > 0) { receivePayMonitor = awbList; } else { err = "没有数据可以进行导出，请重新查询！"; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);

        }
        public List<CargoReceivePayMonitorEntity> receivePayMonitor
        {
            get
            {
                if (Session["receivePayMonitor"] == null)
                {
                    Session["receivePayMonitor"] = new List<CargoReceivePayMonitorEntity>();
                }
                return (List<CargoReceivePayMonitorEntity>)(Session["receivePayMonitor"]);
            }
            set
            {
                Session["receivePayMonitor"] = value;
            }
        }
        /// <summary>
        /// 报销收款监督
        /// </summary>
        public void QueryExpenseReciveMonitor()
        {
            CargoExpenseEntity queryEntity = new CargoExpenseEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            //允许多个报销单号一起查询，用,逗号隔开
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ExID"]))) { queryEntity.ExpenseID = Convert.ToString(Request["ExID"]); }
            queryEntity.ExName = Convert.ToString(Request["ExName"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientID"])))
            {
                queryEntity.ClientID = Convert.ToInt32(Request["ClientID"]);
            }
            if (Request["CheckStatus"] != "-1") { queryEntity.CheckStatus = Convert.ToString(Request["CheckStatus"]); }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//所属仓库
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            if (Request["Status"] != "-1") { queryEntity.Status = Convert.ToString(Request["Status"]); }
            queryEntity.FromTO = Convert.ToString(Request["FromTO"]);// "2";//按报销单收款
            queryEntity.RType = Convert.ToString(Request["RType"]);// "0";//收入
            queryEntity.ExType = Convert.ToString(Request["ExType"]);// "1";//收款报销
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryExpenseReciveMonitor(pageIndex, pageSize, queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 按报销收款监督导出
        /// </summary>
        public void QueryExpenseReciveMonitorForExport()
        {
            CargoExpenseEntity queryEntity = new CargoExpenseEntity();
            //查询条件
            string key = Request["key"];
            if (string.IsNullOrEmpty(key))
            {
                Response.Clear();
                Response.Write(JSON.Encode(queryEntity));
                return;
            }
            string[] arr = key.Split(',');

            for (int i = 0; i < arr.Length; i++)
            {
                switch (i)
                {
                    case 0:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ExpenseID = arr[i].Trim(); }
                        break;
                    case 1:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ExName = arr[i].Trim(); }
                        break;
                    case 2:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.StartDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 3:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.EndDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 4:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ClientID = Convert.ToInt32(arr[i]); }
                        break;
                    case 5:
                        if (!string.IsNullOrEmpty(arr[i]))//所属仓库
                        {
                            queryEntity.CargoPermisID = Convert.ToString(arr[i]);//所属仓库ID
                        }
                        else
                        {
                            queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                        }
                        break;
                    case 6:
                        if (!arr[i].Equals("-1")) { queryEntity.CheckStatus = Convert.ToString(arr[i]); }
                        break;
                    case 7:
                        if (!arr[i].Equals("-1")) { queryEntity.Status = Convert.ToString(arr[i]); }
                        break;
                    case 8:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.FromTO = arr[i].Trim(); }
                        break;
                    case 9:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.RType = arr[i].Trim(); }
                        break;
                    case 10:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ExType = arr[i].Trim(); }
                        break;
                    default:
                        break;
                }
            }
            //queryEntity.FromTO = "2";//按报销单收款
            //queryEntity.RType = "0";//收入
            //queryEntity.ExType = "1";//收款报销
            //分页
            int pageIndex = 1;
            int pageSize = 1000;
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryExpenseReciveMonitor(pageIndex, pageSize, queryEntity);

            string err = "OK";
            List<CargoExpenseEntity> awbList = list["rows"] as List<CargoExpenseEntity>;
            if (awbList.Count > 0) { expenseReceiveMonitor = awbList; } else { err = "没有数据可以进行导出，请重新查询！"; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        public List<CargoExpenseEntity> expenseReceiveMonitor
        {
            get
            {
                if (Session["expenseReceiveMonitor"] == null)
                {
                    Session["expenseReceiveMonitor"] = new List<CargoExpenseEntity>();
                }
                return (List<CargoExpenseEntity>)(Session["expenseReceiveMonitor"]);
            }
            set
            {
                Session["expenseReceiveMonitor"] = value;
            }
        }
        #endregion
        #region 财务报销管理
        /// <summary>
        /// 查询我的报销数据
        /// </summary>
        public void QueryMyExpense()
        {
            CargoExpenseEntity queryEntity = new CargoExpenseEntity();
            queryEntity.OperaID = UserInfor.LoginName.Trim();//我提交的报销 报销操作人是当前账号登陆ID
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            //允许多个报销单号一起查询，用,逗号隔开
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ExID"]))) { queryEntity.ExpenseID = Convert.ToString(Request["ExID"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ExCharge"]))) { queryEntity.ExCharge = Convert.ToDecimal(Request["ExCharge"]); }
            if (Request["Status"] != "-1") { queryEntity.Status = Convert.ToString(Request["Status"]); }
            queryEntity.ExName = Convert.ToString(Request["ExName"]);
            queryEntity.ExDepart = Convert.ToString(Request["ExDepart"]);
            queryEntity.ReceiveName = Convert.ToString(Request["ReceiveName"]);
            queryEntity.ReceiveNumber = Convert.ToString(Request["ReceiveNumber"]);
            //queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            queryEntity.CargoPermisID = UserInfor.HouseID.ToString();
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryOnlyMyExpense(pageIndex, pageSize, queryEntity);
            //myFinancelist = list["rows"] as List<ExpenseEntity>;
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询报销导出
        /// </summary>
        public void QueryOnlyMyExpenseForExport()
        {
            CargoExpenseEntity queryEntity = new CargoExpenseEntity();
            //查询条件
            string key = Request["key"];
            if (string.IsNullOrEmpty(key))
            {
                Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return;
            }
            string[] arr = key.Split(',');
            #region 赋值
            for (int i = 0; i < arr.Length; i++)
            {
                switch (i)
                {
                    case 0:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ExpenseID = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 1:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ExName = arr[i].Trim(); }
                        break;
                    case 2:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ExDepart = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 3:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ExCharge = Convert.ToDecimal(arr[i].Trim()); }
                        break;
                    case 4:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ReceiveName = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 5:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ReceiveNumber = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 6:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.StartDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 7:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.EndDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 8:
                        if (!arr[i].Equals("-1")) { queryEntity.Status = Convert.ToString(arr[i]); }
                        break;
                    default:
                        break;
                }
            }
            #endregion
            queryEntity.CargoPermisID = UserInfor.HouseID.ToString();
            queryEntity.OperaID = UserInfor.LoginName.Trim();
            string err = "OK";
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoExpenseEntity> list = bus.QueryExpenseMyCheckForExport(queryEntity);
            if (list.Count > 0) { Financelist = list; }
            else { err = "没有数据可以进行导出，请重新查询！"; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 通过ID号获取某一报销单数据
        /// </summary>
        public void GetExpenseById()
        {
            string eid = Request["id"];
            Int64 ExID = 0;
            if (!string.IsNullOrEmpty(eid))
            {
                ExID = Convert.ToInt64(eid.ToUpper().Trim());
            }
            CargoFinanceBus bus = new CargoFinanceBus();
            CargoExpenseEntity result = bus.GetExpenseById(ExID);
            String json = JSON.Encode(result);
            Response.Write(json);
        }
        /// <summary>
        /// 删除报销单
        /// ty:0作废报销单ty:1彻底删除报销单
        /// </summary>
        public void DelCargoMyExpense()
        {
            String idStr = Request["data"];
            int ty = Convert.ToInt32(Request["ty"]);
            if (String.IsNullOrEmpty(idStr)) return;
            ArrayList rows = (ArrayList)JSON.Decode(idStr);
            List<CargoExpenseEntity> list = new List<CargoExpenseEntity>();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "我的工作台";
            log.NvgPage = "费用报销";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            log.Status = "0";
            log.Memo = "删除报销单成功";
            CargoFinanceBus bus = new CargoFinanceBus();
            try
            {
                foreach (Hashtable row in rows)
                {
                    string status = bus.GetExpenseStatusByID(Convert.ToInt64(row["ExID"]));
                    if (string.IsNullOrEmpty(status) || !status.Equals("0"))
                    {
                        msg.Result = false;
                        msg.Message = "报销单号：" + Convert.ToString(row["ExID"]) + "不是待审状态";
                        break;
                    }
                    list.Add(new CargoExpenseEntity
                    {
                        ExID = Convert.ToInt64(row["ExID"]),
                        ExName = Convert.ToString(row["ExName"]),
                        ExDate = Convert.ToDateTime(row["ExDate"]),
                        ReceiveName = Convert.ToString(row["ReceiveName"]),
                        ReceiveNumber = Convert.ToString(row["ReceiveNumber"]),
                        ChargeType = Convert.ToString(row["ChargeType"]),
                        ExCharge = Convert.ToDecimal(row["ExCharge"])
                    });
                }
                if (msg.Result)
                {
                    bus.DelCargoMyExpense(list, ty, log);
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 保存报销申请单
        /// </summary>
        public void saveExpense()
        {
            string json = Request["submitData"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            CargoExpenseEntity ent = new CargoExpenseEntity();
            List<CargoExpenseDetailEntity> entDest = new List<CargoExpenseDetailEntity>();
            CargoFinanceBus bus = new CargoFinanceBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "我的工作台";
            log.NvgPage = "费用报销";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();
            int UFlag = 0;//0:新增1:修改
            long exid = 0;

            if (GridRows.Count <= 0)
            {
                msg.Message = "请输入详细报销列表信息";
                msg.Result = false;
            }
            if (msg.Result)
            {
                String id = Request["ExID"] != null ? Request["ExID"].ToString() : "";
                if (id == "")//新增：id为空
                {
                    log.Operate = "A";
                    UFlag = 0;
                }
                else //更新：id不为空
                {
                    log.Operate = "U";
                    UFlag = 1;
                    ent.ExID = Convert.ToInt64(Request["ExID"]);
                    CargoExpenseEntity ex = bus.GetExpenseById(ent.ExID);
                    if (ex.CheckStatus.Equals("1"))
                    {
                        msg.Message = "该申请已结清，不允许修改";
                        msg.Result = false;
                    }
                    if (ex.CheckStatus.Equals("2"))
                    {
                        msg.Message = "该申请正在结算中，不允许修改";
                        msg.Result = false;
                    }
                    if (!ex.Status.Equals("0"))
                    {
                        msg.Message = "该申请不是待审状态，不允许修改";
                        msg.Result = false;
                    }
                }
                List<QyUserEntity> qyUser = new List<QyUserEntity>();
                CargoOrderBus o = new CargoOrderBus();
                QiyeBus q = new QiyeBus();
                if (msg.Result)
                {
                    #region 赋值
                    //ent.CostType = string.IsNullOrEmpty(Convert.ToString(row["CostType"])) ? 0 : Convert.ToInt32(row["CostType"]);
                    //ent.CostName = Convert.ToString(row["CostName"]);
                    ent.ExName = Convert.ToString(Request["ExName"]);
                    ent.ExDepart = Convert.ToString(Request["ExDepart"]);
                    ent.ExDate = Convert.ToDateTime(Request["ExDate"]);
                    ent.ReceiveName = Convert.ToString(Request["HiddenReceiveName"]);
                    ent.ReceiveNumber = Convert.ToString(Request["HiddenReceiveNumber"]);
                    ent.CardBank = Convert.ToString(Request["CardBank"]);
                    ent.ChargeType = Convert.ToString(Request["ChargeType"]);
                    ent.ExCharge = string.IsNullOrEmpty(Convert.ToString(Request["ExCharge"])) ? 0M : Convert.ToDecimal(Request["ExCharge"]);
                    ent.Reason = Convert.ToString(Request["Reason"]);
                    ent.OperaID = UserInfor.LoginName.Trim();
                    ent.OperaName = Convert.ToString(Request["OperaName"]);
                    ent.ExpenseDate = Convert.ToDateTime(Request["ExpenseDate"]);
                    ent.ApproveID = Convert.ToInt32(Request["ApproveID"]);
                    CargoApproveSetEntity approveSet = bus.QueryApproveSetByID(ent.ApproveID);
                    ent.NextCheckID = Convert.ToString(Request["NextCheckID"]);//下一审批人
                    ent.NextCheckName = Convert.ToString(Request["NextCheckName"]);
                    if (!string.IsNullOrEmpty(approveSet.OneCheckID))
                    {
                        ent.NextCheckID = approveSet.OneCheckID;//下一审批人
                        ent.NextCheckName = approveSet.OneCheckName;
                        //判断如果是分公司领导就查找该 分公司领导是谁
                        if (approveSet.OneCheckID.Equals("3"))
                        {
                            List<SystemUserEntity> Bosslist = o.QueryUserBossLoginName(new SystemUserEntity { LoginName = UserInfor.LoginName });
                            if (Bosslist.Count > 0)
                            {
                                if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                {
                                    qyUser.Add(new QyUserEntity { UserID = Bosslist[0].LoginName, WxName = Bosslist[0].UserName });
                                }
                                else
                                {
                                    ent.NextCheckID = approveSet.TwoCheckID;//下一审批人
                                    ent.NextCheckName = approveSet.TwoCheckName;
                                    if (!string.IsNullOrEmpty(approveSet.TwoCheckID))
                                    {
                                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = approveSet.TwoCheckID, CheckHouseID = UserInfor.HouseID.ToString() });
                                    }
                                }
                            }
                        }
                        else if (approveSet.OneCheckID.Equals("7"))
                        {
                            //分公司财务
                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = approveSet.OneCheckID, HouseID = UserInfor.HouseID, CheckHouseID = UserInfor.HouseID.ToString() });
                            //qyUser = q.QueryUserList(new QyUserEntity { CheckRole = approveSet.OneCheckID });
                            if (qyUser.Count <= 0)
                            {
                                ent.NextCheckID = approveSet.TwoCheckID;//下一审批人
                                ent.NextCheckName = approveSet.TwoCheckName;
                                if (approveSet.TwoCheckID.Equals("3"))
                                {
                                    List<SystemUserEntity> Bosslist = o.QueryUserBossLoginName(new SystemUserEntity { LoginName = UserInfor.LoginName });
                                    if (Bosslist.Count > 0)
                                    {
                                        if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                        {
                                            qyUser.Add(new QyUserEntity { UserID = Bosslist[0].LoginName, WxName = Bosslist[0].UserName });
                                        }
                                    }
                                }
                                else
                                {
                                    if (!string.IsNullOrEmpty(approveSet.TwoCheckID))
                                    {
                                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = approveSet.TwoCheckID, CheckHouseID = UserInfor.HouseID.ToString() });
                                    }
                                }
                            }
                        }
                        else
                        {
                            if (!string.IsNullOrEmpty(approveSet.OneCheckID))
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = approveSet.OneCheckID, CheckHouseID = UserInfor.HouseID.ToString() });
                            }
                        }
                    }
                    ent.OP_ID = UserInfor.LoginName.Trim();
                    ent.UserID = UserInfor.LoginName.Trim();//当前审批人
                    ent.UserName = UserInfor.UserName.Trim();

                    ent.HouseID = UserInfor.HouseID;
                    ent.ClientName = Convert.ToString(Request["clientName"]);
                    ent.ClientID = string.IsNullOrEmpty(Convert.ToString(Request["ClientID"])) ? 0 : Convert.ToInt32(Request["ClientID"]);

                    #endregion
                    int shouzi = 0;
                    decimal total = 0M;
                    DateTime ExpenseDate = Convert.ToDateTime(Request["ExpenseDate"]);
                    foreach (Hashtable row in GridRows)
                    {
                        if (row.Count > 0)
                        {
                            if (shouzi == 0)
                            {
                                shouzi = Convert.ToInt32(row["ZID"]);
                            }
                            if (!shouzi.Equals(Convert.ToInt32(row["ZID"])))
                            {
                                msg.Message = "不允许同时存在收支";
                                msg.Result = false;
                                break;
                            }
                            DateTime HappenDate = Convert.ToDateTime(row["HappenDate"]);

                            string[] Summarys = row["Summary"].ToString().Split(',');
                            if (Summarys.Length > 0)
                            {
                                foreach (string Summary in Summarys)
                                {
                                    if (!string.IsNullOrEmpty(Summary))
                                    {
                                        DataTable dt = bus.CheckSummaryExist(Summary, id);
                                        if (dt.Rows.Count > 0)
                                        {
                                            foreach (DataRow item in dt.Rows)
                                            {
                                                if (item["SID"].ToString() == row["SID"].ToString())
                                                {
                                                    msg.Message = "单号" + Summary + "此科目已在报销单[" + dt.Rows[0]["ExID"].ToString() + "]中报销";
                                                    msg.Result = false;
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                }
                                if (!msg.Result) { break; }
                            }
                            #region 注释
                            //if (HappenDate.Year < ExpenseDate.Year)
                            //{
                            //    msg.Message = "不允许新增上月的报销";
                            //    msg.Result = false;
                            //    break;
                            //}
                            //if (UFlag.Equals(0))
                            //{
                            //    if (ExpenseDate.Day < 16)//说明是本月的上半月
                            //    {
                            //        //if (HappenDate.Year < ExpenseDate.Year)
                            //        //{
                            //        //    msg.Message = "不允许新增上上月的报销";
                            //        //    msg.Result = false;
                            //        //    break;
                            //        //}
                            //        if (HappenDate.Month < ExpenseDate.Month - 1)
                            //        {
                            //            msg.Message = "不允许新增上上月的报销";
                            //            msg.Result = false;
                            //            break;
                            //        }
                            //    }
                            //    else
                            //    {
                            //        if (HappenDate.Month < ExpenseDate.Month)
                            //        {
                            //            msg.Message = "不允许新增上月的报销";
                            //            msg.Result = false;
                            //            break;
                            //        }
                            //    }
                            //} 
                            #endregion
                            entDest.Add(new CargoExpenseDetailEntity
                            {
                                HappenDate = Convert.ToDateTime(row["HappenDate"]),
                                Memo = Convert.ToString(row["Memo"]),
                                Summary = Convert.ToString(row["Summary"]).Replace(';', ',').Replace('、', ',').Replace('。', ',').Replace('，', ',').Replace('；', ',').Replace('．', ','),
                                ZID = string.IsNullOrEmpty(Convert.ToString(row["ZID"])) ? 2 : Convert.ToInt32(row["ZID"]),
                                FID = string.IsNullOrEmpty(Convert.ToString(row["FID"])) ? 0 : Convert.ToInt32(row["FID"]),
                                SID = Convert.ToInt32(row["SID"]),
                                FName = Convert.ToString(row["FName"]),
                                SName = Convert.ToString(row["SName"]),
                                DetailCharge = Convert.ToDecimal(row["DetailCharge"]),
                                OP_ID = UserInfor.LoginName.Trim()
                            });
                            total += Convert.ToDecimal(row["DetailCharge"]);
                        }
                    }
                    ent.ExType = shouzi.ToString();
                    if (msg.Result)
                    {
                        try
                        {
                            ent.exDetail = entDest;
                            ent.ExCharge = total;
                            if (UFlag.Equals(0))
                            {
                                exid = bus.AddExpense(ent, log); ent.ExID = exid; msg.Message = exid.ToString();
                                bus.AddApproveCheck(new CargoApproveCheckEntity { ApproveID = ent.ExID, CheckUserID = UserInfor.LoginName, CheckName = UserInfor.UserName, ReadStatus = "1", CheckType = "0", ApproveType = "0" }, log);
                            }
                            else { bus.UpdateExpense(ent, log); msg.Message = ent.ExID.ToString(); }
                        }
                        catch (ApplicationException ex) { msg.Message = ex.Message; msg.Result = false; }
                        #region 推送申请审批
                        if (msg.Result)
                        {
                            try
                            {
#if DEBUG
                                //DEBUG模式不执行企业微信推送
#else
                                //推送报销审批通知
                                if (!string.IsNullOrEmpty(approveSet.OneCheckID))
                                {
                                    QySendInfoEntity send = new QySendInfoEntity();
                                    send.title = "费用报销申请";
                                    send.agentID = "1000009";//费用报销应用
                                    send.msgType = msgType.textcard;
                                    send.content = "<div></div><div>分仓仓库：" + UserInfor.HouseName + "</div><div>报销单号：" + ent.ExID.ToString() + "</div><div>报销金额：" + ent.ExCharge.ToString("F2") + "</div><div>受款人：" + ent.ReceiveName + "  " + ent.ReceiveNumber + "</div><div>报销人：" + ent.ExName + " " + ent.ExDate.ToString("yyyy-MM-dd") + "</div><div>申请原因：" + ent.Reason + "</div><div></div><div class=\"highlight\">请点击本通知进行审批！</div>";
                                    send.url = "http://dlt.neway5.com/QY/qyExpenseCheck.aspx?ExID=" + ent.ExID.ToString();
                                    foreach (var it in qyUser)
                                    {
                                        send.toUser = it.UserID;
                                        if (!bus.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = ent.ExID, ApproveType = "0", CheckUserID = it.UserID, CheckType = "0" }))
                                        {
                                            bus.AddApproveCheck(new CargoApproveCheckEntity { ApproveID = ent.ExID, CheckUserID = it.UserID, CheckName = it.WxName, ReadStatus = "1", CheckType = "0", ApproveType = "0" }, log);
                                        }
                                        //WxQYSendHelper.QiyePushInfo(send);
                                        Common.WriteTextLog("推送成功：" + it.WxName + ent.ExID.ToString());
                                    }
                                }
#endif
                            }
                            catch (ApplicationException ex)
                            {
                                msg.Result = true;
                            }
                        }
                        #endregion
                    }
                }
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        /// <summary>
        /// 根据报销ID查询该报销的流程图
        /// </summary>
        public void QueryExpenseRout()
        {
            string exid = Request["id"];
            string applyID = Request["ApplyID"];
            string applyName = Request["ApplyName"];
            int HouseID = string.IsNullOrEmpty(Convert.ToString(Request["HouseID"])) ? 0 : Convert.ToInt32(Request["HouseID"]);
            int ApproveID = string.IsNullOrEmpty(Convert.ToString(Request["ApproveID"])) ? 33 : Convert.ToInt32(Request["ApproveID"]);
            QiyeBus qiye = new QiyeBus();
            CargoExpenseApproveRoutEntity queryEntity = new CargoExpenseApproveRoutEntity();
            queryEntity.ExID = Convert.ToInt64(exid);
            queryEntity.ApproveType = Convert.ToString(Request["ApproveType"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoExpenseApproveRoutEntity> result = bus.QueryExpenseRout(queryEntity);

            ArrayList checklist = new ArrayList();

            string res = "OK";
            bool operaType = false;
            if (result.Count > 0)
            {
                res = "<table class='commTblStyle_8' border='0' width='100%' style='border-spacing:0;border-collapse:collapse;font-size:14px;'><tbody><tr><th>处理人</th><th>操作</th><th>处理时间</th><th>结果</th></tr>";
                foreach (var it in result)
                {
                    checklist.Add(it.UserName);
                    string op = "通过";
                    if (it.Opera.Equals("1")) { op = "拒审"; }
                    else if (it.Opera.Equals("2")) { op = "结束"; operaType = true; }
                    else if (it.Opera.Equals("3")) { op = "提交申请"; }
                    res += "<tr><td>" + it.UserName + "</td><td>" + op + "</td><td>" + it.OperaDate.ToString("yyyy-MM-dd HH:mm:ss") + "</td><td>" + it.Result + "</td></tr>";
                }
                res += "</tbody><table>";

                #region 步骤图
                string str = "<div class='content' style='margin: -3% 5%;'><div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'><span class='poetry'>" + applyName + "</span></div><div class='bar b-select'><div class='c-step c-select'></div></div><div class='text' style='margin: 10px -25px;'><span class='poetry'>发起申请</span></div></div>";
                //string str = "";
                CargoFinanceBus f = new CargoFinanceBus();
                List<QyUserEntity> qyUser = new List<QyUserEntity>();
                CargoApproveSetEntity AppSet = f.QueryApproveSetByID(ApproveID);
                CargoOrderBus orderBus = new CargoOrderBus();

                //QyOrderUpdatePriceEntity oupEntity = new QyOrderUpdatePriceEntity();
                //oupEntity.OID = Convert.ToInt64(exid);
                //QyOrderUpdatePriceEntity qup = qiye.QueryOrderUpdatePriceEntity(oupEntity);
                //string checkID = qup.CheckID;
                if (!string.IsNullOrEmpty(AppSet.OneCheckID))
                {
                    string CheckID = AppSet.OneCheckID;
                    string CheckName = AppSet.OneCheckName;
                    qyUser.Clear();
                    string userStr = "", name = "";
                    if (CheckID == "3")
                    {
                        SystemUserEntity entity = new SystemUserEntity();
                        entity.LoginName = applyID;
                        List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                        if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                        {
                            userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                            name = Bosslist[0].UserName;
                        }
                    }
                    else if (CheckID.Equals("7"))
                    {
                        qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID, HouseID = HouseID });
                        //foreach (var user in qyUser)
                        if (qyUser.Count > 0)
                        {
                            if (!string.IsNullOrEmpty(qyUser[0].WxName))
                            {
                                userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                name = qyUser[0].WxName;
                            }
                        }
                    }
                    else
                    {
                        qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                        //foreach (var user in qyUser)
                        if (qyUser.Count > 0)
                        {
                            if (!string.IsNullOrEmpty(qyUser[0].WxName))
                            {
                                userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                name = qyUser[0].WxName;
                            }
                        }
                    }
                    if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                    str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                    if (checklist.Contains(name))
                    {
                        str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                    }
                    else
                    {
                        str += "<div class='bar'><div class='c-step'></div></div>";
                    }
                    str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                    if (!string.IsNullOrEmpty(AppSet.TwoCheckID))
                    {
                        CheckID = AppSet.TwoCheckID;
                        CheckName = AppSet.TwoCheckName;
                        qyUser.Clear();
                        userStr = "";
                        if (CheckID == "3")
                        {
                            SystemUserEntity entity = new SystemUserEntity();
                            entity.LoginName = applyID;
                            List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                            if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                            {
                                userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                name = Bosslist[0].UserName;
                            }
                        }
                        else if (CheckID.Equals("7"))
                        {
                            qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID, HouseID = HouseID });
                            //foreach (var user in qyUser)
                            if (qyUser.Count > 0)
                            {
                                if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                {
                                    userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                    name = qyUser[0].WxName;
                                }
                            }
                        }
                        else
                        {
                            qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                            if (!string.IsNullOrEmpty(qyUser[0].WxName))
                            {
                                userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                name = qyUser[0].WxName;
                            }
                        }
                        if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                        str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                        if (checklist.Contains(name))
                        {
                            str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                        }
                        else
                        {
                            str += "<div class='bar'><div class='c-step'></div></div>";
                        }
                        str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                        if (!string.IsNullOrEmpty(AppSet.ThreeCheckID))
                        {
                            CheckID = AppSet.ThreeCheckID;
                            CheckName = AppSet.ThreeCheckName;
                            qyUser.Clear();
                            userStr = "";
                            if (CheckID == "3")
                            {
                                SystemUserEntity entity = new SystemUserEntity();
                                entity.LoginName = applyID;
                                List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                {
                                    userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                    name = Bosslist[0].UserName;
                                }
                            }
                            else
                            {
                                qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                if (qyUser.Count > 0)
                                {
                                    if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                    {
                                        userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                        name = qyUser[0].WxName;
                                    }
                                }
                            }
                            if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                            str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                            if (checklist.Contains(name))
                            {
                                str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                            }
                            else
                            {
                                str += "<div class='bar'><div class='c-step'></div></div>";
                            }
                            str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                            if (!string.IsNullOrEmpty(AppSet.FourCheckID))
                            {
                                CheckID = AppSet.FourCheckID;
                                CheckName = AppSet.FourCheckName;
                                qyUser.Clear();
                                userStr = "";
                                if (CheckID == "3")
                                {
                                    SystemUserEntity entity = new SystemUserEntity();
                                    entity.LoginName = applyID;
                                    List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                    if (Bosslist.Count > 0)
                                    {
                                        if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                        {
                                            userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                            name = Bosslist[0].UserName;
                                        }
                                    }
                                }
                                else
                                {
                                    qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                    if (qyUser.Count > 0)
                                    {
                                        if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                        {
                                            userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                            name = qyUser[0].WxName;
                                        }
                                    }
                                }
                                if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                if (checklist.Contains(name))
                                {
                                    str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                }
                                else
                                {
                                    str += "<div class='bar'><div class='c-step'></div></div>";
                                }
                                str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                if (!string.IsNullOrEmpty(AppSet.FiveCheckID))
                                {
                                    CheckID = AppSet.FiveCheckID;
                                    CheckName = AppSet.FiveCheckName;
                                    qyUser.Clear();
                                    userStr = "";
                                    if (CheckID == "3")
                                    {
                                        SystemUserEntity entity = new SystemUserEntity();
                                        entity.LoginName = applyID;
                                        List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                        if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                        {
                                            userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                            name = Bosslist[0].UserName;
                                        }
                                    }
                                    else
                                    {
                                        qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                        if (qyUser.Count > 0)
                                        {
                                            if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                            {
                                                userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                                name = qyUser[0].WxName;
                                            }
                                        }
                                    }
                                    if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                    str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                    if (checklist.Contains(name))
                                    {
                                        str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                    }
                                    else
                                    {
                                        str += "<div class='bar'><div class='c-step'></div></div>";
                                    }
                                    str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                    if (!string.IsNullOrEmpty(AppSet.SixCheckID))
                                    {
                                        CheckID = AppSet.SixCheckID;
                                        CheckName = AppSet.SixCheckName;
                                        qyUser.Clear();
                                        userStr = "";
                                        if (CheckID == "3")
                                        {
                                            SystemUserEntity entity = new SystemUserEntity();
                                            entity.LoginName = applyID;
                                            List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                            if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                            {
                                                userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                                name = Bosslist[0].UserName;
                                            }
                                        }
                                        else
                                        {
                                            qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                            if (qyUser.Count > 0)
                                            {
                                                if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                                {
                                                    userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                                    name = qyUser[0].WxName;
                                                }
                                            }
                                        }
                                        if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                        str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                        if (checklist.Contains(name))
                                        {
                                            str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                        }
                                        else
                                        {
                                            str += "<div class='bar'><div class='c-step'></div></div>";
                                        }
                                        str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                        if (!string.IsNullOrEmpty(AppSet.SevenCheckID))
                                        {
                                            CheckID = AppSet.SevenCheckID;
                                            CheckName = AppSet.SevenCheckName;
                                            qyUser.Clear();
                                            userStr = "";
                                            if (CheckID == "3")
                                            {
                                                SystemUserEntity entity = new SystemUserEntity();
                                                entity.LoginName = applyID;
                                                List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                                if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                                {
                                                    userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                                    name = Bosslist[0].UserName;
                                                }
                                            }
                                            else
                                            {
                                                qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                                if (qyUser.Count > 0)
                                                {
                                                    if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                                    {
                                                        userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                                        name = qyUser[0].WxName;
                                                    }
                                                }
                                            }
                                            if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                            str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                            if (checklist.Contains(name))
                                            {
                                                str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                            }
                                            else
                                            {
                                                str += "<div class='bar'><div class='c-step'></div></div>";
                                            }
                                            str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                            if (!string.IsNullOrEmpty(AppSet.EightCheckID))
                                            {
                                                CheckID = AppSet.EightCheckID;
                                                CheckName = AppSet.EightCheckName;
                                                qyUser.Clear();
                                                userStr = "";
                                                if (CheckID == "3")
                                                {
                                                    SystemUserEntity entity = new SystemUserEntity();
                                                    entity.LoginName = applyID;
                                                    List<SystemUserEntity> Bosslist = orderBus.QueryUserBossLoginName(entity);
                                                    if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                                    {
                                                        userStr += "<span class='poetry'>" + Bosslist[0].UserName + "</span>";
                                                        name = Bosslist[0].UserName;
                                                    }
                                                }
                                                else
                                                {
                                                    qyUser = qiye.QueryUserList(new QyUserEntity { CheckRole = CheckID });
                                                    if (qyUser.Count > 0)
                                                    {
                                                        if (!string.IsNullOrEmpty(qyUser[0].WxName))
                                                        {
                                                            userStr += "<span class='poetry'>" + qyUser[0].WxName + "</span>";
                                                            name = qyUser[0].WxName;
                                                        }
                                                    }
                                                }
                                                if (string.IsNullOrEmpty(userStr)) { userStr += "<span class='poetry'>&nbsp;</span>"; }
                                                str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'>" + userStr + "</div>";
                                                if (checklist.Contains(name))
                                                {
                                                    str += "<div class='bar b-select'><div class='c-step c-select'></div></div>";
                                                }
                                                else
                                                {
                                                    str += "<div class='bar'><div class='c-step'></div></div>";
                                                }
                                                str += "<div class='text' style='margin: 10px -30px;'><span class='poetry'>" + CheckName + "</span></div></div>";
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                if (operaType)
                {
                    str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'><span class='poetry'>&nbsp;</span></div><div class='bar b-select' style='width: 0;'><div class='c-step c-select'></div></div><div class='text' style='margin: 10px -15px;'><span class='poetry'>结束</span></div></div></div>";
                }
                else
                {
                    str += "<div class='processBar'><div class='text' style='text-align: left; margin: 10px -25px;'><span class='poetry'>&nbsp;</span></div><div class='bar' style='width: 0;'><div class='c-step'></div></div><div class='text' style='margin: 10px -15px;'><span class='poetry'>结束</span></div></div></div>";
                }
                #endregion
                res = str + res;
            }

            String json = JSON.Encode(res);
            Response.Write(json);
        }
        /// <summary>
        /// 查询系统架构
        /// </summary>
        public void QuerySystemOrganize()
        {
            SystemBus bus = new SystemBus();
            List<SystemOrganizeEntity> list = bus.SystemOrganizeQuery(new SystemOrganizeEntity { ParentID = 3 });
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 根据操作人查询所有收款人
        /// </summary>
        public void QueryAllReceiveName()
        {
            CargoExpenseEntity queryEntity = new CargoExpenseEntity();
            queryEntity.OP_ID = UserInfor.LoginName;
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoExpenseEntity> list = new List<CargoExpenseEntity>();
            list = bus.QueryAllReceiveName(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 根据收款人查询收款账号
        /// </summary>
        public void QueryAllReceiveNumber()
        {
            CargoExpenseEntity queryEntity = new CargoExpenseEntity();
            queryEntity.OP_ID = UserInfor.LoginName;
            string ReceiveName = Request["ReceiveName"];
            queryEntity.ReceiveName = ReceiveName;
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoExpenseEntity> list = new List<CargoExpenseEntity>();
            list = bus.QueryAllReceiveNumber(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 财务报销审批
        /// <summary>
        /// 查询我的审批
        /// </summary>
        public void QueryExpenseMyCheck()
        {
            CargoExpenseEntity queryEntity = new CargoExpenseEntity();
            //允许多个报销单号一起查询，用,逗号隔开
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ExID"]))) { queryEntity.ExpenseID = Convert.ToString(Request["ExID"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ExCharge"]))) { queryEntity.ExCharge = Convert.ToDecimal(Request["ExCharge"]); }
            if (Request["Status"] != "-1") { queryEntity.Status = Convert.ToString(Request["Status"]); }
            if (Request["ExType"] != "-1") { queryEntity.ExType = Convert.ToString(Request["ExType"]); }
            queryEntity.ExName = Convert.ToString(Request["ExName"]);
            queryEntity.ExDepart = Convert.ToString(Request["ExDepart"]);
            queryEntity.ReceiveName = Convert.ToString(Request["ReceiveName"]);
            queryEntity.ReceiveNumber = Convert.ToString(Request["ReceiveNumber"]);
            if (Convert.ToString(Request["IsMe"]).Equals("1"))
            {
                queryEntity.NextCheckID = UserInfor.LoginName;//我的审批
            }
            //queryEntity.CargoPermisID = UserInfor.CargoPermisID;
            queryEntity.CargoPermisID = UserInfor.HouseID.ToString();

            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryMyExpense(pageIndex, pageSize, queryEntity);
            //myFinancelist = list["rows"] as List<ExpenseEntity>;
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询报销导出
        /// </summary>
        public void QueryExpenseMyCheckForExport()
        {
            CargoExpenseEntity queryEntity = new CargoExpenseEntity();
            //查询条件
            string key = Request["key"];
            if (string.IsNullOrEmpty(key))
            {
                Response.Clear(); Response.Write(JSON.Encode(queryEntity)); return;
            }
            string[] arr = key.Split(',');
            #region 赋值
            for (int i = 0; i < arr.Length; i++)
            {
                switch (i)
                {
                    case 0:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ExpenseID = Convert.ToString(arr[i].Trim()); }
                        break;
                    case 1:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ExName = arr[i].Trim(); }
                        break;
                    case 2:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ExCharge = Convert.ToDecimal(arr[i].Trim()); }
                        break;
                    case 3:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ReceiveName = arr[i].Trim(); }
                        break;
                    case 4:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.ReceiveNumber = Convert.ToString(arr[i]); }
                        break;
                    case 5:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.StartDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 6:
                        if (!string.IsNullOrEmpty(arr[i])) { queryEntity.EndDate = Convert.ToDateTime(arr[i].Trim()); }
                        break;
                    case 7:
                        if (!arr[i].Equals("-1")) { queryEntity.Status = Convert.ToString(arr[i]); }
                        break;
                    case 8:
                        if (!arr[i].Equals("-1")) { queryEntity.ExType = Convert.ToString(arr[i]); }
                        break;
                    case 9:
                        if (!string.IsNullOrEmpty(arr[i]))
                        {
                            if (Convert.ToString(arr[i]).Equals("1"))
                            {
                                queryEntity.NextCheckID = UserInfor.LoginName;//我的审批
                            }
                        }
                        break;
                    default:
                        break;
                }
            }
            #endregion
            queryEntity.CargoPermisID = UserInfor.HouseID.ToString();
            string err = "OK";
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoExpenseEntity> list = bus.QueryExpenseMyCheckForExport(queryEntity);
            if (list.Count > 0) { Financelist = list; }
            else { err = "没有数据可以进行导出，请重新查询！"; }
            //JSON
            String json = JSON.Encode(err);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 导出实体
        /// </summary>
        public List<CargoExpenseEntity> Financelist
        {
            get
            {
                if (Session["Financelist"] == null)
                {
                    Session["Financelist"] = new List<CargoExpenseEntity>();
                }
                return (List<CargoExpenseEntity>)(Session["Financelist"]);
            }
            set
            {
                Session["Financelist"] = value;
            }
        }
        /// <summary>
        /// 通过审核和拒审方法
        /// </summary>
        public void updateExpenseStatus()
        {
            String idStr = Request["data"];
            int ty = Convert.ToInt32(Request["ty"]);
            String DenyReason = Request["reason"];
            if (String.IsNullOrEmpty(idStr)) return;
            ArrayList rows = (ArrayList)JSON.Decode(idStr);
            List<CargoExpenseEntity> list = new List<CargoExpenseEntity>();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "财务报销审批";
            log.UserID = UserInfor.LoginName.Trim();
            log.Status = "0";
            log.Operate = "U";
            CargoFinanceBus bus = new CargoFinanceBus();
            QiyeBus q = new QiyeBus();
            CargoOrderBus o = new CargoOrderBus();
            QyUserEntity qyU = q.QueryUser(new QyUserEntity { UserID = UserInfor.LoginName });
            try
            {
                if (ty.Equals(2))
                {
                    #region 拒审
                    log.Memo = "拒审成功 ";
                    foreach (Hashtable row in rows)
                    {
                        if (Convert.ToString(row["Status"]).Equals("3"))
                        {
                            msg.Message = "审批结束的不允许拒审";
                            msg.Result = false;
                            break;
                        }
                        if (Convert.ToString(row["CheckStatus"]).Equals("1"))
                        {
                            msg.Message = "已结清的报销单不允许拒审";
                            msg.Result = false;
                            break;
                        }
                        //查询审批流程数据
                        CargoApproveSetEntity appSet = bus.QueryApproveSetByID(Convert.ToInt32(row["ApproveID"]));
                        if (!qyU.CheckRole.Contains(Convert.ToString(row["NextCheckID"])))
                        {
                            msg.Result = false;
                            msg.Message = "报销单号:" + Convert.ToString(row["ExID"]) + "审批流程未到您审批";
                            break;
                        }
                        QySendInfoEntity send = new QySendInfoEntity();
                        List<QyUserEntity> qyUser = new List<QyUserEntity>();
                        string OperaID = Convert.ToString(row["OperaID"]);//申请人
                        string OperaName = Convert.ToString(row["OperaName"]);//申请人姓名

                        CargoExpenseEntity result = new CargoExpenseEntity();
                        result.ExID = Convert.ToInt64(row["ExID"]);
                        result.ApproveID = Convert.ToInt32(row["ApproveID"]);
                        result.OP_ID = UserInfor.LoginName;
                        result.CheckTime = DateTime.Now;
                        //result.OperaID = UserInfor.LoginName;
                        // result.OperaName = UserInfor.UserName;
                        result.UserID = UserInfor.LoginName;
                        result.UserName = UserInfor.UserName;
                        result.CargoPermisID = UserInfor.HouseID.ToString();
                        result.Status = "2";
                        result.NextCheckID = "";
                        result.NextCheckName = "";
                        result.DenyReason = DenyReason;
                        list.Add(result);
                        bus.updateExpenseStatus(list, ty, log);
                        qyUser.Add(new QyUserEntity { UserID = OperaID, WxName = OperaName });
                        send.title = result.ExID.ToString() + "报销申请拒审";
                        send.agentID = "1000009";//费用报销应用
                        send.msgType = msgType.textcard;
                        send.content = "<div></div><div>分仓仓库：" + UserInfor.HouseName + "</div><div>报销单号：" + result.ExID.ToString() + "</div><div>报销金额：" + result.ExCharge.ToString("F2") + "</div><div>审批人：" + UserInfor.UserName + "  " + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>拒审意见：" + result.DenyReason + "</div><div></div><div class=\"highlight\">请重新提交审批！</div>";
                        send.url = "http://dlt.neway5.com/QY/qyExpenseCheck.aspx?ExID=" + result.ExID.ToString();
                        foreach (var it in qyUser)
                        {
                            send.toUser = it.UserID;
                            WxQYSendHelper.QiyePushInfo(send);
                            Common.WriteTextLog("推送成功：" + it.WxName + result.ExID.ToString());
                        }
                    }
                    #endregion
                }
                else
                {
                    log.Memo = "审批成功 ";
                    foreach (Hashtable row in rows)
                    {
                        if (Convert.ToString(row["Status"]).Equals("3"))
                        {
                            msg.Message = "审批结束的不允许审批";
                            msg.Result = false;
                            break;
                        }
                        if (Convert.ToString(row["CheckStatus"]).Equals("1"))
                        {
                            msg.Message = "已结清的报销单不允许审批";
                            msg.Result = false;
                            break;
                        }
                        //查询审批流程数据
                        CargoApproveSetEntity appSet = bus.QueryApproveSetByID(Convert.ToInt32(row["ApproveID"]));
                        if (!qyU.CheckRole.Contains(Convert.ToString(row["NextCheckID"])))
                        {
                            msg.Result = false;
                            msg.Message = "报销单号:" + Convert.ToString(row["ExID"]) + "审批流程未到您审批";
                            break;
                        }
                        bool IsEnd = false;
                        List<QyUserEntity> qyUser = new List<QyUserEntity>();
                        CargoExpenseEntity result = new CargoExpenseEntity();
                        result.ExID = Convert.ToInt64(row["ExID"]);
                        result.ApproveID = Convert.ToInt32(row["ApproveID"]);
                        result.OP_ID = UserInfor.LoginName;
                        result.CheckTime = DateTime.Now;
                        result.ExCharge = Convert.ToDecimal(row["ExCharge"]);
                        //result.OperaID = UserInfor.LoginName;
                        // result.OperaName = UserInfor.UserName;
                        result.UserID = UserInfor.LoginName;
                        result.UserName = UserInfor.UserName;
                        result.CargoPermisID = UserInfor.HouseID.ToString();
                        QySendInfoEntity send = new QySendInfoEntity();
                        string NextCheckID = Convert.ToString(row["NextCheckID"]);//下一审批人
                        string OperaID = Convert.ToString(row["OperaID"]);//申请人
                        string OperaName = Convert.ToString(row["OperaName"]);//申请人姓名
                        if (appSet.OneCheckID.Equals(NextCheckID))
                        {
                            #region 第一级
                            send.title = appSet.OneCheckName + "审批通过";
                            result.Status = "1";
                            result.NextCheckID = appSet.TwoCheckID;
                            result.NextCheckName = appSet.TwoCheckName;
                            if (string.IsNullOrEmpty(appSet.TwoCheckID))
                            {
                                send.title = result.ExID.ToString() + "报销申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.Status = "3";
                                result.NextCheckID = "";// AppSet.OneCheckID;
                                result.NextCheckName = "";// AppSet.OneCheckName;
                            }
                            else
                            {
                                //判断下一级是不是分公司领导，如果是则查询申请人的上级领导
                                if (appSet.TwoCheckID.Equals("8"))
                                {
                                    List<SystemUserEntity> Bosslist = o.QueryUserBossLoginName(new SystemUserEntity { LoginName = OperaID });
                                    if (Bosslist.Count > 0)
                                    {
                                        if (!string.IsNullOrEmpty(Bosslist[0].LoginName))
                                        {
                                            qyUser.Add(new QyUserEntity { UserID = Bosslist[0].LoginName, WxName = Bosslist[0].UserName });
                                        }
                                        else
                                        {
                                            if (!string.IsNullOrEmpty(appSet.ThreeCheckID))
                                            {
                                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.ThreeCheckID, CheckHouseID = appSet.HouseID.ToString() });
                                            }
                                            else
                                            {
                                                //结束 
                                                send.title = result.ExID.ToString() + "报销申请审批结束";
                                                //表示是最后一级
                                                IsEnd = true;
                                                result.Status = "3";
                                                result.NextCheckID = "";// AppSet.OneCheckID;
                                                result.NextCheckName = "";// AppSet.OneCheckName;
                                            }
                                        }
                                    }
                                }
                                else if (appSet.TwoCheckID.Equals("3"))
                                {
                                    SystemUserEntity Bosslist = o.QueryBossLeaderByLoginName(new SystemUserEntity { LoginName = OperaID });
                                    if (!string.IsNullOrEmpty(Bosslist.LoginName))
                                    {
                                        //qyUser.Add(new QyUserEntity { UserID = Bosslist.LoginName, WxName = Bosslist.UserName });
                                        if (Bosslist.LoginName != UserInfor.LoginName)
                                        {
                                            qyUser.Add(new QyUserEntity { UserID = Bosslist.LoginName, WxName = Bosslist.UserName });
                                        }
                                        //申请人部门负责人是自己，推送给下一级
                                        else
                                        {
                                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.ThreeCheckID, CheckHouseID = appSet.HouseID.ToString() });
                                        }
                                    }
                                    else
                                    {
                                        if (!string.IsNullOrEmpty(appSet.ThreeCheckID))
                                        {
                                            qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.ThreeCheckID, CheckHouseID = appSet.HouseID.ToString() });
                                        }
                                        else
                                        {
                                            //结束 
                                            send.title = result.ExID.ToString() + "报销申请审批结束";
                                            //表示是最后一级
                                            IsEnd = true;
                                            result.Status = "3";
                                            result.NextCheckID = "";// AppSet.OneCheckID;
                                            result.NextCheckName = "";// AppSet.OneCheckName;
                                        }
                                    }
                                }
                                else if (appSet.TwoCheckID.Equals("7"))
                                {
                                    qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.TwoCheckID, HouseID = Convert.ToInt32(row["HouseID"]), CheckHouseID = appSet.HouseID.ToString() });
                                }
                                else
                                {
                                    if (!string.IsNullOrEmpty(appSet.TwoCheckID))
                                    {
                                        qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.TwoCheckID, CheckHouseID = appSet.HouseID.ToString() });
                                    }
                                }
                            }
                            #endregion
                        }
                        else if (appSet.TwoCheckID.Equals(NextCheckID))
                        {
                            #region 第二级
                            send.title = appSet.TwoCheckName + "审批通过";
                            result.Status = "1";
                            result.NextCheckID = appSet.ThreeCheckID;
                            result.NextCheckName = appSet.ThreeCheckName;
                            if (string.IsNullOrEmpty(appSet.ThreeCheckID))
                            {
                                send.title = result.ExID.ToString() + "报销申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.Status = "3";
                                result.NextCheckID = "";// AppSet.OneCheckID;
                                result.NextCheckName = "";// AppSet.OneCheckName;
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.ThreeCheckID, CheckHouseID = appSet.HouseID.ToString() });
                            }
                            #endregion
                        }
                        else if (appSet.ThreeCheckID.Equals(NextCheckID))
                        {
                            #region 第三级
                            send.title = appSet.ThreeCheckName + "审批通过";
                            result.Status = "1";
                            result.NextCheckID = appSet.FourCheckID;
                            result.NextCheckName = appSet.FourCheckName;
                            if (string.IsNullOrEmpty(appSet.FourCheckID))
                            {
                                send.title = result.ExID.ToString() + "报销申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.Status = "3";
                                result.NextCheckID = "";// AppSet.OneCheckID;
                                result.NextCheckName = "";// AppSet.OneCheckName;
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.FourCheckID, CheckHouseID = appSet.HouseID.ToString() });
                            }
                            #endregion
                        }
                        else if (appSet.FourCheckID.Equals(NextCheckID))
                        {
                            #region 第四级
                            send.title = appSet.FourCheckName + "审批通过";
                            result.Status = "1";
                            result.NextCheckID = appSet.FiveCheckID;
                            result.NextCheckName = appSet.FiveCheckName;
                            if (string.IsNullOrEmpty(appSet.FiveCheckID))
                            {
                                send.title = result.ExID.ToString() + "报销申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.Status = "3";
                                result.NextCheckID = "";// AppSet.OneCheckID;
                                result.NextCheckName = "";// AppSet.OneCheckName;
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.FiveCheckID, CheckHouseID = appSet.HouseID.ToString() });
                            }
                            #endregion
                        }
                        else if (appSet.FiveCheckID.Equals(NextCheckID))
                        {
                            #region 第五级
                            send.title = appSet.FiveCheckName + "审批通过";
                            result.Status = "1";
                            result.NextCheckID = appSet.SixCheckID;
                            result.NextCheckName = appSet.SixCheckName;
                            if (string.IsNullOrEmpty(appSet.SixCheckID))
                            {
                                send.title = result.ExID.ToString() + "报销申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.Status = "3";
                                result.NextCheckID = "";// AppSet.OneCheckID;
                                result.NextCheckName = "";// AppSet.OneCheckName;
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.SixCheckID, CheckHouseID = appSet.HouseID.ToString() });
                            }
                            #endregion
                        }
                        else if (appSet.SixCheckID.Equals(NextCheckID))
                        {
                            #region 第六级
                            send.title = appSet.SixCheckName + "审批通过";
                            result.Status = "1";
                            result.NextCheckID = appSet.SevenCheckID;
                            result.NextCheckName = appSet.SevenCheckName;
                            if (string.IsNullOrEmpty(appSet.SevenCheckID))
                            {
                                send.title = result.ExID.ToString() + "报销申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.Status = "3";
                                result.NextCheckID = "";// AppSet.OneCheckID;
                                result.NextCheckName = "";// AppSet.OneCheckName;
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.SevenCheckID, CheckHouseID = appSet.HouseID.ToString() });
                            }
                            #endregion
                        }
                        else if (appSet.SevenCheckID.Equals(NextCheckID))
                        {
                            #region 第七级
                            send.title = appSet.SevenCheckName + "审批通过";
                            result.Status = "1";
                            result.NextCheckID = appSet.EightCheckID;
                            result.NextCheckName = appSet.EightCheckName;
                            if (string.IsNullOrEmpty(appSet.EightCheckID))
                            {
                                send.title = "报销申请审批结束";
                                //表示是最后一级
                                IsEnd = true;
                                result.Status = "3";
                                result.NextCheckID = "";// AppSet.OneCheckID;
                                result.NextCheckName = "";// AppSet.OneCheckName;
                            }
                            else
                            {
                                qyUser = q.QueryUserList(new QyUserEntity { CheckRole = appSet.EightCheckID, CheckHouseID = appSet.HouseID.ToString() });
                            }
                            #endregion
                        }
                        list.Add(result);
                        bus.updateExpenseStatus(list, ty, log);
                        qyUser.Add(new QyUserEntity { UserID = OperaID, WxName = OperaName });

                        send.agentID = "1000009";//费用报销应用
                        send.msgType = msgType.textcard;
                        send.content = "<div></div><div>分仓仓库：" + UserInfor.HouseName + "</div><div>报销单号：" + result.ExID.ToString() + "</div><div>报销金额：" + result.ExCharge.ToString("F2") + "</div><div>审批人：" + UserInfor.UserName + "  " + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "</div><div>审批意见：" + result.ExName + "</div><div></div><div class=\"highlight\">请点击本通知进行审批！</div>";
                        send.url = "http://dlt.neway5.com/QY/qyExpenseCheck.aspx?ExID=" + result.ExID.ToString();
                        foreach (var it in qyUser)
                        {
                            send.toUser = it.UserID;
                            if (!bus.IsExistApproveCheck(new CargoApproveCheckEntity { ApproveID = result.ExID, ApproveType = "0", CheckUserID = it.UserID, CheckType = "0" }))
                            {
                                bus.AddApproveCheck(new CargoApproveCheckEntity { ApproveID = result.ExID, CheckUserID = it.UserID, CheckName = it.WxName, ReadStatus = "1", CheckType = "0", ApproveType = "0" }, log);
                            }
                            //WxQYSendHelper.QiyePushInfo(send);
                            Common.WriteTextLog("推送成功：" + it.WxName + result.ExID.ToString());
                        }
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }

        /// <summary>
        /// 到出纳
        /// </summary>
        public void updateExpenseCashier()
        {
            String json = Request["data"];
            ArrayList rows = (ArrayList)JSON.Decode(json);
            List<CargoExpenseEntity> list = new List<CargoExpenseEntity>();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "财务报销审批";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "U";
            log.Status = "0";
            log.Memo = "到出纳成功 ";
            try
            {
                foreach (Hashtable row in rows)
                {
                    //if (Convert.ToDecimal(row["ExCharge"]) > UserInfor.PayLimit)
                    //{
                    //    msg.Message = Convert.ToString(row["ExID"]) + "报销金额超出额度限制,请提交总部审核<br />";
                    //    msg.Result = false;
                    //    break; ;
                    //}
                    list.Add(new CargoExpenseEntity
                    {
                        ExID = Convert.ToInt64(row["ExID"]),
                        OperaID = UserInfor.LoginName,
                        OperaName = UserInfor.UserName
                    });
                }
                CargoFinanceBus bus = new CargoFinanceBus();
                if (msg.Result)
                {
                    if (list.Count > 0)
                    {
                        bus.updateExpenseCashier(list, log);
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
        #region 报销科目查询
        /// <summary>
        /// 超级科目查询收入和支出
        /// </summary>
        public void GetZeroSubject()
        {
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoZeroSubjectEntity> list = bus.GetZeroSubject();

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 根据科目ID查询一级科目内容
        /// </summary>
        public void GetFIDByZID()
        {
            //查询条件
            int id = Convert.ToInt32(Request["id"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoFirstSubjectEntity> list = bus.GetFIDByZID(id);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// 获取一级科目名称
        /// </summary>
        public void GetFIDNameByFID()
        {
            //查询条件
            int fid = Convert.ToInt32(Request["fid"]);
            int zid = Convert.ToInt32(Request["zid"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            string FName = bus.GetFIDNameByZID(zid, fid);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            msg.Message = FName;
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 报销的一级科目查询
        /// </summary>
        public void GetFirstSubject()
        {
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoFirstSubjectEntity> list = bus.GetFirstSubject();

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        /// <summary>
        /// 根据一级科目ID查询二级科目内容
        /// </summary>
        public void GetSIDByFID()
        {
            //查询条件
            int id = Convert.ToInt32(Request["id"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoSecondSubjectEntity> list = bus.GetSIDByFID(id);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询所有二级科目
        /// </summary>
        public void GetSecondSubject()
        {
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoSecondSubjectEntity> list = bus.GetSecondSubject();
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }

        /// <summary>
        /// 获取二级科目名称
        /// </summary>
        public void GetSIDNameBySID()
        {
            //查询条件
            int fid = Convert.ToInt32(Request["fid"]);
            int sid = Convert.ToInt32(Request["sid"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            string SName = bus.GetSIDNameByFID(fid, sid);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            msg.Message = SName;
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
        #region 审批流程设置
        /// <summary>
        /// 查询审批流程数据
        /// </summary>
        public void QueryFinanceApproveSet()
        {
            CargoApproveSetEntity queryEntity = new CargoApproveSetEntity();
            if (Request["ApproveType"] != "-1") { queryEntity.ApproveType = Convert.ToString(Request["ApproveType"]); }
            if (Request["DelFlag"] != "-1") { queryEntity.DelFlag = Convert.ToString(Request["DelFlag"]); }
            queryEntity.ApproveName = Convert.ToString(Request["ApproveName"]);
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryFinanceApproveSet(pageIndex, pageSize, queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 保存和修改审批流程
        /// </summary>
        public void SaveFinanceApproveSet()
        {
            CargoApproveSetEntity ent = new CargoApproveSetEntity();
            CargoFinanceBus bus = new CargoFinanceBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "审批流程设置";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();
            try
            {
                String id = Request["ID"] != null ? Request["ID"].ToString() : "";
                //ent.HouseID = UserInfor.HouseID;
                ent.HouseID = Convert.ToInt32(Request["HouseID"]);
                ent.ApproveName = Convert.ToString(Request["ApproveName"]);
                ent.OneCheckID = Convert.ToString(Request["OneCheckID"]);
                ent.OneCheckName = Convert.ToString(Request["OneCheckName"]);
                ent.TwoCheckID = Convert.ToString(Request["TwoCheckID"]);
                ent.TwoCheckName = Convert.ToString(Request["TwoCheckName"]);
                ent.ThreeCheckID = Convert.ToString(Request["ThreeCheckID"]);
                ent.ThreeCheckName = Convert.ToString(Request["ThreeCheckName"]);
                ent.FourCheckID = Convert.ToString(Request["FourCheckID"]);
                ent.FourCheckName = Convert.ToString(Request["FourCheckName"]);
                ent.FiveCheckID = Convert.ToString(Request["FiveCheckID"]);
                ent.FiveCheckName = Convert.ToString(Request["FiveCheckName"]);
                ent.SixCheckID = Convert.ToString(Request["SixCheckID"]);
                ent.SixCheckName = Convert.ToString(Request["SixCheckName"]);
                ent.CopyCheck = Convert.ToString(Request["CopyCheck"]);
                ent.CopyCheckName = Convert.ToString(Request["CopyCheckName"]);
                ent.CopyUserID = Convert.ToString(Request["CopyUserID"]);
                ent.CopyUserName = Convert.ToString(Request["CopyUserName"]);
                ent.AutoPassID = Convert.ToString(Request["AutoPassID"]);
                ent.AutoPassName = Convert.ToString(Request["AutoPassName"]);

                ent.ApproveType = Convert.ToString(Request["ApproveType"]);

                if (id == "")
                {
                    log.Operate = "A";
                    bus.AddFinanceApproveSet(ent, log);

                }
                else
                {
                    log.Operate = "U";
                    ent.ID = Convert.ToInt32(id);
                    bus.UpdateFinanceApproveSet(ent, log);
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);

        }
        /// <summary>
        /// 删除审批流程
        /// </summary>
        public void DelFinanceApproveSet()
        {
            String idStr = Request["data"];
            int ty = Convert.ToInt32(Request["ty"]);
            if (String.IsNullOrEmpty(idStr)) return;
            ArrayList rows = (ArrayList)JSON.Decode(idStr);
            List<CargoApproveSetEntity> list = new List<CargoApproveSetEntity>();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "审批流程设置";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();
            switch (ty)
            {
                case 0:
                    log.Memo = "注销审批流程";
                    log.Operate = "U";
                    break;
                case 1:
                    log.Memo = "删除审批流程";
                    log.Operate = "D";
                    break;
                case 2:
                    log.Memo = "恢复审批流程";
                    log.Operate = "U";
                    break;
                default:
                    break;
            }
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoApproveSetEntity
                    {
                        ID = Convert.ToInt32(row["ID"]),
                        ApproveName = Convert.ToString(row["ApproveName"]),
                        ApproveType = Convert.ToString(row["ApproveType"])
                    });
                }
                CargoFinanceBus bus = new CargoFinanceBus();
                bus.DelFinanceApproveSet(list, ty, log);
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 查询该仓库下的所有用户
        /// </summary>
        public void QueryUserByDepCode()
        {
            string cqd = string.Format("cmd={0}&depCode={1}", "queryUserInfoByCode", UserInfor.HouseName);
            //string cqd = string.Format("cmd={0}&depCode={1}&houseID={2}", "queryUserInfoByDepCode", "",UserInfor.);
            string result = wxHttpUtility.SendHttpRequest(Common.GethouseAPI(), cqd);
            userAPIMessage rows = Newtonsoft.Json.JsonConvert.DeserializeObject<userAPIMessage>(result);
            List<SystemUserEntity> list = new List<SystemUserEntity>();
            if (rows.Result)
            {
                list = rows.userList;
            }
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询可用的审批流程
        /// </summary>
        public void QueryApproveSet()
        {
            CargoApproveSetEntity queryEntity = new CargoApproveSetEntity();
            queryEntity.ApproveType = Convert.ToString(Request["ApproveType"]);
            queryEntity.DelFlag = Convert.ToString(Request["DelFlag"]);
            queryEntity.HouseID = UserInfor.HouseID;
            //if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            //{
            //    queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            //}
            //else
            //{
            //    queryEntity.CargoPermisID = UserInfor.HouseID.ToString();//用户所属仓库权限ID
            //}
            //if (UserInfor.HouseID.Equals(47))
            //{
            //    queryEntity.CargoPermisID = UserInfor.HouseID.ToString();//用户所属仓库权限ID
            //}
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoApproveSetEntity> list = bus.QueryApproveSet(queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);

        }
        public void QueryQyWeixinUserList()
        {
            QiyeBus bus = new QiyeBus();
            List<QyUserEntity> list = bus.QueryUserList(new QyUserEntity { });
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 付款申请书
        /// <summary>
        /// 获取付款申请人资料数据
        /// </summary>
        public void QueryReceiveNameList()
        {
            CargoReceiveInfoEntity queryEntity = new CargoReceiveInfoEntity();
            queryEntity.HouseID = UserInfor.HouseID;
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoReceiveInfoEntity> list = bus.QueryReceiveNameList(queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void QueryReceiveInfo()
        {
            CargoReceiveInfoEntity queryEntity = new CargoReceiveInfoEntity();
            queryEntity.HouseID = UserInfor.HouseID;
            queryEntity.CardType = "1";
            queryEntity.CardName = Convert.ToString(Request["CardName"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoReceiveInfoEntity> list = bus.QueryReceiveInfo(queryEntity);

            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 保存打印付款申请书
        /// </summary>
        public void SavePayment()
        {
            CargoPaymentEntity ent = new CargoPaymentEntity();
            List<CargoPayRelateAwbEntity> relate = new List<CargoPayRelateAwbEntity>();
            CargoFinanceBus bus = new CargoFinanceBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "打印付款申请书";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();
            String id = Request["ID"] != null ? Request["ID"].ToString() : "";
            try
            {
                ent.HouseID = UserInfor.HouseID;
                ent.ReceiveUnit = Convert.ToString(Request["ReceiveUnit"]);
                ent.ApplyDep = Convert.ToString(Request["ApplyDep"]);
                ent.ApplyPeople = Convert.ToString(Request["ApplyPeople"]);
                ent.CardBank = Convert.ToString(Request["CardBank"]);
                ent.CardName = Convert.ToString(Request["ACardName"]);
                ent.CardNum = Convert.ToString(Request["ACardNum"]);
                ent.PayMemo = Convert.ToString(Request["PayMemo"]);
                ent.PayWay = Convert.ToString(Request["PayWay"]);
                ent.RelateAwb = Convert.ToString(Request["RelateAwb"]);
                ent.PayMoney = Convert.ToDecimal(Request["PayMoney"]);
                ent.PrintName = UserInfor.UserName;
                string[] r = ent.RelateAwb.Split(',');
                for (int i = 0; i < r.Length; i++)
                {
                    if (string.IsNullOrEmpty(r[i])) { continue; }
                    relate.Add(new CargoPayRelateAwbEntity { RelateAwb = Convert.ToString(r[i]) });
                }
                ent.PayRelateList = relate;
                if (id == "")
                {
                    log.Operate = "A";
                    bus.SavePayment(ent, log);
                }
                else
                {
                    log.Operate = "U";
                    ent.ID = Convert.ToInt32(id);
                    bus.UpdatePayment(ent, log);
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 查询付款申请涵数据
        /// </summary>
        public void RemitQuery()
        {
            CargoPaymentEntity queryEntity = new CargoPaymentEntity();
            queryEntity.ApplyPeople = Convert.ToString(Request["ApplyPeople"]);
            queryEntity.RelateAwb = Convert.ToString(Request["RelateAwb"]);
            queryEntity.ReceiveUnit = Convert.ToString(Request["ReceiveUnit"]);
            queryEntity.CardName = Convert.ToString(Request["CardName"]);
            queryEntity.CardNum = Convert.ToString(Request["CardNum"]);
            queryEntity.CardBank = Convert.ToString(Request["CardBank"]);
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.HouseID = Convert.ToInt32(Request["HouseID"]);//所属仓库ID
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.RemitQuery(pageIndex, pageSize, queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 物流账单付款
        /// <summary>
        /// 查询物流账单信息
        /// </summary>
        public void QueryAccountList()
        {
            CargoAccountEntity queryEntity = new CargoAccountEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AccountNo"]))) { queryEntity.AccountNo = Convert.ToString(Request["AccountNo"]); };
            if (!string.IsNullOrEmpty(Convert.ToString(Request["OrderNo"]))) { queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]); };
            if (Convert.ToString(Request["Name"]) != "-1") { queryEntity.Name = Convert.ToString(Request["Name"]); };
            if (Convert.ToString(Request["CheckStatus"]) != "-1") { queryEntity.CheckStatus = Convert.ToString(Request["CheckStatus"]); };
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoAccountEntity> list = bus.QueryAccountList(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 查询订单信息
        /// </summary>
        public void QueryOrderList()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AccountNo"])))
            {
                queryEntity.AccountNo = Convert.ToString(Request["AccountNo"]);
            }
            else
            {
                if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
                if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
                if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
                {
                    queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
                }
                else
                {
                    queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
                }
            }
            CargoFinanceBus bus = new CargoFinanceBus();
            List<CargoOrderEntity> list = bus.QueryOrderList(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        /// <summary>
        /// 保存物流账单
        /// </summary>
        public void SaveAccountData()
        {
            CargoAccountEntity ent = new CargoAccountEntity();
            CargoFinanceBus bus = new CargoFinanceBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();

            string json = Request["data"];
            ArrayList GridRows = (ArrayList)JSON.Decode(json);
            if (GridRows.Count <= 0)
            {
                msg.Message = "没有物流数据";
                msg.Result = false;
                //返回处理结果
                string res = JSON.Encode(msg);
                Response.Write(res);
                return;
            }
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "出纳付款操作";
            log.NvgPage = "按物流单付款";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();
            String AccountNo = Request["AccountNo"].ToString();
            List<CargoOrderEntity> orderList = new List<CargoOrderEntity>();
            try
            {
                foreach (Hashtable row in GridRows)
                {
                    orderList.Add(new CargoOrderEntity
                    {
                        OrderNo = Convert.ToString(row["OrderNo"]).Trim()
                    });
                }
                ent.orderList = orderList;
                ent.Title = Convert.ToString(Request["Title"].Trim());
                ent.Name = Convert.ToString(Request["Name"].Trim());
                ent.Total = string.IsNullOrEmpty(Request["Total"]) ? 0.00 : Convert.ToDouble(Request["Total"].Trim());
                ent.TaxFee = string.IsNullOrEmpty(Request["TaxFee"]) ? 0.00 : Convert.ToDouble(Request["TaxFee"].Trim());
                ent.OtherFee = string.IsNullOrEmpty(Request["OtherFee"]) ? 0.00 : Convert.ToDouble(Request["OtherFee"].Trim());
                ent.Memo = Convert.ToString(Request["Memo"].Trim());
                ent.OP_ID = UserInfor.LoginName.Trim();
                ent.AType = 1;
                if (!string.IsNullOrEmpty(AccountNo))
                {
                    ent.AccountNo = AccountNo;
                    log.Operate = "U";
                    bus.UpdateAccountData(ent, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
                else
                {
                    ent.AccountNo = "WL" + bus.GetMaxAccountNumByDate(new CargoAccountEntity { StartDate = DateTime.Now, EndDate = DateTime.Now, AType = 1 });
                    log.Operate = "A";
                    bus.InsertAccountData(ent, log);
                    msg.Result = true;
                    msg.Message = "成功";
                }
            }
            catch (Exception ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            Response.Write(JSON.Encode(msg));
        }

        /// <summary>
        /// 删除物流账单数据
        /// </summary>
        public void DeleteAccountData()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<CargoAccountEntity> list = new List<CargoAccountEntity>();
            CargoFinanceBus bus = new CargoFinanceBus();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "出纳付款操作";
            log.Status = "0";
            log.NvgPage = "物流账单管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new CargoAccountEntity
                    {
                        AccountNo = Convert.ToString(row["AccountNo"])
                    });
                }
                bus.DeleteAccountData(list, log);
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
        #region 

        public void QueryPurSelFeeData()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["AcceptUnit"]))) { queryEntity.AcceptUnit = Convert.ToString(Request["AcceptUnit"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientNum"]))) { queryEntity.ClientNum = Convert.ToInt32(Request["ClientNum"]); }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.HouseID.ToString();//用户所属仓库权限ID
            }
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryPurSelFeeData(queryEntity);
            List<CargoClientEntity> datalist = (List<CargoClientEntity>)list["rows"];
            List<CargoClientEntity> curentPageList = new List<CargoClientEntity>();
            curentPageList = datalist.ToList();
            if (list != null) { QueryPurSelFeeDataList = list; }
            Hashtable ht = new Hashtable();
            decimal SelFee = 0;
            decimal SelAffectTotal = 0;
            decimal PurFee = 0;
            decimal PurAffectTotal = 0;
            decimal Weight = 0;
            foreach (var item in (List<CargoClientEntity>)list["rows"])
            {
                SelFee += item.SelFee;
                SelAffectTotal += item.SelAffectTotal;
                PurFee += item.PurFee;
                PurAffectTotal += item.PurAffectTotal;
                Weight += item.Weight;
            }
            //脚页
            List<CargoClientEntity> footlist = new List<CargoClientEntity>();
            footlist.Add(new CargoClientEntity
            {
                ClientName = "",
                Boss = "",
                Cellphone = "",
                UserName = "总计：",
                SelFee = SelFee,
                SelAffectTotal = SelAffectTotal,
                PurFee = PurFee,
                PurAffectTotal = PurAffectTotal,
                Weight = Weight
            });
            list["footer"] = footlist;
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public Hashtable QueryPurSelFeeDataList
        {
            get
            {
                if (Session["QueryPurSelFeeDataList"] == null)
                {
                    Session["QueryPurSelFeeDataList"] = new Hashtable();
                }
                return (Hashtable)(Session["QueryPurSelFeeDataList"]);
            }
            set
            {
                Session["QueryPurSelFeeDataList"] = value;
            }
        }
        public void QueryPurSelFeeOrderData()
        {
            CargoOrderEntity queryEntity = new CargoOrderEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientNum"]))) { queryEntity.ClientNum = Convert.ToInt32(Request["ClientNum"]); }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryPurSelFeeOrderData(pageIndex, pageSize, queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        #endregion
        #region 其它业务管理

        public void QueryFinanceOther()
        {
            FinanceOtherEntity queryEntity = new FinanceOtherEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientNum"]))) { queryEntity.ClientNum = Convert.ToInt32(Request["ClientNum"]); }
            if (!Convert.ToString(Request["CheckStatus"]).Equals("-1")) { queryEntity.CheckStatus = Convert.ToString(Request["CheckStatus"]); }
            if (!string.IsNullOrEmpty(Request["HouseID"]) && Request["HouseID"] != "undefined")//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryFinanceOther(pageIndex, pageSize, queryEntity);
            //JSON
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void SaveFinanceOtherData()
        {
            FinanceOtherEntity ent = new FinanceOtherEntity();
            CargoFinanceBus bus = new CargoFinanceBus();
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = true;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.NvgPage = "其他业务管理";
            log.Status = "0";
            log.UserID = UserInfor.LoginName.Trim();
            try
            {
                String id = Request["ID"] != null ? Request["ID"].ToString() : "";
                ent.HouseID = UserInfor.HouseID;
                ent.ProjectType = Convert.ToString(Request["ProjectType"]);
                ent.ProjectCategory = Convert.ToString(Request["ProjectCategory"]);
                ent.HappenDate = Convert.ToDateTime(Request["HappenDate"]);
                ent.ClientNum = string.IsNullOrEmpty(Request["ClientNum"]) ? 0 : Convert.ToInt32(Request["ClientNum"]);
                ent.AcceptUnit = Convert.ToString(Request["AcceptUnit"]);
                ent.AmountInvolved = Convert.ToDecimal(Request["AmountInvolved"]);
                ent.OP_ID = UserInfor.LoginName.Trim();

                if (id == "")
                {
                    log.Operate = "A";
                    if (msg.Result)
                    {
                        bus.AddFinanceOtherData(ent, log);
                    }
                }
                else
                {
                    log.Operate = "U";
                    ent.ID = Convert.ToInt32(Request["ID"]);
                    if (msg.Result)
                    {
                        bus.UpdateFinanceOtherData(ent, log);
                    }
                }
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        public void QueryFinanceOtherDataForCash()
        {
            FinanceOtherEntity queryEntity = new FinanceOtherEntity();
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["ClientNum"]))) { queryEntity.ClientNum = Convert.ToInt32(Request["ClientNum"]); }
            if (!Convert.ToString(Request["CheckStatus"]).Equals("-1")) { queryEntity.CheckStatus = Convert.ToString(Request["CheckStatus"]); }
            if (!string.IsNullOrEmpty(Request["HouseID"]) && Request["HouseID"] != "undefined")//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            queryEntity.ProjectType = Convert.ToString(Request["ProjectType"]);
            CargoFinanceBus bus = new CargoFinanceBus();
            List<FinanceOtherEntity> list = bus.QueryFinanceOtherDataForCash(queryEntity);
            String json = JSON.Encode(list);
            Response.Clear();
            Response.Write(json);
        }
        public void DeleteFinanceOtherData()
        {
            String json = Request["data"];
            if (String.IsNullOrEmpty(json)) return;
            List<FinanceOtherEntity> list = new List<FinanceOtherEntity>();
            CargoFinanceBus bus = new CargoFinanceBus();
            ArrayList rows = (ArrayList)JSON.Decode(json);
            ErrMessage msg = new ErrMessage(); msg.Message = "";
            msg.Result = false;
            LogEntity log = new LogEntity();
            log.IPAddress = Common.GetUserIP(HttpContext.Current.Request);
            log.Moudle = "财务管理";
            log.Status = "0";
            log.NvgPage = "其他业务管理";
            log.UserID = UserInfor.LoginName.Trim();
            log.Operate = "D";
            try
            {
                foreach (Hashtable row in rows)
                {
                    list.Add(new FinanceOtherEntity
                    {
                        ID = Convert.ToInt32(row["ID"]),
                        HouseID = Convert.ToInt32(row["HouseID"]),
                        ProjectCategory = Convert.ToString(row["ProjectCategory"]),
                        ProjectType = Convert.ToString(row["ProjectType"]),
                        ClientNum = Convert.ToInt32(row["ClientNum"]),
                        AcceptUnit = Convert.ToString(row["AcceptUnit"]),
                        AmountInvolved = Convert.ToDecimal(row["AmountInvolved"])
                    });
                }
                bus.DeleteFinanceOtherData(list, log);
                msg.Result = true;
                msg.Message = "成功";
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
        #region 退款审核管理
        /// <summary>
        /// 查询退款记录
        /// </summary>
        public void QueryRefundCheckData()
        {
            WXOrderEntity queryEntity = new WXOrderEntity();
            #region 赋值
            queryEntity.PayStatus = "2,3";//“申请退款、已退款”状态
            queryEntity.OrderType = "4";//订单类型：云配小程序商场订单
            queryEntity.ThrowGood = "22,23";//即日达、次日达订单
            if (!string.IsNullOrEmpty(Request["CargoOrderNo"]))
            {
                queryEntity.CargoOrderNo = Convert.ToString(Request["CargoOrderNo"]);//仓储订单号
            }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            if (!string.IsNullOrEmpty(Request["OrderNo"]))//订单号
            {
                queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);
            }
            if (!string.IsNullOrEmpty(Request["WXPayOrderNo"]))//微信支付号
            {
                queryEntity.WXPayOrderNo = Convert.ToString(Request["WXPayOrderNo"]);
            }
            if (!string.IsNullOrEmpty(Request["ClientName"]))//客户名称
            {
                queryEntity.ClientName = Convert.ToString(Request["ClientName"]);
            }
            if (Convert.ToString(Request["RefundCheckStatus"]) != "-1")//审核状态
            {
                queryEntity.RefundCheckStatus = Convert.ToString(Request["RefundCheckStatus"]);
            }
            if (Convert.ToString(Request["RefundReason"]) != "-1")//退款原因
            {
                queryEntity.RefundReason = Convert.ToString(Request["RefundReason"]);
            }
            if (!string.IsNullOrEmpty(Request["HouseID"]))//一级分类
            {
                queryEntity.CargoPermisID = Convert.ToString(Request["HouseID"]);//所属仓库ID
            }
            else
            {
                queryEntity.CargoPermisID = UserInfor.CargoPermisID;//用户所属仓库权限ID
            }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["StartDate"]))) { queryEntity.StartDate = Convert.ToDateTime(Request["StartDate"]); }
            if (!string.IsNullOrEmpty(Convert.ToString(Request["EndDate"]))) { queryEntity.EndDate = Convert.ToDateTime(Request["EndDate"]); }
            queryEntity.OrderNo = Convert.ToString(Request["OrderNo"]);

            //分页
            int pageIndex = Convert.ToInt32(Request["page"]);
            int pageSize = Convert.ToInt32(Request["rows"]);
            #endregion
            CargoFinanceBus bus = new CargoFinanceBus();
            Hashtable list = bus.QueryRefundCheckData(pageIndex, pageSize, queryEntity);
            String json = JSON.Encode(list); //JSON
            Response.Clear();
            Response.Write(json);
        }

        /// 更新退款审核状态
        /// </summary>
        /// <param name="entity"></param>
        public void UpdateRefundCheckStatus()
        {
            WXOrderEntity entity = new WXOrderEntity();
            CargoFinanceBus bus = new CargoFinanceBus();
            ErrMessage msg = new ErrMessage()
            {
                Message = "",
                Result = true,
            };
            LogEntity log = new LogEntity()
            {
                IPAddress = Common.GetUserIP(HttpContext.Current.Request),
                Moudle = "财务管理",
                NvgPage = "商城退款审核",
                Status = "0",
                UserID = UserInfor.LoginName.Trim(),
                Operate = "U",
            };
            try
            {
                #region 赋值及判断
                entity.FacOrderNo = Convert.ToString(Request["FacOrderNo"]);
                if (string.IsNullOrEmpty(Convert.ToString(Request["RefundCheckStatus"])) || Convert.ToString(Request["RefundCheckStatus"]) != "0")
                {
                    msg.Message = "请仔细检查审核状态！";
                    msg.Result = false;
                }
                if (!string.IsNullOrEmpty(entity.FacOrderNo))
                {
                    // 退货来货入库单号不为空时查询退货单
                    CargoFactoryOrderBus orderBus = new CargoFactoryOrderBus();
                    CargoFactoryOrderEntity factoryOrderEntity = orderBus.QueryFactoryOrderData(new CargoFactoryOrderEntity()
                    {
                        FacName = entity.FacOrderNo
                    });
                    if (factoryOrderEntity != null && !string.IsNullOrEmpty(factoryOrderEntity.FacOrderNo) && factoryOrderEntity.InCargoStatus != 1)
                    {
                        msg.Message = "该订单的退货单还未完全入库！";
                        msg.Result = false;
                    }
                }
                entity.WXPayOrderNo = string.IsNullOrEmpty(Convert.ToString(Request["WXPayOrderNo"])) ? "" : Convert.ToString(Request["WXPayOrderNo"]);//微信支付订单号
                entity.CargoOrderNo = string.IsNullOrEmpty(Convert.ToString(Request["CargoOrderNo"])) ? "" : Convert.ToString(Request["CargoOrderNo"]);//仓储订单号
                entity.OrderNo = string.IsNullOrEmpty(Convert.ToString(Request["OrderNo"])) ? "" : Convert.ToString(Request["OrderNo"]);//微信订单号
                entity.OrderID = string.IsNullOrEmpty(Convert.ToString(Request["OrderID"])) ? 0 : Convert.ToInt64(Request["OrderID"]);//CargoOrderID
                entity.RefundCheckStatus = string.IsNullOrEmpty(Convert.ToString(Request["RefundCheckStatus"])) ? "" : Convert.ToString(Request["RefundCheckStatus"]);//退款审核状态
                entity.ID = string.IsNullOrEmpty(Convert.ToString(Request["ID"])) ? 0 : Convert.ToInt64(Request["ID"]);//WxOrderID
                entity.RefundCheckID = UserInfor.LoginName.Trim();//退款审核人ID
                entity.RefundCheckName = UserInfor.UserName;//退款审核人姓名
                entity.RefundCheckDate = DateTime.Now;
                entity.InCargoStatus = Convert.ToString(Request["InCargoStatus"]);//入库状态
                if (msg.Result)
                {
                    //仓库同步缓存
                    CargoHouseBus house = new CargoHouseBus();
                    List<CargoProductEntity> syncProduct = house.SyncTypeOrderNo(entity.CargoOrderNo);
                    foreach (CargoProductEntity product in syncProduct)
                    {

                        if (product.SyncType == "2" || (product.SyncType == "1" && product.TypeID == 34))
                        {
                            RedisHelper.HashSet("OpenSystemStockSyc", "" + product.HouseID + "_" + product.TypeID + "_" + product.ProductCode + "", product.GoodsCode);
                        }
                    }

                    bus.UpdateRefundCheckStatus(entity, log);
                }
                #endregion
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Write(res);
        }
        /// <summary>
        /// 新增退货单
        /// </summary>
        public void AddReturnOrder()
        {
            WXOrderEntity entity = new WXOrderEntity();
            CargoFinanceBus bus = new CargoFinanceBus();
            ErrMessage msg = new ErrMessage()
            {
                Message = "",
                Result = true,
            };
            LogEntity log = new LogEntity()
            {
                IPAddress = Common.GetUserIP(HttpContext.Current.Request),
                Moudle = "财务管理",
                NvgPage = "商城退款审核-新增退货单",
                Status = "0",
                UserID = UserInfor.LoginName.Trim(),
                Operate = "A",
            };
            try
            {
                #region 赋值及判断
                entity.FacOrderNo = Convert.ToString(Request["FacOrderNo"]);
                entity.Piece = Convert.ToInt32(Request["Piece"]);//总件数
                entity.ReturnPiece = Convert.ToInt32(Request["ReturnPiece"]);//退货件数
                entity.IsTransitFee = Convert.ToString(Request["IsTransitFee"]);//是否退回运费
                entity.TotalCharge = Convert.ToDecimal(Request["TotalCharge"]);//合计
                entity.TransitFee = Convert.ToDecimal(Request["TransitFee"]);//配送费

                if (string.IsNullOrEmpty(Convert.ToString(Request["RefundCheckStatus"])) || Convert.ToString(Request["RefundCheckStatus"]) != "0")
                {
                    msg.Message = "请仔细检查审核状态！";
                    msg.Result = false;
                }
                //if (entity.ReturnPiece <= 0)
                //{
                //    msg.Message = "退货数量不能小于等于0！";
                //    msg.Result = false;
                //}
                //if (entity.ReturnPiece > entity.Piece)
                //{
                //    msg.Message = "退货数量不能大于订单数量！";
                //    msg.Result = false;
                //}
                if (string.IsNullOrEmpty(entity.IsTransitFee))
                {
                    msg.Message = "是否退回运费获取有误，请联系管理员！";
                    msg.Result = false;
                }
                // 退货来货入库单号不为空时查询退货单
                if (!string.IsNullOrEmpty(entity.FacOrderNo))
                {
                    CargoFactoryOrderBus orderBus = new CargoFactoryOrderBus();
                    CargoFactoryOrderEntity factoryOrderEntity = orderBus.QueryFactoryOrderData(new CargoFactoryOrderEntity()
                    {
                        FacName = entity.FacOrderNo
                    });
                    if (factoryOrderEntity != null && !string.IsNullOrEmpty(factoryOrderEntity.FacOrderNo))
                    {
                        msg.Message = "该订单已生成退货单！";
                        msg.Result = false;
                    }
                }

                entity.HouseID = string.IsNullOrEmpty(Convert.ToString(Request["HouseID"])) ? 0 : Convert.ToInt32(Request["HouseID"]);//HouseID
                entity.ID = string.IsNullOrEmpty(Convert.ToString(Request["ID"])) ? 0 : Convert.ToInt64(Request["ID"]);//WxOrderID
                entity.OrderNo = string.IsNullOrEmpty(Convert.ToString(Request["OrderNo"])) ? "" : Convert.ToString(Request["OrderNo"]);//微信订单号
                entity.CargoOrderNo = string.IsNullOrEmpty(Convert.ToString(Request["CargoOrderNo"])) ? "" : Convert.ToString(Request["CargoOrderNo"]);//仓储订单号
                entity.WXPayOrderNo = string.IsNullOrEmpty(Convert.ToString(Request["WXPayOrderNo"])) ? "" : Convert.ToString(Request["WXPayOrderNo"]);//微信支付订单号
                entity.RefundCheckID = UserInfor.LoginName.Trim();//退款审核人ID
                entity.RefundCheckName = UserInfor.UserName;//退款审核人姓名
                entity.RefundCheckDate = DateTime.Now;
                int OrderNum = 0;
                CargoHouseBus cargoHouse = new CargoHouseBus();
                CargoHouseEntity house = cargoHouse.QueryCargoHouseByID(entity.HouseID);//查询仓库代码
                entity.ReturnOrderNO = Common.GetMaxOrderNumByCurrentDate(entity.HouseID, house.HouseCode, out OrderNum);//生成退货单号
                entity.ThrowGood = "5";//是否抛货（5:退货订单）
                entity.OrderNum = OrderNum;//订单顺序号

                if (msg.Result)
                {
                    bus.AddReturnOrder(entity, log);
                }
                #endregion
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            string res = JSON.Encode(msg);
            Response.Clear();
            Response.Write(res);
            Response.End();
            //string res = JSON.Encode(msg);
            //Response.Write(res);
        }

        /// <summary>
        /// 撤销退款申请
        /// </summary>
        public void saveRepealItem() {
            WXOrderEntity entity = new WXOrderEntity();
            CargoFinanceBus bus = new CargoFinanceBus();
            ErrMessage msg = new ErrMessage()
            {
                Message = "",
                Result = true,
            };
            LogEntity log = new LogEntity()
            {
                IPAddress = Common.GetUserIP(HttpContext.Current.Request),
                Moudle = "财务管理",
                NvgPage = "商城退款审核",
                Status = "0",
                UserID = UserInfor.LoginName.Trim(),
                Operate = "U",
            };
            string res = string.Empty;
            try
            {
                #region 赋值及判断
                string a = Convert.ToString(Request["aaaa"]);
                entity.FacOrderNo = Convert.ToString(Request["FacOrderNo"]);
             
                //if (!string.IsNullOrEmpty(entity.FacOrderNo))
                //{
                //    // 退货来货入库单号不为空时查询退货单
                //    CargoFactoryOrderBus orderBus = new CargoFactoryOrderBus();
                //    CargoFactoryOrderEntity factoryOrderEntity = orderBus.QueryFactoryOrderData(new CargoFactoryOrderEntity()
                //    {
                //        FacName = entity.FacOrderNo
                //    });
                //    if (factoryOrderEntity != null && !string.IsNullOrEmpty(factoryOrderEntity.FacOrderNo) && factoryOrderEntity.InCargoStatus != 1)
                //    {
                //        msg.Message = "该订单的退货单还未完全入库！";
                //        msg.Result = false;
                //    }
                //}

                var submitData = JsonConvert.DeserializeObject<WXOrderEntity>(Request["submitData"]);

                entity.WXPayOrderNo = string.IsNullOrEmpty(Convert.ToString(submitData.WXPayOrderNo)) ? "" : Convert.ToString(submitData.WXPayOrderNo);//微信支付订单号
                entity.CargoOrderNo = string.IsNullOrEmpty(Convert.ToString(submitData.CargoOrderNo)) ? "" : Convert.ToString(submitData.CargoOrderNo);//仓储订单号
                entity.OrderNo = string.IsNullOrEmpty(Convert.ToString(submitData.OrderNo)) ? "" : Convert.ToString(submitData.OrderNo);//微信订单号
                entity.OrderID = string.IsNullOrEmpty(Convert.ToString(submitData.OrderID)) ? 0 : Convert.ToInt64(submitData.OrderID);//CargoOrderID
                entity.ID = string.IsNullOrEmpty(Convert.ToString(submitData.ID)) ? 0 : Convert.ToInt64(submitData.ID);//WxOrderID
                entity.RefundMemo= string.IsNullOrEmpty(Convert.ToString(Request["RepealRemark"])) ? "" : Convert.ToString(Request["RepealRemark"]);//撤销审核备注
                entity.PayStatus = string.IsNullOrEmpty(Convert.ToString(submitData.PayStatus)) ? "" : Convert.ToString(submitData.PayStatus);//付款状态
                entity.RefundCheckStatus = string.IsNullOrEmpty(Convert.ToString(submitData.RefundCheckStatus)) ? "" : Convert.ToString(submitData.RefundCheckStatus);//退款审核状态

                if (string.IsNullOrEmpty(Convert.ToString(entity.RefundCheckStatus)) || Convert.ToString(entity.RefundCheckStatus) != "0")
                {
                    msg.Message = "订单已审核，不可撤销！";
                    msg.Result = false;
                }
                if (string.IsNullOrEmpty(Convert.ToString(entity.PayStatus)) || Convert.ToString(entity.PayStatus) == "3")
                {
                    msg.Message = "订单已退款，不可撤销！";
                    msg.Result = false;
                }
                if (string.IsNullOrEmpty(Convert.ToString(entity.PayStatus)) || Convert.ToString(entity.PayStatus) == "3")
                {
                    msg.Message = "订单已退款，不可撤销！";
                    msg.Result = false;
                }

                entity.PayStatus = "1";

                if (msg.Result)
                {
                    CargoHouseBus house = new CargoHouseBus();
                    ////仓库同步缓存
                    //List<CargoProductEntity> syncProduct = house.SyncTypeOrderNo(entity.CargoOrderNo);
                    //foreach (CargoProductEntity product in syncProduct)
                    //{

                    //    if (product.SyncType == "2" || (product.SyncType == "1" && product.TypeID == 34))
                    //    {
                    //        RedisHelper.HashSet("OpenSystemStockSyc", "" + product.HouseID + "_" + product.TypeID + "_" + product.ProductCode + "", product.GoodsCode);
                    //    }
                    //}

                    bus.RevokeRefundApply(entity, log);
                }
                #endregion
            }
            catch (ApplicationException ex)
            {
                msg.Message = ex.Message;
                msg.Result = false;
            }
            //返回处理结果
            res = JSON.Encode(msg);
            Response.Write(res);
        }
        #endregion
    }
}